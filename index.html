<!DOCTYPE html>
<html lang="en">
<!--
    ðŸš€ GOOGLE DRIVE API INTEGRATION - FAST PDF LOADING
    
    How to use:
    1. Upload PDF to Google Drive
    2. Right-click > Share > "Anyone with the link can view"
    3. Copy the link (e.g., https://drive.google.com/file/d/1abc123xyz/view)
    4. Use in embedded documents - it will auto-convert to fast preview URL
    
    Benefits:
    âœ… Blazing fast loading (Google's CDN)
    âœ… No server load
    âœ… Unlimited storage
    âœ… Auto-optimized for mobile
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduSphere Pro | Next-Gen JEE/NEET Platform</title>
    
    <!-- Device Detection Script - Must run FIRST -->
    <script>
        // Detect device type on first load and store it
        (function() {
            const detectDeviceType = () => {
                const ua = navigator.userAgent.toLowerCase();
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
                const isTablet = /(ipad|tablet|playbook|silk)|(android(?!.*mobile))/i.test(ua);
                const touchPoints = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
                
                // Check if device has touch capability and small screen
                const hasTouch = ('ontouchstart' in window) || (touchPoints > 0);
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const smallScreen = Math.min(screenWidth, screenHeight) <= 926;
                
                // Determine device type
                let deviceType = 'desktop';
                if (isMobile || (hasTouch && smallScreen)) {
                    deviceType = 'mobile';
                } else if (isTablet || (hasTouch && screenWidth <= 1024)) {
                    deviceType = 'tablet';
                }
                
                return deviceType;
            };
            
            // Store device type in localStorage and as data attribute
            const deviceType = detectDeviceType();
            localStorage.setItem('deviceType', deviceType);
            document.documentElement.setAttribute('data-device-type', deviceType);
            
            // Also add as body class when DOM is ready
            if (document.body) {
                document.body.classList.add('device-' + deviceType);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('device-' + deviceType);
                });
            }
            
            console.log('ðŸ” Device detected:', deviceType);
            console.log('ðŸ“± User Agent:', navigator.userAgent);
            console.log('ðŸ“ Screen:', window.screen.width, 'x', window.screen.height);
            console.log('âœ… data-device-type attribute set to:', deviceType);
            
            // Re-apply on orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    document.documentElement.setAttribute('data-device-type', deviceType);
                    if (document.body) {
                        document.body.classList.add('device-' + deviceType);
                    }
                    console.log('ðŸ”„ Orientation changed, device type reapplied:', deviceType);
                }, 100);
            });
            
            // Also listen to resize events
            window.addEventListener('resize', function() {
                document.documentElement.setAttribute('data-device-type', deviceType);
                if (document.body) {
                    document.body.classList.add('device-' + deviceType);
                }
            });
        })();
    </script>
    <!-- Cache busting -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap">
    
    <!-- Gujarati Font Support -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;500;600;700&display=swap">

    <!-- jsPDF + html2canvas for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- MathJax for regular display -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: { '[+]': ['ams', 'newcommand', 'configmacros'] },
                macros: {
                    R: "\\mathbb{R}",
                    N: "\\mathbb{N}",
                    Z: "\\mathbb{Z}",
                    Q: "\\mathbb{Q}",
                    C: "\\mathbb{C}",
                    vec: ["\\overrightarrow{#1}", 1],
                    unit: ["\\hat{#1}", 1],
                    deg: "^\\circ",
                    ohm: "\\Omega"
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady();
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

    <!-- KaTeX for PDF generation only -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Chart.js for performance graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script>
        console.log('ðŸš¨ HTML FILE VERSION 4.0 - MathJax for display, KaTeX for PDF! ðŸš¨');
        console.log('ðŸ“… Loaded at:', new Date().toLocaleString());

        // MathJax handles regular display rendering automatically
        // KaTeX is only used during PDF generation (see printToPDF function)
        
        // Ensure MathJax is ready
        async function ensureMathJaxReady() {
            if (!window.MathJax) {
                console.warn('âš ï¸ MathJax not loaded, LaTeX will use Unicode fallback');
                return false;
            }
            
            // Wait for MathJax to be ready
            if (MathJax.startup && MathJax.startup.promise) {
                await MathJax.startup.promise;
            }
            
            return true;
        }
        
        // Convert LaTeX to SVG using MathJax (VECTOR-BASED!)
        async function convertLatexToSVG(latex) {
            if (!latex) return null;
            
            const mathJaxReady = await ensureMathJaxReady();
            if (!mathJaxReady) return null;
            
            try {
                // Use MathJax to convert LaTeX to SVG
                const node = await MathJax.tex2svgPromise(latex, {
                    display: false,
                    em: 16,
                    ex: 8,
                    containerWidth: 1000
                });
                
                // Extract SVG string
                const svg = node.querySelector('svg');
                if (!svg) return null;
                
                // Get SVG as string
                const svgString = new XMLSerializer().serializeToString(svg);
                
                // Convert SVG to data URI
                const svgDataUri = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                
                return {
                    svg: svgDataUri,
                    width: parseFloat(svg.getAttribute('width').replace('ex', '')) * 8,
                    height: parseFloat(svg.getAttribute('height').replace('ex', '')) * 8
                };
            } catch (error) {
                console.error('Error converting LaTeX to SVG:', error);
                return null;
            }
        }
        
        // Parse text and extract LaTeX expressions
        function parseTextWithLatex(text) {
            if (!text) return [];
            
            const parts = [];
            const latexRegex = /\$\$(.*?)\$\$|\$(.*?)\$/g;
            let lastIndex = 0;
            let match;
            
            while ((match = latexRegex.exec(text)) !== null) {
                // Add text before LaTeX
                if (match.index > lastIndex) {
                    parts.push({
                        type: 'text',
                        content: text.substring(lastIndex, match.index)
                    });
                }
                
                // Add LaTeX
                parts.push({
                    type: 'latex',
                    content: match[1] || match[2]
                });
                
                lastIndex = match.index + match[0].length;
            }
            
            // Add remaining text
            if (lastIndex < text.length) {
                parts.push({
                    type: 'text',
                    content: text.substring(lastIndex)
                });
            }
            
            return parts.length > 0 ? parts : [{ type: 'text', content: text }];
        }
        
        // Convert text with LaTeX to pdfmake content (with SVG support)
        async function textWithLatexToPdfMake(text, style = {}) {
            const parts = parseTextWithLatex(text);
            const content = [];
            
            for (const part of parts) {
                if (part.type === 'text') {
                    content.push({
                        text: part.content,
                        ...style
                    });
                } else if (part.type === 'latex') {
                    // Convert LaTeX to SVG
                    const svgData = await convertLatexToSVG(part.content);
                    if (svgData) {
                        content.push({
                            svg: svgData.svg,
                            width: Math.min(svgData.width, 400),
                            height: svgData.height,
                            margin: [0, 2, 0, 2]
                        });
                    } else {
                        // Fallback to Unicode
                        content.push({
                            text: convertLatexToUnicode('$$' + part.content + '$$'),
                            ...style
                        });
                    }
                }
            }
            
            return content.length === 1 ? content[0] : { stack: content };
        }
        
        // Fallback: Convert LaTeX to Unicode symbols
        function convertLatexToUnicode(text) {
            if (!text) return '';
            
            return text
                // Remove LaTeX delimiters
                .replace(/\$\$(.*?)\$\$/g, '$1')
                .replace(/\$(.*?)\$/g, '$1')
                .replace(/\\\[(.*?)\\\]/g, '$1')
                .replace(/\\\((.*?)\\\)/g, '$1')
                
                // Greek letters (lowercase)
                .replace(/\\alpha/g, 'Î±').replace(/\\beta/g, 'Î²').replace(/\\gamma/g, 'Î³')
                .replace(/\\delta/g, 'Î´').replace(/\\epsilon/g, 'Îµ').replace(/\\theta/g, 'Î¸')
                .replace(/\\lambda/g, 'Î»').replace(/\\mu/g, 'Î¼').replace(/\\pi/g, 'Ï€')
                .replace(/\\sigma/g, 'Ïƒ').replace(/\\tau/g, 'Ï„').replace(/\\phi/g, 'Ï†')
                .replace(/\\omega/g, 'Ï‰')
                
                // Greek letters (uppercase)
                .replace(/\\Delta/g, 'Î”').replace(/\\Sigma/g, 'Î£').replace(/\\Omega/g, 'Î©')
                
                // Math operators
                .replace(/\\times/g, 'Ã—').replace(/\\div/g, 'Ã·').replace(/\\pm/g, 'Â±')
                .replace(/\\cdot/g, 'Â·').replace(/\\approx/g, 'â‰ˆ').replace(/\\neq/g, 'â‰ ')
                .replace(/\\leq/g, 'â‰¤').replace(/\\geq/g, 'â‰¥').replace(/\\infty/g, 'âˆž')
                
                // Fractions (simple conversion)
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)')
                
                // Square roots
                .replace(/\\sqrt\{([^}]+)\}/g, 'âˆš$1')
                
                // Superscripts and subscripts
                .replace(/\^{([^}]+)}/g, '^$1')
                .replace(/_{([^}]+)}/g, '_$1')
                
                // Remove remaining LaTeX commands
                .replace(/\\[a-zA-Z]+/g, '')
                .replace(/[{}]/g, '')
                .trim();
        }
        
        // Helper function to render MathJax in an element
        async function renderMathJaxInElement(element) {
            if (!element) return;
            
            // Pause observer during rendering
            pauseObserver();
            
            try {
                // Wait for MathJax to be ready
                if (!window.MathJax) {
                    console.warn('âš ï¸ MathJax not loaded yet, queuing for later');
                    // Queue for later when MathJax is ready
                    if (document.readyState === 'complete') {
                        setTimeout(() => renderMathJaxInElement(element), 500);
                    }
                    resumeObserver();
                    return;
                }
                
                // Wait for startup if needed
                if (window.MathJax.startup && window.MathJax.startup.promise) {
                    await window.MathJax.startup.promise;
                }
                
                if (window.MathJax.typesetPromise) {
                    // Clear existing rendered math in this element
                    const existingMath = element.querySelectorAll('mjx-container, MJX-CONTAINER');
                    existingMath.forEach(mjx => {
                        try {
                            const script = mjx.previousElementSibling;
                            if (script && script.tagName === 'SCRIPT' && script.type.includes('math/tex')) {
                                mjx.remove();
                            }
                        } catch (e) {
                            // Ignore
                        }
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 10));
                    await window.MathJax.typesetPromise([element]);
                    console.log('âœ… MathJax rendered in element');
                } else {
                    console.warn('âš ï¸ MathJax typesetPromise not available');
                }
            } catch (error) {
                console.error('âŒ Error rendering MathJax:', error);
                // Retry once
                setTimeout(async () => {
                    try {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            await window.MathJax.typesetPromise([element]);
                            console.log('âœ… MathJax rendered in element on retry');
                        }
                    } catch (retryError) {
                        console.error('âŒ MathJax element retry failed:', retryError);
                    } finally {
                        resumeObserver();
                    }
                }, 500);
                return; // Don't resume yet, let retry handle it
            } finally {
                // Resume observer after rendering
                setTimeout(() => resumeObserver(), 50);
            }
        }

        // Global function to render MathJax on the entire page or specific container
        async function renderAllMathJax(container) {
            // Pause observer during rendering
            pauseObserver();
            
            try {
                // Wait for MathJax to be ready
                if (!window.MathJax) {
                    console.warn('âš ï¸ MathJax not loaded yet');
                    return;
                }
                
                // Wait for startup if needed
                if (window.MathJax.startup && window.MathJax.startup.promise) {
                    await window.MathJax.startup.promise;
                }
                
                if (window.MathJax.typesetPromise) {
                    // Clear existing rendered math to prevent conflicts
                    const target = container || document.body;
                    const existingMath = target.querySelectorAll('mjx-container, MJX-CONTAINER');
                    existingMath.forEach(mjx => {
                        try {
                            const script = mjx.previousElementSibling;
                            if (script && script.tagName === 'SCRIPT' && script.type.includes('math/tex')) {
                                mjx.remove();
                            }
                        } catch (e) {
                            // Ignore
                        }
                    });
                    
                    // Wait for DOM to stabilize
                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                    if (container) {
                        await window.MathJax.typesetPromise([container]);
                        console.log('âœ… MathJax rendered in container');
                    } else {
                        await window.MathJax.typesetPromise();
                        console.log('âœ… MathJax rendered on entire page');
                    }
                } else {
                    console.warn('âš ï¸ MathJax typesetPromise not available');
                }
            } catch (error) {
                console.error('âŒ Error rendering MathJax:', error);
                // Retry once after a delay
                setTimeout(async () => {
                    try {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            if (container) {
                                await window.MathJax.typesetPromise([container]);
                            } else {
                                await window.MathJax.typesetPromise();
                            }
                            console.log('âœ… MathJax rendered on retry');
                        }
                    } catch (retryError) {
                        console.error('âŒ MathJax retry failed:', retryError);
                    } finally {
                        resumeObserver();
                    }
                }, 500);
                return; // Don't resume observer yet, let retry handle it
            } finally {
                // Resume observer after rendering
                setTimeout(() => resumeObserver(), 50);
            }
        }

        // Observer to automatically render MathJax when content changes
        let mathJaxRenderTimeout = null;
        let mathJaxRenderQueue = [];
        let isProcessingQueue = false;
        
        // Process queued render requests
        async function processMathJaxQueue() {
            if (isProcessingQueue || mathJaxRenderQueue.length === 0) {
                return;
            }
            
            isProcessingQueue = true;
            
            // Pause observer to prevent conflicts during rendering
            pauseObserver();
            
            try {
                // Get all unique elements to render, filter out invalid ones
                const elementsToRender = [...new Set(mathJaxRenderQueue)].filter(el => {
                    // Check if element is still in DOM and valid
                    return el && el.isConnected && document.body.contains(el);
                });
                mathJaxRenderQueue = [];
                
                if (elementsToRender.length === 0) {
                    console.log('âš ï¸ No valid elements to render');
                    return;
                }
                
                if (window.MathJax && window.MathJax.typesetPromise) {
                    console.log('ðŸ”„ Rendering MathJax for', elementsToRender.length, 'elements');
                    
                    // Clear any existing MathJax containers in these elements first
                    elementsToRender.forEach(el => {
                        try {
                            const existingMath = el.querySelectorAll('mjx-container, MJX-CONTAINER');
                            existingMath.forEach(mjx => {
                                // Store the original text if available
                                const script = mjx.previousElementSibling;
                                if (script && script.tagName === 'SCRIPT' && script.type.includes('math/tex')) {
                                    // Keep the script tag, remove only the rendered output
                                    mjx.remove();
                                }
                            });
                        } catch (e) {
                            // Ignore errors during cleanup
                        }
                    });
                    
                    // Wait a tick for DOM to stabilize
                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                    // Render with error handling per element
                    await window.MathJax.typesetPromise(elementsToRender);
                    console.log('âœ… MathJax rendered successfully');
                }
            } catch (error) {
                console.error('âŒ Error rendering MathJax:', error);
                
                // If it's a DOM mutation error, try rendering the whole document instead
                if (error.name === 'IndexSizeError' || error.message.includes('splitText')) {
                    console.log('ðŸ”„ Retrying with full document render...');
                    try {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            await window.MathJax.typesetPromise();
                            console.log('âœ… Full document render successful');
                        }
                    } catch (retryError) {
                        console.error('âŒ Retry failed:', retryError);
                    }
                }
            } finally {
                isProcessingQueue = false;
                
                // Resume observer after a short delay
                setTimeout(() => resumeObserver(), 50);
                
                // Process any new items that were added while we were rendering
                if (mathJaxRenderQueue.length > 0) {
                    setTimeout(() => processMathJaxQueue(), 150);
                }
            }
        }
        
        // Queue an element for MathJax rendering
        function queueMathJaxRender(element) {
            if (!element || !element.isConnected) return;
            
            // Don't queue if already in queue
            if (mathJaxRenderQueue.includes(element)) return;
            
            mathJaxRenderQueue.push(element);
            
            // Debounce processing - increased to 150ms for better stability
            clearTimeout(mathJaxRenderTimeout);
            mathJaxRenderTimeout = setTimeout(() => {
                processMathJaxQueue();
            }, 150);
        }
        
        let mathJaxObserver = null;
        
        function setupMathJaxObserver() {
            if (!window.MathJax) {
                console.warn('âš ï¸ MathJax not loaded, observer not set up');
                return;
            }

            mathJaxObserver = new MutationObserver((mutations) => {
                // Batch process mutations to avoid excessive renders
                const nodesToCheck = new Set();
                
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Element node
                                // Skip MathJax's own elements
                                if (node.classList && (node.classList.contains('MathJax') || 
                                    node.tagName === 'mjx-container' || 
                                    node.tagName === 'MJX-CONTAINER' ||
                                    node.closest && node.closest('.MathJax, mjx-container, MJX-CONTAINER'))) {
                                    return;
                                }
                                
                                // Check if the added content contains LaTeX delimiters
                                const text = node.textContent || '';
                                if (text.includes('$') || text.includes('\\(') || text.includes('\\[')) {
                                    nodesToCheck.add(node);
                                }
                            }
                        });
                    }
                });
                
                // Queue all nodes at once
                if (nodesToCheck.size > 0) {
                    console.log('ðŸ“ LaTeX content detected in', nodesToCheck.size, 'nodes');
                    nodesToCheck.forEach(node => queueMathJaxRender(node));
                }
            });

            // Observe the entire document body for changes
            mathJaxObserver.observe(document.body, {
                childList: true,
                subtree: true
            });

            console.log('âœ… MathJax observer set up');
            
            // Render any existing content on page
            setTimeout(() => {
                console.log('ðŸ”„ Initial MathJax render');
                renderAllMathJax();
            }, 200);
        }
        
        // Temporarily pause observer during rendering to prevent conflicts
        function pauseObserver() {
            if (mathJaxObserver) {
                mathJaxObserver.disconnect();
            }
        }
        
        function resumeObserver() {
            if (mathJaxObserver) {
                mathJaxObserver.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
        }

        // Initialize MathJax observer when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (window.MathJax && window.MathJax.startup && window.MathJax.startup.promise) {
                window.MathJax.startup.promise.then(() => {
                    console.log('âœ… MathJax ready, setting up observer');
                    setupMathJaxObserver();
                }).catch(error => {
                    console.error('âŒ MathJax startup error:', error);
                    // Try again after delay
                    setTimeout(() => setupMathJaxObserver(), 1000);
                });
            } else {
                // Fallback: try to set up observer after a delay
                setTimeout(() => {
                    if (window.MathJax) {
                        setupMathJaxObserver();
                    } else {
                        console.error('âŒ MathJax failed to load');
                    }
                }, 2000);
            }
        });
        
        // Global utility: Force render LaTeX in any element or entire page
        // Usage: window.forceRenderLatex() or window.forceRenderLatex(element)
        window.forceRenderLatex = async function(element) {
            console.log('ðŸ”„ Force rendering LaTeX...');
            
            // Pause observer to prevent conflicts
            pauseObserver();
            
            try {
                if (!window.MathJax) {
                    console.error('âŒ MathJax not loaded');
                    return false;
                }
                
                // Wait for MathJax to be ready
                if (window.MathJax.startup && window.MathJax.startup.promise) {
                    await window.MathJax.startup.promise;
                }
                
                // Clear any existing MathJax output in the target
                const target = element || document.body;
                const mjxContainers = target.querySelectorAll('mjx-container, MJX-CONTAINER');
                mjxContainers.forEach(container => {
                    try {
                        container.remove();
                    } catch (e) {
                        // Ignore removal errors
                    }
                });
                
                // Wait for DOM to stabilize after removal
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Render
                if (window.MathJax.typesetPromise) {
                    if (element) {
                        await window.MathJax.typesetPromise([element]);
                    } else {
                        await window.MathJax.typesetPromise();
                    }
                    console.log('âœ… Force render complete');
                    return true;
                } else {
                    console.error('âŒ MathJax typesetPromise not available');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Force render error:', error);
                
                // Try one more time with a clean slate
                try {
                    console.log('ðŸ”„ Attempting recovery render...');
                    await new Promise(resolve => setTimeout(resolve, 200));
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        await window.MathJax.typesetPromise();
                        console.log('âœ… Recovery render successful');
                        return true;
                    }
                } catch (recoveryError) {
                    console.error('âŒ Recovery render failed:', recoveryError);
                }
                
                return false;
            } finally {
                // Resume observer after a delay
                setTimeout(() => resumeObserver(), 100);
            }
        };

        // BLAZING FAST PDF with pdfmake (Native PDF, No Canvas!)
        async function generateFastPDF(questions, config, type = 'questions') {
            try {
                console.log('ðŸš€ Generating PDF with pdfmake (ULTRA FAST!)');
                console.log('ðŸ“Š Questions:', questions);
                console.log('âš™ï¸ Config:', config);
                console.log('ðŸ“„ Type:', type);
                
                // Log images found
                const imagesFound = questions.filter(q => q.image || q.questionImage).length;
                console.log(`ðŸ–¼ï¸ Found ${imagesFound} question images`);
                
                // Validate inputs
                if (!questions || questions.length === 0) {
                    throw new Error('No questions provided');
                }
                if (!config) {
                    throw new Error('No config provided');
                }
                
                const docDefinition = {
                    pageSize: 'A4',
                    pageMargins: [40, 60, 40, 60],
                    
                    // Header
                    header: (currentPage, pageCount) => {
                        return {
                            columns: [
                                { text: config.schoolName || 'GYANMANJARI', style: 'header', alignment: 'center' }
                            ],
                            margin: [40, 20]
                        };
                    },
                    
                    // Footer
                    footer: (currentPage, pageCount) => {
                        return {
                            text: `Page ${currentPage} of ${pageCount}`,
                            alignment: 'center',
                            fontSize: 9,
                            margin: [0, 10]
                        };
                    },
                    
                    content: [],
                    
                    styles: {
                        header: {
                            fontSize: 20,
                            bold: true,
                            alignment: 'center',
                            margin: [0, 0, 0, 10]
                        },
                        subheader: {
                            fontSize: 14,
                            bold: true,
                            margin: [0, 10, 0, 5]
                        },
                        paperInfo: {
                            fontSize: 10,
                            margin: [0, 5, 0, 5]
                        },
                        question: {
                            fontSize: 11,
                            margin: [0, 10, 0, 5]
                        },
                        option: {
                            fontSize: 10,
                            margin: [15, 3, 0, 3]
                        },
                        solution: {
                            fontSize: 10,
                            margin: [15, 5, 0, 5],
                            italics: true,
                            color: '#1976d2'
                        }
                    }
                };
                
                // Add paper info
                docDefinition.content.push({
                    columns: [
                        { text: `Subject: ${config.subject}`, style: 'paperInfo' },
                        { text: `Date: ${new Date(config.examDate).toLocaleDateString()}`, style: 'paperInfo', alignment: 'right' }
                    ]
                });
                
                docDefinition.content.push({
                    columns: [
                        { text: `Total Marks: ${config.totalMarks}`, style: 'paperInfo' },
                        { text: `Time: ${config.examTime} minutes`, style: 'paperInfo', alignment: 'right' }
                    ]
                });
                
                docDefinition.content.push({
                    text: type === 'questions' ? 'Question Paper' : type === 'answers' ? 'Answer Key' : 'Solutions',
                    style: 'subheader',
                    alignment: 'center',
                    margin: [0, 15, 0, 15]
                });
                
                // Add line separator
                docDefinition.content.push({
                    canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }],
                    margin: [0, 0, 0, 15]
                });
                
                // Add questions
                if (type === 'answers') {
                    // Answer key format - compact table
                    const answerRows = [];
                    const answersPerRow = 5;
                    
                    for (let i = 0; i < questions.length; i += answersPerRow) {
                        const row = [];
                        for (let j = 0; j < answersPerRow && i + j < questions.length; j++) {
                            const q = questions[i + j];
                            row.push({ text: `${i + j + 1}. ${q.answer || q.correctAnswer || 'N/A'}`, style: 'option' });
                        }
                        answerRows.push(row);
                    }
                    
                    docDefinition.content.push({
                        table: {
                            widths: Array(answersPerRow).fill('*'),
                            body: answerRows
                        },
                        layout: 'lightHorizontalLines'
                    });
                    
                } else {
                    // Questions or Solutions format - Process with async LaTeX to SVG
                    for (let index = 0; index < questions.length; index++) {
                        const q = questions[index];
                        
                        // Question number and text (with VECTOR LaTeX support via SVG!)
                        const questionContent = await textWithLatexToPdfMake(q.text || q.question || '', { style: 'question', bold: true });
                        docDefinition.content.push({
                            stack: [
                                { text: `Q${index + 1}. `, style: 'question', bold: true },
                                questionContent
                            ],
                            margin: [0, 10, 0, 5]
                        });
                        
                        // Question image (base64 and URL support)
                        if (q.image || q.questionImage) {
                            const imgData = q.image || q.questionImage;
                            if (imgData) {
                                try {
                                    // Support base64 data URIs and regular URLs
                                    if (imgData.startsWith('data:image') || imgData.startsWith('http')) {
                                        docDefinition.content.push({
                                            image: imgData,
                                            width: 400,
                                            margin: [15, 5, 0, 10],
                                            alignment: 'center'
                                        });
                                    }
                                } catch (error) {
                                    console.error('Error adding question image:', error);
                                }
                            }
                        }
                        
                        // Options (with VECTOR LaTeX support)
                        if (q.options && q.options.length > 0) {
                            for (let optIndex = 0; optIndex < q.options.length; optIndex++) {
                                const opt = q.options[optIndex];
                                const label = String.fromCharCode(65 + optIndex); // A, B, C, D
                                const isCorrect = type === 'solutions' && (q.answer === label || q.correctAnswer === label);
                                
                                const optionContent = await textWithLatexToPdfMake(opt, { 
                                    style: 'option',
                                    bold: isCorrect,
                                    color: isCorrect ? '#4caf50' : '#000000'
                                });
                                
                                docDefinition.content.push({
                                    stack: [
                                        { text: `${label}) `, style: 'option', bold: isCorrect, color: isCorrect ? '#4caf50' : '#000000' },
                                        optionContent
                                    ],
                                    margin: [15, 3, 0, 3]
                                });
                            }
                        }
                        
                        // Solution (if solutions type) with VECTOR LaTeX support
                        if (type === 'solutions' && (q.solution || q.explanation)) {
                            const solutionContent = await textWithLatexToPdfMake(q.solution || q.explanation, { style: 'solution' });
                            docDefinition.content.push({
                                stack: [
                                    { text: 'Solution: ', style: 'solution', bold: true },
                                    solutionContent
                                ],
                                margin: [15, 5, 0, 5]
                            });
                        }
                        
                        // Solution images (base64 and URL support)
                        if (type === 'solutions' && q.solutionImages && q.solutionImages.length > 0) {
                            q.solutionImages.forEach(img => {
                                try {
                                    const imgData = img.data || img;
                                    if (imgData && (imgData.startsWith('data:image') || imgData.startsWith('http'))) {
                                        docDefinition.content.push({
                                            image: imgData,
                                            width: 300,
                                            margin: [15, 5, 0, 10],
                                            alignment: 'center'
                                        });
                                    }
                                } catch (error) {
                                    console.error('Error adding solution image:', error);
                                }
                            });
                        }
                        
                        // Option images (if any option has an image)
                        if (q.options && q.options.length > 0) {
                            q.options.forEach((opt, optIndex) => {
                                if (typeof opt === 'object' && opt.image) {
                                    try {
                                        const imgData = opt.image;
                                        if (imgData && (imgData.startsWith('data:image') || imgData.startsWith('http'))) {
                                            docDefinition.content.push({
                                                image: imgData,
                                                width: 200,
                                                margin: [30, 3, 0, 3],
                                                alignment: 'left'
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error adding option image:', error);
                                    }
                                }
                            });
                        }
                        
                        // Add spacing between questions
                        if (index < questions.length - 1) {
                            docDefinition.content.push({ text: '', margin: [0, 5, 0, 5] });
                        }
                    }
                }
                
                // Generate and download PDF (INSTANT!)
                console.log('ðŸ“¦ Creating PDF with docDefinition:', docDefinition);
                
                if (typeof pdfMake === 'undefined') {
                    throw new Error('pdfMake library not loaded');
                }
                
                const pdfDocGenerator = pdfMake.createPdf(docDefinition);
                const filename = `${config.paperTitle || config.schoolName || 'paper'}_${type}.pdf`;
                
                console.log('ðŸ’¾ Downloading:', filename);
                pdfDocGenerator.download(filename);
                
                console.log('âœ… PDF generated successfully with pdfmake!');
                return true;
                
            } catch (error) {
                console.error('âŒ pdfmake error:', error);
                console.error('Error details:', error.message, error.stack);
                alert('PDF Generation Error: ' + error.message);
                throw error;
            }
        }
        
        // DISABLED: Old html2canvas method - Now using pdfmake exclusively
        async function generateOptimizedPDF_DISABLED(htmlContent, filename, onProgress) {
            console.warn('âš ï¸ This function is disabled. Use generateFastPDF with pdfmake instead.');
            return;
        }
        
        // OLD CODE REMOVED - The html2canvas implementation has been replaced with pdfmake
        // If needed, the old code can be found in git history
        
        function OLD_generateOptimizedPDF_CODE() {
            // This is just a placeholder for the old code that was removed
            return;
            /* OLD CODE WAS HERE - REMOVED */
        }
        
        function OLD_generateServerPDF_CODE() {
            // This is just a placeholder for the old code that was removed
            return;
            /* OLD CODE WAS HERE - REMOVED */
        }
        
        // Keeping the structure for reference only
        async function REFERENCE_OLD_CODE(htmlContent, filename, onProgress) {
            return new Promise(async (resolve, reject) => {
                try {
                    onProgress?.('Preparing document...', 10);
                    
                    // Create temporary container
                    const container = document.createElement('div');
                    container.style.position = 'absolute';
                    container.style.left = '-9999px';
                    container.style.top = '0';
                    container.style.width = '794px'; // A4 width
                    container.style.background = 'white';
                    container.style.padding = '20px';
                    container.innerHTML = htmlContent;
                    document.body.appendChild(container);

                    onProgress?.('Rendering math equations...', 30);
                    
                    // Render math with KaTeX (BLAZING FAST!)
                    if (window.renderMathInElement) {
                        renderMathInElement(container, {
                            delimiters: [
                                {left: '$$', right: '$$', display: false},
                                {left: '\\(', right: '\\)', display: false},
                                {left: '\\[', right: '\\]', display: true},
                                {left: '$', right:'$', display: true},
                            ],
                            throwOnError: false,
                            strict: false,
                            trust: true
                        });
                        await new Promise(r => setTimeout(r, 50)); // KaTeX is instant!
                    }

                    onProgress?.('Loading images...', 50);
                    
                    // Preload images (parallel)
                    const images = Array.from(container.getElementsByTagName('img'));
                    if (images.length > 0) {
                        await Promise.race([
                            Promise.all(images.map(img => {
                                if (img.complete) return Promise.resolve();
                                return new Promise(r => {
                                    img.onload = r;
                                    img.onerror = r;
                                });
                            })),
                            new Promise(r => setTimeout(r, 2000)) // Max 2s wait
                        ]);
                    }

                    onProgress?.('Capturing high-quality snapshot...', 70);
                    
                    // OPTIMIZED html2canvas settings for SPEED + QUALITY
                    const canvas = await html2canvas(container, {
                        scale: 2.5, // Ultra HD quality
                        useCORS: true,
                        allowTaint: false,
                        logging: false,
                        backgroundColor: '#ffffff',
                        windowWidth: 794,
                        windowHeight: container.scrollHeight,
                        imageTimeout: 0,
                        removeContainer: false,
                        async: true,
                        foreignObjectRendering: false, // Faster
                        letterRendering: true, // Better text
                        onclone: (clonedDoc) => {
                            const cloned = clonedDoc.body.querySelector('div');
                            if (cloned) {
                                cloned.style.fontFamily = 'Times New Roman, serif';
                                cloned.style.fontSize = '12px';
                            }
                        }
                    });

                    onProgress?.('Creating PDF...', 85);
                    
                    // Create PDF with jsPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4', true); // Compression enabled
                    
                    // Convert to high-quality JPEG
                    const imgData = canvas.toDataURL('image/jpeg', 0.98);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = pdfWidth;
                    const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;
                    let pageNum = 0;
                    
                    // Add pages progressively
                    while (heightLeft >= 0) {
                        if (pageNum > 0) {
                            pdf.addPage();
                            await new Promise(r => setTimeout(r, 10)); // Yield to UI
                        }
                        
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                        heightLeft -= pdfHeight;
                        position -= pdfHeight;
                        pageNum++;
                        
                        onProgress?.(`Adding page ${pageNum}...`, 85 + (pageNum * 2));
                    }
                    
                    onProgress?.('Finalizing...', 95);
                    
                    // Save PDF
                    pdf.save(filename + '.pdf');
                    
                    // Cleanup
                    document.body.removeChild(container);
                    
                    onProgress?.('Complete!', 100);
                    resolve();

                } catch (error) {
                    console.error('âŒ PDF Generation Error:', error);
                    reject(error);
                }
            });
        }
        
        // Alternative: Server-side PDF generation (FASTEST + BEST QUALITY)
        async function generateServerPDF(htmlContent, filename) {
            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        html: htmlContent,
                        filename: filename 
                    })
                });
                
                if (!response.ok) throw new Error('Server PDF generation failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.pdf';
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Server PDF failed, falling back to client-side:', error);
                // Fallback to client-side
                return generateOptimizedPDF(htmlContent, filename);
            }
        }
        

    </script>
    <style>
        /* Gujarati Font Support */
        @font-face {
            font-family: 'EKLG-13-BoldItalic';
            src: url('fonts/EKLG-13-BoldItalic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }

        /* Apply Gujarati font to elements */
        .gujarati-text,
        .lang-gu,
        [lang="gu"] {
            font-family: 'EKLG-13-BoldItalic', 'Noto Sans Gujarati', sans-serif !important;
        }

        :lang(gu) {
            font-family: 'EKLG-13-BoldItalic', 'Noto Sans Gujarati', sans-serif;
        }

        /* Prevent MathJax from affecting normal text spacing */
        mjx-container {
            display: inline-block;
            margin: 0;
        }
        
        mjx-container[display="true"] {
            display: block;
            margin: 1em 0;
        }
        
        /* Ensure normal text spacing is preserved */
        .question-text, .option-text, .question-solution {
            white-space: pre-line;
        }
        
        body {
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --white: #ffffff;
            --primary: #5046e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --gradient-primary: linear-gradient(135deg, #5046e5 0%, #8b5cf6 100%);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-primary: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.7;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            width: 100%;
        }

        /* Line break preservation for question content */
        .question-text,
        .question-solution,
        .option-text,
        .option-item {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* Preserve line breaks but trim leading/trailing spaces */
        .question-text::first-line,
        .question-solution::first-line {
            text-indent: 0;
        }

        /* Ensure proper text wrapping */
        .question-text p,
        .question-solution p,
        .option-text,
        .option-item {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }
        
        /* Question Bank Container Fix */
        .question-bank-item,
        .question-card {
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .question-bank-item > *,
        .question-card > * {
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        /* MOBILE LAYOUT - Works on real devices AND Chrome DevTools emulator */
        /* Targets screens under 926px width (mobile size) */
        @media (max-width: 926px) {
            /* Force single column for ALL grids */
            .stats-overview,
            .stats-row,
            .action-cards-grid,
            .subject-grid,
            #paperSubjectCards,
            .question-type-cards,
            .academic-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* Question Bank Cards - Fix text breaking into single characters */
            .question-bank-item,
            .question-card,
            .question-select-item {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .question-text,
            .question-title,
            .question-content,
            .question-select-item p,
            .question-select-item > div {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: normal !important;
                white-space: normal !important;
                hyphens: none !important;
                flex: 1 !important;
                padding: 0 !important;
                margin: 0.25rem 0 !important;
            }
            
            .question-meta,
            .question-info {
                width: 100% !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                padding: 0.5rem 0 !important;
            }
            
            /* Reduce spacing in question cards */
            .question-card .option-item,
            .question-select-item .option-item {
                padding: 0.5rem !important;
                margin: 0.25rem 0 !important;
            }
            
            /* Compact buttons in question cards */
            .question-card .btn,
            .question-select-item .btn {
                padding: 0.5rem 1rem !important;
                font-size: 0.85rem !important;
            }
            
            /* Reduce tag/badge spacing */
            .question-card .badge,
            .question-card .tag,
            .question-meta span {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
                margin: 0.125rem !important;
            }
            
            /* Compact reference section */
            .question-card .references,
            .question-card .reference-section {
                padding: 0.5rem !important;
                margin: 0.5rem 0 !important;
            }
            
            /* FORCE ALL dropdowns EXTRA small on mobile */
            select,
            select[style],
            #paperDifficultyFilter,
            #paperChapterFilter {
                padding: 0.25rem 0.35rem !important;
                font-size: 0.7rem !important;
                height: 32px !important;
                min-height: 32px !important;
                max-height: 32px !important;
                line-height: 1.1 !important;
                border-width: 1px !important;
                border-radius: 4px !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* FORCE dropdown options to be tiny */
            select option,
            #paperDifficultyFilter option,
            #paperChapterFilter option {
                padding: 0.25rem !important;
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
                height: auto !important;
                min-height: 28px !important;
            }
            
            /* Override inline styles on select */
            select[style*="padding"] {
                padding: 0.25rem 0.35rem !important;
            }
            
            select[style*="font-size"] {
                font-size: 0.7rem !important;
            }
            
            /* Make the native dropdown menu smaller */
            @supports (-webkit-appearance: none) or (-moz-appearance: none) {
                select {
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    appearance: none;
                }
            }
            
            /* ALL labels much smaller */
            label {
                font-size: 0.7rem !important;
                margin-bottom: 0.2rem !important;
                display: block !important;
            }
            
            /* Filter bar very compact */
            div[style*="padding: 1.5rem"] {
                padding: 0.6rem !important;
            }
            
            /* Filter grid single column */
            div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.6rem !important;
            }
            
            /* Reset button smaller */
            button[onclick*="resetPaperFilters"],
            button[onclick*="reset"] {
                padding: 0.4rem 0.8rem !important;
                font-size: 0.75rem !important;
                height: 34px !important;
                font-size: 0.85rem !important;
            }
            
            /* Make ALL select dropdowns smaller on mobile */
            select {
                font-size: 0.75rem !important;
                padding: 0.4rem 0.5rem !important;
                line-height: 1.1 !important;
                max-width: 100% !important;
            }
            
            /* Make dropdown options smaller and more compact */
            select option {
                font-size: 0.75rem !important;
                padding: 0.3rem 0.4rem !important;
                line-height: 1.2 !important;
                min-height: 28px !important;
                height: 28px !important;
            }
            
            /* Reduce select height */
            select:not([multiple]) {
                height: 34px !important;
                min-height: 34px !important;
                max-height: 34px !important;
            }
            
            /* Make the dropdown popup smaller */
            select[size] {
                max-height: 200px !important;
            }
            
            /* Compact select appearance */
            select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.5rem center;
                background-size: 10px;
                padding-right: 2rem !important;
            }
            
            .dashboard {
                padding: 0 !important;
            }
            
            .main-content {
                width: 100vw !important;
                max-width: 100vw !important;
            }
            
            .content-area,
            .content-area-full {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 0.5rem !important;
            }
        }
        
        /* LANDSCAPE MODE - For mobile-sized screens in landscape */
        @media (max-width: 926px) and (orientation: landscape) {
            body {
                overflow-x: hidden;
                max-width: 100vw;
                height: 100vh;
            }
            
            /* KEEP single column even in landscape */
            .stats-overview,
            .stats-row,
            .action-cards-grid,
            .subject-grid,
            #paperSubjectCards,
            .question-type-cards,
            .academic-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .section {
                min-height: 100vh !important;
                overflow-y: auto !important;
                padding: 0.5rem 1rem !important;
            }
            
            /* AI Section in landscape */
            #ultraAiGuidanceSection {
                height: 100vh !important;
                padding: 0 !important;
            }
            
            .chatgpt-container {
                height: 100vh !important;
                flex-direction: column !important;
            }
            
            .chatgpt-sidebar {
                width: 100% !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            
            .chatgpt-main {
                flex: 1 !important;
                height: 100% !important;
            }
        }
        
        /* DESKTOP PROTECTION - Ensure desktop keeps multi-column layout */
        @media (min-width: 927px) {
            .stats-overview,
            .stats-row {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            }
            
            .action-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            }
            
            .documents-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* DOCUMENTS SECTION - Mobile Friendly */
        .documents-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        /* Document Viewer - Mobile Friendly */
        .document-viewer-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .document-viewer-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .document-viewer-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }
        
        .doc-back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
            white-space: nowrap;
        }
        
        .document-title-section {
            min-width: 0;
            flex: 1;
        }
        
        .document-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-subtitle {
            margin: 0.25rem 0 0 0;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .document-viewer-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .doc-download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
        }
        
        .doc-fullscreen-btn {
            background: rgba(102,126,234,0.1);
            border: 2px solid rgba(102,126,234,0.3);
            color: #667eea;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .pdf-viewer-container {
            flex: 1;
            position: relative;
            padding: 1rem;
            overflow: hidden;
        }
        
        .document-loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(102,126,234,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-title {
            color: #1f2937;
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0 0 0.5rem 0;
        }
        
        .loading-subtitle {
            color: #6b7280;
            font-size: 0.85rem;
            margin: 0;
        }
        
        .pdf-iframe-wrapper {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.5);
        }
        
        /* ADMIN PANEL - Mobile Friendly */
        @media (max-width: 926px) {
            .admin-dashboard {
                padding: 0.5rem;
            }
            
            .admin-tabs {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .admin-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
                justify-content: flex-start;
            }
            
            .admin-tab i {
                font-size: 1.1rem;
            }
            
            .admin-section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .admin-section-header h2 {
                font-size: 1.3rem;
            }
            
            /* Button container in admin section header */
            .admin-section-header > div {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.75rem !important;
                width: 100% !important;
            }
            
            .admin-section-header .btn {
                width: 100% !important;
                justify-content: center !important;
                padding: 0.875rem 1.5rem !important;
                font-size: 0.95rem !important;
            }
            
            .admin-stats {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .stat-info h3 {
                font-size: 0.8rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            /* Make tables scrollable on mobile */
            .users-table {
                overflow-x: auto;
            }
            
            .users-table table {
                min-width: 600px;
            }
            
            .users-table th,
            .users-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
            
            .documents-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .document-viewer-header {
                padding: 0.5rem;
                flex-direction: column;
                align-items: stretch;
            }
            
            .document-viewer-header-left {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .doc-back-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
                justify-content: center;
            }
            
            .back-text {
                display: inline;
            }
            
            .document-title {
                font-size: 0.95rem;
                white-space: normal;
                word-break: break-word;
            }
            
            .document-subtitle {
                font-size: 0.7rem;
            }
            
            .document-viewer-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .doc-download-btn,
            .doc-fullscreen-btn {
                flex: 1;
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
                justify-content: center;
            }
            
            .btn-text {
                display: none;
            }
            
            .pdf-viewer-container {
                padding: 0.5rem;
            }
            
            .document-loading {
                padding: 1.5rem;
                max-width: 90%;
            }
            
            .loading-spinner {
                width: 50px;
                height: 50px;
            }
            
            .loading-title {
                font-size: 1rem;
            }
            
            .loading-subtitle {
                font-size: 0.75rem;
            }
        }
        
        /* Responsive layout fixes */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .enhanced-modal-content {
                max-width: 95%;
                margin: 0 auto;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .enhanced-modal-header {
                padding: 1rem;
            }
        }

        /* Fix for small mobile devices */
        @media (max-width: 480px) {
            body {
                font-size: 13px;
            }

            .modal {
                padding: 1rem;
            }
        }

        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .enhanced-modal-content {
            background: #ffffff;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
            margin: 0 auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Enhanced Modal Header */
        .enhanced-modal-header {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 2rem;
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .progress-indicator {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition-base);
            cursor: pointer;
        }

        .progress-step.active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .progress-step.completed {
            background: var(--success);
        }

        .enhanced-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition-base);
        }

        .enhanced-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Enhanced Modal Body */
        .enhanced-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Form Steps */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: stepFadeIn 0.3s ease-out;
        }

        @keyframes stepFadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .step-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .step-header p {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        /* Question Type Cards */
        .question-type-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .type-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition-base);
            text-align: center;
        }

        .type-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .type-card.active {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .type-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .type-card h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .type-card p {
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .type-features {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .type-features span {
            font-size: 0.9rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .type-features i {
            color: var(--success);
        }

        /* Academic Grid */
        .academic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .enhanced-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .enhanced-input,
        .enhanced-select,
        .enhanced-editor {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition-base);
            background: var(--white);
        }

        .enhanced-input:focus,
        .enhanced-select:focus,
        .enhanced-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(80, 70, 229, 0.1);
        }

        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            gap: 1rem;
        }

        .difficulty-option {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .difficulty-option.easy {
            border-color: var(--success);
        }

        .difficulty-option.medium {
            border-color: var(--warning);
        }

        .difficulty-option.hard {
            border-color: var(--error);
        }

        .difficulty-option input[type="radio"] {
            display: none;
        }

        .difficulty-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-radius: 50%;
            position: relative;
        }

        .difficulty-option input[type="radio"]:checked+.difficulty-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: currentColor;
            border-radius: 50%;
        }

        .difficulty-info strong {
            display: block;
            font-weight: 600;
        }

        .difficulty-info small {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        /* Chapter Input Container */
        .chapter-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .chapter-suggest-btn {
            position: absolute;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .chapter-suggest-btn:hover {
            background: var(--primary-dark);
        }

        /* Enhanced Modal Footer */
        .enhanced-modal-footer {
            background: var(--gray-50);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left,
        .footer-right {
            display: flex;
            gap: 1rem;
        }

        .footer-center {
            display: flex;
            align-items: center;
        }

        .step-counter {
            font-weight: 600;
            color: var(--gray-600);
        }

        /* Button Styles */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.025em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn i {
            transition: transform 0.3s ease;
        }

        .btn:hover i {
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:active {
            transform: translateY(-1px);
            transition: transform 0.1s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            color: white;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .enhanced-modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }

            .enhanced-modal-header {
                padding: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .progress-indicator {
                justify-content: center;
            }

            .question-type-cards {
                grid-template-columns: 1fr;
            }

            .academic-grid {
                grid-template-columns: 1fr;
            }

            .difficulty-selector {
                flex-direction: column;
            }

            .enhanced-modal-footer {
                flex-direction: column;
                gap: 1rem;
            }

            .footer-left,
            .footer-right {
                width: 100%;
                justify-content: center;
            }
        }

        /* Enhanced Keyboard Shortcuts Help Panel */
        .keyboard-shortcuts-help {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(80, 70, 229, 0.1);
            z-index: 1000;
            width: 380px;
            max-height: 500px;
            display: none;
            font-size: 0.9rem;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .keyboard-shortcuts-help.show {
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shortcuts-title {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .shortcuts-title i {
            font-size: 1.3rem;
        }

        .shortcuts-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .shortcuts-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .shortcuts-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            max-height: 400px;
        }

        .shortcuts-content::-webkit-scrollbar {
            width: 6px;
        }

        .shortcuts-content::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .shortcuts-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .shortcuts-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .shortcuts-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .shortcuts-section:last-child {
            border-bottom: none;
        }

        .shortcuts-section-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shortcuts-section-title i {
            color: var(--primary);
            font-size: 1rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .shortcut-item:last-child {
            margin-bottom: 0;
        }

        .shortcut-item:hover {
            background: var(--gray-50);
            transform: translateX(2px);
        }

        .shortcut-keys {
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .shortcut-description {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .shortcut-icon {
            color: var(--primary);
            margin-right: 0.5rem;
            font-size: 0.9rem;
            width: 16px;
            text-align: center;
        }

        /* Enhanced Keyboard shortcuts toggle button */
        .shortcuts-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(80, 70, 229, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .shortcuts-toggle-btn:hover {
            background: linear-gradient(135deg, #4338ca 0%, #7c3aed 100%);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 35px rgba(80, 70, 229, 0.5);
        }

        .shortcuts-toggle-btn:active {
            transform: scale(0.95);
        }

        .shortcuts-toggle-btn.active {
            background: var(--success);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .shortcuts-toggle-btn.active:hover {
            background: #059669;
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.5);
        }

        /* File Attachment Styles */
        .file-drop-zone {
            transition: all 0.3s ease;
        }

        .file-drop-zone:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.02);
        }

        .file-drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
            transform: scale(1.02);
        }

        .attachment-btn:hover {
            background: var(--gray-100) !important;
            color: var(--primary) !important;
        }

        .attachment-btn:active {
            transform: scale(0.95);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(80, 70, 229, 0.1);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .file-icon.pdf { background: #dc2626; }
        .file-icon.doc { background: #2563eb; }
        .file-icon.txt { background: #059669; }
        .file-icon.img { background: #7c3aed; }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .file-size {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .file-remove:hover {
            background: var(--error);
            color: white;
        }

        .attached-file-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .attached-file-chip i {
            font-size: 0.7rem;
        }

        .processing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--info);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .processing-indicator i {
            animation: spin 1s linear infinite;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            /* Prevent horizontal scroll on mobile */
            body {
                overflow-x: hidden;
                max-width: 100vw;
            }
            
            /* NUCLEAR OPTION: Hide ALL sections by default on mobile */
            section.section,
            .section,
            [class*="section"] {
                display: none !important;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                padding: 1rem;
            }
            
            /* Only show dashboard section when it has display style */
            #dashboardSection {
                display: none !important;
            }
            
            #dashboardSection[style*="display: block"],
            #dashboardSection[style*="display: flex"] {
                display: block !important;
            }
            
            /* Show any section that has explicit display style */
            section[style*="display: block"],
            section[style*="display: flex"],
            .section[style*="display: block"],
            .section[style*="display: flex"] {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                position: relative !important;
                left: auto !important;
            }
            
            /* Specific sections that should show when active */
            #makePaperSection[style*="display: block"],
            #makePaperSection[style*="display: flex"],
            #questionBankSection[style*="display: block"],
            #questionBankSection[style*="display: flex"],
            #ultraAiGuidanceSection[style*="display: block"],
            #ultraAiGuidanceSection[style*="display: flex"] {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Hide all admin tabs on mobile */
            .admin-tab-content {
                display: none !important;
            }
            
            .admin-tab-content.active {
                display: block !important;
            }
            
            /* HARD FIX: Hide Documents tab content on mobile by default */
            #documents-tab {
                display: none !important;
            }
            
            /* Only show documents tab when it's explicitly active */
            #documents-tab.active {
                display: block !important;
            }
            
            .dashboard-scroll-container {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            /* Hide any floating or absolute positioned sections */
            .section:not([style*="display: block"]):not([style*="display: flex"]) {
                visibility: hidden !important;
                opacity: 0 !important;
                pointer-events: none !important;
                position: absolute !important;
                left: -9999px !important;
            }
            
            /* AI SECTION MOBILE FIX */
            #ultraAiGuidanceSection {
                height: 100vh !important;
                overflow: hidden !important;
                padding: 0 !important;
            }
            
            .chatgpt-container {
                display: flex !important;
                flex-direction: column !important;
                height: 100vh !important;
                width: 100vw !important;
                max-width: 100vw !important;
                overflow: hidden !important;
            }
            
            .chatgpt-sidebar {
                width: 100% !important;
                height: auto !important;
                max-height: 0 !important;
                overflow: hidden !important;
                border-right: none !important;
                border-bottom: 1px solid #e5e5e5 !important;
                transition: max-height 0.3s ease !important;
                flex-shrink: 0 !important;
            }
            
            .chatgpt-sidebar.mobile-open {
                max-height: 80vh !important;
                overflow-y: auto !important;
            }
            
            .chatgpt-main {
                flex: 1 !important;
                width: 100% !important;
                max-width: 100vw !important;
                min-height: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            
            .messages-container {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 1rem !important;
                width: 100% !important;
                max-width: 100vw !important;
                min-height: 0 !important;
            }
            
            .input-area {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 1rem !important;
                background: white !important;
                border-top: 1px solid #e5e5e5 !important;
                flex-shrink: 0 !important;
            }
            
            .input-container {
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            .input-wrapper {
                width: 100% !important;
            }
            
            .input-wrapper textarea {
                width: 100% !important;
                max-width: 100% !important;
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            .welcome-screen {
                padding: 1rem !important;
            }
            
            .examples-section {
                grid-template-columns: 1fr !important;
            }
            
            .example-category {
                margin-bottom: 1.5rem !important;
            }
            
            /* Mobile menu toggle button for AI sidebar */
            .mobile-menu-toggle {
                display: block !important;
                position: fixed !important;
                top: 1rem !important;
                left: 1rem !important;
                z-index: 1000 !important;
                background: white !important;
                border: 1px solid #e5e5e5 !important;
                border-radius: 8px !important;
                padding: 0.5rem !important;
                cursor: pointer !important;
            }
            
            /* FIX ALL MODALS ON MOBILE */
            .modal {
                padding: 0.5rem !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .modal-content {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
                margin: 0 !important;
                overflow-y: auto !important;
            }
            
            .modal-header {
                padding: 1rem !important;
                flex-wrap: wrap !important;
            }
            
            .modal-title {
                font-size: 1.25rem !important;
                word-break: break-word !important;
            }
            
            .modal-body {
                padding: 1rem !important;
                max-height: calc(90vh - 150px) !important;
                overflow-y: auto !important;
            }
            
            .modal-footer {
                padding: 1rem !important;
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .modal-footer .btn {
                width: 100% !important;
            }
            
            /* Fix buttons in modals */
            .modal .btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.95rem !important;
                white-space: normal !important;
                word-break: break-word !important;
            }
            
            /* MAKE PAPER SECTION MOBILE FIX */
            #makePaperSection {
                padding: 1rem !important;
                overflow-y: auto !important;
                height: auto !important;
                min-height: 100vh !important;
            }
            
            #makePaperSection .section-header {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            #makePaperSection .exam-type-tab {
                min-width: 150px !important;
                padding: 0.75rem 1rem !important;
                flex-direction: row !important;
                align-items: center !important;
            }
            
            #makePaperSection .exam-type-tab > div:first-child {
                flex-shrink: 0 !important;
            }
            
            #makePaperSection .exam-type-tab > div:last-child {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            #makePaperSection .exam-type-tab div[style*="font-size: 1.25rem"] {
                white-space: nowrap !important;
                overflow: visible !important;
            }
            
            #makePaperSection .exam-type-tab div[style*="font-size: 0.85rem"] {
                white-space: nowrap !important;
                overflow: visible !important;
            }
            
            #paperSubjectCards {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .subject-card {
                padding: 1.5rem !important;
                min-height: auto !important;
            }
            
            .subject-card > div {
                flex-direction: row !important;
                align-items: center !important;
                gap: 1rem !important;
            }
            
            .subject-card div[style*="font-size: 1.5rem"] {
                font-size: 1.25rem !important;
                white-space: normal !important;
                word-break: normal !important;
                overflow-wrap: normal !important;
            }
            
            /* Fix exam type tabs text */
            .exam-type-tab {
                white-space: normal !important;
            }
            
            .exam-type-tab > div > div {
                white-space: normal !important;
                word-break: normal !important;
            }
            
            #paperQuestionsList {
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            /* Question cards in make paper */
            .question-card,
            .paper-question-card {
                width: 100% !important;
                max-width: 100% !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Filter bar in make paper */
            #makePaperSection .filter-bar,
            #makePaperSection > div > div {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 0.75rem !important;
            }
            
            /* Selection summary */
            #makePaperSection .selection-summary {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .keyboard-shortcuts-help {
                bottom: 80px;
                right: 10px;
                left: 10px;
                width: auto;
                max-height: 60vh;
            }

            .file-drop-zone {
                padding: 1.5rem 1rem;
            }

            .processing-options {
                padding: 1rem;
            }

            .processing-options > div {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .shortcuts-toggle-btn {
                bottom: 10px;
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 1.1rem;
            }

            .shortcuts-content {
                max-height: 300px;
            }

            .shortcuts-section {
                padding: 0.75rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .keyboard-shortcuts-help {
                max-height: 50vh;
            }

            .shortcuts-content {
                max-height: 250px;
            }

            .shortcut-item {
                margin-bottom: 0.5rem;
                padding: 0.4rem 0.5rem;
            }

            .shortcut-keys {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
        }

        /* Edit Modal Styles */
        .edit-tab.active {
            color: var(--primary) !important;
            border-bottom-color: var(--primary) !important;
            background: rgba(80, 70, 229, 0.05);
        }

        .edit-tab:hover {
            color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
        }

        .edit-tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Preview Question Styles */
        .preview-question-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        .preview-question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .preview-question-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .preview-meta-tag {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .preview-meta-tag.subject {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .preview-meta-tag.difficulty-easy {
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
        }

        .preview-meta-tag.difficulty-medium {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
        }

        .preview-meta-tag.difficulty-hard {
            background: rgba(239, 68, 68, 0.1);
            color: #b91c1c;
        }

        .preview-question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
        }

        .preview-options {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .preview-option {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .preview-option:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.02);
        }

        .preview-option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .preview-option-label {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-200);
            color: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .preview-option.correct .preview-option-label {
            background: var(--success);
            color: white;
        }

        .preview-option-text {
            flex: 1;
            line-height: 1.5;
        }

        .preview-solution {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--primary);
        }

        .preview-solution-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }

        .preview-solution-text {
            line-height: 1.6;
            color: var(--gray-700);
        }

        /* Responsive Edit Modal */
        @media (max-width: 1200px) {
            .modal-body {
                flex-direction: column !important;
                height: auto !important;
            }
            
            .edit-form-section {
                border-right: none !important;
                border-bottom: 1px solid var(--gray-200);
            }
            
            .preview-section {
                max-height: 400px;
            }
        }



        /* Enhanced Dashboard Styles */
        .dashboard {
            min-height: 100vh;
            background: var(--gray-50);
            display: none;
            flex-direction: column;
        }
        
        .dashboard.active {
            display: flex;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 1rem;
            flex-wrap: nowrap;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }

        .header-logo i {
            font-size: 2rem;
        }

        .header-nav {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
        }
        
        .header-nav::-webkit-scrollbar {
            display: none;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--gray-600);
            position: relative;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: var(--gray-100);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(80, 70, 229, 0.3);
        }
        
        /* Responsive: Stack icon and text vertically on smaller screens */
        @media (max-width: 1200px) {
            .nav-btn {
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-width: 70px;
            }
            
            .nav-btn i {
                font-size: 1.1rem;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            white-space: nowrap;
            margin-left: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .stat-change {
            color: var(--success);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Enhanced Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(80, 70, 229, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 20px rgba(80, 70, 229, 0.3);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .card-description {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        /* Section Styles */
        .section {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-title i {
            color: var(--primary);
        }

        .section-subtitle {
            font-size: 1.1rem;
            color: var(--gray-600);
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-text {
            display: block;
            font-size: 0.8rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Enhanced Exam Type Tabs */
        .exam-type-tabs {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 3rem;
            justify-content: center;
        }

        .exam-type-tab {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .tab-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--gray-600);
            transition: all 0.3s ease;
        }

        .tab-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .tab-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .tab-subtitle {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .exam-type-tab:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(80, 70, 229, 0.15);
        }

        .exam-type-tab:hover .tab-icon {
            background: var(--primary);
            color: white;
        }

        .exam-type-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(80, 70, 229, 0.25);
        }

        .exam-type-tab.active .tab-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .exam-type-tab.active .tab-title,
        .exam-type-tab.active .tab-subtitle {
            color: white;
        }

        /* Modern Dashboard Styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-900);
            margin: 0 0 0.5rem 0;
        }

        .dashboard-subtitle {
            font-size: 1.1rem;
            color: var(--gray-600);
            margin: 0;
        }

        .logout-btn {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: var(--gray-200);
        }

        /* Stats Overview */
        .stats-overview {
            margin-bottom: 3rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .stat-header {
            border-bottom: 3px solid var(--primary);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            letter-spacing: 0.05em;
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon-wrapper.purple {
            background: var(--primary);
        }

        .stat-icon-wrapper.blue {
            background: var(--info);
        }

        .stat-icon-wrapper.green {
            background: var(--success);
        }

        .stat-icon-wrapper.orange {
            background: var(--warning);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        /* Action Cards Grid */
        .action-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            transition: all 0.2s ease;
            position: relative;
        }

        .action-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .card-header-accent {
            height: 4px;
            width: 100%;
        }

        .card-header-accent.purple {
            background: var(--primary);
        }

        .card-header-accent.blue {
            background: var(--info);
        }

        .card-header-accent.green {
            background: var(--success);
        }

        .card-header-accent.orange {
            background: var(--warning);
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-icon-container {
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .card-icon.purple {
            background: var(--primary);
        }

        .card-icon.blue {
            background: var(--info);
        }

        .card-icon.green {
            background: var(--success);
        }

        .card-icon.orange {
            background: var(--warning);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0 0 0.5rem 0;
        }

        .card-description {
            color: var(--gray-600);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .card-action-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.025em;
        }

        .card-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .card-action-btn:hover::before {
            left: 100%;
        }

        .card-action-btn.purple {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .card-action-btn.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .card-action-btn.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .card-action-btn.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .card-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card-action-btn.purple:hover {
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .card-action-btn.blue:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .card-action-btn.green:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .card-action-btn.orange:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .card-action-btn:active {
            transform: translateY(-1px);
            transition: transform 0.1s ease;
        }

        .card-action-btn i {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .card-action-btn:hover i {
            transform: translateX(3px);
        }

        .card-action-btn span {
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        /* Enhanced Logout Button */
        .logout-btn {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .logout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .logout-btn:hover::before {
            left: 100%;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
            color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .logout-btn i {
            transition: transform 0.3s ease;
        }

        .logout-btn:hover i {
            transform: rotate(15deg);
        }

        /* Enhanced Navigation Buttons */
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.25rem;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            color: var(--gray-600);
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        /* Paper Maker Styles */
        .paper-maker-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .question-selector {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .question-select-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .question-select-item:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
        }

        .question-select-item.selected {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.1);
        }

        .paper-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .setting-input {
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(80, 70, 229, 0.1);
        }

        .logo-upload {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px dashed var(--gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .pdf-options {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pdf-option-btn {
            flex: 1;
            padding: 1.5rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .pdf-option-btn:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
            transform: translateY(-2px);
        }

        .pdf-option-btn.selected {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.1);
        }

        .practice-test-interface {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .practice-question-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary);
        }

        .practice-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .practice-option:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
        }

        .practice-option.selected {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.1);
        }

        .practice-option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .practice-option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn i {
            transition: transform 0.3s ease;
        }

        .nav-btn:hover i {
            transform: scale(1.1);
        }

        .nav-btn.active i {
            transform: scale(1.05);
        }

        .exam-type-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .exam-type-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .exam-content {
            display: none;
        }

        .exam-content.active {
            display: block;
        }

        .subject-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .subject-tab {
            padding: 1rem 2rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-700);
        }

        .subject-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .subject-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .questions-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            min-height: 400px;
        }

        .subject-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        button[onclick*="showChapterQuestions"]:hover {
            background: #5046e5 !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .question-card {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .questions-container {
            display: grid;
            gap: 1.5rem;
        }

        /* Test Section Styles */
        .test-chapters-container {
            margin-top: 2rem;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .chapter-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .chapter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .chapter-card h4 {
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .chapter-card p {
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .test-interface {
            padding: 2rem;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .test-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            color: var(--gray-500);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            padding: 4px;
        }

        .test-close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            transform: scale(1.1);
        }

        .section-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            color: var(--gray-500);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            padding: 4px;
        }

        .section-close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            transform: scale(1.1);
        }

        .test-info {
            display: flex;
            gap: 2rem;
            font-weight: 500;
        }

        .test-info span {
            color: var(--gray-600);
        }

        #timer {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .test-question {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: var(--gray-800);
            white-space: pre-line;
        }

        .test-options {
            display: grid;
            gap: 0.75rem;
        }

        .test-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .test-option:hover {
            background: var(--gray-100);
        }

        .test-option input[type="radio"] {
            margin: 0;
        }

        .numerical-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .numerical-input input {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }

        .test-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }



        /* Enhanced Question Modal Styles */
        .enhanced-question-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .enhanced-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .enhanced-tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .enhanced-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .enhanced-tab-content {
            display: none;
        }

        .enhanced-tab-content.active {
            display: block;
        }

        .enhanced-editor {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .editor-toolbar {
            background: var(--gray-50);
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            gap: 0.5rem;
        }

        .editor-btn,
        .editor-btn-sm {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .editor-btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        .editor-btn:hover,
        .editor-btn-sm:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .enhanced-textarea {
            border: none;
            border-radius: 0;
            resize: vertical;
        }

        .enhanced-options-container {
            display: grid;
            gap: 1rem;
        }

        .enhanced-option-item {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 1rem;
            background: var(--gray-50);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .option-label {
            font-weight: 600;
            color: var(--primary);
        }

        .option-controls {
            display: flex;
            gap: 0.25rem;
        }

        .media-upload-section {
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .math-tools {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .math-btn {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .math-btn:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .uploaded-image {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--gray-300);
        }

        .uploaded-image img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Advanced Enhanced Question Styles */
        .graph-tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .graph-tool-btn {
            padding: 1.5rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .graph-tool-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .graph-tool-btn i {
            font-size: 2rem;
            color: var(--primary);
        }

        .graph-tool-btn span {
            font-weight: 600;
            color: var(--gray-800);
        }

        .graph-tool-btn small {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        .question-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .question-type-option {
            cursor: pointer;
        }

        /* CSS Variables */
        :root {
            /* Modern Color Palette 2024 */
            --primary: #5046e5;
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --secondary: #06b6d4;
            --accent: #f97316;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f43f5e;
            --info: #3b82f6;

            /* Neutral Colors - Refined */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --black: #020617;

            /* Dark Theme - Enhanced */
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-card: #334155;
            --dark-border: #475569;
            --dark-text: #f8fafc;
            --dark-text-muted: #94a3b8;

            /* Background Colors */
            --bg-primary: var(--white);
            --bg-secondary: var(--gray-50);

            /* Modern Gradients 2024 */
            --gradient-primary: linear-gradient(135deg, #5046e5 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --gradient-accent: linear-gradient(135deg, #f97316 0%, #f43f5e 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            --gradient-error: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            --gradient-hero: linear-gradient(135deg, #5046e5 0%, #8b5cf6 50%, #f43f5e 100%);
            --gradient-subtle: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);

            /* Enhanced Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.4);
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --shadow-outline: 0 0 0 3px rgba(79, 70, 229, 0.5);

            /* Modern Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;

            /* Enhanced Spacing */
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            --spacing-10: 2.5rem;
            --spacing-12: 3rem;
            --spacing-16: 4rem;
            --spacing-20: 5rem;
            --spacing-24: 6rem;

            /* Enhanced Transitions */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);

            /* Typography */
            --font-primary: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Z-index layers */
            --z-negative: -1;
            --z-base: 0;
            --z-elevated: 10;
            --z-dropdown: 1000;
            --z-sticky: 1100;
            --z-fixed: 1200;
            --z-modal: 1300;
            --z-popover: 1400;
            --z-tooltip: 1500;
            --z-drawer: 1600;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
            font-family: var(--font-primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--gray-800);
            line-height: 1.7;
        }

        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            z-index: 10000;
        }
        
        .auth-container.hidden {
            display: none !important;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(99, 102, 241, 0.2) 0%, transparent 50%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(1deg);
            }
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(25px);
            border-radius: 28px;
            padding: 2.5rem;
            box-shadow:
                0 32px 64px rgba(0, 0, 0, 0.12),
                0 16px 32px rgba(99, 102, 241, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            margin: auto;
        }

        /* Custom scrollbar for auth-card */
        .auth-card::-webkit-scrollbar {
            width: 6px;
        }

        .auth-card::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .auth-card::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        .auth-card::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .auth-card:hover {
            transform: translateY(-5px);
            box-shadow:
                0 40px 80px rgba(0, 0, 0, 0.15),
                0 20px 40px rgba(99, 102, 241, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo-icon {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: 
                0 15px 40px rgba(102, 126, 234, 0.4),
                0 5px 15px rgba(118, 75, 162, 0.3),
                inset 0 -2px 10px rgba(0, 0, 0, 0.1);
            animation: logoFloat 3s ease-in-out infinite;
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            border-radius: 26px;
            z-index: -1;
            opacity: 0.5;
            filter: blur(10px);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        @keyframes logoGlow {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 0.8;
            }
        }

        .logo-icon i {
            font-size: 3rem;
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .logo-subtitle {
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .auth-toggle {
            display: flex;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .auth-toggle-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--gray-600);
            position: relative;
            overflow: hidden;
        }

        .auth-toggle-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .auth-toggle-btn:hover::before {
            left: 100%;
        }

        .auth-toggle-btn.active {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(80, 70, 229, 0.2);
        }

        .auth-toggle-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-1px);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Enhanced Form Group Styles */
        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .form-label::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .form-group:focus-within .form-label {
            color: var(--primary);
        }

        .form-group:focus-within .form-label::after {
            width: 30px;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            color: var(--gray-800);
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .form-input::placeholder {
            color: var(--gray-400);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow:
                0 0 0 4px rgba(99, 102, 241, 0.1),
                0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
            background: #ffffff;
        }

        .form-input:focus::placeholder {
            color: var(--gray-300);
        }

        .form-input:valid {
            border-color: var(--success);
        }

        .form-input:invalid:not(:placeholder-shown) {
            border-color: var(--error);
        }

        .form-group.has-error .form-input {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .form-group.has-success .form-input {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Enhanced Role Selector */
        .role-selector {
            position: relative;
        }

        .role-dropdown {
            position: relative;
            width: 100%;
        }

        .role-selected {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .role-selected:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .role-selected.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .role-selected-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .role-icon {
            font-size: 1.1rem;
            color: var(--gray-500);
            transition: color 0.3s ease;
        }

        .role-selected.active .role-icon {
            color: var(--primary);
        }

        .role-text {
            font-size: 1rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            color: var(--gray-400);
            transition: all 0.3s ease;
        }

        .role-selected.active .dropdown-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .role-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .role-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .role-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--gray-100);
        }

        .role-option:last-child {
            border-bottom: none;
        }

        .role-option:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(4px);
        }

        .role-option.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-left: 3px solid var(--primary);
        }

        .role-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gray-600);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .role-option:hover .role-option-icon {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            transform: scale(1.1);
        }

        .role-option-content {
            flex: 1;
        }

        .role-option-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .role-option-desc {
            font-size: 0.85rem;
            color: var(--gray-500);
            line-height: 1.4;
        }

        /* Custom scrollbar for role options */
        .role-options::-webkit-scrollbar {
            width: 4px;
        }

        .role-options::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 2px;
        }

        .role-options::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        /* Enhanced Chapter Selector */
        .chapter-selector-container {
            position: relative;
        }

        .chapter-dropdown {
            position: relative;
            width: 100%;
        }

        .chapter-selected {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chapter-selected:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .chapter-selected.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .chapter-selected-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chapter-icon {
            font-size: 1.1rem;
            color: var(--gray-500);
            transition: color 0.3s ease;
        }

        .chapter-selected.active .chapter-icon {
            color: var(--primary);
        }

        .chapter-text {
            font-size: 1rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        .chapter-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 0.5rem;
            max-height: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chapter-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .chapter-search {
            position: relative;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .chapter-search input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .chapter-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chapter-search i {
            position: absolute;
            right: 1.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 0.9rem;
        }

        .chapter-list {
            flex: 1;
            overflow-y: auto;
            max-height: 250px;
        }

        .chapter-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--gray-100);
        }

        .chapter-option:last-child {
            border-bottom: none;
        }

        .chapter-option:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(4px);
        }

        .chapter-option.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-left: 3px solid var(--primary);
        }

        .chapter-option-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .chapter-option-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--gray-600);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .chapter-option:hover .chapter-option-icon {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            transform: scale(1.1);
        }

        .chapter-option-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-800);
        }

        .chapter-option-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chapter-option:hover .chapter-option-actions {
            opacity: 1;
        }

        .chapter-delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--error);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .chapter-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .chapter-actions {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .add-chapter-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .add-chapter-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #7c3aed 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Custom scrollbar for chapter list */
        .chapter-list::-webkit-scrollbar {
            width: 4px;
        }

        .chapter-list::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 2px;
        }

        .chapter-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        /* LaTeX Dropdown Styles */
        .latex-dropdown-container {
            position: relative;
        }

        .latex-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .latex-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .latex-category {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .latex-category:last-child {
            border-bottom: none;
        }

        .latex-category h5 {
            margin: 0 0 0.75rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .latex-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .latex-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .latex-option:hover {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
            transform: translateY(-1px);
        }

        .latex-preview {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: var(--gray-800);
            font-weight: 500;
        }

        .latex-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Enhanced Question Information Form */
        .question-info-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .header-content {
            flex: 1;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0 0 0.25rem 0;
        }

        .section-subtitle {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin: 0;
        }

        .enhanced-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .enhanced-form-group {
            position: relative;
        }

        .enhanced-form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .label-icon {
            font-size: 0.85rem;
            color: var(--primary);
        }

        .select-wrapper {
            position: relative;
        }

        .enhanced-form-select {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: var(--gray-800);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .enhanced-form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .enhanced-form-select:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .select-arrow {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 0.8rem;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .enhanced-form-select:focus+.select-arrow,
        .select-wrapper.focused .select-arrow {
            color: var(--primary);
            transform: translateY(-50%) rotate(180deg);
        }

        .enhanced-form-select.has-value {
            border-color: var(--success);
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        }

        .enhanced-form-select.has-value+.select-arrow {
            color: var(--success);
        }

        /* Option styling */
        .enhanced-form-select option {
            padding: 0.75rem;
            background: white;
            color: var(--gray-800);
        }

        .enhanced-form-select option:hover {
            background: var(--gray-50);
        }

        /* Responsive design for enhanced form */
        @media (max-width: 768px) {
            .enhanced-form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .question-info-header {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .header-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .enhanced-form-select {
                padding: 0.875rem 2.5rem 0.875rem 0.875rem;
            }

            .chapter-selected {
                padding: 0.875rem 1rem;
            }

            .chapter-option {
                padding: 0.75rem;
            }

            .chapter-option-icon {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .chapter-search {
                padding: 0.75rem;
            }

            .chapter-search input {
                padding: 0.625rem 2rem 0.625rem 0.75rem;
                font-size: 0.85rem;
            }

            .chapter-actions {
                padding: 0.75rem;
            }

            .add-chapter-btn {
                padding: 0.625rem 0.875rem;
                font-size: 0.85rem;
            }
        }

        .form-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .password-toggle:hover {
            color: var(--primary);
            background: rgba(80, 70, 229, 0.1);
        }

        /* Enhanced Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(80, 70, 229, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(80, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-block {
            width: 100%;
        }

        /* AI 2024 Container Styles */
        .ai-2024-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100%;
            background-color: var(--bg-primary);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            transition: all var(--transition-normal);
        }

        /* Sidebar Styles */
        .ai-sidebar {
            background-color: var(--gray-50);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all var(--transition-normal);
        }

        .sidebar-header {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: var(--spacing-2) var(--spacing-4);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .new-chat-btn:hover {
            background-color: var(--primary-dark);
        }

        .sidebar-tabs {
            display: flex;
            padding: var(--spacing-2);
            gap: var(--spacing-1);
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2);
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .sidebar-tab.active {
            background-color: var(--gray-200);
            color: var(--gray-900);
        }

        .sidebar-tab:hover:not(.active) {
            background-color: var(--gray-100);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
            padding: var(--spacing-3);
            height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        .search-container {
            margin-bottom: var(--spacing-3);
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--spacing-2) var(--spacing-3);
        }

        .search-input-wrapper i {
            color: var(--gray-400);
            margin-right: var(--spacing-2);
        }

        .search-input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            color: var(--gray-900);
            outline: none;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-8);
            text-align: center;
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: var(--spacing-4);
            color: var(--gray-400);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state p {
            font-weight: 500;
            margin: 0 0 var(--spacing-1);
            color: var(--gray-700);
        }

        .empty-state span {
            font-size: 14px;
        }

        .setting-group {
            margin-bottom: var(--spacing-6);
        }

        .setting-group h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--spacing-3);
        }

        .setting-select {
            width: 100%;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            background-color: var(--white);
            font-size: 14px;
            color: var(--gray-900);
            outline: none;
        }

        .theme-selector {
            display: flex;
            gap: var(--spacing-2);
        }

        .theme-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-1);
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            background-color: var(--white);
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-btn i {
            font-size: 16px;
            margin-bottom: var(--spacing-1);
        }

        .theme-btn.active {
            background-color: var(--gray-100);
            border-color: var(--primary);
            color: var(--primary);
        }

        .sidebar-footer {
            padding: var(--spacing-3);
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            color: var(--gray-900);
            margin: 0;
            font-size: 14px;
        }

        .user-status {
            font-size: 12px;
            color: var(--gray-500);
        }

        .logout-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background-color: var(--gray-100);
            border: none;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background-color: var(--gray-200);
            color: var(--error);
        }

        /* Main Chat Area */
        .ai-main {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--white);
        }

        .ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-size: 13px;
            color: var(--gray-600);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-400);
        }

        .status-dot.active {
            background-color: var(--success);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background-color: transparent;
            border: none;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .header-btn:hover {
            background-color: var(--gray-100);
            color: var(--gray-900);
        }

        /* Messages Area */
        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-4);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-6);
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-8) var(--spacing-4);
            text-align: center;
        }

        .welcome-header {
            margin-bottom: var(--spacing-8);
        }

        .welcome-icon {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            margin: 0 auto var(--spacing-6);
        }

        .icon-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--gradient-primary);
            opacity: 0.3;
            filter: blur(10px);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.1;
            }

            100% {
                transform: scale(1);
                opacity: 0.3;
            }
        }

        .welcome-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0 0 var(--spacing-2);
        }

        .welcome-header p {
            font-size: 16px;
            color: var(--gray-600);
            margin: 0;
        }

        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .feature-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-4);
            width: 100%;
            max-width: 800px;
            margin-bottom: var(--spacing-8);
        }

        .feature-card {
            background-color: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            text-align: left;
            transition: all var(--transition-fast);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--gradient-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 20px;
            margin-bottom: var(--spacing-3);
        }

        .feature-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0 0 var(--spacing-1);
        }

        .feature-card p {
            font-size: 14px;
            color: var(--gray-600);
            margin: 0;
        }

        .quick-prompts {
            width: 100%;
            max-width: 800px;
        }

        .quick-prompts h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
            margin: 0 0 var(--spacing-3);
            text-align: left;
        }

        .prompt-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
        }

        .prompt-chip {
            background-color: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-full);
            padding: var(--spacing-2) var(--spacing-4);
            font-size: 14px;
            color: var(--gray-700);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .prompt-chip:hover {
            background-color: var(--gray-200);
            color: var(--gray-900);
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: var(--spacing-4);
            max-width: 100%;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: var(--primary);
            color: white;
        }

        .message-content {
            background-color: var(--gray-100);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            max-width: 80%;
        }

        .message.user .message-content {
            background-color: var(--primary);
            color: white;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.5;
        }

        .message.user .message-text {
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
            padding: var(--spacing-2) var(--spacing-4);
            background-color: var(--gray-100);
            border-radius: var(--radius-full);
            width: fit-content;
            margin-top: var(--spacing-2);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-400);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-4px);
            }
        }

        /* Input Area */
        .ai-input-area {
            padding: var(--spacing-4);
            border-top: 1px solid var(--gray-200);
            position: relative;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background-color: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2);
            transition: all var(--transition-fast);
        }

        .input-container:focus-within {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .input-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background-color: transparent;
            border: none;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .input-btn:hover {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper textarea {
            width: 100%;
            border: none;
            background: transparent;
            resize: none;
            padding: var(--spacing-2);
            font-size: 15px;
            color: var(--gray-900);
            outline: none;
            max-height: 200px;
            line-height: 1.5;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background-color: var(--primary);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
        }

        .input-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: var(--spacing-2);
            padding: 0 var(--spacing-2);
        }

        .model-selector {
            display: flex;
            align-items: center;
        }

        .model-selector select {
            border: none;
            background: transparent;
            font-size: 13px;
            color: var(--gray-600);
            outline: none;
            cursor: pointer;
        }

        .input-info {
            font-size: 12px;
            color: var(--gray-500);
        }

        .input-info kbd {
            background-color: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            padding: 1px 4px;
            font-family: var(--font-mono);
            font-size: 11px;
        }

        /* File Upload Area */
        .file-upload-area {
            background-color: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-3);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .file-upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--gray-200);
        }

        .file-upload-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .close-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            background-color: transparent;
            border: none;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .close-btn:hover {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .uploaded-files {
            padding: var(--spacing-3);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-2) var(--spacing-3);
            background-color: var(--gray-50);
            border-radius: var(--radius-md);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .file-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background-color: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-900);
        }

        .file-size {
            font-size: 12px;
            color: var(--gray-500);
        }

        .file-actions {
            display: flex;
            gap: var(--spacing-1);
        }

        .file-action-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            background-color: transparent;
            border: none;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .file-action-btn:hover {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .file-action-btn.remove:hover {
            color: var(--error);
        }

        .upload-actions {
            padding: var(--spacing-3);
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: var(--spacing-2) var(--spacing-4);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .upload-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .ai-2024-container {
                grid-template-columns: 1fr;
            }

            .ai-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100%;
                z-index: var(--z-drawer);
                transform: translateX(-100%);
            }

            .ai-sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu {
                display: flex !important;
            }

            .feature-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Performance Section Styles */
        .performance-dashboard {
            padding: 2rem;
            background: var(--gray-50);
            min-height: calc(100vh - 80px);
        }

        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .performance-card .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .performance-card .card-content h3 {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .performance-card .score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .performance-card .score-change {
            font-size: 0.85rem;
            color: var(--success);
            margin: 0;
        }

        .performance-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .performance-section h2 {
            font-size: 1.5rem;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .subject-performance {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .subject-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }

        .subject-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 120px;
        }

        .subject-info i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        .percentage {
            font-weight: 600;
            color: var(--gray-700);
            min-width: 50px;
            text-align: right;
        }

        .test-results {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .test-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }

        .test-info h4 {
            font-size: 1rem;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .test-info p {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin: 0;
        }

        .score-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .score-badge.high {
            background: var(--success);
            color: white;
        }

        .score-badge.medium {
            background: var(--warning);
            color: white;
        }

        .score-badge.low {
            background: var(--error);
            color: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .chart-card h3 {
            font-size: 1.1rem;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--gray-500);
            text-align: center;
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Admin Section Styles */
        .admin-dashboard {
            padding: 2rem;
            background: var(--gray-50);
            min-height: calc(100vh - 80px);
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .admin-tab {
            background: transparent;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 3px solid transparent;
        }

        .admin-tab:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .admin-tab.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-tab-content {
            display: none;
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .admin-section-header h2 {
            font-size: 1.5rem;
            color: var(--gray-900);
            margin: 0;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .users-table {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .users-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-badge.student {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .role-badge.teacher {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .role-badge.admin {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 0.5rem;
        }

        .btn-icon:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-icon.danger:hover {
            background: var(--error);
            color: white;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .analytics-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .analytics-card h3 {
            font-size: 1.1rem;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .settings-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .settings-card h3 {
            font-size: 1.1rem;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .setting-item input[type="text"],
        .setting-item input[type="number"],
        .setting-item input[type="email"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Section Header Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0 0 0.5rem 0;
        }

        .section-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
            margin: 0;
        }

        /* Question Bank Specific Styles */
        .exam-type-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .exam-type-tab {
            padding: 1.5rem 3rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .exam-type-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .exam-type-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        /* Language Selector Styles */
        .language-selector {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .language-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .language-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .language-btn.active {
            background: #667eea;
            color: white;
        }

        .subject-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .subject-tab {
            padding: 1rem 2rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-700);
        }

        .subject-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .subject-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Paper Step Styles */
        .paper-step {
            display: none;
        }

        .paper-step.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .question-select-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-select-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .question-select-item.selected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }
        
        /* Custom Checkbox Styles */
        .custom-checkbox {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .custom-checkbox:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .custom-checkbox.checked {
            animation: checkboxPop 0.3s ease;
        }
        
        @keyframes checkboxPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .custom-checkbox i {
            animation: checkmarkAppear 0.3s ease;
        }
        
        @keyframes checkmarkAppear {
            0% { 
                opacity: 0;
                transform: scale(0) rotate(-45deg);
            }
            100% { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .question-selector-item:hover {
            border-color: var(--primary) !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .question-selector-item.selected {
            border-color: var(--success) !important;
            background: rgba(16, 185, 129, 0.05) !important;
        }

        .created-paper-card {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dark Mode */
        .dark-mode .ai-2024-container {
            background-color: var(--dark-bg);
        }

        .dark-mode .ai-sidebar {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .dark-mode .sidebar-header {
            border-color: var(--dark-border);
        }

        .dark-mode .sidebar-header h2 {
            color: var(--dark-text);
        }

        .dark-mode .sidebar-tab {
            color: var(--dark-text-muted);
        }

        .dark-mode .sidebar-tab.active {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }

        .dark-mode .sidebar-tab:hover:not(.active) {
            background-color: var(--dark-card);
        }

        .dark-mode .search-input-wrapper {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
        }

        .dark-mode .search-input {
            color: var(--dark-text);
        }

        .dark-mode .empty-icon {
            background-color: var(--dark-card);
            color: var(--dark-text-muted);
        }

        .dark-mode .empty-state p {
            color: var(--dark-text);
        }

        .dark-mode .empty-state span {
            color: var(--dark-text-muted);
        }

        .dark-mode .setting-group h3 {
            color: var(--dark-text);
        }

        .dark-mode .setting-select {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .dark-mode .theme-btn {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text-muted);
        }

        .dark-mode .theme-btn.active {
            border-color: var(--primary);
            color: var(--primary-light);
        }

        .dark-mode .sidebar-footer {
            border-color: var(--dark-border);
        }

        .dark-mode .user-avatar {
            background-color: var(--dark-card);
            color: var(--dark-text-muted);
        }

        .dark-mode .user-name {
            color: var(--dark-text);
        }

        .dark-mode .user-status {
            color: var(--dark-text-muted);
        }

        .dark-mode .logout-btn {
            background-color: var(--dark-card);
            color: var(--dark-text-muted);
        }

        .dark-mode .ai-main {
            background-color: var(--dark-bg);
        }

        .dark-mode .ai-header {
            border-color: var(--dark-border);
        }

        .dark-mode .header-title h1 {
            color: var(--dark-text);
        }

        /* Enhanced UI Improvements */

        /* Better Subject Cards */
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .subject-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .subject-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .subject-card:hover::before {
            transform: scaleX(1);
        }

        .subject-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .subject-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .subject-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .subject-description {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .subject-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Enhanced Question Cards */
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .question-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .question-text {
            color: var(--gray-800);
            line-height: 1.6;
            margin-bottom: 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            white-space: pre-line;
        }
        
        .question-text p:first-child,
        .question-solution p:first-child {
            margin-top: 0;
        }

        .question-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-badge.easy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .difficulty-badge.medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .difficulty-badge.hard {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Enhanced Test Interface */
        .test-interface {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .test-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-info h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .test-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        #timer {
            font-size: 1.25rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .test-question {
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .test-question:last-child {
            border-bottom: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .question-number {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .test-options {
            display: grid;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .test-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-option:hover {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .test-option.selected {
            background: rgba(80, 70, 229, 0.1);
            border-color: var(--primary);
        }

        .test-controls {
            padding: 1.5rem 2rem;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Enhanced Modal Styles */
        .modal {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }

        .enhanced-modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--gray-200);
        }

        .enhanced-modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 20px 20px 0 0;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .section {
                padding: 1rem;
            }

            .section-title {
                font-size: 2rem;
            }

            .auth-card {
                padding: 2rem;
                margin: 1rem;
            }

            .logo-text {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .auth-card {
                padding: 1.5rem;
            }
        }

        /* Modern UI Components */
        .modern-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
        }

        .header-left h1.page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 0.25rem 0;
        }

        .header-left .page-subtitle {
            color: #6b7280;
            font-size: 1rem;
            margin: 0;
        }

        .header-right {
            display: flex;
            gap: 0.75rem;
        }

        .modern-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modern-btn.primary {
            background: #6366f1;
            color: white;
        }

        .modern-btn.primary:hover {
            background: #5856eb;
            transform: translateY(-1px);
        }

        .modern-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .modern-btn.secondary:hover {
            background: #e5e7eb;
        }

        /* Modern Stats Grid */
        .modern-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .modern-stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .modern-stat-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .stat-header {
            border-bottom: 3px solid #6366f1;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            letter-spacing: 0.05em;
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon.purple {
            background: #6366f1;
        }

        .stat-icon.blue {
            background: #3b82f6;
        }

        .stat-icon.green {
            background: #10b981;
        }

        .stat-icon.orange {
            background: #f59e0b;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* Modern Table Styles */
        .modern-table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modern-table {
            width: 100%;
            border-collapse: collapse;
        }

        .modern-table th {
            background: #f9fafb;
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }

        .modern-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .modern-table tr:hover {
            background: #f9fafb;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.student {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.teacher {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.admin {
            background: #fef3c7;
            color: #92400e;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .action-btn.edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn.edit:hover {
            background: #bfdbfe;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-btn.delete:hover {
            background: #fecaca;
        }

        /* Modern Cards */
        .modern-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .modern-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .card-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0.25rem 0 0 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modern-header {
                flex-direction: column;
                gap: 1rem;
            }

            .modern-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modern-table-container {
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .modern-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Subject Cards Modern */
        .subjects-modern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .subject-card-modern {
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .subject-card-modern:hover {
            border-color: #6366f1;
        }

        .subject-stats-modern {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f3f4f6;
        }

        .stat-item-small {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label-small {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .stat-value-small {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        /* Test Categories */
        .test-categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .test-category-card {
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .test-category-card:hover {
            border-color: #6366f1;
        }

        .test-subjects {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f3f4f6;
            flex-wrap: wrap;
        }

        .subject-tag {
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Create Test Modal Modern Styles */
        .create-test-modal .enhanced-modal-content {
            max-width: 600px;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .modern-form-group {
            margin-bottom: 1.5rem;
        }

        .modern-form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .modern-form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .modern-form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modern-form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .difficulty-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .difficulty-option-modern {
            position: relative;
            cursor: pointer;
        }

        .difficulty-option-modern input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .difficulty-option-modern .difficulty-card {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .difficulty-option-modern input[type="radio"]:checked+.difficulty-card {
            border-color: #6366f1;
            background: #f0f9ff;
        }

        .difficulty-option-modern:hover .difficulty-card {
            border-color: #6366f1;
        }

        .difficulty-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .difficulty-desc {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .info-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .info-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: #0369a1;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #0369a1;
        }

        .info-item i {
            font-size: 1rem;
        }

        .info-item .correct {
            color: #10b981;
        }

        .info-item .wrong {
            color: #ef4444;
        }

        .info-item .unattempted {
            color: #6b7280;
        }

        .dark-mode .ai-status {
            color: var(--dark-text-muted);
        }

        .dark-mode .header-btn {
            color: var(--dark-text-muted);
        }

        .dark-mode .header-btn:hover {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }

        .dark-mode .welcome-header h1 {
            color: var(--dark-text);
        }

        .dark-mode .welcome-header p {
            color: var(--dark-text-muted);
        }

        .dark-mode .feature-card {
            background-color: var(--dark-surface);
        }

        .dark-mode .feature-card h3 {
            color: var(--dark-text);
        }

        .dark-mode .feature-card p {
            color: var(--dark-text-muted);
        }

        .dark-mode .quick-prompts h3 {
            color: var(--dark-text);
        }

        .dark-mode .prompt-chip {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
            color: var(--dark-text-muted);
        }

        .dark-mode .prompt-chip:hover {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }

        .dark-mode .message-content {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }

        .dark-mode .typing-indicator {
            background-color: var(--dark-card);
        }

        .dark-mode .ai-input-area {
            border-color: var(--dark-border);
        }

        .dark-mode .input-container {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .dark-mode .input-btn {
            color: var(--dark-text-muted);
        }

        .dark-mode .input-btn:hover {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }

        .dark-mode .input-wrapper textarea {
            color: var(--dark-text);
        }

        .dark-mode .input-info {
            color: var(--dark-text-muted);
        }

        .dark-mode .input-info kbd {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
        }

        .dark-mode .file-upload-area {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .dark-mode .file-upload-header {
            border-color: var(--dark-border);
        }

        .dark-mode .file-upload-header h3 {
            color: var(--dark-text);
        }

        .dark-mode .file-item {
            background-color: var(--dark-card);
        }

        .dark-mode .file-name {
            color: var(--dark-text);
        }

        .dark-mode .upload-actions {
            border-color: var(--dark-border);
        }

        /*
 LaTeX Modal Styles */
        .latex-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .latex-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .latex-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gray-50);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .latex-modal-header h3 {
            margin: 0;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .latex-modal-body {
            padding: 1.5rem;
        }

        .latex-modal-body p {
            margin: 0 0 1rem 0;
            color: var(--gray-600);
        }

        .latex-input-container {
            margin-bottom: 1.5rem;
        }

        .latex-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-family: var(--font-mono);
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
            background: var(--gray-50);
        }

        .latex-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: white;
        }

        .latex-preview-container {
            margin-bottom: 1.5rem;
        }

        .latex-preview-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .latex-preview-area {
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: white;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gray-600);
        }

        .latex-quick-buttons h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 0.9rem;
        }

        .latex-quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .latex-quick-btn {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            font-family: 'Times New Roman', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .latex-quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .latex-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: var(--gray-50);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }

        /* Enhanced Editor Styles */
        .editor-btn,
        .editor-btn-sm {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .editor-btn {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
        }

        .editor-btn-sm {
            padding: 0.25rem;
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
        }

        .editor-btn:hover,
        .editor-btn-sm:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .editor-btn.active,
        .editor-btn-sm.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Editor Separator */
        .editor-separator {
            width: 1px;
            height: 24px;
            background: var(--gray-300);
            margin: 0 0.5rem;
            align-self: center;
        }

        .latex-btn,
        .latex-btn-sm {
            background: white !important;
            border: 1px solid var(--gray-300) !important;
            color: var(--gray-700) !important;
        }

        .latex-btn:hover,
        .latex-btn-sm:hover {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        /* Enhanced Form Styles */
        .enhanced-textarea {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            resize: vertical;
            font-family: var(--font-primary);
            transition: border-color 0.2s ease;
        }

        .enhanced-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .enhanced-options-container {
            display: grid;
            gap: 1rem;
        }

        .enhanced-option-item {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 1rem;
            background: var(--gray-50);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .option-label {
            font-weight: 600;
            color: var(--primary);
        }

        .option-controls {
            display: flex;
            gap: 0.25rem;
        }

        /* Responsive Design for LaTeX Modal */
        @media (max-width: 768px) {
            .latex-modal-content {
                width: 95%;
                margin: 1rem;
            }

            .latex-quick-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .latex-modal-footer {
                flex-direction: column;
            }

            .latex-modal-header {
                padding: 1rem;
            }

            .latex-modal-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .latex-quick-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .latex-quick-btn {
                padding: 0.5rem;
                font-size: 1rem;
                min-height: 40px;
            }
        }

        .question-type-option input[type="radio"] {
            display: none;
        }

        .option-card {
            padding: 1.5rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .question-type-option input[type="radio"]:checked+.option-card {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .option-card i {
            font-size: 2rem;
            color: var(--primary);
        }

        .option-card span {
            font-weight: 600;
            color: var(--gray-800);
        }

        .option-card small {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        .interactive-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .interactive-btn:hover {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }



        .graph-canvas-container {
            position: relative;
        }

        #graphCanvas {
            max-width: 100%;
            height: auto;
        }

        /* Chapter Input Container Styles */
        .chapter-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chapter-input-container input {
            flex: 1;
        }

        .add-chapter-btn {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .add-chapter-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .add-chapter-btn i {
            font-size: 0.9rem;
        }

        /* Enhanced Editor Toolbar Styles */
        .editor-toolbar {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 0.5rem;
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .editor-btn {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
        }

        .editor-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .editor-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .editor-btn-sm {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
        }

        .editor-btn-sm:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .latex-btn {
            background: white !important;
            border: 1px solid var(--gray-300) !important;
            color: var(--gray-700) !important;
        }

        .latex-btn:hover {
            background: var(--gray-100) !important;
            border-color: var(--gray-400) !important;
        }

        .latex-btn-sm {
            background: white !important;
            border: 1px solid var(--gray-300) !important;
            color: var(--gray-700) !important;
        }

        .latex-btn-sm:hover {
            background: var(--gray-100) !important;
            border-color: var(--gray-400) !important;
        }

        /* Enhanced LaTeX Dropdown Styles */
        .latex-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            min-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .latex-dropdown.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .latex-dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .latex-dropdown-header h4 {
            margin: 0;
            color: var(--gray-800);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .latex-input-section {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .latex-input-wrapper {
            position: relative;
        }

        .latex-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s ease;
        }

        .latex-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .latex-preview {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--gray-50);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .latex-options {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .latex-option {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .latex-option:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .latex-option-category {
            grid-column: 1 / -1;
            background: var(--gray-100);
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: default;
        }

        .latex-option-category:hover {
            background: var(--gray-100);
            color: var(--gray-700);
            transform: none;
            box-shadow: none;
        }

        .latex-actions {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            background: var(--gray-50);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        /* LaTeX Modal Styles */
        .latex-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .latex-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .latex-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .latex-modal-header h3 {
            margin: 0;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .latex-modal-body {
            padding: 1.5rem;
        }

        .latex-modal-body p {
            margin: 0 0 1rem 0;
            color: var(--gray-600);
        }

        .latex-input-container {
            margin-bottom: 1.5rem;
        }

        .latex-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .latex-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .latex-preview-container {
            margin-bottom: 1.5rem;
        }

        .latex-preview-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .latex-preview-area {
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--gray-50);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gray-600);
        }

        .latex-quick-buttons h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 0.9rem;
        }

        .latex-quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 0.5rem;
        }

        .latex-quick-btn {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            font-family: 'Times New Roman', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }

        .latex-quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .latex-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Add Chapter Modal Styles */
        .add-chapter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .add-chapter-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-2xl);
        }

        .add-chapter-modal h3 {
            margin: 0 0 1.5rem 0;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chapter-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .chapter-suggestion {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .chapter-suggestion:hover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        /* Responsive LaTeX Dropdown */
        @media (max-width: 768px) {
            .latex-dropdown {
                min-width: 300px;
                max-width: 90vw;
                left: 50%;
                transform: translateX(-50%);
            }

            .latex-options {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .chapter-input-container {
                flex-direction: column;
                align-items: stretch;
            }

            .add-chapter-btn {
                justify-content: center;
            }
        }

        /* Enhanced Custom Test Styles */
        .custom-test-interface {
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .test-title-section h2 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-800);
        }

        .test-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .test-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .timer-display {
            color: var(--primary) !important;
            font-weight: 700;
        }

        .test-progress {
            margin: 2rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 600;
            color: var(--gray-700);
            white-space: nowrap;
        }

        .custom-test-question {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .question-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .difficulty-badge.easy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .difficulty-badge.medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .difficulty-badge.hard {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .source-badge {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .custom-test-options {
            display: grid;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .custom-test-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-test-option:hover {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .custom-test-option.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            font-weight: 500;
            white-space: pre-line;
        }

        .numerical-input-container {
            margin-top: 1.5rem;
        }

        .numerical-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .numerical-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .numerical-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        .test-results {
            text-align: center;
            padding: 3rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .results-header {
            margin-bottom: 3rem;
        }

        .results-header h2 {
            margin-bottom: 2rem;
            color: var(--gray-800);
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--success));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: white;
        }

        .score-number {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .marking-scheme-display {
            background: rgba(99, 102, 241, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-weight: 600;
        }

        .stat-marks {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .marks-display {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
        }

        /* Enhanced Dashboard Layout */
        .dashboard {
            display: block;
            min-height: 100vh;
            background: var(--gray-50);
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .dashboard.hidden {
            display: none;
        }

        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1100;
            backdrop-filter: blur(10px);
            height: 50px;
            box-sizing: border-box;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .nav-btn:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }





        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
            overflow: hidden;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 300px;
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            padding: var(--space-xl) 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .nav-item {
            padding: var(--space-md) var(--space-xl);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            color: var(--gray-600);
            text-decoration: none;
            transition: var(--transition-base);
            border-left: 4px solid transparent;
            font-weight: 600;
            margin: 0 var(--space-xs);
            border-radius: var(--radius-md);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.1;
            transition: var(--transition-base);
        }

        .nav-item:hover::before,
        .nav-item.active::before {
            left: 0;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--primary);
            border-left-color: var(--primary);
            transform: translateX(8px);
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.2rem;
            z-index: 1;
        }

        .content-area-full {
            width: 100%;
            padding: 0;
            overflow: hidden;
            background: var(--gray-50);
            min-height: calc(100vh - 50px);
            box-sizing: border-box;
        }

        .dashboard-scroll-container {
            height: calc(100vh - 80px);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .dashboard-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .dashboard-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .dashboard-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .dashboard-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Ultra Modern AI Interface */
        .ultra-modern-ai-container {
            display: flex !important;
            height: calc(100vh - 50px) !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            overflow: hidden;
            margin: 0 !important;
            width: 100% !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            position: relative;
            box-sizing: border-box;
        }

        .floating-nav {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-sizing: border-box;
        }

        .nav-floating-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-floating-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
        }

        .nav-floating-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .ultra-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 80px 20px 20px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-height: calc(100vh - 120px);
            box-sizing: border-box;
        }

        .content-view {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .content-view.active {
            display: flex;
        }

        .ultra-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .ai-status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #2d3748;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg, #48bb78, #38a169);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .header-action-btn {
            background: transparent;
            border: none;
            color: #718096;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-action-btn:hover {
            background: rgba(113, 128, 150, 0.1);
            color: #2d3748;
            transform: scale(1.1);
        }

        .ultra-messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-sizing: border-box;
        }

        .ultra-welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
        }

        .welcome-animation {
            margin-bottom: 40px;
            position: relative;
        }

        /* Admin and performance sections as regular pages */
        #performanceSection,
        #adminSection {
            position: relative !important;
            top: auto !important;
            left: auto !important;
            width: 100% !important;
            height: auto !important;
            background: var(--gray-50) !important;
            z-index: auto !important;
            overflow-y: visible !important;
            padding: 20px !important;
            margin: 0 !important;
            box-sizing: border-box !important;
            min-height: calc(100vh - 80px) !important;
        }

        #performanceSection.active,
        #adminSection.active {
            display: block !important;
        }

        #performanceSection .section-header,
        #adminSection .section-header {
            position: relative !important;
            top: auto !important;
            background: transparent !important;
            z-index: auto !important;
            padding: 0 0 20px 0 !important;
            border-bottom: 1px solid var(--gray-200) !important;
            box-shadow: none !important;
            margin-bottom: 20px !important;
        }

        #performanceSection .section-dropdown,
        #adminSection .section-dropdown {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            max-height: none !important;
            height: auto !important;
        }

        #performanceSection .section-dropdown::before,
        #adminSection .section-dropdown::before {
            display: none !important;
        }

        /* Close button styling for admin and performance sections */
        .section-close-btn {
            position: absolute !important;
            top: 10px !important;
            right: 10px !important;
            background: var(--gray-200) !important;
            color: var(--gray-600) !important;
            border: none !important;
            width: 32px !important;
            height: 32px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 1rem !important;
            transition: all 0.3s ease !important;
            z-index: 10 !important;
        }

        .section-close-btn:hover {
            background: var(--gray-300) !important;
            color: var(--gray-800) !important;
            transform: none !important;
            box-shadow: var(--shadow-sm) !important;
        }

        /* Admin-only visibility controls - Now password-protected */
        .admin-only {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .admin-only.show-admin {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Admin elements are now always visible (password-protected) */
        #adminNavItem {
            display: flex !important;
            visibility: visible !important;
            opacity: 0 !important;
        }

        #adminNavItem.show-admin {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Additional safety - hide any button with admin text */
        button:contains("Admin Panel") {
            display: none !important;
        }

        /* Hide admin sections */
        #adminSection {
            display: none !important;
        }

        #adminSection.show-admin {
            display: block !important;
        }

        /* Rich media support for questions */
        .question-media-container {
            margin: 1rem 0;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .question-graph {
            width: 100%;
            height: 300px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        /* Media upload controls for admin */
        .media-upload-section {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .media-upload-section:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .media-upload-section.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .upload-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Media preview in questions */
        .media-preview {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
        }

        .media-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .media-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }



        /* Rich text editor for solutions */
        .rich-editor {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            min-height: 200px;
            background: white;
        }

        .editor-toolbar {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-300);
            padding: 0.5rem;
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .editor-btn {
            background: none;
            border: 1px solid transparent;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--gray-600);
            transition: all 0.2s ease;
        }

        .editor-btn:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .editor-btn.active {
            background: var(--primary);
            color: white;
        }

        .editor-content {
            padding: 1rem;
            min-height: 150px;
            outline: none;
        }

        /* LaTeX math input */
        .math-input-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
        }

        .math-input-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            display: block;
        }

        .math-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .math-preview {
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 0.5rem;
            min-height: 50px;
        }

        .ai-orb {
            width: 120px;
            height: 120px;
            position: relative;
            margin: 0 auto;
        }

        .orb-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .orb-pulse {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Image Upload Styles */
        .upload-area {
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-dark);
            background: rgba(80, 70, 229, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-dark);
            background: rgba(80, 70, 229, 0.1);
            transform: scale(1.02);
        }

        .question-preview {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .question-preview:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .question-preview.selected {
            border-color: var(--primary);
            background: rgba(80, 70, 229, 0.05);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .question-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .meta-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .meta-tag.subject {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .meta-tag.difficulty {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .meta-tag.chapter {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .question-text {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--gray-800);
            margin-bottom: 1rem;
            white-space: pre-line;
        }

        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .option-item {
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .option-item.correct {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            font-weight: 600;
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .confidence-bar {
            width: 60px;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .edit-question-btn {
            background: none;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .edit-question-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .ultra-welcome-title {
            font-size: 36px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ultra-welcome-subtitle {
            font-size: 18px;
            color: #718096;
            margin-bottom: 48px;
            max-width: 600px;
            line-height: 1.6;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .quick-action-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .action-icon.study-plan {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .action-icon.concept {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .action-icon.problem {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .action-icon.practice {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
        }

        .action-content h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .action-content p {
            font-size: 14px;
            color: #718096;
            margin: 0;
        }

        .ultra-input-area {
            padding: 30px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .input-container-ultra {
            max-width: 800px;
            margin: 0 auto;
        }

        .input-wrapper-ultra {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: white;
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .input-wrapper-ultra:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-action-btn {
            background: transparent;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-action-btn:hover {
            background: rgba(113, 128, 150, 0.1);
            color: #667eea;
            transform: scale(1.1);
        }

        .input-field-container {
            flex: 1;
            position: relative;
        }

        .ultra-chat-input {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            background: transparent;
            color: #2d3748;
            font-family: inherit;
            max-height: 120px;
            min-height: 24px;
        }

        .ultra-chat-input::placeholder {
            color: #a0aec0;
        }

        .ultra-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ultra-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .input-footer-ultra {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            font-size: 12px;
        }

        .provider-select-ultra {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            color: #667eea;
            cursor: pointer;
        }

        .input-hints {
            color: #a0aec0;
        }

        .input-hints kbd {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* History and Settings Views */
        .history-content,
        .settings-content {
            padding: 40px;
            height: 100%;
            overflow-y: auto;
        }

        .history-content h2,
        .settings-content h2 {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 30px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
        }

        .setting-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .setting-select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4a5568;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .floating-nav {
                position: relative;
                top: 0;
                left: 0;
                margin: 20px;
                justify-content: center;
            }

            .ultra-main-content {
                margin: 10px;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .ultra-welcome-title {
                font-size: 28px;
            }

            .ultra-welcome-subtitle {
                font-size: 16px;
            }
        }

        /* New Modern ChatGPT Interface */
        .new-chatgpt-container {
            display: flex !important;
            height: calc(100vh - 50px) !important;
            background: #ffffff !important;
            overflow: hidden;
            margin: 0 !important;
            width: 100% !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .new-chatgpt-sidebar {
            width: 260px;
            background: #f7f7f8;
            border-right: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .new-sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .new-chat-btn {
            width: 100%;
            background: none;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .sidebar-nav-items {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: #374151;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .nav-item i {
            width: 16px;
            text-align: center;
            font-size: 14px;
        }

        .chat-history-section {
            flex: 1;
            padding: 8px 12px;
            overflow-y: auto;
        }

        .history-header {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .chat-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item:hover {
            background: #f3f4f6;
        }

        .chat-item.active {
            background: #e5e7eb;
            font-weight: 600;
        }

        .new-sidebar-footer {
            padding: 12px;
            border-top: 1px solid #e5e5e5;
            margin-top: auto;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .user-profile:hover {
            background: #f3f4f6;
        }

        .user-avatar-new {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #10a37f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .username {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .user-status {
            font-size: 12px;
            color: #6b7280;
        }

        .upgrade-button {
            background: none;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 500;
        }

        .upgrade-button:hover {
            background: #f3f4f6;
        }

        .new-chatgpt-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .new-chat-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-bottom: 1px solid #e5e5e5;
            background: #ffffff;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-model {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }

        .upgrade-pill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .new-chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .new-welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 48px 24px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 400;
            color: #2d333a;
            margin-bottom: 48px;
            text-align: center;
        }

        .main-input-container {
            width: 100%;
            max-width: 768px;
        }

        .input-wrapper-new {
            display: flex;
            align-items: center;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .input-wrapper-new:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .input-add-btn,
        .voice-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-add-btn:hover,
        .voice-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .main-chat-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            padding: 0 12px;
            background: transparent;
            color: #2d333a;
        }

        .main-chat-input::placeholder {
            color: #9ca3af;
        }

        .send-btn-new {
            background: #10a37f;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn-new:hover {
            background: #0d8f6c;
        }

        /* Alternative Welcome Design */
        .alternative-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 48px 24px;
        }

        .edu-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            color: white;
            font-size: 32px;
        }

        .alt-welcome-title {
            font-size: 32px;
            font-weight: 600;
            color: #2d333a;
            margin-bottom: 48px;
            text-align: center;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 48px;
        }

        .suggestion-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-card:hover {
            border-color: #10a37f;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.15);
            transform: translateY(-2px);
        }

        .suggestion-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .suggestion-subtitle {
            font-size: 16px;
            font-weight: 400;
            color: #6b7280;
        }

        .bottom-input-container {
            width: 100%;
            max-width: 768px;
        }

        .bottom-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bottom-input-wrapper:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .bottom-chat-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            background: transparent;
            color: #2d333a;
            max-height: 120px;
        }

        .bottom-chat-input::placeholder {
            color: #9ca3af;
        }

        .bottom-send-btn {
            background: #10a37f;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bottom-send-btn:hover {
            background: #0d8f6c;
            transform: scale(1.05);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .new-chatgpt-container {
                flex-direction: column;
            }

            .new-chatgpt-sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e5e5e5;
            }

            .suggestion-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .welcome-title,
            .alt-welcome-title {
                font-size: 24px;
            }
        }

        /* Exact ChatGPT Interface */
        .chatgpt-container {
            display: flex !important;
            height: calc(100vh - 50px) !important;
            background: #ffffff !important;
            overflow: hidden;
            margin: 0 !important;
            width: 100% !important;
            border-radius: 0;
            box-shadow: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .chatgpt-sidebar {
            width: 260px !important;
            background: #202123 !important;
            display: flex !important;
            flex-direction: column !important;
            flex-shrink: 0;
            border-right: 1px solid #2d2d2d;
            min-height: 100%;
            position: relative;
            color: #ffffff;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .new-chat-button {
            width: 100%;
            background: #343541;
            border: 1px solid #565869;
            color: #ffffff;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .new-chat-button:hover {
            background: #40414f;
        }

        .sidebar-nav {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: #374151;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 2px;
            transition: background-color 0.2s;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .nav-item i {
            width: 16px;
            text-align: center;
        }

        .chat-history {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .chat-history h4 {
            font-size: 12px;
            color: #8e8ea0;
            margin-bottom: 10px;
            padding-left: 5px;
            font-weight: 500;
        }

        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .chat-history-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #ececf1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease;
        }

        .chat-history-item:hover {
            background-color: #343541;
        }

        .chat-history-item.active {
            background-color: #343541;
            font-weight: 600;
        }

        .chat-history-item .chat-options {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-history-item:hover .chat-options {
            opacity: 1;
        }

        .chat-delete-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
        }

        .chat-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        .no-chats {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #8e8ea0;
            text-align: center;
        }

        .no-chats i {
            font-size: 24px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .no-chats p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .no-chats small {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid #2d2d2d;
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .user-info:hover {
            background: #343541;
        }


        .upgrade-btn {
            background: none;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: auto;
        }

        .upgrade-btn:hover {
            background: #f3f4f6;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #ececf1;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .chatgpt-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            position: relative;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 1px solid #e5e5e5;
            background: #ffffff;
        }

        .chat-title-section h1 {
            font-size: 16px;
            font-weight: 600;
            color: #202123;
            margin: 0;
        }

        .chat-title-section p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .chat-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        /* Welcome message and suggestions */
        .welcome-message {
            padding: 24px;
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .welcome-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #202123;
            margin-bottom: 16px;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .suggestion-card {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .suggestion-card:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .suggestion-content h4 {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin: 0;
            line-height: 1.5;
        }


        /* Chat input area */
        .chat-input-container {
            padding: 16px 24px;
            border-top: 1px solid #e5e5e5;
            background: #ffffff;
            position: relative;
            margin-top: auto;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
            resize: none;
            transition: all 0.2s ease;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            min-height: 48px;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        .send-btn {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: none;
            border: none;
            color: #10a37f;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background: rgba(16, 163, 127, 0.1);
        }

        /* Chat messages */
        .message {
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #f3f4f6;
        }

        .message.user {
            background: #ffffff;
        }

        .message.assistant {
            background: #f7f7f8;
        }

        .message-content {
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            gap: 16px;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #10a37f;
            color: white;
        }

        .assistant .message-avatar {
            background: #ffffff;
            border: 1px solid #e5e5e5;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .chatgpt-container {
                flex-direction: column;
                height: 100vh;
            }

            .chatgpt-sidebar {
                width: 100%;
                height: auto;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .chatgpt-sidebar.active {
                max-height: 300px;
            }

            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                position: absolute;
                top: 12px;
                left: 12px;
                z-index: 10;
                background: #202123;
                border: 1px solid #4b5563;
                border-radius: 4px;
                color: white;
                cursor: pointer;
            }

            .suggestion-grid {
                grid-template-columns: 1fr;
            }
        }


        .input-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .suggestion-cards {
            display: none;
        }

        .chat-input-area {
            padding: 20px 24px 32px;
            background: #ffffff;
            border-top: none;
        }

        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }

        .file-upload-section {
            margin-bottom: 12px;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .file-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 16px;
            font-size: 12px;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .file-tag .remove-file {
            cursor: pointer;
            color: #6b7280;
            font-size: 14px;
            padding: 2px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .file-tag .remove-file:hover {
            background: #ef4444;
            color: white;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .input-container:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .attach-button {
            background: none;
            border: none;
            color: #6b7280;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .attach-button:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            padding: 0 12px;
            background: transparent;
            color: #2d333a;
            font-family: inherit;
            max-height: 200px;
            min-height: 24px;
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .send-button {
            background: #10a37f;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #0d8f6c;
        }

        .send-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .input-footer {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: #9ca3af;
        }

        .provider-select {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            margin-bottom: 8px;
        }

        /* Chat Messages */
        .chat-message {
            display: flex;
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .chat-message.user {
            background: #f7f7f8;
        }

        .chat-message.ai {
            background: #ffffff;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
            margin-right: 16px;
        }

        .chat-message.ai .message-avatar {
            background: #10a37f;
            color: white;
        }

        .chat-message.user .message-avatar {
            background: #5436da;
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 768px;
            margin: 0 auto;
            line-height: 1.7;
            font-size: 16px;
            color: #2d333a;
        }

        .message-content p {
            margin-bottom: 16px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin-bottom: 8px;
        }

        .message-content code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .message-content pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .file-upload-section {
            margin-bottom: 12px;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--gray-100);
            border-radius: 16px;
            font-size: 12px;
            color: var(--gray-700);
        }

        .file-tag .remove-file {
            cursor: pointer;
            color: var(--error);
            font-size: 14px;
        }

        /* Typing indicator */
        .typing-indicator {
            opacity: 0.7;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 16px 0;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Message animations */
        .chat-message {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-title-section h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .chat-title-section p {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin: 0;
        }

        .chat-controls {
            display: flex;
            gap: var(--space-sm);
        }

        .control-btn {
            background: none;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .deepseek-messages {
            flex: 1;
            padding: var(--space-lg) var(--space-3xl);
            overflow-y: auto;
            background: var(--gray-50);
            width: 100%;
        }

        .welcome-card {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
            width: 100%;
            margin: 0;
        }

        .welcome-icon {
            width: 64px;
            height: 64px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
            color: white;
            font-size: 1.5rem;
        }

        .welcome-card h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-md);
        }

        .welcome-card p {
            color: var(--gray-600);
            font-size: 1rem;
            margin-bottom: var(--space-xl);
            line-height: 1.6;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-lg);
            margin-top: var(--space-xl);
        }

        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-lg);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
        }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .feature-item i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .feature-item span {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-700);
        }



        .input-wrapper {
            width: 100%;
            padding: 0 var(--space-xl);
        }

        .input-box {
            display: flex;
            align-items: flex-end;
            gap: var(--space-sm);
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-sm);
            transition: var(--transition-base);
        }

        .input-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }





        .send-button {
            background: var(--primary);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        .input-hint {
            text-align: center;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: var(--space-sm);
        }

        /* Chat Messages in DeepSeek Style */
        .deepseek-message {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            width: 100%;
            padding: 0 var(--space-lg);
        }

        .deepseek-message.user {
            flex-direction: row-reverse;
        }

        .deepseek-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .deepseek-message.ai .deepseek-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .deepseek-message.user .deepseek-avatar {
            background: var(--gray-300);
            color: var(--gray-700);
        }

        .deepseek-message-content {
            flex: 1;
            background: var(--white);
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            line-height: 1.6;
            min-width: 0;
            word-wrap: break-word;
        }

        .deepseek-message.user .deepseek-message-content {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Enhanced Sections */
        .section {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: calc(100vh - 80px);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .section.active {
            display: block !important;
        }

        /* Specific styling for admin and performance sections as regular pages */
        #performanceSection,
        #adminSection {
            background: var(--white) !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            width: 100% !important;
            height: auto !important;
            position: static !important;
            z-index: auto !important;
        }

        /* Ensure proper page layout for admin and performance */
        #performanceSection .performance-dashboard,
        #adminSection .admin-dashboard {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
            max-height: none !important;
            overflow: visible !important;
        }

        /* Remove any popup/modal styling */
        #performanceSection .section-header,
        #adminSection .section-header {
            position: relative !important;
            background: transparent !important;
            border-bottom: 1px solid var(--gray-200) !important;
            margin-bottom: 2rem !important;
            padding-bottom: 1rem !important;
        }

        /* Style the close button as a regular back button */
        #performanceSection .section-close-btn,
        #adminSection .section-close-btn {
            position: absolute !important;
            top: 0 !important;
            right: 0 !important;
            background: var(--gray-100) !important;
            color: var(--gray-600) !important;
            border: 1px solid var(--gray-300) !important;
            padding: 0.5rem 1rem !important;
            border-radius: var(--radius-md) !important;
            font-size: 0.875rem !important;
            width: auto !important;
            height: auto !important;
        }

        #performanceSection .section-close-btn:hover,
        #adminSection .section-close-btn:hover {
            background: var(--gray-200) !important;
            color: var(--gray-800) !important;
        }

        /* Scroll dropdown styles for admin and performance sections */
        .section-dropdown {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--gray-400) var(--gray-100);
            padding: 0 10px;
        }

        .section-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .section-dropdown::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        .section-dropdown::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        .section-dropdown::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Performance and Admin section specific styles */
        .performance-cards,
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card,
        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
        }

        .performance-card:hover,
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .performance-section,
        .admin-section {
            margin-bottom: 2rem;
        }

        .performance-section h2,
        .admin-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        /* Responsive adjustments for scroll sections */
        @media (max-width: 768px) {
            .section-dropdown {
                max-height: calc(100vh - 100px);
                padding: 0 5px;
            }

            .performance-cards,
            .admin-stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Ensure all sections display properly */
        #aiGuidanceSection.active,
        #ultraAiGuidanceSection.active,
        #questionBankSection.active,
        #dashboardSection.active,
        #practiceSection.active,
        #testsSection.active,
        #resultsSection.active,
        #resourcesSection.active,
        #settingsSection.active {
            display: block !important;
            height: auto !important;
            overflow: visible;
            box-sizing: border-box;
            opacity: 1;
            visibility: visible;
        }

        /* Hide inactive sections completely */
        .section:not(.active) {
            display: none !important;
        }

        /* Ensure sections don't overlap */
        .section {
            position: relative;
            width: 100%;
            box-sizing: border-box;
            overflow: visible !important;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: var(--space-2xl);
            text-align: center;
            position: relative;
        }

        .section-title {
            font-size: 3rem;
            font-weight: 900;
            color: var(--gray-900);
            margin-bottom: var(--space-sm);
            line-height: 1.1;
            letter-spacing: -1px;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            color: var(--gray-600);
            font-size: 1.3rem;
            font-weight: 500;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Enhanced Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            box-shadow: var(--shadow-soft);
            transition: var(--transition-base);
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--gradient-primary);
        }

        .card:hover {
            transform: translateY(-12px);
            box-shadow: var(--shadow-2xl);
        }

        .card-icon {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-xl);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-lg);
            color: white;
            font-size: 2rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-base);
        }

        .card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .card-title {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: var(--space-sm);
            color: var(--gray-900);
            line-height: 1.2;
        }

        .card-description {
            color: var(--gray-600);
            margin-bottom: var(--space-lg);
            line-height: 1.7;
            flex-grow: 1;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            box-shadow: var(--shadow-soft);
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .stat-value {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: var(--space-sm);
            line-height: 1;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Enhanced Test Cards */
        .test-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            transition: var(--transition-base);
        }

        .test-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-xl);
            transform: translateY(-6px);
        }

        .test-card:hover::before {
            width: 8px;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .test-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--gray-900);
            line-height: 1.3;
        }

        .test-meta {
            display: flex;
            gap: var(--space-lg);
            color: var(--gray-600);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .test-difficulty {
            padding: var(--space-xs) var(--space-md);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        .difficulty-easy {
            background: var(--success);
            color: white;
        }

        .difficulty-medium {
            background: var(--warning);
            color: white;
        }

        .difficulty-hard {
            background: var(--error);
            color: white;
        }

        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--space-2xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
            position: relative;
            margin: 0 auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-md);
            padding-right: 40px;
            border-bottom: 2px solid var(--gray-100);
            position: relative;
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .close-modal:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1);
        }

        /* Ensure close button is always visible in modals */
        #createTestModal .close-modal,
        #testModal .close-modal,
        #addQuestionModal .close-modal {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Enhanced Add Question Modal Styles */
        .question-type-selector {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .radio-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-400);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }

        .radio-option input[type="radio"]:checked+.radio-custom {
            border-color: var(--primary);
            background: var(--primary);
        }

        .radio-option input[type="radio"]:checked+.radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .radio-option input[type="radio"]:checked~span:not(.radio-custom) {
            color: var(--primary);
        }

        .textarea-container {
            position: relative;
        }

        .textarea-tools {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .tool-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .options-container {
            display: grid;
            gap: 0.75rem;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .option-label {
            font-weight: 600;
            color: var(--primary);
            min-width: 30px;
            font-size: 1.1rem;
        }

        .option-input {
            flex: 1;
        }

        .form-hint {
            color: var(--gray-500);
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: block;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .form-actions .btn {
            min-width: 120px;
        }

        /* Question Preview Styles */
        .question-preview {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-300);
        }

        .preview-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .preview-tag {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .preview-question {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            color: var(--gray-800);
        }

        .preview-options {
            display: grid;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preview-option {
            padding: 0.75rem;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-option.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .preview-solution {
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
        }

        .preview-solution h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        /* Responsive Design for Add Question Modal */
        @media (max-width: 768px) {
            .question-type-selector {
                flex-direction: column;
                gap: 0.75rem;
            }

            .form-row {
                flex-direction: column;
            }

            .option-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .option-label {
                min-width: auto;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }
        }

        /* Performance Section Styles */
        .performance-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Debug: Ensure sections are visible when active */
        #performanceSection.active,
        #adminSection.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 100vh;
            background: #f8fafc;
        }

        /* Ensure section content is visible */
        .performance-dashboard,
        .admin-dashboard {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .performance-card .card-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .performance-card .card-content h3 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .performance-card .score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .performance-card .score-change {
            font-size: 0.8rem;
            color: var(--success);
            margin: 0;
        }

        .performance-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .performance-section h2 {
            margin: 0 0 1.5rem 0;
            color: var(--gray-900);
        }

        .subject-performance {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .subject-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .subject-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        .percentage {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-700);
        }

        .test-results {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .test-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .test-result-item .test-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--gray-900);
        }

        .test-result-item .test-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .score-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .score-badge.high {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .score-badge.medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .score-badge.low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Admin Section Styles */
        .admin-dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .admin-tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-tab:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-section-header h2 {
            margin: 0;
            color: var(--gray-900);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-lg);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .stat-card .stat-info h3 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-card .stat-number {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gray-900);
        }

        .users-table {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .users-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-badge.student {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .role-badge.teacher {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .role-badge.admin {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.inactive {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-600);
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .btn-icon:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .btn-icon.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .question-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
            padding: 1.5rem;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: visible;
        }

        .question-filters::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .question-filters .form-select,
        .question-filters .form-input {
            min-width: 180px;
            height: 44px;
            padding: 0 12px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 500;
            background: var(--gray-50);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            line-height: 1.4;
            vertical-align: middle;
        }

        .question-filters .form-select:hover,
        .question-filters .form-input:hover {
            border-color: var(--primary);
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(80, 70, 229, 0.15);
        }

        .question-filters .form-select:focus,
        .question-filters .form-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(80, 70, 229, 0.1), 0 4px 12px rgba(80, 70, 229, 0.15);
            transform: translateY(-1px);
        }

        .question-filters .form-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px 18px;
            padding-right: 40px !important;
            padding-left: 12px !important;
        }

        .question-filters .form-input:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%235046e5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-size: 18px 18px;
        }

        .question-filters .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px !important;
            padding-left: 12px !important;
            cursor: pointer;
        }

        .question-filters .form-select:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%235046e5' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-size: 16px 16px;
        }

        .question-filters .btn {
            height: 44px;
            padding: 0 1.5rem;
            font-weight: 600;
            border-radius: var(--radius-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
        }

        .question-filters .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .question-filters .btn-secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .question-filters .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-color: var(--gray-400);
            color: var(--gray-800);
        }

        .question-filters .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: 2px solid transparent;
            box-shadow: 0 4px 15px rgba(80, 70, 229, 0.3);
        }

        .question-filters .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #7c3aed 100%);
            box-shadow: 0 8px 25px rgba(80, 70, 229, 0.4);
        }

        /* Enhanced search input styling */
        .question-filters .form-input::placeholder {
            color: var(--gray-400);
            font-weight: 500;
        }

        .question-filters .form-input:focus::placeholder {
            color: var(--gray-300);
        }

        /* Fix for dropdown text overflow and positioning */
        .question-filters .form-select option {
            padding: 8px 12px;
            background: white;
            color: var(--gray-800);
        }

        .question-filters .form-select::-ms-expand {
            display: none;
        }

        /* Ensure proper text positioning in selects */
        .question-filters .form-select {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            line-height: 1.4;
        }

        /* Loading state for filters */
        .question-filters.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .question-filters.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray-300);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Filter count badge */
        .filter-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Enhanced button animations */
        .question-filters .btn i {
            transition: transform 0.3s ease;
        }

        .question-filters .btn:hover i {
            transform: scale(1.1);
        }

        .question-filters .btn-primary:hover i {
            animation: rotate 0.5s ease-in-out;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1.1); }
        }

        /* Responsive design for filters */
        @media (max-width: 768px) {
            .question-filters {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            .question-filters .form-select,
            .question-filters .form-input {
                min-width: 140px;
                font-size: 0.9rem;
            }
            
            .question-filters .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .question-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .question-filters .form-select,
            .question-filters .form-input,
            .question-filters .btn {
                width: 100%;
                min-width: auto;
            }
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .analytics-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .analytics-card h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-900);
        }

        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            color: var(--gray-500);
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .settings-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .settings-card h3 {
            margin: 0 0 1.5rem 0;
            color: var(--gray-900);
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .settings-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .performance-cards {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-wrap: wrap;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                overflow-x: auto;
            }
        }

        .question-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .question-item .question-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
        }

        .question-item .question-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Enhanced Question Interface */
        .question-container {
            margin-bottom: var(--space-xl);
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-lg);
            color: var(--gray-800);
            line-height: 1.7;
            padding: var(--space-lg);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary);
            white-space: pre-line;
        }

        /* Question References Styles */
        .question-references {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.05);
            border-left: 3px solid #3b82f6;
            border-radius: 0 6px 6px 0;
            transition: all 0.3s ease;
        }

        .question-references:hover {
            background: rgba(59, 130, 246, 0.08);
            transform: translateX(2px);
        }

        .references-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: #3b82f6;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .references-content {
            color: #374151;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Answer Examples Styles */
        .answer-examples {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .answer-examples:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
        }

        .answer-examples .examples-header {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .answer-examples .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .answer-examples .example-item {
            padding: 0.25rem 0;
        }

        .answer-examples .example-item strong {
            color: var(--primary);
            font-weight: 600;
        }

        /* Numerical Answer Validation Styles */
        .valid-input {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }

        .invalid-input {
            border-color: var(--error) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        /* Enhanced textarea for numerical answers */
        #enhancedNumericalAnswer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            line-height: 1.4;
            resize: vertical;
        }

        .options-grid {
            display: grid;
            gap: var(--space-md);
        }

        .option-item {
            padding: var(--space-lg);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: 600;
            background: var(--white);
            position: relative;
            overflow: hidden;
        }

        .option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.1;
            transition: var(--transition-base);
        }

        .option-item:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .option-item:hover::before {
            left: 0;
        }

        .option-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .timer {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin: var(--space-lg) 0;
            padding: var(--space-lg);
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--gray-200);
            background: var(--gradient-primary);
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced AI Chat Interface */
        .ai-chat-container {
            display: flex;
            height: calc(100vh - 80px);
            background: var(--white);
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            margin: -2rem;
            width: calc(100% + 4rem);
            border: 1px solid var(--gray-200);
        }

        .chat-sidebar {
            width: 340px;
            background: var(--gray-50);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            transition: var(--transition-base);
            position: relative;
            z-index: 10;
        }

        .chat-sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--gray-200);
            background: var(--white);
        }

        .new-chat-btn {
            width: 100%;
            justify-content: center;
            gap: var(--space-sm);
            font-weight: 700;
        }

        .chat-history {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        .chat-history h4 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--gray-600);
            margin-bottom: var(--space-lg);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--gray-200);
        }

        .chat-history-item {
            padding: var(--space-lg);
            margin-bottom: var(--space-sm);
            background: var(--white);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .chat-history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.05;
            transition: var(--transition-base);
        }

        .chat-history-item:hover::before {
            left: 0;
        }

        .chat-history-item:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .chat-history-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: 8px;
            opacity: 0;
            transition: var(--transition-base);
            font-size: 0.8rem;
            z-index: 1;
        }

        .chat-history-item:hover .delete-chat-btn {
            opacity: 1;
        }

        .delete-chat-btn:hover {
            background: var(--error);
            color: white;
            transform: scale(1.1);
        }

        .no-chats {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin: 10px 0;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }

        .no-chats i {
            font-size: 2.5rem;
            margin-bottom: 16px;
            opacity: 0.6;
            color: rgba(102, 126, 234, 0.8);
        }

        .no-chats p {
            margin: 12px 0;
            font-weight: 600;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }

        .no-chats small {
            font-size: 13px;
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
            font-size: 0.8rem;
        }

        .message-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .chat-date {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            color: var(--gray-600);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle-btn:hover {
            background: var(--gray-100);
            color: var(--primary);
            transform: rotate(180deg);
        }

        .chat-title h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: var(--space-xs);
            color: var(--gray-900);
        }

        .chat-title p {
            font-size: 1rem;
            color: var(--gray-600);
            margin: 0;
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .chat-messages {
            flex: 1;
            padding: var(--space-2xl);
            overflow-y: auto;
            background: var(--gray-50);
        }

        .welcome-message {
            display: flex;
            gap: var(--space-lg);
            padding: var(--space-2xl);
            background: var(--white);
            border-radius: var(--radius-2xl);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            animation: fadeInUp 0.6s ease-out;
        }

        .ai-avatar {
            width: 56px;
            height: 56px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
            box-shadow: var(--shadow-lg);
        }

        .user-avatar {
            width: 56px;
            height: 56px;
            background: var(--gradient-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
            box-shadow: var(--shadow-lg);
        }

        .message-content {
            flex: 1;
        }

        .message-content h3 {
            margin-bottom: var(--space-lg);
            color: var(--gray-900);
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .message-content ul {
            margin: var(--space-lg) 0;
            padding-left: var(--space-xl);
        }

        .message-content li {
            margin-bottom: var(--space-sm);
            line-height: 1.7;
            font-weight: 500;
        }

        .chat-message {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message.user .message-bubble {
            background: var(--primary);
            color: white;
            border-radius: 1.5rem 1.5rem 0.25rem 1.5rem;
        }

        .chat-message.ai .message-bubble {
            background: var(--white);
            border-radius: 1.5rem 1.5rem 1.5rem 0.25rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-md);
        }

        .message-bubble {
            padding: var(--space-lg) var(--space-xl);
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.7;
            position: relative;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: var(--space-sm);
            font-weight: 500;
        }

        .chat-input-container {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--gray-200);
            background: var(--white);
        }

        .chat-input-wrapper {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-2xl);
            transition: var(--transition-base);
            box-shadow: var(--shadow-md);
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .file-upload-area {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--gray-200);
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .file-tag {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition-base);
        }

        .file-tag:hover {
            background: var(--gray-200);
            transform: translateY(-1px);
        }

        .file-tag .remove-file {
            cursor: pointer;
            color: var(--error);
            padding: 4px;
            border-radius: 50%;
            transition: var(--transition-fast);
        }

        .file-tag .remove-file:hover {
            background: var(--error);
            color: white;
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
        }

        .attachment-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: 50%;
            transition: var(--transition-base);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attachment-btn:hover {
            background: var(--gray-100);
            color: var(--primary);
            transform: scale(1.1);
        }

        .message-input-container {
            flex: 1;
        }

        .chat-input {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 1.1rem;
            line-height: 1.6;
            max-height: 150px;
            min-height: 28px;
            background: transparent;
            padding: var(--space-sm) 0;
            font-weight: 500;
        }

        .send-btn {
            background: var(--primary);
            border: none;
            color: white;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            font-size: 1.2rem;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .send-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-footer {
            padding: var(--space-sm) var(--space-lg);
            text-align: center;
            border-top: 1px solid var(--gray-200);
        }

        .input-footer small {
            color: var(--gray-500);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-lg);
            color: var(--gray-600);
            font-style: italic;
            font-weight: 500;
        }

        .typing-dots {
            display: flex;
            gap: 0.3rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray-400);
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingDot {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Enhanced Math Toolbar */
        .math-toolbar {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .math-btn {
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .math-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced Tabs */
        .tab-container {
            margin-bottom: var(--space-xl);
        }

        .tabs {
            display: flex;
            gap: var(--space-sm);
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: var(--space-xl);
            padding: 0 var(--space-sm);
        }

        .tab {
            padding: var(--space-md) var(--space-xl);
            background: none;
            border: none;
            color: var(--gray-600);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-base);
            border-bottom: 3px solid transparent;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.1;
            transition: var(--transition-base);
        }

        .tab:hover::before {
            left: 0;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Admin Controls */
        .admin-controls {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }

        .question-form {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-lg);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .performance-chart {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid var(--gray-200);
            height: 400px;
            box-shadow: var(--shadow-lg);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow:
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(255, 255, 255, 0.5);
            z-index: 10000;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 380px;
            min-width: 280px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            overflow: hidden;
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--success);
            border-radius: 2px 0 0 2px;
        }

        .notification::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
            pointer-events: none;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success::before {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.success::after {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.03) 100%);
        }

        .notification.error::before {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.error::after {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.03) 100%);
        }

        .notification.warning::before {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .notification.warning::after {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.03) 100%);
        }

        .notification.info::before {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .notification.info::after {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.03) 100%);
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: white;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .notification.success .notification-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error .notification-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.warning .notification-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .notification.info .notification-icon {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .notification-content {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .notification-text {
            color: var(--gray-800);
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0;
        }

        .notification-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(107, 114, 128, 0.1);
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .notification-close:hover {
            background: rgba(107, 114, 128, 0.2);
            color: var(--gray-700);
            transform: scale(1.1);
        }

        /* Notification Animation */
        @keyframes notificationSlideIn {
            from {
                transform: translateX(120%) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes notificationSlideOut {
            from {
                transform: translateX(0) scale(1);
                opacity: 1;
            }

            to {
                transform: translateX(120%) scale(0.95);
                opacity: 0;
            }
        }

        .notification.show {
            animation: notificationSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.hide {
            animation: notificationSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scroll to Top Button */
        .scroll-to-top-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary, #6366f1);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        .scroll-to-top-btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-to-top-btn:hover {
            background: var(--primary-dark, #4f46e5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .scroll-to-top-btn:active {
            transform: translateY(0);
        }

        /* Admin Panel Visibility */
        .admin-only {
            display: flex !important;
            visibility: visible !important;
        }

        .admin-only.show-admin {
            display: flex !important;
        }

        .admin-dropdown-only {
            display: block !important;
        }

        .admin-dropdown-only.show-admin {
            display: block !important;
        }

        /* Force admin visibility when needed */
        #adminNavItem.show-admin {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #adminDropdownItem.show-admin {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Smaller logout button */
        #logoutBtn {
            padding: 8px 12px !important;
            font-size: 0.875rem !important;
            min-width: auto !important;
        }

        #logoutBtn i {
            font-size: 0.875rem !important;
            margin-right: 4px !important;
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert i {
            font-size: 1.1rem;
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            background: var(--gray-100);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
            gap: 4px;
        }

        .admin-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            color: var(--gray-600);
        }

        .admin-tab:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Mock Test Grid */
        .mock-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .mock-test-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .mock-test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .mock-test-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .mock-test-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .mock-test-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Results Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        .results-table th {
            background: var(--gray-50);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .results-table tr:hover {
            background: var(--gray-50);
        }

        .score-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .score-excellent {
            background: #d4edda;
            color: #155724;
        }

        .score-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .score-average {
            background: #fff3cd;
            color: #856404;
        }

        .score-poor {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .subject-distribution {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .form-row label {
            min-width: 120px;
            font-weight: 500;
        }

        .form-row input {
            flex: 1;
        }

        /* Button Sizes */
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Responsive scroll button */
        @media (max-width: 768px) {
            .scroll-to-top-btn {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1024px) {
            .card-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: var(--space-lg);
            }

            .section-title {
                font-size: 2.5rem;
            }

            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {



            .card-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-lg);
            }

            .admin-controls {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .chatgpt-container {
                height: calc(100vh - 100px);
                border-radius: var(--radius-lg);
                margin: -1rem;
                width: calc(100% + 2rem);
                flex-direction: column;
            }

            .chatgpt-sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #4d4d4f;
            }

            .chat-history {
                display: none;
            }

            .welcome-screen h1 {
                font-size: 24px;
            }

            .suggestion-cards {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .input-wrapper {
                max-width: 100%;
            }

            .chat-input {
                font-size: 16px;
            }

            .deepseek-header {
                padding: var(--space-md) var(--space-lg);
            }

            .chat-title-section h1 {
                font-size: 1.25rem;
            }

            .feature-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-md);
            }

            .welcome-card {
                padding: var(--space-xl);
            }

            .chat-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 300px;
                z-index: 20;
                box-shadow: var(--shadow-2xl);
                transform: translateX(-100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .chat-sidebar:not(.collapsed) {
                transform: translateX(0);
            }

            .chat-sidebar.collapsed {
                transform: translateX(-100%);
                width: 300px;
            }

            .chat-main {
                width: 100%;
            }

            .message-bubble {
                max-width: 90%;
            }

            .chat-history {
                padding: var(--space-md);
                max-height: calc(100vh - 200px);
            }

            .chat-history-item {
                padding: var(--space-md);
            }

            .sidebar-toggle-btn {
                display: block !important;
            }

            .section-title {
                font-size: 2rem;
            }

            .auth-card {
                padding: var(--space-xl);
            }

            .logo-text {
                font-size: 2.5rem;
            }

            .header {
                padding: var(--space-md) var(--space-lg);
            }

            .content-area {
                padding: var(--space-lg);
            }
        }

        @media (min-width: 769px) {
            .sidebar-toggle-btn {
                display: block;
            }
        }

        /* Enhanced Loading States */
        .loading-messages {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            padding: var(--space-2xl);
            justify-content: center;
        }

        .loading-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
        }

        .loading-text p {
            margin: 0;
            color: var(--gray-600);
            font-style: italic;
            font-weight: 500;
        }

        /* Enhanced Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 8px;
            border: 2px solid var(--gray-100);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* Scroll Dropdown Styles for Admin and Performance Sections */
        .section-dropdown {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--gray-100);
            padding: 15px;
            margin-top: 10px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            box-shadow:
                inset 0 2px 8px rgba(0, 0, 0, 0.05),
                0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .section-dropdown::-webkit-scrollbar {
            width: 12px;
        }

        .section-dropdown::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 6px;
            margin: 5px 0;
        }

        .section-dropdown::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border-radius: 6px;
            border: 2px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .section-dropdown::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--primary));
            transform: scale(1.1);
        }

        /* Scroll indicator for dropdown sections */
        .section-dropdown::before {
            content: 'â†• Scroll to see more content';
            position: sticky;
            top: 0;
            display: block;
            text-align: center;
            padding: 8px 12px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            animation: pulse 2s infinite;
        }

        /* Enhanced dropdown container styling */
        .performance-dashboard.section-dropdown,
        .admin-dashboard.section-dropdown {
            border: 2px solid var(--primary);
            box-shadow:
                inset 0 2px 8px rgba(99, 102, 241, 0.1),
                0 4px 20px rgba(99, 102, 241, 0.2);
        }

        /* Performance and Admin specific scroll styles */
        .performance-cards,
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card,
        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
        }

        .performance-card:hover,
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .performance-section,
        .admin-section {
            margin-bottom: 2rem;
        }

        .performance-section h2,
        .admin-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        /* Responsive adjustments for scroll sections */
        @media (max-width: 768px) {
            .section-dropdown {
                max-height: calc(100vh - 120px);
                padding: 10px;
            }

            .section-dropdown::before {
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            .performance-cards,
            .admin-stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Enhanced Focus States */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Enhanced Selection */
        ::selection {
            background: rgba(99, 102, 241, 0.3);
        }

        /* Enhanced Print Styles */
        @media print {

            .header,
            .sidebar,
            .chat-input-container,
            .admin-controls {
                display: none !important;
            }

            .content-area {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 2px solid var(--gray-300);
            }

            .section-title {
                background: none;
                -webkit-text-fill-color: var(--gray-900);
            }
        }

        /* Additional Enhancements */
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-md) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: var(--primary);
            color: white;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hover-lift {
            transition: var(--transition-base);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
        }

        /* Modern Clean Layout Styles */
        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #404040;
            background: #2d2d2d;
        }

        .new-chat-btn {
            width: 100%;
            background: #6366f1;
            border: 1px solid #6366f1;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .new-chat-btn:hover {
            background: #4f46e5;
            border-color: #4f46e5;
            transform: translateY(-1px);
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modern-main {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #ffffff !important;
        }

        .chat-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            height: 60px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #6366f1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .header-btn.active {
            background: #6366f1;
            color: white;
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff6b9d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logout-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .chat-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px 24px;
            background: #ffffff;
        }

        .welcome-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .welcome-icon {
            width: 64px;
            height: 64px;
            background: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            color: white;
            font-size: 28px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 40px;
            line-height: 1.2;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-item:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .suggestion-item i {
            color: #6366f1;
            font-size: 16px;
            flex-shrink: 0;
        }

        .suggestion-item span {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .chat-input-section {
            padding: 24px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
        }

        .input-area {
            max-width: 800px;
            margin: 0 auto;
        }

        .input-controls {
            margin-bottom: 12px;
            display: flex;
            justify-content: flex-end;
        }

        .ai-provider-select {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 180px;
        }

        .ai-provider-select:hover {
            border-color: #6366f1;
        }

        .ai-provider-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-box-modern {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 8px 12px;
            transition: all 0.2s;
        }

        .input-box-modern:focus-within {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: #ffffff;
        }



        .modern-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            padding: 8px 0;
            background: transparent;
            color: #1f2937;
            font-family: inherit;
            max-height: 120px;
        }

        .modern-input::placeholder {
            color: #9ca3af;
        }

        .send-btn-modern {
            background: #6366f1;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn-modern:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .send-btn-modern:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .input-footer-text {
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            margin-top: 12px;
            line-height: 1.4;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid #404040;
        }

        .user-avatar-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #6366f1;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-name {
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 500;
        }

        /* Chat History Styles */
        .history-list {
            padding: 8px 16px;
            flex: 1;
            overflow-y: auto;
        }

        .chat-history-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e2e8f0;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: block;
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .chat-history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(4px);
            color: white;
        }

        .chat-history-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chat-history-item.active:hover {
            transform: translateX(0);
        }

        /* Responsive Design for Modern Layout */
        @media (max-width: 768px) {
            .modern-ai-container {
                flex-direction: column;
                margin: -1rem;
                width: calc(100% + 2rem);
            }

            .modern-sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .chat-header-bar {
                padding: 8px 16px;
                height: 50px;
            }

            .header-btn span {
                display: none;
            }

            .suggestion-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .welcome-title {
                font-size: 24px;
            }

            .chat-input-section {
                padding: 16px;
            }
        }



        .form-select:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236366f1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Demo Credentials Styling */
        .demo-credentials {
            text-align: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .demo-credentials p {
            color: #475569;
            font-size: 0.85rem;
            font-weight: 500;
            margin: 0;
            line-height: 1.5;
        }

        .demo-credentials strong {
            color: #334155;
            font-weight: 600;
        }

        .dashboard {
            display: block;
        }

        .dashboard.hidden {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        /* AI Chat Styles */
        .ai-chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: var(--space-lg);
            background: var(--gray-50);
        }

        .welcome-message {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-content h3 {
            margin: 0 0 var(--space-sm) 0;
            color: var(--gray-800);
        }

        .message-content p {
            margin: 0;
            color: var(--gray-600);
        }

        .chat-input-area {
            padding: var(--space-lg);
            background: var(--white);
            border-top: 1px solid var(--gray-200);
        }

        .input-container {
            display: flex;
            gap: var(--space-md);
            align-items: flex-end;
        }

        #chatInput {
            flex: 1;
            padding: var(--space-md);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            resize: none;
            font-family: inherit;
            font-size: 1rem;
        }

        #chatInput:focus {
            outline: none;
            border-color: var(--primary);
        }

        #sendButton {
            padding: var(--space-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sendButton:hover {
            background: var(--primary-dark);
        }

        .chat-message {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message.user .message-content {
            background: var(--primary);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) var(--radius-sm) var(--radius-lg);
        }

        .chat-message.ai .message-content {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-sm);
        }

        .chat-message .message-content {
            padding: var(--space-md);
            max-width: 70%;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        /* ChatGPT-Style Interface */
        .chatgpt-container {
            display: flex;
            height: calc(100vh - 50px);
            background: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .chatgpt-sidebar {
            width: 260px;
            background: #171717;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #4d4d4f;
        }

        .chatgpt-sidebar .sidebar-header {
            padding: 14px;
            border-bottom: 1px solid #4d4d4f;
        }

        .chatgpt-sidebar .new-chat-btn {
            width: 100%;
            background: transparent;
            border: 1px solid #4d4d4f;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .chatgpt-sidebar .new-chat-btn:hover {
            background: #2d2d30;
        }

        .chatgpt-sidebar .chat-history {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
        }

        .chatgpt-sidebar .chat-history h4 {
            color: #8e8ea0;
            font-size: 12px;
            font-weight: 600;
            margin: 16px 8px 8px 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chatgpt-sidebar .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chatgpt-sidebar .chat-history-item {
            padding: 12px;
            color: #ececf1;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chatgpt-sidebar .chat-history-item:hover {
            background: #2d2d30;
        }

        .chatgpt-sidebar .chat-history-item.active {
            background: #343541;
        }

        .chatgpt-sidebar .no-chats {
            text-align: center;
            padding: 40px 20px;
            color: #8e8ea0;
        }

        .chatgpt-sidebar .no-chats i {
            font-size: 24px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .chatgpt-sidebar .no-chats p {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .chatgpt-sidebar .no-chats small {
            font-size: 12px;
            opacity: 0.7;
        }

        .chatgpt-sidebar .sidebar-footer {
            padding: 8px 12px;
            border-top: 1px solid #4d4d4f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatgpt-sidebar .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .chatgpt-sidebar .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            background: #10a37f;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        .chatgpt-sidebar .user-details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .chatgpt-sidebar .user-name {
            color: #ececf1;
            font-size: 12px;
            font-weight: 500;
        }

        .chatgpt-sidebar .user-role {
            color: #8e8ea0;
            font-size: 10px;
        }

        .chatgpt-sidebar .logout-btn {
            background: transparent;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
            font-size: 12px;
        }

        .chatgpt-sidebar .logout-btn:hover {
            background: #2d2d30;
            color: #ececf1;
        }

        .chatgpt-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .welcome-content {
            max-width: 800px;
            width: 100%;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 48px;
        }

        .welcome-content .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10a37f, #1a7f64);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .welcome-content h1 {
            font-size: 32px;
            font-weight: 600;
            color: #202123;
            margin-bottom: 8px;
        }

        .welcome-content p {
            font-size: 16px;
            color: #6e6e80;
        }

        .examples-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .example-category h3 {
            font-size: 16px;
            font-weight: 600;
            color: #202123;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .example-item {
            background: #f7f7f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #202123;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.4;
        }

        .example-item:hover {
            background: #ececf1;
            border-color: #d1d5db;
        }

        .input-area {
            padding: 24px;
            border-top: 1px solid #e5e5e5;
            background: #ffffff;
        }

        .input-container {
            max-width: 768px;
            margin: 0 auto;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 12px 16px;
            gap: 8px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .input-wrapper textarea {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            background: transparent;
            color: #202123;
            font-family: inherit;
            max-height: 200px;
        }

        .input-wrapper textarea::placeholder {
            color: #8e8ea0;
        }

        .input-wrapper .send-btn {
            background: #10a37f;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .input-wrapper .send-btn:hover {
            background: #0d8f6c;
        }

        .input-wrapper .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }





        .input-wrapper {
            position: relative;
        }





        .input-footer {
            text-align: center;
            margin-top: 12px;
        }

        .input-footer p {
            font-size: 12px;
            color: #6e6e80;
        }

        /* Message Styles */
        .ultra-messages-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .ultra-message {
            display: flex;
            gap: 16px;
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
        }

        .ultra-message.user {
            flex-direction: row-reverse;
        }

        .ultra-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .ultra-message.user .ultra-message-avatar {
            background: #10a37f;
            color: white;
        }

        .ultra-message.ai .ultra-message-avatar {
            background: #ab68ff;
            color: white;
        }

        .ultra-message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            color: #202123;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .ultra-message-content p {
            margin: 0 0 12px 0;
        }

        .ultra-message-content p:last-child {
            margin-bottom: 0;
        }

        .ultra-message-content ul,
        .ultra-message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .ultra-message-content li {
            margin: 4px 0;
        }

        .ultra-message-content h1,
        .ultra-message-content h2,
        .ultra-message-content h3 {
            margin: 16px 0 8px 0;
            font-weight: 600;
        }

        .ultra-message-content h1 {
            font-size: 18px;
        }

        .ultra-message-content h2 {
            font-size: 16px;
        }

        .ultra-message-content h3 {
            font-size: 15px;
        }

        .ultra-message-content strong {
            font-weight: 600;
        }

        .ultra-message-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .ultra-message-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .ultra-message.user .ultra-message-content {
            background: #f7f7f8;
            border: 1px solid #e5e5e5;
        }

        .ultra-message.ai .ultra-message-content {
            background: transparent;
        }

        /* Section Management */
        .section {
            display: none;
            padding: 2rem;
        }

        .section.active {
            display: block;
        }

        /* Section Styles */
        .section {
            display: none;
            padding: 2rem;
            min-height: calc(100vh - 50px);
            box-sizing: border-box;
        }

        .section.active {
            display: block;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .section-subtitle {
            font-size: 1.1rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Question Bank Styles */
        .subject-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #6366f1;
        }

        .chapter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #6366f1;
        }

        .option-item:hover {
            border-color: #6366f1;
            background: #f0f9ff;
        }

        .exam-type-btn:hover {
            background: #6366f1 !important;
            color: white !important;
        }

        /* Performance Section Styles */
        .performance-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .performance-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .performance-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .performance-card .card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .performance-card .card-content h3 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-700);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .performance-card .score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .performance-card .score-change {
            font-size: 0.8rem;
            color: var(--success);
            margin: 0;
        }

        .performance-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .performance-section h2 {
            margin: 0 0 1.5rem 0;
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .subject-performance {
            display: grid;
            gap: 1rem;
        }

        .subject-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
        }

        .subject-item:hover {
            background: var(--gray-100);
            transform: translateX(4px);
        }

        .subject-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 120px;
        }

        .subject-info i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.6s ease;
        }

        .percentage {
            font-weight: 600;
            color: var(--primary);
            min-width: 50px;
            text-align: right;
        }

        .test-results {
            display: grid;
            gap: 1rem;
        }

        .test-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
        }

        .test-result-item:hover {
            background: var(--gray-100);
            transform: translateY(-2px);
        }

        .test-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--gray-800);
            font-size: 1.1rem;
        }

        .test-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .score-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .score-badge.high {
            background: var(--success);
            color: white;
        }

        .score-badge.medium {
            background: var(--warning);
            color: white;
        }

        .score-badge.low {
            background: var(--error);
            color: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
        }

        .chart-card h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
        }

        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--gray-500);
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Admin Panel Styles */
        .admin-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: var(--radius-xl);
        }

        .admin-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: 600;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .admin-tab:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-section-header h2 {
            margin: 0;
            color: var(--gray-800);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .stat-info h3 {
            margin: 0 0 0.25rem 0;
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
        }

        .users-table {
            background: white;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .users-table tr:hover {
            background: var(--gray-50);
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-badge.student {
            background: var(--info);
            color: white;
        }

        .role-badge.teacher {
            background: var(--success);
            color: white;
        }

        .role-badge.admin {
            background: var(--error);
            color: white;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: var(--success);
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
            background: var(--gray-100);
            color: var(--gray-600);
            margin: 0 0.25rem;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        .btn-icon.danger:hover {
            background: var(--error);
            color: white;
        }

        /* This duplicate definition is handled by the main .question-filters above */

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .analytics-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .analytics-card h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .settings-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .settings-card h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .settings-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Admin Password Modal Styles */
        #adminPasswordModal .modal-content {
            text-align: center;
        }

        #adminPasswordModal .form-group {
            text-align: left;
        }

        #adminPasswordModal .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Shake animation for incorrect password */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        /* Admin button styling */
        #adminNavBtn {
            position: relative;
        }

        #adminNavBtn:hover {
            background: var(--gradient-primary);
            color: white;
        }

        #adminNavBtn i {
            color: var(--warning);
        }

        #adminNavBtn:hover i {
            color: white;
        }

        /* Responsive Design for Auth */
        @media (max-width: 768px) {
            /* Ensure only one section shows at a time on mobile */
            .auth-container:not(.hidden) {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 9999;
                width: 100vw;
                height: 100vh;
                overflow-y: auto;
            }
            
            .auth-container.hidden {
                display: none !important;
            }
            
            .dashboard:not(.hidden) {
                display: flex !important;
                flex-direction: column;
                width: 100%;
                min-height: 100vh;
            }
            
            .dashboard.hidden {
                display: none !important;
            }
            
            .auth-container {
                padding: 1rem;
                align-items: center;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            .auth-card {
                max-height: none;
                margin: 0;
                padding: 1.5rem;
                max-width: 100%;
                border-radius: 16px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
                top: 10px;
            }

            .logo-icon {
                width: 60px !important;
                height: 60px !important;
            }

            .logo-icon i {
                font-size: 1.75rem !important;
            }

            .logo-text {
                font-size: 1.75rem !important;
            }

            .logo-subtitle {
                font-size: 0.85rem !important;
            }

            .form-input {
                padding: 0.875rem 1rem;
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .subjects-grid {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
            }

            .exam-type-selector {
                max-width: 100% !important;
                margin-bottom: 1.5rem !important;
            }

            .exam-type-btn {
                padding: 12px 16px !important;
                font-size: 0.9rem !important;
            }

        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 0.5rem;
                align-items: center;
            }

            .auth-card {
                padding: 1.5rem;
                border-radius: 20px;
            }

            .logo-icon {
                width: 50px !important;
                height: 50px !important;
            }

            .logo-icon i {
                font-size: 1.5rem !important;
            }

            .logo h1 {
                font-size: 1.6rem !important;
            }

            .form-group {
                margin-bottom: 1.25rem;
            }

            .role-selected {
                padding: 0.875rem 1rem;
            }

            .role-option {
                padding: 0.875rem;
            }

            .role-option-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .role-option-title {
                font-size: 0.9rem;
                
            }

            .role-option-desc {
                font-size: 0.8rem;
            }

            .notification {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .chapters-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chatgpt-sidebar {
                width: 100%;
                position: fixed;
                top: 50px;
                left: -100%;
                height: calc(100vh - 50px);
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .chatgpt-sidebar.open {
                left: 0;
            }

            .examples-section {
                grid-template-columns: 1fr;
            }

            .input-area {
                padding: 16px;
            }
        }

        /* ========================================
           MOBILE RESPONSIVE DESIGN - BEAUTIFUL UI
           ======================================== */

        /* Mobile First - Base Styles for Small Screens */
        @media (max-width: 640px) {
            /* Base Typography */
            body { 
                font-size: 14px; 
                overflow-x: hidden;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            }
            
            h1 { font-size: 1.75rem !important; }
            h2 { font-size: 1.5rem !important; }
            h3 { font-size: 1.25rem !important; }
            
            /* Beautiful Modern Header with Hamburger Menu */
            .header { 
                padding: 1.25rem 1rem !important; 
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 1rem;
                position: sticky;
                top: 0;
                z-index: 100;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.5) !important;
                border-radius: 0 0 24px 24px !important;
                backdrop-filter: blur(10px);
            }
            
            /* Hamburger Menu Button - Ultra Beautiful */
            .mobile-menu-btn {
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 5px;
                width: 48px;
                height: 48px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
                border: 2px solid rgba(255, 255, 255, 0.4);
                cursor: pointer;
                padding: 10px;
                z-index: 101;
                border-radius: 14px;
                transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                backdrop-filter: blur(20px);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
            }
            
            .mobile-menu-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.6s ease;
            }
            
            .mobile-menu-btn:hover::before {
                left: 100%;
            }
            
            .mobile-menu-btn:hover {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.25) 100%);
                transform: scale(1.1) rotate(5deg);
                box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3), 
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
                border-color: rgba(255, 255, 255, 0.6);
            }
            
            .mobile-menu-btn:active {
                transform: scale(0.95);
            }
            
            .mobile-menu-btn span {
                width: 26px;
                height: 3px;
                background: linear-gradient(90deg, #ffffff 0%, #f0f0f0 100%);
                border-radius: 10px;
                transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),
                            0 1px 0 rgba(255, 255, 255, 0.5);
                position: relative;
            }
            
            .mobile-menu-btn span::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
                animation: shimmer 2s infinite;
            }
            
            @keyframes shimmer {
                0%, 100% { transform: translateX(-100%); }
                50% { transform: translateX(100%); }
            }
            
            .mobile-menu-btn span:nth-child(1) {
                animation: lineFloat1 3s ease-in-out infinite;
            }
            
            .mobile-menu-btn span:nth-child(2) {
                animation: lineFloat2 3s ease-in-out infinite;
            }
            
            .mobile-menu-btn span:nth-child(3) {
                animation: lineFloat3 3s ease-in-out infinite;
            }
            
            @keyframes lineFloat1 {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(2px); }
            }
            
            @keyframes lineFloat2 {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(-2px); }
            }
            
            @keyframes lineFloat3 {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(2px); }
            }
            
            .mobile-menu-btn.active {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.3) 100%);
                transform: rotate(90deg);
                box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3), 
                            inset 0 2px 4px rgba(255, 255, 255, 0.4);
            }
            
            .mobile-menu-btn.active span {
                animation: none;
            }
            
            .mobile-menu-btn.active span:nth-child(1) {
                transform: rotate(45deg) translate(7px, 7px);
                width: 28px;
            }
            
            .mobile-menu-btn.active span:nth-child(2) {
                opacity: 0;
                transform: translateX(-30px) scale(0);
            }
            
            .mobile-menu-btn.active span:nth-child(3) {
                transform: rotate(-45deg) translate(7px, -7px);
                width: 28px;
            }
            
            /* Logo - Centered with Animation */
            .header-logo { 
                font-size: 1.4rem !important;
                font-weight: 900 !important;
                color: white !important;
                text-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex !important;
                align-items: center !important;
                gap: 0.6rem;
                flex: 1;
                justify-content: center;
                animation: logoFloat 3s ease-in-out infinite;
            }
            
            @keyframes logoFloat {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-3px); }
            }
            
            .header-logo i { 
                font-size: 1.6rem !important;
                filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
                animation: iconRotate 4s ease-in-out infinite;
            }
            
            @keyframes iconRotate {
                0%, 100% { transform: rotate(0deg); }
                50% { transform: rotate(5deg); }
            }
            
            /* User Avatar - Right Side */
            .user-info {
                display: none !important;
            }
            
            .user-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 1rem !important;
                border: 2px solid white !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                display: flex !important;
            }
            
            /* Hide Desktop Navigation */
            .header-nav { 
                display: none !important;
            }
            
            /* Mobile Sidebar Menu - Enhanced */
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 300px;
                height: 100vh;
                background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
                box-shadow: 8px 0 40px rgba(102, 126, 234, 0.3);
                z-index: 999;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                overflow-y: auto;
                padding: 0;
                border-radius: 0 24px 24px 0;
            }
            
            .mobile-sidebar.active {
                left: 0;
                animation: slideInLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            @keyframes slideInLeft {
                from {
                    left: -100%;
                    opacity: 0;
                }
                to {
                    left: 0;
                    opacity: 1;
                }
            }
            
            /* Sidebar Overlay - Enhanced */
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.4) 0%, rgba(118, 75, 162, 0.4) 100%);
                backdrop-filter: blur(8px);
                z-index: 998;
                opacity: 0;
                visibility: hidden;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .mobile-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            
            /* Sidebar User Info - Enhanced */
            .sidebar-user-info {
                padding: 2rem 1.5rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                gap: 1rem;
                position: relative;
                overflow: hidden;
            }
            
            .sidebar-user-info::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                animation: pulse 3s ease-in-out infinite;
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 0.5; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }
            
            .sidebar-user-info .user-avatar {
                width: 60px !important;
                height: 60px !important;
                font-size: 1.5rem !important;
                border: 3px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                position: relative;
                z-index: 1;
            }
            
            .sidebar-user-details {
                position: relative;
                z-index: 1;
            }
            
            .sidebar-user-details h3 {
                margin: 0;
                font-size: 1.2rem;
                font-weight: 800;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            
            .sidebar-user-details p {
                margin: 0.25rem 0 0 0;
                font-size: 0.85rem;
                opacity: 0.95;
                font-weight: 500;
            }
            
            /* Sidebar Navigation Items - Enhanced */
            .sidebar-nav-item {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1.1rem 1.5rem;
                margin: 0.25rem 0.75rem;
                color: #475569;
                text-decoration: none;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 12px;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                font-weight: 500;
            }
            
            .sidebar-nav-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 4px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transform: scaleY(0);
                transition: transform 0.3s ease;
            }
            
            .sidebar-nav-item:hover {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
                color: #667eea;
                transform: translateX(4px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            }
            
            .sidebar-nav-item:hover::before {
                transform: scaleY(1);
            }
            
            .sidebar-nav-item.active {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
                color: #667eea;
                font-weight: 700;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            }
            
            .sidebar-nav-item.active::before {
                transform: scaleY(1);
            }
            
            .sidebar-nav-item i {
                font-size: 1.3rem;
                width: 28px;
                text-align: center;
                transition: transform 0.3s ease;
            }
            
            .sidebar-nav-item:hover i {
                transform: scale(1.15) rotate(5deg);
            }
            
            .sidebar-nav-item span {
                font-size: 0.95rem;
                letter-spacing: 0.3px;
            }
            
            /* Sidebar Logout Button - Enhanced */
            .sidebar-logout {
                margin: 1.5rem 0.75rem;
                padding: 1.1rem;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border: none;
                border-radius: 14px;
                font-weight: 700;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.6rem;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
                position: relative;
                overflow: hidden;
            }
            
            .sidebar-logout::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                transition: left 0.5s ease;
            }
            
            .sidebar-logout:hover::before {
                left: 100%;
            }
            
            .sidebar-logout:hover {
                transform: translateY(-3px) scale(1.02);
                box-shadow: 0 8px 28px rgba(239, 68, 68, 0.45);
            }
            
            .sidebar-logout:active {
                transform: translateY(-1px) scale(0.98);
            }
            
            .sidebar-logout i {
                font-size: 1.2rem;
                transition: transform 0.3s ease;
            }
            
            .sidebar-logout:hover i {
                transform: rotate(-10deg) scale(1.1);
            }
            
            /* Hide Desktop Logout */
            .logout-btn {
                display: none !important;
            }
            
            /* Dashboard & Sections - Beautiful Cards */
            .dashboard-container, .section { 
                padding: 1rem !important; 
                width: 100%;
                overflow-x: hidden;
                background: transparent !important;
            }
            
            .main-content {
                background: transparent !important;
                flex-direction: column;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .content-area-full {
                background: transparent !important;
            }
            
            .dashboard-scroll-container {
                background: transparent !important;
            }
            
            /* Grids - Single Column with Beautiful Spacing */
            .stats-grid, 
            .stats-row, 
            .card-grid, 
            .action-cards-grid { 
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* Beautiful Stat Cards - Enhanced */
            .stat-card {
                padding: 1.5rem !important;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%) !important;
                border-radius: 24px !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15) !important;
                border: 2px solid rgba(102, 126, 234, 0.1) !important;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: relative;
                overflow: hidden;
            }
            
            .stat-card::after {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
                animation: cardPulse 4s ease-in-out infinite;
            }
            
            @keyframes cardPulse {
                0%, 100% { transform: scale(1) rotate(0deg); }
                50% { transform: scale(1.1) rotate(180deg); }
            }
            
            .stat-card:hover {
                transform: translateY(-6px) scale(1.02) !important;
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25) !important;
                border-color: rgba(102, 126, 234, 0.3) !important;
            }
            
            .stat-card::before {
                height: 4px !important;
                border-radius: 4px 4px 0 0 !important;
            }
            
            /* Question Bank Section Container */
            #questionBankSection {
                max-width: 100vw !important;
                overflow-x: hidden !important;
                padding: 0.75rem !important;
                box-sizing: border-box !important;
            }
            
            #questionBankSection * {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Questions Display Container */
            #questionsDisplay,
            #physicsQuestionsList,
            #chapterQuestionsPage {
                max-width: 100% !important;
                overflow-x: hidden !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Question Bank Mobile Fixes - Compact Design */
            .question-card,
            .question-bank-item {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                border-radius: 16px !important;
                border-left-width: 3px !important;
                max-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* All children of question card must stay within bounds */
            .question-card > *,
            .question-bank-item > * {
                max-width: 100% !important;
                overflow-wrap: break-word !important;
                word-wrap: break-word !important;
                box-sizing: border-box !important;
            }
            
            /* Question Header - Compact */
            .question-header {
                margin-bottom: 0.5rem !important;
                max-width: 100% !important;
                overflow: hidden !important;
            }
            
            .question-text,
            .question-solution,
            .option-text {
                font-size: 0.8rem !important;
                line-height: 1.5 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
                white-space: normal !important;
                max-width: 100% !important;
                margin-bottom: 0.5rem !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                padding-right: 0.25rem !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            .question-text:first-child,
            .question-solution:first-child {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            /* Question Content Container */
            .question-content {
                max-width: 100% !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                word-wrap: break-word !important;
            }
            
            .question-content * {
                max-width: 100% !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            .question-number {
                font-size: 0.75rem !important;
                margin-bottom: 0.5rem !important;
                padding: 0.25rem 0.5rem !important;
                display: inline-block;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 8px;
            }
            
            .question-meta {
                flex-wrap: wrap !important;
                gap: 0.4rem !important;
                font-size: 0.7rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .difficulty-badge {
                padding: 0.2rem 0.4rem !important;
                font-size: 0.65rem !important;
                border-radius: 8px !important;
            }
            
            /* Subject and Chapter Tags - Compact */
            .subject-tag,
            .chapter-tag {
                font-size: 0.65rem !important;
                padding: 0.2rem 0.4rem !important;
                border-radius: 8px !important;
            }
            
            /* Options Container */
            .options-container,
            .question-options {
                max-width: 100% !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Option Items - Compact */
            .option-item {
                padding: 0.5rem !important;
                margin-bottom: 0.4rem !important;
                font-size: 0.75rem !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
                border-radius: 10px !important;
                line-height: 1.4 !important;
                max-width: 100% !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
                display: flex !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            
            .option-item * {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
            }
            
            .option-label {
                font-size: 0.75rem !important;
                min-width: 24px !important;
                width: 24px !important;
                height: 24px !important;
                line-height: 24px !important;
                flex-shrink: 0 !important;
            }
            
            .option-text {
                flex: 1 !important;
                min-width: 0 !important;
                max-width: 100% !important;
                overflow-wrap: break-word !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
            }
            
            /* Solution Section - Compact */
            .solution-section,
            .question-solution-container,
            .question-solution {
                max-width: 100% !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                word-wrap: break-word !important;
                box-sizing: border-box !important;
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
                margin-top: 0.5rem !important;
                border-radius: 10px !important;
            }
            
            .solution-section h4,
            .question-solution h4 {
                font-size: 0.85rem !important;
                margin-bottom: 0.5rem !important;
                margin-top: 0 !important;
                padding: 0 !important;
            }
            
            .solution-section div,
            .question-solution div {
                font-size: 0.75rem !important;
                line-height: 1.5 !important;
                padding: 0 !important;
                margin-top: 0 !important;
            }
            
            .solution-section div:first-child,
            .question-solution div:first-child {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            .solution-section *,
            .question-solution-container *,
            .question-solution * {
                max-width: 100% !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            /* Remove leading spaces from text content */
            .question-text,
            .question-solution,
            .solution-section > div,
            .question-content {
                text-align: left !important;
            }
            
            .question-text::before,
            .question-solution::before {
                content: '';
                display: block;
                height: 0;
            }
            
            /* Explanation Section - Compact */
            .explanation-section {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
                border-radius: 10px !important;
            }
            
            .explanation-section h4 {
                font-size: 0.85rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .explanation-section div {
                font-size: 0.75rem !important;
                line-height: 1.5 !important;
            }
            
            /* References Section - Compact */
            .references-section {
                padding: 0.5rem !important;
                max-width: 100% !important;
                overflow: hidden !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
                font-size: 0.75rem !important;
                margin-top: 0.5rem !important;
                border-radius: 10px !important;
            }
            
            .references-section h4 {
                font-size: 0.8rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            /* Action Buttons - Compact */
            .question-actions {
                margin-top: 0.5rem !important;
                gap: 0.5rem !important;
            }
            
            .question-actions button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
                border-radius: 10px !important;
            }
            
            /* Question Bank Header - Compact */
            .question-bank-header {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .question-bank-header h2 {
                font-size: 1.25rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            .question-bank-header p {
                font-size: 0.8rem !important;
            }
            
            /* Filters Section - Compact */
            .filters-section {
                padding: 0.75rem !important;
                gap: 0.5rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .filters-section select,
            .filters-section input {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
                border-radius: 10px !important;
            }
            
            /* Math Formulas - Compact */
            .question-card .MathJax,
            .question-card mjx-container {
                font-size: 0.9em !important;
                margin: 0.25rem 0 !important;
            }
            
            /* Images in Questions - Compact */
            .question-card img {
                max-width: 100% !important;
                height: auto !important;
                margin: 0.5rem 0 !important;
                border-radius: 8px !important;
            }
            
            /* Question Content Spacing */
            .question-content {
                margin-bottom: 0.5rem !important;
            }
            
            .question-content > * {
                margin-bottom: 0.4rem !important;
            }
            
            /* Pagination - Compact */
            .pagination {
                padding: 0.5rem !important;
                gap: 0.4rem !important;
            }
            
            .pagination button {
                padding: 0.4rem 0.6rem !important;
                font-size: 0.75rem !important;
                min-width: 32px !important;
                height: 32px !important;
            }
            
            /* Beautiful Action Cards - Enhanced */
            .card,
            .action-card {
                padding: 1.5rem !important;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%) !important;
                border-radius: 24px !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15) !important;
                border: 2px solid rgba(102, 126, 234, 0.1) !important;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: relative;
                overflow: hidden;
            }
            
            .card::before,
            .action-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
                transition: left 0.6s ease;
            }
            
            .card:hover::before,
            .action-card:hover::before {
                left: 100%;
            }
            
            .card:hover,
            .action-card:hover {
                transform: translateY(-6px) scale(1.02) !important;
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25) !important;
                border-color: rgba(102, 126, 234, 0.3) !important;
            }
            
            /* Modals - Full Screen Enhanced */
            .modal { 
                padding: 0 !important;
                align-items: stretch !important;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.5) 0%, rgba(118, 75, 162, 0.5) 100%) !important;
                backdrop-filter: blur(12px) !important;
            }
            
            .enhanced-modal-content { 
                max-width: 100% !important; 
                width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: 0 0 60px rgba(102, 126, 234, 0.4) !important;
                animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            @keyframes modalSlideUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .enhanced-modal-header { 
                padding: 1.25rem !important;
                position: sticky;
                top: 0;
                z-index: 10;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15) !important;
            }
            
            .enhanced-modal-body { 
                padding: 1.25rem !important;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
            }
            
            .enhanced-modal-footer {
                padding: 1.25rem !important;
                flex-direction: column !important;
                gap: 0.75rem !important;
                position: sticky;
                bottom: 0;
                background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(248,249,255,0.98) 100%);
                border-top: 2px solid rgba(102, 126, 234, 0.2);
                backdrop-filter: blur(10px);
                box-shadow: 0 -4px 12px rgba(102, 126, 234, 0.1);
            }
            
            .footer-left,
            .footer-right {
                width: 100% !important;
            }
            
            /* Forms - iOS Zoom Prevention */
            .enhanced-input, 
            .enhanced-select, 
            .enhanced-editor,
            input,
            textarea,
            select { 
                font-size: 16px !important;
                padding: 0.75rem !important;
            }
            
            /* Beautiful Buttons - Enhanced */
            .btn { 
                padding: 1.1rem 1.5rem !important;
                font-size: 0.95rem !important;
                width: 100%;
                border-radius: 16px !important;
                font-weight: 700 !important;
                box-shadow: 0 6px 24px rgba(102, 126, 234, 0.35) !important;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: relative;
                overflow: hidden;
                letter-spacing: 0.5px;
            }
            
            .btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }
            
            .btn:active::after {
                width: 300px;
                height: 300px;
            }
            
            .btn:hover {
                transform: translateY(-3px) scale(1.02) !important;
                box-shadow: 0 10px 32px rgba(102, 126, 234, 0.45) !important;
            }
            
            .btn:active {
                transform: translateY(-1px) scale(0.98) !important;
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                border: 2px solid rgba(255, 255, 255, 0.2) !important;
            }
            
            .btn-sm {
                padding: 0.75rem 1.2rem !important;
                font-size: 0.85rem !important;
                border-radius: 14px !important;
            }
            
            /* Exam Type Tabs - Stack Vertically */
            .exam-type-tabs { 
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .exam-type-tab {
                width: 100% !important;
                min-width: auto !important;
            }
            
            /* Section Headers - Enhanced */
            .section-header { 
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem !important;
                padding: 1.5rem !important;
                background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,255,0.95) 100%) !important;
                border-radius: 24px !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2) !important;
                margin-bottom: 1.5rem !important;
                backdrop-filter: blur(10px);
            }
            
            .section-title {
                font-size: 1.6rem !important;
                font-weight: 900 !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: titleShine 3s ease-in-out infinite;
            }
            
            @keyframes titleShine {
                0%, 100% { filter: brightness(1); }
                50% { filter: brightness(1.2); }
            }
            
            .dashboard-header {
                background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,255,0.95) 100%) !important;
                border-radius: 24px !important;
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2) !important;
                backdrop-filter: blur(10px);
            }
            
            .dashboard-title {
                font-size: 1.8rem !important;
                font-weight: 900 !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.5rem !important;
            }
            
            .dashboard-subtitle {
                color: #64748b !important;
                font-size: 1rem !important;
                font-weight: 500 !important;
            }
            
            /* AI Guidance Section - Full Visibility */
            #ai-guidance-section,
            .ai-chat-container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0.75rem !important;
            }
            
            .chat-messages {
                max-height: 60vh !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            .message {
                max-width: 100% !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .message-content {
                font-size: 0.9rem !important;
                line-height: 1.6 !important;
            }
            
            /* Chat Input */
            .chat-input-container {
                position: sticky;
                bottom: 0;
                background: white;
                padding: 0.75rem !important;
                border-top: 1px solid var(--gray-200);
            }
            
            .chat-input {
                font-size: 16px !important;
                min-height: 44px !important;
            }
            
            /* File Attachments */
            .file-drop-zone {
                padding: 1rem !important;
            }
            
            .file-item {
                padding: 0.75rem !important;
                flex-wrap: wrap;
            }
            
            /* Tables - Horizontal Scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                font-size: 0.85rem !important;
                min-width: 600px;
            }
            
            th, td {
                padding: 0.5rem !important;
                white-space: nowrap;
            }
            
            /* Touch Friendly Elements */
            button, 
            a, 
            .clickable { 
                min-height: 44px;
                min-width: 44px;
            }
            
            button { 
                -webkit-tap-highlight-color: transparent; 
                user-select: none; 
            }
            
            /* Prevent Horizontal Scroll */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            img {
                max-width: 100%;
                height: auto;
            }
            
            /* Force word wrapping on all text elements */
            p, span, div, h1, h2, h3, h4, h5, h6, li {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
            }
            
            /* Ensure containers don't overflow */
            .section, .dashboard-container, .content-area-full {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            /* Smooth Scrolling */
            * {
                scroll-behavior: smooth;
            }
            
            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: rgba(102, 126, 234, 0.1);
                border-radius: 10px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            }
            
            /* Keyboard Shortcuts - Enhanced */
            .shortcuts-toggle-btn {
                width: 56px !important;
                height: 56px !important;
                bottom: 1.25rem !important;
                right: 1.25rem !important;
                z-index: 999;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.5) !important;
                border: 3px solid rgba(255, 255, 255, 0.3) !important;
                animation: floatButton 3s ease-in-out infinite;
            }
            
            @keyframes floatButton {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-8px); }
            }
            
            .shortcuts-toggle-btn:hover {
                transform: scale(1.15) rotate(10deg) !important;
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6) !important;
            }
            
            .keyboard-shortcuts-help {
                width: calc(100% - 1.5rem) !important;
                left: 0.75rem !important;
                right: 0.75rem !important;
                bottom: 5.5rem !important;
                max-height: 70vh !important;
                border-radius: 24px !important;
                box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4) !important;
                border: 2px solid rgba(102, 126, 234, 0.2) !important;
            }
        }

        /* Tablet Styles */
        @media (min-width: 641px) and (max-width: 1024px) {
            .stats-grid, 
            .card-grid { 
                grid-template-columns: repeat(2, 1fr) !important; 
            }
            
            .section {
                padding: 1.5rem !important;
            }
            
            .enhanced-modal-content {
                max-width: 90% !important;
                height: auto !important;
            }
        }

        /* Mock Test Mobile Responsive */
        @media (max-width: 1024px) {
            .mock-test-container {
                padding: 1rem !important;
            }
            
            #mockTestInterfaceSection > div > div:nth-child(2) {
                grid-template-columns: 1fr !important;
            }
            
            .mock-test-header {
                padding: 1rem !important;
            }
            
            #mockTestTitle {
                font-size: 1.3rem !important;
            }
            
            #mockTestTimer {
                font-size: 1.5rem !important;
            }
        }

        @media (max-width: 768px) {
            /* Hide My Papers section on tablets and mobile */
            #myPapersSection,
            #makePaperSection {
                display: none !important;
            }
            
            /* Hide My Papers navigation buttons */
            .nav-btn[data-section="myPapersSection"],
            .nav-btn[data-section="makePaperSection"],
            .sidebar-nav-item[data-section="myPapersSection"],
            .sidebar-nav-item[data-section="makePaperSection"] {
                display: none !important;
            }
            
            /* Ensure Documents section is visible */
            #documentsSection {
                display: block !important;
            }
            
            #mockTestInterfaceSection {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .mock-test-container {
                padding: 0.75rem !important;
                overflow: visible !important;
            }
            
            .mock-test-header > div {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .mock-test-header > div > div:last-child {
                width: 100%;
                justify-content: space-between !important;
                gap: 1rem !important;
            }
            
            #mockTestQuestions {
                padding: 1rem !important;
                font-size: 0.95rem !important;
                overflow: visible !important;
            }
            
            #mockTestQuestions > div > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            #mockTestQuestions > div > div:first-child > div:last-child {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            #mockTestQuestions label {
                padding: 1rem !important;
            }
            
            #prevQuestionBtn, #nextQuestionBtn, #submitMockTestBtn {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
            }
            
            #questionPalette {
                grid-template-columns: repeat(6, 1fr) !important;
            }
        }

        @media (max-width: 640px) {
            .mock-test-header {
                border-radius: 12px !important;
                margin-bottom: 1rem !important;
            }
            
            #mockTestTitle {
                font-size: 1.1rem !important;
            }
            
            #mockTestInfo {
                font-size: 0.85rem !important;
            }
            
            #mockTestTimer {
                font-size: 1.3rem !important;
            }
            
            .mock-test-header button {
                padding: 0.5rem 1rem !important;
                font-size: 0.85rem !important;
            }
            
            #mockTestQuestions {
                border-radius: 12px !important;
                padding: 0.75rem !important;
                overflow: visible !important;
            }
            
            #mockTestQuestions > div > div:nth-child(2) {
                font-size: 1rem !important;
                padding: 1rem !important;
            }
            
            #questionPalette {
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 0.4rem !important;
            }
            
            #questionPalette button {
                width: 35px !important;
                height: 35px !important;
                font-size: 0.85rem !important;
            }
            
            #prevQuestionBtn, #nextQuestionBtn, #submitMockTestBtn {
                padding: 0.65rem 0.85rem !important;
                font-size: 0.85rem !important;
            }
            
            #prevQuestionBtn i, #nextQuestionBtn i, #submitMockTestBtn i {
                display: none;
            }
        }

        /* Extra Small Mobile */
        @media (max-width: 480px) {
            body { 
                font-size: 13px; 
            }
            
            .header { 
                padding: 0.5rem !important; 
            }
            
            .section {
                padding: 0.5rem !important;
            }
            
            /* Hide My Papers section on mobile */
            #myPapersSection,
            #makePaperSection {
                display: none !important;
            }
            
            /* Hide My Papers navigation button on mobile */
            .nav-btn[data-section="myPapersSection"],
            .nav-btn[data-section="makePaperSection"],
            .sidebar-nav-item[data-section="myPapersSection"],
            .sidebar-nav-item[data-section="makePaperSection"] {
                display: none !important;
            }
            
            /* Ensure Documents section is visible on mobile */
            #documentsSection {
                display: block !important;
            }
            
            .nav-btn[data-section="documentsSection"],
            .sidebar-nav-item[data-section="documentsSection"] {
                display: flex !important;
            }
            
            .btn {
                padding: 0.65rem 0.85rem !important;
                font-size: 0.85rem !important;
            }
            
            .section-title {
                font-size: 1.25rem !important;
            }
            
            .mock-test-container {
                padding: 0.5rem !important;
            }
            
            #mockTestTitle {
                font-size: 1rem !important;
            }
            
            #mockTestInfo {
                font-size: 0.8rem !important;
            }
            
            #mockTestTimer {
                font-size: 1.2rem !important;
            }
            
            .mock-test-header > div > div:last-child {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .mock-test-header button {
                width: 100%;
                padding: 0.5rem !important;
            }
            
            #mockTestQuestions {
                padding: 0.5rem !important;
            }
            
            #mockTestQuestions > div > div:nth-child(2) {
                font-size: 0.95rem !important;
                padding: 0.75rem !important;
            }
            
            #mockTestQuestions label {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            
            #questionPalette {
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 0.3rem !important;
            }
            
            #questionPalette button {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.8rem !important;
            }
            
            #prevQuestionBtn span, #nextQuestionBtn span, #submitMockTestBtn span {
                display: none;
            }
            
            /* Mock Test Results Mobile - Force overflow visible everywhere */
            #mockTestInterfaceSection,
            .mock-test-container,
            #mockTestQuestions,
            #mockTestQuestions > div,
            .mock-test-results {
                overflow: visible !important;
            }
            
            body {
                overflow-x: hidden !important;
                overflow-y: auto !important;
            }
            
            .mock-test-results {
                padding: 2rem 1rem !important;
                min-height: auto !important;
                padding-top: 2rem !important;
            }
            
            .results-check-icon {
                width: 120px !important;
                height: 120px !important;
                margin: 0 auto 1.5rem !important;
                position: relative !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .results-check-icon i {
                font-size: 3.5rem !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                line-height: 1 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .results-title {
                font-size: 1.5rem !important;
            }
            
            .results-test-name {
                font-size: 1rem !important;
            }
            
            .results-marking-info {
                font-size: 0.85rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .results-stats-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .results-stat-card {
                padding: 1.25rem !important;
            }
            
            .results-stat-card .stat-number {
                font-size: 2rem !important;
            }
            
            .results-stat-card .stat-label {
                font-size: 0.95rem !important;
            }
            
            .results-stat-card .stat-marks,
            .results-stat-card .stat-percentage {
                font-size: 0.85rem !important;
            }
            
            .results-actions {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .results-actions button {
                width: 100%;
                padding: 0.85rem 1rem !important;
                font-size: 0.95rem !important;
            }
        }

        /* Landscape Mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .enhanced-modal-content {
                max-height: 95vh !important;
            }
            
            .chat-messages {
                max-height: 40vh !important;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Document Viewer Page Styles */
        #documentViewerPage {
            animation: slideInRight 0.3s ease-out;
        }

        /* Modern PDF Viewer Styles */
        #pdfCanvas {
            transition: all 0.3s ease;
        }

        #pdfViewerContainer:fullscreen {
            background: #0f172a;
        }

        #pdfViewerContainer:fullscreen #pdfCanvasWrapper {
            max-height: 100vh;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        #bookViewerContainer {
            transition: all 0.3s ease;
        }

        #documentViewerPageContent {
            transition: transform 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        /* Book flip effect */
        #documentViewerPageContent iframe {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Chapter card hover effects */
        .chapter-card {
            position: relative;
        }

        .chapter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 16px;
            pointer-events: none;
        }

        .chapter-card:hover::before {
            opacity: 1;
        }

        /* Fullscreen styles */
        #bookViewerContainer:fullscreen {
            background: #1f2937;
            padding: 1rem;
        }

        #bookViewerContainer:fullscreen #documentViewerPageContent {
            height: calc(100vh - 150px);
        }

        /* Smooth page transitions */
        .section {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Document type badges animation */
        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .chapter-card:hover span {
            animation: badgePulse 0.6s ease-in-out;
        }
    </style>
</head>

<body>
    <!-- Authentication Section -->
    <div class="auth-container" id="authSection" style="display: flex;">
        <div class="auth-card">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="logo-text">EduSphere Pro</h1>
                <p class="logo-subtitle">Advanced JEE/NEET Preparation Platform</p>
            </div>

            <!-- Auth Toggle Buttons -->
            <div class="auth-toggle">
                <button class="auth-toggle-btn active" id="loginToggle" onclick="showLogin()">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </button>
                <button class="auth-toggle-btn" id="registerToggle" onclick="showRegister()">
                    <i class="fas fa-user-plus"></i>
                    Register
                </button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" name="username" class="form-input"
                        placeholder="Enter your username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" name="password" class="form-input"
                            placeholder="Enter your password" required autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('password')">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="role">Role</label>
                    <div class="role-selector">
                        <div class="role-dropdown" id="roleDropdown">
                            <div class="role-selected" onclick="toggleRoleDropdown('role')">
                                <div class="role-selected-content">
                                    <i class="fas fa-user-circle role-icon"></i>
                                    <span class="role-text">Select your role</span>
                                </div>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="role-options" id="roleOptions">
                                <div class="role-option" data-value="student" onclick="selectRole('role', 'student')">
                                    <div class="role-option-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <div class="role-option-content">
                                        <div class="role-option-title">Student</div>
                                        <div class="role-option-desc">Access practice tests and study materials</div>
                                    </div>
                                </div>
                                <div class="role-option" data-value="teacher" onclick="selectRole('role', 'teacher')">
                                    <div class="role-option-icon">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                    </div>
                                    <div class="role-option-content">
                                        <div class="role-option-title">Teacher</div>
                                        <div class="role-option-desc">Create and manage tests and questions</div>
                                    </div>
                                </div>
                                <div class="role-option" data-value="admin" onclick="selectRole('role', 'admin')">
                                    <div class="role-option-icon">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    <div class="role-option-content">
                                        <div class="role-option-title">Administrator</div>
                                        <div class="role-option-desc">Full system access and user management</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="role" name="role" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
            </form>

            <!-- Registration Form -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label class="form-label" for="regUsername">Username</label>
                    <input type="text" id="regUsername" class="form-input" placeholder="Choose a username" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="regEmail">Email</label>
                    <input type="email" id="regEmail" class="form-input" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="regPassword">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="regPassword" class="form-input"
                            placeholder="Create a password (min 6 chars)" required minlength="6">
                        <button type="button" class="password-toggle" onclick="togglePassword('regPassword')">
                            <i class="fas fa-eye" id="regPassword-toggle-icon"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="regConfirmPassword">Confirm Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="regConfirmPassword" class="form-input"
                            placeholder="Confirm your password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('regConfirmPassword')">
                            <i class="fas fa-eye" id="regConfirmPassword-toggle-icon"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="regRole">Role</label>
                    <div class="role-selector">
                        <div class="role-dropdown" id="regRoleDropdown">
                            <div class="role-selected" onclick="toggleRoleDropdown('regRole')">
                                <div class="role-selected-content">
                                    <i class="fas fa-user-circle role-icon"></i>
                                    <span class="role-text">Select your role</span>
                                </div>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="role-options" id="regRoleOptions">
                                <div class="role-option" data-value="student"
                                    onclick="selectRole('regRole', 'student')">
                                    <div class="role-option-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <div class="role-option-content">
                                        <div class="role-option-title">Student</div>
                                        <div class="role-option-desc">Access practice tests and study materials</div>
                                    </div>
                                </div>
                                <div class="role-option" data-value="teacher"
                                    onclick="selectRole('regRole', 'teacher')">
                                    <div class="role-option-icon">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                    </div>
                                    <div class="role-option-content">
                                        <div class="role-option-title">Teacher</div>
                                        <div class="role-option-desc">Create and manage tests and questions</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="regRole" name="regRole" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>
            </form>

            
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <header class="header">
            <!-- Mobile Hamburger Menu Button -->
            <button class="mobile-menu-btn" aria-label="Menu" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <div class="header-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>EduSphere Pro</span>
            </div>

            <div class="header-nav">
                <button class="nav-btn active" data-section="dashboardSection">
                    <i class="fas fa-home"></i>
                    Dashboard
                </button>
                <button class="nav-btn" data-section="ultraAiGuidanceSection">
                    <i class="fas fa-robot"></i>
                    AI Guidance
                </button>
                <button class="nav-btn" data-section="createTestSection">
                    <i class="fas fa-plus-circle"></i>
                    Create Test
                </button>
                <button class="nav-btn" data-section="questionBankSection">
                    <i class="fas fa-book"></i>
                    Question Bank
                </button>
                <button class="nav-btn" data-section="documentsSection">
                    <i class="fas fa-file-alt"></i>
                    Documents
                </button>
                <button class="nav-btn" data-section="performanceSection">
                    <i class="fas fa-chart-line"></i>
                    Performance
                </button>
                <button class="nav-btn" onclick="handleAdminButtonClick()" id="adminNavBtn">
                    <i class="fas fa-shield-alt"></i>
                    Admin Panel
                </button>
                <button class="nav-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>

            <div class="user-info" style="display: none;">
                <span id="userName" style="display: none;">User</span>
                <span id="userRole" style="display: none;">Role</span>
                <div id="userAvatar" style="display: none;">U</div>
            </div>
        </header>

        <div class="main-content">
            <main class="content-area-full">
                <div class="dashboard-scroll-container">
                    <!-- Dashboard Section -->
                    <section class="section" id="dashboardSection" style="display: none;">
                        <div class="dashboard-container">
                            <!-- Dashboard Header -->
                            <div class="dashboard-header">
                                <div class="header-content">
                                    <h1 class="dashboard-title">Dashboard</h1>
                                    <p class="dashboard-subtitle">Welcome back, <span id="greetingName">Student</span>!
                                        Ready to continue your learning journey?</p>
                                </div>

                            </div>

                            <!-- Stats Overview -->
                            <div class="stats-overview">
                                <div class="stats-row">
                                    <div class="stat-card">
                                        <div class="stat-header">
                                            <span class="stat-label">TOTAL TESTS</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-icon-wrapper purple">
                                                <i class="fas fa-clipboard-list"></i>
                                            </div>
                                            <div class="stat-number" id="dashboardTotalTests">0</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-header">
                                            <span class="stat-label">AVERAGE SCORE</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-icon-wrapper blue">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <div class="stat-number" id="dashboardAverageScore">0%</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-header">
                                            <span class="stat-label">HIGHEST SCORE</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-icon-wrapper green">
                                                <i class="fas fa-trophy"></i>
                                            </div>
                                            <div class="stat-number" id="dashboardHighestScore">0%</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-header">
                                            <span class="stat-label">TOTAL MARKS</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-icon-wrapper orange">
                                                <i class="fas fa-star"></i>
                                            </div>
                                            <div class="stat-number" id="dashboardTotalMarks">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <!-- Main Action Cards -->
                            <div class="action-cards-grid">
                                <!-- Question Bank Card -->
                                <div class="action-card">
                                    <div class="card-header-accent purple"></div>
                                    <div class="card-content">
                                        <div class="card-icon-container">
                                            <div class="card-icon purple">
                                                <i class="fas fa-book"></i>
                                            </div>
                                        </div>
                                        <h3 class="card-title">Question Bank</h3>
                                        <p class="card-description">Access thousands of acurated questions for JEE and
                                            NEET preparation</p>
                                        <button class="card-action-btn purple"
                                            onclick="showSection('questionBankSection')">
                                            <span>Explore Questions</span>
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Make Paper Card -->
                                <div class="action-card">
                                    <div class="card-header-accent blue"></div>
                                    <div class="card-content">
                                        <div class="card-icon-container">
                                            <div class="card-icon blue">
                                                <i class="fas fa-file-alt"></i>
                                            </div>
                                        </div>
                                        <h3 class="card-title">Make Paper</h3>
                                        <p class="card-description">Create custom exam papers with school details and download as PDF</p>
                                        <button class="card-action-btn blue" onclick="showSection('makePaperSection')">
                                            <span>Make Paper</span>
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Create Practice Test Card -->
                                <div class="action-card">
                                    <div class="card-header-accent green"></div>
                                    <div class="card-content">
                                        <div class="card-icon-container">
                                            <div class="card-icon green">
                                                <i class="fas fa-clipboard-check"></i>
                                            </div>
                                        </div>
                                        <h3 class="card-title">Create Practice Test</h3>
                                        <p class="card-description">Build interactive practice tests with instant feedback</p>
                                        <button class="card-action-btn green" onclick="openCreatePracticeTestModal()">
                                            <span>Create Test</span>
                                            <i class="fas fa-plus-circle"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- AI Guidance Card -->
                                <div class="action-card">
                                    <div class="card-header-accent orange"></div>
                                    <div class="card-content">
                                        <div class="card-icon-container">
                                            <div class="card-icon orange">
                                                <i class="fas fa-robot"></i>
                                            </div>
                                        </div>
                                        <h3 class="card-title">AI Guidance</h3>
                                        <p class="card-description">Get personalized study plans and doubt resolution
                                            from AI</p>
                                        <button class="card-action-btn orange"
                                            onclick="showSection('ultraAiGuidanceSection')">
                                            <span>Get Guidance</span>
                                            <i class="fas fa-brain"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>


                    <!-- NEW Make Paper Section -->
                    <section class="section" id="makePaperSection">
                        <div class="section-header">
                            <div>
                                <h2 class="section-title">
                                    <i class="fas fa-file-alt"></i>
                                    Create Exam Paper
                                </h2>
                                <p class="section-subtitle">Build custom exam papers with selected questions</p>
                            </div>
                            <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div style="max-width: 1400px; margin: 0 auto;">
                            <!-- JEE/NEET Toggle -->
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem;">
                                <div class="exam-type-tab active" id="paperJeeTab" onclick="selectPaperExamType('jee')" style="display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; border: 2px solid #6366f1; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s; min-width: 200px;">
                                    <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        <i class="fas fa-atom"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: 700;">JEE</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9;">Engineering</div>
                                    </div>
                                </div>
                                <div class="exam-type-tab" id="paperNeetTab" onclick="selectPaperExamType('neet')" style="display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; cursor: pointer; transition: all 0.3s; min-width: 200px;">
                                    <div style="width: 50px; height: 50px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: 700;">NEET</div>
                                        <div style="font-size: 0.85rem; opacity: 0.7;">Medical</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subject Cards -->
                            <div id="paperSubjectCards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                                <!-- JEE Subjects (default) -->
                                <div class="subject-card active" data-subject="physics" onclick="selectPaperSubject('physics')" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 2rem; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(59,130,246,0.3); border: 3px solid #3b82f6;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                                            <i class="fas fa-atom"></i>
                                        </div>
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 700;">Physics</div>
                                            <div style="font-size: 0.9rem; opacity: 0.9;" id="physicsLabel">JEE Physics</div>
                                        </div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 600;">
                                        <i class="fas fa-check-circle"></i> Selected
                                    </div>
                                </div>

                                <div class="subject-card" data-subject="chemistry" onclick="selectPaperSubject('chemistry')" style="background: white; color: #64748b; padding: 2rem; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 3px solid #e2e8f0;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <div style="width: 60px; height: 60px; background: #dcfce7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #10b981;">
                                            <i class="fas fa-flask"></i>
                                        </div>
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">Chemistry</div>
                                            <div style="font-size: 0.9rem;" id="chemistryLabel">JEE Chemistry</div>
                                        </div>
                                    </div>
                                    <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 600; color: #64748b;">
                                        Click to Select
                                    </div>
                                </div>

                                <div class="subject-card" data-subject="mathematics" id="thirdSubjectCard" onclick="selectPaperSubject('mathematics')" style="background: white; color: #64748b; padding: 2rem; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 3px solid #e2e8f0;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <div style="width: 60px; height: 60px; background: #fef3c7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #f59e0b;">
                                            <i class="fas fa-calculator" id="thirdSubjectIcon"></i>
                                        </div>
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;" id="thirdSubjectName">Mathematics</div>
                                            <div style="font-size: 0.9rem;" id="thirdSubjectLabel">JEE Mathematics</div>
                                        </div>
                                    </div>
                                    <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 600; color: #64748b;">
                                        Click to Select
                                    </div>
                                </div>
                            </div>

                            <!-- Filter Bar -->
                            <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Difficulty</label>
                                        <select id="paperDifficultyFilter" onchange="filterPaperQuestions()" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                            <option value="">All Levels</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium">Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Chapter</label>
                                        <select id="paperChapterFilter" onchange="filterPaperQuestions()" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                                            <option value="">All Chapters</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; align-items: flex-end;">
                                        <button onclick="resetPaperFilters()" style="width: 100%; padding: 0.75rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; color: #475569;">
                                            <i class="fas fa-redo"></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Selection Summary -->
                            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 12px;">
                                        <i class="fas fa-check-circle" style="font-size: 2rem;"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.9rem; opacity: 0.9;">Selected Questions</div>
                                        <div style="font-size: 2.5rem; font-weight: 700; line-height: 1;">
                                            <span id="paperSelectedCount">0</span>
                                            <span id="selectedQuestionsCount" style="display: none;">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                    <button onclick="selectAllPaper()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-check-double"></i> Select All
                                    </button>
                                    <button onclick="clearAllPaper()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                    <button onclick="goToNextStep()" style="background: white; border: none; color: #6366f1; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                        Next: Paper Settings <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Questions List -->
                            <div id="paperQuestionsList" style="display: grid; gap: 1rem;">
                                <div style="text-align: center; padding: 4rem; color: #94a3b8;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem;">Loading questions...</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Paper Settings Section -->
                    <section class="section" id="paperSettingsSection">
                        <div class="section-header">
                            <div>
                                <h2 class="section-title">
                                    <i class="fas fa-cog"></i>
                                    Paper Settings
                                </h2>
                                <p class="section-subtitle">Configure your exam paper for PDF generation</p>
                            </div>
                            <button class="section-close-btn" onclick="backToPaperSelection()">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>

                        <div style="max-width: 900px; margin: 0 auto;">
                            <!-- Selected Questions Summary -->
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; text-align: center;">
                                <div style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 0.5rem;">Questions Selected</div>
                                <div style="font-size: 3.5rem; font-weight: 700; line-height: 1;">
                                    <span id="settingsSelectedCount">0</span>
                                </div>
                                <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 0.5rem;" id="settingsExamInfo">JEE - Physics</div>
                            </div>

                            <!-- PDF Configuration Form -->
                            <div style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: #1e293b;">
                                    <i class="fas fa-file-pdf"></i> PDF Configuration
                                </h3>

                                <div style="display: grid; gap: 1.5rem;">
                                    <!-- School/Institute Name -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">School/Institute Name</label>
                                        <input type="text" id="schoolName" placeholder="e.g., ABC International School" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                    </div>

                                    <!-- Paper Title -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Paper Title</label>
                                        <input type="text" id="paperTitle" placeholder="e.g., Physics Mock Test 1" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                    </div>

                                    <!-- Exam Details Row -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Exam Date</label>
                                            <input type="date" id="examDate" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Duration (minutes)</label>
                                            <input type="number" id="examDuration" value="180" min="30" max="300" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                    </div>

                                    <!-- Marks Configuration -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Total Marks</label>
                                            <input type="number" id="totalMarks" value="100" min="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Marks per Question</label>
                                            <input type="number" id="marksPerQuestion" value="4" min="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                    </div>

                                    <!-- PDF Options -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #475569;">PDF Options</label>
                                        <div style="display: grid; gap: 0.75rem;">
                                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                                                <input type="checkbox" id="includeAnswers" checked style="width: 20px; height: 20px; cursor: pointer; accent-color: #6366f1;">
                                                <span style="font-weight: 500;">Include Answer Key</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                                                <input type="checkbox" id="includeSolutions" style="width: 20px; height: 20px; cursor: pointer; accent-color: #6366f1;">
                                                <span style="font-weight: 500;">Include Detailed Solutions</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                                                <input type="checkbox" id="showDifficulty" checked style="width: 20px; height: 20px; cursor: pointer; accent-color: #6366f1;">
                                                <span style="font-weight: 500;">Show Difficulty Level</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Instructions -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Instructions (Optional)</label>
                                        <textarea id="paperInstructions" rows="4" placeholder="Enter exam instructions..." style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                    <button onclick="backToPaperSelection()" style="flex: 1; padding: 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; color: #475569; font-size: 1rem;">
                                        <i class="fas fa-arrow-left"></i> Back to Selection
                                    </button>
                                    <button onclick="generatePaperPDF()" style="flex: 2; padding: 1rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; border-radius: 8px; cursor: pointer; font-weight: 700; color: white; font-size: 1rem; box-shadow: 0 4px 12px rgba(99,102,241,0.3);">
                                        <i class="fas fa-file-pdf"></i> Generate PDF
                                    </button>
                                </div>
                            </div>

                            <!-- Created Papers Container -->
                            <div id="createdPapersContainer" style="margin-top: 3rem;">
                                <!-- Created papers will be displayed here -->
                            </div>
                        </div>
                    </section>

                    <!-- PDF Generation Progress Modal -->
                    <div id="pdfProgressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <h3 style="margin: 0 0 1.5rem 0; font-size: 1.5rem; color: #1e293b; text-align: center;">
                                <i class="fas fa-file-pdf" style="color: #6366f1;"></i> Generating PDF
                            </h3>
                            
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span id="pdfProgressText" style="font-weight: 600; color: #475569;">Initializing...</span>
                                    <span id="pdfProgressPercent" style="font-weight: 700; color: #6366f1;">0%</span>
                                </div>
                                <div style="width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden;">
                                    <div id="pdfProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.3s ease; border-radius: 6px;"></div>
                                </div>
                            </div>
                            
                            <div id="pdfProgressDetails" style="font-size: 0.9rem; color: #64748b; text-align: center; min-height: 20px;">
                                Please wait...
                            </div>
                            
                            <div style="margin-top: 1.5rem; text-align: center;">
                                <div style="display: inline-block; padding: 0.5rem 1rem; background: #f1f5f9; border-radius: 8px; font-size: 0.85rem; color: #64748b;">
                                    <i class="fas fa-info-circle"></i> This may take a few moments
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Papers Section -->
                    <section class="section" id="myPapersSection">
                        <div class="section-header">
                            <div>
                                <h2 class="section-title">
                                    <i class="fas fa-folder-open"></i>
                                    My Papers
                                </h2>
                                <p class="section-subtitle">View and download your saved exam papers</p>
                            </div>
                            <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="paper-maker-container">
                            <!-- Filter and Search -->
                            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700); font-size: 0.9rem;">Exam Type</label>
                                        <select id="myPapersExamFilter" class="setting-input" onchange="loadMyPapers()" style="width: 100%;">
                                            <option value="">All Types</option>
                                            <option value="jee">JEE</option>
                                            <option value="neet">NEET</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700); font-size: 0.9rem;">Subject</label>
                                        <select id="myPapersSubjectFilter" class="setting-input" onchange="loadMyPapers()" style="width: 100%;">
                                            <option value="">All Subjects</option>
                                            <option value="physics">Physics</option>
                                            <option value="chemistry">Chemistry</option>
                                            <option value="mathematics">Mathematics</option>
                                            <option value="biology">Biology</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; align-items: flex-end;">
                                        <button class="btn btn-primary" onclick="loadMyPapers()" style="width: 100%;">
                                            <i class="fas fa-sync"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Papers List -->
                            <div id="myPapersList" style="display: grid; gap: 1.5rem;">
                                <!-- Papers will be loaded here -->
                                <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                    <p>Loading your papers...</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Create Practice Test Section -->
                    <section class="section" id="createPracticeTestSection">
                        <div class="section-header">
                            <div>
                                <h2 class="section-title">
                                    <i class="fas fa-clipboard-check"></i>
                                    Create Practice Test
                                </h2>
                                <p class="section-subtitle">Build interactive practice tests with instant feedback</p>
                            </div>
                            <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="paper-maker-container">
                            <!-- Test Configuration -->
                            <div id="practiceTestConfig" class="practice-test-config">
                                <h3 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                                    <i class="fas fa-sliders-h"></i> Configure Your Practice Test
                                </h3>

                                <div class="exam-type-tabs" style="margin-bottom: 2rem;">
                                    <div class="exam-type-tab active" onclick="selectPracticeExamType('jee')">
                                        <div class="tab-icon"><i class="fas fa-atom"></i></div>
                                        <div class="tab-content">
                                            <div class="tab-title">JEE</div>
                                            <div class="tab-subtitle">Engineering</div>
                                        </div>
                                    </div>
                                    <div class="exam-type-tab" onclick="selectPracticeExamType('neet')">
                                        <div class="tab-icon"><i class="fas fa-heartbeat"></i></div>
                                        <div class="tab-content">
                                            <div class="tab-title">NEET</div>
                                            <div class="tab-subtitle">Medical</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="subject-tabs" style="margin-bottom: 2rem;">
                                    <div class="subject-tab active" onclick="selectPracticeSubject('Physics')">
                                        <i class="fas fa-atom"></i> Physics
                                    </div>
                                    <div class="subject-tab" onclick="selectPracticeSubject('Chemistry')">
                                        <i class="fas fa-flask"></i> Chemistry
                                    </div>
                                    <div class="subject-tab" onclick="selectPracticeSubject('Mathematics')">
                                        <i class="fas fa-calculator"></i> Mathematics
                                    </div>
                                </div>

                                <div class="paper-settings">
                                    <div class="setting-group">
                                        <label class="setting-label">Number of Questions</label>
                                        <input type="number" id="practiceQuestionCount" class="setting-input" value="10" min="1" max="50">
                                    </div>

                                    <div class="setting-group">
                                        <label class="setting-label">Difficulty Level</label>
                                        <select id="practiceDifficulty" class="setting-input">
                                            <option value="mixed">Mixed</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium">Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>

                                <button class="btn btn-primary btn-block" onclick="startPracticeTest()" style="margin-top: 2rem;">
                                    <i class="fas fa-play"></i> Start Practice Test
                                </button>
                            </div>

                            <!-- Practice Test Interface (Hidden initially) -->
                            <div id="practiceTestInterface" class="practice-test-interface" style="display: none;">
                                <div class="test-header">
                                    <div class="test-info">
                                        <span><i class="fas fa-question-circle"></i> Question <span id="currentQuestionNum">1</span> of <span id="totalQuestionsNum">10</span></span>
                                        <span><i class="fas fa-check-circle"></i> Score: <span id="practiceScore">0</span></span>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="exitPracticeTest()">
                                        <i class="fas fa-times"></i> Exit Test
                                    </button>
                                </div>

                                <div id="practiceQuestionContainer">
                                    <!-- Questions will be loaded here -->
                                </div>

                                <div class="test-controls">
                                    <button class="btn btn-secondary" id="practicePrevBtn" onclick="previousPracticeQuestion()" disabled>
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    <button class="btn btn-primary" id="practiceNextBtn" onclick="nextPracticeQuestion()">
                                        Next <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="btn btn-success" id="practiceFinishBtn" onclick="finishPracticeTest()" style="display: none;">
                                        <i class="fas fa-flag-checkered"></i> Finish Test
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Practice Test Section (for viewing active test) -->
                    <section class="section" id="practiceTestSection">
                        <div class="practice-test-interface">
                            <div class="test-header">
                                <div>
                                    <h2 id="practiceTestTitle">Practice Test</h2>
                                    <div class="test-info">
                                        <span><i class="fas fa-question-circle"></i> Question <span id="practiceCurrentQ">1</span> of <span id="practiceTotalQ">10</span></span>
                                        <span><i class="fas fa-check-circle"></i> Correct: <span id="practiceCorrect">0</span></span>
                                        <span><i class="fas fa-times-circle"></i> Wrong: <span id="practiceWrong">0</span></span>
                                    </div>
                                </div>
                                <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div id="practiceTestContent">
                                <!-- Practice test content will be loaded here -->
                            </div>
                        </div>
                    </section>

                    <!-- Create Custom Test Section (Full Screen) -->
                    <section class="section" id="createCustomTestSection" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Create Custom Test</h2>
                            <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="paper-maker-container">
                            <!-- Test Configuration -->
                            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 1.5rem; color: #1f2937;"><i class="fas fa-cog"></i> Test Configuration</h3>
                                
                                <!-- Test Name -->
                                <div class="form-group">
                                    <label>Test Name</label>
                                    <input type="text" id="customTestName" class="form-input" placeholder="e.g., My Physics Practice Test">
                                </div>

                                <!-- Exam Type Selection -->
                                <div class="form-group">
                                    <label>Exam Type</label>
                                    <div class="exam-type-tabs" style="display: flex; gap: 1rem;">
                                        <div class="custom-test-exam-tab active" onclick="selectCustomTestExamType('jee')" style="flex: 1; padding: 1rem; border: 2px solid #667eea; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                                            <i class="fas fa-atom" style="font-size: 1.5rem; color: #667eea;"></i>
                                            <div style="font-weight: 600; margin-top: 0.5rem;">JEE</div>
                                        </div>
                                        <div class="custom-test-exam-tab" onclick="selectCustomTestExamType('neet')" style="flex: 1; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                                            <i class="fas fa-heartbeat" style="font-size: 1.5rem; color: #ef4444;"></i>
                                            <div style="font-weight: 600; margin-top: 0.5rem;">NEET</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Subject Selection -->
                                <div class="form-group">
                                    <label>Subject</label>
                                    <div class="subject-tabs" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <div class="custom-test-subject-tab active" onclick="selectCustomTestSubject('physics')" style="padding: 0.75rem 1.5rem; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                            <i class="fas fa-atom"></i> Physics
                                        </div>
                                        <div class="custom-test-subject-tab" onclick="selectCustomTestSubject('chemistry')" style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                            <i class="fas fa-flask"></i> Chemistry
                                        </div>
                                        <div class="custom-test-subject-tab" onclick="selectCustomTestSubject('mathematics')" style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: block;">
                                            <i class="fas fa-calculator"></i> Mathematics
                                        </div>
                                        <div class="custom-test-subject-tab" onclick="selectCustomTestSubject('biology')" style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: none;">
                                            <i class="fas fa-dna"></i> Biology
                                        </div>
                                    </div>
                                </div>

                                <!-- Duration -->
                                <div class="form-group">
                                    <label>Test Duration (minutes)</label>
                                    <input type="number" id="customTestDuration" class="form-input" value="60" min="10" max="180">
                                </div>

                                <!-- Marks Configuration -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Marks per Question</label>
                                        <input type="number" id="customTestMarksPerQuestion" class="form-input" value="4" min="1" max="10" oninput="updateNegativeMarkingDisplay()">
                                    </div>
                                    <div class="form-group">
                                        <label>Negative Marking</label>
                                        <select id="customTestNegativeMarking" class="form-input" onchange="updateNegativeMarkingDisplay()">
                                            <option value="yes">Yes (25% of per question marks)</option>
                                            <option value="no">No Negative Marking</option>
                                        </select>
                                        <small id="negativeMarkingInfo" style="display: block; margin-top: 0.5rem; color: #6b7280; font-size: 0.85rem;">
                                            <i class="fas fa-info-circle"></i> Negative marking will be 25% of marks per question
                                        </small>
                                    </div>
                                </div>

                                <!-- Selection Mode Toggle -->
                                <div class="form-group">
                                    <label>Question Selection Mode</label>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="selection-mode-btn active" onclick="toggleCustomTestMode('auto')" style="flex: 1; padding: 1rem; border: 2px solid #10b981; background: #10b981; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                            <i class="fas fa-magic"></i> Auto Select
                                        </button>
                                        <button class="selection-mode-btn" onclick="toggleCustomTestMode('manual')" style="flex: 1; padding: 1rem; border: 2px solid #e2e8f0; background: white; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                            <i class="fas fa-hand-pointer"></i> Manual Select
                                        </button>
                                    </div>
                                </div>

                                <!-- Auto Selection Options -->
                                <div id="customTestAutoSelection">
                                    <div class="form-group">
                                        <label>Number of Questions</label>
                                        <input type="number" id="customTestQuestionCount" class="form-input" value="10" min="1" max="50">
                                    </div>
                                    <div class="form-group">
                                        <label>Chapter</label>
                                        <select id="customTestChapter" class="form-input" onchange="filterCustomTestQuestions()">
                                            <option value="">All Chapters</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Difficulty Level</label>
                                        <select id="customTestDifficulty" class="form-input">
                                            <option value="mixed">Mixed</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium">Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Manual Selection Interface -->
                                <div id="customTestManualSelection" style="display: none;">
                                    <!-- Filters for Manual Selection -->
                                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                            <div class="form-group" style="margin: 0;">
                                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.9rem;">
                                                    <i class="fas fa-book"></i> Filter by Chapter
                                                </label>
                                                <select id="manualChapterFilter" class="form-input" onchange="filterManualQuestions()" style="width: 100%;">
                                                    <option value="all">All Chapters</option>
                                                </select>
                                            </div>
                                            <div class="form-group" style="margin: 0;">
                                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.9rem;">
                                                    <i class="fas fa-signal"></i> Filter by Difficulty
                                                </label>
                                                <select id="manualDifficultyFilter" class="form-input" onchange="filterManualQuestions()" style="width: 100%;">
                                                    <option value="all">All Difficulties</option>
                                                    <option value="easy">Easy</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="hard">Hard</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 600; color: #374151;">Selected Questions: <span id="selectedQuestionCount">0</span></span>
                                            <button onclick="customTestSelectedQuestions = []; renderManualQuestionSelection();" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                                <i class="fas fa-times"></i> Clear All
                                            </button>
                                        </div>
                                    </div>
                                    <div id="manualQuestionsList" style="max-height: 400px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                                        <!-- Questions will be loaded here -->
                                    </div>
                                </div>

                                <!-- Create Button -->
                                <button onclick="createAndSaveCustomTest()" class="btn btn-primary btn-block" style="margin-top: 2rem; padding: 1rem; font-size: 1.1rem;">
                                    <i class="fas fa-save"></i> Create & Save Test
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- AI Guidance Section - ChatGPT Style -->
                    <section class="section" id="aiGuidanceSection">
                        <div class="chatgpt-container">
                            <!-- Sidebar -->
                            <div class="chatgpt-sidebar">
                                <div class="sidebar-header">
                                    <button class="new-chat-button" onclick="startNewChat()">
                                        <i class="fas fa-plus"></i> New chat
                                    </button>
                                </div>

                                <div class="sidebar-footer">
                                    <div class="user-info">
                                        <div class="user-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="user-name">Student</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Chat Area -->
                            <div class="chatgpt-main">
                                <div class="chat-header">
                                    <div class="chat-title-section">
                                        <h1 id="currentChatTitle">AI Guidance</h1>
                                        <p>Get personalized study help from our AI tutors</p>
                                    </div>
                                    <div class="chat-controls">
                                        <button class="control-btn" onclick="clearCurrentChat()" title="Clear chat">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        <button class="control-btn" onclick="exportChat()" title="Export chat">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="control-btn" onclick="toggleChatSidebar()"
                                            title="Toggle sidebar">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="chat-container">
                                    <div class="chat-messages" id="chatMessages">
                                        <div class="welcome-message">
                                            <div class="welcome-header">
                                                <h2>How can I help with your JEE/NEET preparation today?</h2>
                                            </div>
                                            <div class="suggestion-grid">
                                                <div class="suggestion-card"
                                                    onclick="applySuggestion('Explain the concept of quantum numbers in atomic structure')">
                                                    <div class="suggestion-content">
                                                        <h4>Explain the concept of quantum numbers in atomic structure
                                                        </h4>
                                                    </div>
                                                </div>
                                                <div class="suggestion-card"
                                                    onclick="applySuggestion('Help me solve this integration problem: âˆ«(xÂ²+3x+2)/(x+1) dx')">
                                                    <div class="suggestion-content">
                                                        <h4>Help me solve this integration problem: âˆ«(xÂ²+3x+2)/(x+1)
                                                            dx
                                                        </h4>
                                                    </div>
                                                </div>
                                                <div class="suggestion-card"
                                                    onclick="applySuggestion('Create a study plan for JEE Advanced Physics in 3 months')">
                                                    <div class="suggestion-content">
                                                        <h4>Create a study plan for JEE Advanced Physics in 3 months
                                                        </h4>
                                                    </div>
                                                </div>
                                                <div class="suggestion-card"
                                                    onclick="applySuggestion('Explain the mechanism of SN1 and SN2 reactions with examples')">
                                                    <div class="suggestion-content">
                                                        <h4>Explain the mechanism of SN1 and SN2 reactions with examples
                                                        </h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chat-input-area">
                                        <div class="input-container" style="position: relative;">
                                            <button class="attachment-btn" onclick="openFileAttachmentModal()" title="Attach files" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-500); cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s ease; z-index: 10;">
                                                <i class="fas fa-paperclip"></i>
                                            </button>
                                            <textarea id="chatInput" placeholder="Message EduSphere AI..." rows="1" style="padding-left: 45px;"></textarea>
                                            <button id="sendButton" onclick="sendMessage()">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                        <!-- Attached Files Preview -->
                                        <div class="attached-files-preview" id="attachedFilesPreview" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-weight: 600; color: var(--gray-700); font-size: 0.9rem;">
                                                    <i class="fas fa-paperclip"></i>
                                                    Attached Files
                                                </span>
                                                <button onclick="clearAttachedFiles()" style="background: none; border: none; color: var(--gray-500); cursor: pointer; padding: 4px; border-radius: 4px;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="attached-files-list" id="attachedFilesList"></div>
                                        </div>
                                        <div class="input-footer">
                                            <p class="disclaimer">EduSphere AI may produce inaccurate information about
                                                people, places, or facts.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Question Bank Section -->
                    <section class="section" id="questionBankSection">
                        <div class="section-header" style="margin-bottom: 2rem;">
                            <h1 class="section-title" style="margin-bottom: 0.5rem;">Question Bank</h1>
                            <p class="section-subtitle">Practice questions for JEE and NEET preparation</p>
                        </div>

                        <!-- Language Selector -->
                        <div class="language-selector" style="margin: 0 0 2rem 0; padding: 0 1rem; display: flex; justify-content: flex-end; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="language-btn active" onclick="setQuestionLanguage('all')" data-lang="all" 
                                style="padding: 0.5rem 1rem; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                <i class="fas fa-globe"></i> All Languages
                            </button>
                            <button class="language-btn" onclick="setQuestionLanguage('en')" data-lang="en"
                                style="padding: 0.5rem 1rem; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                <i class="fas fa-language"></i> English
                            </button>
                            <button class="language-btn lang-gu" onclick="setQuestionLanguage('gu')" data-lang="gu"
                                style="padding: 0.5rem 1rem; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                <i class="fas fa-language"></i> àª—à«àªœàª°àª¾àª¤à«€
                            </button>
                        </div>

                        <!-- Exam Type Selection -->
                        <div class="exam-type-tabs" style="margin: 0 0 2rem 0; padding: 0 1rem;">
                            <button class="exam-type-tab active" onclick="showExamType('jee')" data-exam="jee">
                                <i class="fas fa-graduation-cap"></i></br>
                                JEE
                            </button>
                            <button class="exam-type-tab" onclick="showExamType('neet')" data-exam="neet">
                                <i class="fas fa-user-md"></i></br>
                                NEET
                            </button>
                        </div>



                        <!-- JEE Subjects -->
                        <div id="jeeSubjects" class="exam-content active">
                            <div class="subject-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                                <div class="subject-card" onclick="showSubjectPage('jee', 'physics')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; position: relative; z-index: 10;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-atom" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Physics</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Mechanics, Thermodynamics,
                                        Optics, Modern Physics</p>
                                </div>

                                <div class="subject-card" onclick="showSubjectPage('jee', 'chemistry')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-flask" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Chemistry</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Organic, Inorganic,
                                        Physical Chemistry</p>
                                </div>

                                <div class="subject-card" onclick="showSubjectPage('jee', 'mathematics')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-calculator" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Mathematics</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Calculus, Algebra,
                                        Coordinate Geometry</p>
                                </div>
                            </div>
                        </div>

                        <!-- NEET Subjects -->
                        <div id="neetSubjects" class="exam-content">
                            <div class="subject-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                                <div class="subject-card" onclick="showSubjectPage('neet', 'physics')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-atom" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Physics</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Mechanics, Optics, Modern
                                        Physics</p>
                                </div>

                                <div class="subject-card" onclick="showSubjectPage('neet', 'chemistry')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-flask" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Chemistry</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Organic, Inorganic,
                                        Physical Chemistry</p>
                                </div>

                                <div class="subject-card" onclick="showSubjectPage('neet', 'biology')"
                                    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;">
                                    <div class="subject-icon"
                                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                        <i class="fas fa-dna" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <h3
                                        style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">
                                        Biology</h3>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Botany, Zoology, Human
                                        Physiology</p>
                                </div>
                            </div>
                        </div>

                        <!-- Subject Detail Page -->
                        <div id="subjectDetailPage" class="exam-content" style="display: none;">
                            <div class="subject-detail-header" style="margin-bottom: 2rem;">
                                <button onclick="goBackToExamType()"
                                    style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Subjects
                                </button>
                                <h2 id="subjectDetailTitle"
                                    style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: #1f2937;">
                                </h2>
                                <p id="subjectDetailSubtitle" style="margin: 0; color: #6b7280;"></p>
                            </div>

                            <div id="chaptersGrid" class="chapters-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                                <!-- Chapters will be loaded here -->
                                <div style="padding: 20px; background: yellow; border: 2px solid red; margin: 10px;">
                                    <h3>DEBUG: Chapters Grid</h3>
                                    <p>If you see this, the chapters page is loading</p>
                                    <button onclick="showChapterQuestions('phy-1', 'Test Chapter')"
                                        style="background: green; color: white; padding: 10px; border: none; cursor: pointer;">
                                        DIRECT TEST BUTTON
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Chapter Questions Page -->
                        <div id="chapterQuestionsPage" class="exam-content" style="display: none;">
                            <div class="chapter-questions-header" style="margin-bottom: 2rem;">
                                <button onclick="goBackToSubject()"
                                    style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Chapters
                                </button>
                                <h2 id="chapterQuestionsTitle"
                                    style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: #1f2937;">
                                </h2>
                                <p id="chapterQuestionsSubtitle" style="margin: 0; color: #6b7280;"></p>
                            </div>

                            <div id="chapterQuestionsList" class="questions-container">
                                <!-- Questions will be loaded here -->
                            </div>
                        </div>

                        <!-- Hidden elements for compatibility with duplicate functions -->
                        <div id="subjectDetailView" style="display: none;"></div>
                        <div id="questionPracticeView" style="display: none;"></div>
                        <div id="practiceTitle" style="display: none;"></div>
                        <div id="practiceSubtitle" style="display: none;"></div>
                        <div id="questionsContainer" style="display: none;"></div>
                    </section>

                    <!-- Create Test Section -->
                    <section class="section" id="createTestSection">
                        <div class="section-header">
                            <div>
                                <h1 class="section-title">
                                    <i class="fas fa-plus-circle"></i>
                                    Create & Take Tests
                                </h1>
                                <p class="section-subtitle">Create custom papers, practice tests, or take mock tests</p>
                            </div>
                            <button class="section-close-btn" onclick="showSection('dashboardSection')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Test Creation Options -->
                        <div class="action-cards-grid" style="margin-bottom: 3rem;">
                            <!-- Make Paper Card -->
                            <div class="action-card">
                                <div class="card-header-accent blue"></div>
                                <div class="card-content">
                                    <div class="card-icon-container">
                                        <div class="card-icon blue">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Make Paper</h3>
                                    <p class="card-description">Create custom exam papers with school details and download as PDF</p>
                                    <button class="card-action-btn blue" onclick="showSection('makePaperSection')">
                                        <span>Make Paper</span>
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Create Practice Test Card -->
                            <div class="action-card">
                                <div class="card-header-accent green"></div>
                                <div class="card-content">
                                    <div class="card-icon-container">
                                        <div class="card-icon green">
                                            <i class="fas fa-clipboard-check"></i>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Create Custom Test</h3>
                                    <p class="card-description">Build personalized tests with auto or manual question selection</p>
                                    <button class="card-action-btn green" onclick="showSection('createCustomTestSection')">
                                        <span>Create Test</span>
                                        <i class="fas fa-plus-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Mock Tests Section -->
                        <div class="section-header" style="margin-top: 3rem;">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-check" style="color: var(--primary);"></i>
                                Available Mock Tests
                            </h2>
                            <p class="section-subtitle">Standardized mock tests for comprehensive practice</p>
                        </div>

                        <div id="mockTestsDisplay" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                            <!-- Mock tests will be loaded here -->
                        </div>

                        <!-- Personal Tests Section -->
                        <div style="margin-top: 3rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">
                                <i class="fas fa-user-check"></i> My Personal Tests
                            </h2>
                            <p style="color: #6b7280; margin-bottom: 1.5rem;">Custom tests created by you</p>
                            
                            <div id="personalTestsDisplay" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                                <!-- Personal tests will be loaded here -->
                            </div>
                        </div>
                    </section>



                    <!-- Documents Section -->
                    <section class="section" id="documentsSection">
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-file-alt"></i>
                                Documents
                            </h1>
                            <p class="section-subtitle">Access study materials, PDFs, PPTs, and documents</p>
                        </div>

                        <!-- Exam Type Selection -->
                        <div class="exam-type-tabs" style="margin-bottom: 2rem;">
                            <button class="exam-type-tab active" onclick="showDocumentsExamType('jee')" data-exam="jee" id="docsJeeTab">
                                <i class="fas fa-graduation-cap"></i><br/>
                                JEE
                            </button>
                            <button class="exam-type-tab" onclick="showDocumentsExamType('neet')" data-exam="neet" id="docsNeetTab">
                                <i class="fas fa-user-md"></i><br/>
                                NEET
                            </button>
                        </div>

                        <!-- Subject Filter Buttons -->
                        <div id="documentsSubjectFilter" style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: center;">
                            <!-- Subject buttons will be dynamically added here -->
                        </div>

                        <!-- Documents Grid (Button Style like Question Bank) -->
                        <div id="documentsGrid" class="documents-grid">
                            <!-- Documents will be loaded here -->
                            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1.1rem;">Loading documents...</p>
                            </div>
                        </div>
                    </section>

                    <!-- Beautiful Document Viewer -->
                    <section class="section" id="documentViewerPage" style="display: none;">
                        <div class="document-viewer-container">
                            <!-- Beautiful Header with Glassmorphism -->
                            <div class="document-viewer-header">
                                <div class="document-viewer-header-left">
                                    <button onclick="closeDocumentViewerPage()" class="doc-back-btn">
                                        <i class="fas fa-arrow-left"></i>
                                        <span class="back-text">Back</span>
                                    </button>
                                    <div class="document-title-section">
                                        <h2 id="documentViewerPageTitle" class="document-title"></h2>
                                        <p id="documentViewerPageSubtitle" class="document-subtitle"></p>
                                    </div>
                                </div>
                                <div class="document-viewer-actions">
                                    <button id="documentPageDownloadBtn" class="doc-download-btn">
                                        <i class="fas fa-download"></i>
                                        <span class="btn-text">Download</span>
                                    </button>
                                    <button onclick="toggleDocumentFullscreen()" class="doc-fullscreen-btn">
                                        <i class="fas fa-expand"></i>
                                        <span class="btn-text">Fullscreen</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Beautiful iframe container with shadow and rounded corners -->
                            <div id="pdfViewerContainer" class="pdf-viewer-container">
                                <!-- Loading Animation -->
                                <div id="documentLoadingAnimation" class="document-loading">
                                    <div class="loading-spinner"></div>
                                    <p class="loading-title">Loading Document...</p>
                                    <p class="loading-subtitle">Please wait while we prepare your document</p>
                                </div>
                                
                                <!-- Beautiful iframe wrapper with shadow and rounded corners -->
                                <div id="pdfIframeWrapper" class="pdf-iframe-wrapper"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Performance Section -->
                    <section class="section" id="performanceSection">
                        <div class="section-header">
                            <h1 class="section-title">Performance Analytics</h1>
                            <p class="section-subtitle">Track your progress and analyze your performance</p>
                            <button class="section-close-btn" onclick="goBackToHome()" title="Back to Dashboard">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div class="performance-dashboard">
                            <!-- Performance Overview Cards -->
                            <div class="performance-cards">
                                <div class="performance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3>Overall Score</h3>
                                        <div class="score" id="overallScore">78%</div>
                                        <p class="score-change">+5% from last week</p>
                                    </div>
                                </div>

                                <div class="performance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3>Tests Completed</h3>
                                        <div class="score" id="testsCompleted">24</div>
                                        <p class="score-change">+3 this week</p>
                                    </div>
                                </div>

                                <div class="performance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3>Best Subject</h3>
                                        <div class="score" id="bestSubject">Physics</div>
                                        <p class="score-change">85% average</p>
                                    </div>
                                </div>

                                <div class="performance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-target"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3>Accuracy</h3>
                                        <div class="score" id="accuracy">82%</div>
                                        <p class="score-change">+2% improvement</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Charts -->
                            <div class="performance-section">
                                <h2><i class="fas fa-chart-line"></i> Performance Trends</h2>
                                <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-800); font-size: 1.1rem;">Score Progress</h3>
                                        <canvas id="scoreProgressChart" style="max-height: 300px;"></canvas>
                                    </div>
                                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-800); font-size: 1.1rem;">Subject-wise Performance</h3>
                                        <canvas id="subjectPerformanceChart" style="max-height: 300px;"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Test Results -->
                            <div class="performance-section">
                                <h2><i class="fas fa-clipboard-check"></i> Recent Test Results</h2>
                                <div id="recentTestResults" style="display: grid; gap: 1rem;">
                                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                        <p>No test results yet. Take a test to see your performance!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Mock Test Interface Section -->
                    <section class="section" id="mockTestInterfaceSection" style="display: none; position: relative; z-index: 100; background: var(--gray-50); min-height: 100vh; overflow: visible;">
                        <div class="mock-test-container" style="max-width: 1400px; margin: 0 auto; padding: 2rem; position: relative; z-index: 101; overflow: visible;">
                            <!-- Test Header -->
                            <div class="mock-test-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div>
                                        <h1 id="mockTestTitle" style="margin: 0 0 0.5rem 0; font-size: 1.8rem; font-weight: 700;">Mock Test</h1>
                                        <p id="mockTestInfo" style="margin: 0; opacity: 0.9; font-size: 1rem;">Loading...</p>
                                    </div>
                                    <div style="display: flex; gap: 2rem; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">Time Remaining</div>
                                            <div id="mockTestTimer" style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">00:00</div>
                                        </div>
                                        <button onclick="exitMockTest()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                            <i class="fas fa-times"></i> Exit Test
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Content -->
                            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; overflow: visible;">
                                <!-- Questions Area -->
                                <div style="overflow: visible;">
                                    <div id="mockTestQuestions" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: visible;">
                                        <!-- Questions will be loaded here -->
                                    </div>

                                    <!-- Navigation Buttons -->
                                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                                        <button id="prevQuestionBtn" onclick="navigateMockQuestion(-1)" class="btn btn-secondary" style="padding: 1rem 2rem;">
                                            <i class="fas fa-arrow-left"></i> Previous
                                        </button>
                                        <button id="nextQuestionBtn" onclick="navigateMockQuestion(1)" class="btn btn-primary" style="padding: 1rem 2rem;">
                                            Next <i class="fas fa-arrow-right"></i>
                                        </button>
                                        <button id="submitMockTestBtn" onclick="submitMockTest()" class="btn btn-success" style="padding: 1rem 2rem; display: none;">
                                            <i class="fas fa-check"></i> Submit Test
                                        </button>
                                    </div>
                                </div>

                                <!-- Sidebar -->
                                <div>
                                    <!-- Question Palette -->
                                    <div style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--gray-800);">
                                            <i class="fas fa-th"></i> Question Palette
                                        </h3>
                                        <div id="questionPalette" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                                            <!-- Question numbers will be loaded here -->
                                        </div>
                                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                                <div style="width: 24px; height: 24px; background: var(--success); border-radius: 4px;"></div>
                                                <span>Answered</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                                <div style="width: 24px; height: 24px; background: var(--warning); border-radius: 4px;"></div>
                                                <span>Marked for Review</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                <div style="width: 24px; height: 24px; background: var(--gray-200); border-radius: 4px;"></div>
                                                <span>Not Answered</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Test Stats -->
                                    <div style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--gray-800);">
                                            <i class="fas fa-chart-pie"></i> Progress
                                        </h3>
                                        <div style="margin-bottom: 1rem;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.9rem; color: var(--gray-600);">Answered</span>
                                                <span id="answeredCount" style="font-weight: 600; color: var(--success);">0</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.9rem; color: var(--gray-600);">Marked</span>
                                                <span id="markedCount" style="font-weight: 600; color: var(--warning);">0</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 0.9rem; color: var(--gray-600);">Not Answered</span>
                                                <span id="notAnsweredCount" style="font-weight: 600; color: var(--gray-400);">0</span>
                                            </div>
                                        </div>
                                        <button onclick="markForReview()" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">
                                            <i class="fas fa-flag"></i> Mark for Review
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Admin Panel Section -->
                    <section class="section" id="adminSection">
                        <div class="section-header">
                            <h1 class="section-title">Admin Panel</h1>
                            <p class="section-subtitle">Manage users, questions, and system settings</p>
                            <button class="section-close-btn" onclick="goBackToHome()" title="Back to Dashboard">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div class="admin-dashboard">
                            <!-- Admin Navigation Tabs -->
                            <div class="admin-tabs">
                                <button class="admin-tab active" onclick="showAdminTab('users')">
                                    <i class="fas fa-users"></i>
                                    User Management
                                </button>
                                <button class="admin-tab" onclick="showAdminTab('questions')">
                                    <i class="fas fa-question-circle"></i>
                                    Question Management
                                </button>
                                <button class="admin-tab" onclick="showAdminTab('analytics')">
                                    <i class="fas fa-chart-bar"></i>
                                    System Analytics
                                </button>
                                <button class="admin-tab" onclick="showAdminTab('settings')">
                                    <i class="fas fa-clipboard-check"></i>
                                    Mock Test
                                </button>
                                <button class="admin-tab" onclick="showAdminTab('documents')">
                                    <i class="fas fa-file-alt"></i>
                                    Embedded Documents
                                </button>
                            </div>

                            <!-- User Management Tab -->
                            <div class="admin-tab-content active" id="users-tab">
                                <div class="admin-section-header">
                                    <h2>User Management</h2>
                                    <button class="btn btn-primary" onclick="showAddUserModal()">
                                        <i class="fas fa-plus"></i>
                                        Add New User
                                    </button>
                                </div>

                                <div class="admin-stats">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Total Users</h3>
                                            <div class="stat-number">1,247</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-user-graduate"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Students</h3>
                                            <div class="stat-number">1,156</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-chalkboard-teacher"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Teachers</h3>
                                            <div class="stat-number">78</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-user-shield"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Admins</h3>
                                            <div class="stat-number">13</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="users-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <tr>
                                                <td>John Doe</td>
                                                <td>john.doe@example.com</td>
                                                <td><span class="role-badge student">Student</span></td>
                                                <td><span class="status-badge active">Active</span></td>
                                                <td>2 hours ago</td>
                                                <td>
                                                    <button class="btn-icon" onclick="editUser('john.doe')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn-icon danger" onclick="deleteUser('john.doe')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Jane Smith</td>
                                                <td>jane.smith@example.com</td>
                                                <td><span class="role-badge teacher">Teacher</span></td>
                                                <td><span class="status-badge active">Active</span></td>
                                                <td>1 day ago</td>
                                                <td>
                                                    <button class="btn-icon" onclick="editUser('jane.smith')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn-icon danger" onclick="deleteUser('jane.smith')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Question Management Tab -->
                            <div class="admin-tab-content" id="questions-tab">
                                <div class="admin-section-header">
                                    <h2>Question Management</h2>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="btn btn-primary" onclick="showAddQuestionModal()">
                                            <i class="fas fa-plus"></i>
                                            Add New Question
                                        </button>
                                        <button class="btn btn-success" onclick="showEnhancedQuestionModal()"
                                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                            <i class="fas fa-magic"></i>
                                            Create Enhanced Question
                                        </button>

                                    </div>
                                </div>

                                <div class="admin-stats">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-question-circle"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Total Questions</h3>
                                            <div class="stat-number">2,847</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-atom"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Physics</h3>
                                            <div class="stat-number">1,156</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-flask"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Chemistry</h3>
                                            <div class="stat-number">978</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-calculator"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Mathematics</h3>
                                            <div class="stat-number">713</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="question-filters">
                                    <select class="form-select" id="adminSubjectFilter" onchange="filterAdminQuestions()">
                                        <option value="">All Subjects</option>
                                        <option value="physics">Physics</option>
                                        <option value="chemistry">Chemistry</option>
                                        <option value="mathematics">Mathematics</option>
                                        <option value="biology">Biology</option>
                                    </select>

                                    <select class="form-select" id="adminDifficultyFilter" onchange="filterAdminQuestions()">
                                        <option value="">All Difficulties</option>
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>

                                    <select class="form-select" id="adminChapterFilter" onchange="filterAdminQuestions()">
                                        <option value="">All Chapters</option>
                                    </select>

                                    <input type="text" class="form-input" id="adminSearchFilter"
                                        placeholder="Search questions..." onkeyup="debouncedFilterQuestions()" oninput="debouncedFilterQuestions()">

                                    <button class="btn btn-secondary" onclick="clearAdminFilters()" title="Clear all filters">
                                        <i class="fas fa-times"></i>
                                        Clear Filters
                                    </button>

                                    <button class="btn btn-primary" onclick="loadQuestionManagement()" title="Refresh questions">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                </div>

                                <div class="questions-list" id="adminQuestionsList">
                                    <!-- Questions will be loaded here -->
                                </div>
                            </div>

                            <!-- System Analytics Tab -->
                            <div class="admin-tab-content" id="analytics-tab">
                                <div class="admin-section-header">
                                    <h2>System Analytics & Management</h2>
                                </div>

                                <!-- System Management Actions -->
                                <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h3 style="margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.75rem;">
                                        <i class="fas fa-tools" style="color: #6366f1;"></i>
                                        System Management
                                    </h3>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                        <!-- Clear Chat History Card -->
                                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1.5rem; border: 2px solid #fbbf24;">
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                                <div style="width: 50px; height: 50px; background: #f59e0b; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                    <i class="fas fa-comments"></i>
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #92400e; font-size: 1.1rem;">Clear Chat History</h4>
                                                    <p style="margin: 0.25rem 0 0 0; color: #b45309; font-size: 0.85rem;">Remove all AI chat conversations</p>
                                                </div>
                                            </div>
                                            <p style="margin: 0 0 1rem 0; color: #92400e; font-size: 0.9rem; line-height: 1.5;">
                                                This will permanently delete all users' AI chat history from localStorage. This action cannot be undone.
                                            </p>
                                            <button onclick="clearAllChatHistory()" style="width: 100%; background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease;">
                                                <i class="fas fa-trash-alt"></i>
                                                Clear All Chat History
                                            </button>
                                        </div>

                                        <!-- Clear Cache Card -->
                                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; padding: 1.5rem; border: 2px solid #60a5fa;">
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                                <div style="width: 50px; height: 50px; background: #3b82f6; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                    <i class="fas fa-database"></i>
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #1e40af; font-size: 1.1rem;">Clear Browser Cache</h4>
                                                    <p style="margin: 0.25rem 0 0 0; color: #2563eb; font-size: 0.85rem;">Clear all localStorage data</p>
                                                </div>
                                            </div>
                                            <p style="margin: 0 0 1rem 0; color: #1e40af; font-size: 0.9rem; line-height: 1.5;">
                                                Clear all cached data including saved papers, user preferences, and temporary data.
                                            </p>
                                            <button onclick="clearBrowserCache()" style="width: 100%; background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease;">
                                                <i class="fas fa-broom"></i>
                                                Clear Browser Cache
                                            </button>
                                        </div>

                                        <!-- Refresh System Card -->
                                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 12px; padding: 1.5rem; border: 2px solid #4ade80;">
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                                <div style="width: 50px; height: 50px; background: #10b981; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                    <i class="fas fa-sync-alt"></i>
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #065f46; font-size: 1.1rem;">Refresh System</h4>
                                                    <p style="margin: 0.25rem 0 0 0; color: #059669; font-size: 0.85rem;">Reload all data and reset UI</p>
                                                </div>
                                            </div>
                                            <p style="margin: 0 0 1rem 0; color: #065f46; font-size: 0.9rem; line-height: 1.5;">
                                                Refresh the page and reload all data from the server. Useful after making changes.
                                            </p>
                                            <button onclick="refreshSystem()" style="width: 100%; background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease;">
                                                <i class="fas fa-redo"></i>
                                                Refresh System
                                            </button>
                                        </div>

                                        <!-- Google Drive API Key Card -->
                                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1.5rem; border: 2px solid #fbbf24;">
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                                <div style="width: 50px; height: 50px; background: #f59e0b; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                    <i class="fab fa-google-drive"></i>
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #92400e; font-size: 1.1rem;">Google Drive API</h4>
                                                    <p style="margin: 0.25rem 0 0 0; color: #b45309; font-size: 0.85rem;">Faster PDF loading (optional)</p>
                                                </div>
                                            </div>
                                            <p style="margin: 0 0 1rem 0; color: #92400e; font-size: 0.9rem; line-height: 1.5;">
                                                Add Google Drive API key for 10x faster PDF loading. Get free key from Google Cloud Console.
                                            </p>
                                            <input type="text" id="googleApiKeyInput" placeholder="AIzaSy..." style="width: 100%; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 8px; margin-bottom: 0.75rem; font-family: monospace;">
                                            <button onclick="saveGoogleApiKey()" style="width: 100%; background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease;">
                                                <i class="fas fa-key"></i>
                                                Save API Key
                                            </button>
                                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="display: block; text-align: center; margin-top: 0.75rem; color: #92400e; font-size: 0.85rem; text-decoration: underline;">
                                                Get Free API Key â†’
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="analytics-grid">
                                    <div class="analytics-card">
                                        <h3>User Activity</h3>
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-line"></i>
                                            <p>User activity chart would go here</p>
                                        </div>
                                    </div>

                                    <div class="analytics-card">
                                        <h3>Test Performance</h3>
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-bar"></i>
                                            <p>Performance analytics chart would go here</p>
                                        </div>
                                    </div>

                                    <div class="analytics-card">
                                        <h3>Popular Subjects</h3>
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-pie"></i>
                                            <p>Subject popularity chart would go here</p>
                                        </div>
                                    </div>

                                    <div class="analytics-card">
                                        <h3>System Usage</h3>
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-area"></i>
                                            <p>System usage chart would go here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mock Test Creation Tab -->
                            <div class="admin-tab-content" id="settings-tab">
                                <div class="admin-section-header">
                                    <h2>Create Mock Test for Everyone</h2>
                                    <p style="color: var(--gray-600);">Create standardized mock tests available to all students</p>
                                </div>

                                <div class="mock-test-form" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                                    
                                    <!-- Test Basic Info -->
                                    <h3 style="color: var(--primary); margin-bottom: 1.5rem;">
                                        <i class="fas fa-info-circle"></i> Test Information
                                    </h3>
                                    
                                    <div class="form-group" style="margin-bottom: 1rem;">
                                        <label for="mockTestName">Test Name <span style="color: red;">*</span></label>
                                        <input type="text" id="mockTestName" class="form-input" placeholder="e.g., JEE Main Mock Test 2024" required>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div class="form-group">
                                            <label for="mockTestExam">Exam Type <span style="color: red;">*</span></label>
                                            <select id="mockTestExam" class="form-input" required>
                                                <option value="">Select Exam</option>
                                                <option value="jee">JEE</option>
                                                <option value="neet">NEET</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="mockTestDuration">Duration (minutes) <span style="color: red;">*</span></label>
                                            <input type="number" id="mockTestDuration" class="form-input" placeholder="180" min="30" max="300" required>
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div class="form-group">
                                            <label for="mockTestMarksPerQuestion">Marks Per Question <span style="color: red;">*</span></label>
                                            <input type="number" id="mockTestMarksPerQuestion" class="form-input" placeholder="4" min="1" max="10" value="4" required>
                                        </div>

                                        <div class="form-group">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 1.8rem;">
                                                <input type="checkbox" id="mockTestNegativeMarking" checked style="width: 20px; height: 20px; cursor: pointer;">
                                                <span style="font-weight: 500;">Enable Negative Marking</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 1rem; background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                                        <p style="color: #856404; font-size: 0.9rem; margin: 0;">
                                            <i class="fas fa-info-circle"></i> 
                                            <strong>Negative Marking:</strong> When enabled, 25% of marks per question will be deducted for each wrong answer.
                                            <br>
                                            <span style="font-size: 0.85rem; margin-left: 1.2rem;">
                                                Example: If marks per question = 4, then wrong answer = -1 mark
                                            </span>
                                        </p>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 2rem;">
                                        <label for="mockTestDescription">Description</label>
                                        <textarea id="mockTestDescription" class="form-input" rows="2" placeholder="Brief description..."></textarea>
                                    </div>

                                    <!-- Manual Question Selection -->
                                    <h3 style="color: var(--primary); margin-bottom: 1rem;">
                                        <i class="fas fa-hand-pointer"></i> Select Questions Manually
                                    </h3>
                                    <p style="color: var(--gray-600); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                        Click the button below to open the question selector and choose specific questions for your mock test
                                    </p>

                                    <button type="button" class="btn btn-info" onclick="openQuestionSelector()" style="width: 100%; padding: 1rem; margin-bottom: 1.5rem;">
                                        <i class="fas fa-list-check"></i>
                                        Open Question Selector
                                    </button>

                                    <!-- Selected Questions Display -->
                                    <div id="selectedQuestionsDisplay" style="background: #f8f9ff; padding: 1rem; border-radius: 12px; border: 2px dashed var(--primary); min-height: 100px;">
                                        <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                            <p>No questions selected yet. Click "Open Question Selector" to choose questions.</p>
                                        </div>
                                    </div>

                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; margin: 1rem 0;">
                                        <strong style="font-size: 1.1rem;">Total Questions Selected: <span id="totalMockQuestions">0</span></strong>
                                    </div>

                                    <!-- Hidden input to store selected question IDs -->
                                    <input type="hidden" id="selectedQuestionIds" value="[]">

                                    <!-- Action Buttons -->
                                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                                        <button class="btn btn-primary" onclick="createMockTest()">
                                            <i class="fas fa-plus-circle"></i> Create Mock Test
                                        </button>
                                        <button class="btn btn-secondary" onclick="resetMockTestForm()">
                                            <i class="fas fa-redo"></i> Reset Form
                                        </button>
                                    </div>
                                </div>

                                <!-- Existing Mock Tests List -->
                                <div>
                                    <h3 style="margin-bottom: 1rem;">
                                        <i class="fas fa-clipboard-list"></i> Existing Mock Tests
                                    </h3>
                                    <div id="mockTestsList">
                                        <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                            <p>No mock tests created yet. Create your first mock test above!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Embedded Documents Tab -->
                            <div class="admin-tab-content" id="documents-tab">
                                <div class="admin-section-header">
                                    <h2>Embedded Documents Management</h2>
                                    <button class="btn btn-primary" onclick="showAddDocumentModal()">
                                        <i class="fas fa-plus"></i>
                                        Add New Document
                                    </button>
                                </div>

                                <!-- Documents List -->
                                <div id="adminDocumentsList" style="display: grid; gap: 1.5rem;">
                                    <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p style="font-size: 1.1rem;">Loading documents...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Add/Edit Document Modal -->
                    <div id="documentModal" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2 class="modal-title" id="documentModalTitle">Add New Document</h2>
                                <button class="modal-close" onclick="closeDocumentModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="documentForm" onsubmit="saveDocument(event)">
                                    <input type="hidden" id="documentId" value="">
                                    
                                    <div class="form-group">
                                        <label for="documentName">Document Name <span style="color: red;">*</span></label>
                                        <input type="text" id="documentName" class="form-input" placeholder="e.g., Physics Chapter 1 Notes" required>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label for="documentStream">Stream <span style="color: red;">*</span></label>
                                            <select id="documentStream" class="form-input" required onchange="updateDocumentSubjects()">
                                                <option value="">Select Stream</option>
                                                <option value="jee">JEE</option>
                                                <option value="neet">NEET</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="documentSubject">Subject <span style="color: red;">*</span></label>
                                            <select id="documentSubject" class="form-input" required>
                                                <option value="">Select Subject</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="documentType">Document Type</label>
                                        <select id="documentType" class="form-input">
                                            <option value="pdf">PDF</option>
                                            <option value="ppt">PowerPoint (PPT)</option>
                                            <option value="docx">Word Document (DOCX)</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="documentPdfUrl">PDF URL (For Flipbook) - Recommended</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="url" id="documentPdfUrl" class="form-input" placeholder="https://example.com/document.pdf" style="flex: 1;">
                                            <button type="button" onclick="testPdfUrl()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                                <i class="fas fa-check-circle"></i> Test URL
                                            </button>
                                        </div>
                                        <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> <strong>Direct PDF URL</strong> for realistic page flipping
                                        </small>
                                        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                                            <strong style="color: #1e40af;">âœ“ Supported URLs:</strong>
                                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #1e40af;">
                                                <li>Direct PDF links: <code>https://example.com/file.pdf</code></li>
                                                <li><strong>Google Drive:</strong> Right-click file â†’ Share â†’ "Anyone with the link" â†’ Copy link</li>
                                                <li>Dropbox: Use direct download link</li>
                                                <li>CDN-hosted PDFs</li>
                                            </ul>
                                        </div>
                                        <div style="background: #dcfce7; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                                            <strong style="color: #065f46;">âœ… Option 1: Google Drive (Our Flipbook):</strong>
                                            <ol style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #065f46;">
                                                <li>Upload PDF to Google Drive</li>
                                                <li>Share â†’ "Anyone with the link"</li>
                                                <li>Copy link and paste in "PDF URL"</li>
                                                <li>We'll create the flipbook for you!</li>
                                            </ol>
                                        </div>
                                        
                                        <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                                            <strong style="color: #92400e;">âš¡ Option 2: FlipHTML5 (Fastest - Recommended!):</strong>
                                            <ol style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #92400e;">
                                                <li>Go to <a href="https://fliphtml5.com" target="_blank" style="color: #92400e; text-decoration: underline;">FlipHTML5.com</a></li>
                                                <li>Upload your PDF (free account)</li>
                                                <li>Click "Share" â†’ Copy embed code</li>
                                                <li>Paste in "Embed Code" field below</li>
                                                <li>âœ¨ Instant professional flipbook!</li>
                                            </ol>
                                            <div style="background: rgba(255,255,255,0.5); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                                <strong>Why FlipHTML5?</strong> Professional flipbook, super fast, no loading time, works perfectly!
                                            </div>
                                        </div>
                                        
                                        <div style="background: #e0e7ff; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                                            <strong style="color: #3730a3;">ðŸ“š Option 3: Other Services:</strong>
                                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #3730a3;">
                                                <li><strong>Issuu:</strong> <a href="https://issuu.com" target="_blank" style="color: #3730a3;">issuu.com</a> - Professional publishing</li>
                                                <li><strong>Publuu:</strong> <a href="https://publuu.com" target="_blank" style="color: #3730a3;">publuu.com</a> - Interactive flipbooks</li>
                                                <li><strong>FlippingBook:</strong> <a href="https://flippingbook.com" target="_blank" style="color: #3730a3;">flippingbook.com</a> - Premium quality</li>
                                                <li><strong>Yumpu:</strong> <a href="https://yumpu.com" target="_blank" style="color: #3730a3;">yumpu.com</a> - Free & easy</li>
                                            </ul>
                                            <div style="background: rgba(255,255,255,0.5); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                                Upload PDF â†’ Get embed code â†’ Paste in "Embed Code" field
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="documentEmbedCode">Embed Code (iframe) - Alternative</label>
                                        <textarea id="documentEmbedCode" class="form-input" rows="4" placeholder='<iframe src="..." width="100%" height="600"></iframe>'></textarea>
                                        <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> Use this if you don't have a direct PDF URL
                                        </small>
                                    </div>

                                    <div class="form-group">
                                        <label for="documentDescription">Description</label>
                                        <textarea id="documentDescription" class="form-input" rows="2" placeholder="Brief description of the document"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="documentDownloadUrl">Download URL (Optional)</label>
                                        <input type="url" id="documentDownloadUrl" class="form-input" placeholder="https://...">
                                        <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> Direct download link for students
                                        </small>
                                    </div>

                                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                        <button type="button" class="btn btn-secondary" onclick="closeDocumentModal()">
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            Save Document
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- AI Guidance Section - Ultra Modern UI -->
                    <section class="section" id="ultraAiGuidanceSection">
                        <div class="chatgpt-container">
                            <!-- Sidebar -->
                            <div class="chatgpt-sidebar">
                                <div class="sidebar-header">
                                    <button class="new-chat-btn" onclick="startNewChat()">
                                        <i class="fas fa-plus"></i>
                                        <span>New chat</span>
                                    </button>
                                </div>

                                <div class="chat-history">
                                    <h4 id="chatHistoryTitle">TODAY (0)</h4>
                                    <div id="chatHistoryList" class="chat-history-list">
                                        <!-- Chat history items will be populated here -->
                                        <div class="no-chats">
                                            <i class="fas fa-comments"></i>
                                            <p>No chats yet</p>
                                            <small>Start a new chat to begin!</small>
                                        </div>
                                    </div>
                                </div>



                                <div class="sidebar-footer">
                                    <div class="user-info">
                                        <div class="user-avatar" id="sidebarUserAvatar">S</div>
                                        <div class="user-details">
                                            <span class="user-name" id="sidebarUserName">Student</span>
                                            <span class="user-role" id="sidebarUserRole">Free Plan</span>
                                        </div>
                                    </div>
                                    <button class="logout-btn" onclick="logoutUser()" title="Logout">
                                        <i class="fas fa-sign-out-alt"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Main Chat Area -->
                            <div class="chatgpt-main">
                                <!-- Messages Container -->
                                <div class="messages-container" id="ultraMessagesContainer">
                                    <!-- Welcome Screen -->
                                    <div class="welcome-screen">
                                        <div class="welcome-content">
                                            <div class="logo-section">
                                                <div class="logo-icon">
                                                    <i class="fas fa-graduation-cap"></i>
                                                </div>
                                                <h1>EduSphere AI</h1>
                                                <p>Your personal AI tutor for JEE & NEET preparation</p>
                                            </div>

                                            <div class="examples-section">
                                                <div class="example-category">
                                                    <h3><i class="fas fa-sun"></i> Examples</h3>
                                                    <div class="example-item"
                                                        onclick="sendQuickMessage('Explain the concept of electromagnetic induction')">
                                                        "Explain the concept of electromagnetic induction" â†’
                                                    </div>
                                                    <div class="example-item"
                                                        onclick="sendQuickMessage('Solve this calculus problem: Find the derivative of xÂ²sin(x)')">
                                                        "Solve this calculus problem: Find the derivative of xÂ²sin(x)"
                                                        â†’
                                                    </div>
                                                    <div class="example-item"
                                                        onclick="sendQuickMessage('Create a study schedule for organic chemistry')">
                                                        "Create a study schedule for organic chemistry" â†’
                                                    </div>
                                                </div>

                                                <div class="example-category">
                                                    <h3><i class="fas fa-bolt"></i> Capabilities</h3>
                                                    <div class="example-item">
                                                        ï¿½ Explains complex physics, chemistry, and math concepts
                                                    </div>
                                                    <div class="example-item">
                                                        ï¿½ Solves problems step-by-step with detailed explanations
                                                    </div>
                                                    <div class="example-item">
                                                        ï¿½ Creates personalized study plans and schedules
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Input Area -->
                                <div class="input-area">
                                    <div class="input-container">
                                        <div class="input-wrapper" style="position: relative;">
                                            <button class="attachment-btn" onclick="openFileAttachmentModal()" title="Attach files" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-500); cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s ease; z-index: 10;">
                                                <i class="fas fa-paperclip"></i>
                                            </button>
                                            <textarea id="ultraChatInput" placeholder="Message EduSphere AI..." style="padding-left: 45px;"
                                                onkeydown="handleUltraKeydown(event)"
                                                oninput="adjustUltraTextarea(this)" rows="1"></textarea>
                                            <button class="send-btn" onclick="sendUltraMessage()" id="ultraSendBtn">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Attached Files Preview for Ultra Chat -->
                                    <div class="attached-files-preview" id="ultraAttachedFilesPreview" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-700); font-size: 0.9rem;">
                                                <i class="fas fa-paperclip"></i>
                                                Attached Files
                                            </span>
                                            <button onclick="clearAttachedFiles()" style="background: none; border: none; color: var(--gray-500); cursor: pointer; padding: 4px; border-radius: 4px;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="attached-files-list" id="ultraAttachedFilesList"></div>
                                    </div>
                                    <div class="input-footer">
                                        <p>EduSphere AI can make mistakes. Consider checking important information.</p>
                                    </div>
                                </div>
                            </div>
                        </div>








                        <div class="input-footer">
                            <small>Press Enter to send, Shift+Enter for new line â€¢ ðŸ“Ž Attach files â€¢ Use $math$
                                for inline or $$math$$ for display â€¢ Click âˆš for math symbols</small>
                        </div>
                </div>
        </div>
    </div>
    </section>

    <!-- Question Bank Section -->
    <section class="section" id="questionBankSection">
        <div class="section-header">
            <h1 class="section-title">Question Bank</h1>
            <p class="section-subtitle">Practice questions from Physics, Chemistry, and Mathematics</p>
        </div>

        <!-- Subject Selection -->
        <div class="subject-tabs">
            <button class="subject-tab" onclick="showSubject('physics')" data-subject="physics">
                <i class="fas fa-atom"></i>
                Physics
            </button>
            <button class="subject-tab active" onclick="showSubject('chemistry')" data-subject="chemistry">
                <i class="fas fa-flask"></i>
                Chemistry
            </button>
            <button class="subject-tab" onclick="showSubject('mathematics')" data-subject="mathematics">
                <i class="fas fa-calculator"></i>
                Mathematics
            </button>
        </div>

        <!-- Questions Container -->
        <div class="questions-container" id="questionsContainer">
            <!-- Questions will be loaded here -->
        </div>
    </section>

    <!-- Admin Section Removed -->





    <!-- Student Results Tab -->
    <div class="admin-tab-content" id="student-results-tab" style="display: none;">
        <div class="admin-controls">
            <button class="btn btn-secondary" onclick="loadStudentResults()">
                <i class="fas fa-sync"></i>
                Refresh Results
            </button>
            <button class="btn btn-secondary" onclick="exportStudentResults()">
                <i class="fas fa-download"></i>
                Export Results
            </button>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3>ðŸ“Š Student Performance Analytics</h3>

            <!-- Summary Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Tests Taken</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageScore">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topScore">0%</div>
                    <div class="stat-label">Highest Score</div>
                </div>
            </div>

            <!-- Student Results Table -->
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Test Name</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Time Taken</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentResultsTable">
                        <!-- Results will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI Configuration Tab -->
    <div class="admin-tab-content" id="ai-config-tab" style="display: none;">
        <div class="card">
            <h3 style="margin-bottom: 1rem;">ðŸš€ Multi-AI Configuration (4 Providers with Auto-Fallback)</h3>

            <!-- Cohere Configuration -->
            <div class="form-group">
                <label class="form-label">ï¿½  Cohere API Key (Very Fast - Priority 1)</label>
                <div class="form-row">
                    <input type="text" id="cohereKey" class="form-input" placeholder="Cohere API Key (co_...)"
                        style="flex: 1;">
                    <button class="btn btn-secondary" onclick="testCohereKey()" style="width: auto;">
                        Test Cohere
                    </button>
                </div>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;">
                    Get free API key from: <a href="https://cohere.com/" target="_blank">cohere.com</a><br>
                    <strong>âš¡ Speed:</strong> 300+ tokens/sec | <strong>Free:</strong> 1000 calls/month
                </p>
            </div>

            <!-- Groq Configuration -->
            <div class="form-group">
                <label class="form-label">ï¿½ Grhoq API Key (Ultra Fast - Priority 2)</label>
                <div class="form-row">
                    <input type="text" id="cohereKey" class="form-input" placeholder="Cohere API Key (co_...)"
                        style="flex: 1;">
                    <button class="btn btn-secondary" onclick="testCohereKey()" style="width: auto;">
                        Test Cohere
                    </button>
                </div>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;">
                    Get free API key from: <a href="https://cohere.com/" target="_blank">cohere.com</a><br>
                    <strong>âš¡ Speed:</strong> 300+ tokens/sec | <strong>Free:</strong> 1000 calls/month
                </p>
            </div>

            <!-- Test All Keys -->
            <div class="form-row" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="testAllKeys()" style="flex: 1;">
                    <i class="fas fa-rocket"></i>
                    Test All API Keys
                </button>
                <button class="btn btn-secondary" onclick="checkAIStatus()" style="flex: 1;">
                    <i class="fas fa-robot"></i>
                    Check AI Status
                </button>
            </div>

            <div id="aiStatusResult" style="margin-top: 1rem;"></div>

            <!-- Speed Comparison -->
            <div
                style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-lg);">
                <h4 style="margin-bottom: 0.5rem;">ðŸ† Speed Rankings & Auto-Fallback Order:</h4>
                <div style="font-size: 0.9rem; line-height: 1.6;">
                    <div>1. ï¿½ <sttrong>Cohere</strong> - 300+ tokens/sec (Command R 08-2024) - PRIMARY</div>
                    <div>2. ï¿½ <strong>Goroq</strong> - 500+ tokens/sec (Llama 3.1 8B Instant)</div>
                </div>
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-600);">
                    <strong>Smart Fallback:</strong> If one provider fails, automatically tries the next fastest
                    available provider.
                </p>
            </div>
        </div>
    </div>


    </section>
    </div>
    </main>
    </div>
    </div>

    <!-- Performance Section -->
    <section class="section" id="performanceSection">
        <div class="section-header">
            <h1 class="section-title">Performance Analytics</h1>
            <p class="section-subtitle">Track your progress and analyze your performance</p>
            <button class="section-close-btn" onclick="goBackToHome()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="performance-dashboard">
            <!-- Performance Overview Cards -->
            <div class="performance-cards"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="performance-card"
                    style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--primary);">
                    <div class="card-icon" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">Overall Score</h3>
                        <div class="score" id="overallScore"
                            style="font-size: 2rem; font-weight: 700; color: var(--primary);">Loading...</div>
                        <p class="score-change" style="color: var(--success); font-size: 0.9rem;">+5% from last week</p>
                    </div>
                </div>

                <div class="performance-card"
                    style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--success);">
                    <div class="card-icon" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem;">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">Tests Completed</h3>
                        <div class="score" id="testsCompleted"
                            style="font-size: 2rem; font-weight: 700; color: var(--success);">Loading...</div>
                        <p class="score-change" style="color: var(--success); font-size: 0.9rem;">+3 this week</p>
                    </div>
                </div>

                <div class="performance-card"
                    style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--warning);">
                    <div class="card-icon" style="font-size: 2rem; color: var(--warning); margin-bottom: 1rem;">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">Best Subject</h3>
                        <div class="score" id="bestSubject"
                            style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">Loading...</div>
                        <p class="score-change" style="color: var(--success); font-size: 0.9rem;">85% average</p>
                    </div>
                </div>

                <div class="performance-card"
                    style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--info);">
                    <div class="card-icon" style="font-size: 2rem; color: var(--info); margin-bottom: 1rem;">
                        <i class="fas fa-target"></i>
                    </div>
                    <div class="card-content">
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">Accuracy</h3>
                        <div class="score" id="accuracy" style="font-size: 2rem; font-weight: 700; color: var(--info);">
                            Loading...</div>
                        <p class="score-change" style="color: var(--success); font-size: 0.9rem;">+2% improvement</p>
                    </div>
                </div>
            </div>

            <!-- Subject-wise Performance -->
            <div class="performance-section"
                style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1.5rem; color: var(--gray-800);">Subject-wise Performance</h2>
                <div class="subject-performance" id="subjectPerformance">
                    <div class="loading-placeholder" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Loading performance data...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Test Results -->
            <div class="performance-section"
                style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);">
                <h2 style="margin-bottom: 1.5rem; color: var(--gray-800);">Recent Test Results</h2>
                <div class="test-results" id="recentTestResults">
                    <div class="loading-placeholder" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Loading recent tests...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Section -->
    <section class="section" id="adminSection" style="display: none;">
        <div class="section-header">
            <h1 class="section-title">Admin Panel</h1>
            <p class="section-subtitle">Manage users, questions, and system settings</p>
            <button class="section-close-btn" onclick="goBackToHome()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="admin-dashboard">
            <!-- Admin Navigation Tabs -->
            <div class="admin-tabs"
                style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--gray-200); padding-bottom: 1rem;">
                <button class="admin-tab active" onclick="showAdminTab('users')"
                    style="padding: 0.75rem 1.5rem; border: none; background: var(--primary); color: white; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition-base);">
                    <i class="fas fa-users"></i>
                    User Management
                </button>
                <button class="admin-tab" onclick="showAdminTab('questions')"
                    style="padding: 0.75rem 1.5rem; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition-base);">
                    <i class="fas fa-question-circle"></i>
                    Question Management
                </button>
                <button class="admin-tab" onclick="showAdminTab('analytics')"
                    style="padding: 0.75rem 1.5rem; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition-base);">
                    <i class="fas fa-chart-bar"></i>
                    System Analytics
                </button>
                <button class="admin-tab" onclick="showAdminTab('settings')"
                    style="padding: 0.75rem 1.5rem; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition-base);">
                    <i class="fas fa-clipboard-check"></i>
                    Mock Test
                </button>
            </div>

            <!-- User Management Tab -->
            <div class="admin-tab-content active" id="users-tab">
                <div class="admin-section-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--gray-800);">User Management</h2>
                    <button class="btn btn-primary" onclick="refreshUserList()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Users
                    </button>
                </div>

                <div class="admin-stats"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--primary);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Total Users</h3>
                            <div class="stat-number" id="totalUsersCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--primary);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--success);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem;">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Students</h3>
                            <div class="stat-number" id="totalStudentsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--success);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--warning);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--warning); margin-bottom: 1rem;">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Teachers</h3>
                            <div class="stat-number" id="totalTeachersCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--warning);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--error);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--error); margin-bottom: 1rem;">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Admins</h3>
                            <div class="stat-number" id="totalAdminsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--error);">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="users-table"
                    style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--gray-200);">
                                <th style="text-align: left; padding: 1rem; color: var(--gray-700); font-weight: 600;">
                                    Username</th>
                                <th style="text-align: left; padding: 1rem; color: var(--gray-700); font-weight: 600;">
                                    Email</th>
                                <th style="text-align: left; padding: 1rem; color: var(--gray-700); font-weight: 600;">
                                    Role</th>
                                <th style="text-align: left; padding: 1rem; color: var(--gray-700); font-weight: 600;">
                                    Created</th>
                                <th style="text-align: left; padding: 1rem; color: var(--gray-700); font-weight: 600;">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin"
                                        style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                    <br>Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Question Management Tab -->
            <div class="admin-tab-content" id="questions-tab" style="display: none;">
                <div class="admin-section-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--gray-800);">Question Management</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="refreshQuestionStats()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Stats
                        </button>
                        <button class="btn btn-primary" onclick="clearAllQuestions()">
                            <i class="fas fa-trash"></i>
                            Clear All Questions
                        </button>
                    </div>
                </div>

                <div class="admin-stats"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--primary);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Total Questions</h3>
                            <div class="stat-number" id="totalQuestionsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--primary);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--success);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem;">
                            <i class="fas fa-atom"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Physics</h3>
                            <div class="stat-number" id="physicsQuestionsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--success);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--warning);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--warning); margin-bottom: 1rem;">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Chemistry</h3>
                            <div class="stat-number" id="chemistryQuestionsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--warning);">Loading...</div>
                        </div>
                    </div>

                    <div class="stat-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--info);">
                        <div class="stat-icon" style="font-size: 2rem; color: var(--info); margin-bottom: 1rem;">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-info">
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Mathematics</h3>
                            <div class="stat-number" id="mathQuestionsCount"
                                style="font-size: 2rem; font-weight: 700; color: var(--info);">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Analytics Tab -->
            <div class="admin-tab-content" id="analytics-tab" style="display: none;">
                <div class="admin-section-header">
                    <h2 style="color: var(--gray-800); margin-bottom: 2rem;">System Analytics</h2>
                </div>

                <div class="analytics-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div class="analytics-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);">
                        <h3 style="color: var(--gray-800); margin-bottom: 1rem;">User Activity</h3>
                        <div class="chart-placeholder"
                            style="text-align: center; padding: 3rem; background: var(--gray-50); border-radius: var(--radius-md); color: var(--gray-500);">
                            <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>User activity analytics coming soon</p>
                        </div>
                    </div>

                    <div class="analytics-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);">
                        <h3 style="color: var(--gray-800); margin-bottom: 1rem;">Test Performance</h3>
                        <div class="chart-placeholder"
                            style="text-align: center; padding: 3rem; background: var(--gray-50); border-radius: var(--radius-md); color: var(--gray-500);">
                            <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Performance analytics coming soon</p>
                        </div>
                    </div>

                    <div class="analytics-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);">
                        <h3 style="color: var(--gray-800); margin-bottom: 1rem;">Popular Subjects</h3>
                        <div class="chart-placeholder"
                            style="text-align: center; padding: 3rem; background: var(--gray-50); border-radius: var(--radius-md); color: var(--gray-500);">
                            <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Subject popularity analytics coming soon</p>
                        </div>
                    </div>

                    <div class="analytics-card"
                        style="background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);">
                        <h3 style="color: var(--gray-800); margin-bottom: 1rem;">System Usage</h3>
                        <div class="chart-placeholder"
                            style="text-align: center; padding: 3rem; background: var(--gray-50); border-radius: var(--radius-md); color: var(--gray-500);">
                            <i class="fas fa-chart-area" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>System usage analytics coming soon</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mock Test Creation Tab -->
            <div class="admin-tab-content" id="settings-tab" style="display: none;">
                <div class="admin-section-header">
                    <h2 style="color: var(--gray-800); margin-bottom: 1rem;">Create Mock Test for Everyone</h2>
                    <p style="color: var(--gray-600); font-size: 1rem;">Create standardized mock tests that will be available to all students</p>
                </div>

                <div class="mock-test-form" style="background: white; border-radius: var(--radius-xl); padding: 2rem; box-shadow: var(--shadow-lg); max-width: 900px; margin: 0 auto;">
                    
                    <!-- Test Basic Info -->
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle"></i>
                            Test Information
                        </h3>
                        
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="mockTestName2" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
                                Test Name <span style="color: var(--error);">*</span>
                            </label>
                            <input type="text" id="mockTestName2" class="form-input" placeholder="e.g., JEE Main Mock Test 2024" required>
                        </div>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="mockTestExam2" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
                                    Exam Type <span style="color: var(--error);">*</span>
                                </label>
                                <select id="mockTestExam2" class="form-input" required>
                                    <option value="">Select Exam</option>
                                    <option value="jee">JEE</option>
                                    <option value="neet">NEET</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="mockTestDuration2" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
                                    Duration (minutes) <span style="color: var(--error);">*</span>
                                </label>
                                <input type="number" id="mockTestDuration2" class="form-input" placeholder="180" min="30" max="300" required>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="mockTestDescription2" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
                                Description
                            </label>
                            <textarea id="mockTestDescription2" class="form-input" rows="3" placeholder="Brief description of the mock test..."></textarea>
                        </div>
                    </div>

                    <!-- Question Selection -->
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-list-check"></i>
                            Question Configuration
                        </h3>

                        <div class="subject-questions" id="mockSubjectQuestions2">
                            <!-- Physics -->
                            <div class="subject-config" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                                <h4 style="color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-atom" style="color: #3b82f6;"></i>
                                    Physics
                                </h4>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Easy Questions</label>
                                        <input type="number" id="physicsEasy2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Medium Questions</label>
                                        <input type="number" id="physicsMedium2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Hard Questions</label>
                                        <input type="number" id="physicsHard2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                </div>
                            </div>

                            <!-- Chemistry -->
                            <div class="subject-config" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                                <h4 style="color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-flask" style="color: #10b981;"></i>
                                    Chemistry
                                </h4>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Easy Questions</label>
                                        <input type="number" id="chemistryEasy2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Medium Questions</label>
                                        <input type="number" id="chemistryMedium2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Hard Questions</label>
                                        <input type="number" id="chemistryHard2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                </div>
                            </div>

                            <!-- Mathematics/Biology -->
                            <div class="subject-config" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                                <h4 style="color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-square-root-alt" style="color: #f59e0b;"></i>
                                    <span id="thirdSubjectLabel2">Mathematics</span>
                                </h4>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Easy Questions</label>
                                        <input type="number" id="thirdSubjectEasy2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Medium Questions</label>
                                        <input type="number" id="thirdSubjectMedium2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">Hard Questions</label>
                                        <input type="number" id="thirdSubjectHard2" class="form-input" placeholder="10" min="0" value="10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="total-questions" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: var(--radius-lg); text-align: center; margin-top: 1rem;">
                            <strong style="font-size: 1.1rem;">Total Questions: <span id="totalMockQuestions2">90</span></strong>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions" style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="createMockTest()" style="padding: 1rem 2rem; font-size: 1rem;">
                            <i class="fas fa-plus-circle"></i>
                            Create Mock Test
                        </button>
                        <button class="btn btn-secondary" onclick="resetMockTestForm()" style="padding: 1rem 2rem; font-size: 1rem;">
                            <i class="fas fa-redo"></i>
                            Reset Form
                        </button>
                    </div>
                </div>

                <!-- Existing Mock Tests List -->
                <div class="existing-mock-tests" style="margin-top: 3rem;">
                    <h3 style="color: var(--gray-800); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-clipboard-list"></i>
                        Existing Mock Tests
                    </h3>
                    <div id="mockTestsList" style="display: grid; gap: 1rem;">
                        <!-- Mock tests will be loaded here -->
                        <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No mock tests created yet. Create your first mock test above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="testModalTitle">Test</h2>
                <button class="close-modal" onclick="closeTestModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="timer" id="testTimer">00:00</div>

            <div id="testContent">
                <!-- Test questions will be loaded here -->
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                <button class="btn btn-secondary" id="prevQuestion" onclick="navigateQuestion(-1)">
                    <i class="fas fa-arrow-left"></i>
                    Previous
                </button>
                <button class="btn btn-primary" id="nextQuestion" onclick="navigateQuestion(1)">
                    Next
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn" id="submitTest" onclick="submitTest()"
                    style="background: var(--success); color: white; display: none;">
                    <i class="fas fa-check"></i>
                    Submit Test
                </button>
            </div>
        </div>
    </div>

    <!-- Create Test Modal -->
    <div class="modal" id="createTestModal">
        <div class="modal-content enhanced-modal-content create-test-modal">
            <div class="modal-header enhanced-modal-header">
                <div class="header-content">
                    <div>
                        <h2 class="modal-title">Create Custom Test</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Build your personalized test with custom
                            settings</p>
                    </div>
                </div>
                <button class="enhanced-close-btn" onclick="closeCreateTestModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="enhanced-modal-body">
                <!-- Test Details Section -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-info-circle"></i>
                        Test Details
                    </h3>
                    <div class="modern-form-group">
                        <label class="modern-form-label" for="testTitle">Test Title</label>
                        <input type="text" id="testTitle" class="modern-form-input"
                            placeholder="Enter a descriptive test title">
                    </div>
                </div>

                <!-- Academic Settings Section -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-graduation-cap"></i>
                        Academic Settings
                    </h3>
                    <div class="form-grid">
                        <div class="modern-form-group">
                            <label class="modern-form-label" for="testType">Exam Type</label>
                            <select id="testType" class="modern-form-input modern-form-select">
                                <option value="jee">JEE (Joint Entrance Examination)</option>
                                <option value="neet">NEET (National Eligibility cum Entrance Test)</option>
                            </select>
                        </div>

                        <div class="modern-form-group">
                            <label class="modern-form-label" for="testSubject">Subject</label>
                            <select id="testSubject" class="modern-form-input modern-form-select">
                                <option value="physics">Physics</option>
                                <option value="chemistry">Chemistry</option>
                                <option value="mathematics">Mathematics</option>
                                <option value="biology">Biology</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="modern-form-group">
                        <label class="modern-form-label" for="testClass">Class</label>
                        <select id="testClass" class="modern-form-input modern-form-select">
                            <option value="11">Class 11</option>
                            <option value="12">Class 12</option>
                        </select>
                    </div>

                    <div class="modern-form-group">
                        <label class="modern-form-label" for="testChapter">Chapter</label>
                        <select id="testChapter" class="modern-form-input modern-form-select">
                            <option value="Mixed">Mixed (All Chapters)</option>
                            <!-- Chapter options will be loaded dynamically from database -->
                            <option value="Some Basic Concepts of Chemistry">Some Basic Concepts of Chemistry</option>
                            <option value="Structure of Atom">Structure of Atom</option>
                        </select>
                    </div>
                </div>

                <!-- Test Configuration Section -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-cog"></i>
                        Test Configuration
                    </h3>

                    <div class="modern-form-group">
                        <label class="modern-form-label">Difficulty Level</label>
                        <div class="difficulty-options">
                            <label class="difficulty-option-modern">
                                <input type="radio" name="difficulty" value="easy">
                                <div class="difficulty-card">
                                    <div class="difficulty-title">Easy</div>
                                    <div class="difficulty-desc">Basic concepts</div>
                                </div>
                            </label>
                            <label class="difficulty-option-modern">
                                <input type="radio" name="difficulty" value="medium" checked>
                                <div class="difficulty-card">
                                    <div class="difficulty-title">Medium</div>
                                    <div class="difficulty-desc">Moderate level</div>
                                </div>
                            </label>
                            <label class="difficulty-option-modern">
                                <input type="radio" name="difficulty" value="hard">
                                <div class="difficulty-card">
                                    <div class="difficulty-title">Hard</div>
                                    <div class="difficulty-desc">Advanced level</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="modern-form-group">
                            <label class="modern-form-label" for="testDuration">Duration (minutes)</label>
                            <input type="number" id="testDuration" class="modern-form-input" value="30" min="5"
                                max="180">
                        </div>

                        <div class="modern-form-group">
                            <label class="modern-form-label" for="questionCount">Number of Questions</label>
                            <input type="number" id="questionCount" class="modern-form-input" value="10" min="5"
                                max="50">
                        </div>
                    </div>
                </div>

                <!-- Marking Scheme Section -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-calculator"></i>
                        Marking Scheme
                    </h3>

                    <div class="modern-form-group">
                        <label class="modern-form-label" for="negativeMarking">Marking Type</label>
                        <select id="negativeMarking" class="modern-form-input modern-form-select">
                            <option value="true">JEE/NEET Style (+4, -1)</option>
                            <option value="false">No Negative Marking (+1, 0)</option>
                        </select>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-info-circle"></i>
                            JEE/NEET Marking Scheme
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <i class="fas fa-check-circle correct"></i>
                                <span>Correct: <strong>+4 marks</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-times-circle wrong"></i>
                                <span>Wrong: <strong>-1 mark</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-circle unattempted"></i>
                                <span>Unattempted: <strong>0 marks</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="enhanced-modal-footer">
                <div class="footer-left">
                    <button type="button" class="modern-btn secondary" onclick="closeCreateTestModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
                <div class="footer-right">
                    <button type="button" class="modern-btn primary" onclick="generateCustomTest()">
                        <i class="fas fa-rocket"></i>
                        Create Test
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="generateCustomTest()">
                <i class="fas fa-cogs"></i>
                Generate Test
            </button>
        </div>
    </div>

    <!-- Question Preview Modal -->
    <div class="modal" id="questionPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; position: sticky; top: 0; z-index: 10;">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-eye"></i> Question Preview
                </h2>
                <button onclick="closeQuestionPreview()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="questionPreviewContent" style="padding: 2rem; background: white;">
                <!-- Question preview will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Question Selector Modal for Mock Tests -->
    <div class="modal" id="questionSelectorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-hand-pointer"></i>
                    Select Questions for Mock Test
                </h2>
                <button onclick="closeQuestionSelector()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; flex: 1; background: white;">
                <!-- Filters -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; background: var(--gray-50); padding: 1rem; border-radius: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Subject</label>
                        <select id="selectorSubject" class="form-input" onchange="updateChapterDropdown(); filterQuestionsForSelector();" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <option value="">All Subjects</option>
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="biology">Biology</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Difficulty</label>
                        <select id="selectorDifficulty" class="form-input" onchange="filterQuestionsForSelector()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <option value="">All Difficulties</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Chapter</label>
                        <select id="selectorChapter" class="form-input" onchange="filterQuestionsForSelector()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <option value="">All Chapters</option>
                            <!-- Chapters will be loaded dynamically -->
                        </select>
                    </div>
                </div>

                <!-- Questions List -->
                <div id="questionSelectorList" style="display: grid; gap: 1rem; background: white;">
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Loading questions...</p>
                    </div>
                </div>
            </div>

            <div style="padding: 1.5rem; border-top: 2px solid var(--gray-200); background: var(--gray-50); display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 16px 16px;">
                <div style="font-weight: 600; color: var(--gray-700);">
                    Selected: <span id="selectedCount" style="color: var(--primary); font-size: 1.2rem;">0</span> questions
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeQuestionSelector()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" onclick="confirmQuestionSelection()">
                        <i class="fas fa-check"></i> Confirm Selection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Preview Modal -->
    <div class="modal" id="questionPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-eye"></i>
                    Question Preview
                </h2>
                <button onclick="closeQuestionPreview()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="questionPreviewContent" style="padding: 2rem; background: white;">
                <!-- Question preview will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div class="modal" id="addQuestionModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Add New Question
                </h2>
                <button class="close-modal" onclick="closeAddQuestionModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addQuestionForm" onsubmit="return false;">
                    <!-- Question Type Selection -->
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <div class="question-type-selector">
                            <label class="radio-option">
                                <input type="radio" name="questionType" value="mcq" checked
                                    onchange="toggleQuestionType()">
                                <span class="radio-custom"></span>
                                Multiple Choice (MCQ)
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="questionType" value="numerical"
                                    onchange="toggleQuestionType()">
                                <span class="radio-custom"></span>
                                Numerical Answer
                            </label>
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="qExamType">Exam Type *</label>
                            <select id="qExamType" class="form-input form-select" required>
                                <option value="">Select Exam Type</option>
                                <option value="jee">JEE Main/Advanced</option>
                                <option value="neet">NEET</option>
                                <option value="boards">Board Exams</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="qSubject">Subject *</label>
                            <select id="qSubject" class="form-input form-select" required
                                onchange="updateChapterOptions()">
                                <option value="">Select Subject</option>
                                <option value="physics">Physics</option>
                                <option value="chemistry">Chemistry</option>
                                <option value="mathematics">Mathematics</option>
                                <option value="biology">Biology</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="qClass">Class *</label>
                            <select id="qClass" class="form-input form-select" required>
                                <option value="">Select Class</option>
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="qChapter">Chapter *</label>
                            <input type="text" id="qChapter" class="form-input" placeholder="Enter chapter name"
                                required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="qDifficulty">Difficulty Level *</label>
                            <select id="qDifficulty" class="form-input form-select" required>
                                <option value="">Select Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="qTopic">Topic (Optional)</label>
                            <input type="text" id="qTopic" class="form-input"
                                placeholder="Specific topic within chapter">
                        </div>
                    </div>

                    <!-- Question Text -->
                    <div class="form-group">
                        <label class="form-label" for="qText">Question Text *</label>
                        <div class="textarea-container">
                            <textarea id="qText" class="form-input" rows="4"
                                placeholder="Enter the question text. You can use LaTeX for mathematical expressions."
                                required></textarea>
                            <div class="textarea-tools latex-dropdown-container">
                                <button type="button" class="tool-btn" onclick="insertLatex('qText')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                                <button type="button" class="tool-btn" onclick="previewQuestion()" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <small class="form-hint">Use $ for inline math: $x^2$ or $$ for display math:
                            $$\frac{1}{2}$$</small>
                    </div>

                    <!-- MCQ Options -->
                    <div id="mcqOptions" class="form-group">
                        <label class="form-label">Answer Options *</label>
                        <div class="options-container">
                            <div class="option-row">
                                <span class="option-label">A)</span>
                                <input type="text" id="qOptionA" class="form-input option-input" placeholder="Option A"
                                    required>
                                <button type="button" class="tool-btn" onclick="insertLatex('qOptionA')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                            <div class="option-row">
                                <span class="option-label">B)</span>
                                <input type="text" id="qOptionB" class="form-input option-input" placeholder="Option B"
                                    required>
                                <button type="button" class="tool-btn" onclick="insertLatex('qOptionB')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                            <div class="option-row">
                                <span class="option-label">C)</span>
                                <input type="text" id="qOptionC" class="form-input option-input" placeholder="Option C"
                                    required>
                                <button type="button" class="tool-btn" onclick="insertLatex('qOptionC')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                            <div class="option-row">
                                <span class="option-label">D)</span>
                                <input type="text" id="qOptionD" class="form-input option-input" placeholder="Option D"
                                    required>
                                <button type="button" class="tool-btn" onclick="insertLatex('qOptionD')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Numerical Answer -->
                    <div id="numericalAnswer" class="form-group" style="display: none;">
                        <label class="form-label" for="qNumericalAnswer">Numerical Answer *</label>
                        <div class="form-row">
                            <input type="number" id="qNumericalAnswer" class="form-input"
                                placeholder="Enter numerical answer" step="any">
                            <select id="qNumericalUnit" class="form-input form-select" style="max-width: 200px;">
                                <option value="">No Unit</option>
                                <option value="m">meters (m)</option>
                                <option value="kg">kilograms (kg)</option>
                                <option value="s">seconds (s)</option>
                                <option value="A">amperes (A)</option>
                                <option value="K">kelvin (K)</option>
                                <option value="mol">moles (mol)</option>
                                <option value="cd">candela (cd)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Correct Answer Selection -->
                    <div id="correctAnswerMCQ" class="form-group">
                        <label class="form-label" for="qAnswer">Correct Answer *</label>
                        <select id="qAnswer" class="form-input form-select" required>
                            <option value="">Select Correct Answer</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>

                    <!-- Solution -->
                    <div class="form-group">
                        <label class="form-label" for="qSolution">Solution *</label>
                        <div class="textarea-container">
                            <textarea id="qSolution" class="form-input" rows="3"
                                placeholder="Enter step-by-step solution" required></textarea>
                            <div class="textarea-tools latex-dropdown-container">
                                <button type="button" class="tool-btn" onclick="insertLatex('qSolution')"
                                    title="Insert LaTeX">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-group">
                        <label class="form-label" for="qExplanation">Additional Explanation (Optional)</label>
                        <textarea id="qExplanation" class="form-input" rows="2"
                            placeholder="Any additional explanation or concept clarification"></textarea>
                    </div>

                    <!-- Tags -->
                    <div class="form-group">
                        <label class="form-label" for="qTags">Tags (Optional)</label>
                        <input type="text" id="qTags" class="form-input"
                            placeholder="Enter tags separated by commas (e.g., mechanics, kinematics, motion)">
                        <small class="form-hint">Tags help in organizing and searching questions</small>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddQuestionModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-info" onclick="previewQuestion()">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveQuestion()">
                            <i class="fas fa-save"></i>
                            Save Question
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New User</h2>
                <button class="close-modal" onclick="closeAddUserModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="uUsername">Username</label>
                        <input type="text" id="uUsername" class="form-input" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="uEmail">Email</label>
                        <input type="email" id="uEmail" class="form-input" placeholder="Enter email address" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="uPassword">Password</label>
                        <input type="password" id="uPassword" class="form-input" placeholder="Enter password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="uRole">Role</label>
                        <select id="uRole" class="form-select" required>
                            <option value="">Select Role</option>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="addUser()">
                    <i class="fas fa-user-plus"></i>
                    Add User
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Edit Question Modal with Preview -->
    <div class="modal" id="editQuestionModal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; max-height: 95vh; overflow: hidden;">
            <div class="modal-header" style="background: var(--gradient-primary); color: white; padding: 1.5rem 2rem;">
                <h2 class="modal-title" style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-edit"></i>
                    Edit Question
                </h2>
                <button class="close-modal" onclick="closeEditQuestionModal()" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">&times;</button>
            </div>

            <div class="modal-body" style="display: flex; height: calc(95vh - 140px); overflow: hidden;">
                <!-- Edit Form Section -->
                <div class="edit-form-section" style="flex: 1; padding: 2rem; overflow-y: auto; border-right: 1px solid var(--gray-200);">
                    <input type="hidden" id="editQuestionId">

                    <!-- Tab Navigation -->
                    <div class="edit-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="edit-tab active" onclick="showEditTab('basic')" data-tab="basic" style="padding: 0.75rem 1.5rem; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.3s ease;">
                            <i class="fas fa-info-circle"></i> Basic Info
                        </button>
                        <button class="edit-tab" onclick="showEditTab('content')" data-tab="content" style="padding: 0.75rem 1.5rem; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.3s ease;">
                            <i class="fas fa-question-circle"></i> Content
                        </button>
                        <button class="edit-tab" onclick="showEditTab('solution')" data-tab="solution" style="padding: 0.75rem 1.5rem; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.3s ease;">
                            <i class="fas fa-lightbulb"></i> Solution
                        </button>
                    </div>

                    <!-- Basic Info Tab -->
                    <div class="edit-tab-content active" id="edit-basic-tab">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label" for="editQExamType" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    <i class="fas fa-graduation-cap"></i> Exam Type
                                </label>
                                <select id="editQExamType" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;">
                                    <option value="jee">JEE</option>
                                    <option value="neet">NEET</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editQSubject" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    <i class="fas fa-book"></i> Subject
                                </label>
                                <select id="editQSubject" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" onchange="updateEditChapterOptions(); updatePreview(); saveDraft();">
                                    <option value="physics">Physics</option>
                                    <option value="chemistry">Chemistry</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="biology">Biology</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label" for="editQClass" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    <i class="fas fa-layer-group"></i> Class
                                </label>
                                <select id="editQClass" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" onchange="updatePreview(); saveDraft();">
                                    <option value="11">Class 11</option>
                                    <option value="12">Class 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editQDifficulty" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    <i class="fas fa-signal"></i> Difficulty
                                </label>
                                <select id="editQDifficulty" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" onchange="updatePreview(); saveDraft();">
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="editQChapter" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-bookmark"></i> Chapter
                            </label>
                            <select id="editQChapter" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" onchange="updatePreview(); saveDraft();">
                                <option value="">Select Chapter</option>
                            </select>
                            <small style="color: var(--gray-500); margin-top: 0.5rem; display: block;">
                                <i class="fas fa-info-circle"></i> Select a subject first to load chapters
                            </small>
                        </div>
                    </div>

                    <!-- Content Tab -->
                    <div class="edit-tab-content" id="edit-content-tab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="editQText" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-question-circle"></i> Question Text
                            </label>
                            <div style="position: relative;">
                                <textarea id="editQText" class="form-input" rows="4" placeholder="Enter the question text (LaTeX supported: use $ for inline math, $$ for display math)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();"></textarea>
                                <button type="button" onclick="addImageToQuestion('editQText')" style="position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    <i class="fas fa-image"></i> Add Image
                                </button>
                            </div>
                            <small style="color: var(--gray-500); margin-top: 0.5rem; display: block;">
                                <i class="fas fa-info-circle"></i> Use LaTeX for math: $x^2 + y^2 = z^2$ or $$\int_0^\infty e^{-x} dx = 1$$
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-list"></i> Options
                            </label>
                            <div class="options-container">
                                <div style="position: relative; margin-bottom: 0.75rem;">
                                    <label style="font-weight: 500; color: var(--gray-600); margin-bottom: 0.25rem; display: block;">Option A</label>
                                    <input type="text" id="editQOptionA" class="form-input" placeholder="Option A (LaTeX supported)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();">
                                    <button type="button" onclick="addImageToOption('editQOptionA')" style="position: absolute; top: 32px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>
                                <div style="position: relative; margin-bottom: 0.75rem;">
                                    <label style="font-weight: 500; color: var(--gray-600); margin-bottom: 0.25rem; display: block;">Option B</label>
                                    <input type="text" id="editQOptionB" class="form-input" placeholder="Option B (LaTeX supported)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();">
                                    <button type="button" onclick="addImageToOption('editQOptionB')" style="position: absolute; top: 32px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>
                                <div style="position: relative; margin-bottom: 0.75rem;">
                                    <label style="font-weight: 500; color: var(--gray-600); margin-bottom: 0.25rem; display: block;">Option C</label>
                                    <input type="text" id="editQOptionC" class="form-input" placeholder="Option C (LaTeX supported)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();">
                                    <button type="button" onclick="addImageToOption('editQOptionC')" style="position: absolute; top: 32px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>
                                <div style="position: relative; margin-bottom: 0.75rem;">
                                    <label style="font-weight: 500; color: var(--gray-600); margin-bottom: 0.25rem; display: block;">Option D</label>
                                    <input type="text" id="editQOptionD" class="form-input" placeholder="Option D (LaTeX supported)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();">
                                    <button type="button" onclick="addImageToOption('editQOptionD')" style="position: absolute; top: 32px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="editQAnswer" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-check-circle"></i> Correct Answer
                            </label>
                            <select id="editQAnswer" class="form-select" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" onchange="updatePreview(); saveDraft();">
                                <option value="">Select correct answer</option>
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                    </div>

                    <!-- Solution Tab -->
                    <div class="edit-tab-content" id="edit-solution-tab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="editQSolution" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-lightbulb"></i> Solution
                            </label>
                            <div style="position: relative;">
                                <textarea id="editQSolution" class="form-input" rows="6" placeholder="Enter the detailed solution (LaTeX supported)" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; font-family: 'JetBrains Mono', monospace;" oninput="debouncedUpdatePreview(); saveDraft();"></textarea>
                                <button type="button" onclick="addImageToSolution('editQSolution')" style="position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    <i class="fas fa-image"></i> Add Image
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="editQExplanation" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <i class="fas fa-comment"></i> Additional Explanation (Optional)
                            </label>
                            <textarea id="editQExplanation" class="form-input" rows="3" placeholder="Any additional explanation or notes" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem;" oninput="debouncedUpdatePreview(); saveDraft();"></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-200);">
                        <button class="btn btn-secondary" onclick="closeEditQuestionModal()" style="flex: 1; padding: 0.75rem; border: 2px solid var(--gray-300); background: white; color: var(--gray-700); border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="updateQuestion()" style="flex: 2; padding: 0.75rem; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-save"></i> Update Question
                        </button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section" style="flex: 1; padding: 2rem; background: var(--gray-50); overflow-y: auto;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                        <i class="fas fa-eye" style="color: var(--primary); font-size: 1.2rem;"></i>
                        <h3 style="margin: 0; color: var(--gray-800); font-size: 1.25rem; font-weight: 700;">Live Preview</h3>
                        <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                            <button onclick="refreshPreview()" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;" title="Refresh Preview">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="questionPreview" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--gray-200);">
                        <!-- Preview content will be generated here -->
                        <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            <i class="fas fa-eye" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>Question preview will appear here as you edit</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Question Modal -->
    <div class="modal" id="viewQuestionModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">View Question</h2>
                <button class="close-modal" onclick="closeViewQuestionModal()">&times;</button>
            </div>

            <div class="modal-body" id="viewQuestionContent">
                <!-- Question content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Enhanced Question Modal -->
    <div class="modal" id="enhancedQuestionModal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-magic"></i>
                    Create Enhanced Question
                </h2>
                <button class="close-modal" onclick="closeEnhancedQuestionModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="enhanced-question-tabs"
                    style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--gray-200);">
                    <button class="enhanced-tab active" onclick="showEnhancedTab('basic')" data-tab="basic">
                        <i class="fas fa-info-circle"></i>
                        Basic Info
                    </button>
                    <button class="enhanced-tab" onclick="showEnhancedTab('question')" data-tab="question">
                        <i class="fas fa-question-circle"></i>
                        Question Content
                    </button>


                    <button class="enhanced-tab" onclick="showEnhancedTab('solution')" data-tab="solution">
                        <i class="fas fa-lightbulb"></i>
                        Solution & Explanation
                    </button>
                </div>

                <!-- Basic Info Tab -->
                <div class="enhanced-tab-content active" id="enhanced-basic-tab">
                    <div class="question-info-header">
                        <div class="header-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="header-content">
                            <h3 class="section-title">Question Information</h3>
                            <p class="section-subtitle">Configure the basic details for your question</p>
                        </div>
                    </div>

                    <div class="enhanced-form-grid">
                        <div class="enhanced-form-group">
                            <label class="enhanced-form-label" for="enhancedSubject">
                                <i class="fas fa-book label-icon"></i>
                                Subject
                            </label>
                            <div class="select-wrapper">
                                <select id="enhancedSubject" class="enhanced-form-select" required>
                                    <option value="">Choose subject</option>
                                    <option value="physics">Physics</option>
                                    <option value="chemistry">Chemistry</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="biology">Biology</option>
                                </select>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                        </div>

                        <div class="enhanced-form-group">
                            <label class="enhanced-form-label" for="enhancedDifficulty">
                                <i class="fas fa-signal label-icon"></i>
                                Difficulty Level
                            </label>
                            <div class="select-wrapper">
                                <select id="enhancedDifficulty" class="enhanced-form-select" required>
                                    <option value="">Choose difficulty</option>
                                    <option value="easy">Easy (Foundation Level)</option>
                                    <option value="medium">Medium (Intermediate Level)</option>
                                    <option value="hard">Hard (Advanced Level)</option>
                                </select>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                        </div>

                        <div class="enhanced-form-group">
                            <label class="enhanced-form-label" for="enhancedLanguage">
                                <i class="fas fa-language label-icon"></i>
                                Question Language
                            </label>
                            <div class="select-wrapper">
                                <select id="enhancedLanguage" class="enhanced-form-select" required>
                                    <option value="en">English</option>
                                    <option value="gu" class="lang-gu">àª—à«àªœàª°àª¾àª¤à«€ (Gujarati)</option>
                                </select>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                            <small style="color: var(--gray-500); font-size: 0.8rem; margin-top: 0.5rem; display: block;">
                                Select the language in which this question is written
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedChapter">
                            <i class="fas fa-book-open label-icon"></i>
                            Chapter/Topic
                        </label>
                        <div class="chapter-selector-container">
                            <div class="chapter-dropdown" id="enhancedChapterDropdown">
                                <div class="chapter-selected" onclick="toggleChapterDropdown()">
                                    <div class="chapter-selected-content">
                                        <i class="fas fa-book chapter-icon"></i>
                                        <span class="chapter-text">Select a chapter</span>
                                    </div>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                <div class="chapter-options" id="chapterOptions">
                                    <div class="chapter-search">
                                        <input type="text" placeholder="Search chapters..." id="chapterSearch"
                                            onkeyup="filterChapters()">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div class="chapter-list" id="chapterList">
                                        <!-- Chapters will be populated here -->
                                    </div>
                                    <div class="chapter-actions">
                                        <button type="button" class="add-chapter-btn" onclick="showAddChapterModal()">
                                            <i class="fas fa-plus"></i>
                                            Add New Chapter
                                        </button>
                                        <button type="button" class="add-chapter-btn" onclick="clearAllChapters()"
                                            style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 0.5rem;">
                                            <i class="fas fa-trash-alt"></i>
                                            Clear All Chapters
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="enhancedChapter" name="enhancedChapter" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedTags">Tags (Optional)</label>
                        <input type="text" id="enhancedTags" class="form-input"
                            placeholder="Enter tags separated by commas (e.g., mechanics, forces, newton's laws)">
                        <small style="color: var(--gray-500); font-size: 0.8rem;">Tags help in better categorization and
                            searching</small>
                    </div>
                </div>

                <!-- Question Content Tab -->
                <div class="enhanced-tab-content" id="enhanced-question-tab">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">
                        <i class="fas fa-question-circle"></i>
                        Question Content
                    </h3>

                    <!-- Question Type Selection -->
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <div class="question-type-buttons" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <button type="button" id="mcqTypeBtn" class="question-type-btn active"
                                onclick="setQuestionType('mcq')"
                                style="flex: 1; padding: 1rem; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: var(--radius-lg); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-list-ul"></i>
                                Multiple Choice (MCQ)
                            </button>
                            <button type="button" id="numericalTypeBtn" class="question-type-btn"
                                onclick="setQuestionType('numerical')"
                                style="flex: 1; padding: 1rem; border: 2px solid var(--gray-300); background: white; color: var(--gray-700); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-calculator"></i>
                                Numerical Answer
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedQuestionText">Question Statement</label>
                        <div class="enhanced-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('enhancedQuestionText', 'bold')"
                                    class="editor-btn" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" onclick="formatText('enhancedQuestionText', 'italic')"
                                    class="editor-btn" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" onclick="formatText('enhancedQuestionText', 'underline')"
                                    class="editor-btn" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <div class="editor-separator"></div>
                                <button type="button" onclick="alignText('enhancedQuestionText', 'left')"
                                    class="editor-btn" title="Align Left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button type="button" onclick="alignText('enhancedQuestionText', 'center')"
                                    class="editor-btn" title="Align Center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button type="button" onclick="alignText('enhancedQuestionText', 'right')"
                                    class="editor-btn" title="Align Right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <div class="editor-separator"></div>
                                <button type="button" onclick="insertNewLine('enhancedQuestionText')" class="editor-btn"
                                    title="Insert New Line">
                                    <i class="fas fa-level-down-alt"></i>
                                </button>
                                <button type="button" onclick="addImageToEnhanced('enhancedQuestionText')"
                                    class="editor-btn" title="Insert Image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" onclick="showLatexModal('enhancedQuestionText')"
                                    class="editor-btn latex-btn" title="Insert LaTeX Math">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>

                            </div>
                            <textarea id="enhancedQuestionText" class="form-input enhanced-textarea" rows="6"
                                placeholder="Enter the complete question statement. Use LaTeX for mathematical expressions: $x^2 + y^2 = r^2$"
                                required></textarea>
                        </div>
                    </div>

                    <!-- MCQ Options Container -->
                    <div id="mcqOptionsContainer" class="form-group">
                        <label class="form-label">Answer Options</label>
                        <div class="enhanced-options-container">
                            <div class="enhanced-option-item">
                                <div class="option-header">
                                    <span class="option-label">Option A</span>
                                    <div class="option-controls">
                                        <button type="button" onclick="formatText('enhancedOptionA', 'bold')"
                                            class="editor-btn-sm" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" onclick="formatText('enhancedOptionA', 'italic')"
                                            class="editor-btn-sm" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" onclick="insertNewLine('enhancedOptionA')"
                                            class="editor-btn-sm" title="Insert New Line">
                                            <i class="fas fa-level-down-alt"></i>
                                        </button>
                                        <button type="button" onclick="showLatexModal('enhancedOptionA')"
                                            class="editor-btn-sm latex-btn-sm" title="Insert LaTeX">
                                            <i class="fas fa-square-root-alt"></i>
                                        </button>
                                        <button type="button" onclick="addImageToEnhanced('enhancedOptionA')"
                                            class="editor-btn-sm">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="enhancedOptionA" class="form-input" rows="2" placeholder="Enter option A"
                                    required></textarea>
                            </div>

                            <div class="enhanced-option-item">
                                <div class="option-header">
                                    <span class="option-label">Option B</span>
                                    <div class="option-controls">
                                        <button type="button" onclick="formatText('enhancedOptionB', 'bold')"
                                            class="editor-btn-sm" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" onclick="formatText('enhancedOptionB', 'italic')"
                                            class="editor-btn-sm" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" onclick="insertNewLine('enhancedOptionB')"
                                            class="editor-btn-sm" title="Insert New Line">
                                            <i class="fas fa-level-down-alt"></i>
                                        </button>
                                        <button type="button" onclick="showLatexModal('enhancedOptionB')"
                                            class="editor-btn-sm latex-btn-sm" title="Insert LaTeX">
                                            <i class="fas fa-square-root-alt"></i>
                                        </button>
                                        <button type="button" onclick="addImageToEnhanced('enhancedOptionB')"
                                            class="editor-btn-sm">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="enhancedOptionB" class="form-input" rows="2" placeholder="Enter option B"
                                    required></textarea>
                            </div>

                            <div class="enhanced-option-item">
                                <div class="option-header">
                                    <span class="option-label">Option C</span>
                                    <div class="option-controls">
                                        <button type="button" onclick="formatText('enhancedOptionC', 'bold')"
                                            class="editor-btn-sm" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" onclick="formatText('enhancedOptionC', 'italic')"
                                            class="editor-btn-sm" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" onclick="insertNewLine('enhancedOptionC')"
                                            class="editor-btn-sm" title="Insert New Line">
                                            <i class="fas fa-level-down-alt"></i>
                                        </button>
                                        <button type="button" onclick="showLatexModal('enhancedOptionC')"
                                            class="editor-btn-sm latex-btn-sm" title="Insert LaTeX">
                                            <i class="fas fa-square-root-alt"></i>
                                        </button>
                                        <button type="button" onclick="addImageToEnhanced('enhancedOptionC')"
                                            class="editor-btn-sm">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="enhancedOptionC" class="form-input" rows="2" placeholder="Enter option C"
                                    required></textarea>
                            </div>

                            <div class="enhanced-option-item">
                                <div class="option-header">
                                    <span class="option-label">Option D</span>
                                    <div class="option-controls">
                                        <button type="button" onclick="formatText('enhancedOptionD', 'bold')"
                                            class="editor-btn-sm" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" onclick="formatText('enhancedOptionD', 'italic')"
                                            class="editor-btn-sm" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" onclick="insertNewLine('enhancedOptionD')"
                                            class="editor-btn-sm" title="Insert New Line">
                                            <i class="fas fa-level-down-alt"></i>
                                        </button>
                                        <button type="button" onclick="showLatexModal('enhancedOptionD')"
                                            class="editor-btn-sm latex-btn-sm" title="Insert LaTeX">
                                            <i class="fas fa-square-root-alt"></i>
                                        </button>
                                        <button type="button" onclick="addImageToEnhanced('enhancedOptionD')"
                                            class="editor-btn-sm">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="enhancedOptionD" class="form-input" rows="2" placeholder="Enter option D"
                                    required></textarea>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label class="form-label" for="enhancedCorrectAnswer">Correct Answer</label>
                            <select id="enhancedCorrectAnswer" class="form-input" required>
                                <option value="">Select correct answer</option>
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                    </div>

                    <!-- Numerical Answer Container -->
                    <div id="numericalAnswerContainer" class="form-group" style="display: none;">
                        <label class="form-label" for="enhancedNumericalAnswer">Numerical Answer</label>
                        <div class="enhanced-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="insertMathSymbol('enhancedNumericalAnswer', 'âˆš')"
                                    class="editor-btn" title="Square Root">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                                <button type="button" onclick="insertMathSymbol('enhancedNumericalAnswer', 'âˆ›')"
                                    class="editor-btn" title="Cube Root">
                                    âˆ›
                                </button>
                                <button type="button" onclick="insertMathSymbol('enhancedNumericalAnswer', 'Ï€')"
                                    class="editor-btn" title="Pi">
                                    Ï€
                                </button>
                                <button type="button" onclick="insertMathSymbol('enhancedNumericalAnswer', 'Ã—10^')"
                                    class="editor-btn" title="Scientific Notation">
                                    Ã—10^
                                </button>
                                <button type="button" onclick="insertMathSymbol('enhancedNumericalAnswer', 'Â±')"
                                    class="editor-btn" title="Plus Minus">
                                    Â±
                                </button>
                                <div class="editor-separator"></div>
                                <button type="button" onclick="insertNewLine('enhancedNumericalAnswer')"
                                    class="editor-btn" title="Insert New Line">
                                    <i class="fas fa-level-down-alt"></i>
                                </button>
                                <button type="button" onclick="showLatexModal('enhancedNumericalAnswer')"
                                    class="editor-btn latex-btn" title="Insert LaTeX Math">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </div>
                            <textarea id="enhancedNumericalAnswer" class="form-input enhanced-textarea" rows="3"
                                placeholder="Enter the numerical answer (e.g., 3.14, 42, 2.5Ã—10^8, âˆš2, Ï€/4)"></textarea>
                        </div>
                        <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                            Enter the exact numerical value. You can use mathematical symbols, scientific notation, or
                            LaTeX for complex expressions.
                        </small>

                        <!-- Answer Format Examples -->
                        <div class="answer-examples"
                            style="margin-top: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
                            <div
                                style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-lightbulb"></i> Answer Format Examples:
                            </div>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.85rem; color: var(--gray-600);">
                                <div><strong>Simple:</strong> 42, 3.14, -5.2</div>
                                <div><strong>Scientific:</strong> 2.5Ã—10^8, 1.6Ã—10^-19</div>
                                <div><strong>Fractions:</strong> 1/2, 3/4, 22/7</div>
                                <div><strong>Roots:</strong> âˆš2, âˆ›8, âˆš(25)</div>
                                <div><strong>With Ï€:</strong> Ï€, 2Ï€, Ï€/4</div>
                                <div><strong>Range:</strong> 9.8 Â± 0.1</div>
                            </div>
                        </div>
                    </div>


                </div>







                <!-- Solution & Explanation Tab -->
                <div class="enhanced-tab-content" id="enhanced-solution-tab">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">
                        <i class="fas fa-lightbulb"></i>
                        Solution & Explanation
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="enhancedSolution">Detailed Solution</label>
                        <div class="enhanced-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('enhancedSolution', 'bold')"
                                    class="editor-btn" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" onclick="formatText('enhancedSolution', 'italic')"
                                    class="editor-btn" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" onclick="formatText('enhancedSolution', 'underline')"
                                    class="editor-btn" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <div class="editor-separator"></div>
                                <button type="button" onclick="alignText('enhancedSolution', 'left')" class="editor-btn"
                                    title="Align Left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button type="button" onclick="alignText('enhancedSolution', 'center')"
                                    class="editor-btn" title="Align Center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button type="button" onclick="alignText('enhancedSolution', 'right')"
                                    class="editor-btn" title="Align Right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <div class="editor-separator"></div>
                                <button type="button" onclick="insertNewLine('enhancedSolution')" class="editor-btn"
                                    title="Insert New Line">
                                    <i class="fas fa-level-down-alt"></i>
                                </button>
                                <button type="button" onclick="addImageToEnhanced('enhancedSolution')"
                                    class="editor-btn" title="Insert Image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" onclick="showLatexModal('enhancedSolution')"
                                    class="editor-btn latex-btn" title="Insert LaTeX Math">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                                <button type="button" onclick="insertStep('enhancedSolution')" class="editor-btn"
                                    title="Insert Step Template">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                            </div>
                            <textarea id="enhancedSolution" class="form-input enhanced-textarea" rows="8"
                                placeholder="Provide a detailed step-by-step solution. Use LaTeX for math: $F = ma$"
                                required></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedExplanation">Additional Explanation</label>
                        <textarea id="enhancedExplanation" class="form-input" rows="4"
                            placeholder="Add any additional explanations, concepts, or tips (optional)"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedHints">Hints (Optional)</label>
                        <textarea id="enhancedHints" class="form-input" rows="3"
                            placeholder="Provide hints that can help students solve the problem"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enhancedReferences">References (Optional)</label>
                        <input type="text" id="enhancedReferences" class="form-input"
                            placeholder="NCERT Chapter 5, HC Verma Part 1, etc.">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions"
                    style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--gray-200); display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeEnhancedQuestionModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-info" onclick="previewEnhancedQuestion()">
                        <i class="fas fa-eye"></i>
                        Preview
                    </button>
                    <button class="btn btn-success" onclick="saveEnhancedQuestion()">
                        <i class="fas fa-save"></i>
                        Save Enhanced Question
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Question Preview Modal -->
    <div class="modal" id="enhancedQuestionPreviewModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-eye"></i>
                    Question Preview
                </h2>
                <button class="close-modal" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body" id="previewModalBody">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePreviewModal()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
                <button class="btn btn-primary" onclick="editFromPreview()">
                    <i class="fas fa-edit"></i>
                    Edit Question
                </button>
            </div>
        </div>
    </div>

    <!-- LaTeX Input Modal -->
    <div class="latex-modal" id="latexModal" style="display: none;">
        <div class="latex-modal-content">
            <div class="latex-modal-header">
                <h3>
                    <i class="fas fa-square-root-alt"></i>
                    Enter LaTeX Math Expression
                </h3>
                <button class="close-modal" onclick="closeLatexModal()">&times;</button>
            </div>

            <div class="latex-modal-body">
                <p>Enter LaTeX math expression (e.g., x^2 + y^2 = r^2):</p>

                <div class="latex-input-container">
                    <textarea id="latexInput" class="latex-input" placeholder="Enter LaTeX expression..."
                        rows="3"></textarea>
                </div>

                <div class="latex-preview-container">
                    <label>Preview:</label>
                    <div id="latexPreview" class="latex-preview-area">
                        Enter LaTeX above to see preview
                    </div>
                </div>

                <div class="latex-quick-buttons">
                    <h4>Quick Insert:</h4>
                    <div class="latex-quick-grid">
                        <button onclick="insertQuickLatex('x^2')" class="latex-quick-btn">xÂ²</button>
                        <button onclick="insertQuickLatex('x_1')" class="latex-quick-btn">xâ‚</button>
                        <button onclick="insertQuickLatex('\\frac{a}{b}')" class="latex-quick-btn">a/b</button>
                        <button onclick="insertQuickLatex('\\sqrt{x}')" class="latex-quick-btn">âˆšx</button>
                        <button onclick="insertQuickLatex('\\int')" class="latex-quick-btn">âˆ«</button>
                        <button onclick="insertQuickLatex('\\sum')" class="latex-quick-btn">Î£</button>
                        <button onclick="insertQuickLatex('\\alpha')" class="latex-quick-btn">Î±</button>
                        <button onclick="insertQuickLatex('\\beta')" class="latex-quick-btn">Î²</button>
                        <button onclick="insertQuickLatex('\\gamma')" class="latex-quick-btn">Î³</button>
                        <button onclick="insertQuickLatex('\\pi')" class="latex-quick-btn">Ï€</button>
                        <button onclick="insertQuickLatex('\\theta')" class="latex-quick-btn">Î¸</button>
                        <button onclick="insertQuickLatex('\\lambda')" class="latex-quick-btn">Î»</button>
                        <button onclick="testLatexPreview()" class="latex-quick-btn"
                            style="background: #10b981; color: white;">Test</button>
                    </div>
                </div>
            </div>

            <div class="latex-modal-footer">
                <button class="btn btn-secondary" onclick="closeLatexModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="insertLatexFromModal()">
                    <i class="fas fa-check"></i>
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Add Chapter Modal -->
    <div class="add-chapter-modal" id="addChapterModal" style="display: none;">
        <div class="add-chapter-modal-content">
            <h3>
                <i class="fas fa-book"></i>
                Add New Chapter
            </h3>

            <div class="form-group">
                <label class="form-label" for="newChapterName">Chapter Name</label>
                <input type="text" id="newChapterName" class="form-input" placeholder="Enter chapter name" required>
            </div>



            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeAddChapterModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-success" onclick="addNewChapter()">
                    <i class="fas fa-plus"></i>
                    Add Chapter
                </button>
            </div>
        </div>
    </div>

    <!-- Image Manager Modal -->
    <div class="modal" id="imageManagerModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-images"></i>
                    Question Image Manager
                </h2>
                <button class="close-modal" onclick="closeImageManagerModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 2rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Admin Tool:</strong> Manage images, graphs, and tables for questions that require visual
                    elements.
                </div>

                <!-- Filter Questions -->
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label class="form-label">Filter Questions</label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <select id="imageFilterSubject" class="form-input" style="flex: 1; min-width: 150px;">
                            <option value="all">All Subjects</option>
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="mathematics">Mathematics</option>
                        </select>
                        <select id="imageFilterType" class="form-input" style="flex: 1; min-width: 150px;">
                            <option value="all">All Types</option>
                            <option value="needsImage">Needs Image</option>
                            <option value="needsTable">Needs Table</option>
                            <option value="hasImage">Has Image</option>
                        </select>
                        <button class="btn btn-primary" onclick="filterQuestionsForImages()">
                            <i class="fas fa-filter"></i>
                            Filter
                        </button>
                    </div>
                </div>

                <!-- Questions List -->
                <div id="questionsForImagesList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Questions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Question Image Upload Modal -->
    <div class="modal" id="questionImageModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-upload"></i>
                    Upload Question Image
                </h2>
                <button class="close-modal" onclick="closeQuestionImageModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div id="selectedQuestionInfo"
                    style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                    <!-- Selected question info will be shown here -->
                </div>

                <!-- Image Upload -->
                <div class="form-group">
                    <label class="form-label">Upload Image/Graph</label>
                    <div class="upload-area"
                        style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer;"
                        onclick="document.getElementById('questionImageFile').click()">
                        <i class="fas fa-cloud-upload-alt"
                            style="font-size: 2rem; color: #6b7280; margin-bottom: 1rem;"></i>
                        <p style="margin: 0; color: #6b7280;">Click to upload image or drag and drop</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #9ca3af;">Supports: JPG, PNG, SVG,
                            WebP (Max 5MB)</p>
                    </div>
                    <input type="file" id="questionImageFile" accept="image/*" style="display: none;"
                        onchange="handleImageUpload(event)">
                </div>

                <!-- Image Preview -->
                <div id="imagePreview" style="display: none; margin-top: 1rem;">
                    <label class="form-label">Preview</label>
                    <div style="border: 1px solid #d1d5db; border-radius: 8px; padding: 1rem; text-align: center;">
                        <img id="previewImage" style="max-width: 100%; max-height: 300px; border-radius: 4px;">
                    </div>
                </div>

                <!-- Table Creator -->
                <div class="form-group" style="margin-top: 2rem;">
                    <label class="form-label">Or Create Table</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="number" id="tableRows" placeholder="Rows" min="2" max="10" value="3"
                            style="width: 100px;">
                        <input type="number" id="tableCols" placeholder="Columns" min="2" max="6" value="3"
                            style="width: 100px;">
                        <button class="btn btn-secondary" onclick="createTable()">
                            <i class="fas fa-table"></i>
                            Create Table
                        </button>
                    </div>
                    <div id="tableContainer" style="display: none;">
                        <!-- Dynamic table will be created here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeQuestionImageModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveQuestionImage()">
                        <i class="fas fa-save"></i>
                        Save Image/Table
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" class="scroll-to-top-btn" onclick="scrollToTop()" title="Scroll to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- Admin Password Modal -->
    <div class="modal" id="adminPasswordModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-shield-alt"></i>
                    Admin Access
                </h2>
                <button class="close-modal" onclick="closeAdminPasswordModal()">&times;</button>
            </div>

            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                    The admin panel is password-protected. Enter the admin password to access all administrative
                    features:
                </p>

                <div class="form-group">
                    <label for="adminPassword" class="form-label">Admin Password</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password"
                        onkeypress="handleAdminPasswordKeypress(event)">
                </div>

                <div id="adminPasswordError"
                    style="display: none; color: var(--error); margin-top: 0.5rem; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Incorrect password. Please try again.
                </div>

                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="verifyAdminPassword()">
                        <i class="fas fa-unlock"></i>
                        Access Admin Panel
                    </button>
                    <button class="btn btn-secondary" onclick="closeAdminPasswordModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentTest = null;
        let currentQuestionIndex = 0;

        // Initialize data arrays immediately to prevent initialization errors
        let allQuestionsData = []; // For admin panel filtering
        let realQuestionsData = []; // For question bank display
        let isLoadingRealQuestions = false; // Flag to prevent multiple simultaneous loads

        // Initialize chapters data structure
        let chaptersData = {
            jee: {
                physics: [],
                chemistry: [],
                mathematics: []
            },
            neet: {
                physics: [],
                chemistry: [],
                biology: []
            }
        };
        let userAnswers = {};
        let testStartTime = null;
        let timerInterval = null;
        let currentRole = 'student';

        // AI Chat variables
        let selectedProvider = 'auto';

        // ========================================
        // MOBILE MENU FUNCTIONALITY
        // ========================================
        (function() {
            'use strict';
            
            // Wait for DOM to load
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ðŸ“± Initializing mobile menu...');
                
                // Check if we're on mobile
                if (window.innerWidth > 640) {
                    console.log('Desktop view - mobile menu not needed');
                    return;
                }
                
                // Create mobile menu elements
                createMobileMenu();
                
                // Re-create on resize
                window.addEventListener('resize', function() {
                    if (window.innerWidth <= 640) {
                        if (!document.querySelector('.mobile-menu-btn')) {
                            createMobileMenu();
                        }
                    }
                });
            });
            
            function createMobileMenu() {
                const header = document.querySelector('.header');
                if (!header) {
                    console.log('Header not found, retrying...');
                    setTimeout(createMobileMenu, 500);
                    return;
                }
                
                // Check if already initialized
                const existingOverlay = document.querySelector('.mobile-overlay');
                if (existingOverlay) {
                    return;
                }
                
                console.log('âœ… Creating mobile menu...');
                
                // Get existing hamburger button
                const hamburger = document.querySelector('.mobile-menu-btn');
                if (!hamburger) {
                    console.log('Hamburger button not found');
                    return;
                }
                
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'mobile-overlay';
                
                // Create sidebar
                const sidebar = document.createElement('div');
                sidebar.className = 'mobile-sidebar';
                
                // Get user info
                const userInfo = document.querySelector('.user-info');
                const username = userInfo ? userInfo.textContent.trim() : 'User';
                const userAvatar = userInfo ? userInfo.querySelector('.user-avatar')?.textContent : 'U';
                
                // Build sidebar content
                sidebar.innerHTML = `
                    <div class="sidebar-user-info">
                        <div class="user-avatar">${userAvatar}</div>
                        <div class="sidebar-user-details">
                            <h3>${username}</h3>
                            <p>Student Account</p>
                        </div>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="dashboardSection">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="ultraAiGuidanceSection">
                        <i class="fas fa-robot"></i>
                        <span>AI Guidance</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="createTestSection">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create Test</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="questionBankSection">
                        <i class="fas fa-book"></i>
                        <span>Question Bank</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="documentsSection">
                        <i class="fas fa-file-alt"></i>
                        <span>Documents</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="performanceSection">
                        <i class="fas fa-chart-line"></i>
                        <span>Performance</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="myPapersSection">
                        <i class="fas fa-folder-open"></i>
                        <span>My Papers</span>
                    </div>
                    
                    <div class="sidebar-nav-item" data-section="adminPanel" id="adminNavBtnMobile" style="display: none;">
                        <i class="fas fa-shield-alt"></i>
                        <span>Admin Panel</span>
                    </div>
                    
                    <button class="sidebar-logout" id="logoutBtnMobile">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                `;
                
                // Add overlay and sidebar to page (hamburger already exists in HTML)
                document.body.appendChild(overlay);
                document.body.appendChild(sidebar);
                
                // Toggle menu
                hamburger.addEventListener('click', function() {
                    hamburger.classList.toggle('active');
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                });
                
                // Close on overlay click
                overlay.addEventListener('click', function() {
                    hamburger.classList.remove('active');
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // Handle navigation clicks
                const navItems = sidebar.querySelectorAll('.sidebar-nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const section = this.getAttribute('data-section');
                        
                        // Remove active from all
                        navItems.forEach(i => i.classList.remove('active'));
                        
                        // Add active to clicked
                        this.classList.add('active');
                        
                        // Handle admin panel click
                        if (section === 'adminPanel') {
                            if (typeof handleAdminButtonClick === 'function') {
                                handleAdminButtonClick();
                            }
                        } else {
                            // Show section (call existing function)
                            if (typeof showSection === 'function') {
                                showSection(section);
                            }
                        }
                        
                        // Close menu
                        hamburger.classList.remove('active');
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
                
                // Handle logout button
                const logoutBtnMobile = sidebar.querySelector('#logoutBtnMobile');
                if (logoutBtnMobile) {
                    logoutBtnMobile.addEventListener('click', function() {
                        // Close menu first
                        hamburger.classList.remove('active');
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                        
                        // Call logout function
                        const logoutBtn = document.getElementById('logoutBtn');
                        if (logoutBtn) {
                            logoutBtn.click();
                        }
                    });
                }
                
                // Sync admin button visibility
                const adminNavBtn = document.getElementById('adminNavBtn');
                const adminNavBtnMobile = sidebar.querySelector('#adminNavBtnMobile');
                if (adminNavBtn && adminNavBtnMobile) {
                    // Check if admin button is visible
                    const observer = new MutationObserver(function() {
                        const isVisible = window.getComputedStyle(adminNavBtn).display !== 'none';
                        adminNavBtnMobile.style.display = isVisible ? 'flex' : 'none';
                    });
                    
                    observer.observe(adminNavBtn, { attributes: true, attributeFilter: ['style'] });
                    
                    // Initial check
                    const isVisible = window.getComputedStyle(adminNavBtn).display !== 'none';
                    adminNavBtnMobile.style.display = isVisible ? 'flex' : 'none';
                }
                
                console.log('âœ… Mobile menu created successfully');
            }
        })();
        let currentChatId = null;
        let uploadedFiles = [];
        let createdPapers = [];
        let selectedPaperQuestions = [];

        // API Base URL - HARDCODED FOR APK
        // This file is specifically for APK, so always use production server
        const API_BASE = 'https://eduspherebysarvesh.onrender.com';
        
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ï¿½ FILE: MoyApp/www/index.html (APK VERSION)');
        console.log('ðŸŒ API Base URL (HARDCODED FOR APK):', API_BASE);
        console.log('ðŸ“± Is Cordova:', !!window.cordova);
        console.log('ðŸ“„ Protocol:', window.location.protocol);
        console.log('ðŸ  Hostname:', window.location.hostname);
        console.log('ðŸŒ Origin:', window.location.origin);
        console.log('âš ï¸ This is the APK version - API_BASE is hardcoded to production server');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Test LaTeX dropdown functionality
        function testLatexDropdown() {
            console.log('ðŸ§ª Testing LaTeX dropdown...');

            // Test with qText field
            const testField = document.getElementById('qText');
            if (testField) {
                console.log('âœ… Found qText field');
                toggleLatexDropdown('qText');

                setTimeout(() => {
                    const dropdown = document.getElementById('latexDropdown-qText');
                    if (dropdown && dropdown.classList.contains('active')) {
                        console.log('âœ… LaTeX dropdown is working');
                        showNotification('âœ… LaTeX dropdown is working correctly!', 'success');
                        dropdown.classList.remove('active');
                    } else {
                        console.error('âŒ LaTeX dropdown not working');
                        showNotification('âŒ LaTeX dropdown not working', 'error');
                    }
                }, 500);
            } else {
                console.error('âŒ qText field not found');
                showNotification('âŒ Question text field not found', 'error');
            }
        }

        // Test MathJax availability
        function testMathJax() {
            console.log('ðŸ§® Testing MathJax availability...');

            if (window.MathJax) {
                console.log('âœ… MathJax is loaded');
                console.log('ðŸ“Š MathJax version:', window.MathJax.version);

                // Test rendering
                const testElement = document.createElement('div');
                testElement.innerHTML = 'Test: $x^2 + y^2 = z^2$';
                document.body.appendChild(testElement);

                if (window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([testElement]).then(() => {
                        console.log('âœ… MathJax rendering test successful');
                        showNotification('âœ… MathJax is working correctly!', 'success');
                        document.body.removeChild(testElement);
                    }).catch((err) => {
                        console.error('âŒ MathJax rendering test failed:', err);
                        showNotification('âŒ MathJax rendering failed', 'error');
                        document.body.removeChild(testElement);
                    });
                } else {
                    console.warn('âš ï¸ MathJax typesetPromise not available');
                    showNotification('âš ï¸ MathJax not fully loaded', 'warning');
                    document.body.removeChild(testElement);
                }
            } else {
                console.error('âŒ MathJax not loaded');
                showNotification('âŒ MathJax not available. LaTeX will show as raw text.', 'error');
            }
        }

        // Function to manually re-render MathJax for all questions
        function reRenderMathJax() {
            console.log('ðŸ”„ Re-rendering MathJax for all questions...');

            if (window.MathJax && window.MathJax.typesetPromise) {
                // Find all question containers
                const containers = [
                    document.getElementById('adminQuestionsList'),
                    document.getElementById('questionsDisplay'),
                    document.querySelector('.questions-container')
                ].filter(container => container !== null);

                if (containers.length > 0) {
                    window.MathJax.typesetPromise(containers).then(() => {
                        console.log('âœ… MathJax re-rendering completed');
                        showNotification('âœ… LaTeX expressions re-rendered', 'success');
                    }).catch((err) => {
                        console.error('âŒ MathJax re-rendering failed:', err);
                        showNotification('âŒ LaTeX re-rendering failed', 'error');
                    });
                } else {
                    console.warn('âš ï¸ No question containers found');
                    showNotification('âš ï¸ No question containers found', 'warning');
                }
            } else {
                console.error('âŒ MathJax not available');
                showNotification('âŒ MathJax not available', 'error');
            }
        }

        // Helper function to preserve line breaks in text
        function preserveLineBreaks(text) {
            if (!text) return '';
            
            // Don't insert <br> tags - they break MathJax rendering
            // Instead, just convert literal \n to actual newlines
            // CSS white-space: pre-line will handle the display
            return text
                .replace(/\\n/g, '\n')  // Convert literal \n to actual newlines
                .replace(/\r\n/g, '\n')  // Windows line endings to Unix
                .replace(/\r/g, '\n');   // Mac line endings to Unix
        }

        // Helper function to clean and preserve line breaks
        function cleanTextWithLineBreaks(text) {
            if (!text) return '';
            // First clean the text, then preserve line breaks
            const cleaned = cleanText(text);
            return preserveLineBreaks(cleaned);
        }

        // Test API connection
        async function testAPIConnection() {
            try {
                console.log('ðŸ” Testing API connection to:', API_BASE);
                const response = await fetch(`${API_BASE}/api/ai-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer admin-token`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… API connection successful:', data);
                    return true;
                } else {
                    console.error('âŒ API connection failed:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('âŒ API connection error:', error);
                return false;
            }
        }

        // ==================== OLD MAKE PAPER FUNCTIONS (REMOVED) ====================
        // All old make paper functions removed - using new implementation below
        
        // OLD FUNCTIONS REMOVED TO AVOID CONFLICTS
        
        function loadSavedPapers() {
            try {
                const saved = localStorage.getItem('savedPapers');
                if (saved) {
                    createdPapers = JSON.parse(saved);
                    console.log('âœ… Loaded', createdPapers.length, 'saved papers');
                    // Display saved papers if on step 3
                    if (createdPapers.length > 0) {
                        createdPapers.forEach(paper => displayCreatedPaper(paper));
                    }
                }
            } catch (error) {
                console.error('âŒ Error loading papers:', error);
            }
        }
        
        // Save papers to localStorage
        function savePapersToStorage() {
            try {
                localStorage.setItem('savedPapers', JSON.stringify(createdPapers));
                console.log('âœ… Saved', createdPapers.length, 'papers');
            } catch (error) {
                console.error('âŒ Error saving papers:', error);
            }
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    loadSavedPapers();
                    updateSelectionCount();
                    console.log('âœ… Paper system initialized');
                }, 500);
            });
        } else {
            setTimeout(() => {
                loadSavedPapers();
                updateSelectionCount();
                console.log('âœ… Paper system initialized');
            }, 500);
        }

        function selectPaperExamType(type) {
            paperExamType = type;
            console.log('ðŸ“ Selected exam type:', type);
            
            // Update active tab
            const tabs = document.querySelectorAll('#makePaperSection .exam-type-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.closest('.exam-type-tab').classList.add('active');
            
            // Update subject tabs based on exam type
            updatePaperSubjectTabs();
            
            // Reload questions
            loadPaperQuestions();
        }

        function updatePaperSubjectTabs() {
            const subjectTabsContainer = document.getElementById('paperSubjectTabs');
            
            if (paperExamType === 'jee') {
                // JEE: Physics, Chemistry, Mathematics
                subjectTabsContainer.innerHTML = `
                    <div class="subject-tab active" onclick="selectPaperSubject('physics')">
                        <i class="fas fa-atom"></i> Physics
                    </div>
                    <div class="subject-tab" onclick="selectPaperSubject('chemistry')">
                        <i class="fas fa-flask"></i> Chemistry
                    </div>
                    <div class="subject-tab" onclick="selectPaperSubject('mathematics')">
                        <i class="fas fa-calculator"></i> Mathematics
                    </div>
                `;
                paperSubject = 'physics'; // Reset to physics
            } else {
                // NEET: Physics, Chemistry, Biology
                subjectTabsContainer.innerHTML = `
                    <div class="subject-tab active" onclick="selectPaperSubject('physics')">
                        <i class="fas fa-atom"></i> Physics
                    </div>
                    <div class="subject-tab" onclick="selectPaperSubject('chemistry')">
                        <i class="fas fa-flask"></i> Chemistry
                    </div>
                    <div class="subject-tab" onclick="selectPaperSubject('biology')">
                        <i class="fas fa-dna"></i> Biology
                    </div>
                `;
                paperSubject = 'physics'; // Reset to physics
            }
        }

        function selectPaperSubject(subject) {
            paperSubject = subject;
            console.log('ðŸ“š Selected subject:', subject);
            
            const tabs = document.querySelectorAll('#makePaperSection .subject-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            loadPaperQuestions();
        }

        // Load chapters for filter dropdown
        async function loadPaperChapters() {
            try {
                const chapterFilter = document.getElementById('paperChapterFilter');
                if (!chapterFilter) return;
                
                const response = await fetch(`${API_BASE}/api/chapters?examType=${paperExamType}&subject=${paperSubject}`);
                const data = await response.json();
                
                if (data.success && data.chapters) {
                    chapterFilter.innerHTML = '<option value="">All Chapters</option>';
                    data.chapters.forEach(chapter => {
                        const option = document.createElement('option');
                        option.value = chapter.name;
                        option.textContent = chapter.name;
                        chapterFilter.appendChild(option);
                    });
                    console.log('âœ… Loaded', data.chapters.length, 'chapters for filter');
                }
            } catch (error) {
                console.error('âŒ Error loading chapters:', error);
            }
        }

        async function loadPaperQuestions() {
            console.log('ðŸ“„ Loading paper questions...', { paperExamType, paperSubject });
            const container = document.getElementById('paperQuestionsList');
            
            if (!container) {
                console.error('âŒ Paper questions container not found');
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top: 1rem;">Loading questions...</p></div>';

            try {
                // Get filter values
                const chapterFilter = document.getElementById('paperChapterFilter')?.value || '';
                const difficultyFilter = document.getElementById('paperDifficultyFilter')?.value || '';
                const classFilter = document.getElementById('paperClassFilter')?.value || '';

                // Build URL with filters
                const params = new URLSearchParams();
                params.append('examType', paperExamType);
                params.append('subject', paperSubject);
                if (chapterFilter) params.append('chapter', chapterFilter);
                if (difficultyFilter) params.append('difficulty', difficultyFilter);
                if (classFilter) params.append('class', classFilter);

                const url = `${API_BASE}/api/questions?${params.toString()}`;
                console.log('ðŸ”— Fetching from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('âœ… API Response:', data);
                
                // FIX: Handle both response formats
                const questions = data.questions || data || [];
                console.log('âœ… Loaded questions:', questions.length);

                // Load chapters for the filter
                await loadPaperChapters();

                if (!Array.isArray(questions) || questions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>No questions available</h3>
                            <p>No questions found for ${paperExamType.toUpperCase()} - ${paperSubject}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = questions.map((q, index) => `
                    <div class="question-select-item ${selectedPaperQuestions.includes(q._id) ? 'selected' : ''}" 
                         data-question-id="${q._id}"
                         onclick="toggleQuestionSelection('${q._id}')"
                         style="cursor: pointer; position: relative; transition: all 0.3s ease; display: flex; gap: 1rem; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <span style="background: rgba(99, 102, 241, 0.1); color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${q.examType?.toUpperCase() || 'N/A'}</span>
                                    <span style="background: rgba(16, 185, 129, 0.1); color: #047857; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${q.subject || 'N/A'}</span>
                                    <span style="background: rgba(245, 158, 11, 0.1); color: #92400e); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${q.difficulty || 'N/A'}</span>
                                    <span style="background: rgba(59, 130, 246, 0.1); color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${q.chapter || 'N/A'}</span>
                                </div>
                                <button onclick="event.stopPropagation(); previewQuestion('${q._id}', ${index})" 
                                        style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease;">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            <div class="question-text-preview" style="font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-800); line-height: 1.6; white-space: pre-wrap;">
                                <strong>Q${index + 1}.</strong> ${preserveLineBreaks(q.text || 'No question text')}
                            </div>
                            ${q.options && q.options.length > 0 ? `
                                <div style="display: grid; gap: 0.5rem; margin-top: 0.75rem; padding-left: 1rem;">
                                    ${q.options.map((opt, i) => `
                                        <div style="display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.9rem; color: var(--gray-700);">
                                            <span style="font-weight: 600; color: ${String.fromCharCode(65 + i) === q.answer ? 'var(--success)' : 'var(--gray-600)'};">${String.fromCharCode(65 + i)})</span>
                                            <span style="white-space: pre-wrap; line-height: 1.5;">${preserveLineBreaks(opt)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 0.85rem; color: var(--gray-600);">
                                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Answer: <strong>${q.answer || 'N/A'}</strong>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">
                                    <i class="fas fa-graduation-cap"></i> Class ${q.class || 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div style="margin-left: 1rem; flex-shrink: 0;">
                            <input type="checkbox" 
                                   ${selectedPaperQuestions.includes(q._id) ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleQuestionSelection('${q._id}');"
                                   style="width: 24px; height: 24px; cursor: pointer; accent-color: #10b981;">
                        </div>
                    </div>
                `).join('');

                // Add click handlers to all checkboxes
                setTimeout(() => {
                    const checkboxes = container.querySelectorAll('.custom-checkbox');
                    console.log('ðŸ“¦ Found', checkboxes.length, 'checkboxes');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const questionId = this.getAttribute('data-checkbox-id');
                            console.log('ðŸ–±ï¸ Checkbox clicked:', questionId);
                            if (questionId) {
                                toggleQuestionSelection(questionId);
                            }
                        });
                    });
                }, 100);

                // Render LaTeX after DOM update
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([container]).catch(err => {
                            console.error('MathJax rendering error:', err);
                        });
                    }, 100);
                }

                // Update selection count - IMPORTANT FIX
                setTimeout(() => {
                    updateSelectionCount();
                }, 200);

                console.log('âœ… Questions rendered successfully');
                console.log('ðŸ“Š Current selection count:', selectedPaperQuestions.length);
            } catch (error) {
                console.error('âŒ Error loading questions:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--error);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Error loading questions</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadPaperQuestions()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        function toggleQuestionSelection(questionId) {
            console.log('ðŸ”„ ===== TOGGLE SELECTION =====');
            console.log('ðŸ“ Question ID:', questionId);
            console.log('ï¿½ Qufestion ID type:', typeof questionId);
            console.log('ðŸ“‹ Before:', selectedPaperQuestions.length, 'questions');
            console.log('ðŸ“‹ Array contents:', selectedPaperQuestions);
            
            const index = selectedPaperQuestions.indexOf(questionId);
            console.log('ðŸ“ Index in array:', index);
            
            if (index > -1) {
                selectedPaperQuestions.splice(index, 1);
                console.log('âŒ DESELECTED - Removed from array');
            } else {
                selectedPaperQuestions.push(questionId);
                console.log('âœ… SELECTED - Added to array');
            }
            
            console.log('ðŸ“‹ After:', selectedPaperQuestions.length, 'questions');
            console.log('ðŸ“Š Full array:', selectedPaperQuestions);
            console.log('ðŸ“Š Array JSON:', JSON.stringify(selectedPaperQuestions));
            
            // Update UI - find the item by data attribute
            const item = document.querySelector(`[data-question-id="${questionId}"]`);
            console.log('ðŸŽ¯ DOM Element found:', !!item);
            
            if (item) {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const isSelected = selectedPaperQuestions.includes(questionId);
                
                // Update checkbox
                if (checkbox) {
                    checkbox.checked = isSelected;
                    console.log('â˜‘ï¸ Checkbox updated:', isSelected);
                }
                
                // Update visual state with inline styles for immediate feedback
                if (isSelected) {
                    item.classList.add('selected');
                    item.style.borderColor = '#10b981';
                    item.style.background = 'rgba(16, 185, 129, 0.1)';
                    item.style.transform = 'translateY(-2px)';
                    item.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.2)';
                    console.log('ðŸŽ¨ Added "selected" class and styles');
                } else {
                    item.classList.remove('selected');
                    item.style.borderColor = '';
                    item.style.background = '';
                    item.style.transform = '';
                    item.style.boxShadow = '';
                    console.log('ðŸŽ¨ Removed "selected" class and styles');
                }
                
                // Force reflow
                void item.offsetWidth;
            } else {
                console.error('âŒ Could not find DOM element for question:', questionId);
            }
            
            // Update selection count display
            updateSelectionCount();
            console.log('ðŸ”„ ===== TOGGLE COMPLETE =====\n');
        }
        
        function updateSelectionCount() {
            const count = selectedPaperQuestions.length;
            console.log('ðŸ“Š Updating selection count:', count);
            
            // Update all count displays
            const countDisplay = document.getElementById('selectedQuestionsCount');
            const paperCountDisplay = document.getElementById('paperSelectedCount');
            const settingsCountDisplay = document.getElementById('settingsSelectedCount');
            
            if (countDisplay) {
                countDisplay.textContent = count;
                console.log('âœ… selectedQuestionsCount updated:', count);
            }
            
            if (paperCountDisplay) {
                paperCountDisplay.textContent = count;
                console.log('âœ… paperSelectedCount updated:', count);
            }
            
            if (settingsCountDisplay) {
                settingsCountDisplay.textContent = count;
                console.log('âœ… settingsSelectedCount updated:', count);
            }
            
            // Also update the display area
            const displayArea = document.getElementById('selectedQuestionsDisplay');
            if (displayArea) {
                if (count > 0) {
                    displayArea.innerHTML = `
                        <div style="padding: 1rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--primary);">
                                <i class="fas fa-check-circle"></i> ${count} Question${count !== 1 ? 's' : ''} Selected
                            </h4>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${selectedPaperQuestions.map((id, idx) => `
                                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                        Q${idx + 1}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    displayArea.innerHTML = `
                        <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p>No questions selected yet. Click on questions below to select them.</p>
                        </div>
                    `;
                }
            } else {
                console.warn('âš ï¸ selectedQuestionsDisplay element not found');
            }
        }

        async function selectAllPaperQuestions() {
            try {
                // Get filter values
                const chapterFilter = document.getElementById('paperChapterFilter')?.value || '';
                const difficultyFilter = document.getElementById('paperDifficultyFilter')?.value || '';
                const classFilter = document.getElementById('paperClassFilter')?.value || '';

                // Build URL with filters
                const params = new URLSearchParams();
                params.append('examType', paperExamType);
                params.append('subject', paperSubject);
                if (chapterFilter) params.append('chapter', chapterFilter);
                if (difficultyFilter) params.append('difficulty', difficultyFilter);
                if (classFilter) params.append('class', classFilter);

                const url = `${API_BASE}/api/questions?${params.toString()}`;
                const response = await fetch(url);
                const data = await response.json();
                const questions = data.questions || data || [];
                
                // Select all question IDs
                selectedPaperQuestions = questions.map(q => q._id);
                console.log('âœ… Selected all questions:', selectedPaperQuestions.length, selectedPaperQuestions);
                
                // Reload to update UI
                await loadPaperQuestions();
                
                // Verify selection persisted
                console.log('âœ… After reload, selected questions:', selectedPaperQuestions.length);
                
                showNotification(`Selected all ${selectedPaperQuestions.length} questions`, 'success');
            } catch (error) {
                console.error('Error selecting all questions:', error);
                showNotification('Error selecting all questions', 'error');
            }
        }

        function clearAllPaperQuestions() {
            selectedPaperQuestions = [];
            console.log('ðŸ—‘ï¸ Cleared all selections');
            loadPaperQuestions();
            showNotification('Cleared all selections', 'info');
        }

        // Preview question in modal
        async function previewQuestion(questionId, index) {
            try {
                console.log('ðŸ‘ï¸ Previewing question:', questionId);
                
                // Show modal
                document.getElementById('questionPreviewModal').style.display = 'flex';
                
                // Get question data
                const response = await fetch(`${API_BASE}/api/questions?examType=${paperExamType}&subject=${paperSubject}`);
                const data = await response.json();
                const questions = data.questions || data || [];
                const question = questions.find(q => q._id === questionId);
                
                if (!question) {
                    throw new Error('Question not found');
                }
                
                // Display question
                const container = document.getElementById('questionPreviewContent');
                container.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <span style="background: rgba(99, 102, 241, 0.1); color: #4338ca; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-graduation-cap"></i> ${question.examType?.toUpperCase() || 'N/A'}
                            </span>
                            <span style="background: rgba(16, 185, 129, 0.1); color: #047857; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-book"></i> ${question.subject || 'N/A'}
                            </span>
                            <span style="background: rgba(245, 158, 11, 0.1); color: #92400e; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-layer-group"></i> ${question.difficulty || 'N/A'}
                            </span>
                            <span style="background: rgba(59, 130, 246, 0.1); color: #1e40af; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-bookmark"></i> ${question.chapter || 'N/A'}
                            </span>
                            <span style="background: rgba(139, 92, 246, 0.1); color: #6b21a8; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-school"></i> Class ${question.class || 'N/A'}
                            </span>
                        </div>
                    </div>

                    <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--primary); margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-800); font-size: 1.1rem;">
                            <i class="fas fa-question-circle"></i> Question ${index + 1}
                        </h3>
                        <div class="question-text" style="font-size: 1.1rem; line-height: 1.8; color: var(--gray-800); white-space: pre-wrap;">
                            ${preserveLineBreaks(question.text || 'No question text')}
                        </div>
                    </div>

                    ${question.options && question.options.length > 0 ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--gray-700); font-size: 1rem;">
                                <i class="fas fa-list"></i> Options
                            </h4>
                            <div style="display: grid; gap: 0.75rem;">
                                ${question.options.map((opt, i) => `
                                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: ${String.fromCharCode(65 + i) === question.answer ? 'rgba(16, 185, 129, 0.1)' : 'white'}; border: 2px solid ${String.fromCharCode(65 + i) === question.answer ? 'var(--success)' : 'var(--gray-200)'}; border-radius: 12px;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: ${String.fromCharCode(65 + i) === question.answer ? 'var(--success)' : 'var(--gray-200)'}; color: ${String.fromCharCode(65 + i) === question.answer ? 'white' : 'var(--gray-700)'}; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">
                                            ${String.fromCharCode(65 + i)}
                                        </div>
                                        <div style="flex: 1; line-height: 1.6; white-space: pre-wrap; color: var(--gray-800);">
                                            ${preserveLineBreaks(opt)}
                                        </div>
                                        ${String.fromCharCode(65 + i) === question.answer ? '<i class="fas fa-check-circle" style="color: var(--success); font-size: 1.5rem; flex-shrink: 0;"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success); margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--success); font-size: 1rem;">
                            <i class="fas fa-check-circle"></i> Correct Answer
                        </h4>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--gray-800);">
                            Option ${question.answer || 'N/A'}
                        </div>
                    </div>

                    ${question.solution ? `
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--info);">
                            <h4 style="margin: 0 0 1rem 0; color: var(--info); font-size: 1rem;">
                                <i class="fas fa-lightbulb"></i> Solution
                            </h4>
                            <div class="question-solution" style="line-height: 1.8; color: var(--gray-800); white-space: pre-wrap;">
                                ${preserveLineBreaks(question.solution)}
                            </div>
                        </div>
                    ` : ''}

                    ${question.explanation ? `
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #8b5cf6; margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #8b5cf6; font-size: 1rem;">
                                <i class="fas fa-info-circle"></i> Additional Explanation
                            </h4>
                            <div style="line-height: 1.8; color: var(--gray-800); white-space: pre-wrap;">
                                ${preserveLineBreaks(question.explanation)}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Render LaTeX
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([container]).catch(err => {
                            console.error('MathJax rendering error:', err);
                        });
                    }, 100);
                }

            } catch (error) {
                console.error('âŒ Error previewing question:', error);
                showNotification('Error loading question preview: ' + error.message, 'error');
            }
        }

        function closeQuestionPreview() {
            document.getElementById('questionPreviewModal').style.display = 'none';
        }

        // Load chapters for paper filter
        async function loadPaperChapters() {
            try {
                const response = await fetch(`${API_BASE}/api/chapters?examType=${paperExamType}&subject=${paperSubject}`);
                const data = await response.json();
                
                const chapterSelect = document.getElementById('paperChapterFilter');
                if (chapterSelect && data.chapters) {
                    const currentValue = chapterSelect.value;
                    chapterSelect.innerHTML = '<option value="">All Chapters</option>';
                    data.chapters.forEach(chapter => {
                        chapterSelect.innerHTML += `<option value="${chapter.name}" ${currentValue === chapter.name ? 'selected' : ''}>${chapter.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
            }
        }

        function goToPaperStep(step) {
            console.log('ðŸ“„ Attempting to move to step:', step);
            console.log('ðŸ“‹ Currently selected questions:', selectedPaperQuestions.length, selectedPaperQuestions);
            
            if (step === 2 && selectedPaperQuestions.length === 0) {
                showNotification('Please select at least one question', 'warning');
                console.error('âŒ No questions selected!');
                return;
            }

            console.log('âœ… Moving to paper step:', step);
            document.querySelectorAll('.paper-step').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            const targetStep = document.getElementById(`paperStep${step}`);
            if (targetStep) {
                targetStep.classList.add('active');
                targetStep.style.display = 'block';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolLogo = e.target.result;
                    document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                    showNotification('Logo uploaded successfully', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Create paper configuration (save only IDs, not PDF)
        async function createPaperConfig() {
            if (selectedPaperQuestions.length === 0) {
                showNotification('Please select at least one question', 'warning');
                return;
            }

            const schoolName = document.getElementById('schoolName').value;
            const examDate = document.getElementById('examDate').value;
            const examTime = document.getElementById('examTime').value;
            const totalMarks = document.getElementById('totalMarks').value;
            const watermark = document.getElementById('watermark').value;

            if (!schoolName || !examDate) {
                showNotification('Please fill in school name and exam date', 'warning');
                return;
            }

            try {
                showNotification('Creating paper configuration...', 'info');

                // Create paper config with unique ID
                const paperConfig = {
                    _id: 'paper_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    paperName: `${paperExamType.toUpperCase()} ${paperSubject.charAt(0).toUpperCase() + paperSubject.slice(1)} Paper`,
                    schoolName,
                    schoolLogo,
                    examType: paperExamType,
                    subject: paperSubject,
                    examDate,
                    examTime: parseInt(examTime),
                    totalMarks: parseInt(totalMarks),
                    watermark,
                    questionIds: [...selectedPaperQuestions], // Copy array
                    createdAt: new Date().toISOString()
                };

                console.log('ðŸ“ Creating paper config (localStorage):', paperConfig);
                console.log('ðŸ“Š Selected questions:', selectedPaperQuestions.length);

                // Save to localStorage
                createdPapers.push(paperConfig);
                savePapersToStorage();
                
                showNotification('âœ… Paper created successfully!', 'success');
                displayCreatedPaper(paperConfig);
                goToPaperStep(3);
                
                // Reset selection for next paper
                selectedPaperQuestions = [];
                updateSelectionCount();
                
            } catch (error) {
                console.error('âŒ Error creating paper:', error);
                showNotification('Error creating paper: ' + error.message, 'error');
            }
        }

        // Display created paper with download buttons
        function displayCreatedPaper(paperConfig) {
            const container = document.getElementById('createdPapersContainer');
            
            if (!container) {
                console.warn('âš ï¸ createdPapersContainer not found in DOM');
                return;
            }
            
            const paperCard = `
                <div class="created-paper-card" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--gray-900);">
                                <i class="fas fa-file-alt"></i> ${paperConfig.paperName}
                            </h3>
                            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">
                                ${paperConfig.schoolName} â€¢ ${paperConfig.questionIds.length} Questions
                            </p>
                        </div>
                        <div style="background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-check-circle"></i> Created
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 12px;">
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.25rem;">Exam Type</div>
                            <div style="font-weight: 600; color: var(--gray-800);">${paperConfig.examType.toUpperCase()}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.25rem;">Subject</div>
                            <div style="font-weight: 600; color: var(--gray-800);">${paperConfig.subject}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.25rem;">Total Marks</div>
                            <div style="font-weight: 600; color: var(--gray-800);">${paperConfig.totalMarks}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.25rem;">Duration</div>
                            <div style="font-weight: 600; color: var(--gray-800);">${paperConfig.examTime} min</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <button class="btn btn-primary" onclick="downloadPaperPDF('${paperConfig._id}', 'questions')" style="width: 100%;">
                            <i class="fas fa-file-alt"></i> Questions
                        </button>
                        <button class="btn btn-success" onclick="downloadPaperPDF('${paperConfig._id}', 'answerkey')" style="width: 100%;">
                            <i class="fas fa-check-circle"></i> Answer Key
                        </button>
                        <button class="btn btn-info" onclick="downloadPaperPDF('${paperConfig._id}', 'solutions')" style="width: 100%;">
                            <i class="fas fa-book-open"></i> Solutions
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = paperCard + container.innerHTML;
        }

        // Download PDF on-demand with GYANMANJARI format
        async function downloadPaperPDF(paperId, type) {
            try {
                showNotification(`Generating ${type} PDF...`, 'info');
                console.log('ðŸ“„ Downloading PDF:', paperId, type);

                // Find paper config from createdPapers array
                const paperConfig = createdPapers.find(p => p._id === paperId);
                
                if (paperConfig) {
                    console.log('âœ… Found paper config in memory:', paperConfig);
                    // Generate PDF directly from the paper config
                    await generatePDFFromConfig(paperConfig, type);
                    showNotification(`${type} PDF downloaded successfully!`, 'success');
                } else {
                    // Try to fetch from API as fallback
                    console.log('âš ï¸ Paper not found in memory, trying API...');
                    const response = await fetch(`${API_BASE}/api/paper-configs/${paperId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        await generatePDFFromConfig(data.paperConfig, type);
                        showNotification(`${type} PDF downloaded successfully!`, 'success');
                    } else {
                        throw new Error(data.error || 'Paper configuration not found');
                    }
                }
            } catch (error) {
                console.error('âŒ Error downloading PDF:', error);
                showNotification('Error downloading PDF: ' + error.message, 'error');
            }
        }

        // Generate PDF from config (using Playwright backend)
        async function generatePDFFromConfig(paperConfig, type) {
            try {
                console.log('ðŸ“„ Generating PDF:', type, paperConfig);
                showNotification(`Generating ${type} PDF...`, 'info');

                // Fetch questions
                const questionsResponse = await fetch(`${API_BASE}/api/questions/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionIds: paperConfig.questionIds })
                });

                if (!questionsResponse.ok) {
                    throw new Error('Failed to fetch questions');
                }

                const questions = await questionsResponse.json();
                console.log('âœ… Fetched', questions.length, 'questions for PDF');

                // Prepare config for backend
                const config = {
                    schoolName: paperConfig.schoolName || 'GYANMANJARI',
                    paperTitle: paperConfig.paperName || 'MOCK_12-11',
                    subject: paperConfig.subject || 'Physics',
                    standard: paperConfig.standard || '11',
                    totalMarks: paperConfig.totalMarks || '100',
                    paperSet: paperConfig.paperSet || '1',
                    examDate: paperConfig.examDate || new Date().toISOString(),
                    examTime: paperConfig.examTime || '0H:0M'
                };

                // Send to Playwright backend for PDF generation
                const token = localStorage.getItem('token');
                const pdfResponse = await fetch(`${API_BASE}/api/generate-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        paperConfigId: paperConfig._id,
                        pdfType: type,
                        questions: questions,
                        config: config
                    })
                });

                if (!pdfResponse.ok) {
                    const error = await pdfResponse.json();
                    throw new Error(error.error || 'PDF generation failed');
                }

                // Download the PDF
                const blob = await pdfResponse.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Detect if mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // On mobile, open in new tab
                    window.open(url, '_blank');
                    showNotification(`${type} PDF opened in new tab!`, 'success');
                    console.log('âœ… PDF opened in new tab (mobile)');
                    
                    // Clean up after a delay
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                    }, 1000);
                } else {
                    // On desktop, download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${config.schoolName}_${config.paperTitle}_${type}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification(`${type} PDF downloaded successfully!`, 'success');
                    console.log('âœ… PDF generated and downloaded (desktop)');
                }
                
            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }
        
        // OLD jsPDF CODE REMOVED - Now using pdfmake exclusively
        // If you need the old code, it's been replaced with generateFastPDF above
        
        function oldGeneratePDFFromConfig_DISABLED() {
            // This function is disabled - using pdfmake now
            return;
            
            // OLD CODE BELOW (disabled)
            // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const lineHeight = 7;
                const maxWidth = pageWidth - (margin * 2);

                // Add header
                if (paperConfig.schoolLogo) {
                    try {
                        doc.addImage(paperConfig.schoolLogo, 'PNG', margin, yPosition, 30, 30);
                        yPosition += 35;
                    } catch (e) {
                        console.log('Could not add logo:', e);
                    }
                }

                // GYANMANJARI Header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(paperConfig.schoolName.toUpperCase(), pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;

                // Border line
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 8;

                // Paper details in 3-column format
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Left column
                doc.text(`Subject`, margin, yPosition);
                doc.text(`: ${paperConfig.subject.charAt(0).toUpperCase() + paperConfig.subject.slice(1)}`, margin + 30, yPosition);
                
                // Center - Paper title
                const paperTitle = type === 'questions' ? 'MOCK_12-11' : 
                                   type === 'answers' ? 'MOCK_12-11\n(Answer Key)' : 'MOCK_12-11\n(Solutions)';
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text(paperTitle, pageWidth / 2, yPosition, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Right column
                doc.text(`Paper Set : 1`, pageWidth - margin - 35, yPosition);
                yPosition += 6;
                
                // Second row
                doc.text(`Standard`, margin, yPosition);
                doc.text(`: 11`, margin + 30, yPosition);
                doc.text(`Date`, pageWidth - margin - 35, yPosition);
                const dateStr = new Date(paperConfig.examDate).toLocaleDateString('en-GB').replace(/\//g, '-');
                doc.text(`: ${dateStr}`, pageWidth - margin - 20, yPosition);
                yPosition += 6;
                
                // Third row
                doc.text(`Total Mark`, margin, yPosition);
                doc.text(`: ${paperConfig.totalMarks}`, margin + 30, yPosition);
                doc.text(`Time`, pageWidth - margin - 35, yPosition);
                doc.text(`: ${paperConfig.examTime}M`, pageWidth - margin - 20, yPosition);
                yPosition += 8;
                
                // Border line
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;

                // Add watermark if provided
                if (paperConfig.watermark) {
                    doc.setFontSize(50);
                    doc.setTextColor(220, 220, 220);
                    doc.text(paperConfig.watermark, pageWidth / 2, pageHeight / 2, {
                        align: 'center',
                        angle: 45
                    });
                    doc.setTextColor(0, 0, 0);
                }

                // GYANMANJARI Format - Section Header
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                const sectionTitle = `${paperConfig.subject.charAt(0).toUpperCase() + paperConfig.subject.slice(1)} - Section A (MCQ)`;
                doc.text(sectionTitle, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                const checkPageBreak = (space = 30) => {
                    if (yPosition > pageHeight - space) {
                        doc.addPage();
                        yPosition = 20;
                    }
                };

                // Answer Key Table Format
                if (type === 'answers') {
                    const cols = 10;
                    const cellWidth = (pageWidth - 2 * margin) / cols;
                    const cellHeight = 8;
                    doc.setFontSize(9);
                    let currentCol = 0;
                    let currentRow = 0;
                    
                    questions.forEach((q, index) => {
                        if (currentCol === 0) checkPageBreak(cellHeight + 10);
                        const x = margin + (currentCol * cellWidth);
                        const y = yPosition + (currentRow * cellHeight);
                        doc.rect(x, y, cellWidth, cellHeight);
                        doc.setFont(undefined, 'normal');
                        doc.text(`${index + 1} - ${q.answer}`, x + cellWidth / 2, y + cellHeight / 2 + 1, { align: 'center' });
                        currentCol++;
                        if (currentCol >= cols) {
                            currentCol = 0;
                            currentRow++;
                        }
                    });
                    yPosition += (currentRow + 1) * cellHeight + 10;
                } else {
                    // Questions or Solutions Format
                    doc.setFontSize(10);
                    
                    // Helper function to render formatted text
                    const renderFormattedText = (text, x, y, maxW, options = {}) => {
                        if (!text) return y;
                        let currentY = y;
                        const { align = 'left', defaultFont = 'normal' } = options;
                        
                        // Split by lines
                        const lines = text.split('\n');
                        
                        lines.forEach(line => {
                            // Process formatting: **bold**, *italic*, __underline__, $latex$
                            let segments = [];
                            let currentText = line;
                            let currentX = x;
                            
                            // Simple approach: detect and apply formatting
                            const boldRegex = /\*\*(.*?)\*\*/g;
                            const italicRegex = /\*(.*?)\*/g;
                            const underlineRegex = /__(.*?)__/g;
                            const latexRegex = /\$(.*?)\$/g;
                            
                            // For now, just remove formatting markers and render
                            let processedLine = currentText
                                .replace(boldRegex, '$1')
                                .replace(italicRegex, '$1')
                                .replace(underlineRegex, '$1')
                                .replace(latexRegex, '$1');
                            
                            // Check for bold
                            const isBold = /\*\*/.test(currentText);
                            const isItalic = /\*[^*]/.test(currentText);
                            
                            if (isBold) {
                                doc.setFont(undefined, 'bold');
                            } else if (isItalic) {
                                doc.setFont(undefined, 'italic');
                            } else {
                                doc.setFont(undefined, defaultFont);
                            }
                            
                            // Split and render
                            const wrappedLines = doc.splitTextToSize(processedLine, maxW);
                            wrappedLines.forEach((wLine, idx) => {
                                if (idx > 0 && currentY > pageHeight - 30) {
                                    doc.addPage();
                                    currentY = 20;
                                }
                                
                                let textX = x;
                                if (align === 'center') {
                                    textX = pageWidth / 2;
                                } else if (align === 'right') {
                                    textX = pageWidth - margin;
                                }
                                
                                doc.text(wLine, textX, currentY, { align });
                                
                                // Underline if needed
                                if (/__/.test(currentText)) {
                                    const textWidth = doc.getTextWidth(wLine);
                                    doc.line(textX, currentY + 1, textX + textWidth, currentY + 1);
                                }
                                
                                currentY += 6;
                            });
                        });
                        
                        return currentY;
                    };
                    
                    questions.forEach((q, index) => {
                        checkPageBreak(40);
                        
                        // Question number
                        doc.setFont(undefined, 'bold');
                        doc.text(`(${index + 1})`, margin, yPosition);
                        
                        // Question text with formatting
                        doc.setFont(undefined, 'normal');
                        yPosition = renderFormattedText(q.text || '', margin + 8, yPosition, maxWidth - 10);
                        yPosition += 2;
                        
                        // Render question images
                        if (q.questionImages && q.questionImages.length > 0) {
                            for (const img of q.questionImages) {
                                checkPageBreak(60);
                                try {
                                    if (img.data) {
                                        doc.addImage(img.data, 'PNG', margin + 10, yPosition, 80, 50);
                                        yPosition += 55;
                                    }
                                } catch (e) {
                                    console.log('Image error:', e);
                                }
                            }
                        }
                        
                        // Options
                        if (q.options && q.options.length > 0) {
                            q.options.forEach((option, optIndex) => {
                                checkPageBreak();
                                const optionLetter = String.fromCharCode(65 + optIndex);
                                const isCorrect = optionLetter === q.answer;
                                
                                if (type === 'solutions' && isCorrect) {
                                    doc.setFont(undefined, 'bold');
                                    doc.setTextColor(0, 128, 0);
                                } else {
                                    doc.setFont(undefined, 'normal');
                                    doc.setTextColor(0, 0, 0);
                                }
                                
                                const optionText = `(${optionLetter}) ${option}`;
                                yPosition = renderFormattedText(optionText, margin + 10, yPosition, maxWidth - 15, { 
                                    defaultFont: isCorrect && type === 'solutions' ? 'bold' : 'normal' 
                                });
                            });
                            doc.setTextColor(0, 0, 0);
                            yPosition += 3;
                        }
                        
                        // Solution
                        if (type === 'solutions') {
                            checkPageBreak(20);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(0, 128, 0);
                            doc.text(`Solution:(Correct Answer:${q.answer})`, margin + 10, yPosition);
                            yPosition += 6;
                            doc.setTextColor(0, 0, 0);
                            
                            if (q.solution) {
                                doc.setFont(undefined, 'normal');
                                yPosition = renderFormattedText(q.solution, margin + 10, yPosition, maxWidth - 15);
                                yPosition += 3;
                            }
                            
                            // Solution images
                            if (q.solutionImages && q.solutionImages.length > 0) {
                                for (const img of q.solutionImages) {
                                    checkPageBreak(60);
                                    try {
                                        if (img.data) {
                                            doc.addImage(img.data, 'PNG', margin + 15, yPosition, 80, 50);
                                            yPosition += 55;
                                        }
                                    } catch (e) {
                                        console.log('Solution image error:', e);
                                    }
                                }
                            }
                        }
                        
                        yPosition += 8;
                    });
                }

        } // End of oldGeneratePDFFromConfig_DISABLED

        function selectPdfOption(option) {
            selectedPdfOption = option;
            document.querySelectorAll('.pdf-option-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.pdf-option-btn').classList.add('selected');
            document.getElementById('downloadPaperBtn').disabled = false;
            console.log('ðŸ“„ Selected PDF option:', option);
        }

        // Enhanced PDF text rendering with formatting support
        function renderFormattedText(doc, text, x, y, maxWidth, options = {}) {
            const { fontSize = 11, lineHeight = 7, align = 'left' } = options;
            let currentY = y;
            
            // Parse and render text with formatting
            const lines = text.split('\n');
            
            lines.forEach(line => {
                // Handle bold: **text** or <b>text</b>
                let processedLine = line;
                let isBold = false;
                let isItalic = false;
                let isUnderline = false;
                
                // Simple formatting detection
                if (processedLine.includes('**') || processedLine.includes('<b>')) {
                    isBold = true;
                    processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '$1').replace(/<\/?b>/g, '');
                }
                if (processedLine.includes('*') || processedLine.includes('<i>')) {
                    isItalic = true;
                    processedLine = processedLine.replace(/\*(.*?)\*/g, '$1').replace(/<\/?i>/g, '');
                }
                if (processedLine.includes('<u>')) {
                    isUnderline = true;
                    processedLine = processedLine.replace(/<\/?u>/g, '');
                }
                
                // Set font style
                const fontStyle = isBold ? 'bold' : (isItalic ? 'italic' : 'normal');
                doc.setFont(undefined, fontStyle);
                
                // Split text to fit width
                const wrappedLines = doc.splitTextToSize(processedLine, maxWidth);
                
                wrappedLines.forEach(wrappedLine => {
                    if (currentY > doc.internal.pageSize.height - 30) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    // Render text with alignment
                    const textX = align === 'center' ? doc.internal.pageSize.width / 2 : 
                                  align === 'right' ? doc.internal.pageSize.width - x : x;
                    
                    doc.text(wrappedLine, textX, currentY, { align });
                    
                    // Add underline if needed
                    if (isUnderline) {
                        const textWidth = doc.getTextWidth(wrappedLine);
                        doc.line(textX, currentY + 1, textX + textWidth, currentY + 1);
                    }
                    
                    currentY += lineHeight;
                });
            });
            
            return currentY;
        }

        async function downloadPaper() {
            if (!selectedPdfOption) {
                showNotification('Please select a PDF option', 'warning');
                return;
            }

            const schoolName = document.getElementById('schoolName').value || 'GYANMANJARI';
            const examDate = document.getElementById('examDate').value;
            const examTime = document.getElementById('examTime').value;
            const totalMarks = document.getElementById('totalMarks').value || '100';
            const watermark = document.getElementById('watermark').value;

            if (!schoolName || !examDate) {
                showNotification('Please fill in school name and exam date', 'warning');
                return;
            }

            if (selectedPaperQuestions.length === 0) {
                showNotification('Please select at least one question', 'warning');
                return;
            }

            showNotification('Generating PDF... Please wait', 'info');
            console.log('ðŸ“„ Generating PDF with', selectedPaperQuestions.length, 'questions');

            try {
                // Fetch selected questions
                const response = await fetch(`${API_BASE}/api/questions/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionIds: selectedPaperQuestions })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch questions');
                }

                const questions = await response.json();
                console.log('âœ… Fetched', questions.length, 'questions for PDF');

                // Generate PDF using html2canvas for better formatting
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let yPosition = 15;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const lineHeight = 6;
                const maxWidth = pageWidth - (margin * 2);

                // Helper function to check page break
                const checkPageBreak = (requiredSpace = 30) => {
                    if (yPosition > pageHeight - requiredSpace) {
                        doc.addPage();
                        yPosition = 15;
                        return true;
                    }
                    return false;
                };

                // Add header - GYANMANJARI style
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(schoolName.toUpperCase(), pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;

                // Add border line
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 8;

                // Paper details in table format
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Left column
                doc.text(`Subject`, margin, yPosition);
                doc.text(`: ${paperSubject.charAt(0).toUpperCase() + paperSubject.slice(1)}`, margin + 30, yPosition);
                
                // Center
                const paperTitle = selectedPdfOption === 'paper' ? 'Question Paper' : 
                                   selectedPdfOption === 'answers' ? 'Answer Key' : 'Solutions';
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text(paperTitle.toUpperCase(), pageWidth / 2, yPosition, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Right column
                doc.text(`Paper Set : 1`, pageWidth - margin - 35, yPosition);
                
                yPosition += 6;
                
                // Second row
                doc.text(`Standard`, margin, yPosition);
                doc.text(`: ${paperSubject === 'mathematics' ? '11' : '11'}`, margin + 30, yPosition);
                doc.text(`Date`, pageWidth - margin - 35, yPosition);
                doc.text(`: ${examDate}`, pageWidth - margin - 20, yPosition);
                
                yPosition += 6;
                
                // Third row
                doc.text(`Total Mark`, margin, yPosition);
                doc.text(`: ${totalMarks}`, margin + 30, yPosition);
                doc.text(`Time`, pageWidth - margin - 35, yPosition);
                doc.text(`: ${examTime}M`, pageWidth - margin - 20, yPosition);
                
                yPosition += 8;
                
                // Add border line
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;

                // Section header for questions
                if (selectedPdfOption !== 'answers') {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    const sectionTitle = `${paperSubject.charAt(0).toUpperCase() + paperSubject.slice(1)} - Section A (MCQ)`;
                    doc.text(sectionTitle, pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 8;
                }

                // For Answer Key - create table
                if (selectedPdfOption === 'answers') {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${paperSubject.charAt(0).toUpperCase() + paperSubject.slice(1)} - Section A (MCQ)`, pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 10;
                    
                    // Create answer key table
                    const cols = 10;
                    const cellWidth = (pageWidth - 2 * margin) / cols;
                    const cellHeight = 8;
                    
                    doc.setFontSize(9);
                    let currentCol = 0;
                    let currentRow = 0;
                    
                    questions.forEach((q, index) => {
                        if (currentCol === 0) {
                            checkPageBreak(cellHeight + 10);
                        }
                        
                        const x = margin + (currentCol * cellWidth);
                        const y = yPosition + (currentRow * cellHeight);
                        
                        // Draw cell border
                        doc.rect(x, y, cellWidth, cellHeight);
                        
                        // Add question number and answer
                        doc.setFont(undefined, 'normal');
                        doc.text(`${index + 1} - ${q.answer}`, x + cellWidth / 2, y + cellHeight / 2 + 1, { align: 'center' });
                        
                        currentCol++;
                        if (currentCol >= cols) {
                            currentCol = 0;
                            currentRow++;
                        }
                    });
                    
                    yPosition += (currentRow + 1) * cellHeight + 10;
                    
                } else {
                    // Add questions with formatting
                    doc.setFontSize(10);
                    
                    for (let index = 0; index < questions.length; index++) {
                        const q = questions[index];
                        
                        checkPageBreak(40);
                        
                        // Question number
                        doc.setFont(undefined, 'bold');
                        doc.text(`(${index + 1})`, margin, yPosition);
                        
                        // Question text with formatting
                        doc.setFont(undefined, 'normal');
                        const questionLines = doc.splitTextToSize(q.text || '', maxWidth - 10);
                        questionLines.forEach((line, lineIndex) => {
                            if (lineIndex > 0) checkPageBreak();
                            doc.text(line, margin + 8, yPosition);
                            yPosition += lineHeight;
                        });
                        
                        yPosition += 2;
                        
                        // Render question images if available
                        if (q.questionImages && q.questionImages.length > 0) {
                            for (const img of q.questionImages) {
                                checkPageBreak(60);
                                try {
                                    const imgData = img.data;
                                    if (imgData) {
                                        const imgWidth = 80;
                                        const imgHeight = 50;
                                        doc.addImage(imgData, 'PNG', margin + 10, yPosition, imgWidth, imgHeight);
                                        yPosition += imgHeight + 5;
                                    }
                                } catch (e) {
                                    console.log('Could not add question image:', e);
                                }
                            }
                        }
                        
                        // Options (for paper and solutions)
                        if (selectedPdfOption === 'paper' || selectedPdfOption === 'solutions') {
                            if (q.options && q.options.length > 0) {
                                q.options.forEach((option, optIndex) => {
                                    checkPageBreak();
                                    const optionLetter = String.fromCharCode(65 + optIndex);
                                    const isCorrect = optionLetter === q.answer;
                                    
                                    if (selectedPdfOption === 'solutions' && isCorrect) {
                                        doc.setFont(undefined, 'bold');
                                        doc.setTextColor(0, 128, 0);
                                    } else {
                                        doc.setFont(undefined, 'normal');
                                        doc.setTextColor(0, 0, 0);
                                    }
                                    
                                    const optionText = `(${optionLetter}) ${option}`;
                                    const optionLines = doc.splitTextToSize(optionText, maxWidth - 15);
                                    optionLines.forEach((line, lineIndex) => {
                                        if (lineIndex > 0) checkPageBreak();
                                        doc.text(line, margin + 10, yPosition);
                                        yPosition += lineHeight;
                                    });
                                });
                                
                                doc.setTextColor(0, 0, 0);
                                yPosition += 3;
                            }
                        }
                        
                        // Solution (only for solutions PDF)
                        if (selectedPdfOption === 'solutions') {
                            checkPageBreak(20);
                            
                            // Answer
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(0, 128, 0);
                            doc.text(`Solution: (Correct Answer: ${q.answer})`, margin + 10, yPosition);
                            yPosition += lineHeight;
                            doc.setTextColor(0, 0, 0);
                            
                            // Solution text
                            if (q.solution) {
                                doc.setFont(undefined, 'normal');
                                const solutionLines = doc.splitTextToSize(q.solution, maxWidth - 15);
                                solutionLines.forEach((line, lineIndex) => {
                                    if (lineIndex > 0) checkPageBreak();
                                    doc.text(line, margin + 10, yPosition);
                                    yPosition += lineHeight;
                                });
                                yPosition += 3;
                            }
                            
                            // Render solution images if available
                            if (q.solutionImages && q.solutionImages.length > 0) {
                                for (const img of q.solutionImages) {
                                    checkPageBreak(60);
                                    try {
                                        const imgData = img.data;
                                        if (imgData) {
                                            const imgWidth = 80;
                                            const imgHeight = 50;
                                            doc.addImage(imgData, 'PNG', margin + 15, yPosition, imgWidth, imgHeight);
                                            yPosition += imgHeight + 5;
                                        }
                                    } catch (e) {
                                        console.log('Could not add solution image:', e);
                                    }
                                }
                            }
                        }
                        
                        yPosition += 8; // Space between questions
                    }
                }

                // Save PDF
                const pdfType = selectedPdfOption === 'paper' ? 'Questions' : 
                               selectedPdfOption === 'answers' ? 'AnswerKey' : 'Solutions';
                const fileName = `${schoolName.replace(/\s+/g, '_')}_${paperSubject}_${pdfType}_${examDate.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF downloaded successfully! âœ…', 'success');
                console.log('âœ… PDF generated:', fileName);
            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        // DOM elements - will be initialized after DOM loads
        let authSection, dashboard, loginForm, userName, userRole, userAvatar, greetingName, logoutBtn, notification;

        // Load question bank data
        function loadQuestionBank() {
            console.log('ðŸ“š Loading question bank...');
            // Question bank loading logic here
        }

        // Load dashboard data
        function loadDashboardData() {
            console.log('ðŸ“Š Loading dashboard data...');
            // Dashboard data loading logic here
        }

        // Show specific section with enhanced debugging
        function showSection(sectionId) {
            if (!sectionId) {
                console.error('âŒ showSection called with null or undefined sectionId');
                return;
            }

            console.log('ðŸ”„ ===== SWITCHING TO SECTION =====');
            console.log('ðŸ“ Target Section ID:', sectionId);
            console.log('ðŸ‘¤ Current User:', currentUser);
            console.log('ðŸ”‘ User Role:', currentUser?.role);

            // Hide all sections
            const allSections = document.querySelectorAll('.section');
            console.log('ðŸ“‹ Total sections found:', allSections.length);

            allSections.forEach((section, index) => {
                console.log(`  - Section ${index + 1}: ${section.id} (hiding)`);
                section.classList.remove('active');
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                console.log('âœ… Section activated:', sectionId);
                console.log('ðŸ“ Section dimensions:', {
                    width: targetSection.offsetWidth,
                    height: targetSection.offsetHeight,
                    display: window.getComputedStyle(targetSection).display
                });

                // Load section-specific data with enhanced debugging
                switch (sectionId) {
                    case 'questionBankSection':
                        console.log('ðŸ“š Loading question bank section');
                        loadQuestionBank().catch(error => {
                            console.error('Error loading question bank:', error);
                            showNotification('Error loading question bank', 'error');
                        });
                        break;
                    case 'createTestSection':
                        console.log('ðŸ“ Loading create test section');
                        loadMockTestsInCreateSection(); // Load mock tests
                        break;
                    case 'makePaperSection':
                        console.log('ðŸ“„ Loading make paper section');
                        loadPaperQuestions(); // Load questions for paper
                        break;
                    case 'createPracticeTestSection':
                        console.log('âœï¸ Loading create practice test section');
                        // Reset practice test interface
                        document.getElementById('practiceTestConfig').style.display = 'block';
                        document.getElementById('practiceTestInterface').style.display = 'none';
                        break;
                    case 'dashboardSection':
                        console.log('ðŸ  Loading dashboard section');
                        loadDashboardData();
                        break;
                    case 'adminSection':
                        console.log('ðŸ”§ ===== LOADING ADMIN SECTION =====');

                        // Admin panel is now password-protected
                        console.log('ðŸ”‘ Admin panel access - password protection enabled');
                        showAdminPasswordPrompt();

                        // Debug admin section elements
                        const adminTabs = targetSection.querySelectorAll('.admin-tab');
                        const adminTabContents = targetSection.querySelectorAll('.admin-tab-content');

                        console.log('ðŸ” Admin section elements:');
                        console.log('  - Admin tabs found:', adminTabs.length);
                        console.log('  - Admin tab contents found:', adminTabContents.length);

                        // Initialize debug tools
                        initializeAdminPanelWithDebug();

                        // Load admin questions by default
                        setTimeout(() => {
                            console.log('ðŸ“š Loading admin questions...');
                            loadAdminQuestions();
                        }, 100);

                        console.log('ðŸ”§ ===== ADMIN SECTION LOADED =====');
                        break;
                    default:
                        console.log('ðŸ“„ Loading generic section:', sectionId);
                }

                // Update navigation button highlighting
                updateNavigationHighlight(sectionId);

                // Smooth scroll to top after section switch
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                    console.log('ðŸ“œ Scrolled to top');
                }, 100);

                console.log('ðŸ”„ ===== SECTION SWITCH COMPLETE =====');
            } else {
                console.error('âŒ ===== SECTION NOT FOUND =====');
                console.error('ðŸ” Searched for section ID:', sectionId);
                console.error('ðŸ“‹ Available sections:');

                document.querySelectorAll('.section').forEach((section, index) => {
                    console.error(`  - Section ${index + 1}: ${section.id}`);
                });

                showNotification(`Section "${sectionId}" not found!`, 'error');
            }
        }

        // Show dashboard
        function showDashboard() {
            console.log('ðŸ  Showing dashboard...');

            // Hide auth section if it exists
            if (authSection) {
                authSection.classList.add('hidden');
                authSection.style.display = 'none';
            }

            // Show dashboard section
            if (dashboard) {
                dashboard.classList.remove('hidden');
                dashboard.classList.add('active');
                dashboard.style.display = 'flex';
                console.log('âœ… Dashboard shown');
            }

            // Update user info if elements exist
            if (userName && currentUser) {
                userName.textContent = currentUser.username;
            }
            if (userRole && currentUser) {
                userRole.textContent = currentUser.role;
            }
            if (greetingName && currentUser) {
                greetingName.textContent = currentUser.username;
            }
            if (userAvatar && currentUser) {
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }



            // Show the dashboard section specifically
            showSection('dashboardSection');
        }







        // ==================== PRACTICE TEST FUNCTIONS ====================
        let practiceExamType = 'jee';
        let practiceSubject = 'Physics';
        let practiceQuestions = [];
        let currentPracticeIndex = 0;
        let practiceAnswers = {};
        let practiceScore = 0;

        function selectPracticeExamType(type) {
            practiceExamType = type;
            document.querySelectorAll('#createPracticeTestSection .exam-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.exam-type-tab').classList.add('active');
        }

        function selectPracticeSubject(subject) {
            practiceSubject = subject;
            document.querySelectorAll('#createPracticeTestSection .subject-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ==================== NEW PRACTICE TEST MODAL SYSTEM ====================
        
        // Custom Test Creation Variables
        let customTestExamType = 'jee';
        let customTestSubject = 'physics'; // lowercase to match database
        let customTestSelectionMode = 'auto'; // 'auto' or 'manual'
        let customTestSelectedQuestions = [];
        let customTestAllQuestions = [];

        // Open Create Custom Test Panel (Full Screen)
        function openCreatePracticeTestModal() {
            showSection('createCustomTestSection');
            // Load chapters when opening the section
            updateCustomTestChapterDropdown();
        }
        
        // Alias for compatibility
        function openCustomTestModal() {
            showSection('createCustomTestSection');
            // Load chapters when opening the section
            updateCustomTestChapterDropdown();
        }

        // Toggle between Auto and Manual selection
        function toggleCustomTestMode(mode) {
            customTestSelectionMode = mode;
            
            document.querySelectorAll('.selection-mode-btn').forEach(btn => {
                btn.style.borderColor = '#e2e8f0';
                btn.style.background = 'white';
                btn.style.color = '#374151';
            });
            
            if (mode === 'auto') {
                event.target.style.borderColor = '#10b981';
                event.target.style.background = '#10b981';
                event.target.style.color = 'white';
                document.getElementById('customTestAutoSelection').style.display = 'block';
                document.getElementById('customTestManualSelection').style.display = 'none';
            } else {
                event.target.style.borderColor = '#667eea';
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';
                document.getElementById('customTestAutoSelection').style.display = 'none';
                document.getElementById('customTestManualSelection').style.display = 'block';
                loadQuestionsForManualSelection();
            }
        }

        // Select exam type for custom test
        function selectCustomTestExamType(type) {
            customTestExamType = type;
            document.querySelectorAll('.custom-test-exam-tab').forEach(tab => {
                tab.style.borderColor = '#e2e8f0';
                tab.style.background = 'white';
            });
            event.target.closest('.custom-test-exam-tab').style.borderColor = '#667eea';
            event.target.closest('.custom-test-exam-tab').style.background = '#f0f4ff';
            
            // Update subjects based on exam type
            updateCustomTestSubjects(type);
            
            if (customTestSelectionMode === 'manual') {
                loadQuestionsForManualSelection();
            }
        }

        // Update subjects based on exam type
        function updateCustomTestSubjects(examType) {
            const subjectTabs = document.querySelectorAll('.custom-test-subject-tab');
            
            if (examType === 'jee') {
                // JEE: Physics, Chemistry, Mathematics
                subjectTabs.forEach((tab, index) => {
                    if (index === 0) { // Physics
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('physics');
                        tab.innerHTML = '<i class="fas fa-atom"></i> Physics';
                    } else if (index === 1) { // Chemistry
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('chemistry');
                        tab.innerHTML = '<i class="fas fa-flask"></i> Chemistry';
                    } else if (index === 2) { // Mathematics
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('mathematics');
                        tab.innerHTML = '<i class="fas fa-calculator"></i> Mathematics';
                    } else if (index === 3) { // Biology - hide for JEE
                        tab.style.display = 'none';
                    }
                });
                // Set default to physics
                if (customTestSubject === 'biology') {
                    customTestSubject = 'physics';
                    selectCustomTestSubject('physics');
                }
            } else if (examType === 'neet') {
                // NEET: Physics, Chemistry, Biology
                subjectTabs.forEach((tab, index) => {
                    if (index === 0) { // Physics
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('physics');
                        tab.innerHTML = '<i class="fas fa-atom"></i> Physics';
                    } else if (index === 1) { // Chemistry
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('chemistry');
                        tab.innerHTML = '<i class="fas fa-flask"></i> Chemistry';
                    } else if (index === 2) { // Biology
                        tab.style.display = 'block';
                        tab.onclick = () => selectCustomTestSubject('biology');
                        tab.innerHTML = '<i class="fas fa-dna"></i> Biology';
                    } else if (index === 3) { // Mathematics - hide for NEET
                        tab.style.display = 'none';
                    }
                });
                // Set default to physics
                if (customTestSubject === 'mathematics') {
                    customTestSubject = 'physics';
                    selectCustomTestSubject('physics');
                }
            }
        }

        // Select subject for custom test
        function selectCustomTestSubject(subject) {
            customTestSubject = subject;
            document.querySelectorAll('.custom-test-subject-tab').forEach(tab => {
                tab.style.borderColor = '#e2e8f0';
                tab.style.background = 'white';
                tab.style.color = '#374151';
            });
            event.target.style.borderColor = '#667eea';
            event.target.style.background = '#667eea';
            event.target.style.color = 'white';
            
            // Update chapter dropdown when subject changes
            updateCustomTestChapterDropdown();
            
            if (customTestSelectionMode === 'manual') {
                loadQuestionsForManualSelection();
            }
        }
        
        // Update chapter dropdown based on selected subject
        async function updateCustomTestChapterDropdown() {
            const chapterSelect = document.getElementById('customTestChapter');
            if (!chapterSelect) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/chapters', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.chapters) {
                    // Filter chapters by selected subject and exam type
                    const filteredChapters = data.chapters.filter(c => 
                        c.subject.toLowerCase() === customTestSubject.toLowerCase() &&
                        c.examType.toLowerCase() === customTestExamType.toLowerCase()
                    );
                    
                    // Update dropdown
                    chapterSelect.innerHTML = '<option value="">All Chapters</option>' + 
                        filteredChapters.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                    
                    console.log(`ðŸ“š Loaded ${filteredChapters.length} chapters for ${customTestSubject}`);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
            }
        }
        
        // Update negative marking display when marks per question changes
        function updateNegativeMarkingDisplay() {
            const marksPerQuestion = parseFloat(document.getElementById('customTestMarksPerQuestion')?.value) || 4;
            const negativeMarkingSelect = document.getElementById('customTestNegativeMarking')?.value;
            const infoElement = document.getElementById('negativeMarkingInfo');
            
            if (infoElement && negativeMarkingSelect === 'yes') {
                const negativeMarks = (marksPerQuestion * 0.25).toFixed(2);
                infoElement.innerHTML = `<i class="fas fa-info-circle"></i> Negative marking will be ${negativeMarks} marks (25% of ${marksPerQuestion} marks per question)`;
                infoElement.style.display = 'block';
            } else if (infoElement) {
                infoElement.style.display = 'none';
            }
        }
        
        // Update chapter options when subject is selected (for Add Question form)
        async function updateChapterOptions() {
            const subjectSelect = document.getElementById('qSubject');
            const chapterSelect = document.getElementById('qChapter');
            const examTypeSelect = document.getElementById('qExamType');
            
            if (!subjectSelect || !chapterSelect) {
                console.warn('âš ï¸ Subject or Chapter select not found');
                return;
            }
            
            const subject = subjectSelect.value;
            const examType = examTypeSelect?.value || 'jee';
            
            if (!subject) {
                chapterSelect.innerHTML = '<option value="">Select a subject first</option>';
                return;
            }
            
            try {
                console.log(`ðŸ“š Loading chapters for ${subject} (${examType})...`);
                const token = localStorage.getItem('token');
                const response = await fetch('/api/chapters', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.chapters) {
                    // Filter chapters by selected subject and exam type
                    const filteredChapters = data.chapters.filter(c => 
                        c.subject.toLowerCase() === subject.toLowerCase() &&
                        c.examType.toLowerCase() === examType.toLowerCase()
                    );
                    
                    if (filteredChapters.length > 0) {
                        chapterSelect.innerHTML = '<option value="">Select Chapter</option>' + 
                            filteredChapters.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        console.log(`âœ… Loaded ${filteredChapters.length} chapters for ${subject}`);
                    } else {
                        chapterSelect.innerHTML = '<option value="">No chapters available</option>';
                        console.log(`âš ï¸ No chapters found for ${subject} (${examType})`);
                    }
                } else {
                    chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
                    console.error('Failed to load chapters:', data.error);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
            }
        }
        
        // Update chapter options for Edit Question form
        async function updateEditChapterOptions() {
            const subjectSelect = document.getElementById('editQSubject');
            const chapterSelect = document.getElementById('editQChapter');
            const examTypeSelect = document.getElementById('editQExamType');
            
            if (!subjectSelect || !chapterSelect) {
                console.warn('âš ï¸ Edit form: Subject or Chapter select not found');
                return;
            }
            
            const subject = subjectSelect.value;
            const examType = examTypeSelect?.value || 'jee';
            
            if (!subject) {
                chapterSelect.innerHTML = '<option value="">Select a subject first</option>';
                return;
            }
            
            try {
                console.log(`ðŸ“š Loading chapters for edit form: ${subject} (${examType})...`);
                const token = localStorage.getItem('token');
                const response = await fetch('/api/chapters', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.chapters) {
                    // Filter chapters by selected subject and exam type
                    const filteredChapters = data.chapters.filter(c => 
                        c.subject.toLowerCase() === subject.toLowerCase() &&
                        c.examType.toLowerCase() === examType.toLowerCase()
                    );
                    
                    if (filteredChapters.length > 0) {
                        chapterSelect.innerHTML = '<option value="">Select Chapter</option>' + 
                            filteredChapters.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        console.log(`âœ… Loaded ${filteredChapters.length} chapters for ${subject}`);
                    } else {
                        chapterSelect.innerHTML = '<option value="">No chapters available</option>';
                        console.log(`âš ï¸ No chapters found for ${subject} (${examType})`);
                    }
                } else {
                    chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
                    console.error('Failed to load chapters:', data.error);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
            }
        }
        
        // Load chapters from API (for enhanced form)
        async function loadChaptersFromAPI(examType, subject) {
            try {
                // Validate and encode parameters
                const validExamType = String(examType || 'jee').trim();
                const validSubject = String(subject || 'physics').trim();
                
                console.log(`ðŸ“š Loading chapters for examType="${validExamType}" subject="${validSubject}"`);
                
                // Build URL with proper encoding
                const baseUrl = '/api/chapters';
                const params = new URLSearchParams({
                    examType: validExamType,
                    subject: validSubject
                });
                const url = `${baseUrl}?${params.toString()}`;
                
                console.log(`ðŸ”— Full URL: ${url}`);
                console.log(`ðŸ”— URL type: ${typeof url}`);
                console.log(`ðŸ”— URL length: ${url.length}`);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || localStorage.getItem('token') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`ðŸ“¡ Response status: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`ðŸ“Š Response data:`, data);

                if (data.success && data.chapters) {
                    // Always add "Mixed" option at the beginning
                    const chapters = [
                        { id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' },
                        ...data.chapters.map(chapter => ({
                            id: chapter._id,
                            name: chapter.name,
                            icon: chapter.icon || 'fa-book'
                        }))
                    ];

                    console.log(`âœ… Loaded ${data.chapters.length} chapters`);
                    return chapters;
                } else {
                    console.error('âŒ Failed to load chapters:', data.error || 'Unknown error');
                    return [{ id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' }];
                }
            } catch (error) {
                console.error('âŒ Error loading chapters from API:', error);
                console.error('âŒ Error stack:', error.stack);
                return [{ id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' }];
            }
        }
        
        // Update chapter dropdown for enhanced form
        async function updateEnhancedChapterDropdown() {
            try {
                const examType = 'jee'; // Default value
                const subject = document.getElementById('enhancedSubject')?.value || 'physics';
                
                console.log(`ðŸ“š updateEnhancedChapterDropdown called for: ${examType} - ${subject}`);

                // Load chapters from API
                const chapters = await loadChaptersFromAPI(examType, subject);
                console.log(`ðŸ“Š Received ${chapters.length} chapters:`, chapters);
                
                const chapterList = document.getElementById('chapterList');

                if (!chapterList) {
                    console.error('âŒ chapterList element not found in DOM');
                    return;
                }

                chapterList.innerHTML = '';
                console.log('âœ… Cleared chapterList, adding chapters...');

                chapters.forEach((chapter, index) => {
                    const chapterOption = document.createElement('div');
                    chapterOption.className = 'chapter-option';
                    chapterOption.setAttribute('data-chapter-id', chapter.id);
                    chapterOption.innerHTML = `
                        <div class="chapter-option-content" onclick="selectChapter('${chapter.id}', '${chapter.name}')">
                            <div class="chapter-option-icon">
                                <i class="fas ${chapter.icon}"></i>
                            </div>
                            <div class="chapter-option-text">${chapter.name}</div>
                        </div>
                        ${chapter.id !== 'mixed' ? `
                            <div class="chapter-option-actions">
                                <button class="chapter-delete-btn" onclick="deleteChapter('${chapter.id}', '${chapter.name}')" title="Delete Chapter">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    `;
                    chapterList.appendChild(chapterOption);
                    console.log(`  âœ“ Added chapter ${index + 1}: ${chapter.name}`);
                });
                
                console.log(`âœ… Successfully populated ${chapters.length} chapters in dropdown`);
            } catch (error) {
                console.error('âŒ Error in updateChapterDropdown:', error);
            }
        }
        
        // Select chapter in enhanced form
        function selectChapter(chapterId, chapterName) {
            const selected = document.querySelector('.chapter-selected');
            const chapterText = selected?.querySelector('.chapter-text');
            const chapterIcon = selected?.querySelector('.chapter-icon');
            const hiddenInput = document.getElementById('enhancedChapter');
            const options = document.getElementById('chapterOptions');

            if (!hiddenInput) {
                console.error('âŒ enhancedChapter input not found');
                return;
            }

            // Update display
            if (chapterText) chapterText.textContent = chapterName;
            if (chapterIcon) chapterIcon.className = 'fas fa-book chapter-icon';
            hiddenInput.value = chapterName;

            // Update selected state
            document.querySelectorAll('.chapter-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-chapter-id="${chapterId}"]`)?.classList.add('selected');

            // Close dropdown
            if (options) options.classList.remove('show');
            if (selected) selected.classList.remove('active');

            // Trigger validation
            hiddenInput.dispatchEvent(new Event('change'));
            
            console.log(`âœ… Selected chapter: ${chapterName}`);
        }
        
        // Setup chapter loading for enhanced question form
        function setupEnhancedChapterLoading() {
            const subjectSelect = document.getElementById('enhancedSubject');
            
            if (subjectSelect) {
                console.log('âœ… Setting up enhanced form chapter loading');
                
                // Load chapters when modal opens
                updateEnhancedChapterDropdown();
            } else {
                console.warn('âš ï¸ Enhanced form subject select not found');
            }
        }
        
        // Load chapters for enhanced question form
        async function loadEnhancedChapters(subject) {
            const chapterSelect = document.getElementById('enhancedChapter');
            
            if (!chapterSelect) {
                console.error('âŒ Enhanced chapter select not found');
                return;
            }
            
            if (!subject) {
                chapterSelect.innerHTML = '<option value="">Select a subject first</option>';
                return;
            }
            
            try {
                console.log(`ðŸ“š Loading chapters for enhanced form: ${subject}...`);
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch('/api/chapters', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.chapters) {
                    // Filter chapters by selected subject (default to JEE)
                    const filteredChapters = data.chapters.filter(c => 
                        c.subject.toLowerCase() === subject.toLowerCase() &&
                        c.examType.toLowerCase() === 'jee'
                    );
                    
                    if (filteredChapters.length > 0) {
                        chapterSelect.innerHTML = '<option value="">Select a chapter</option>' + 
                            filteredChapters.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        console.log(`âœ… Loaded ${filteredChapters.length} chapters for ${subject}`);
                        showNotification(`Loaded ${filteredChapters.length} chapters`, 'success');
                    } else {
                        chapterSelect.innerHTML = '<option value="">No chapters available</option>';
                        console.log(`âš ï¸ No chapters found for ${subject}`);
                        showNotification(`No chapters found for ${subject}`, 'warning');
                    }
                } else {
                    chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
                    console.error('Failed to load chapters:', data.error);
                }
            } catch (error) {
                console.error('Error loading enhanced chapters:', error);
                chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
                showNotification('Error loading chapters', 'error');
            }
        }
        
        // Toggle chapter dropdown (for UI interactions)
               function toggleChapterDropdown() {
            const options = document.getElementById('chapterOptions');
            const selected = document.querySelector('.chapter-selected');

            // Close other dropdowns
            document.querySelectorAll('.role-options').forEach(opt => {
                opt.classList.remove('show');
                opt.parentElement.querySelector('.role-selected').classList.remove('active');
            });

            // Toggle current dropdown
            const isOpen = options.classList.contains('show');
            if (isOpen) {
                options.classList.remove('show');
                selected.classList.remove('active');
            } else {
                options.classList.add('show');
                selected.classList.add('active');
                // Focus search input
                setTimeout(() => {
                    document.getElementById('chapterSearch').focus();
                }, 100);
            }
        }

        async function updateChapterDropdown() {
            const examType = 'jee'; // Default value
            const subject = document.getElementById('enhancedSubject')?.value || 'physics';

            // Load chapters from API
            const chapters = await loadChaptersFromAPI(examType, subject);
            const chapterList = document.getElementById('chapterList');

            if (!chapterList) return;

            chapterList.innerHTML = '';

            chapters.forEach(chapter => {
                const chapterOption = document.createElement('div');
                chapterOption.className = 'chapter-option';
                chapterOption.setAttribute('data-chapter-id', chapter.id);
                chapterOption.innerHTML = `
                    <div class="chapter-option-content" onclick="selectChapter('${chapter.id}', '${chapter.name}')">
                        <div class="chapter-option-icon">
                            <i class="fas ${chapter.icon}"></i>
                        </div>
                        <div class="chapter-option-text">${chapter.name}</div>
                    </div>
                    ${chapter.id !== 'mixed' ? `
                        <div class="chapter-option-actions">
                            <button class="chapter-delete-btn" onclick="deleteChapter('${chapter.id}', '${chapter.name}')" title="Delete Chapter">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : ''}
                `;
                chapterList.appendChild(chapterOption);
            });
        }

        function selectChapter(chapterId, chapterName) {
            const selected = document.querySelector('.chapter-selected');
            const chapterText = selected.querySelector('.chapter-text');
            const chapterIcon = selected.querySelector('.chapter-icon');
            const hiddenInput = document.getElementById('enhancedChapter');
            const options = document.getElementById('chapterOptions');

            // Update display
            chapterText.textContent = chapterName;
            chapterIcon.className = 'fas fa-book chapter-icon';
            hiddenInput.value = chapterName;

            // Update selected state
            document.querySelectorAll('.chapter-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-chapter-id="${chapterId}"]`)?.classList.add('selected');

            // Close dropdown
            options.classList.remove('show');
            selected.classList.remove('active');

            // Trigger validation
            hiddenInput.dispatchEvent(new Event('change'));
        }

        function filterChapters() {
            const searchTerm = document.getElementById('chapterSearch').value.toLowerCase();
            const chapterOptions = document.querySelectorAll('.chapter-option');

            chapterOptions.forEach(option => {
                const chapterName = option.querySelector('.chapter-option-text').textContent.toLowerCase();
                if (chapterName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        async function deleteChapter(chapterId, chapterName) {
            if (confirm(`Are you sure you want to delete the chapter "${chapterName}"? This action cannot be undone.`)) {
                try {
                    console.log(`ðŸ—‘ï¸ Deleting chapter: ${chapterName} (ID: ${chapterId})`);

                    const response = await fetch(`${API_BASE}/api/chapters/${chapterId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update dropdown
                        await updateChapterDropdown();

                        // Clear selection if deleted chapter was selected
                        const hiddenInput = document.getElementById('enhancedChapter');
                        if (hiddenInput.value === chapterName) {
                            const selected = document.querySelector('.chapter-selected');
                            const chapterText = selected.querySelector('.chapter-text');
                            chapterText.textContent = 'Select a chapter';
                            hiddenInput.value = '';
                        }

                        showNotification(`âœ… Chapter "${chapterName}" deleted successfully`, 'success');
                        console.log('âœ… Chapter deleted successfully');
                    } else {
                        showNotification(`âŒ Error: ${data.error}`, 'error');
                        console.error('âŒ Error deleting chapter:', data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error deleting chapter:', error);
                    showNotification('âŒ Failed to delete chapter. Please try again.', 'error');
                }
            }
        }

        // Clear all chapters for current subject
        async function clearAllChapters() {
            const examType = 'jee'; // Default value
            const subject = document.getElementById('enhancedSubject')?.value || 'physics';

            if (confirm(`Are you sure you want to clear ALL chapters for ${examType.toUpperCase()} ${subject.charAt(0).toUpperCase() + subject.slice(1)}? This action cannot be undone.`)) {
                try {
                    console.log(`ðŸ—‘ï¸ Clearing all chapters for ${examType} - ${subject}`);

                    const response = await fetch(`${API_BASE}/api/chapters/clear?examType=${examType}&subject=${subject}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update dropdown
                        await updateChapterDropdown();

                        // Clear selection
                        const hiddenInput = document.getElementById('enhancedChapter');
                        const selected = document.querySelector('.chapter-selected');
                        const chapterText = selected.querySelector('.chapter-text');
                        chapterText.textContent = 'Select a chapter';
                        hiddenInput.value = '';

                        showNotification(`âœ… All chapters cleared for ${examType.toUpperCase()} ${subject.charAt(0).toUpperCase() + subject.slice(1)}`, 'success');
                        console.log('âœ… All chapters cleared successfully');
                    } else {
                        showNotification(`âŒ Error: ${data.error}`, 'error');
                        console.error('âŒ Error clearing chapters:', data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error clearing chapters:', error);
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        showNotification('âŒ Server not accessible. Please ensure you are accessing the app through the correct server URL.', 'error');
                    } else {
                        showNotification('âŒ Failed to clear chapters. Please try again.', 'error');
                    }
                }
            }
        }

        // Clear ALL chapters from database (admin only)
        async function clearAllChaptersFromDatabase() {
            if (confirm('âš ï¸ DANGER: This will permanently delete ALL chapters from the database for ALL subjects and exam types. This action cannot be undone. Are you absolutely sure?')) {
                try {
                    console.log('ðŸ—‘ï¸ Clearing ALL chapters from database...');

                    const response = await fetch('/api/admin/chapters/clear-all', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update dropdown
                        await updateChapterDropdown();

                        showNotification(`âœ… All chapters deleted from database (${data.deletedCount} chapters)`, 'success');
                        console.log('âœ… All chapters cleared from database');
                    } else {
                        showNotification(`âŒ Error: ${data.error}`, 'error');
                        console.error('âŒ Error clearing all chapters:', data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error clearing all chapters:', error);
                    showNotification('âŒ Failed to clear all chapters. Please try again.', 'error');
                }
            }
        }


        // Populate chapter filter based on loaded questions
        function populateChapterFilter() {
            const chapterFilter = document.getElementById('manualChapterFilter');
            if (!chapterFilter) return;
            
            // Safety check for customTestAllQuestions
            if (!customTestAllQuestions || !Array.isArray(customTestAllQuestions)) {
                console.warn('âš ï¸ customTestAllQuestions is not defined or not an array');
                chapterFilter.innerHTML = '<option value="all">All Chapters</option>';
                return;
            }
            
            // Get unique chapters
            const chapters = [...new Set(customTestAllQuestions.map(q => q.chapter).filter(c => c))];
            chapters.sort();
            
            // Populate dropdown
            chapterFilter.innerHTML = `
                <option value="all">All Chapters</option>
                ${chapters.map(chapter => `<option value="${chapter}">${chapter}</option>`).join('')}
            `;
            
            console.log('ðŸ“š Populated chapter filter with', chapters.length, 'chapters');
        }

        // Filter questions by chapter and difficulty
        function filterManualQuestions() {
            const chapterFilter = document.getElementById('manualChapterFilter')?.value || '';
            const difficultyFilter = document.getElementById('manualDifficultyFilter')?.value || '';
            
            console.log('ðŸ” Filtering:', { chapter: chapterFilter, difficulty: difficultyFilter });
            
            // Safety check for customTestAllQuestions
            if (!customTestAllQuestions || !Array.isArray(customTestAllQuestions)) {
                console.warn('âš ï¸ customTestAllQuestions is not defined or not an array');
                renderFilteredQuestions([]);
                return;
            }
            
            let filteredQuestions = [...customTestAllQuestions];
            
            // Filter by chapter
            if (chapterFilter && chapterFilter !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.chapter && q.chapter.toLowerCase() === chapterFilter.toLowerCase()
                );
            }
            
            // Filter by difficulty
            if (difficultyFilter && difficultyFilter !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.difficulty && q.difficulty.toLowerCase() === difficultyFilter.toLowerCase()
                );
            }
            
            console.log(`âœ… Filtered: ${filteredQuestions.length} of ${customTestAllQuestions.length} questions`);
            
            // Update the display with filtered questions
            renderFilteredQuestions(filteredQuestions);
        }

        // Render filtered questions
        function renderFilteredQuestions(questions) {
            const container = document.getElementById('manualQuestionsList');
            
            if (!container) {
                console.error('âŒ manualQuestionsList container not found!');
                return;
            }
            
            // Safety check for questions array
            if (!questions || !Array.isArray(questions)) {
                console.warn('âš ï¸ questions is not defined or not an array');
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No questions available</p>';
                return;
            }
            
            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No questions match the selected filters</p>';
                return;
            }
            
            // Use the same rendering logic but with filtered questions
            container.innerHTML = questions.map((q, index) => {
                const isSelected = customTestSelectedQuestions.includes(q._id);
                const formattedText = formatQuestionText(q.text);
                
                let questionImage = '';
                if (q.image) questionImage = q.image;
                else if (q.questionImage) questionImage = q.questionImage;
                else if (q.media && q.media.length > 0 && q.media[0].data) questionImage = q.media[0].data;
                
                const optionsHTML = q.options && q.options.length > 0 ? `
                    <div style="margin-top: 0.75rem; padding-left: 1.5rem;">
                        ${q.options.map((opt, optIndex) => {
                            const optionLabel = String.fromCharCode(65 + optIndex);
                            const formattedOption = formatQuestionText(opt);
                            return `
                                <div style="margin-bottom: 0.5rem; display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-weight: 600; color: #667eea; min-width: 25px;">${optionLabel})</span>
                                    <span class="tex2jax_process" style="color: #374151;">${formattedOption}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '';
                
                return `
                    <div class="question-select-item" data-question-id="${q._id}" style="padding: 1.25rem; border: 2px solid ${isSelected ? '#10b981' : '#e2e8f0'}; background: ${isSelected ? '#f0fdf4' : 'white'}; border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <input type="checkbox" id="q_${q._id}" ${isSelected ? 'checked' : ''} style="margin-top: 0.25rem; width: 20px; height: 20px; cursor: pointer; pointer-events: none;">
                            <div style="flex: 1; pointer-events: none;">
                                <div class="question-text-full" style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; line-height: 1.6; font-size: 1rem;">
                                    <span style="color: #667eea; margin-right: 0.5rem; font-size: 1.1rem;">Q${index + 1}.</span>
                                    <span class="tex2jax_process">${formattedText}</span>
                                </div>
                                ${questionImage ? `<img src="${questionImage}" style="max-width: 400px; height: auto; margin: 0.75rem 0; border-radius: 8px; border: 1px solid #e2e8f0; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">` : ''}
                                ${optionsHTML}
                                <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #6b7280; flex-wrap: wrap; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0;">
                                    <span><i class="fas fa-book"></i> ${q.chapter || 'N/A'}</span>
                                    <span><i class="fas fa-signal"></i> ${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}</span>
                                    ${q.answer ? `<span style="color: #10b981; font-weight: 600;"><i class="fas fa-check-circle"></i> Answer: ${q.answer}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click event listeners
            setTimeout(() => {
                document.querySelectorAll('.question-select-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question-id');
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        
                        if (checkbox.checked) {
                            if (!customTestSelectedQuestions.includes(questionId)) {
                                customTestSelectedQuestions.push(questionId);
                                this.style.borderColor = '#10b981';
                                this.style.background = '#f0fdf4';
                            }
                        } else {
                            customTestSelectedQuestions = customTestSelectedQuestions.filter(id => id !== questionId);
                            this.style.borderColor = '#e2e8f0';
                            this.style.background = 'white';
                        }
                        
                        const counter = document.getElementById('selectedQuestionCount');
                        if (counter) counter.textContent = customTestSelectedQuestions.length;
                    });
                });
                
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
                }
            }, 100);
        }

        // Load questions for manual selection
        async function loadQuestionsForManualSelection() {
            try {
                const container = document.getElementById('manualQuestionsList');
                container.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i><p style="margin-top: 1rem; color: #6b7280;">Loading questions...</p></div>';
                
                console.log('ðŸ” Loading questions for:', customTestExamType, customTestSubject);
                
                const response = await fetch(`${API_BASE}/api/questions?examType=${customTestExamType}&subject=${customTestSubject}`);
                const data = await response.json();
                
                console.log('ðŸ“Š Questions loaded:', data);
                
                if (data.success && data.questions && data.questions.length > 0) {
                    customTestAllQuestions = data.questions;
                    showNotification(`âœ… Loaded ${data.questions.length} questions`, 'success');
                    
                    // Populate chapter filter
                    populateChapterFilter();
                    
                    // Render all questions initially
                    renderFilteredQuestions(customTestAllQuestions);
                } else {
                    const subjectDisplay = customTestSubject.charAt(0).toUpperCase() + customTestSubject.slice(1);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No questions available for ${customTestExamType.toUpperCase()} ${subjectDisplay}</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Try selecting a different subject or add questions in admin panel</p>
                        </div>
                    `;
                    showNotification('No questions found', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error loading questions:', error);
                const container = document.getElementById('manualQuestionsList');
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <i class="fas fa-times-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Error loading questions</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
                showNotification('Error loading questions', 'error');
            }
        }

        // Format question text with LaTeX, formatting, and images
        function formatQuestionText(text) {
            if (!text) return '';
            
            // Simply use preserveLineBreaks which already handles everything correctly
            return preserveLineBreaks(text);
        }

        // Render manual question selection interface
        function renderManualQuestionSelection() {
            const container = document.getElementById('manualQuestionsList');
            
            if (!container) {
                console.error('âŒ manualQuestionsList container not found!');
                return;
            }
            
            if (customTestAllQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No questions available</p>';
                return;
            }
            
            console.log(`ðŸ“ Rendering ${customTestAllQuestions.length} questions`);
            
            container.innerHTML = customTestAllQuestions.map((q, index) => {
                const isSelected = customTestSelectedQuestions.includes(q._id);
                const formattedText = formatQuestionText(q.text);
                
                // Check for images in different fields
                let questionImage = '';
                if (q.image) {
                    questionImage = q.image;
                } else if (q.questionImage) {
                    questionImage = q.questionImage;
                } else if (q.media && q.media.length > 0 && q.media[0].data) {
                    questionImage = q.media[0].data;
                }
                
                // Render options
                const optionsHTML = q.options && q.options.length > 0 ? `
                    <div style="margin-top: 0.75rem; padding-left: 1.5rem;">
                        ${q.options.map((opt, optIndex) => {
                            const optionLabel = String.fromCharCode(65 + optIndex); // A, B, C, D
                            const formattedOption = formatQuestionText(opt);
                            return `
                                <div style="margin-bottom: 0.5rem; display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-weight: 600; color: #667eea; min-width: 25px;">${optionLabel})</span>
                                    <span class="tex2jax_process" style="color: #374151;">${formattedOption}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '';
                
                return `
                    <div class="question-select-item" data-question-id="${q._id}" style="padding: 1.25rem; border: 2px solid ${isSelected ? '#10b981' : '#e2e8f0'}; background: ${isSelected ? '#f0fdf4' : 'white'}; border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <input type="checkbox" id="q_${q._id}" ${isSelected ? 'checked' : ''} style="margin-top: 0.25rem; width: 20px; height: 20px; cursor: pointer; pointer-events: none;">
                            <div style="flex: 1; pointer-events: none;">
                                <!-- Question Number and Text -->
                                <div class="question-text-full" style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; line-height: 1.6; font-size: 1rem;">
                                    <span style="color: #667eea; margin-right: 0.5rem; font-size: 1.1rem;">Q${index + 1}.</span>
                                    <span class="tex2jax_process">${formattedText}</span>
                                </div>
                                
                                <!-- Question Image -->
                                ${questionImage ? `<img src="${questionImage}" style="max-width: 400px; height: auto; margin: 0.75rem 0; border-radius: 8px; border: 1px solid #e2e8f0; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">` : ''}
                                
                                <!-- Options -->
                                ${optionsHTML}
                                
                                <!-- Metadata -->
                                <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #6b7280; flex-wrap: wrap; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0;">
                                    <span><i class="fas fa-layer-group"></i> Class ${q.class || 'N/A'}</span>
                                    <span><i class="fas fa-book"></i> ${q.chapter || 'N/A'}</span>
                                    <span><i class="fas fa-signal"></i> ${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}</span>
                                    ${q.tags && q.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${q.tags.slice(0, 2).join(', ')}</span>` : ''}
                                    ${q.answer ? `<span style="color: #10b981; font-weight: 600;"><i class="fas fa-check-circle"></i> Answer: ${q.answer}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const countElement = document.getElementById('selectedQuestionCount');
            if (countElement) {
                countElement.textContent = customTestSelectedQuestions.length;
            }
            
            // Add click event listeners to question cards
            setTimeout(() => {
                document.querySelectorAll('.question-select-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question-id');
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        
                        // Toggle checkbox
                        checkbox.checked = !checkbox.checked;
                        
                        if (checkbox.checked) {
                            if (!customTestSelectedQuestions.includes(questionId)) {
                                customTestSelectedQuestions.push(questionId);
                                this.style.borderColor = '#10b981';
                                this.style.background = '#f0fdf4';
                            }
                        } else {
                            customTestSelectedQuestions = customTestSelectedQuestions.filter(id => id !== questionId);
                            this.style.borderColor = '#e2e8f0';
                            this.style.background = 'white';
                        }
                        
                        // Update counter
                        const counter = document.getElementById('selectedQuestionCount');
                        if (counter) {
                            counter.textContent = customTestSelectedQuestions.length;
                        }
                    });
                });
                
                // Render LaTeX after DOM update
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
                }
            }, 100);
        }

        // Toggle question selection
        function toggleQuestionSelection(questionId, element, event) {
            // Prevent event bubbling if clicking on checkbox directly
            if (event && event.target.type === 'checkbox') {
                event.stopPropagation();
            }
            
            const checkbox = element.querySelector('input[type="checkbox"]');
            
            // Toggle checkbox
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!customTestSelectedQuestions.includes(questionId)) {
                    customTestSelectedQuestions.push(questionId);
                    element.style.borderColor = '#10b981';
                    element.style.background = '#f0fdf4';
                }
            } else {
                customTestSelectedQuestions = customTestSelectedQuestions.filter(id => id !== questionId);
                element.style.borderColor = '#e2e8f0';
                element.style.background = 'white';
            }
            
            // Update counter
            const countElement = document.getElementById('selectedQuestionCount');
            if (countElement) {
                countElement.textContent = customTestSelectedQuestions.length;
            }
        }

        // Test Configuration Object
        let currentTestConfig = {
            marksPerQuestion: 1,
            hasNegativeMarking: false,
            negativeMarkingPercent: 25,
            negativeMarksPerQuestion: 0,
            totalQuestions: 0,
            totalMarks: 0,
            duration: 60
        };

        // Create and save custom test
        async function createAndSaveCustomTest() {
            const name = document.getElementById('customTestName').value.trim();
            const duration = parseInt(document.getElementById('customTestDuration').value) || 60;
            const marksPerQuestion = parseFloat(document.getElementById('customTestMarksPerQuestion').value) || 1;
            const negativeMarkingSelect = document.getElementById('customTestNegativeMarking').value;
            const hasNegativeMarking = negativeMarkingSelect === 'yes';
            const negativeMarkingPercent = 25; // Fixed at 25%
            
            if (!name) {
                showNotification('Please enter a test name', 'warning');
                return;
            }
            
            try {
                showNotification('Creating custom test...', 'info');
                
                let questionIds = [];
                
                if (customTestSelectionMode === 'auto') {
                    // Auto mode - fetch questions
                    const questionCount = parseInt(document.getElementById('customTestQuestionCount').value);
                    const difficulty = document.getElementById('customTestDifficulty').value;
                    const chapter = document.getElementById('customTestChapter')?.value || '';
                    
                    // Build query - don't include difficulty if it's "mixed"
                    let queryParams = `examType=${customTestExamType}&subject=${customTestSubject}`;
                    if (difficulty !== 'mixed') {
                        queryParams += `&difficulty=${difficulty}`;
                    }
                    if (chapter) {
                        queryParams += `&chapter=${encodeURIComponent(chapter)}`;
                    }
                    
                    console.log('ðŸ” Fetching questions with:', queryParams);
                    
                    const response = await fetch(`${API_BASE}/api/questions?${queryParams}`);
                    const data = await response.json();
                    
                    console.log('ðŸ“Š API Response:', data);
                    
                    if (!data.success || !data.questions || data.questions.length === 0) {
                        const subjectDisplay = customTestSubject.charAt(0).toUpperCase() + customTestSubject.slice(1);
                        const chapterInfo = chapter ? ` (Chapter: ${chapter})` : '';
                        throw new Error(`No questions found for ${customTestExamType.toUpperCase()} ${subjectDisplay}${chapterInfo}. Please add questions in admin panel.`);
                    }
                    
                    // Shuffle and take only the requested number
                    const shuffled = data.questions.sort(() => 0.5 - Math.random());
                    questionIds = shuffled.slice(0, questionCount).map(q => q._id);
                    
                    console.log(`âœ… Selected ${questionIds.length} questions`);
                } else {
                    // Manual mode - use selected questions
                    if (customTestSelectedQuestions.length === 0) {
                        showNotification('Please select at least one question', 'warning');
                        return;
                    }
                    questionIds = customTestSelectedQuestions;
                }
                
                // Calculate test configuration
                const totalQuestions = questionIds.length;
                const totalMarks = totalQuestions * marksPerQuestion;
                const negativeMarksPerQuestion = hasNegativeMarking ? (marksPerQuestion * negativeMarkingPercent / 100) : 0;
                
                // Store configuration for later use
                currentTestConfig = {
                    marksPerQuestion: marksPerQuestion,
                    hasNegativeMarking: hasNegativeMarking,
                    negativeMarkingPercent: negativeMarkingPercent,
                    negativeMarksPerQuestion: negativeMarksPerQuestion,
                    totalQuestions: totalQuestions,
                    totalMarks: totalMarks,
                    duration: duration
                };
                
                console.log('ðŸ“Š Test Configuration:', currentTestConfig);
                
                // Save to database
                const saveResponse = await fetch('/api/practice-tests', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        name,
                        examType: customTestExamType,
                        subject: customTestSubject,
                        difficulty: customTestSelectionMode === 'auto' ? document.getElementById('customTestDifficulty').value : 'mixed',
                        questionCount: questionIds.length,
                        duration: duration,
                        marksPerQuestion: marksPerQuestion,
                        hasNegativeMarking: hasNegativeMarking,
                        negativeMarkingPercent: negativeMarkingPercent,
                        totalMarks: totalMarks,
                        questionIds: questionIds,
                        selectionMode: customTestSelectionMode
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    showNotification('âœ… Custom test created successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('customTestName').value = '';
                    customTestSelectedQuestions = [];
                    
                    // Close panel and show dashboard
                    showSection('dashboardSection');
                    
                    // Reload personal tests
                    loadPersonalTests();
                } else {
                    throw new Error(saveData.error || 'Failed to save test');
                }
            } catch (error) {
                console.error('Error creating custom test:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        // Create and save practice test to database
        async function createAndSavePracticeTest() {
            const name = document.getElementById('practiceTestName').value.trim();
            const examType = document.getElementById('modalPracticeExamType').value;
            const subject = document.getElementById('modalPracticeSubject').value;
            const questionCount = parseInt(document.getElementById('modalPracticeQuestionCount').value);
            const difficulty = document.getElementById('modalPracticeDifficulty').value;
            
            if (!name) {
                showNotification('Please enter a test name', 'warning');
                return;
            }
            
            try {
                showNotification('Creating practice test...', 'info');
                
                // Fetch questions
                const response = await fetch(`${API_BASE}/api/questions?examType=${examType}&subject=${subject}&difficulty=${difficulty}&limit=${questionCount}`);
                const data = await response.json();
                
                if (!data.success || !data.questions || data.questions.length === 0) {
                    throw new Error('No questions found for this configuration');
                }
                
                // Save to database
                const saveResponse = await fetch('/api/practice-tests', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        name,
                        examType,
                        subject,
                        difficulty,
                        questionCount,
                        questionIds: data.questions.map(q => q._id)
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    showNotification('âœ… Practice test created successfully!', 'success');
                    document.querySelector('.modal-overlay').remove();
                    loadPracticeTests(); // Reload the list
                } else {
                    throw new Error(saveData.error || 'Failed to save test');
                }
            } catch (error) {
                console.error('Error creating practice test:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        // Load practice tests (display after mock tests)
        async function loadPracticeTests() {
            try {
                const response = await fetch('/api/practice-tests');
                const data = await response.json();
                
                if (data.success && data.tests && data.tests.length > 0) {
                    const container = document.getElementById('mockTestsDisplay');
                    
                    // Add practice tests after mock tests
                    data.tests.forEach(test => {
                        const card = document.createElement('div');
                        card.className = 'mock-test-card';
                        card.style.border = '2px solid #10b981';
                        card.innerHTML = `
                            <div class="mock-test-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <h3><i class="fas fa-clipboard-check"></i> ${test.name}</h3>
                                <span class="test-badge">PRACTICE</span>
                            </div>
                            <div class="mock-test-body">
                                <p><i class="fas fa-graduation-cap"></i> ${test.examType.toUpperCase()}</p>
                                <p><i class="fas fa-book"></i> ${test.subject}</p>
                                <p><i class="fas fa-question-circle"></i> ${test.questionCount} Questions</p>
                                <p><i class="fas fa-signal"></i> ${test.difficulty.charAt(0).toUpperCase() + test.difficulty.slice(1)}</p>
                            </div>
                            <div class="mock-test-footer">
                                <button class="btn btn-primary btn-sm" onclick="startSavedPracticeTest('${test._id}')">
                                    <i class="fas fa-play"></i> Start Test
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletePracticeTest('${test._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading practice tests:', error);
            }
        }

        // Start a saved practice test (opens like mock test)
        async function startSavedPracticeTest(testId) {
            try {
                console.log('ðŸš€ Starting practice test:', testId);
                showNotification('ðŸš€ Loading your test...', 'info');
                
                // Fetch practice test from database
                const response = await fetch(`${API_BASE}/api/practice-tests/${testId}`);
                const data = await response.json();
                
                console.log('ðŸ“Š Practice test data:', data);
                
                if (!data.success || !data.test) {
                    throw new Error('Test not found');
                }
                
                const test = data.test;
                
                // Set as active mock test (reuse mock test interface)
                activeMockTest = {
                    _id: test._id,
                    name: test.name,
                    examType: test.examType,
                    subject: test.subject,
                    duration: test.duration || 60,
                    totalQuestions: test.questionCount,
                    questionIds: test.questionIds || []
                };
                
                console.log('ðŸ“Š Test loaded:', activeMockTest);
                
                // Check if we have questions
                if (!test.questions || test.questions.length === 0) {
                    throw new Error('No questions found in this test');
                }
                
                activeMockQuestions = test.questions;
                console.log('ðŸ“ Questions loaded:', activeMockQuestions.length);
                
                // Initialize test state
                activeMockQuestionIdx = 0;
                activeMockAnswers = {};
                activeMockMarked = new Set();
                activeMockTime = activeMockTest.duration * 60; // Convert to seconds
                
                // Show mock test interface
                showMockTestInterface();
                
                showNotification(`âœ… Test started: ${activeMockTest.name}`, 'success');
                
            } catch (error) {
                console.error('âŒ Error starting practice test:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        // Delete practice test
        async function deletePracticeTest(testId) {
            if (!confirm('Are you sure you want to delete this practice test?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/practice-tests/${testId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('âœ… Practice test deleted successfully!', 'success');
                    loadPersonalTests(); // Reload personal tests
                } else {
                    throw new Error(data.error || 'Failed to delete test');
                }
            } catch (error) {
                console.error('Error deleting practice test:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        // Load personal tests (only for current user)
        async function loadPersonalTests() {
            try {
                const response = await fetch('${API_BASE}/api/practice-tests/my-tests', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                const container = document.getElementById('personalTestsDisplay');
                
                if (!container) return;
                
                if (data.success && data.tests && data.tests.length > 0) {
                    container.innerHTML = data.tests.map(test => `
                        <div class="mock-test-card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-radius: 20px; padding: 1.5rem; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15); border: 2px solid rgba(16, 185, 129, 0.2); transition: all 0.3s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h3 style="color: #1f2937; margin-bottom: 0.5rem; font-size: 1.2rem; font-weight: 700;">${test.name}</h3>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">PERSONAL</span>
                                        <span style="background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${test.examType.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.05); border-radius: 12px;">
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Subject</div>
                                    <div style="font-weight: 600; color: #1f2937;"><i class="fas fa-book"></i> ${test.subject.charAt(0).toUpperCase() + test.subject.slice(1)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Questions</div>
                                    <div style="font-weight: 600; color: #1f2937;"><i class="fas fa-list"></i> ${test.questionCount}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Duration</div>
                                    <div style="font-weight: 600; color: #1f2937;"><i class="fas fa-clock"></i> ${test.duration || 60} min</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Mode</div>
                                    <div style="font-weight: 600; color: #1f2937;"><i class="fas fa-${test.selectionMode === 'manual' ? 'hand-pointer' : 'magic'}"></i> ${test.selectionMode === 'manual' ? 'Manual' : 'Auto'}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem;">
                                <button onclick="startSavedPracticeTest('${test._id}')" class="btn btn-primary" style="flex: 1; padding: 0.75rem; font-weight: 600; border-radius: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-play"></i> Start Test
                                </button>
                                <button onclick="deletePracticeTest('${test._id}')" class="btn btn-danger" style="padding: 0.75rem 1rem; border-radius: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: white; border-radius: 16px; border: 2px dashed #e2e8f0;">
                            <i class="fas fa-clipboard-list" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                            <h3 style="color: #6b7280; margin-bottom: 0.5rem;">No Personal Tests Yet</h3>
                            <p style="color: #9ca3af; margin-bottom: 1rem;">Create your first custom test to get started</p>
                            <button onclick="openCreatePracticeTestModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Test
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading personal tests:', error);
            }
        }

        async function startPracticeTest() {
            const questionCount = parseInt(document.getElementById('practiceQuestionCount').value);
            const difficulty = document.getElementById('practiceDifficulty').value;

            if (questionCount < 1 || questionCount > 50) {
                showNotification('Please enter a valid number of questions (1-50)', 'warning');
                return;
            }

            showNotification('Loading practice test...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/questions?examType=${practiceExamType}&subject=${practiceSubject}&difficulty=${difficulty}&limit=${questionCount}`);
                practiceQuestions = await response.json();

                if (practiceQuestions.length === 0) {
                    showNotification('No questions available for this configuration', 'warning');
                    return;
                }

                // Initialize practice test
                currentPracticeIndex = 0;
                practiceAnswers = {};
                practiceScore = 0;

                // Hide config, show interface
                document.getElementById('practiceTestConfig').style.display = 'none';
                document.getElementById('practiceTestInterface').style.display = 'block';

                // Update totals
                document.getElementById('totalQuestionsNum').textContent = practiceQuestions.length;
                document.getElementById('practiceScore').textContent = '0';

                // Load first question
                loadPracticeQuestion();
            } catch (error) {
                console.error('Error loading practice test:', error);
                showNotification('Error loading practice test', 'error');
            }
        }

        function loadPracticeQuestion() {
            const question = practiceQuestions[currentPracticeIndex];
            const container = document.getElementById('practiceQuestionContainer');

            document.getElementById('currentQuestionNum').textContent = currentPracticeIndex + 1;

            const isAnswered = practiceAnswers[currentPracticeIndex] !== undefined;
            const userAnswer = practiceAnswers[currentPracticeIndex];
            const correctAnswer = question.answer;

            container.innerHTML = `
                <div class="practice-question-card">
                    <div class="question-number">Question ${currentPracticeIndex + 1}</div>
                    <div class="question-text">${preserveLineBreaks(question.text)}</div>
                    
                    <div class="test-options" style="margin-top: 1.5rem;">
                        ${question.options.map((option, index) => {
                            const optionLetter = String.fromCharCode(65 + index);
                            let optionClass = 'practice-option';
                            
                            if (isAnswered) {
                                if (optionLetter === correctAnswer) {
                                    optionClass += ' correct';
                                } else if (optionLetter === userAnswer && userAnswer !== correctAnswer) {
                                    optionClass += ' incorrect';
                                }
                            } else if (optionLetter === userAnswer) {
                                optionClass += ' selected';
                            }

                            return `
                                <div class="${optionClass}" onclick="${!isAnswered ? `selectPracticeAnswer('${optionLetter}')` : ''}">
                                    <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                        ${optionLetter}
                                    </div>
                                    <div style="flex: 1;">${preserveLineBreaks(option)}</div>
                                    ${isAnswered && optionLetter === correctAnswer ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                                    ${isAnswered && optionLetter === userAnswer && userAnswer !== correctAnswer ? '<i class="fas fa-times-circle" style="color: var(--error);"></i>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    ${isAnswered ? `
                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 12px; border-left: 4px solid var(--primary);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary);"><i class="fas fa-lightbulb"></i> Solution</h4>
                            <p style="line-height: 1.6; color: var(--gray-700);">${preserveLineBreaks(question.solution)}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            // Update button states
            document.getElementById('practicePrevBtn').disabled = currentPracticeIndex === 0;
            document.getElementById('practiceNextBtn').style.display = currentPracticeIndex < practiceQuestions.length - 1 ? 'flex' : 'none';
            document.getElementById('practiceFinishBtn').style.display = currentPracticeIndex === practiceQuestions.length - 1 ? 'flex' : 'none';
        }

        function selectPracticeAnswer(answer) {
            const question = practiceQuestions[currentPracticeIndex];
            practiceAnswers[currentPracticeIndex] = answer;

            // Check if correct
            if (answer === question.answer) {
                practiceScore++;
                document.getElementById('practiceScore').textContent = practiceScore;
                showNotification('Correct! ðŸŽ‰', 'success');
            } else {
                showNotification('Incorrect. Check the solution below.', 'error');
            }

            // Reload question to show feedback
            loadPracticeQuestion();
        }

        function previousPracticeQuestion() {
            if (currentPracticeIndex > 0) {
                currentPracticeIndex--;
                loadPracticeQuestion();
            }
        }

        function nextPracticeQuestion() {
            if (currentPracticeIndex < practiceQuestions.length - 1) {
                currentPracticeIndex++;
                loadPracticeQuestion();
            }
        }

        function finishPracticeTest() {
            const totalQuestions = practiceQuestions.length;
            const percentage = ((practiceScore / totalQuestions) * 100).toFixed(1);

            showNotification(`Test completed! Score: ${practiceScore}/${totalQuestions} (${percentage}%)`, 'success');

            // Reset and go back to config
            setTimeout(() => {
                exitPracticeTest();
            }, 2000);
        }

        function exitPracticeTest() {
            document.getElementById('practiceTestConfig').style.display = 'block';
            document.getElementById('practiceTestInterface').style.display = 'none';
            practiceQuestions = [];
            currentPracticeIndex = 0;
            practiceAnswers = {};
            practiceScore = 0;
        }

        // Initialize paper maker when section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            const examDateInput = document.getElementById('examDate');
            if (examDateInput) {
                examDateInput.value = today;
            }
        });

        // Admin helper functions
        function loadAdminQuestions() {
            console.log('ðŸ“š Loading admin questions...');
            const container = document.getElementById('adminQuestionsList');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-question-circle" style="font-size: 3rem; color: #6366f1; margin-bottom: 1rem;"></i>
                        <h3>Question Management</h3>
                        <p>Use the buttons above to add new questions or manage existing ones.</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">Questions will be loaded from the database here.</p>
                    </div>
                `;
            }
        }

        function loadMockTests() {
            console.log('ðŸŽ¯ Loading mock tests...');
            const container = document.getElementById('mockTestsList');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                        <h3>Mock Test Management</h3>
                        <p>Create and manage mock tests for students.</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">Mock tests will be displayed here.</p>
                    </div>
                `;
            }
        }

        function loadStudentResults() {
            console.log('ðŸ“Š Loading student results...');
            const container = document.getElementById('studentResultsTable');
            if (container) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; color: #f59e0b; margin-bottom: 1rem; display: block;"></i>
                            <p>No student results available yet.</p>
                            <p style="color: #6b7280; font-size: 0.9rem;">Results will appear here as students take tests.</p>
                        </td>
                    </tr>
                `;
            }
        }



        // Show notification function


        // ===== ADMIN PANEL DEBUGGING FUNCTIONS =====

        function debugAdminPanel() {
            console.log('ðŸ”§ ===== ADMIN PANEL DEBUG REPORT =====');

            // Check user role
            console.log('ðŸ‘¤ Current User:', currentUser);
            console.log('ðŸ”‘ User Role:', currentUser?.role);

            // Check admin elements
            const adminNavItem = document.getElementById('adminNavItem');
            const adminSection = document.getElementById('adminSection');

            console.log('ðŸ” Admin Elements Check:');
            console.log('  - Admin Nav Button:', adminNavItem ? 'âœ… Found' : 'âŒ Missing');
            console.log('  - Admin Section:', adminSection ? 'âœ… Found' : 'âŒ Missing');

            if (adminNavItem) {
                console.log('  - Nav Button Display:', window.getComputedStyle(adminNavItem).display);
                console.log('  - Nav Button Visibility:', window.getComputedStyle(adminNavItem).visibility);
                console.log('  - Nav Button Classes:', adminNavItem.className);
            }

            if (adminSection) {
                console.log('  - Section Display:', window.getComputedStyle(adminSection).display);
                console.log('  - Section Classes:', adminSection.className);
            }

            // Check admin tabs
            const adminTabs = document.querySelectorAll('.admin-tab');
            const adminTabContents = document.querySelectorAll('.admin-tab-content');

            console.log('ðŸ“‹ Admin Tabs Check:');
            console.log('  - Tab Buttons Found:', adminTabs.length);
            console.log('  - Tab Contents Found:', adminTabContents.length);

            adminTabs.forEach((tab, index) => {
                console.log(`  - Tab ${index + 1}:`, tab.textContent.trim(),
                    tab.classList.contains('active') ? '(Active)' : '(Inactive)');
            });

            adminTabContents.forEach((content, index) => {
                console.log(`  - Content ${index + 1}:`, content.id,
                    window.getComputedStyle(content).display);
            });

            console.log('ðŸ”§ ===== END DEBUG REPORT =====');

            // Show summary notification
            showNotification('Debug report generated - check console', 'info');
        }

        // DEBUG FUNCTION REMOVED - Users must login properly

        function testAdminTabSwitching() {
            console.log('ðŸ§ª TESTING ADMIN TAB SWITCHING');

            const tabs = ['questions', 'mock-tests', 'student-results', 'ai-config'];
            let currentIndex = 0;

            function switchToNextTab() {
                if (currentIndex < tabs.length) {
                    const tabName = tabs[currentIndex];
                    console.log(`ðŸ”„ Testing tab: ${tabName}`);
                    showAdminTab(tabName);
                    currentIndex++;

                    setTimeout(switchToNextTab, 2000);
                } else {
                    console.log('âœ… Tab switching test completed');
                    showNotification('Tab switching test completed!', 'success');
                }
            }

            switchToNextTab();
        }

        function debugAdminTabContent() {
            console.log('ðŸ” DEBUGGING ADMIN TAB CONTENT');

            const tabContents = [
                'questions-tab',
                'mock-tests-tab',
                'student-results-tab',
                'ai-config-tab'
            ];

            tabContents.forEach(tabId => {
                const element = document.getElementById(tabId);
                if (element) {
                    console.log(`âœ… ${tabId}:`, {
                        exists: true,
                        display: window.getComputedStyle(element).display,
                        classes: element.className,
                        innerHTML: element.innerHTML.substring(0, 100) + '...'
                    });
                } else {
                    console.log(`âŒ ${tabId}: NOT FOUND`);
                }
            });

            showNotification('Tab content debug complete - check console', 'info');
        }

        // Enhanced admin initialization with debugging
        function initializeAdminPanelWithDebug() {
            console.log('ðŸ”§ INITIALIZING ADMIN PANEL WITH DEBUG');

            // Add debug buttons to admin panel
            setTimeout(() => {
                const adminSection = document.getElementById('adminSection');
                if (adminSection && !document.getElementById('debug-container')) {
                    const debugContainer = document.createElement('div');
                    debugContainer.id = 'debug-container';
                    debugContainer.innerHTML = `
                        <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <h4 style="color: #dc2626; margin: 0 0 1rem 0;">ðŸ”§ Admin Debug Tools</h4>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="debugAdminPanel()" style="background: #dc2626; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    ðŸ” Debug Report
                                </button>
                                <button class="btn btn-sm" onclick="forceShowAdminPanel()" style="background: #059669; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    ðŸš€ Force Show
                                </button>
                                <button class="btn btn-sm" onclick="testAdminTabSwitching()" style="background: #7c3aed; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    ðŸ§ª Test Tabs
                                </button>
                                <button class="btn btn-sm" onclick="debugAdminTabContent()" style="background: #ea580c; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    ðŸ“‹ Debug Content
                                </button>
                                <button class="btn btn-sm" onclick="console.clear()" style="background: #6b7280; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    ðŸ§¹ Clear Console
                                </button>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280;">
                                Open browser console (F12) to see detailed debug information
                            </div>
                        </div>
                    `;

                    // Insert debug container at the beginning of admin section
                    const sectionHeader = adminSection.querySelector('.section-header');
                    if (sectionHeader) {
                        sectionHeader.insertAdjacentElement('afterend', debugContainer);
                        console.log('âœ… Debug buttons added to admin panel');
                    }
                }
            }, 500);
        }

        function showPhysicsUploadModal() {
            console.log('ðŸ“¤ Opening physics upload modal...');
            showNotification('Physics upload feature coming soon!', 'info');
        }

        function loadAllQuestions() {
            console.log('ðŸ”„ Refreshing all questions...');
            loadAdminQuestions();
            showNotification('Questions refreshed!', 'success');
        }

        function showCreateMockTestModal() {
            console.log('ðŸŽ¯ Opening create mock test modal...');
            showNotification('Mock test creation feature coming soon!', 'info');
        }

        function loadAllMockTests() {
            console.log('ðŸ”„ Loading all mock tests...');
            loadMockTests();
            showNotification('Mock tests loaded!', 'success');
        }

        function exportStudentResults() {
            console.log('ðŸ“¥ Exporting student results...');
            showNotification('Export feature coming soon!', 'info');
        }

        // MathJax ready event
        window.MathJax = window.MathJax || {};
        window.MathJax.startup = window.MathJax.startup || {};
        window.MathJax.startup.ready = () => {
            console.log('ðŸ§® MathJax is ready!');
            window.MathJax.startup.defaultReady();

            // Test MathJax after it's ready
            setTimeout(() => {
                testMathJax();
            }, 1000);
        };

        // Close LaTeX dropdown when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.latex-dropdown-container')) {
                document.querySelectorAll('.latex-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        // Initialize keyboard shortcuts for editor
        function initializeKeyboardShortcuts() {
            console.log('âŒ¨ï¸ Initializing keyboard shortcuts...');

            // Add global keyboard event listener
            document.addEventListener('keydown', function (event) {
                // Get the currently focused element
                const activeElement = document.activeElement;

                // Check if we're in a textarea or input field in the enhanced question modal
                const isInEditor = activeElement && (
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.tagName === 'INPUT'
                ) && (
                        activeElement.id.startsWith('enhanced') ||
                        activeElement.closest('.enhanced-modal-content') ||
                        activeElement.closest('.enhanced-editor')
                    );

                if (!isInEditor) return;

                const elementId = activeElement.id;

                // Ctrl+Q - LaTeX
                if (event.ctrlKey && event.key.toLowerCase() === 'q') {
                    event.preventDefault();
                    showLatexModal(elementId);
                    showNotification('LaTeX modal opened (Ctrl+Q)', 'info');
                    return;
                }

                // Ctrl+M - New Line
                if (event.ctrlKey && event.key.toLowerCase() === 'm') {
                    event.preventDefault();
                    insertNewLine(elementId);
                    showNotification('New line inserted (Ctrl+M)', 'info');
                    return;
                }

                // Ctrl+B - Bold
                if (event.ctrlKey && event.key.toLowerCase() === 'b') {
                    event.preventDefault();
                    formatText(elementId, 'bold');
                    showNotification('Bold formatting applied (Ctrl+B)', 'info');
                    return;
                }

                // Ctrl+I - Italic
                if (event.ctrlKey && event.key.toLowerCase() === 'i') {
                    event.preventDefault();
                    formatText(elementId, 'italic');
                    showNotification('Italic formatting applied (Ctrl+I)', 'info');
                    return;
                }

                // Ctrl+Shift+U - Underline
                if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'u') {
                    event.preventDefault();
                    formatText(elementId, 'underline');
                    showNotification('Underline formatting applied (Ctrl+Shift+U)', 'info');
                    return;
                }

                // Ctrl+Shift+L - Align Left
                if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'l') {
                    event.preventDefault();
                    alignText(elementId, 'left');
                    showNotification('Text aligned left (Ctrl+Shift+L)', 'info');
                    return;
                }

                // Ctrl+Shift+E - Align Center
                if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'e') {
                    event.preventDefault();
                    alignText(elementId, 'center');
                    showNotification('Text aligned center (Ctrl+Shift+E)', 'info');
                    return;
                }

                // Ctrl+Shift+R - Align Right
                if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'r') {
                    event.preventDefault();
                    alignText(elementId, 'right');
                    showNotification('Text aligned right (Ctrl+Shift+R)', 'info');
                    return;
                }

                // Mathematical symbols shortcuts (only for numerical answer field)
                if (elementId === 'enhancedNumericalAnswer') {
                    // Ctrl+Shift+P - Pi
                    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'p') {
                        event.preventDefault();
                        insertMathSymbol(elementId, 'Ï€');
                        return;
                    }

                    // Ctrl+Shift+S - Square Root
                    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 's') {
                        event.preventDefault();
                        insertMathSymbol(elementId, 'âˆš');
                        return;
                    }

                    // Ctrl+Shift+X - Multiplication (Ã—10^)
                    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'x') {
                        event.preventDefault();
                        insertMathSymbol(elementId, 'Ã—10^');
                        return;
                    }
                }
            });

            console.log('âœ… Keyboard shortcuts initialized');
            console.log('ðŸ“‹ Available shortcuts:');
            console.log('   Ctrl+Q: LaTeX modal');
            console.log('   Ctrl+M: Insert new line (\\n)');
            console.log('   Ctrl+B: Bold formatting');
            console.log('   Ctrl+I: Italic formatting');
            console.log('   Ctrl+Shift+U: Underline formatting');
            console.log('   Ctrl+Shift+L: Align left');
            console.log('   Ctrl+Shift+E: Align center');
            console.log('   Ctrl+Shift+R: Align right');
            console.log('ðŸ“ Mathematical shortcuts (Numerical Answer):');
            console.log('   Ctrl+Shift+P: Pi (Ï€)');
            console.log('   Ctrl+Shift+S: Square Root (âˆš)');
            console.log('   Ctrl+Shift+X: Scientific notation (Ã—10^)');

            // Add F1 key to toggle help panel
            document.addEventListener('keydown', function (event) {
                if (event.key === 'F1') {
                    event.preventDefault();
                    toggleKeyboardShortcuts();
                }
            });
        }

        // Toggle keyboard shortcuts help panel
        function toggleKeyboardShortcuts() {
            const helpPanel = document.getElementById('keyboardShortcutsHelp');
            const toggleBtn = document.getElementById('shortcutsToggleBtn');

            if (helpPanel && toggleBtn) {
                const isVisible = helpPanel.classList.contains('show');

                if (isVisible) {
                    helpPanel.classList.remove('show');
                    toggleBtn.style.display = 'block';
                } else {
                    helpPanel.classList.add('show');
                    toggleBtn.style.display = 'none';
                }
            }
        }

        // Initialize the application with enhanced debugging
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ðŸš€ ===== APPLICATION INITIALIZATION =====');

            // Show welcome notification for UI improvements
            setTimeout(() => {
                showNotification('âœ¨ UI Enhanced! Dashboard, Login, and Create Test sections now feature a modern design.', 'success');
            }, 2000);

            // Initialize DOM elements
            authSection = document.getElementById('authSection');
            dashboard = document.getElementById('dashboardSection');
            loginForm = document.getElementById('loginForm');
            userName = document.getElementById('userName');
            userRole = document.getElementById('userRole');
            userAvatar = document.getElementById('userAvatar');
            greetingName = document.getElementById('greetingName');
            logoutBtn = document.getElementById('logoutBtn');
            notification = document.getElementById('notification');

            // Initialize keyboard shortcuts for editor
            initializeKeyboardShortcuts();

            // Show keyboard shortcuts notification
            setTimeout(() => {
                showNotification('âŒ¨ï¸ Keyboard shortcuts available! Press F1 or click the keyboard icon to see all shortcuts.', 'info');
            }, 4000);

            console.log('ðŸ” ===== DOM ELEMENTS CHECK =====');
            console.log('authSection:', authSection ? 'âœ… Found' : 'âŒ Missing');
            console.log('dashboard:', dashboard ? 'âœ… Found' : 'âŒ Missing');
            console.log('loginForm:', loginForm ? 'âœ… Found' : 'âŒ Missing');
            console.log('userName:', userName ? 'âœ… Found' : 'âŒ Missing');
            console.log('userRole:', userRole ? 'âœ… Found' : 'âŒ Missing');
            console.log('notification:', notification ? 'âœ… Found' : 'âŒ Missing');

            // Check admin elements specifically
            const adminNavItem = document.getElementById('adminNavItem');
            const adminSection = document.getElementById('adminSection');

            console.log('ðŸ” ===== ADMIN ELEMENTS CHECK =====');
            console.log('adminNavItem:', adminNavItem ? 'âœ… Found' : 'âŒ Missing');
            console.log('adminSection:', adminSection ? 'âœ… Found' : 'âŒ Missing');

            // Show auth section by default (no auto-login)
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'flex';
                console.log('âœ… Auth section visible - user must login');
            }
            
            // Hide dashboard until user logs in
            if (dashboard) {
                dashboard.classList.add('hidden');
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
                console.log('âœ… Dashboard hidden - requires login');
            }

            // Add visible indicator
            document.body.style.backgroundColor = 'red';
            setTimeout(() => {
                document.body.style.backgroundColor = '';
            }, 1000);

            // Clean all text content on page load
            setTimeout(() => {
                applyCleanTextToPage();
                console.log('? Page content cleaned of strange symbols');
            }, 500);
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();

                    // Initialize chapters for existing user
                    setTimeout(async () => {
                        console.log('ðŸ“š Initializing chapters for existing user...');
                        try {
                            await updateChapterDropdown();
                            console.log('âœ… Chapters initialized successfully');
                        } catch (error) {
                            console.error('âŒ Error initializing chapters:', error);
                        }
                    }, 1000);

                    // Load mock tests on page load
                    setTimeout(() => {
                        console.log('ðŸŽ¯ Loading mock tests on page initialization...');
                        try {
                            loadMockTestsInCreateSection();
                            loadMockTestsList();
                            console.log('âœ… Mock tests loaded on initialization');
                        } catch (error) {
                            console.error('âŒ Error loading mock tests on init:', error);
                        }
                    }, 1500);
                } catch (e) {
                    console.error('Error parsing saved user data:', e);
                    localStorage.removeItem('currentUser');
                }
            } else {
                // No auto-login - user must login manually
                console.log('ï¿½ ANo user logged in - showing auth section');
                currentUser = null;
                localStorage.removeItem('currentUser');
                // User will see login page by default (no function needed)

                // Load mock tests on page load
                setTimeout(() => {
                    console.log('ðŸŽ¯ Loading mock tests on page initialization...');
                    try {
                        loadMockTestsInCreateSection();
                        loadMockTestsList();
                        console.log('âœ… Mock tests loaded on initialization');
                    } catch (error) {
                        console.error('âŒ Error loading mock tests on init:', error);
                    }
                }, 1500);

                // No debug code - clean initialization
            }

            // Setup event listeners
            setupEventListeners();

            // Fallback: Ensure dashboard is visible
            setTimeout(() => {
                const dashboardSection = document.getElementById('dashboardSection');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                    dashboardSection.classList.add('active');
                    console.log('ðŸ”§ Fallback: Dashboard section made visible');
                }
            }, 100);
        });

        // Setup event listeners for navigation
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('[data-section]').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    } else {
                        console.warn('âš ï¸ Button clicked but no data-section attribute found:', this);
                    }
                });
            });

            // Form submissions
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }

            // Logout button
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
        }

        // Show specific section
        // Show specific section
        function showSection(sectionId) {
            if (!sectionId) {
                console.error('âŒ showSection called with null or undefined sectionId');
                return;
            }

            console.log('ðŸ”„ Switching to section:', sectionId);

            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                targetSection.style.visibility = 'visible';
                targetSection.style.opacity = '1';
                console.log('âœ… Section activated:', sectionId);
                console.log('ðŸ“ Section visibility:', window.getComputedStyle(targetSection).display);

                // Load section-specific data
                switch (sectionId) {
                    case 'questionBankSection':
                        loadQuestionBank().catch(error => {
                            console.error('Error loading question bank:', error);
                            showNotification('Error loading question bank', 'error');
                        });
                        break;
                    case 'dashboardSection':
                        loadDashboardData();
                        break;
                    case 'adminSection':
                        console.log('ðŸ”§ Loading admin section');
                        // Initialize admin panel (password-protected)
                        console.log('ðŸ”§ Admin panel initialized with password protection');
                        break;

                    case 'performanceSection':
                        console.log('ðŸ“Š Loading performance section');
                        // Initialize performance section
                        setTimeout(() => {
                            loadPerformanceData();
                            console.log('âœ… Performance data loaded');
                        }, 100);
                        break;
                    case 'adminSection':
                        console.log('ðŸ”§ Loading admin section');
                        // Admin section is now password-protected
                        console.log('ðŸ”§ Admin section loaded with password protection');
                        console.log('âœ… Admin access granted');
                        // Initialize with users tab by default
                        setTimeout(() => {
                            showAdminTab('users');
                        }, 100);
                        break;
                    // Add other cases as needed
                }

                // Smooth scroll to top after section switch
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 100);
            } else {
                console.error('âŒ Section not found:', sectionId);
            }
        }

        // Removed duplicate functions - using the more complete versions above

        // Show notification function






        function showPhysicsUploadModal() {
            console.log('ðŸ“¤ Opening physics upload modal...');
            showNotification('Physics upload feature coming soon!', 'info');
        }

        function loadAllQuestions() {
            console.log('ðŸ”„ Refreshing all questions...');
            loadAdminQuestions();
            showNotification('Questions refreshed!', 'success');
        }

        function showCreateMockTestModal() {
            console.log('ðŸŽ¯ Opening create mock test modal...');
            showNotification('Mock test creation feature coming soon!', 'info');
        }

        function loadAllMockTests() {
            console.log('ðŸ”„ Loading all mock tests...');
            showNotification('Mock tests loaded!', 'success');
        }

        function exportStudentResults() {
            console.log('ðŸ“¥ Exporting student results...');
            showNotification('Export feature coming soon!', 'info');
        }

        // Show dashboard
        function showDashboard() {
            console.log('ðŸ  Showing dashboard...');

            // Hide auth section if it exists
            if (authSection) {
                authSection.classList.add('hidden');
                authSection.style.display = 'none';
            }

            // Show dashboard section
            if (dashboard) {
                dashboard.classList.remove('hidden');
                dashboard.classList.add('active');
                dashboard.style.display = 'flex';
                console.log('âœ… Dashboard shown');
            }

            // Update user info if elements exist
            if (userName && currentUser) {
                userName.textContent = currentUser.username;
            }
            if (userRole && currentUser) {
                userRole.textContent = currentUser.role;
            }
            if (greetingName && currentUser) {
                greetingName.textContent = currentUser.username;
            }
            if (userAvatar && currentUser) {
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }

            // Show/hide admin elements based on role
            if (currentUser && currentUser.role === 'admin') {
                console.log('ðŸ”‘ User is admin, showing admin elements');
                const adminNavItem = document.getElementById('adminNavItem');
                const adminDropdownItem = document.getElementById('adminDropdownItem');

                if (adminNavItem) {
                    adminNavItem.style.display = 'flex';
                    adminNavItem.classList.add('show-admin');
                }
            }

            // Show the dashboard section specifically
            showSection('dashboardSection');
        }

        // HARDCODED INITIALIZATION
        console.log('?? HARDCODED CHAT SYSTEM INITIALIZED');
        console.log('  âœ… Bulletproof saving system active');
        console.log('  âœ… Auto-save after AI responses');
        console.log('  âœ… Auto-save on page unload');
        console.log('  âœ… Auto-save on tab switching');
        console.log('  âœ… Auto-save every 2 minutes');
        console.log('  âœ… Hardcoded fallbacks enabled');

        // HARDCODED: Initialize chat history on page load
        setTimeout(() => {
            console.log('ðŸ”§ HARDCODED: Running initial chat history load');
            if (currentUser && currentUser.username) {
                hardcodedUpdateChatHistory();
            } else {
                console.log('ðŸ”§ HARDCODED: No user yet, will load on login');
            }
        }, 1000);

        // Initialize scroll features
        initializeScrollFeatures();

        // ENSURE ADMIN PANEL IS ALWAYS ACCESSIBLE
        setTimeout(() => {
            const adminNav = document.getElementById('adminNavItem');
            const adminDropdown = document.getElementById('adminDropdownItem');

            if (adminNav) {
                adminNav.style.display = 'flex';
                adminNav.style.visibility = 'visible';
                adminNav.classList.add('show-admin');
                console.log('âœ… Admin nav made permanently visible');
            }

            if (adminDropdown) {
                adminDropdown.style.display = 'block';
                adminDropdown.style.visibility = 'visible';
                adminDropdown.classList.add('show-admin');
                console.log('âœ… Admin dropdown made permanently visible');
            }
        });

        function setupEventListeners() {
            // Fix layout issues on initialization
            document.body.style.overflow = 'hidden';

            // Ensure proper viewport handling
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }

            // Login form submission
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                loginUser();
            });

            // Registration form submission
            const registerForm = document.getElementById('registerForm');
            registerForm.addEventListener('submit', function (e) {
                e.preventDefault();
                registerUser();
            });

            // Navigation
            document.querySelectorAll('.nav-item, .nav-btn').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);

                        // Update active nav item
                        document.querySelectorAll('.nav-item, .nav-btn').forEach(nav => {
                            nav.classList.remove('active');
                        });
                        if (this.classList.contains('nav-btn')) {
                            this.classList.add('active');
                        }
                    } else {
                        console.warn('âš ï¸ Navigation item clicked but no data-section attribute found:', this);
                    }
                });
            });

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Show corresponding tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                });
            });

            // Section navigation buttons
            document.querySelectorAll('button[data-section]').forEach(button => {
                button.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);

                        // Update active nav item
                        document.querySelectorAll('.nav-item').forEach(nav => {
                            nav.classList.remove('active');
                            if (nav.getAttribute('data-section') === sectionId) {
                                nav.classList.add('active');
                            }
                        });
                    } else {
                        console.warn('âš ï¸ Button clicked but no data-section attribute found:', this);
                    }
                });
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                    logoutUser();
                });
                console.log('âœ… Logout button event listener added');
            }
        }

        async function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, role })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    currentRole = data.user.role;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showNotification('Login successful! Welcome to your dashboard.', 'success');
                    showDashboard();
                } else {
                    showNotification(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        function showDashboard() {
            if (authSection) {
                authSection.classList.add('hidden');
                authSection.style.display = 'none';
            }
            if (dashboard) {
                dashboard.classList.remove('hidden');
                dashboard.classList.add('active');
                dashboard.style.display = 'flex';
            }

            // Update user info
            userName.textContent = currentUser.username;
            userRole.textContent = currentUser.role;
            greetingName.textContent = currentUser.username;
            userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();

            // Show/hide admin nav based on role
            console.log('ðŸ‘¤ User role:', currentUser.role);

            // Get admin elements (they may not exist since we removed them)
            const adminNavItem = document.getElementById('adminNavItem');
            const adminDropdownItem = document.getElementById('adminDropdownItem');

            console.log('ðŸ” Admin nav item element:', adminNavItem);
            console.log('ðŸ” Admin dropdown item element:', adminDropdownItem);

            // Admin panel is now password-protected, always show admin button
            console.log('ðŸ”‘ Admin panel is password-protected, showing admin button');
            if (adminNavItem) {
                adminNavItem.classList.add('show-admin');
                console.log('âœ… Admin nav item shown (password-protected)');
            } else {
                console.log('â„¹ï¸ Admin nav item not found');
            }

            // Ensure dashboard section is active and others are hidden
            showSection('dashboardSection');

            // Load dashboard data
            loadDashboardData();

            // Load user-specific chat history
            loadChatHistory();

            // HARDCODED: Force load chat history
            setTimeout(() => {
                console.log('ðŸ”§ HARDCODED: Force loading chat history after login');
                hardcodedUpdateChatHistory();
            }, 500);
        }





        // Scroll Functions
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function handleScroll() {
            const scrollBtn = document.getElementById('scrollToTopBtn');
            if (!scrollBtn) return;

            if (window.pageYOffset > 300) {
                scrollBtn.classList.add('show');
            } else {
                scrollBtn.classList.remove('show');
            }
        }

        // Smooth scroll for navigation links
        function smoothScrollTo(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // Initialize scroll functionality
        function initializeScrollFeatures() {
            // Add scroll event listener
            window.addEventListener('scroll', handleScroll);

            // Add smooth scrolling to all internal links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    smoothScrollTo(targetId);
                });
            });

            // Add smooth scrolling to navigation items
            document.querySelectorAll('.nav-item, .nav-btn').forEach(item => {
                item.addEventListener('click', function () {
                    // Small delay to allow section switching, then scroll to top
                    setTimeout(() => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
            });
        }

        // Dashboard functions
        function loadDashboardData() {
            try {
                const totalTests = document.getElementById('totalTests');
                const averageScore = document.getElementById('averageScore');
                const studyHours = document.getElementById('studyHours');
                const rank = document.getElementById('rank');

                if (totalTests) totalTests.textContent = '12';
                if (averageScore) averageScore.textContent = '78%';
                if (studyHours) studyHours.textContent = '45';
                if (rank) rank.textContent = '1,245';

                console.log('âœ… Dashboard data loaded successfully');
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
            }
        }

        // Global variables
        let chatHistory = [];

        // Question Bank functions
        let currentExamType = 'jee';
        let currentSubject = 'physics';
        let currentLanguage = 'all'; // Language filter: 'all', 'en', 'gu'

        // New chapter-based navigation functions
        function showSubjectPage(examType, subject) {
            console.log('showSubjectPage called with:', examType, subject);
            currentExamType = examType;
            currentSubject = subject;

            // Hide all exam content sections
            document.querySelectorAll('.exam-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show subject detail page
            document.getElementById('subjectDetailPage').style.display = 'block';

            // Update header
            const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
            const examName = examType.toUpperCase();
            document.getElementById('subjectDetailTitle').textContent = `${subjectName} - ${examName}`;
            document.getElementById('subjectDetailSubtitle').textContent = `Choose a chapter to start practicing ${subjectName}`;

            // Load chapters for this subject (now async)
            loadChapters(examType, subject).catch(error => {
                console.error('âŒ Error loading chapters in showSubjectPage:', error);
            });

            // Add event listeners after a short delay to ensure HTML is rendered
            setTimeout(() => {
                const chaptersGrid = document.getElementById('chaptersGrid');
                const chapterCards = chaptersGrid.querySelectorAll('.chapter-card');
                console.log('Adding event listeners to', chapterCards.length, 'chapter cards');

                chapterCards.forEach((card, index) => {
                    const chapterId = card.getAttribute('data-chapter-id');
                    const chapterName = card.getAttribute('data-chapter-name');

                    if (chapterId && chapterName) {
                        console.log('Adding listener to card', index, chapterId, chapterName);

                        // Remove any existing listeners
                        card.replaceWith(card.cloneNode(true));
                        const newCard = chaptersGrid.children[index];

                        newCard.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Chapter clicked:', chapterId, chapterName);
                            showChapterQuestions(chapterId, chapterName);
                        });

                        // Add hover effect
                        newCard.addEventListener('mouseenter', function () {
                            newCard.style.transform = 'translateY(-4px)';
                            newCard.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
                            newCard.style.borderColor = '#6366f1';
                        });

                        newCard.addEventListener('mouseleave', function () {
                            newCard.style.transform = 'translateY(0)';
                            newCard.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                            newCard.style.borderColor = 'transparent';
                        });
                    }
                });
            }, 200);
        }

        function goBackToExamType() {
            // Hide subject detail page and chapter questions page
            document.getElementById('subjectDetailPage').style.display = 'none';
            document.getElementById('chapterQuestionsPage').style.display = 'none';

            // Hide all exam content first
            document.querySelectorAll('.exam-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // Show the current exam type subjects
            const currentExamContent = document.getElementById(`${currentExamType}Subjects`);
            if (currentExamContent) {
                currentExamContent.classList.add('active');
                currentExamContent.style.display = 'block';
            }

            // Ensure the correct exam type tab is active
            document.querySelectorAll('.exam-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const currentExamTab = document.querySelector(`[data-exam="${currentExamType}"]`);
            if (currentExamTab) {
                currentExamTab.classList.add('active');
            }

            console.log('Returned to exam type:', currentExamType);
        }

        function goBackToSubject() {
            console.log('Going back to subject');

            // Hide chapter questions page
            const questionsPage = document.getElementById('chapterQuestionsPage');
            if (questionsPage) {
                questionsPage.style.display = 'none';
            }

            // Show subject detail page
            const subjectPage = document.getElementById('subjectDetailPage');
            if (subjectPage) {
                subjectPage.style.display = 'block';
            }
        }

        async function loadChapters(examType, subject) {
            const chaptersGrid = document.getElementById('chaptersGrid');
            console.log('ðŸ“š Loading chapters from database for:', examType, subject);

            if (!chaptersGrid) {
                console.error('âŒ chaptersGrid element not found');
                return;
            }

            // Show loading state
            chaptersGrid.innerHTML = `
                <div style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">Loading chapters...</p>
                </div>
            `;

            try {
                // Fetch chapters from database
                const chapters = await loadChaptersFromAPI(examType, subject);
                console.log('âœ… Chapters loaded from database:', chapters.length);

                if (chapters.length === 0) {
                    // Show empty state
                    chaptersGrid.innerHTML = `
                        <div style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                                <i class="fas fa-book-open" style="font-size: 2rem; color: #9ca3af;"></i>
                            </div>
                            <h3 style="color: #374151; margin-bottom: 1rem;">No Chapters Available</h3>
                            <p style="color: #6b7280; margin-bottom: 2rem;">No chapters have been added for ${examType.toUpperCase()} ${subject.charAt(0).toUpperCase() + subject.slice(1)} yet.</p>
                            <p style="color: #9ca3af; font-size: 0.9rem;">Chapters can be added through the admin panel.</p>
                        </div>
                    `;
                    return;
                }

                // Count questions for each chapter (this would need to be implemented in the API)
                let html = '';

                for (const chapter of chapters) {
                    // Skip the "Mixed" option for chapter cards display
                    if (chapter.id === 'mixed') continue;

                    // Get question count for this chapter (placeholder for now)
                    const questionCount = await getQuestionCountForChapter(examType, subject, chapter.name);

                    html += `
                        <div class="chapter-card" style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 2px solid transparent; margin-bottom: 2rem; text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 20px 40px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 30px rgba(0, 0, 0, 0.1)'">
                            <div>
                                <div class="chapter-icon" style="width: 120px; height: 120px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem auto; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);">
                                    <i class="${chapter.icon || 'fas fa-book'}" style="font-size: 48px; color: white;"></i>
                                </div>
                                <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700; color: #1f2937; line-height: 1.3;">${chapter.name}</h3>
                                <p style="margin: 0 0 2rem 0; color: #6b7280; font-size: 1rem; line-height: 1.6;">
                                    ${questionCount > 0 ? `Practice ${questionCount} acurated questions` : 'No questions available yet'}
                                </p>
                                ${questionCount === 0 ? `
                                    <div style="background: #fef3c7; color: #92400e; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 1rem;">
                                        <i class="fas fa-exclamation-triangle"></i> No questions added yet
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="showChapterQuestions('${chapter.id}', '${chapter.name}')" 
                                    style="width: 100%; background: ${questionCount > 0 ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)'}; color: white; border: none; border-radius: 16px; padding: 16px 24px; cursor: ${questionCount > 0 ? 'pointer' : 'not-allowed'}; font-weight: 700; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px;" ${questionCount === 0 ? 'disabled' : ''}>
                                ${questionCount > 0 ? 'Start Practice' : 'No Questions'}
                                <i class="fas ${questionCount > 0 ? 'fa-arrow-right' : 'fa-ban'}" style="font-size: 16px;"></i>
                            </button>
                        </div>
                    `;
                }

                chaptersGrid.innerHTML = html;

            } catch (error) {
                console.error('âŒ Error loading chapters:', error);

                // Show error state
                chaptersGrid.innerHTML = `
                    <div style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc2626;"></i>
                        </div>
                        <h3 style="color: #374151; margin-bottom: 1rem;">Error Loading Chapters</h3>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Unable to load chapters from the database.</p>
                        <button onclick="loadChapters('${examType}', '${subject}')" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-refresh"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        function getChaptersForSubject(examType, subject) {
            // This function is deprecated - chapters are now loaded from API
            // Return empty array as fallback
            console.warn('âš ï¸ getChaptersForSubject is deprecated - use loadChaptersFromAPI instead');
            return [];
        }

        // Helper function for clean console logging
        function cleanLog(...args) {
            const cleanedArgs = args.map(arg =>
                typeof arg === 'string' ? cleanText(arg) : arg
            );
            console.log(...cleanedArgs);
        }

        // Enhanced function to clean strange symbols
        function cleanText(text) {
            if (!text) return text;

            let cleanedText = text
                // Common encoding issues - comprehensive cleaning
                .replace(/ï¿½ï¿½"/g, '-')     // em dash
                .replace(/ï¿½ï¿½"/g, 'ï¿½')     // en dash  
                .replace(/ï¿½ï¿½'/g, '?')     // right arrow
                .replace(/ï¿½ï¿½/g, '?')      // left arrow
                .replace(/Ã—/g, 'ï¿½')      // multiplication
                .replace(/Â°/g, 'ï¿½')      // degree
                .replace(/ï¿½ï¿½/g, '5')      // superscript 5
                .replace(/ï¿½ï¿½/g, '7')      // superscript 7
                .replace(/ï¿½ï¿½/g, '?')      // minus/negative
                .replace(/Â¹/g, 'ï¿½')      // superscript 1
                .replace(/ï¿½ï¿½'/g, '-')     // minus sign
                .replace(/â€¢/g, 'ï¿½')     // bullet
                .replace(/ï¿½ï¿½"ï¿½/g, '??')    // paperclip
                .replace(/âˆš/g, 'v')     // square root
                .replace(/â€œ/g, '"')     // left double quote
                .replace(/ï¿½ï¿½/g, '"')      // right double quote
                .replace(/â€™/g, "'")     // right single quote
                .replace(/â€˜/g, "'")     // left single quote
                .replace(/â€¦/g, '...')   // ellipsis

                // Fix emoji encoding issues
                .replace(/ï¿½ï¿½"'/g, '??')    // wrench
                .replace(/ï¿½ï¿½''/g, '??')    // crown
                .replace(/ðŸ§ª/g, '??')    // test tube
                .replace(/ðŸŽ¯/g, '??')    // target
                .replace(/ðŸš€/g, '??')    // rocket
                .replace(/ï¿½ï¿½"/g, '??')     // magnifying glass
                .replace(/âš¡/g, '?')     // lightning
                .replace(/ï¿½ï¿½"'/g, '??')    // lock

                // More aggressive cleaning for remaining patterns
                .replace(/ï¿½ï¿½[^\w\s]/g, '"') // any ï¿½ï¿½ followed by non-word/space char becomes quote
                .replace(/ï¿½ï¿½[^\w\s]/g, '?') // any ï¿½ï¿½ followed by non-word/space char becomes arrow
                .replace(/ï¿½[^\w\s]/g, '')   // remove any remaining ï¿½ followed by non-word/space char
                .replace(/ï¿½/g, '')          // remove stray ï¿½ characters
                .replace(/ï¿½/g, '')          // remove stray ï¿½ characters
                .replace(/ï¿½/g, '')          // remove stray ï¿½ characters

                // Normalize standard characters
                .replace(/"/g, '"')         // normalize quotes
                .replace(/"/g, '"')         // normalize quotes
                .replace(/'/g, "'")         // normalize apostrophes
                .replace(/'/g, "'")         // normalize apostrophes
                .replace(/ï¿½/g, '...')       // normalize ellipsis
                .replace(/ï¿½/g, '-')         // normalize en dash
                .replace(/ï¿½/g, '-')         // normalize em dash

                // Clean up multiple spaces and trim
                .replace(/\s+/g, ' ')
                .trim();

            return cleanedText;
        }

        // Apply cleanText to all displayed content
        function applyCleanTextToPage() {
            // Clean all text content in the page
            const elementsToClean = document.querySelectorAll('*');
            elementsToClean.forEach(element => {
                if (element.childNodes) {
                    element.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                            node.textContent = cleanText(node.textContent);
                        }
                    });
                }

                // Also clean attributes that might contain text
                if (element.title) element.title = cleanText(element.title);
                if (element.placeholder) element.placeholder = cleanText(element.placeholder);
                if (element.alt) element.alt = cleanText(element.alt);
            });
        }

        function getQuestionsForChapter(examType, subject, chapterId) {
            console.log(`ðŸ” Getting questions for: ${examType} > ${subject} > ${chapterId}`);

            // Ensure realQuestionsData is initialized as an array
            if (!realQuestionsData) {
                console.warn('âš ï¸ realQuestionsData not initialized, returning empty array');
                return [];
            }

            // If we have real questions data, use it
            if (realQuestionsData && realQuestionsData.length > 0) {
                let filteredQuestions = realQuestionsData.filter(q => {
                    const matchesExam = !examType || q.examType.toLowerCase() === examType.toLowerCase();
                    const matchesSubject = !subject || q.subject.toLowerCase() === subject.toLowerCase();

                    // For chapter matching, we need to be more flexible since chapter names might not match exactly
                    let matchesChapter = true;
                    if (chapterId && chapterId !== 'all') {
                        // If chapterId is like "physics-1", extract the chapter name from our stored data
                        // Or match directly by chapter name
                        const questionChapter = q.chapter.toLowerCase();

                        // Try different matching strategies
                        if (chapterId.includes('-')) {
                            // This might be a generated ID, try to match by position or name
                            matchesChapter = true; // For now, show all chapters for the subject
                        } else {
                            // Direct chapter name matching
                            const searchChapter = chapterId.toLowerCase();
                            matchesChapter = questionChapter.includes(searchChapter) ||
                                searchChapter.includes(questionChapter) ||
                                questionChapter === searchChapter;
                        }
                    }

                    return matchesExam && matchesSubject && matchesChapter;
                });

                console.log(`ðŸ“Š Found ${filteredQuestions.length} real questions matching criteria`);
                if (filteredQuestions.length > 0) {
                    console.log('Sample questions:');
                    filteredQuestions.slice(0, 3).forEach((q, i) => {
                        console.log(`  ${i + 1}. ${q.chapter}: ${q.text.substring(0, 50)}...`);
                    });
                }

                return filteredQuestions;
            }

            // No hardcoded questions - all questions should come from database
            console.log('âš ï¸ No questions available - database is empty');
            return [];
        }

        function showChapterQuestions(chapterId, chapterName) {
            console.log('showChapterQuestions called:', chapterId, chapterName);

            try {
                // Hide subject detail page
                const subjectPage = document.getElementById('subjectDetailPage');
                if (subjectPage) {
                    subjectPage.style.display = 'none';
                    console.log('Hidden subject detail page');
                } else {
                    console.error('subjectDetailPage not found');
                }

                // Show chapter questions page
                let questionsPage = document.getElementById('chapterQuestionsPage');
                if (questionsPage) {
                    questionsPage.style.display = 'block';
                    console.log('Showing chapter questions page');
                } else {
                    console.error('chapterQuestionsPage not found - creating it');
                    createChapterQuestionsPage();
                    questionsPage = document.getElementById('chapterQuestionsPage');
                    if (questionsPage) {
                        questionsPage.style.display = 'block';
                        console.log('Created and showing chapter questions page');
                    } else {
                        console.error('Failed to create chapterQuestionsPage');
                        // Fallback: show questions in current page
                        const chaptersGrid = document.getElementById('chaptersGrid');
                        if (chaptersGrid) {
                            chaptersGrid.innerHTML = `
                                <div style="padding: 20px;">
                                    <button onclick="goBackToSubject()" style="margin-bottom: 20px; padding: 10px; background: #6366f1; color: white; border: none; border-radius: 5px;">
                                        â† Back to Chapters
                                    </button>
                                    <h2>${chapterName || 'Chapter Questions'}</h2>
                                    <div id="questionsDisplay"></div>
                                </div>
                            `;
                            loadChapterQuestions(currentExamType, currentSubject, chapterId);
                        }
                        return;
                    }
                }

                // Update header
                const titleElement = document.getElementById('chapterQuestionsTitle');
                const subtitleElement = document.getElementById('chapterQuestionsSubtitle');

                if (titleElement) {
                    titleElement.textContent = chapterName;
                }
                if (subtitleElement) {
                    subtitleElement.textContent = `${currentSubject.charAt(0).toUpperCase() + currentSubject.slice(1)} - ${currentExamType.toUpperCase()}`;
                }

                // Load questions for this chapter
                loadChapterQuestions(currentExamType, currentSubject, chapterId);
            } catch (error) {
                console.error('Error in showChapterQuestions:', error);
                // Fallback: show questions directly
                loadChapterQuestions(currentExamType, currentSubject, chapterId);
            }
        }

        // Simple function to show questions in place
        function showQuestionsInPlace(chapterId, chapterName) {
            console.log('showQuestionsInPlace called:', chapterId, chapterName);

            const chaptersGrid = document.getElementById('chaptersGrid');
            if (!chaptersGrid) {
                console.error('chaptersGrid not found!');
                return;
            }

            // Replace the chapters with questions
            chaptersGrid.innerHTML = `
                <div style="padding: 20px;">
                    <button onclick="goBackToSubject()" 
                            style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">
                        â† Back to Chapters
                    </button>
                    <h2 style="margin-bottom: 20px;">${chapterName}</h2>
                    <div id="questionsDisplay">Loading questions...</div>
                </div>
            `;

            // Load questions using the proper displayQuestions function
            setTimeout(() => {
                const questions = getQuestionsForChapter(currentExamType || 'jee', currentSubject || 'physics', chapterId);
                const questionsDisplay = document.getElementById('questionsDisplay');

                if (questions.length === 0) {
                    questionsDisplay.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <h3>No Questions Available</h3>
                            <p>Chapter ID: ${chapterId}</p>
                            <p>Questions found: ${questions.length}</p>
                        </div>
                    `;
                } else {
                    // Use the proper displayQuestions function with answer/solution buttons
                    displayQuestions(questions, questionsDisplay);
                }
            }, 100);
        }

        // Helper function to create the page if it doesn't exist
        function createChapterQuestionsPage() {
            const questionBankSection = document.getElementById('questionBankSection');
            if (!questionBankSection) return;

            const questionsPageHTML = `
                <div id="chapterQuestionsPage" class="exam-content" style="display: none;">
                    <div class="chapter-questions-header" style="margin-bottom: 2rem;">
                        <button onclick="goBackToSubject()"
                                style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-bottom: 1rem;">
                            <i class="fas fa-arrow-left"></i> Back to Chapters
                        </button>
                        <h2 id="chapterQuestionsTitle"
                            style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: #1f2937;">
                        </h2>
                        <p id="chapterQuestionsSubtitle" style="margin: 0; color: #6b7280;"></p>
                    </div>
                    <div id="chapterQuestionsList" class="questions-container">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>
            `;

            questionBankSection.insertAdjacentHTML('beforeend', questionsPageHTML);
        }


        async function loadChapterQuestions(examType, subject, chapterId) {
            console.log('Loading questions for:', examType, subject, chapterId);

            // Try multiple possible container IDs
            let container = document.getElementById('chapterQuestionsList') ||
                document.getElementById('questionsContainer') ||
                document.getElementById('questionsDisplay');

            if (!container) {
                container = document.createElement('div');
                container.id = 'questionsDisplay';
                console.log('Created new container for questions');
            }

            // If container doesn't exist, try to find it or create it
            if (!container.parentNode) {
                const questionsPage = document.getElementById('chapterQuestionsPage') ||
                    document.getElementById('questionBankSection') ||
                    document.body;

                if (questionsPage) {
                    questionsPage.appendChild(container);
                    container.className = 'questions-container';
                    console.log('Appended container to:', questionsPage.id);
                }
            }

            try {
                container.innerHTML = `
                    <div class="loading-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
                        <p>Loading questions for this chapter...</p>
                    </div>
                `;

                // Get questions for the specific chapter from database
                const questions = await getQuestionsForChapterFromDB(examType, subject, chapterId);
                console.log('Questions found:', questions.length, 'for', examType, subject, chapterId);

                if (questions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <h3>No Questions Available</h3>
                            <p>No questions found for this chapter yet.</p>
                            <p style="margin-top: 1rem; color: var(--gray-600);">
                                Debug Info: ${examType} > ${subject} > ${chapterId}
                            </p>
                        </div>
                    `;
                } else {
                    console.log('Calling displayQuestions with', questions.length, 'questions');
                    console.log('First question text:', questions[0]?.text);
                    console.log('Container element:', container);
                    displayQuestions(questions, container);
                }

            } catch (error) {
                console.error('Error loading chapter questions:', error);
                container.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error); margin-bottom: 1rem;"></i>
                        <h3>Error Loading Questions</h3>
                        <p>There was a problem loading the questions for this chapter.</p>
                        <button onclick="loadChapterQuestions('${examType}', '${subject}', '${chapterId}')"
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        async function loadQuestionBank() {
            console.log('ðŸ“š Initializing Question Bank...');

            // Load real questions from database first
            await loadRealQuestions();

            // Initialize the question bank with proper state
            currentExamType = 'jee'; // Default to JEE
            currentSubject = 'physics'; // Default to Physics

            // Ensure proper initial state
            document.querySelectorAll('.exam-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // Show JEE subjects by default
            const jeeSubjects = document.getElementById('jeeSubjects');
            if (jeeSubjects) {
                jeeSubjects.classList.add('active');
                jeeSubjects.style.display = 'block';
            }

            // Ensure JEE tab is active
            document.querySelectorAll('.exam-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const jeeTab = document.querySelector('[data-exam="jee"]');
            if (jeeTab) {
                jeeTab.classList.add('active');
            }

            // Hide any detail pages
            const subjectDetailPage = document.getElementById('subjectDetailPage');
            const chapterQuestionsPage = document.getElementById('chapterQuestionsPage');

            if (subjectDetailPage) {
                subjectDetailPage.style.display = 'none';
            }

            if (chapterQuestionsPage) {
                chapterQuestionsPage.style.display = 'none';
            }

            console.log('âœ… Question Bank initialized with real data - JEE/Physics selected by default');
        }

        // Language filter function
        function setQuestionLanguage(language) {
            currentLanguage = language;
            console.log('ðŸŒ Language filter set to:', language);
            
            // Update button states
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#667eea';
            });
            
            const activeBtn = document.querySelector(`[data-lang="${language}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#667eea';
                activeBtn.style.color = 'white';
            }
            
            // Reload current view with language filter
            if (currentExamType && currentSubject) {
                const chapterQuestionsPage = document.getElementById('chapterQuestionsPage');
                if (chapterQuestionsPage && chapterQuestionsPage.style.display !== 'none') {
                    // If viewing chapter questions, reload them
                    const currentChapter = chapterQuestionsPage.dataset.currentChapter;
                    if (currentChapter) {
                        loadChapterQuestions(currentExamType, currentSubject, currentChapter);
                    }
                } else {
                    // Reload chapters view
                    loadChapters(currentExamType, currentSubject);
                }
            }
            
            showNotification(`Language filter: ${language === 'all' ? 'All Languages' : language === 'en' ? 'English' : 'àª—à«àªœàª°àª¾àª¤à«€'}`, 'success');
        }

        function showExamType(examType) {
            currentExamType = examType;

            // Update exam type tabs
            document.querySelectorAll('.exam-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-exam="${examType}"]`).classList.add('active');

            // Show/hide exam content - Force approach
            const jeeContent = document.getElementById('jeeSubjects');
            const neetContent = document.getElementById('neetSubjects');

            if (examType === 'jee') {
                // Show JEE, Hide NEET
                if (jeeContent) {
                    jeeContent.classList.add('active');
                    jeeContent.style.display = 'block';
                    jeeContent.style.visibility = 'visible';
                }
                if (neetContent) {
                    neetContent.classList.remove('active');
                    neetContent.style.display = 'none';
                }
            } else if (examType === 'neet') {
                // Show NEET, Hide JEE
                if (neetContent) {
                    neetContent.classList.add('active');
                    neetContent.style.display = 'block';
                    neetContent.style.visibility = 'visible';
                }
                if (jeeContent) {
                    jeeContent.classList.remove('active');
                    jeeContent.style.display = 'none';
                }
            }

            // Also hide other exam-content elements
            document.querySelectorAll('.exam-content').forEach(content => {
                if (content.id !== `${examType}Subjects`) {
                    content.classList.remove('active');
                    content.style.display = 'none';
                }
            });

            console.log('Showing content for:', examType);

            // Force refresh the display
            setTimeout(() => {
                const checkElement = document.getElementById(`${examType}Subjects`);
                if (checkElement) {
                    console.log(`${examType}Subjects display:`, window.getComputedStyle(checkElement).display);
                    console.log(`${examType}Subjects visibility:`, window.getComputedStyle(checkElement).visibility);
                }
            }, 100);

            // Reset subject selection and show default subject (physics)
            currentSubject = 'physics';

            // Update subject tabs for the new exam type
            const examContent = document.getElementById(`${examType}Subjects`);
            if (examContent) {
                // Reset all subject tabs
                examContent.querySelectorAll('.subject-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Activate physics tab (default)
                const physicsTab = examContent.querySelector('[data-subject="physics"]');
                if (physicsTab) {
                    physicsTab.classList.add('active');
                }
            }

            // Hide any open chapter questions or subject details
            const chapterQuestionsPage = document.getElementById('chapterQuestionsPage');
            const subjectDetailPage = document.getElementById('subjectDetailPage');

            if (chapterQuestionsPage) {
                chapterQuestionsPage.style.display = 'none';
            }

            if (subjectDetailPage) {
                subjectDetailPage.style.display = 'none';
            }

            console.log('Exam type switched to:', examType, 'Default subject: physics');

            // Debug: Check if elements exist
            console.log('JEE Subjects element:', document.getElementById('jeeSubjects'));
            console.log('NEET Subjects element:', document.getElementById('neetSubjects'));
            console.log('Target element:', document.getElementById(`${examType}Subjects`));
        }

        // Debug function to force show NEET subjects
        function forceShowNEET() {
            console.log('Force showing NEET subjects');

            // Hide JEE
            const jeeSubjects = document.getElementById('jeeSubjects');
            if (jeeSubjects) {
                jeeSubjects.style.display = 'none';
                jeeSubjects.classList.remove('active');
            }

            // Show NEET
            const neetSubjects = document.getElementById('neetSubjects');
            if (neetSubjects) {
                neetSubjects.style.display = 'block';
                neetSubjects.classList.add('active');
                console.log('NEET subjects should now be visible');
            }

            // Update tabs
            document.querySelectorAll('.exam-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const neetTab = document.querySelector('[data-exam="neet"]');
            if (neetTab) {
                neetTab.classList.add('active');
            }
        }

        function showSubject(examType, subject) {
            console.log('showSubject called with:', examType, subject);
            currentExamType = examType;
            currentSubject = subject;

            try {
                // Update subject tabs within the current exam type
                const examContent = document.getElementById(`${examType}Subjects`);
                if (!examContent) {
                    console.error('Exam content not found:', `${examType}Subjects`);
                    return;
                }

                examContent.querySelectorAll('.subject-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const subjectTab = examContent.querySelector(`[data-subject="${subject}"]`);
                if (subjectTab) {
                    subjectTab.classList.add('active');
                } else {
                    console.error('Subject tab not found:', subject);
                }

                // Load questions for the selected exam type and subject
                loadSubjectQuestions(examType, subject);
            } catch (error) {
                console.error('Error in showSubject:', error);
            }
        }

        async function loadSubjectQuestions(examType, subject) {
            const container = document.getElementById(`${examType}QuestionsList`);

            try {
                // Show loading state
                container.innerHTML = `
                    <div class="loading-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
                        <p>Loading ${subject} questions for ${examType.toUpperCase()}...</p>
                    </div>
                `;

                // Fetch questions from the server with language filter
                let apiUrl = `${API_BASE}/api/questions?examType=${examType}&subject=${subject}`;
                if (currentLanguage && currentLanguage !== 'all') {
                    apiUrl += `&language=${currentLanguage}`;
                }
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch questions');
                }

                const data = await response.json();
                displayQuestions(data.questions, container);

            } catch (error) {
                console.error('Error loading questions:', error);
                container.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error); margin-bottom: 1rem;"></i>
                        <h3>No Questions Available</h3>
                        <p>No questions found for ${subject} in ${examType.toUpperCase()}.</p>
                        <p style="margin-top: 1rem; color: var(--gray-600);">Questions can be added by admin or teacher users.</p>
                    </div>
                `;
            }
        }

        function displayQuestions(questions, container) {
            console.log('displayQuestions called with', questions.length, 'questions');
            if (questions.length > 0) {
                console.log('First question text:', questions[0].text.substring(0, 50));
            }

            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-book-open" style="font-size: 2rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                        <h3>No Questions Available</h3>
                        <p>No questions found for this subject.</p>
                        <p style="margin-top: 1rem; color: var(--gray-600);">Questions can be added by admin or teacher users.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="questions-header" style="margin-bottom: 2rem;">
                    <h3>${questions.length} Questions Available</h3>
                    <p>Subject: ${currentSubject.charAt(0).toUpperCase() + currentSubject.slice(1)} | Exam: ${currentExamType.toUpperCase()}</p>
                </div>
            `;

            questions.forEach((question, index) => {
                // Determine if question is in Gujarati
                const isGujarati = question.language === 'gu';
                const langClass = isGujarati ? 'lang-gu gujarati-text' : '';
                const langAttr = isGujarati ? 'lang="gu"' : '';
                
                html += `
                    <div class="question-card ${langClass}" ${langAttr} style="margin-bottom: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: white;">
                        <div class="question-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div class="question-meta" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="meta-tag subject" style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.subject}</span>
                                <span class="meta-tag difficulty ${question.difficulty}" style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.difficulty}</span>
                                <span class="meta-tag chapter" style="background: rgba(59, 130, 246, 0.1); color: #2563eb; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.chapter}</span>
                                ${question.examType ? `<span class="meta-tag exam-type" style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">${question.examType}</span>` : ''}
                                ${isGujarati ? `<span class="meta-tag language lang-gu" style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;"><i class="fas fa-language"></i> àª—à«àªœàª°àª¾àª¤à«€</span>` : ''}
                                ${question.tags && question.tags.length > 0 ? question.tags.map(tag => `<span class="meta-tag tag" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">#${tag}</span>`).join('') : ''}
                                ${question.type === 'numerical' ? `
                                    <span class="meta-tag type" style="background: rgba(168, 85, 247, 0.1); color: #7c3aed; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-calculator"></i> Numerical
                                    </span>
                                ` : ''}
                                ${question.source ? `
                                    <span class="meta-tag source" style="background: rgba(34, 197, 94, 0.1); color: #16a34a; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">
                                        ${question.source}
                                    </span>
                                ` : ''}
                            </div>
                            <span class="question-number" style="font-weight: 600; color: #6b7280;">#${index + 1}</span>
                        </div>
                        
                        <div class="question-text ${langClass}" ${langAttr} style="font-size: 1rem; line-height: 1.6; color: #374151; margin-bottom: 1rem;">
                            ${cleanTextWithLineBreaks(question.text)}
                        </div>
                        
                        ${question.references ? `
                            <div class="question-references" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">
                                    <i class="fas fa-book"></i>
                                    References
                                </div>
                                <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                                    ${cleanTextWithLineBreaks(question.references)}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${question.options && question.options.length > 0 ? `
                            <div class="question-options ${langClass}" ${langAttr} style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                                ${question.options.map((option, optIndex) => `
                                    <div class="option-item ${langClass}" ${langAttr} style="padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                                         onclick="selectOption(this, '${cleanText(option)}', '${cleanText(question.answer)}', ${index})">
                                        <strong>${String.fromCharCode(65 + optIndex)}.</strong> ${cleanTextWithLineBreaks(option)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="numerical-question" style="padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; margin-bottom: 1rem;">
                                <p style="margin: 0; color: #0369a1; font-weight: 500;">
                                    <i class="fas fa-calculator"></i> Numerical Answer Question
                                </p>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    This is a numerical question. Enter your calculated answer.
                                </p>
                            </div>
                        `}
                        
                        <div class="question-actions" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button class="btn-answer" onclick="showAnswer(${index})" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                                Show Answer
                            </button>
                            <button class="btn-solution" onclick="showSolution(${index})" 
                                    style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                                Show Solution
                            </button>
                        </div>
                        
                        <div id="answer-${index}" class="question-answer ${langClass}" ${langAttr} style="display: none; padding: 1rem; background: #dbeafe; border-radius: 8px; margin-bottom: 0.5rem;">
                            <strong>Correct Answer:</strong> ${cleanText(question.answer)}
                        </div>
                        
                        ${question.solution ? `
                            <div id="solution-${index}" class="question-solution ${langClass}" ${langAttr} style="display: none; padding: 1rem; background: #d1fae5; border-radius: 8px;">
                                <strong>Solution:</strong> ${cleanTextWithLineBreaks(question.solution)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;

            // Render MathJax for LaTeX expressions
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch((err) => {
                    console.log('MathJax rendering error:', err);
                });
            }
        }

        function selectOption(element, selectedOption, correctAnswer, questionIndex) {
            // Remove previous selections
            const questionCard = element.closest('.question-card');
            const options = questionCard.querySelectorAll('.option-item');
            options.forEach(opt => {
                opt.style.background = '#f9fafb';
                opt.style.borderColor = '#e5e7eb';
                opt.style.color = '#374151';
            });

            // Highlight selected option
            if (selectedOption === correctAnswer) {
                element.style.background = '#d1fae5';
                element.style.borderColor = '#10b981';
                element.style.color = '#065f46';
            } else {
                element.style.background = '#fee2e2';
                element.style.borderColor = '#ef4444';
                element.style.color = '#991b1b';

                // Also highlight correct answer
                options.forEach(opt => {
                    if (opt.textContent.includes(correctAnswer)) {
                        opt.style.background = '#d1fae5';
                        opt.style.borderColor = '#10b981';
                        opt.style.color = '#065f46';
                    }
                });
            }
        }

        function showAnswer(questionIndex) {
            const answerDiv = document.getElementById(`answer-${questionIndex}`);
            if (answerDiv.style.display === 'none') {
                answerDiv.style.display = 'block';
            } else {
                answerDiv.style.display = 'none';
            }
        }

        function showSolution(questionIndex) {
            const solutionDiv = document.getElementById(`solution-${questionIndex}`);
            if (solutionDiv.style.display === 'none') {
                solutionDiv.style.display = 'block';
            } else {
                solutionDiv.style.display = 'none';
            }
        }

        function displayQuestionBankInterface(data) {
            // Try to find the correct element for displaying questions
            let questionsList = document.getElementById('questionsDisplay') ||
                document.getElementById('questionsList') ||
                document.getElementById('chapterQuestionsList');

            // If no element found, try to find question bank section
            if (!questionsList) {
                const questionBankSection = document.getElementById('questionBankSection');
                if (questionBankSection) {
                    questionsList = document.createElement('div');
                    questionsList.id = 'questionsDisplay';
                    questionBankSection.appendChild(questionsList);
                } else {
                    console.error('No suitable container found for displaying questions');
                    return;
                }
            }

            let html = `
                <div class="question-bank-header">
                    <h2>Question Bank</h2>
                    <p>Total Questions Available: <strong>${data.metadata.totalQuestions.toLocaleString()}</strong></p>
                </div>
                
                <div class="exam-tabs">
                    <button class="exam-tab active" onclick="showExamQuestions('JEE', this)">
                        <i class="fas fa-graduation-cap"></i>
                        JEE (${data.questionBanks.JEE.totalQuestions.toLocaleString()} Questions)
                    </button>
                    <button class="exam-tab" onclick="showExamQuestions('NEET', this)">
                        <i class="fas fa-user-md"></i>
                        NEET (${data.questionBanks.NEET.totalQuestions.toLocaleString()} Questions)
                    </button>
                </div>
                
                <div id="examContent">
                    ${generateExamContent('JEE', data.questionBanks.JEE)}
                </div>
            `;

            questionsList.innerHTML = html;
        }

        function generateExamContent(examType, examData) {
            let html = `<div class="subjects-grid">`;

            Object.entries(examData.subjects).forEach(([key, subject]) => {
                html += `
                    <div class="subject-card" onclick="loadSubjectQuestions('${examType}', '${key}')">
                        <div class="subject-icon">
                            <i class="${subject.icon}"></i>
                        </div>
                        <h3>${subject.name}</h3>
                        <p>${subject.totalQuestions.toLocaleString()} Questions</p>
                        <button class="btn btn-primary">
                            Explore Questions
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
            });

            html += `</div>`;
            return html;
        }

        async function showExamQuestions(examType, buttonElement) {
            // Update active tab
            document.querySelectorAll('.exam-tab').forEach(tab => tab.classList.remove('active'));
            buttonElement.classList.add('active');

            try {
                // Create mock exam data using local questions
                const mockExamData = {
                    subjects: {
                        physics: {
                            name: 'Physics',
                            chapters: ['Physical World and Measurement', 'Kinematics']
                        },
                        chemistry: {
                            name: 'Chemistry',
                            chapters: ['Some Basic Concepts']
                        },
                        mathematics: {
                            name: 'Mathematics',
                            chapters: ['Sets and Functions']
                        }
                    }
                };

                const examContent = document.getElementById('examContent');
                examContent.innerHTML = generateExamContent(examType, mockExamData);
            } catch (error) {
                console.error('Error loading exam data:', error);
            }
        }

        async function loadSubjectQuestions(examType, subject) {
            try {
                console.log(`ðŸ“– Loading subject questions for: ${examType} > ${subject}`);

                // Ensure we have real questions loaded
                if (!realQuestionsData || realQuestionsData.length === 0) {
                    await loadRealQuestions();
                }

                // Get all questions for this exam type and subject
                const subjectQuestions = realQuestionsData.filter(q => {
                    const matchesExam = !examType || q.examType.toLowerCase() === examType.toLowerCase();
                    const matchesSubject = !subject || q.subject.toLowerCase() === subject.toLowerCase();
                    return matchesExam && matchesSubject;
                });

                console.log(`ðŸ“Š Found ${subjectQuestions.length} questions for ${subject}`);

                // Group questions by chapter
                const chapterGroups = {};
                subjectQuestions.forEach(q => {
                    const chapterName = q.chapter;
                    if (!chapterGroups[chapterName]) {
                        chapterGroups[chapterName] = [];
                    }
                    chapterGroups[chapterName].push(q);
                });

                // Create subject data with real chapters
                const chapters = {};
                Object.keys(chapterGroups).forEach((chapterName, index) => {
                    const chapterId = `${subject}-${index + 1}`;
                    chapters[chapterId] = {
                        name: chapterName,
                        totalQuestions: chapterGroups[chapterName].length,
                        realChapterName: chapterName // Store the real chapter name for matching
                    };
                });

                const subjectData = {
                    subject: subject.charAt(0).toUpperCase() + subject.slice(1),
                    exam: examType.toUpperCase(),
                    chapters: chapters
                };

                console.log('ðŸ“š Created subject data with chapters:', Object.keys(chapters));
                displaySubjectQuestions(subjectData, examType, subject);

            } catch (error) {
                console.error('Error loading subject questions:', error);
                showNotification('Error loading questions', 'error');
            }
        }

        function displaySubjectQuestions(subjectData, examType, subject) {
            // Try to find the correct element for displaying questions
            let questionsList = document.getElementById('questionsDisplay') ||
                document.getElementById('questionsList') ||
                document.getElementById('chapterQuestionsList');

            // If no element found, create one
            if (!questionsList) {
                const questionsPage = document.getElementById('chapterQuestionsPage');
                if (questionsPage) {
                    questionsList = document.createElement('div');
                    questionsList.id = 'questionsDisplay';
                    questionsPage.appendChild(questionsList);
                } else {
                    console.error('No suitable container found for displaying questions');
                    return;
                }
            }

            let html = `
                <div class="subject-header">
                    <button class="btn btn-secondary" onclick="loadQuestionBank().catch(e => console.error('Error:', e))">
                        <i class="fas fa-arrow-left"></i> Back to Question Bank
                    </button>
                    <h2>${subjectData.subject} - ${subjectData.exam}</h2>
                    <p>Total Questions: ${subjectData.totalQuestions.toLocaleString()}</p>
                </div>
                
                <div class="chapters-grid">
            `;

            Object.entries(subjectData.chapters).forEach(([chapterKey, chapter]) => {
                html += `
                    <div class="chapter-card" onclick="loadChapterQuestions('${examType}', '${subject}', '${chapterKey}')">
                        <h3>${chapter.name}</h3>
                        <p>${chapter.totalQuestions} Questions</p>
                        <div class="topics-preview">
                            ${Object.keys(chapter.topics).slice(0, 3).map(topic =>
                    `<span class="topic-tag">${chapter.topics[topic].name}</span>`
                ).join('')}
                            ${Object.keys(chapter.topics).length > 3 ?
                        `<span class="topic-tag">+${Object.keys(chapter.topics).length - 3} more</span>` : ''}
                        </div>
                        <button class="btn btn-primary">
                            Start Practice
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                `;
            });

            html += `</div>`;
            questionsList.innerHTML = html;
        }



        function getChapterName(chapterId) {
            // This function is deprecated - chapter names should come from database
            console.warn('âš ï¸ getChapterName is deprecated - use database chapter data instead');
            return chapterId || 'Unknown Chapter';
        }

        function displayChapterQuestions(chapterData, examType, subject, chapter) {
            // Try to find the correct element for displaying questions
            let questionsList = document.getElementById('questionsDisplay') ||
                document.getElementById('questionsList') ||
                document.getElementById('chapterQuestionsList');

            // If no element found, create one
            if (!questionsList) {
                const questionsPage = document.getElementById('chapterQuestionsPage');
                if (questionsPage) {
                    questionsList = document.createElement('div');
                    questionsList.id = 'questionsDisplay';
                    questionsPage.appendChild(questionsList);
                } else {
                    console.error('No suitable container found for displaying questions');
                    return;
                }
            }

            // Get the actual questions for this chapter
            const questions = getQuestionsForChapter(examType, subject, chapter);

            if (questions.length === 0) {
                questionsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <h3>No Questions Available</h3>
                        <p>Questions for this chapter are being prepared.</p>
                    </div>
                `;
                return;
            }

            // Use the proper displayQuestions function with answer/solution buttons
            displayQuestions(questions, questionsList);
        }

        function getDifficultyDistribution(questions) {
            const counts = { easy: 0, medium: 0, hard: 0 };
            questions.forEach(q => counts[q.difficulty]++);

            return `
                <div class="difficulty-bars">
                    <div class="difficulty-bar">
                        <span class="difficulty-label easy">Easy: ${counts.easy}</span>
                    </div>
                    <div class="difficulty-bar">
                        <span class="difficulty-label medium">Medium: ${counts.medium}</span>
                    </div>
                    <div class="difficulty-bar">
                        <span class="difficulty-label hard">Hard: ${counts.hard}</span>
                    </div>
                </div>
            `;
        }

        async function startTopicPractice(examType, subject, chapter, topic) {
            try {
                // Use local questions data instead of fetching from external files
                const questions = getQuestionsForChapter(examType, subject, chapter);

                if (questions && questions.length > 0) {
                    const topicName = topic === 'general' ? 'General Questions' : topic;
                    displayPracticeQuestions(questions, topicName);
                } else {
                    showNotification('No questions found for this topic', 'info');
                }
            } catch (error) {
                console.error('Error loading practice questions:', error);
                showNotification('Error loading practice questions', 'error');
            }
        }

        function displayPracticeQuestions(questions, topicName) {
            // Try to find the correct element for displaying questions
            let questionsList = document.getElementById('questionsDisplay') ||
                document.getElementById('questionsList') ||
                document.getElementById('chapterQuestionsList');

            // If no element found, create one
            if (!questionsList) {
                const questionsPage = document.getElementById('chapterQuestionsPage');
                if (questionsPage) {
                    questionsList = document.createElement('div');
                    questionsList.id = 'questionsDisplay';
                    questionsPage.appendChild(questionsList);
                } else {
                    console.error('No suitable container found for displaying questions');
                    return;
                }
            }

            let html = `
                <div class="practice-header">
                    <h2>Practice: ${topicName}</h2>
                    <p>${questions.length} Questions</p>
                </div>
                
                <div class="questions-container">
            `;

            questions.forEach((question, index) => {
                html += `
                    <div class="question-card" id="question-${index}">
                        <div class="question-header">
                            <span class="question-number">Question ${index + 1}</span>
                            <span class="difficulty-badge ${question.difficulty}">${question.difficulty}</span>
                        </div>
                        <div class="question-text">${preserveLineBreaks(question.question)}</div>
                        <div class="options-container">
                            ${question.options.map((option, optIndex) => `
                                <div class="option" onclick="selectOption(${index}, ${optIndex})">
                                    <span class="option-letter">${String.fromCharCode(65 + optIndex)}</span>
                                    <span class="option-text">${preserveLineBreaks(option)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="question-actions">
                            <button class="btn btn-secondary" onclick="showExplanation(${index})">
                                Show Explanation
                            </button>
                        </div>
                        <div class="explanation" id="explanation-${index}" style="display: none;">
                            <h4>Explanation:</h4>
                            <p>${preserveLineBreaks(question.explanation)}</p>
                            <div class="tags">
                                ${question.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            questionsList.innerHTML = html;

            // Store questions for interaction
            window.currentPracticeQuestions = questions;
        }

        function selectOption(questionIndex, optionIndex) {
            const question = window.currentPracticeQuestions[questionIndex];
            const questionCard = document.getElementById(`question-${questionIndex}`);
            const options = questionCard.querySelectorAll('.option');

            // Remove previous selections
            options.forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));

            // Mark selected option
            options[optionIndex].classList.add('selected');

            // Show correct/incorrect
            if (optionIndex === question.correctAnswer) {
                options[optionIndex].classList.add('correct');
                showNotification('Correct!', 'success');
            } else {
                options[optionIndex].classList.add('incorrect');
                options[question.correctAnswer].classList.add('correct');
                showNotification('Incorrect. Check the explanation.', 'error');
            }

            // Auto-show explanation after selection
            setTimeout(() => showExplanation(questionIndex), 1000);
        }

        function showExplanation(questionIndex) {
            const explanation = document.getElementById(`explanation-${questionIndex}`);
            explanation.style.display = explanation.style.display === 'none' ? 'block' : 'none';
        }

        async function loadQuestions(examType, subject) {
            try {
                const response = await fetch(`${API_BASE}/api/questions?examType=${examType}&subject=${subject}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.role}-token`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    displayQuestions(data.questions, `${subject.charAt(0).toUpperCase() + subject.slice(1)} Questions`);
                } else {
                    showNotification('Error loading questions', 'error');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                showNotification('Network error loading questions', 'error');
            }
        }


        async function login(event) {
            event.preventDefault();
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const role = document.getElementById("role").value;

            try {
                const res = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password, role })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem("token", data.token);
                    localStorage.setItem("username", data.user.username);
                    localStorage.setItem("role", data.user.role);

                    // Store current user for later use
                    localStorage.setItem('currentUser', JSON.stringify(data.user));

                    document.getElementById("authSection").style.display = "none";
                    const dashboardEl = document.getElementById("dashboard");
                    dashboardEl.style.display = "flex";
                    dashboardEl.classList.add("active");
                    document.getElementById("userAvatar").innerText = data.user.username[0].toUpperCase();
                    document.getElementById("userName").innerText = data.user.username;
                    document.getElementById("userRole").innerText = data.user.role;

                    // Update sidebar elements if they exist
                    const sidebarAvatar = document.getElementById("sidebarAvatar");
                    const sidebarUsername = document.getElementById("sidebarUsername");
                    if (sidebarAvatar) sidebarAvatar.innerText = data.user.username[0].toUpperCase();
                    if (sidebarUsername) sidebarUsername.innerText = data.user.username;

                    // Admin panel is now password-protected, always show admin button
                    const adminNavItem = document.getElementById('adminNavItem');
                    if (adminNavItem) {
                        adminNavItem.style.display = 'flex';
                        adminNavItem.style.visibility = 'visible';
                        console.log('âœ… Admin panel button enabled (password-protected)');
                    }
                } else {
                    showNotification(data.error || "Login failed", "error");
                }
            } catch (err) {
                console.error("Login error:", err);
                showNotification("Server error during login", "error");
            }
        }

        document.getElementById("loginForm").addEventListener("submit", login);
        // Test functions
        function loadAvailableTests() {
            document.getElementById('availableTests').innerHTML = `
                <div class="test-card">
                    <div class="test-header">
                        <div class="test-title">JEE Physics Full Test</div>
                        <div class="test-meta">
                            <span><i class="fas fa-clock"></i> 180 min</span>
                            <span><i class="fas fa-question-circle"></i> 75 questions</span>
                            <span class="test-difficulty difficulty-medium">Medium</span>
                        </div>
                    </div>
                    <p>Comprehensive physics test covering all topics for JEE Mains</p>
                    <button class="btn btn-primary" onclick="startTest('jee-physics-full')" style="margin-top: 1rem;">
                        <i class="fas fa-play"></i>
                        Start Test
                    </button>
                </div>
                
                <div class="test-card">
                    <div class="test-header">
                        <div class="test-title">NEET Biology Practice</div>
                        <div class="test-meta">
                            <span><i class="fas fa-clock"></i> 60 min</span>
                            <span><i class="fas fa-question-circle"></i> 45 questions</span>
                            <span class="test-difficulty difficulty-easy">Easy</span>
                        </div>
                    </div>
                    <p>Biology practice test focusing on NCERT concepts</p>
                    <button class="btn btn-primary" onclick="startTest('neet-biology-practice')" style="margin-top: 1rem;">
                        <i class="fas fa-play"></i>
                        Start Test
                    </button>
                </div>
            `;
        }

        function showCreateTestModal() {
            document.getElementById('createTestModal').classList.add('active');
        }

        function closeCreateTestModal() {
            document.getElementById('createTestModal').classList.remove('active');
        }

        // Update chapter dropdown when exam type or subject changes
        function updateChapterOptions() {
            const examType = document.getElementById('testType').value;
            const subject = document.getElementById('testSubject').value;
            const chapterSelect = document.getElementById('testChapter');

            // Clear existing options
            chapterSelect.innerHTML = '<option value="Mixed">Mixed (All Chapters)</option>';

            // Get chapters for selected exam type and subject
            const chapters = getChaptersForSubject(examType, subject);

            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.name;
                option.textContent = chapter.name;
                chapterSelect.appendChild(option);
            });
        }

        // Update marking scheme info when selection changes
        function updateMarkingSchemeInfo() {
            const negativeMarkingSelect = document.getElementById('negativeMarking');
            const infoDiv = document.getElementById('markingSchemeInfo');

            if (!negativeMarkingSelect || !infoDiv) return;

            const negativeMarking = negativeMarkingSelect.value === 'true';

            if (negativeMarking) {
                infoDiv.innerHTML = `
                    <h4 style="margin: 0 0 0.5rem 0; color: #0369a1; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> JEE/NEET Marking Scheme
                    </h4>
                    <div style="font-size: 0.85rem; color: #0369a1;">
                        <div>âœ… Correct Answer: <strong>+4 marks</strong></div>
                        <div>âŒ Wrong Answer: <strong>-1 mark</strong></div>
                        <div>âšª Unattempted: <strong>0 marks</strong></div>
                    </div>
                `;
            } else {
                infoDiv.innerHTML = `
                    <h4 style="margin: 0 0 0.5rem 0; color: #059669; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> No Negative Marking
                    </h4>
                    <div style="font-size: 0.85rem; color: #059669;">
                        <div>âœ… Correct Answer: <strong>+1 mark</strong></div>
                        <div>âŒ Wrong Answer: <strong>0 marks</strong></div>
                        <div>âšª Unattempted: <strong>0 marks</strong></div>
                    </div>
                `;
            }
        }

        // Add event listeners to update chapters when exam type or subject changes
        document.addEventListener('DOMContentLoaded', function () {
            const testTypeSelect = document.getElementById('testType');
            const testSubjectSelect = document.getElementById('testSubject');
            const negativeMarkingSelect = document.getElementById('negativeMarking');

            if (testTypeSelect) {
                testTypeSelect.addEventListener('change', updateChapterOptions);
            }

            if (testSubjectSelect) {
                testSubjectSelect.addEventListener('change', updateChapterOptions);
            }

            if (negativeMarkingSelect) {
                negativeMarkingSelect.addEventListener('change', updateMarkingSchemeInfo);
            }

            // Initialize chapter options and marking scheme
            setTimeout(() => {
                updateChapterOptions();
                updateMarkingSchemeInfo();
            }, 100);

            // Add navigation button event listeners
            document.querySelectorAll('.nav-btn[data-section]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    console.log('ðŸ”„ Navigation clicked:', sectionId);
                    if (sectionId) {
                        showSection(sectionId);

                        // Update active nav button
                        document.querySelectorAll('.nav-btn').forEach(navBtn => {
                            navBtn.classList.remove('active');
                        });
                        this.classList.add('active');
                    }
                });
            });

            // Force admin button to be visible for testing (remove this in production)
            const adminNavItem = document.getElementById('adminNavItem');
            if (adminNavItem && currentUser && currentUser.role === 'admin') {
                adminNavItem.style.display = 'flex';
                adminNavItem.style.visibility = 'visible';
                console.log('ðŸ”§ Admin button made visible for admin user');
            }


        });

        function generateCustomTest() {
            const title = document.getElementById('testTitle').value || 'Custom Test';
            const type = document.getElementById('testType').value;
            const subject = document.getElementById('testSubject').value;
            const classLevel = document.getElementById('testClass').value;
            const chapter = document.getElementById('testChapter').value || 'Mixed';
            const difficulty = document.getElementById('testDifficulty').value;
            const duration = parseInt(document.getElementById('testDuration').value);
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const negativeMarking = document.getElementById('negativeMarking').value === 'true';

            // Validate inputs
            if (!title.trim()) {
                showNotification('Please enter a test title', 'error');
                return;
            }

            if (questionCount < 5 || questionCount > 50) {
                showNotification('Number of questions must be between 5 and 50', 'error');
                return;
            }

            if (duration < 5 || duration > 180) {
                showNotification('Duration must be between 5 and 180 minutes', 'error');
                return;
            }

            // Get questions from the question bank
            let allQuestions = [];

            if (chapter === 'Mixed') {
                // Get questions from all chapters for the subject
                const chapters = getChaptersForSubject(type, subject);
                chapters.forEach(chap => {
                    const chapterQuestions = getQuestionsForChapter(type, subject, chap.id);
                    allQuestions = allQuestions.concat(chapterQuestions);
                });
            } else {
                // Get questions from specific chapter
                const chapterId = getChapterIdByName(type, subject, chapter);
                if (chapterId) {
                    allQuestions = getQuestionsForChapter(type, subject, chapterId);
                } else {
                    showNotification('Chapter not found. Please select a valid chapter.', 'error');
                    return;
                }
            }

            // Filter by difficulty if not mixed
            if (difficulty !== 'mixed') {
                allQuestions = allQuestions.filter(q => q.difficulty === difficulty);
            }

            // Check if we have enough questions
            if (allQuestions.length < questionCount) {
                showNotification(`Only ${allQuestions.length} questions available for the selected criteria. Please reduce the number of questions or change the filters.`, 'error');
                return;
            }

            // Randomly select questions
            const selectedQuestions = shuffleArray(allQuestions).slice(0, questionCount);

            const markingInfo = negativeMarking ? 'JEE/NEET Style (+4, -1)' : 'No Negative Marking (+1, 0)';
            showNotification(`Custom test "${title}" created successfully with ${selectedQuestions.length} questions! Marking: ${markingInfo}`, 'success');
            closeCreateTestModal();

            // Start the custom test
            startCustomTestWithQuestions({
                title,
                type,
                subject,
                classLevel,
                chapter,
                difficulty,
                duration,
                questionCount,
                negativeMarking,
                questions: selectedQuestions
            });
        }

        // Helper function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Helper function to get chapter ID by name
        function getChapterIdByName(examType, subject, chapterName) {
            const chapters = getChaptersForSubject(examType, subject);
            const chapter = chapters.find(ch => ch.name.toLowerCase().includes(chapterName.toLowerCase()));
            return chapter ? chapter.id : null;
        }

        // Enhanced function to start custom test with actual questions
        function startCustomTestWithQuestions(testConfig) {
            const testHtml = `
                <div class="custom-test-interface">
                    <div class="test-header">
                        <div class="test-title-section">
                            <h2>${testConfig.title}</h2>
                            <div class="test-meta">
                                <span class="test-badge">${testConfig.type.toUpperCase()}</span>
                                <span class="test-badge">${testConfig.subject.charAt(0).toUpperCase() + testConfig.subject.slice(1)}</span>
                                <span class="test-badge">${testConfig.chapter}</span>
                                <span class="test-badge">${testConfig.difficulty.charAt(0).toUpperCase() + testConfig.difficulty.slice(1)}</span>
                            </div>
                        </div>
                        <button class="test-close-btn" onclick="endCustomTest()" title="Close Test">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="test-info">
                            <div class="info-item">
                                <i class="fas fa-question-circle"></i>
                                <span>${testConfig.questions.length} Questions</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>${testConfig.duration} Minutes</span>
                            </div>
                            <div class="info-item timer-display">
                                <i class="fas fa-stopwatch"></i>
                                <span id="customTestTimer">00:00</span>
                            </div>
                            <div class="info-item marking-scheme-display">
                                <i class="fas fa-calculator"></i>
                                <span>${testConfig.negativeMarking ? '+4, -1' : '+1, 0'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="testProgress" style="width: 0%"></div>
                        </div>
                        <span class="progress-text">Question <span id="currentQuestionNum">1</span> of ${testConfig.questions.length}</span>
                    </div>
                    
                    <div class="test-questions-container" id="customTestQuestions">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="test-navigation">
                        <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="btn btn-secondary" onclick="endCustomTest()">
                            <i class="fas fa-times"></i> End Test
                        </button>
                        <button class="btn btn-info" onclick="debugTestState()" style="font-size: 0.8rem;">
                            <i class="fas fa-bug"></i> Debug
                        </button>
                        <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-success" onclick="submitCustomTest()" id="submitBtn" style="display: none;">
                            <i class="fas fa-check"></i> Submit Test
                        </button>
                    </div>
                </div>
            `;

            // Note: testSection has been removed - custom tests now handled differently
            showNotification('Custom test functionality has been moved to Create Test section', 'info');

            // Initialize test state
            window.currentCustomTest = testConfig;
            window.currentCustomQuestionIndex = 0;
            window.customTestAnswers = {};

            // Load first question
            displayCustomTestQuestion();

            // Start timer
            startCustomTestTimer(testConfig.duration * 60);
        }

        function startQuickTest() {
            startCustomTest({
                title: 'Quick Practice Test',
                type: 'jee',
                subject: 'physics',
                classLevel: '11',
                chapter: 'Mixed',
                difficulty: 'mixed',
                duration: 15,
                questionCount: 10
            });
        }

        function startTest(testId) {
            const test = {
                id: testId,
                title: testId === 'jee-physics-full' ? 'JEE Physics Full Test' : 'NEET Biology Practice',
                questions: generateSampleQuestions(5)
            };

            startCustomTest(test);
        }

        function startCustomTest(test) {
            currentTest = test;
            activeMockQuestionIndex = 0;
            userAnswers = {};
            testStartTime = new Date();

            if (test.duration) {
                startTimer(test.duration * 60);
            }

            displayTestQuestion();
            document.getElementById('testModalTitle').textContent = test.title;
            document.getElementById('testModal').classList.add('active');
        }

        function generateSampleQuestions(count) {
            const questions = [];
            for (let i = 1; i <= count; i++) {
                questions.push({
                    id: `q${i}`,
                    text: `Sample question ${i} for demonstration purposes. This would be replaced with actual questions from the database.`,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    answer: 'A',
                    solution: 'This is the solution to the sample question.',
                    explanation: 'This is a detailed explanation of the solution.'
                });
            }
            return questions;
        }

        function displayTestQuestion() {
            if (!currentTest || !currentTest.questions) return;

            const question = currentTest.questions[activeMockQuestionIndex];
            const testContent = document.getElementById('testContent');

            testContent.innerHTML = `
                <div class="question-container">
                    <div class="question-text">
                        <strong>Question ${currentQuestionIndex + 1}/${currentTest.questions.length}:</strong><br>
                        ${preserveLineBreaks(question.text)}
                    </div>
                    
                    ${question.references ? `
                        <div class="question-references" style="margin: 1rem 0; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">
                                <i class="fas fa-book"></i>
                                References
                            </div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                                ${preserveLineBreaks(question.references)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="options-grid">
                        ${question.options.map((option, index) => {
                const optionLetter = String.fromCharCode(65 + index);
                const isSelected = userAnswers[question.id] === optionLetter;
                return `
                                <div class="option-item ${isSelected ? 'selected' : ''}" 
                                     onclick="selectOption('${question.id}', '${optionLetter}')">
                                    ${optionLetter}. ${preserveLineBreaks(option)}
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;

            document.getElementById('prevQuestion').style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
            document.getElementById('nextQuestion').style.display = currentQuestionIndex < currentTest.questions.length - 1 ? 'inline-flex' : 'none';
            document.getElementById('submitTest').style.display = currentQuestionIndex === currentTest.questions.length - 1 ? 'inline-block' : 'none';
        }

        function selectOption(questionId, option) {
            userAnswers[questionId] = option;
            displayTestQuestion();
        }

        function navigateQuestion(direction) {
            currentQuestionIndex += direction;
            displayTestQuestion();
        }

        function startTimer(durationInSeconds) {
            let timeLeft = durationInSeconds;

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                timeLeft--;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('testTimer').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function submitTest() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            let score = 0;
            currentTest.questions.forEach(question => {
                if (userAnswers[question.id] === question.answer) {
                    score++;
                }
            });

            const percentage = (score / currentTest.questions.length * 100).toFixed(1);
            const timeSpent = Math.floor((new Date() - testStartTime) / 1000);

            document.getElementById('testContent').innerHTML = `
                <div class="card">
                    <h3 style="text-align: center; margin-bottom: 1rem;">Test Completed!</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}/${currentTest.questions.length}</div>
                            <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${percentage}%</div>
                            <div class="stat-label">Percentage</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}</div>
                            <div class="stat-label">Time Taken</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="closeTestModal()">
                            <i class="fas fa-check"></i>
                            Review Results
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('prevQuestion').style.display = 'none';
            document.getElementById('nextQuestion').style.display = 'none';
            document.getElementById('submitTest').style.display = 'none';

            showNotification(`Test submitted! Score: ${score}/${currentTest.questions.length} (${percentage}%)`, 'success');
        }

        function closeTestModal() {
            document.getElementById('testModal').classList.remove('active');
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        // Performance functions
        function loadPerformanceData() {
            document.getElementById('performanceScore').textContent = '78%';
            document.getElementById('testsCompleted').textContent = '12';
            document.getElementById('improvement').textContent = '15%';
            document.getElementById('accuracy').textContent = '82%';

            document.getElementById('testHistory').innerHTML = `
                <div class="test-card">
                    <div class="test-header">
                        <div class="test-title">JEE Physics Full Test</div>
                        <div class="test-meta">
                            <span><i class="fas fa-calendar"></i> 2 days ago</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                        <div><strong>Score:</strong> 65/75</div>
                        <div><strong>Percentage:</strong> 86.7%</div>
                        <div><strong>Time:</strong> 2h 45m</div>
                    </div>
                </div>
                
                <div class="test-card">
                    <div class="test-header">
                        <div class="test-title">NEET Biology Practice</div>
                        <div class="test-meta">
                            <span><i class="fas fa-calendar"></i> 1 week ago</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                        <div><strong>Score:</strong> 38/45</div>
                        <div><strong>Percentage:</strong> 84.4%</div>
                        <div><strong>Time:</strong> 55m</div>
                    </div>
                </div>
            `;
        }

        // AI Guidance functions
        async function getAIGuidance() {
            const query = document.getElementById("aiQuery").value.trim();
            const resultBox = document.getElementById("guidanceResult");

            if (!query) {
                showNotification("Please enter your query before asking for AI guidance.", "warning");
                return;
            }

            // Get token from current user or use student token as fallback
            let token = localStorage.getItem("token");
            if (!token) {
                // Try to get from currentUser
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.role) {
                    token = `${currentUser.role}-token`;
                } else {
                    token = 'student-token'; // Fallback
                }
            }

            try {
                resultBox.innerHTML = `<div style="text-align:center; padding:1rem;"><i class="fas fa-spinner fa-spin"></i> Generating study guidance...</div>`;

                const response = await fetch(`${API_BASE}/api/ai-guidance`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                console.log('ðŸ” Frontend received data:', data);

                if (data.success) {
                    console.log('âœ… Success! Provider:', data.provider);
                    console.log('âœ… Guidance length:', data.guidance ? data.guidance.length : 0);
                    console.log('âœ… Guidance preview:', data.guidance ? data.guidance.substring(0, 200) : 'No guidance');

                    if (data.guidance && data.guidance.trim()) {
                        resultBox.innerHTML = data.guidance;
                    } else {
                        resultBox.innerHTML = `<div style="color:orange;">âš ï¸ Received empty response. Provider: ${data.provider}</div>`;
                    }
                } else {
                    resultBox.innerHTML = `<div style="color:red;">âŒ Failed to get guidance: ${data.error || "Unknown error"}</div>`;
                }
            } catch (err) {
                console.error("AI Guidance Error:", err);
                resultBox.innerHTML = `<div style="color:red;">âŒ Unable to get AI guidance. Check your server and API key.</div>`;
            }
        }

        // Modern Chat Interface Functions
        // chatHistory moved to top of file

        // Utility function to clean up chat data (for testing)
        function clearAllChatData() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.includes('_chat_')) {
                    localStorage.removeItem(key);
                    console.log('ðŸ—‘ï¸ Removed chat data:', key);
                }
            });
            chatHistory = [];
            loadChatHistory();
            console.log('âœ… All chat data cleared');
        }

        // Utility function to show current user's chat data
        function debugUserChats() {
            if (!currentUser) {
                console.log('âŒ No current user');
                return;
            }

            const userKeys = Object.keys(localStorage).filter(key =>
                key.startsWith(`${currentUser.username}_chat_`)
            );

            console.log(`ðŸ“Š Chat data for ${currentUser.username}:`);
            userKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    console.log(`  - ${key}: ${data.title} (${data.messages?.length || 0} messages)`);
                } catch (e) {
                    console.log(`  - ${key}: Invalid data`);
                }
            });
        }

        // Function to force refresh chat history display
        function refreshChatHistory() {
            console.log('ðŸ”„ Refreshing chat history...');
            loadChatHistory();
            showNotification('Chat history refreshed', 'success');
        }

        // Function to check chat saving status
        function checkChatSavingStatus() {
            console.log('ðŸ” Chat Saving Status Check:');
            console.log('  - Current User:', currentUser?.username || 'Not logged in');
            console.log('  - Current Chat ID:', currentChatId || 'No active chat');
            console.log('  - Messages Area:', !!document.querySelector('.ultra-messages-area'));
            console.log('  - Message Count:', document.querySelectorAll('.ultra-message').length);

            if (currentUser && currentChatId) {
                const userChatKey = `${currentUser.username}_${currentChatId}`;
                const savedChat = localStorage.getItem(userChatKey);
                console.log('  - Chat Saved:', !!savedChat);
                console.log('  - Expected Key:', userChatKey);
                if (savedChat) {
                    try {
                        const chatData = JSON.parse(savedChat);
                        console.log('  - Saved Messages:', chatData.messages?.length || 0);
                        console.log('  - Chat Title:', chatData.title);
                    } catch (e) {
                        console.log('  - Error parsing saved chat');
                    }
                }
            }

            debugUserChats();
        }

        // Test function to manually save a test chat
        function testChatSaving() {
            if (!currentUser) {
                console.error('âŒ Please log in first');
                return;
            }

            console.log('ðŸ§ª Testing chat saving...');

            // Create a test chat
            const testChatId = 'chat_test_' + Date.now();
            const testUserMessage = 'Test user message';
            const testAiResponse = 'Test AI response';

            // Save using the same method as the real system
            const userChatKey = `${currentUser.username}_${testChatId}`;
            const chatData = {
                id: testChatId,
                userId: currentUser.username,
                title: 'Test Chat',
                timestamp: new Date().toISOString(),
                messages: [
                    { type: 'user', content: testUserMessage, timestamp: new Date().toISOString() },
                    { type: 'ai', content: testAiResponse, timestamp: new Date().toISOString() }
                ]
            };

            localStorage.setItem(userChatKey, JSON.stringify(chatData));
            console.log('âœ… Test chat saved with key:', userChatKey);

            // Reload chat history
            loadChatHistory();
            console.log('âœ… Chat history reloaded');
        }



        // Auto-save chat before page unload
        window.addEventListener('beforeunload', function (event) {
            if (currentUser && currentChatId && hasUltraMessages()) {
                saveChatToHistory();
                console.log('ðŸ’¾ Auto-saved chat before page unload');
            }
        });

        // Auto-save chat when page becomes hidden (mobile/tab switching)
        document.addEventListener('visibilitychange', function () {
            if (document.hidden && currentUser && currentChatId && hasUltraMessages()) {
                saveChatToHistory();
                console.log('ðŸ’¾ Auto-saved chat on visibility change');
            }
        });

        // Periodic auto-save every 2 minutes (as backup)
        setInterval(function () {
            if (currentUser && currentChatId && hasUltraMessages()) {
                saveChatToHistory();
                console.log('ðŸ’¾ Periodic auto-save completed');
            }
        }, 120000); // 2 minutes

        // Log that automatic saving is enabled
        console.log('ðŸ”„ Automatic chat saving system initialized:');
        console.log('  âœ… Auto-save after AI responses');
        console.log('  âœ… Auto-save on page unload');
        console.log('  âœ… Auto-save on tab switching');
        console.log('  âœ… Auto-save every 2 minutes');
        console.log('  âœ… Auto-save when starting new chat');
        console.log('  âœ… Auto-save when logging out');

        function toggleSidebar() {
            const sidebar = document.querySelector('.chatgpt-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Ultra Modern AI Interface Functions
        function sendQuickMessage(message) {
            const input = document.getElementById('ultraChatInput');
            if (input) {
                input.value = message;
                sendUltraMessage();
            }
        }



        function sendUltraMessage() {
            console.log('ðŸš€ sendUltraMessage called');
            const input = document.getElementById('ultraChatInput');

            if (!input) {
                console.error('âŒ ultraChatInput element not found');
                return;
            }

            const message = input.value.trim();
            console.log('ðŸ“ Message:', message);

            if (!message && processedFileData.length === 0) {
                console.log('âš ï¸ Empty message and no files, returning');
                showNotification('Please enter a message or attach files', 'warning');
                return;
            }

            // Initialize chat ID if not exists
            if (!currentChatId) {
                currentChatId = generateChatId();
                console.log('ðŸ†” Generated new chat ID:', currentChatId);
            }

            // Clear input
            input.value = '';
            adjustUltraTextarea(input);

            // Switch to chat view and add message
            switchToUltraChatView();
            
            if (message) {
                addUltraMessage('user', message);
            }

            // Show file attachments in chat
            if (processedFileData.length > 0) {
                const fileMessage = `ðŸ“Ž Attached ${processedFileData.length} file(s): ${processedFileData.map(f => f.name).join(', ')}`;
                addUltraMessage('system', fileMessage);
            }

            // Show typing indicator
            showUltraTypingIndicator();

            // Create enhanced message with file attachments
            const enhancedMessage = {
                text: message || '',
                files: processedFileData.map(file => ({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: file.content,
                    options: {
                        extractText: file.extractText,
                        analyzeImages: file.analyzeImages,
                        summarizeContent: file.summarizeContent,
                        detectLanguage: file.detectLanguage
                    }
                }))
            };

            // Send to AI with file data
            sendToAIWithFiles(enhancedMessage);
            
            // Clear attachments after sending
            if (processedFileData.length > 0) {
                clearAttachedFiles();
            }
            
            console.log('âœ… Message sent to AI with files');
        }

        // Enhanced AI sending function for Ultra interface
        async function sendToAIWithFiles(messageData) {
            console.log('ðŸ“Ž Ultra: Sending message with files:', messageData);
            console.log('ðŸ“Ž Ultra: Files count:', messageData.files?.length || 0);
            console.log('ðŸ“Ž Ultra: Message text:', messageData.text);
            try {
                const response = await fetch(`${API_BASE}/api/ai-guidance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'student-token'}`
                    },
                    body: JSON.stringify({
                        query: messageData.text,
                        files: messageData.files,
                        preferredProvider: 'cohere' // Prioritize Cohere for file processing
                    })
                });

                const data = await response.json();
                console.log('ðŸ“Ž Ultra: Server response:', data);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('ultraTypingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                if (data.success) {
                    const aiResponse = data.response || data.guidance || 'No response received from AI';
                    addUltraMessage('ai', aiResponse);
                } else {
                    console.error('âŒ Ultra: Server error:', data.error);
                    addUltraMessage('ai', `Sorry, I encountered an error: ${data.error || 'Unknown error'}. Please try again.`);
                }
            } catch (error) {
                console.error('Error sending message with files:', error);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('ultraTypingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                addUltraMessage('ai', 'Sorry, I encountered a network error. Please check your connection and try again.');
            }
        }

        function showUltraTypingIndicator() {
            const messagesContainer = document.getElementById('ultraMessagesContainer');
            if (!messagesContainer) return;

            // Create typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ultra-message ai typing';
            typingDiv.id = 'ultraTypingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function hideUltraTypingIndicator() {
            const typingIndicator = document.getElementById('ultraTypingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function switchToUltraChatView() {
            const welcomeScreen = document.querySelector('.welcome-screen');
            const messagesContainer = document.getElementById('ultraMessagesContainer');

            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Create messages area if it doesn't exist
            if (!document.querySelector('.ultra-messages-area')) {
                const messagesArea = document.createElement('div');
                messagesArea.className = 'ultra-messages-area';
                messagesContainer.appendChild(messagesArea);
            }
        }

        function addUltraMessage(sender, message) {
            // Safety check for undefined message
            if (message === undefined || message === null) {
                console.warn('addUltraMessage called with undefined/null message');
                message = 'No response received';
            }
            
            // Ensure we have a messages area
            let messagesArea = document.querySelector('.ultra-messages-area');
            if (!messagesArea) {
                switchToUltraChatView();
                messagesArea = document.querySelector('.ultra-messages-area');
                if (!messagesArea) {
                    console.error('Could not create ultra messages area');
                    return;
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `ultra-message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'ultra-message-avatar';
            avatar.innerHTML = sender === 'user' ?
                '<i class="fas fa-user"></i>' :
                '<i class="fas fa-robot"></i>';

            const content = document.createElement('div');
            content.className = 'ultra-message-content';

            // Format message content for better display
            let formattedMessage = message || '';

            // If it's not already HTML, convert line breaks to proper formatting
            if (!message || (!message.includes('<') || !message.includes('>'))) {
                // Convert double line breaks to paragraphs
                formattedMessage = message
                    .split('\n\n')
                    .map(paragraph => paragraph.trim())
                    .filter(paragraph => paragraph.length > 0)
                    .map(paragraph => {
                        // Convert single line breaks to <br> within paragraphs
                        let formatted = paragraph.replace(/\n/g, '<br>');

                        // Basic markdown-style formatting
                        formatted = formatted
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                            .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                            .replace(/`(.*?)`/g, '<code>$1</code>'); // Inline code

                        return `<p>${formatted}</p>`;
                    })
                    .join('');
            }

            content.innerHTML = formattedMessage;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesArea.appendChild(messageDiv);

            // Render math if MathJax is available
            if (window.MathJax && window.MathJax.typesetPromise) {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    window.MathJax.typesetPromise([content]).then(() => {
                        console.log('âœ… Math rendered in message');
                    }).catch((err) => {
                        console.error('âŒ Math rendering error:', err);
                    });
                }, 100);
            }

            // Smooth scroll to bottom
            messagesArea.scrollTo({
                top: messagesArea.scrollHeight,
                behavior: 'smooth'
            });

            // Auto-save chat after adding message (especially for AI responses)
            if (sender === 'ai' && currentUser && currentChatId) {
                // Small delay to ensure message is fully rendered, then save via DOM
                setTimeout(() => {
                    saveChatToHistory();
                    console.log('ðŸ”„ Auto-saved chat after AI response (DOM method)');
                }, 500);
            }
        }

        function handleUltraKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendUltraMessage();
            }
        }

        function adjustUltraTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function clearChat() {
            const messagesArea = document.querySelector('.ultra-messages-area');
            const welcomeScreen = document.querySelector('.welcome-screen');

            if (messagesArea) {
                messagesArea.remove();
            }

            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
            }

            showNotification('Chat cleared', 'success');
        }

        function exportChat() {
            showNotification('Export feature coming soon!', 'info');
        }

        function toggleTheme() {
            showNotification('Theme toggle coming soon!', 'info');
        }

        function toggleFileUpload() {
            showNotification('File upload feature coming soon!', 'info');
        }

        function toggleVoiceInput() {
            showNotification('Voice input feature coming soon!', 'info');
        }

        // Navigation between views
        document.addEventListener('DOMContentLoaded', function () {
            const navBtns = document.querySelectorAll('.nav-floating-btn');
            const contentViews = document.querySelectorAll('.content-view');

            navBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetView = this.getAttribute('data-view') + 'View';

                    // Update active nav button
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Show target view
                    contentViews.forEach(view => view.classList.remove('active'));
                    const target = document.getElementById(targetView);
                    if (target) {
                        target.classList.add('active');
                    }
                });
            });

            // Handle ultra input
            const ultraInput = document.getElementById('ultraChatInput');
            if (ultraInput) {
                ultraInput.addEventListener('keydown', handleUltraKeydown);
                ultraInput.addEventListener('input', function () {
                    adjustUltraTextarea(this);
                });
            }
        });

        // Add slide-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        // Fixed addMessageToChat function for current AI interface
        function addMessageToChat(sender, message) {
            // Safety check for undefined message
            if (message === undefined || message === null) {
                console.warn('addMessageToChat called with undefined/null message');
                message = 'No response received';
            }
            
            console.log('ðŸ’¬ Adding message to chat:', sender, message);
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('âŒ Chat messages container not found');
                return;
            }

            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
                console.log('âœ… Welcome message hidden');
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.style.cssText = `
                display: flex;
                gap: 16px;
                margin-bottom: 20px;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
                animation: fadeInUp 0.3s ease-out;
                ${sender === 'user' ? 'flex-direction: row-reverse;' : ''}
            `;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: 600;
                flex-shrink: 0;
                ${sender === 'user' ?
                    'background: #6366f1; color: white;' :
                    'background: #10b981; color: white;'
                }
            `;
            avatar.innerHTML = sender === 'user' ?
                '<i class="fas fa-user"></i>' :
                '<i class="fas fa-robot"></i>';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.style.cssText = `
                flex: 1;
                padding: 16px 20px;
                background: ${sender === 'user' ? '#6366f1' : '#ffffff'};
                color: ${sender === 'user' ? 'white' : '#2d3748'};
                border-radius: 16px;
                border: 1px solid ${sender === 'user' ? '#6366f1' : '#e2e8f0'};
                line-height: 1.6;
                font-size: 15px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            `;
            content.innerHTML = message.replace(/\n/g, '<br>');

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('âœ… Message added and scrolled to bottom');
        }

        // Fixed applySuggestion function
        function applySuggestion(suggestion) {
            console.log('ðŸ’¡ Applying suggestion:', suggestion);
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = suggestion;
                sendMessage();
            }
        }

        // Chat History Management

        function startNewChat() {
            console.log('ðŸ†• Starting new chat');

            // Save current chat if it has messages
            if (currentChatId && hasUltraMessages()) {
                saveChatToHistory();
            }

            // Clear current chat
            currentChatId = generateChatId();
            clearUltraChatMessages();
            showUltraWelcomeMessage();
            updateChatHistoryDisplay();

            console.log('âœ… New chat started with ID:', currentChatId);
        }

        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function hasMessages() {
            const chatMessages = document.getElementById('chatMessages');
            const messages = chatMessages.querySelectorAll('.chat-message');
            return messages.length > 0;
        }

        function hasUltraMessages() {
            const messagesArea = document.querySelector('.ultra-messages-area');
            if (!messagesArea) return false;
            const messages = messagesArea.querySelectorAll('.ultra-message');
            return messages.length > 0;
        }

        function clearUltraChatMessages() {
            const messagesArea = document.querySelector('.ultra-messages-area');
            if (messagesArea) {
                messagesArea.remove();
            }
        }

        function showUltraWelcomeMessage() {
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
            }
        }

        function clearChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                // Remove all chat messages but keep welcome message
                const messages = chatMessages.querySelectorAll('.chat-message');
                messages.forEach(msg => msg.remove());
            }
        }

        function showWelcomeMessage() {
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'block';
            }
        }

        function saveChatToHistory() {
            console.log('ðŸ’¾ REDIRECTING TO HARDCODED CHAT SAVING');

            // Extract messages from DOM and use hardcoded save
            const messagesArea = document.querySelector('.ultra-messages-area');
            if (!messagesArea) {
                console.log('âŒ No messages area found');
                return;
            }

            const messages = messagesArea.querySelectorAll('.ultra-message');
            if (messages.length < 2) {
                console.log('âŒ Need at least user + AI message to save');
                return;
            }

            // Get last user and AI messages
            let lastUserMessage = '';
            let lastAiMessage = '';

            // Find the last user message and last AI message
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                const content = msg.querySelector('.ultra-message-content');
                if (!content) continue;

                if (msg.classList.contains('user') && !lastUserMessage) {
                    lastUserMessage = content.textContent || content.innerHTML;
                } else if (msg.classList.contains('ai') && !lastAiMessage) {
                    lastAiMessage = content.textContent || content.innerHTML;
                }

                if (lastUserMessage && lastAiMessage) break;
            }

            console.log('ðŸ“ Extracted messages for hardcoded save:');
            console.log('  User:', lastUserMessage.substring(0, 50));
            console.log('  AI:', lastAiMessage.substring(0, 50));

            // Use hardcoded save function
            if (lastUserMessage && lastAiMessage) {
                saveChatMessage(lastUserMessage, lastAiMessage);
            } else {
                console.log('âŒ Could not extract both user and AI messages');
            }
        }

        function loadChatHistory() {
            console.log('ðŸ“š Loading chat history for user:', currentUser?.username);
            console.log('ðŸ” localStorage keys:', Object.keys(localStorage));

            // Debug: Show all keys that match current user
            const userKeys = Object.keys(localStorage).filter(key =>
                key.startsWith(`${currentUser?.username}_chat_`)
            );
            console.log('ðŸ” User-specific chat keys:', userKeys);
            chatHistory = [];

            if (!currentUser || !currentUser.username) {
                console.log('âš ï¸ No current user, skipping chat history load');
                updateChatHistoryDisplay();
                return;
            }

            // Load from localStorage - only for current user
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Look for user-specific chat keys (format: username_chat_timestamp_randomstring)
                if (key && key.startsWith(`${currentUser.username}_chat_`)) {
                    try {
                        const chatData = JSON.parse(localStorage.getItem(key));
                        if (chatData && chatData.title && chatData.messages && chatData.userId === currentUser.username) {
                            chatHistory.push(chatData);
                            console.log('ðŸ“– Loaded chat for user:', chatData.title);
                        }
                    } catch (e) {
                        console.error('Error loading chat:', key, e);
                    }
                }
            }

            // Sort by timestamp (newest first)
            chatHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            console.log('ðŸ“š Total chats loaded for', currentUser.username + ':', chatHistory.length);
            updateChatHistoryDisplay();
        }

        function updateChatHistoryDisplay() {
            console.log('ðŸ”„ updateChatHistoryDisplay called');
            const historyList = document.getElementById('chatHistoryList');
            const historyTitle = document.getElementById('chatHistoryTitle');

            console.log('  - historyList element:', !!historyList);
            console.log('  - historyTitle element:', !!historyTitle);

            if (!historyList) {
                console.error('âŒ chatHistoryList element not found');
                return;
            }

            // Ensure chatHistory is initialized
            if (!chatHistory) {
                chatHistory = [];
            }

            console.log('  - chatHistory length:', chatHistory.length);

            // Update title with count
            if (historyTitle) {
                historyTitle.textContent = `TODAY (${chatHistory.length})`;
                console.log('âœ… Updated title to:', historyTitle.textContent);
            }

            if (chatHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-comments"></i>
                        <p>No chats yet</p>
                        <small>Start a new chat to begin!</small>
                    </div>
                `;
                return;
            }

            // Display chat history
            historyList.innerHTML = chatHistory.map(chat => `
                <div class="chat-history-item ${chat.id === currentChatId ? 'active' : ''}" 
                     onclick="loadChat('${chat.id}')" 
                     title="${chat.title}">
                    ${chat.title}
                </div>
            `).join('');
        }

        function loadChat(chatId) {
            console.log('ðŸ“– Loading chat:', chatId, 'for user:', currentUser?.username);

            if (!currentUser || !currentUser.username) {
                console.error(' No current user for loading chat');
                return;
            }

            // Save current chat first
            if (currentChatId && hasUltraMessages()) {
                saveChatToHistory();
            }

            // Create user-specific key
            const userChatKey = `${currentUser.username}_${chatId}`;

            // Load selected chat
            const chatData = JSON.parse(localStorage.getItem(userChatKey));
            if (!chatData) {
                console.error('Chat not found for user:', currentUser.username, 'chatId:', chatId);
                return;
            }

            // Verify chat belongs to current user
            if (chatData.userId !== currentUser.username) {
                console.error('âŒ Chat does not belong to current user');
                return;
            }

            currentChatId = chatId;
            clearUltraChatMessages();

            // Hide welcome message
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Create messages area and load messages
            switchToUltraChatView();
            const messagesArea = document.querySelector('.ultra-messages-area');
            if (messagesArea && chatData.messages) {
                chatData.messages.forEach(msg => {
                    addUltraMessage(msg.type, msg.content);
                });
            }

            updateChatHistoryDisplay();
            console.log('âœ… Chat loaded successfully for user:', currentUser.username);
        }

        function clearCurrentChat() {
            if (confirm('Are you sure you want to clear this chat?')) {
                clearChatMessages();
                showWelcomeMessage();
                currentChatId = null;
                console.log('ðŸ—‘ï¸ Current chat cleared');
            }
        }

        function exportChat() {
            if (!currentChatId || !hasMessages()) {
                console.log('No chat to export');
                return;
            }

            const chatMessages = document.getElementById('chatMessages');
            const messages = chatMessages.querySelectorAll('.chat-message');

            let exportText = 'EduSphere AI Chat Export\n';
            exportText += '========================\n\n';

            messages.forEach(msg => {
                const type = msg.classList.contains('user') ? 'You' : 'AI';
                const content = msg.querySelector('.message-content').textContent;
                exportText += `${type}: ${content}\n\n`;
            });

            // Create download
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('ðŸ“¥ Chat exported');
        }

        function toggleChatSidebar() {
            const sidebar = document.querySelector('.chatgpt-sidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
            }
        }

        // Logout function
        function logoutUser() {
            console.log('ðŸ‘‹ Logging out user:', currentUser?.username);

            // Save current chat before logout
            if (currentChatId && hasUltraMessages()) {
                saveChatToHistory();
            }

            // Clear user data
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');

            // Reset UI
            currentUser = null;
            currentChatId = null;
            chatHistory = [];

            // Clear chat history display
            const historyList = document.getElementById('chatHistoryList');
            if (historyList) {
                historyList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-comments"></i>
                        <p>No chats yet</p>
                        <small>Start a new chat to begin!</small>
                    </div>
                `;
            }



            // Show auth section
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');

            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'flex';
            }
            if (dashboard) {
                dashboard.classList.add('hidden');
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }

            console.log('âœ… User logged out successfully');
        }

        function sendSuggestion(text) {
            const mainInput = document.getElementById('mainChatInput');
            const bottomInput = document.getElementById('bottomChatInput');

            if (mainInput && mainInput.offsetParent !== null) {
                mainInput.value = text;
            } else if (bottomInput && bottomInput.offsetParent !== null) {
                bottomInput.value = text;
            }

            sendNewMessage();
        }

        function sendNewMessage() {
            const mainInput = document.getElementById('mainChatInput');
            const bottomInput = document.getElementById('bottomChatInput');

            let message = '';
            let inputElement = null;

            if (mainInput && mainInput.offsetParent !== null && mainInput.value.trim()) {
                message = mainInput.value.trim();
                inputElement = mainInput;
            } else if (bottomInput && bottomInput.offsetParent !== null && bottomInput.value.trim()) {
                message = bottomInput.value.trim();
                inputElement = bottomInput;
            }

            if (!message) return;

            // Clear the input
            if (inputElement) {
                inputElement.value = '';
            }

            // Switch to chat view and add message
            switchToChatView();
            addNewMessageToChat('user', message);

            // Send to AI
            sendToAI(message);
        }

        function switchToChatView() {
            const welcomeScreen = document.querySelector('.new-welcome-screen');
            const altWelcome = document.querySelector('.alternative-welcome');
            const chatMessages = document.getElementById('newChatMessages');

            if (welcomeScreen) welcomeScreen.style.display = 'none';
            if (altWelcome) altWelcome.style.display = 'none';

            // Create chat messages container if it doesn't exist
            if (!document.querySelector('.chat-messages-container')) {
                const container = document.createElement('div');
                container.className = 'chat-messages-container';
                container.style.cssText = `
                    flex: 1;
                    overflow-y: auto;
                    padding: 24px;
                    display: flex;
                    flex-direction: column;
                    gap: 24px;
                `;
                chatMessages.appendChild(container);
            }
        }

        function addNewMessageToChat(sender, message) {
            const container = document.querySelector('.chat-messages-container');
            if (!container) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `new-chat-message ${sender}`;
            messageDiv.style.cssText = `
                display: flex;
                gap: 16px;
                max-width: 768px;
                margin: 0 auto;
                width: 100%;
                ${sender === 'user' ? 'flex-direction: row-reverse;' : ''}
            `;

            const avatar = document.createElement('div');
            avatar.className = 'new-message-avatar';
            avatar.style.cssText = `
                width: 32px;
                height: 32px;
                border-radius: 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: 600;
                flex-shrink: 0;
                ${sender === 'user' ?
                    'background: #5436da; color: white;' :
                    'background: #10a37f; color: white;'
                }
            `;
            avatar.innerHTML = sender === 'user' ?
                '<i class="fas fa-user"></i>' :
                '<i class="fas fa-robot"></i>';

            const content = document.createElement('div');
            content.className = 'new-message-content';
            content.style.cssText = `
                flex: 1;
                padding: 16px 20px;
                background: ${sender === 'user' ? '#f7f7f8' : '#ffffff'};
                border-radius: 16px;
                border: 1px solid #e5e7eb;
                line-height: 1.6;
                font-size: 15px;
                color: #2d333a;
            `;
            content.innerHTML = message;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            container.appendChild(messageDiv);

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Toggle between welcome designs
        function toggleWelcomeDesign() {
            const newWelcome = document.querySelector('.new-welcome-screen');
            const altWelcome = document.querySelector('.alternative-welcome');

            if (newWelcome.style.display !== 'none') {
                newWelcome.style.display = 'none';
                altWelcome.style.display = 'flex';
            } else {
                newWelcome.style.display = 'flex';
                altWelcome.style.display = 'none';
            }
        }

        // Handle Enter key for new inputs
        document.addEventListener('DOMContentLoaded', function () {
            const mainInput = document.getElementById('mainChatInput');
            const bottomInput = document.getElementById('bottomChatInput');
            const chatInput = document.getElementById('chatInput');

            if (mainInput) {
                mainInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendNewMessage();
                    }
                });
            }

            // Add Enter key support for the main chat input
            if (chatInput) {
                chatInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                console.log('âœ… Enter key listener added to chat input');
            }

            if (bottomInput) {
                bottomInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendNewMessage();
                    }
                });
            }
        });

        // Check AI connection status
        async function checkAIConnection() {
            try {
                const response = await fetch('/api/ai-status');
                const data = await response.json();

                if (!data.ai_configured) {
                    console.warn('âš ï¸ AI not configured properly');
                } else {
                    console.log('âœ… AI connection verified');
                }
            } catch (error) {
                console.error('âŒ Failed to check AI status:', error);
            }
        }

        async function listGeminiModels() {
            try {
                console.log('ðŸ” Fetching available models...');
                const response = await fetch('/api/list-models');

                console.log('ðŸ“¡ Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ðŸ“‹ Models data:', data);

                const resultDiv = document.getElementById('aiStatusResult');

                if (data.success) {
                    let modelsList = '';
                    if (data.models && data.models.length > 0) {
                        modelsList = data.models.map(model => `<li>${model.name}</li>`).join('');
                    } else {
                        modelsList = '<li>No models found</li>';
                    }

                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--info); color: white; padding: 1rem;">
                            <h4>ðŸ“‹ Available Gemini Models (${data.count})</h4>
                            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                                ${modelsList}
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--error); color: white; padding: 1rem;">
                            <h4>âŒ Failed to List Models</h4>
                            <p><strong>Error:</strong> ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error listing models:', error);
                const resultDiv = document.getElementById('aiStatusResult');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--error); color: white; padding: 1rem;">
                            <h4>âŒ Connection Error</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p>Make sure the server is running and accessible.</p>
                        </div>
                    `;
                }
            }
        }

        function startNewChatOld() {
            currentChatId = null; // Reset current chat ID
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="welcome-center">
                        <div class="welcome-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h1 class="welcome-title">How can I help you today?</h1>
                        
                        <div class="suggestion-grid">
                            <div class="suggestion-item" onclick="sendSuggestion('Create a study plan')">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Create a study plan</span>
                            </div>
                            <div class="suggestion-item" onclick="sendSuggestion('Explain a concept')">
                                <i class="fas fa-lightbulb"></i>
                                <span>Explain a concept</span>
                            </div>
                            <div class="suggestion-item" onclick="sendSuggestion('Solve a problem')">
                                <i class="fas fa-calculator"></i>
                                <span>Solve a problem</span>
                            </div>
                            <div class="suggestion-item" onclick="sendSuggestion('Practice questions')">
                                <i class="fas fa-question-circle"></i>
                                <span>Practice questions</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = '';
                chatInput.focus();
            }

            uploadedFiles = [];
            updateFileUploadArea();
            updateChatHistory(); // Refresh the sidebar
        }

        // Missing utility functions
        function updateFileUploadArea() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const uploadedFilesDiv = document.getElementById('uploadedFiles');

            if (!fileUploadArea || !uploadedFilesDiv) return;

            if (uploadedFiles.length > 0) {
                fileUploadArea.style.display = 'block';
                uploadedFilesDiv.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="file-tag">
                        <i class="fas fa-file"></i>
                        <span>${file.name}</span>
                        <span class="remove-file" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `).join('');
            } else {
                fileUploadArea.style.display = 'none';
                uploadedFilesDiv.innerHTML = '';
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileUploadArea();
        }

        function adjustTextareaHeight(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function sendSuggestion(suggestion) {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = suggestion;
                sendMessage();
            }
        }



        // Authentication toggle functions
        function showLogin() {
            document.getElementById('loginToggle').classList.add('active');
            document.getElementById('registerToggle').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('registerForm').classList.remove('active');
        }

        function showRegister() {
            document.getElementById('loginToggle').classList.remove('active');
            document.getElementById('registerToggle').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
        }

        // Role dropdown functions
        function toggleRoleDropdown(roleId) {
            const dropdown = document.getElementById(roleId + 'Dropdown');
            const options = document.getElementById(roleId + 'Options');
            const selected = dropdown.querySelector('.role-selected');

            // Close other dropdowns
            document.querySelectorAll('.role-options').forEach(opt => {
                if (opt.id !== roleId + 'Options') {
                    opt.classList.remove('show');
                    opt.parentElement.querySelector('.role-selected').classList.remove('active');
                }
            });

            // Toggle current dropdown
            const isOpen = options.classList.contains('show');
            if (isOpen) {
                options.classList.remove('show');
                selected.classList.remove('active');
            } else {
                options.classList.add('show');
                selected.classList.add('active');
            }
        }

        function selectRole(roleId, value) {
            const dropdown = document.getElementById(roleId + 'Dropdown');
            const options = document.getElementById(roleId + 'Options');
            const selected = dropdown.querySelector('.role-selected');
            const roleText = selected.querySelector('.role-text');
            const roleIcon = selected.querySelector('.role-icon');
            const hiddenInput = document.getElementById(roleId);

            // Update selected option
            const selectedOption = options.querySelector(`[data-value="${value}"]`);
            const title = selectedOption.querySelector('.role-option-title').textContent;
            const icon = selectedOption.querySelector('.role-option-icon i').className;

            // Update display
            roleText.textContent = title;
            roleIcon.className = icon + ' role-icon';
            hiddenInput.value = value;

            // Update selected state
            options.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
            selectedOption.classList.add('selected');

            // Close dropdown
            options.classList.remove('show');
            selected.classList.remove('active');

            // Trigger validation
            hiddenInput.dispatchEvent(new Event('change'));
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.role-dropdown')) {
                document.querySelectorAll('.role-options').forEach(options => {
                    options.classList.remove('show');
                    options.parentElement.querySelector('.role-selected').classList.remove('active');
                });
            }
        });

        // Enhanced form interactions
        document.addEventListener('DOMContentLoaded', function () {
            // Add focus/blur effects to enhanced form selects
            const enhancedSelects = document.querySelectorAll('.enhanced-form-select');

            enhancedSelects.forEach(select => {
                select.addEventListener('focus', function () {
                    this.parentElement.classList.add('focused');
                });

                select.addEventListener('blur', function () {
                    this.parentElement.classList.remove('focused');
                });

                select.addEventListener('change', function () {
                    if (this.value) {
                        this.classList.add('has-value');
                        // Update chapters when subject changes
                        if (this.id === 'enhancedSubject') {
                            updateEnhancedChapterDropdown();
                        }
                    } else {
                        this.classList.remove('has-value');
                    }
                });
            });

            // Initialize chapter dropdown after a short delay to ensure all variables are loaded
            setTimeout(async () => {
                console.log('ðŸ”„ Initializing enhanced chapter dropdown...');
                await updateEnhancedChapterDropdown();
            }, 100);
        });

        // Chapter dropdown functions
       
        // Comprehensive test of question saving and loading
        async function testCompleteQuestionFlow() {
            console.log('ðŸ§ª Testing complete question flow...');

            // Step 1: Test API connection
            console.log('ðŸ“¡ Step 1: Testing API connection...');
            const apiTest = await testAPIConnection();
            if (!apiTest) {
                showNotification('âŒ API connection failed', 'error');
                return;
            }

            // Step 2: Create a test chapter first
            console.log('ðŸ“š Step 2: Creating test chapter...');
            try {
                const chapterResponse = await fetch(`${API_BASE}/api/chapters`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify({
                        examType: 'jee',
                        subject: 'physics',
                        name: 'Test Chapter for Questions',
                        description: 'A test chapter',
                        icon: 'fa-flask'
                    })
                });

                const chapterData = await chapterResponse.json();
                console.log('ðŸ“š Chapter creation result:', chapterData);
            } catch (error) {
                console.log('âš ï¸ Chapter creation failed (might already exist):', error.message);
            }

            // Step 3: Create a test question
            console.log('ðŸ“ Step 3: Creating test question...');
            await testQuestionSaving();

            // Step 4: Load questions and verify
            console.log('ðŸ” Step 4: Loading questions to verify...');
            try {
                realQuestionsData = []; // Clear cache
                isLoadingRealQuestions = false; // Reset flag
                await loadRealQuestions();

                if (realQuestionsData.length > 0) {
                    showNotification(`âœ… Complete test successful! Found ${realQuestionsData.length} questions in database`, 'success');
                } else {
                    showNotification('âš ï¸ Questions saved but not found in database', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error loading questions:', error);
                showNotification('âŒ Error loading questions after save', 'error');
            }
        }

        // Test question saving API directly
        async function testQuestionSaving() {
            console.log('ðŸ§ª Testing question saving API...');

            const testData = {
                examType: 'jee',
                subject: 'physics',
                class: '12',
                chapter: 'Test Chapter',
                difficulty: 'medium',
                question: {
                    text: 'What is 2 + 2?',
                    options: ['2', '3', '4', '5'],
                    answer: '4',
                    solution: '2 + 2 = 4',
                    explanation: 'Basic addition'
                }
            };

            try {
                console.log('ðŸ“¤ Sending test question data:', testData);

                const response = await fetch(`${API_BASE}/api/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify(testData)
                });

                console.log('ðŸ“¡ Response status:', response.status);
                console.log('ðŸ“¡ Response headers:', [...response.headers.entries()]);

                const responseText = await response.text();
                console.log('ðŸ“¦ Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('âŒ JSON parse error:', parseError);
                    showNotification('âŒ Invalid server response', 'error');
                    return;
                }

                if (data.success) {
                    showNotification('âœ… Test question saved successfully!', 'success');
                    console.log('âœ… Test question saved:', data.question);
                } else {
                    showNotification(`âŒ Error: ${data.error}`, 'error');
                    console.error('âŒ Server error:', data.error);
                }
            } catch (error) {
                console.error('âŒ Network error:', error);
                showNotification(`âŒ Network error: ${error.message}`, 'error');
            }
        }

        // Create a test question for demonstration (admin only)
        async function createTestQuestion() {
            try {
                console.log('ðŸ“ Creating test question...');

                const testQuestionData = {
                    examType: 'jee',
                    subject: 'physics',
                    class: '12',
                    chapter: 'Test Chapter - Mechanics',
                    difficulty: 'medium',
                    question: {
                        text: 'A ball is thrown vertically upward with initial velocity 20 m/s. Find the maximum height reached. (Take g = 10 m/sÂ²)',
                        options: ['15 m', '20 m', '25 m', '30 m'],
                        answer: '20 m',
                        solution: 'Using vÂ² = uÂ² + 2as, at maximum height v = 0. So, 0 = (20)Â² - 2(10)h. Therefore, h = 400/20 = 20 m',
                        explanation: 'At maximum height, the velocity becomes zero. Using kinematic equation vÂ² = uÂ² + 2as.'
                    }
                };

                const response = await fetch('/api/questions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testQuestionData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`âœ… Test question created successfully!`, 'success');
                    console.log('âœ… Test question created:', data.question);

                    // Refresh question management if visible
                    if (typeof loadQuestionManagement === 'function') {
                        loadQuestionManagement();
                    }
                } else {
                    showNotification(`âŒ Error: ${data.error}`, 'error');
                    console.error('âŒ Error creating test question:', data.error);
                }
            } catch (error) {
                console.error('âŒ Error creating test question:', error);
                showNotification('âŒ Failed to create test question. Please try again.', 'error');
            }
        }

        // Create a test chapter for demonstration (admin only)
        async function createTestChapter() {
            try {
                console.log('ðŸ“š Creating test chapter for Physics (will be shared between JEE and NEET)...');

                const response = await fetch('/api/chapters', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        examType: 'jee',
                        subject: 'physics',
                        name: 'Kinematics',
                        description: 'Study of motion without considering forces',
                        icon: 'fa-running'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const message = data.chapters && data.chapters.length > 1
                        ? `âœ… Physics chapter created for both JEE and NEET!`
                        : `âœ… Test chapter created successfully!`;

                    showNotification(message, 'success');
                    console.log('âœ… Test chapter created:', data.chapter || data.chapters);

                    // Refresh the current view if we're in question bank
                    if (currentExamType && currentSubject) {
                        await loadChapters(currentExamType, currentSubject);
                    }
                } else {
                    showNotification(`âŒ Error: ${data.error}`, 'error');
                    console.error('âŒ Error creating test chapter:', data.error);
                }
            } catch (error) {
                console.error('âŒ Error creating test chapter:', error);
                showNotification('âŒ Failed to create test chapter. Please try again.', 'error');
            }
        }

        // Clear ALL questions from database (admin only)
        async function clearAllQuestionsFromDatabase() {
            if (confirm('âš ï¸ DANGER: This will permanently delete ALL questions from the database. This action cannot be undone. Are you absolutely sure?')) {
                try {
                    console.log('ðŸ—‘ï¸ Clearing ALL questions from database...');

                    const response = await fetch('/api/admin/questions/clear-all', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Reload questions data
                        allQuestionsData = [];
                        realQuestionsData = [];

                        showNotification(`âœ… All questions deleted from database (${data.deletedCount} questions)`, 'success');
                        console.log('âœ… All questions cleared from database');

                        // Refresh admin panel if visible
                        if (document.getElementById('adminSection').style.display !== 'none') {
                            loadQuestionManagement();
                        }
                    } else {
                        showNotification(`âŒ Error: ${data.error}`, 'error');
                        console.error('âŒ Error clearing all questions:', data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error clearing all questions:', error);
                    showNotification('âŒ Failed to clear all questions. Please try again.', 'error');
                }
            }
        }

        // DEBUG: Test admin access function
        // DEBUG FUNCTION REMOVED

        // DEBUG: Force show admin panel
        function forceShowAdminPanel() {
            console.log('ðŸ”§ Force showing admin panel...');

            const adminNav = document.getElementById('adminNavItem');
            const adminDropdown = document.getElementById('adminDropdownItem');

            if (adminNav) {
                adminNav.style.display = 'flex';
                adminNav.style.visibility = 'visible';
                console.log('âœ… Admin nav forced visible');
            }

            if (adminDropdown) {
                adminDropdown.style.display = 'block';
                adminDropdown.style.visibility = 'visible';
                console.log('âœ… Admin dropdown forced visible');
            }

            console.log('ðŸ”§ Force show completed');
        }

        // Quick admin login function
        function quickAdminLogin() {
            console.log('ðŸ”‘ Quick admin login...');

            // Fill login form with admin credentials
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            document.getElementById('role').value = 'admin';

            // Trigger login
            loginUser();

            console.log('âœ… Admin login triggered');
        }

        // ALL DEBUG/BYPASS FUNCTIONS REMOVED - Users must login properly with valid credentials

        // Test admin panel navigation
        function testAdminPanel() {
            console.log('ðŸ§ª Testing admin panel navigation...');

            // Show admin section
            showSection('adminSection');

            console.log('âœ… Admin panel navigation test completed');
        }

        // Test admin panel with demo data
        function testAdminPanelWithDemo() {
            console.log('ðŸ§ª Testing admin panel with demo data...');

            // Navigate to admin section
            showSection('adminSection');

            // Load demo questions directly
            setTimeout(() => {
                displayAdminQuestions([
                    {
                        _id: 'demo1',
                        examType: 'JEE',
                        subject: 'Physics',
                        chapter: 'Mechanics',
                        difficulty: 'Medium',
                        question: 'Demo Physics Question: Find the acceleration',
                        options: ['Option A', 'Option B', 'Option C', 'Option D'],
                        correctAnswer: 0,
                        explanation: 'This is a demo explanation'
                    }
                ]);
                showNotification('Demo admin panel loaded successfully!', 'success');
            }, 500);

            console.log('âœ… Admin panel demo test completed');
        }

        // Force show admin content
        function forceShowAdminContent() {
            console.log('ðŸ”§ Force showing admin content...');

            // Navigate to admin section
            showSection('adminSection');

            // Force show the questions tab
            setTimeout(() => {
                const questionsTab = document.getElementById('questions-tab');
                if (questionsTab) {
                    questionsTab.style.display = 'block';
                    questionsTab.style.visibility = 'visible';
                    console.log('âœ… Questions tab forced visible');
                }

                // Load demo questions
                displayAdminQuestions([
                    {
                        _id: 'demo1',
                        examType: 'JEE',
                        subject: 'Physics',
                        chapter: 'Mechanics',
                        difficulty: 'Medium',
                        question: 'Demo Physics Question: A particle moves with velocity v = 3tÂ² - 2t + 1 m/s. Find acceleration at t = 2s.',
                        options: ['10 m/sÂ²', '12 m/sÂ²', '14 m/sÂ²', '16 m/sÂ²'],
                        correctAnswer: 0,
                        explanation: 'Acceleration a = dv/dt = 6t - 2. At t = 2, a = 6(2) - 2 = 10 m/sÂ²'
                    }
                ]);

                showNotification('Admin content loaded successfully!', 'success');
            }, 500);

            console.log('âœ… Force show admin content completed');
        }



        // Mock Test Management
        function showCreateMockTestModal() {
            console.log('ðŸ“ Opening create mock test modal');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create New Mock Test</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Test Name</label>
                            <input type="text" id="mockTestName3" class="form-input" placeholder="e.g., JEE Main Mock Test 1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Exam Type</label>
                            <select id="mockTestExam3" class="form-input">
                                <option value="JEE">JEE</option>
                                <option value="NEET">NEET</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" id="mockTestDuration3" class="form-input" value="180" min="30" max="300">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Questions</label>
                            <input type="number" id="activeMockQuestions3" class="form-input" value="75" min="10" max="200">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject Distribution</label>
                            <div class="subject-distribution">
                                <div class="form-row">
                                    <label>Physics:</label>
                                    <input type="number" id="physicsQuestions" class="form-input" value="25" min="0">
                                </div>
                                <div class="form-row">
                                    <label>Chemistry:</label>
                                    <input type="number" id="chemistryQuestions" class="form-input" value="25" min="0">
                                </div>
                                <div class="form-row">
                                    <label>Mathematics/Biology:</label>
                                    <input type="number" id="mathBioQuestions" class="form-input" value="25" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createMockTest()">Create Mock Test</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function createMockTest() {
            const testData = {
                name: document.getElementById('mockTestName').value,
                examType: document.getElementById('mockTestExam').value,
                duration: parseInt(document.getElementById('mockTestDuration').value),
                totalQuestions: parseInt(document.getElementById('activeMockQuestions').value),
                subjects: {
                    physics: parseInt(document.getElementById('physicsQuestions').value),
                    chemistry: parseInt(document.getElementById('chemistryQuestions').value),
                    mathBio: parseInt(document.getElementById('mathBioQuestions').value)
                },
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };

            console.log('ðŸ“ Creating mock test:', testData);

            // Save to localStorage for demo
            const mockTests = JSON.parse(localStorage.getItem('mockTests') || '[]');
            testData.id = 'mock_' + Date.now();
            mockTests.push(testData);
            localStorage.setItem('mockTests', JSON.stringify(mockTests));

            showNotification('Mock test created successfully!', 'success');
            closeModal();
            loadAllMockTests();
        }

        function loadAllMockTests() {
            console.log('ðŸ“š Loading all mock tests');

            // Load from localStorage for demo
            const mockTests = JSON.parse(localStorage.getItem('mockTests') || '[]');

            // Add some demo mock tests if none exist
            if (mockTests.length === 0) {
                const demoTests = [
                    {
                        id: 'demo_mock_1',
                        name: 'JEE Main Mock Test 1',
                        examType: 'JEE',
                        duration: 180,
                        totalQuestions: 75,
                        subjects: { physics: 25, chemistry: 25, mathBio: 25 },
                        createdBy: 'admin',
                        createdAt: new Date().toISOString(),
                        attempts: 15
                    },
                    {
                        id: 'demo_mock_2',
                        name: 'NEET Mock Test 1',
                        examType: 'NEET',
                        duration: 180,
                        totalQuestions: 180,
                        subjects: { physics: 45, chemistry: 45, mathBio: 90 },
                        createdBy: 'admin',
                        createdAt: new Date().toISOString(),
                        attempts: 23
                    }
                ];
                localStorage.setItem('mockTests', JSON.stringify(demoTests));
                displayMockTests(demoTests);
            } else {
                displayMockTests(mockTests);
            }
        }

        function displayMockTests(tests) {
            const container = document.getElementById('mockTestsList');

            if (!tests || tests.length === 0) {
                container.innerHTML = '<p>No mock tests created yet. Create your first mock test!</p>';
                return;
            }

            const html = `
                <div class="mock-test-grid">
                    ${tests.map(test => `
                        <div class="mock-test-card">
                            <div class="mock-test-title">${test.name}</div>
                            <div class="mock-test-meta">
                                <span><i class="fas fa-graduation-cap"></i> ${test.examType}</span>
                                <span><i class="fas fa-clock"></i> ${test.duration} min</span>
                                <span><i class="fas fa-question-circle"></i> ${test.totalQuestions} Q</span>
                            </div>
                            <div class="mock-test-meta">
                                <span><i class="fas fa-users"></i> ${test.attempts || 0} attempts</span>
                                <span><i class="fas fa-calendar"></i> ${new Date(test.createdAt).toLocaleDateString()}</span>
                            </div>
                            <div class="mock-test-actions">
                                <button class="btn btn-sm btn-primary" onclick="viewMockTestResults('${test.id}')">
                                    <i class="fas fa-chart-bar"></i> Results
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="editMockTest('${test.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMockTest('${test.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Student Results Management
        function loadStudentResults() {
            console.log('ðŸ“Š Loading student results');

            // Generate demo student results
            const demoResults = [
                {
                    id: 'result_1',
                    studentName: 'Rahul Sharma',
                    testName: 'JEE Main Mock Test 1',
                    score: 68,
                    totalQuestions: 75,
                    percentage: 90.67,
                    timeTaken: 165,
                    date: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'result_2',
                    studentName: 'Priya Patel',
                    testName: 'NEET Mock Test 1',
                    score: 145,
                    totalQuestions: 180,
                    percentage: 80.56,
                    timeTaken: 170,
                    date: new Date(Date.now() - 172800000).toISOString()
                },
                {
                    id: 'result_3',
                    studentName: 'Amit Kumar',
                    testName: 'JEE Main Mock Test 1',
                    score: 52,
                    totalQuestions: 75,
                    percentage: 69.33,
                    timeTaken: 180,
                    date: new Date(Date.now() - 259200000).toISOString()
                },
                {
                    id: 'result_4',
                    studentName: 'Sneha Gupta',
                    testName: 'NEET Mock Test 1',
                    score: 162,
                    totalQuestions: 180,
                    percentage: 90.00,
                    timeTaken: 175,
                    date: new Date(Date.now() - 345600000).toISOString()
                }
            ];

            displayStudentResults(demoResults);
            updateResultsStats(demoResults);
        }

        function displayStudentResults(results) {
            const tableBody = document.getElementById('studentResultsTable');

            if (!results || results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No student results found.</td></tr>';
                return;
            }

            const html = results.map(result => {
                const scoreClass = getScoreClass(result.percentage);
                return `
                    <tr>
                        <td><strong>${result.studentName}</strong></td>
                        <td>${result.testName}</td>
                        <td>${result.score}/${result.totalQuestions}</td>
                        <td><span class="score-badge ${scoreClass}">${result.percentage.toFixed(1)}%</span></td>
                        <td>${Math.floor(result.timeTaken / 60)}h ${result.timeTaken % 60}m</td>
                        <td>${new Date(result.date).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewDetailedResult('${result.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = html;
        }

        function updateResultsStats(results) {
            const totalStudents = new Set(results.map(r => r.studentName)).size;
            const totalTests = results.length;
            const averageScore = results.reduce((sum, r) => sum + r.percentage, 0) / results.length;
            const topScore = Math.max(...results.map(r => r.percentage));

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('averageScore').textContent = averageScore.toFixed(1) + '%';
            document.getElementById('topScore').textContent = topScore.toFixed(1) + '%';
        }

        function getScoreClass(percentage) {
            if (percentage >= 85) return 'score-excellent';
            if (percentage >= 70) return 'score-good';
            if (percentage >= 50) return 'score-average';
            return 'score-poor';
        }

        function viewDetailedResult(resultId) {
            console.log('ðŸ‘ï¸ Viewing detailed result:', resultId);
            showNotification('Detailed result view - Feature coming soon!', 'info');
        }

        function exportStudentResults() {
            console.log('ðŸ“¥ Exporting student results');
            showNotification('Results exported successfully!', 'success');
        }

        // Modal Management
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Debug function to check admin user
        async function checkAdminUser() {
            console.log('ðŸ” Checking admin user status...');

            try {
                const response = await fetch('/api/debug/check-admin');
                const data = await response.json();

                console.log('ðŸ‘¥ Admin check result:', data);

                if (data.success) {
                    console.log('âœ… Admin exists:', data.adminExists);
                    console.log('ðŸ‘¤ Admin user:', data.adminUser);
                    console.log('ðŸ‘¥ All users:', data.allUsers);

                    if (!data.adminExists) {
                        console.log('âš ï¸ Admin user does not exist! Server should create it automatically.');
                    }
                } else {
                    console.error('âŒ Error checking admin:', data.error);
                }
            } catch (error) {
                console.error('âŒ Network error checking admin:', error);
            }
        }

        // Password toggle function
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(inputId + '-toggle-icon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Registration function
        async function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const role = document.getElementById('regRole').value;

            // Validation
            if (!username || !email || !password || !confirmPassword || !role) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            try {
                console.log('ðŸ“ Attempting registration:', { username, email, role });

                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        role: role
                    })
                });

                const data = await response.json();
                console.log('ðŸ“ Registration response:', data);

                if (data.success) {
                    // Registration successful
                    showNotification(data.message || 'Registration successful! Welcome to EduSphere Pro!', 'success');

                    // Store user data and token
                    currentUser = data.user;
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    localStorage.setItem('token', data.token);

                    // Show dashboard
                    setTimeout(() => {
                        showDashboard();
                    }, 1500);

                } else {
                    // Registration failed
                    showNotification(data.error || 'Registration failed. Please try again.', 'error');
                }

            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
            }
        }

        // Update provider selection when dropdown changes
        document.addEventListener('DOMContentLoaded', function () {
            const providerSelect = document.getElementById('aiProviderSelect');
            if (providerSelect) {
                providerSelect.addEventListener('change', function () {
                    selectedProvider = this.value;
                    console.log('ðŸŽ¯ Provider changed to:', selectedProvider);
                });
            }
        });

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            console.log(`ðŸ“Ž Files selected:`, files.map(f => f.name));

            for (const file of files) {
                if (uploadedFiles.length >= 5) {
                    console.log('Maximum 5 files allowed');
                    break;
                }
                uploadedFiles.push(file);
            }

            updateFileUploadArea();
            event.target.value = ''; // Reset file input
        }

        function sendMessage() {
            console.log('ðŸš€ sendMessage called');
            const input = document.getElementById('chatInput');
            if (!input) {
                console.error('âŒ Chat input element not found');
                return;
            }

            const message = input.value.trim();
            console.log('ðŸ“ Message:', message);

            if (!message) {
                console.log('âš ï¸ Empty message, returning');
                return;
            }

            // Clear input
            input.value = '';
            console.log('âœ… Input cleared');

            // Hide welcome message and show chat
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
                console.log('âœ… Welcome message hidden');
            }

            // Add user message to chat
            addMessageToChat('user', message);
            console.log('âœ… Message added to chat');

            // Send to AI
            sendToAI(message);
            console.log('âœ… Sent to AI');
            sendToAI(message);

            // Clear uploaded files after sending
            uploadedFiles = [];
            updateFileUploadArea();
            document.getElementById('fileUploadArea').style.display = 'none';
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function addMessageToChat(sender, message, isHTML = false) {
            // Safety check for undefined message
            if (message === undefined || message === null) {
                console.warn('addMessageToChat called with undefined/null message');
                message = 'No response received';
            }
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Remove welcome screen if it exists
            const welcomeScreen = chatMessages.querySelector('.welcome-screen, .welcome-center');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            const avatar = sender === 'user' ?
                '<div class="message-avatar"><i class="fas fa-user"></i></div>' :
                '<div class="message-avatar"><i class="fas fa-robot"></i></div>';

            const content = isHTML ? message : message.replace(/\n/g, '<br>');

            messageDiv.innerHTML = `
                ${avatar}
                <div class="message-content">
                    ${content}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        // Add this to your existing JavaScript

        // Question Bank Functions - Updated for JEE/NEET structure
        // (Functions moved to main section above)

        // Old loadQuestions function removed - using new JEE/NEET structure


        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Remove welcome screen if it exists
            const welcomeScreen = chatMessages.querySelector('.welcome-screen, .welcome-center');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Function to get conversation history for AI context
        function getConversationHistory() {
            const messagesArea = document.querySelector('.ultra-messages-area');
            if (!messagesArea) return [];

            const messages = messagesArea.querySelectorAll('.ultra-message');
            const history = [];

            messages.forEach(msg => {
                const content = msg.querySelector('.ultra-message-content');
                if (content) {
                    const role = msg.classList.contains('user') ? 'user' : 'assistant';
                    const text = content.textContent || content.innerText || '';

                    if (text.trim()) {
                        history.push({
                            role: role,
                            content: text.trim()
                        });
                    }
                }
            });

            // Limit history to last 10 messages to avoid token limits
            return history.slice(-10);
        }

        async function sendToAI(message) {
            try {
                // Get token from current user or use student token as fallback
                let token = localStorage.getItem("token");
                if (!token) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser.role) {
                        token = `${currentUser.role}-token`;
                    } else {
                        token = 'student-token';
                    }
                }

                console.log('ï¿½ Sending rAI request:', message);
                console.log('ðŸ” Using token:', token?.substring(0, 10) + '...');
                console.log('ðŸŽ¯ Selected provider:', selectedProvider);

                // Get conversation history for context
                const conversationHistory = getConversationHistory();
                console.log('ðŸ“š Including conversation history:', conversationHistory.length, 'messages');

                // Process uploaded files with better validation
                let processedFiles = [];
                if (uploadedFiles.length > 0) {
                    console.log(`ðŸ“Ž Processing ${uploadedFiles.length} files for AI...`);

                    for (const file of uploadedFiles) {
                        try {
                            // Validate file size (max 10MB)
                            if (file.size > 10 * 1024 * 1024) {
                                console.warn(`âš ï¸ File too large: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                                continue;
                            }

                            // Validate file type
                            const supportedTypes = [
                                'image/jpeg', 'image/png', 'image/gif', 'image/webp',
                                'text/plain', 'text/csv', 'application/pdf',
                                'application/json', 'text/markdown'
                            ];

                            if (!supportedTypes.includes(file.type)) {
                                console.warn(`âš ï¸ Unsupported file type: ${file.name} (${file.type})`);
                                continue;
                            }

                            // Convert file to base64
                            const base64Data = await fileToBase64(file);
                            const base64Content = base64Data.split(',')[1]; // Remove data:mime;base64, prefix

                            if (base64Content && base64Content.length > 0) {
                                processedFiles.push({
                                    name: file.name,
                                    mimeType: file.type,
                                    data: base64Content,
                                    size: file.size
                                });
                                console.log(`âœ… Processed file: ${file.name} (${file.type}, ${(file.size / 1024).toFixed(1)}KB)`);
                            }
                        } catch (fileError) {
                            console.error(`âŒ Error processing file ${file.name}:`, fileError);
                            addMessageToChat('ai', `âš ï¸ Could not process file: ${file.name}. ${fileError.message}`);
                        }
                    }

                    if (processedFiles.length === 0 && uploadedFiles.length > 0) {
                        const errorMessage = 'âš ï¸ No files could be processed. Please check file types and sizes.';

                        // Check if we're in ultra interface or regular chat
                        const ultraMessagesArea = document.querySelector('.ultra-messages-area');
                        if (ultraMessagesArea) {
                            addUltraMessage('ai', errorMessage);
                        } else {
                            addMessageToChat('ai', errorMessage);
                        }

                        hideTypingIndicator();
                        hideUltraTypingIndicator();
                        return;
                    }
                }

                console.log('ðŸ“¤ Sending to server:', {
                    query: message,
                    conversationHistory: conversationHistory.length,
                    filesCount: processedFiles.length,
                    fileDetails: processedFiles.map(f => ({ name: f.name, type: f.mimeType, size: f.size })),
                    preferredProvider: selectedProvider !== 'auto' ? selectedProvider : undefined
                });

                const response = await fetch(`${API_BASE}/api/ai-guidance`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        query: message,
                        conversationHistory: conversationHistory,
                        files: processedFiles,
                        preferredProvider: selectedProvider !== 'auto' ? selectedProvider : undefined
                    })
                });

                // Hide typing indicator for both interfaces
                hideTypingIndicator();
                hideUltraTypingIndicator();

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ðŸ“Š AI Response received:', data);

                if (data.success && data.guidance) {
                    // Format the response for better display
                    let formattedResponse = data.guidance;

                    // If it's HTML content, use it as is, otherwise format as text
                    const isHTML = formattedResponse.includes('<') && formattedResponse.includes('>');

                    // Check if we're in ultra interface or regular chat
                    const ultraMessagesArea = document.querySelector('.ultra-messages-area');
                    if (ultraMessagesArea) {
                        addUltraMessage('ai', formattedResponse);
                    } else {
                        addMessageToChat('ai', formattedResponse, isHTML);
                    }

                    // Save to chat history
                    saveChatMessage(message, formattedResponse);

                    // Update chat history display
                    updateChatHistoryDisplay();

                    // Show provider info and notifications
                    if (data.provider && data.provider !== 'fallback' && data.provider !== 'fallback-error') {
                        console.log(`âœ… Response from: ${data.provider} (${data.model || 'Unknown model'}) in ${data.responseTime || 0}ms`);
                        showNotification(`ðŸš€ Response from ${data.provider} in ${data.responseTime || 0}ms`, 'success');
                    } else {
                        console.log('âš ï¸ Using fallback mode - no AI providers available');
                        showNotification('âš ï¸ Using offline mode - configure AI keys in Admin Panel for faster responses', 'warning');
                    }

                    // Log available providers for debugging
                    if (data.availableProviders && data.availableProviders.length > 0) {
                        console.log('ðŸ¤– Available AI Providers:', data.availableProviders);
                    } else {
                        console.log('âŒ No AI providers configured');
                    }
                } else {
                    console.error('AI response error:', data);
                    const errorMessage = data.error || 'I apologize, but I encountered an issue. Please try asking your question again.';

                    // Check if we're in ultra interface or regular chat
                    const ultraMessagesArea = document.querySelector('.ultra-messages-area');
                    if (ultraMessagesArea) {
                        addUltraMessage('ai', errorMessage);
                    } else {
                        addMessageToChat('ai', errorMessage);
                    }
                }
            } catch (error) {
                // Hide typing indicator for both interfaces
                hideTypingIndicator();
                hideUltraTypingIndicator();
                console.error('Chat error:', error);

                // More specific error messages
                let errorMessage;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'I\'m having trouble connecting to the server. Please check your internet connection and try again.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'The server is experiencing issues. Please try again in a moment.';
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = 'Authentication error. Please refresh the page and try again.';
                } else {
                    errorMessage = 'I\'m having trouble connecting right now. Please try again in a moment.';
                }

                // Check if we're in ultra interface or regular chat
                const ultraMessagesArea = document.querySelector('.ultra-messages-area');
                if (ultraMessagesArea) {
                    addUltraMessage('ai', errorMessage);
                } else {
                    addMessageToChat('ai', errorMessage);
                }
            }
        }

        // HARDCODED BULLETPROOF CHAT SAVING SYSTEM
        function saveChatMessage(userMessage, aiResponse) {
            console.log('ðŸš€ HARDCODED SAVE CHAT MESSAGE CALLED');

            // HARDCODED: Force user data if missing
            if (!currentUser) {
                currentUser = JSON.parse(localStorage.getItem('currentUser') || '{"username":"testuser","role":"student"}');
                console.log('ðŸ”§ HARDCODED: Set currentUser to:', currentUser);
            }

            // HARDCODED: Force chat ID if missing
            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('ðŸ”§ HARDCODED: Set currentChatId to:', currentChatId);
            }

            console.log('ðŸ’¾ HARDCODED SAVING:');
            console.log('  User:', currentUser.username);
            console.log('  Chat ID:', currentChatId);
            console.log('  User Message:', userMessage.substring(0, 50) + '...');
            console.log('  AI Response:', aiResponse.substring(0, 50) + '...');

            // HARDCODED: Create user-specific key
            const userChatKey = currentUser.username + '_' + currentChatId;
            console.log('  Storage Key:', userChatKey);

            // HARDCODED: Get existing data or create new
            let existingData = null;
            try {
                existingData = localStorage.getItem(userChatKey);
                console.log('  Existing Data Found:', !!existingData);
            } catch (e) {
                console.log('  No existing data');
            }

            let chatData = null;
            if (existingData) {
                try {
                    chatData = JSON.parse(existingData);
                    console.log('  Parsed existing data, messages:', chatData.messages?.length || 0);
                } catch (e) {
                    console.log('  Failed to parse existing data, creating new');
                    chatData = null;
                }
            }

            if (!chatData) {
                chatData = {
                    id: currentChatId,
                    userId: currentUser.username,
                    title: userMessage.length > 50 ? userMessage.substring(0, 50) + '...' : userMessage,
                    timestamp: new Date().toISOString(),
                    messages: []
                };
                console.log('  Created new chat data');
            }

            // HARDCODED: Add messages
            const newUserMessage = {
                type: 'user',
                content: userMessage,
                timestamp: new Date().toISOString()
            };

            const newAiMessage = {
                type: 'ai',
                content: aiResponse,
                timestamp: new Date().toISOString()
            };

            chatData.messages.push(newUserMessage);
            chatData.messages.push(newAiMessage);
            chatData.timestamp = new Date().toISOString();

            console.log('  Total messages now:', chatData.messages.length);

            // HARDCODED: Force save to localStorage
            try {
                const dataString = JSON.stringify(chatData);
                localStorage.setItem(userChatKey, dataString);
                console.log('âœ… HARDCODED: Successfully saved to localStorage');

                // Verify it was saved
                const verification = localStorage.getItem(userChatKey);
                if (verification) {
                    console.log('âœ… HARDCODED: Verified data exists in localStorage');
                    const verifyData = JSON.parse(verification);
                    console.log('âœ… HARDCODED: Verified', verifyData.messages.length, 'messages saved');
                } else {
                    console.error('âŒ HARDCODED: Failed to verify save');
                }

            } catch (e) {
                console.error('âŒ HARDCODED: Failed to save:', e);
            }

            // HARDCODED: Force update chat history
            hardcodedUpdateChatHistory();
        }

        // HARDCODED CHAT HISTORY UPDATE
        function hardcodedUpdateChatHistory() {
            console.log('ðŸ”„ HARDCODED UPDATE CHAT HISTORY');

            if (!currentUser) {
                console.log('âŒ No current user for hardcoded update');
                return;
            }

            // HARDCODED: Get all user chats
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }

            const userChatKeys = allKeys.filter(key =>
                key && key.startsWith(currentUser.username + '_chat_')
            );

            console.log('ðŸ” HARDCODED: Found', userChatKeys.length, 'chat keys for', currentUser.username);
            console.log('ðŸ” HARDCODED: Keys:', userChatKeys);

            const userChats = [];
            userChatKeys.forEach(key => {
                try {
                    const chatData = JSON.parse(localStorage.getItem(key));
                    if (chatData && chatData.title) {
                        userChats.push(chatData);
                        console.log('  âœ… Loaded:', chatData.title);
                    }
                } catch (e) {
                    console.log('  âŒ Failed to load:', key);
                }
            });

            // HARDCODED: Sort by timestamp
            userChats.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // HARDCODED: Update global chatHistory
            chatHistory = userChats;
            console.log('âœ… HARDCODED: Set chatHistory to', chatHistory.length, 'chats');

            // HARDCODED: Update display
            hardcodedUpdateDisplay();
        }

        // HARDCODED DISPLAY UPDATE
        function hardcodedUpdateDisplay() {
            console.log('ðŸ–¥ï¸ HARDCODED UPDATE DISPLAY');

            const historyList = document.getElementById('chatHistoryList');
            const historyTitle = document.getElementById('chatHistoryTitle');

            console.log('  - historyList found:', !!historyList);
            console.log('  - historyTitle found:', !!historyTitle);
            console.log('  - chatHistory length:', chatHistory.length);

            if (!historyList) {
                console.error('âŒ HARDCODED: chatHistoryList element not found');
                return;
            }

            // HARDCODED: Update title
            if (historyTitle) {
                historyTitle.textContent = 'TODAY (' + chatHistory.length + ')';
                console.log('âœ… HARDCODED: Updated title to:', historyTitle.textContent);
            }

            // HARDCODED: Update list
            if (chatHistory.length === 0) {
                historyList.innerHTML = '<div class="no-chats"><i class="fas fa-comments"></i><p>No chats yet</p><small>Start a new chat to begin!</small></div>';
                console.log('âœ… HARDCODED: Set empty state');
            } else {
                let html = '';
                chatHistory.forEach(chat => {
                    const isActive = chat.id === currentChatId ? 'active' : '';
                    html += '<div class="chat-history-item ' + isActive + '" onclick="loadChat(\'' + chat.id + '\')" title="' + chat.title + '">' + chat.title + '</div>';
                });
                historyList.innerHTML = html;
                console.log('âœ… HARDCODED: Set', chatHistory.length, 'chat items');
            }
        }





        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Global keyboard shortcuts for chat
        document.addEventListener('keydown', function (event) {
            // Only work when in AI Guidance section
            const aiSection = document.getElementById('ultraAiGuidanceSection');
            if (!aiSection || !aiSection.classList.contains('active')) return;

            // Ctrl/Cmd + B to toggle sidebar
            if ((event.ctrlKey || event.metaKey) && event.key === 'b') {
                event.preventDefault();
                toggleChatSidebar();
            }

            // Ctrl/Cmd + N for new chat
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                startNewChat();
            }
        });

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function toggleFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const isVisible = fileUploadArea.style.display !== 'none';
            fileUploadArea.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                document.getElementById('fileInput').click();
            }
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = [...uploadedFiles, ...files];
            updateFileUploadArea();
            document.getElementById('fileUploadArea').style.display = 'block';
        }

        function updateFileUploadArea() {
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            uploadedFilesDiv.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-tag">
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                    <i class="fas fa-times remove-file" onclick="removeFile(${index})"></i>
                </div>
                `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileUploadArea();
            if (uploadedFiles.length === 0) {
                document.getElementById('fileUploadArea').style.display = 'none';
            }
        }

        // Math toolbar functions
        function toggleMathToolbar() {
            const mathToolbar = document.getElementById('mathToolbar');
            const isVisible = mathToolbar.style.display !== 'none';
            mathToolbar.style.display = isVisible ? 'none' : 'block';
        }

        function insertMath(mathSymbol) {
            const chatInput = document.getElementById('chatInput');
            const start = chatInput.selectionStart;
            const end = chatInput.selectionEnd;
            const text = chatInput.value;

            // Insert the math symbol at cursor position
            const newText = text.substring(0, start) + mathSymbol + text.substring(end);
            chatInput.value = newText;

            // Position cursor appropriately
            let cursorPos = start + mathSymbol.length;

            // For symbols with {}, position cursor inside the braces
            if (mathSymbol.includes('{}')) {
                const braceIndex = mathSymbol.indexOf('{}');
                cursorPos = start + braceIndex + 1;
            }

            chatInput.focus();
            chatInput.setSelectionRange(cursorPos, cursorPos);
            adjustTextareaHeight(chatInput);
        }

        function clearCurrentChat() {
            if (confirm('Are you sure you want to clear this chat?')) {
                if (currentChatId) {
                    localStorage.removeItem(`chat_${currentChatId} `);
                }
                startNewChat();
                updateChatHistory();
                showNotification('Chat cleared successfully', 'success');
            }
        }

        function deleteChat(chatId) {
            if (confirm('Are you sure you want to delete this chat?')) {
                localStorage.removeItem(`chat_${chatId} `);

                // If we're deleting the current chat, start a new one
                if (chatId === currentChatId) {
                    startNewChat();
                } else {
                    updateChatHistory();
                }

                showNotification('Chat deleted successfully', 'success');
            }
        }

        function exportChat() {
            if (!currentChatId) {
                showNotification('No chat to export', 'warning');
                return;
            }

            const messages = JSON.parse(localStorage.getItem(`chat_${currentChatId} `) || '[]');
            if (messages.length === 0) {
                showNotification('Chat is empty', 'warning');
                return;
            }

            const chatContent = messages.map(msg =>
                `${msg.sender.toUpperCase()}: ${msg.message.replace(/<[^>]*>/g, '')} `
            ).join('\n\n');

            const blob = new Blob([chatContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Chat exported successfully', 'success');
        }

        // Enhanced LaTeX rendering function
        function renderLatexInElement(element) {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([element]).then(() => {
                    console.log('âœ… LaTeX rendered successfully');
                }).catch((err) => {
                    console.warn('âš ï¸ LaTeX rendering error:', err);
                });
            }
        }

        // Override the original addMessageToChat to include LaTeX rendering
        const originalAddMessageToChat = window.addMessageToChat;
        window.addMessageToChat = function (sender, message, isHTML = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat - message ${sender} `;

            const avatar = sender === 'user' ?
                '<div class="user-avatar"><i class="fas fa-user"></i></div>' :
                '<div class="ai-avatar"><i class="fas fa-robot"></i></div>';

            const content = isHTML ? message : message.replace(/\n/g, '<br>');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                ${avatar}
            <div class="message-bubble tex2jax_process">
                ${content}
                <div class="message-time">${time}</div>
            </div>
            `;

            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            chatMessages.appendChild(messageDiv);

            // Render LaTeX in the new message
            renderLatexInElement(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // Add sample LaTeX examples to welcome message
        function addLatexExamples() {
            const welcomeMessage = document.querySelector('.welcome-message .message-content');
            if (welcomeMessage) {
                const examplesHTML = `
                < div style = "margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius);" >
                        <h4>ðŸ“ LaTeX Math Examples:</h4>
                        <p><strong>Inline math:</strong> Use $x^2 + y^2 = r^2$ for inline formulas</p>
                        <p><strong>Display math:</strong> Use $$\\frac{d}{dx}\\int_a^x f(t)dt = f(x)$$ for centered equations</p>
                        <p><strong>Try asking:</strong> <em>"Explain the quadratic formula using LaTeX"</em></p>
                    </div >
                `;
                welcomeMessage.innerHTML += examplesHTML;
                renderLatexInElement(welcomeMessage);
            }
        }

        // Initialize LaTeX examples when chat loads
        document.addEventListener('DOMContentLoaded', function () {
            // Wait for MathJax to load
            setTimeout(() => {
                addLatexExamples();
            }, 1000);
        });


        // Sidebar toggle functionality
        let sidebarCollapsed = false;

        // Add functions for the ChatGPT-like UI
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const chatInput = document.querySelector('.chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Clear input and reset height
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // Add user message to chat
            addMessageToChat('user', message);

            // Send to AI and get response
            sendToAI(message);
        }

        function toggleChatSidebar() {
            const sidebar = document.querySelector('.chatgpt-sidebar');
            sidebar.classList.toggle('active');
        }


        // Initialize chat when AI Guidance section is loaded
        function initializeChat() {
            console.log('ðŸ”§ Initializing ChatGPT-like interface...');

            // Set up event listeners
            const chatInput = document.querySelector('.chat-input');
            const sendButton = document.querySelector('.send-btn');

            if (chatInput) {
                chatInput.addEventListener('keydown', handleChatKeydown);
                chatInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }

            // Add click event listeners to suggestion cards
            const suggestionCards = document.querySelectorAll('.suggestion-card');
            suggestionCards.forEach(card => {
                card.addEventListener('click', function () {
                    const question = this.querySelector('h4').textContent;
                    if (chatInput) {
                        chatInput.value = question;
                        chatInput.style.height = 'auto';
                        chatInput.style.height = (chatInput.scrollHeight) + 'px';
                        chatInput.focus();
                    }
                });
            });

            // Add click event listener to new chat button
            const newChatButton = document.querySelector('.new-chat-button');
            if (newChatButton) {
                newChatButton.addEventListener('click', startNewChat);
            }

            // Add click event listener to sidebar toggle (for mobile)
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleChatSidebar);
            }

            // Update sidebar user info
            const sidebarAvatar = document.getElementById('sidebarAvatar');
            const sidebarUsername = document.getElementById('sidebarUsername');

            if (currentUser) {
                if (sidebarAvatar) {
                    sidebarAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                }
                if (sidebarUsername) {
                    sidebarUsername.textContent = currentUser.username;
                }
            }

            startNewChat();
            updateChatHistory();
            testAIConnection();

            console.log('âœ… ChatGPT-like interface initialized');
        }

        // Test AI connection and show status
        async function testAIConnection() {
            try {
                console.log('ðŸ” Testing AI connection...');

                const response = await fetch('/api/ai-status');
                const data = await response.json();

                console.log('ðŸ¤– AI Status:', data);

                if (data.ai_configured && data.total_providers > 0) {
                    console.log(`âœ… ${data.total_providers} AI provider(s) configured:`);
                    data.providers.forEach(p => {
                        console.log(`  - ${p.name} (${p.model}) - ${p.speed} - Priority ${p.priority}`);
                    });
                    showNotification(`ðŸš€ ${data.total_providers} AI provider(s) ready for ultra-fast responses!`, 'success');
                } else {
                    console.log('âš ï¸ No AI providers configured - using fallback mode');
                    showNotification('âš ï¸ No AI providers configured - using offline mode. Configure API keys in Admin Panel for AI responses.', 'warning');
                }

                return data;
            } catch (error) {
                console.error('âŒ Error testing AI connection:', error);
                showNotification('âŒ Error checking AI status', 'error');
                return null;
            }
        }

        // Update the section loading to initialize chat
        const originalShowSection = showSection;
        showSection = function (sectionId) {
            console.log('ðŸ”„ Switching to section:', sectionId);
            originalShowSection(sectionId);

            if (sectionId === 'aiGuidanceSection' || sectionId === 'ultraAiGuidanceSection') {
                console.log('ðŸ¤– Loading AI Guidance section...');

                // Initialize chat functionality
                setTimeout(() => {
                    if (sectionId === 'ultraAiGuidanceSection') {
                        // Initialize ultra interface
                        console.log('ðŸš€ Initializing Ultra AI Interface...');

                        // Load chat history
                        loadChatHistory();
                        updateChatHistoryDisplay();

                        // Initialize current chat ID if not exists
                        if (!currentChatId) {
                            currentChatId = generateChatId();
                        }

                        console.log('âœ… Ultra AI Interface initialized');
                    } else {
                        // Initialize regular chat interface
                        const container = document.querySelector('.chatgpt-container');
                        const sidebar = document.querySelector('.chatgpt-sidebar');
                        const chatMessages = document.getElementById('chatMessages');

                        console.log('ðŸ” Layout Debug:', {
                            container: !!container,
                            sidebar: !!sidebar,
                            chatMessages: !!chatMessages,
                            containerVisible: container ? getComputedStyle(container).display : 'not found',
                            sidebarVisible: sidebar ? getComputedStyle(sidebar).display : 'not found'
                        });

                        initializeChat();
                    }
                }, 100);
            }
        };

        function generateFallbackGuidance(query) {
            return `
                < div class="guidance-result" >
                    <div class="guidance-header">
                        <i class="fas fa-robot"></i>
                        <h3>AI Study Guidance</h3>
                        <span class="provider-badge">Offline Mode</span>
                    </div>
                    <div class="guidance-content">
                        <div class="query-preview">
                            <strong>Your Query:</strong> "${query}"
                        </div>
                        <div style="margin-top: 1rem;">
                            <p>Based on your query, here's a comprehensive study plan:</p>
                            <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                                <li>Focus on understanding fundamental concepts first</li>
                                <li>Practice at least 20-30 problems daily</li>
                                <li>Review NCERT textbooks thoroughly</li>
                                <li>Take regular mock tests to assess progress</li>
                            </ul>
                        </div>
                    </div>
                </div >
                `;
        }

        // AI Configuration Functions
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai-status');
                const data = await response.json();

                const resultDiv = document.getElementById('aiStatusResult');

                let html = `
                    <div class="card" style="background: ${data.ai_configured ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 1rem;">
                        <h4>ðŸš€ Multi-AI System Status</h4>
                        <p><strong>Total Providers:</strong> ${data.total_providers} configured</p>
                        <p><strong>Status:</strong> ${data.ai_configured ? 'ðŸŸ¢ ACTIVE' : 'ðŸŸ¡ FALLBACK MODE'}</p>
                        <p><strong>Mode:</strong> ${data.fallback_mode ? 'Offline Only' : 'Smart Multi-AI with Fallback'}</p>
                    </div>
                `;

                if (data.providers && data.providers.length > 0) {
                    html += '<div style="display: grid; gap: 0.5rem; margin-top: 1rem;">';

                    data.providers.forEach(provider => {
                        const icons = {
                            'Groq': 'ðŸš€',
                            'Cohere': 'ðŸ”¥',
                            'Anthropic Claude': 'ðŸ§ ',
                            'Google Gemini': 'ðŸ”„'
                        };

                        html += `
                            <div class="card" style="background: var(--primary); color: white; padding: 0.75rem; font-size: 0.9rem;">
                                <strong>${icons[provider.name] || 'ðŸ¤–'} ${provider.name}</strong> 
                                (${provider.model}) - ${provider.speed} - Priority ${provider.priority}
                            </div>
                        `;
                    });

                    html += '</div>';
                } else {
                    html += `
                        <div class="card" style="background: var(--gray-600); color: white; padding: 1rem; margin-top: 1rem;">
                            <h4>âš ï¸ No AI Providers Configured</h4>
                            <p>Add API keys above to enable ultra-fast AI responses</p>
                            <p><strong>Current Mode:</strong> Offline guidance only</p>
                        </div>
                    `;
                }

                // Configuration status
                html += `
                    <div class="card" style="background: var(--gray-700); color: white; padding: 1rem; margin-top: 1rem;">
                        <h4>ðŸ“‹ Configuration Status</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.9rem;">
                            <div>ðŸš€ Groq: ${data.groq_configured ? 'âœ…' : 'âŒ'}</div>
                            <div>ðŸ”¥ Cohere: ${data.cohere_configured ? 'âœ…' : 'âŒ'}</div>
                            <div>ðŸ§  Anthropic: ${data.anthropic_configured ? 'âœ…' : 'âŒ'}</div>
                            <div>ðŸ”„ Gemini: ${data.gemini_configured ? 'âœ…' : 'âŒ'}</div>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = html;
            } catch (error) {
                console.error('Error checking AI status:', error);
                showNotification('Error checking AI status', 'error');
            }
        }

        async function debugGemini() {
            try {
                const response = await fetch('/api/debug-gemini');
                const data = await response.json();

                const resultDiv = document.getElementById('aiStatusResult');

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--success); color: white; padding: 1rem;">
                            <h4>âœ… Gemini Debug Successful!</h4>
                            <p><strong>API Key:</strong> ${data.api_key_prefix}</p>
                            <p><strong>Available Models:</strong> ${data.available_models ? data.available_models.length : 0} models found</p>
                            <p><strong>Connectivity:</strong> ${data.connectivity}</p>
                        </div>
                `;
                } else {
                    resultDiv.innerHTML = `
                < div class="card" style = "background: var(--error); color: white; padding: 1rem;" >
                            <h4>âŒ Gemini Debug Failed</h4>
                            <p><strong>Error:</strong> ${data.error}</p>
                            <p><strong>API Key:</strong> ${data.api_key_prefix || 'Not found'}</p>
                        </div >
                `;
                }
            } catch (error) {
                console.error('Debug error:', error);
                const resultDiv = document.getElementById('aiStatusResult');
                resultDiv.innerHTML = `
                < div class="card" style = "background: var(--error); color: white; padding: 1rem;" >
                        <h4>âŒ Debug Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div >
                `;
            }
        }



        // Test individual API keys
        async function testGroqKey() {
            const key = document.getElementById('groqKey').value.trim();
            if (!key) {
                showNotification('Please enter a Groq API key', 'warning');
                return;
            }
            await testSingleKey('groq', key, 'Groq');
        }

        async function testCohereKey() {
            const key = document.getElementById('cohereKey').value.trim();
            if (!key) {
                showNotification('Please enter a Cohere API key', 'warning');
                return;
            }
            await testSingleKey('cohere', key, 'Cohere');
        }

        async function testAnthropicKey() {
            const key = document.getElementById('anthropicKey').value.trim();
            if (!key) {
                showNotification('Please enter an Anthropic API key', 'warning');
                return;
            }
            await testSingleKey('anthropic', key, 'Anthropic Claude');
        }

        async function testGeminiKey() {
            const key = document.getElementById('geminiKey').value.trim();
            if (!key) {
                showNotification('Please enter a Gemini API key', 'warning');
                return;
            }
            await testSingleKey('gemini', key, 'Gemini');
        }

        async function testSingleKey(provider, key, displayName) {
            try {
                const body = {};
                body[`${provider}Key`] = key;

                const response = await fetch('/api/test-ai-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const resultDiv = document.getElementById('aiStatusResult');

                if (data[provider] && data[provider].success) {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--success); color: white; padding: 1rem;">
                            <h4>âœ… ${displayName} API Test Successful!</h4>
                            <p>${data[provider].message}</p>
                            <p><strong>Next Step:</strong> Add this key to your .env file as ${provider.toUpperCase()}_API_KEY</p>
                        </div>
                    `;
                    showNotification(`${displayName} API key is valid!`, 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: var(--error); color: white; padding: 1rem;">
                            <h4>âŒ ${displayName} API Test Failed</h4>
                            <p><strong>Error:</strong> ${data[provider] ? data[provider].error : 'Unknown error'}</p>
                            <p><strong>Tip:</strong> Check your API key format and permissions</p>
                        </div>
                    `;
                    showNotification(`${displayName} API key test failed`, 'error');
                }
            } catch (error) {
                console.error(`Error testing ${displayName} key:`, error);
                showNotification(`Error testing ${displayName} API key`, 'error');
            }
        }

        // Test all API keys at once
        async function testAllKeys() {
            const groqKey = document.getElementById('groqKey').value.trim();
            const cohereKey = document.getElementById('cohereKey').value.trim();

            if (!groqKey && !cohereKey) {
                showNotification('Please enter at least one API key to test', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/test-ai-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        groqKey: groqKey || undefined,
                        cohereKey: cohereKey || undefined,
                        geminiKey: geminiKey || undefined
                    })
                });

                const data = await response.json();
                const resultDiv = document.getElementById('aiStatusResult');

                let html = '<div style="display: grid; gap: 1rem;">';
                let successCount = 0;

                // Test results for each provider
                const providers = [
                    { key: 'cohere', name: 'Cohere', icon: 'ðŸ”¥', priority: 1 },
                    { key: 'groq', name: 'Groq', icon: 'ðŸš€', priority: 2 }
                ];

                providers.forEach(provider => {
                    if (data[provider.key]) {
                        const result = data[provider.key];
                        const bgColor = result.success ? 'var(--success)' : 'var(--error)';
                        const status = result.success ? 'âœ… Working' : 'âŒ Failed';

                        if (result.success) successCount++;

                        html += `
                            <div class="card" style="background: ${bgColor}; color: white; padding: 1rem;">
                                <h4>${provider.icon} ${provider.name} (Priority ${provider.priority})</h4>
                                <p><strong>Status:</strong> ${status}</p>
                                <p>${result.success ? result.message : result.error}</p>
                            </div>
                        `;
                    }
                });

                html += '</div>';

                // Summary
                html += `
                    <div class="card" style="background: var(--primary); color: white; padding: 1rem; margin-top: 1rem;">
                        <h4>ðŸŽ¯ Multi-AI System Summary</h4>
                        <p><strong>Working Providers:</strong> ${successCount} out of ${Object.keys(data).length}</p>
                        <p><strong>Fallback Chain:</strong> ${successCount > 0 ? 'Active with smart failover' : 'Using offline mode'}</p>
                        <p><strong>Expected Speed:</strong> ${successCount > 0 ? 'Ultra-fast responses with automatic fallback' : 'Offline guidance only'}</p>
                    </div>
                `;

                resultDiv.innerHTML = html;

                if (successCount > 0) {
                    showNotification(`${successCount} AI provider(s) configured successfully!`, 'success');
                } else {
                    showNotification('No AI providers are working. Check your API keys.', 'warning');
                }

            } catch (error) {
                console.error('Error testing API keys:', error);
                showNotification('Error testing API keys', 'error');
            }
        }

        // Admin functions
        // Enhanced Add Question Modal Functions
        function showAddQuestionModal() {
            console.log('âž• Opening enhanced add question modal...');
            const modal = document.getElementById('addQuestionModal');
            if (modal) {
                modal.style.display = 'flex';
                resetAddQuestionForm();
                console.log('âœ… Add question modal opened');
            } else {
                console.error('âŒ Add question modal not found');
                showNotification('Add question modal not found', 'error');
            }
        }

        function closeAddQuestionModal() {
            console.log('âŒ Closing add question modal...');
            const modal = document.getElementById('addQuestionModal');
            if (modal) {
                modal.style.display = 'none';
                resetAddQuestionForm();
                console.log('âœ… Add question modal closed and form cleared');
            }
        }

        function resetAddQuestionForm() {
            const form = document.getElementById('addQuestionForm');
            if (form) {
                form.reset();

                // Reset question type to MCQ
                document.querySelector('input[name="questionType"][value="mcq"]').checked = true;
                toggleQuestionType();

                // Clear any preview
                const previewContainer = document.getElementById('questionPreview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }

                console.log('ðŸ“ Form reset to default state');
            }
        }

        function toggleQuestionType() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            const mcqOptions = document.getElementById('mcqOptions');
            const numericalAnswer = document.getElementById('numericalAnswer');
            const correctAnswerMCQ = document.getElementById('correctAnswerMCQ');

            if (questionType === 'mcq') {
                mcqOptions.style.display = 'block';
                correctAnswerMCQ.style.display = 'block';
                numericalAnswer.style.display = 'none';

                // Make MCQ options required
                ['qOptionA', 'qOptionB', 'qOptionC', 'qOptionD'].forEach(id => {
                    document.getElementById(id).required = true;
                });
                document.getElementById('qAnswer').required = true;
                document.getElementById('qNumericalAnswer').required = false;
            } else {
                mcqOptions.style.display = 'none';
                correctAnswerMCQ.style.display = 'none';
                numericalAnswer.style.display = 'block';

                // Make numerical answer required
                ['qOptionA', 'qOptionB', 'qOptionC', 'qOptionD'].forEach(id => {
                    document.getElementById(id).required = false;
                });
                document.getElementById('qAnswer').required = false;
                document.getElementById('qNumericalAnswer').required = true;
            }

            console.log(`ðŸ”„ Question type changed to: ${questionType}`);
        }

        function updateChapterOptions() {
            const subject = document.getElementById('qSubject').value;
            const chapterInput = document.getElementById('qChapter');

            // Common chapters for different subjects
            const chapterSuggestions = {
                physics: ['Mechanics', 'Thermodynamics', 'Waves', 'Optics', 'Electricity', 'Magnetism', 'Modern Physics'],
                chemistry: ['Atomic Structure', 'Chemical Bonding', 'Thermodynamics', 'Equilibrium', 'Redox Reactions', 'Organic Chemistry', 'Coordination Compounds'],
                mathematics: ['Algebra', 'Trigonometry', 'Calculus', 'Coordinate Geometry', 'Vectors', 'Probability', 'Statistics'],
                biology: ['Cell Biology', 'Genetics', 'Evolution', 'Ecology', 'Human Physiology', 'Plant Physiology', 'Biotechnology']
            };

            if (subject && chapterSuggestions[subject]) {
                chapterInput.setAttribute('list', 'chapterSuggestions');

                // Create or update datalist
                let datalist = document.getElementById('chapterSuggestions');
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    datalist.id = 'chapterSuggestions';
                    chapterInput.parentNode.appendChild(datalist);
                }

                datalist.innerHTML = chapterSuggestions[subject]
                    .map(chapter => `<option value="${chapter}">`)
                    .join('');
            }
        }

        // LaTeX insertion function - unified implementation
        function insertLatex(fieldId, latexCode = null) {
            const field = document.getElementById(fieldId);
            if (!field) {
                console.error('Field not found:', fieldId);
                return;
            }

            // If no LaTeX code provided, show dropdown
            if (!latexCode) {
                toggleLatexDropdown(fieldId);
                return;
            }

            const cursorPos = field.selectionStart || 0;
            const textBefore = field.value.substring(0, cursorPos);
            const textAfter = field.value.substring(field.selectionEnd || cursorPos);

            // Insert LaTeX code with $ delimiters
            const latexExpression = `$${latexCode}$`;
            field.value = textBefore + latexExpression + textAfter;

            // Position cursor after the LaTeX expression
            field.focus();
            field.setSelectionRange(cursorPos + latexExpression.length, cursorPos + latexExpression.length);

            // Close dropdown
            const dropdown = document.getElementById(`latexDropdown-${fieldId}`);
            if (dropdown) {
                dropdown.classList.remove('active');
            }

            showNotification(`LaTeX expression inserted: ${latexCode}`, 'success');

            // Trigger MathJax rendering if available
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([field.parentElement]).catch((err) => console.log(err));
            }
        }

        function previewQuestion() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            const examType = document.getElementById('qExamType').value;
            const subject = document.getElementById('qSubject').value;
            const chapter = document.getElementById('qChapter').value;
            const difficulty = document.getElementById('qDifficulty').value;
            const questionText = document.getElementById('qText').value;
            const solution = document.getElementById('qSolution').value;

            if (!questionText.trim()) {
                showNotification('Please enter question text to preview', 'warning');
                return;
            }

            let previewHTML = `
                <div class="question-preview">
                    <div class="preview-header">
                        <h4>Question Preview</h4>
                        <div class="preview-meta">
                            <span class="preview-tag">${examType.toUpperCase()}</span>
                            <span class="preview-tag">${subject}</span>
                            <span class="preview-tag">${difficulty}</span>
                        </div>
                    </div>
                    
                    <div class="preview-question">
                        <strong>Chapter:</strong> ${chapter}<br><br>
                        <strong>Question:</strong> ${questionText}
                    </div>
            `;

            if (questionType === 'mcq') {
                const options = [
                    document.getElementById('qOptionA').value,
                    document.getElementById('qOptionB').value,
                    document.getElementById('qOptionC').value,
                    document.getElementById('qOptionD').value
                ];
                const correctAnswer = document.getElementById('qAnswer').value;

                previewHTML += '<div class="preview-options">';
                options.forEach((option, index) => {
                    const letter = String.fromCharCode(65 + index);
                    const isCorrect = letter === correctAnswer;
                    previewHTML += `
                        <div class="preview-option ${isCorrect ? 'correct' : ''}">
                            <strong>${letter})</strong> ${option || `Option ${letter}`}
                        </div>
                    `;
                });
                previewHTML += '</div>';
            } else {
                const numericalAnswer = document.getElementById('qNumericalAnswer').value;
                const unit = document.getElementById('qNumericalUnit').value;
                previewHTML += `
                    <div class="preview-answer">
                        <strong>Expected Answer:</strong> ${numericalAnswer} ${unit}
                    </div>
                `;
            }

            if (solution.trim()) {
                previewHTML += `
                    <div class="preview-solution">
                        <h4>Solution:</h4>
                        <p>${solution}</p>
                    </div>
                `;
            }

            previewHTML += '</div>';

            // Show preview in a modal or insert after form
            let previewContainer = document.getElementById('questionPreview');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'questionPreview';
                document.querySelector('#addQuestionForm').appendChild(previewContainer);
            }

            previewContainer.innerHTML = previewHTML;

            // Render MathJax if available
            if (window.MathJax) {
                MathJax.typesetPromise([previewContainer]).catch(err => {
                    console.warn('MathJax rendering error:', err);
                });
            }

            console.log('ðŸ‘ï¸ Question preview generated');
        }

        async function saveQuestion() {
            console.log('ðŸ’¾ Saving question...');

            // Validate form
            const form = document.getElementById('addQuestionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const questionType = document.querySelector('input[name="questionType"]:checked').value;

            // Prepare question data to match server expectations
            const questionData = {
                examType: document.getElementById('qExamType').value,
                subject: document.getElementById('qSubject').value,
                class: document.getElementById('qClass').value,
                chapter: document.getElementById('qChapter').value,
                difficulty: document.getElementById('qDifficulty').value,
                question: {
                    text: document.getElementById('qText').value,
                    solution: document.getElementById('qSolution').value,
                    explanation: document.getElementById('qExplanation').value || ''
                }
            };

            if (questionType === 'mcq') {
                questionData.question.options = [
                    document.getElementById('qOptionA').value,
                    document.getElementById('qOptionB').value,
                    document.getElementById('qOptionC').value,
                    document.getElementById('qOptionD').value
                ];
                questionData.question.answer = document.getElementById('qAnswer').value;
            } else {
                // For numerical questions, store the answer as a string
                questionData.question.answer = document.getElementById('qNumericalAnswer').value;
                questionData.question.options = []; // Empty options for numerical questions
            }

            console.log('ðŸ“ Question data prepared:', questionData);
            console.log('ðŸ” API_BASE:', API_BASE);
            console.log('ðŸ”‘ Auth token:', localStorage.getItem('authToken') || 'admin-token');

            try {
                console.log('ðŸŒ Making API request to save question...');

                const response = await fetch(`${API_BASE}/api/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify(questionData)
                });

                console.log('ðŸ“¡ Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('ðŸ“¦ Response data:', data);

                if (data.success) {
                    showNotification('âœ… Question saved successfully!', 'success');
                    closeAddQuestionModal();

                    // Refresh questions list if function exists
                    if (typeof loadAllQuestions === 'function') {
                        loadAllQuestions();
                    }

                    // Also refresh question management if visible
                    if (typeof loadQuestionManagement === 'function') {
                        loadQuestionManagement();
                    }

                    console.log('âœ… Question saved successfully:', data.question);
                } else {
                    showNotification(`âŒ Error: ${data.error || 'Failed to save question'}`, 'error');
                    console.error('âŒ Save error:', data.error);
                }
            } catch (error) {
                console.error('âŒ Error saving question:', error);

                if (error.message.includes('Failed to fetch')) {
                    showNotification('âŒ Network error. Please check your connection and ensure the server is running.', 'error');
                } else if (error.message.includes('HTTP 401')) {
                    showNotification('âŒ Authentication error. Please login again.', 'error');
                } else if (error.message.includes('HTTP 400')) {
                    showNotification('âŒ Invalid question data. Please check all required fields.', 'error');
                } else {
                    showNotification(`âŒ Error saving question: ${error.message}`, 'error');
                }
            }
        }



        async function loadAllQuestions() {
            try {
                const response = await fetch(`${API_BASE}/api/questions`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.role}-token`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    displayAdminQuestions(data.questions);
                } else {
                    showNotification('Error loading questions', 'error');
                }
            } catch (error) {
                console.error('Error loading questions:', error);

                // Show demo questions if server is not available
                displayAdminQuestions([
                    {
                        _id: 'demo1',
                        examType: 'JEE',
                        subject: 'Physics',
                        chapter: 'Mechanics',
                        difficulty: 'Medium',
                        question: 'A particle moves with velocity v = 3tÂ² - 2t + 1 m/s. Find acceleration at t = 2s.',
                        options: ['10 m/sÂ²', '12 m/sÂ²', '14 m/sÂ²', '16 m/sÂ²'],
                        correctAnswer: 0,
                        explanation: 'Acceleration a = dv/dt = 6t - 2. At t = 2, a = 6(2) - 2 = 10 m/sÂ²'
                    },
                    {
                        _id: 'demo2',
                        examType: 'NEET',
                        subject: 'Biology',
                        chapter: 'Cell Biology',
                        difficulty: 'Easy',
                        question: 'Which organelle is known as the powerhouse of the cell?',
                        options: ['Nucleus', 'Mitochondria', 'Ribosomes', 'ER'],
                        correctAnswer: 1,
                        explanation: 'Mitochondria produce ATP through cellular respiration.'
                    }
                ]);

                showNotification('Server not available - showing demo questions', 'warning');
            }
        }

        function displayAdminQuestions(questions) {
            if (!questions || questions.length === 0) {
                document.getElementById('adminQuestionsList').innerHTML = `
                < p > No questions found.Add some questions to get started.</p >
                    `;
                return;
            }

            let html = `
                    < div style = "margin-bottom: 1rem; font-weight: 600;" > Total Questions: ${questions.length}</div >
                        <div style="max-height: 500px; overflow-y: auto;">
                            `;

            questions.forEach((question, index) => {
                html += `
                    <div class="test-card">
                        <div class="test-header">
                            <div class="test-title">Question ${index + 1}</div>
                            <div class="test-difficulty difficulty-${question.difficulty}">${question.difficulty}</div>
                        </div>
                        <div class="question-text">${preserveLineBreaks(question.text)}</div>
                        
                        ${question.references ? `
                            <div class="question-references" style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">
                                    <i class="fas fa-book"></i>
                                    References
                                </div>
                                <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                                    ${preserveLineBreaks(question.references)}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${question.tags && question.tags.length > 0 ? `
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                ${question.tags.map(tag => `<span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 500;">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editQuestion('${question._id}')" style="font-size: 0.875rem;">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button class="btn" onclick="deleteQuestion('${question.id}')" style="font-size: 0.875rem; background: var(--error); color: white;">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            document.getElementById('adminQuestionsList').innerHTML = html;

            // Render MathJax for LaTeX expressions
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('adminQuestionsList')]).catch((err) => {
                    console.log('MathJax rendering error:', err);
                });
            }
        }

        async function editQuestion(questionId) {
            console.log('âœï¸ Editing question:', questionId);

            try {
                // Find the question in our stored data
                if (!allQuestionsData || !Array.isArray(allQuestionsData)) {
                    showNotification('Questions data not loaded yet', 'error');
                    return;
                }
                const question = allQuestionsData.find(q => q._id === questionId);
                if (!question) {
                    showNotification('Question not found', 'error');
                    return;
                }

                // Populate the edit form
                document.getElementById('editQuestionId').value = questionId;
                document.getElementById('editQExamType').value = question.examType;
                document.getElementById('editQSubject').value = question.subject;
                document.getElementById('editQClass').value = question.class;
                document.getElementById('editQDifficulty').value = question.difficulty;
                document.getElementById('editQChapter').value = question.chapter;
                document.getElementById('editQText').value = question.text;
                document.getElementById('editQOptionA').value = question.options[0] || '';
                document.getElementById('editQOptionB').value = question.options[1] || '';
                document.getElementById('editQOptionC').value = question.options[2] || '';
                document.getElementById('editQOptionD').value = question.options[3] || '';
                document.getElementById('editQAnswer').value = question.answer;
                document.getElementById('editQSolution').value = question.solution;
                document.getElementById('editQExplanation').value = question.explanation || '';

                // Show the modal
                document.getElementById('editQuestionModal').style.display = 'flex';

            } catch (error) {
                console.error('Error loading question for edit:', error);
                showNotification('Error loading question', 'error');
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/questions/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentUser.role}-token`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Question deleted successfully!', 'success');
                    loadAllQuestions();
                } else {
                    showNotification(data.error || 'Error deleting question', 'error');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showNotification('Network error deleting question', 'error');
            }
        }







        // Reset upload state
        function resetUploadState() {
            extractedQuestions = [];
            selectedQuestions = [];
            document.getElementById('imageInput').value = '';
            document.getElementById('processingStatus').style.display = 'none';
            document.getElementById('extractedQuestions').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        // Setup image upload functionality
        function setupImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // Click to upload
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // File input change
            imageInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleImageFiles(files);
            });
        }

        // Handle uploaded image files
        async function handleImageFiles(files) {
            if (files.length === 0) return;

            // Show processing status
            showProcessingStatus();

            try {
                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProcessingStatus(`Processing ${file.name}...`, (i / files.length) * 100);

                    // Convert file to base64
                    const base64 = await fileToBase64(file);

                    // Extract questions from image
                    const questions = await extractQuestionsFromImage(base64, file.name);
                    extractedQuestions.push(...questions);
                }

                // Show extracted questions
                displayExtractedQuestions();
                hideProcessingStatus();

            } catch (error) {
                console.error('Error processing images:', error);
                showNotification('Error processing images: ' + error.message, 'error');
                hideProcessingStatus();
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Extract questions from image using AI
        async function extractQuestionsFromImage(base64Image, fileName) {
            try {
                const response = await fetch('/api/ai-guidance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'student-token'}`
                    },
                    body: JSON.stringify({
                        query: `Please analyze this image and extract all JEE/NEET questions. For each question, provide:
1. Question text (with proper LaTeX formatting for mathematical expressions)
2. Multiple choice options (A, B, C, D)
3. Correct answer
4. Subject (Physics, Chemistry, Mathematics, Biology)
5. Chapter/topic if visible
6. Difficulty level (easy, medium, hard)
7. Solution/explanation if provided

Format the response as a JSON array of question objects. Use proper LaTeX syntax like $x^2$ for inline math and $$\\frac{a}{b}$$ for display math.`,
                        files: [{
                            name: fileName,
                            data: base64Image,
                            mimeType: 'image/jpeg'
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to process image');
                }

                // Parse AI response to extract questions
                return parseAIResponse(result.guidance, fileName);

            } catch (error) {
                console.error('Error extracting questions:', error);
                throw error;
            }
        }

        // Parse AI response to extract question objects
        function parseAIResponse(aiResponse, fileName) {
            try {
                // Try to extract JSON from the AI response
                const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const questions = JSON.parse(jsonMatch[0]);
                    return questions.map((q, index) => ({
                        id: `IMG_${Date.now()}_${index}`,
                        text: q.question || q.text || '',
                        options: q.options || [],
                        answer: q.correctAnswer || q.answer || 'A',
                        subject: q.subject || 'Physics',
                        chapter: q.chapter || q.topic || 'Unknown',
                        difficulty: q.difficulty || 'medium',
                        solution: q.solution || q.explanation || '',
                        explanation: q.explanation || '',
                        source: fileName,
                        confidence: 0.85,
                        selected: true
                    }));
                }

                // Fallback: create a single question from the response
                return [{
                    id: `IMG_${Date.now()}_0`,
                    text: 'Question extracted from ' + fileName,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    answer: 'A',
                    subject: 'Physics',
                    chapter: 'Unknown',
                    difficulty: 'medium',
                    solution: aiResponse.substring(0, 500),
                    explanation: '',
                    source: fileName,
                    confidence: 0.5,
                    selected: true
                }];

            } catch (error) {
                console.error('Error parsing AI response:', error);
                // Return a placeholder question
                return [{
                    id: `IMG_${Date.now()}_0`,
                    text: 'Failed to extract question from ' + fileName,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    answer: 'A',
                    subject: 'Physics',
                    chapter: 'Unknown',
                    difficulty: 'medium',
                    solution: 'Processing failed',
                    explanation: '',
                    source: fileName,
                    confidence: 0.1,
                    selected: false
                }];
            }
        }

        // Show processing status
        function showProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('extractedQuestions').style.display = 'none';
        }

        // Update processing status
        function updateProcessingStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Hide processing status
        function hideProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'none';
            document.getElementById('extractedQuestions').style.display = 'block';
        }

        // Display extracted questions
        function displayExtractedQuestions() {
            const questionsList = document.getElementById('questionsList');

            if (extractedQuestions.length === 0) {
                questionsList.innerHTML = '<p>No questions were extracted from the images.</p>';
                return;
            }

            let html = '';
            extractedQuestions.forEach((question, index) => {
                html += `
                    <div class="question-preview ${question.selected ? 'selected' : ''}" data-index="${index}">
                        <div class="question-header">
                            <input type="checkbox" class="question-checkbox" ${question.selected ? 'checked' : ''} 
                                   onchange="toggleQuestionSelection(${index})">
                            <div class="confidence-indicator">
                                <span>Confidence:</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${question.confidence * 100}%"></div>
                                </div>
                                <span>${Math.round(question.confidence * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="question-meta">
                            <span class="meta-tag subject">${question.subject}</span>
                            <span class="meta-tag difficulty">${question.difficulty}</span>
                            <span class="meta-tag chapter">${question.chapter}</span>
                        </div>
                        
                        <div class="question-text">${preserveLineBreaks(question.text)}</div>
                        
                        <div class="question-options">
                            ${question.options.map((option, i) => `
                                <div class="option-item ${String.fromCharCode(65 + i) === question.answer ? 'correct' : ''}">
                                    ${String.fromCharCode(65 + i)}. ${preserveLineBreaks(option)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <small style="color: var(--gray-600);">Source: ${question.source}</small>
                            <button class="edit-question-btn" onclick="editQuestion(${index})">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            });

            questionsList.innerHTML = html;
        }

        // Toggle question selection
        function toggleQuestionSelection(index) {
            extractedQuestions[index].selected = !extractedQuestions[index].selected;
            displayExtractedQuestions();
        }

        // Select all questions
        function selectAllQuestions() {
            extractedQuestions.forEach(q => q.selected = true);
            displayExtractedQuestions();
        }

        // Save selected questions
        async function saveSelectedQuestions() {
            const selected = extractedQuestions.filter(q => q.selected);

            if (selected.length === 0) {
                showNotification('Please select at least one question to save.', 'warning');
                return;
            }

            try {
                showNotification('Saving questions...', 'info');

                for (const question of selected) {
                    await saveQuestionToDatabase(question);
                }

                showNotification(`Successfully saved ${selected.length} questions!`, 'success');
                closeImageUploadModal();

                // Refresh question bank if we're on that section
                if (document.getElementById('questionBankSection').style.display !== 'none') {
                    loadQuestionBank();
                }

            } catch (error) {
                console.error('Error saving questions:', error);
                showNotification('Error saving questions: ' + error.message, 'error');
            }
        }


        // Save individual question to database
        async function saveQuestionToDatabase(question) {
            const response = await fetch('/api/questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                },
                body: JSON.stringify({
                    examType: question.subject.toLowerCase() === 'biology' ? 'neet' : 'jee',
                    subject: question.subject.toLowerCase(),
                    class: '11', // Default class
                    chapter: question.chapter,
                    difficulty: question.difficulty,
                    question: question.question,
                    options: question.options,
                    correctAnswer: question.correctAnswer,
                    explanation: question.explanation
                })
            });

            return response.json();
        }

        // Physics Questions Variables
        let physicsQuestions = {
            mechanics: [
                {
                    id: 1,
                    question: "A ball is thrown vertically upward with an initial velocity of 20 m/s. What is the maximum height reached?",
                    options: ["10 m", "15 m", "20 m", "25 m"],
                    correctAnswer: 2,
                    difficulty: "medium",
                    explanation: "Using vÂ² = uÂ² + 2as, where v = 0 at max height, u = 20 m/s, a = -9.8 m/sÂ². Height = uÂ²/(2g) = 400/(2Ã—9.8) â‰ˆ 20.4 m",
                    source: "JEE Main 2023"
                },
                {
                    id: 2,
                    question: "What is Newton's second law of motion?",
                    options: ["F = ma", "F = mv", "F = m/a", "F = a/m"],
                    correctAnswer: 0,
                    difficulty: "easy",
                    explanation: "Newton's second law states that the force acting on an object is equal to mass times acceleration.",
                    source: "NCERT Physics"
                }
            ],
            thermodynamics: [
                {
                    id: 3,
                    question: "What is the efficiency of a Carnot engine operating between 400K and 300K?",
                    options: ["20%", "25%", "30%", "35%"],
                    correctAnswer: 1,
                    difficulty: "hard",
                    explanation: "Efficiency = 1 - Tâ‚‚/Tâ‚ = 1 - 300/400 = 1 - 0.75 = 0.25 = 25%",
                    source: "JEE Advanced 2022"
                }
            ],
            waves: [
                {
                    id: 4,
                    question: "The frequency of a wave is 50 Hz and wavelength is 4 m. What is the wave speed?",
                    options: ["200 m/s", "150 m/s", "100 m/s", "250 m/s"],
                    correctAnswer: 0,
                    difficulty: "easy",
                    explanation: "Wave speed v = fÎ» = 50 Ã— 4 = 200 m/s",
                    source: "NCERT Physics"
                }
            ]
        };
        let currentTopic = 'all';
        let currentDifficulty = 'all';

        function displayPhysicsQuestions() {
            showPhysicsTopic('all');
        }

        function showPhysicsTopic(topic, button = null) {
            currentTopic = topic;

            // Update active button
            document.querySelectorAll('.topic-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'var(--primary)';
            });

            if (button) {
                button.classList.add('active');
                button.style.background = 'var(--primary)';
                button.style.color = 'white';
            } else {
                const topicTab = document.querySelector('.topic-tab');
                if (topicTab) {
                    topicTab.classList.add('active');
                    topicTab.style.background = 'var(--primary)';
                    topicTab.style.color = 'white';
                }
            }

            renderQuestions();
        }

        function filterByDifficulty(difficulty, button = null) {
            currentDifficulty = difficulty;

            // Update active button
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
            });

            if (button) {
                button.classList.add('active');
                button.style.background = 'var(--primary)';
                button.style.color = 'white';
            }

            renderQuestions();
        }

        function renderQuestions() {
            const container = document.querySelector('#questionBankSection #physicsQuestionsList') || document.getElementById('physicsQuestionsList');
            if (!container) {
                console.warn('physicsQuestionsList element not found');
                return;
            }
            let questions = [];

            // Get questions based on topic
            if (currentTopic === 'all') {
                Object.values(physicsQuestions).forEach(topicQuestions => {
                    questions = questions.concat(topicQuestions);
                });
            } else {
                questions = physicsQuestions[currentTopic] || [];
            }

            // Filter by difficulty
            if (currentDifficulty !== 'all') {
                questions = questions.filter(q => q.difficulty === currentDifficulty);
            }

            let html = '';

            questions.forEach((question, index) => {
                const difficultyColor = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                html += `
                    <div class="question-card" style="background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: var(--transition-base);">
                        <div class="question-header" style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                            <div class="question-meta" style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <span class="question-id" style="background: var(--gray-100); color: var(--gray-700); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500;">${question.id}</span>
                                <span class="difficulty-badge" style="background: ${difficultyColor[question.difficulty]}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500; text-transform: capitalize;">${question.difficulty}</span>
                                ${question.tags ? question.tags.map(tag => `<span class="tag" style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">${tag}</span>`).join('') : ''}
                            </div>
                        </div>
                        
                        <div class="question-text" style="font-size: 1rem; line-height: 1.6; margin-bottom: 1rem; color: var(--gray-800);">
                            ${preserveLineBreaks(question.question)}
                        </div>
                        
                        <div class="options-grid" style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                            ${question.options.map((option, optIndex) => `
                                <div class="option" style="padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--gray-50); font-size: 0.9rem;">
                                    <strong>${String.fromCharCode(65 + optIndex)}.</strong> ${preserveLineBreaks(option)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="question-actions" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button onclick="toggleSolution('${question.id}')" class="btn" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-lightbulb"></i> Show Solution
                            </button>
                            <button onclick="toggleExplanation('${question.id}')" class="btn" style="background: var(--secondary); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> Explanation
                            </button>
                        </div>
                        
                        <div id="solution-${question.id}" class="solution-panel" style="display: none; background: var(--success); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i> Correct Answer: ${String.fromCharCode(65 + question.correctAnswer)}</h4>
                        </div>
                        
                        <div id="explanation-${question.id}" class="explanation-panel" style="display: none; background: var(--gray-100); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; border-left: 4px solid var(--primary);">
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-graduation-cap"></i> Detailed Explanation:</h4>
                            <div style="color: var(--gray-800); line-height: 1.6;">${preserveLineBreaks(question.explanation)}</div>
                        </div>
                    </div>
                `;
            });

            if (questions.length === 0) {
                html = `
                    <div class="no-questions" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No questions found</h3>
                        <p>Try adjusting your filters or select a different topic.</p>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Re-render MathJax for LaTeX
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch((err) => console.log(err.message));
            }
        }

        function toggleSolution(questionId) {
            const panel = document.getElementById(`solution-${questionId}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Solution';
                button.style.background = 'var(--gray-500)';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-lightbulb"></i> Show Solution';
                button.style.background = 'var(--primary)';
            }
        }

        function toggleExplanation(questionId) {
            const panel = document.getElementById(`explanation-${questionId}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Explanation';
                button.style.background = 'var(--gray-500)';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-info-circle"></i> Explanation';
                button.style.background = 'var(--secondary)';
            }
        }






        // Initialize uploadArea element
        const uploadArea = document.getElementById('uploadArea') || document.createElement('div');
        // Initialize imageInput element
        const imageInput = document.getElementById('imageInput') || document.createElement('input');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleImageFiles(files);
        });

        // Click to upload
        uploadArea.addEventListener('click', () => {
            imageInput.click();
        });

        // File input change
        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });


        // Handle uploaded image files
        async function handleImageFiles(files) {
            if (files.length === 0) return;

            // Show processing status
            showProcessingStatus();

            try {
                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProcessingStatus(`Processing ${file.name}...`, (i / files.length) * 100);

                    // Convert file to base64
                    const base64 = await fileToBase64(file);

                    // Extract questions from image
                    const questions = await extractQuestionsFromImage(base64, file.name);
                    extractedQuestions.push(...questions);
                }

                // Show extracted questions
                displayExtractedQuestions();
                hideProcessingStatus();

            } catch (error) {
                console.error('Error processing images:', error);
                showNotification('Error processing images: ' + error.message, 'error');
                hideProcessingStatus();
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Extract questions from image using AI
        async function extractQuestionsFromImage(base64Image, fileName) {
            try {
                const response = await fetch('/api/ai-guidance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'student-token'}`
                    },
                    body: JSON.stringify({
                        query: `Please analyze this image and extract all JEE/NEET questions. For each question, provide:
1. Question text (with proper LaTeX formatting for mathematical expressions)
2. Multiple choice options (A, B, C, D)
3. Correct answer
4. Subject (Physics, Chemistry, Mathematics, Biology)
5. Chapter/topic if visible
6. Difficulty level (easy, medium, hard)
7. Solution/explanation if provided

Format the response as a JSON array of question objects. Use proper LaTeX syntax like $x^2$ for inline math and $$\\frac{a}{b}$$ for display math.`,
                        files: [{
                            name: fileName,
                            data: base64Image,
                            mimeType: 'image/jpeg'
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to process image');
                }

                // Parse AI response to extract questions
                return parseAIResponse(result.guidance, fileName);

            } catch (error) {
                console.error('Error extracting questions:', error);
                throw error;
            }
        }

        // Parse AI response to extract question objects
        function parseAIResponse(aiResponse, fileName) {
            try {
                // Try to extract JSON from the AI response
                const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const questions = JSON.parse(jsonMatch[0]);
                    return questions.map((q, index) => ({
                        id: `IMG_${Date.now()}_${index}`,
                        text: q.question || q.text || '',
                        options: q.options || [],
                        answer: q.correctAnswer || q.answer || 'A',
                        subject: q.subject || 'Physics',
                        chapter: q.chapter || q.topic || 'Unknown',
                        difficulty: q.difficulty || 'medium',
                        solution: q.solution || q.explanation || '',
                        explanation: q.explanation || '',
                        source: fileName,
                        confidence: 0.85,
                        selected: true
                    }));
                }

                // Fallback: create a single question from the response
                return [{
                    id: `IMG_${Date.now()}_0`,
                    text: 'Question extracted from ' + fileName,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    answer: 'A',
                    subject: 'Physics',
                    chapter: 'Unknown',
                    difficulty: 'medium',
                    solution: aiResponse.substring(0, 500),
                    explanation: '',
                    source: fileName,
                    confidence: 0.5,
                    selected: true
                }];

            } catch (error) {
                console.error('Error parsing AI response:', error);
                // Return a placeholder question
                return [{
                    id: `IMG_${Date.now()}_0`,
                    text: 'Failed to extract question from ' + fileName,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    answer: 'A',
                    subject: 'Physics',
                    chapter: 'Unknown',
                    difficulty: 'medium',
                    solution: 'Processing failed',
                    explanation: '',
                    source: fileName,
                    confidence: 0.1,
                    selected: false
                }];
            }
        }

        // Show processing status
        function showProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('extractedQuestions').style.display = 'none';
        }

        // Update processing status
        function updateProcessingStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Hide processing status
        function hideProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'none';
            document.getElementById('extractedQuestions').style.display = 'block';
        }

        // Display extracted questions
        function displayExtractedQuestions() {
            const questionsList = document.getElementById('questionsList');

            if (extractedQuestions.length === 0) {
                questionsList.innerHTML = '<p>No questions were extracted from the images.</p>';
                return;
            }

            let html = '';
            extractedQuestions.forEach((question, index) => {
                html += `
                    <div class="question-preview ${question.selected ? 'selected' : ''}" data-index="${index}">
                        <div class="question-header">
                            <input type="checkbox" class="question-checkbox" ${question.selected ? 'checked' : ''} 
                                   onchange="toggleQuestionSelection(${index})">
                            <div class="confidence-indicator">
                                <span>Confidence:</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${question.confidence * 100}%"></div>
                                </div>
                                <span>${Math.round(question.confidence * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="question-meta">
                            <span class="meta-tag subject">${question.subject}</span>
                            <span class="meta-tag difficulty">${question.difficulty}</span>
                            <span class="meta-tag chapter">${question.chapter}</span>
                        </div>
                        
                        <div class="question-text">${preserveLineBreaks(question.text)}</div>
                        
                        <div class="question-options">
                            ${question.options.map((option, i) => `
                                <div class="option-item ${String.fromCharCode(65 + i) === question.answer ? 'correct' : ''}">
                                    ${String.fromCharCode(65 + i)}. ${preserveLineBreaks(option)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <small style="color: var(--gray-600);">Source: ${question.source}</small>
                            <button class="edit-question-btn" onclick="editQuestion(${index})">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            });

            questionsList.innerHTML = html;
        }

        // Toggle question selection
        function toggleQuestionSelection(index) {
            extractedQuestions[index].selected = !extractedQuestions[index].selected;
            displayExtractedQuestions();
        }

        // Select all questions
        function selectAllQuestions() {
            extractedQuestions.forEach(q => q.selected = true);
            displayExtractedQuestions();
        }

        // Save selected questions
        async function saveSelectedQuestions() {
            const selected = extractedQuestions.filter(q => q.selected);

            if (selected.length === 0) {
                showNotification('Please select at least one question to save.', 'warning');
                return;
            }

            try {
                showNotification('Saving questions...', 'info');

                for (const question of selected) {
                    await saveQuestionToDatabase(question);
                }

                showNotification(`Successfully saved ${selected.length} questions!`, 'success');
                closeImageUploadModal();

                // Refresh question bank if we're on that section
                if (document.getElementById('questionBankSection').style.display !== 'none') {
                    loadQuestionBank();
                }

            } catch (error) {
                console.error('Error saving questions:', error);
                showNotification('Error saving questions: ' + error.message, 'error');
            }
        }


        // Save individual question to database
        async function saveQuestionToDatabase(question) {
            const response = await fetch('/api/questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                },
                body: JSON.stringify({
                    examType: question.subject.toLowerCase() === 'biology' ? 'neet' : 'jee',
                    subject: question.subject.toLowerCase(),
                    class: '11', // Default class
                    chapter: question.chapter,
                    difficulty: question.difficulty,
                    question: question.question,
                    options: question.options,
                    correctAnswer: question.correctAnswer,
                    explanation: question.explanation
                })
            });

            return response.json();
        }


        function displayPhysicsQuestions() {
            showPhysicsTopic('all');
        }

        function showPhysicsTopic(topic, button = null) {
            currentTopic = topic;

            // Update active button
            document.querySelectorAll('.topic-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'var(--primary)';
            });

            if (button) {
                button.classList.add('active');
                button.style.background = 'var(--primary)';
                button.style.color = 'white';
            } else {
                const topicTab = document.querySelector('.topic-tab');
                if (topicTab) {
                    topicTab.classList.add('active');
                    topicTab.style.background = 'var(--primary)';
                    topicTab.style.color = 'white';
                }
            }

            renderQuestions();
        }

        function filterByDifficulty(difficulty, button = null) {
            currentDifficulty = difficulty;

            // Update active button
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
            });

            if (button) {
                button.classList.add('active');
                button.style.background = 'var(--primary)';
                button.style.color = 'white';
            }

            renderQuestions();
        }

        function renderQuestions() {
            const container = document.querySelector('#questionBankSection #physicsQuestionsList') || document.getElementById('physicsQuestionsList');
            if (!container) {
                console.warn('physicsQuestionsList element not found');
                return;
            }
            let questions = [];

            // Get questions based on topic
            if (currentTopic === 'all') {
                Object.values(physicsQuestions).forEach(topicQuestions => {
                    questions = questions.concat(topicQuestions);
                });
            } else {
                questions = physicsQuestions[currentTopic] || [];
            }

            // Filter by difficulty
            if (currentDifficulty !== 'all') {
                questions = questions.filter(q => q.difficulty === currentDifficulty);
            }

            let html = '';

            questions.forEach((question, index) => {
                const difficultyColor = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                html += `
                    <div class="question-card" style="background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: var(--transition-base);">
                        <div class="question-header" style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                            <div class="question-meta" style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <span class="question-id" style="background: var(--gray-100); color: var(--gray-700); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500;">${question.id}</span>
                                <span class="difficulty-badge" style="background: ${difficultyColor[question.difficulty]}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500; text-transform: capitalize;">${question.difficulty}</span>
                                ${question.tags ? question.tags.map(tag => `<span class="tag" style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">${tag}</span>`).join('') : ''}
                            </div>
                        </div>
                        
                        <div class="question-text" style="font-size: 1rem; line-height: 1.6; margin-bottom: 1rem; color: var(--gray-800);">
                            ${preserveLineBreaks(question.question)}
                        </div>
                        
                        <div class="options-grid" style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                            ${question.options.map((option, optIndex) => `
                                <div class="option" style="padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--gray-50); font-size: 0.9rem;">
                                    <strong>${String.fromCharCode(65 + optIndex)}.</strong> ${preserveLineBreaks(option)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="question-actions" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button onclick="toggleSolution('${question.id}')" class="btn" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-lightbulb"></i> Show Solution
                            </button>
                            <button onclick="toggleExplanation('${question.id}')" class="btn" style="background: var(--secondary); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> Explanation
                            </button>
                        </div>
                        
                        <div id="solution-${question.id}" class="solution-panel" style="display: none; background: var(--success); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i> Correct Answer: ${String.fromCharCode(65 + question.correctAnswer)}</h4>
                        </div>
                        
                        <div id="explanation-${question.id}" class="explanation-panel" style="display: none; background: var(--gray-100); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; border-left: 4px solid var(--primary);">
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-graduation-cap"></i> Detailed Explanation:</h4>
                            <div style="color: var(--gray-800); line-height: 1.6;">${preserveLineBreaks(question.explanation)}</div>
                        </div>
                    </div>
                `;
            });

            if (questions.length === 0) {
                html = `
                    <div class="no-questions" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No questions found</h3>
                        <p>Try adjusting your filters or select a different topic.</p>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Re-render MathJax for LaTeX
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch((err) => console.log(err.message));
            }
        }

        function toggleSolution(questionId) {
            const panel = document.getElementById(`solution-${questionId}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Solution';
                button.style.background = 'var(--gray-500)';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-lightbulb"></i> Show Solution';
                button.style.background = 'var(--primary)';
            }
        }

        function toggleExplanation(questionId) {
            const panel = document.getElementById(`explanation-${questionId}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Explanation';
                button.style.background = 'var(--gray-500)';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-info-circle"></i> Explanation';
                button.style.background = 'var(--secondary)';
            }
        }


        // ===== IMAGE QUESTION UPDATER FUNCTIONS =====

        // Open image upload modal
        function openImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'flex';
            setupImageUpload();
        }

        // Reset upload state
        function resetUploadState() {
            extractedQuestions = [];
            selectedQuestions = [];
            document.getElementById('imageInput').value = '';
            document.getElementById('processingStatus').style.display = 'none';
            document.getElementById('extractedQuestions').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        // Close image upload modal
        function closeImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'none';
            resetUploadState();
        }

        // Setup image upload functionality
        function setupImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // Click to upload
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // File input change
            imageInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleImageFiles(files);
            });
        }

        // Handle uploaded image files
        async function handleImageFiles(files) {
            if (files.length === 0) return;

            // Show processing status
            showProcessingStatus();

            try {
                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProcessingStatus(`Processing ${file.name}...`, (i / files.length) * 100);

                    // Convert file to base64
                    const base64 = await fileToBase64(file);

                    // Extract questions from image
                    const questions = await extractQuestionsFromImage(base64, file.name);
                    extractedQuestions.push(...questions);
                }

                // Show extracted questions
                displayExtractedQuestions();
                hideProcessingStatus();

            } catch (error) {
                console.error('Error processing images:', error);
                showNotification('Error processing images: ' + error.message, 'error');
                hideProcessingStatus();
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Extract questions from image using AI
        async function extractQuestionsFromImage(base64Image, fileName) {
            try {
                const response = await fetch(`${API_BASE}/api/ai-guidance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'student-token'}`
                    },
                    body: JSON.stringify({
                        query: `Please analyze this image and extract all JEE/NEET questions. For each question, provide:
1. Question text (with proper LaTeX formatting for mathematical expressions)
2. Multiple choice options (A, B, C, D)
3. Correct answer
4. Subject (Physics, Chemistry, Mathematics, Biology)
5. Chapter/topic if visible
6. Difficulty level (easy, medium, hard)
7. Solution/explanation if provided

Format the response as a JSON array of question objects. Use proper LaTeX syntax like $x^2$ for inline math and $\\frac{a}{b}$ for display math.`,
                        files: [{
                            name: fileName,
                            data: base64Image,
                            mimeType: 'image/jpeg'
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to process image');
                }

                // Parse AI response to extract questions
                return parseAIResponse(result.guidance, fileName);

            } catch (error) {
                console.error('Error extracting questions:', error);
                throw error;
            }
        }

        // Parse AI response to extract question objects
        function parseAIResponse(aiResponse, fileName) {
            try {
                // Try to extract JSON from the AI response
                const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const questions = JSON.parse(jsonMatch[0]);
                    return questions.map((q, index) => ({
                        id: `IMG_${Date.now()}_${index}`,
                        text: q.question || q.text || '',
                        options: q.options || [],
                        answer: q.correctAnswer || q.answer || 'A',
                        subject: q.subject || 'Physics',
                        chapter: q.chapter || q.topic || 'Unknown',
                        difficulty: q.difficulty || 'medium',
                        solution: q.solution || q.explanation || '',
                        source: fileName,
                        selected: true
                    }));
                } else {
                    // Fallback: try to parse as plain text
                    return [{
                        id: `IMG_${Date.now()}_0`,
                        text: 'Could not parse questions from image. Please check the image quality.',
                        options: ['A', 'B', 'C', 'D'],
                        answer: 'A',
                        subject: 'Physics',
                        chapter: 'Unknown',
                        difficulty: 'medium',
                        solution: 'Manual review required',
                        source: fileName,
                        selected: false
                    }];
                }
            } catch (error) {
                console.error('Error parsing AI response:', error);
                return [{
                    id: `IMG_${Date.now()}_0`,
                    text: 'Error parsing questions from AI response.',
                    options: ['A', 'B', 'C', 'D'],
                    answer: 'A',
                    subject: 'Physics',
                    chapter: 'Unknown',
                    difficulty: 'medium',
                    solution: 'Manual review required',
                    source: fileName,
                    selected: false
                }];
            }
        }

        // Show processing status
        function showProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('extractedQuestions').style.display = 'none';
        }

        // Update processing status
        function updateProcessingStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Hide processing status
        function hideProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'none';
            document.getElementById('extractedQuestions').style.display = 'block';
        }

        // Display extracted questions
        function displayExtractedQuestions() {
            const questionsList = document.getElementById('questionsList');

            if (extractedQuestions.length === 0) {
                questionsList.innerHTML = '<p>No questions were extracted from the images.</p>';
                return;
            }

            let html = '';
            extractedQuestions.forEach((question, index) => {
                const difficultyColors = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                html += `
                    <div class="question-preview ${question.selected ? 'selected' : ''}" data-index="${index}">
                        <div class="question-header">
                            <input type="checkbox" class="question-checkbox" ${question.selected ? 'checked' : ''} 
                                   onchange="toggleQuestionSelection(${index})">
                            <div class="question-meta">
                                <span class="meta-tag subject">${question.subject}</span>
                                <span class="meta-tag difficulty" style="background: ${difficultyColors[question.difficulty]}; color: white;">
                                    ${question.difficulty}
                                </span>
                                <span class="meta-tag chapter">${question.chapter}</span>
                            </div>
                        </div>
                        <div class="question-text">${preserveLineBreaks(question.text)}</div>
                        <div class="question-options">
                            ${question.options.map((option, optIndex) => `
                                <div class="option-item ${optIndex === question.answer ? 'correct' : ''}">
                                    ${String.fromCharCode(65 + optIndex)}. ${preserveLineBreaks(option)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="confidence-indicator">
                            <span>Confidence:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 85%"></div>
                            </div>
                            <span>85%</span>
                        </div>
                        <button class="edit-question-btn" onclick="editQuestion(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                `;
            });

            questionsList.innerHTML = html;
        }

        // Toggle question selection
        function toggleQuestionSelection(index) {
            extractedQuestions[index].selected = !extractedQuestions[index].selected;
            displayExtractedQuestions();
        }

        // Select all questions
        function selectAllQuestions() {
            extractedQuestions.forEach(q => q.selected = true);
            displayExtractedQuestions();
        }

        // Save selected questions
        async function saveSelectedQuestions() {
            const selected = extractedQuestions.filter(q => q.selected);

            if (selected.length === 0) {
                showNotification('Please select at least one question to save.', 'warning');
                return;
            }

            try {
                // Save each selected question
                for (const question of selected) {
                    await saveQuestionToDatabase(question);
                }

                showNotification(`Successfully saved ${selected.length} questions!`, 'success');
                closeImageUploadModal();

                // Refresh question bank if we're on that section
                if (document.querySelector('.nav-item.active')?.textContent.includes('Question Bank')) {
                    loadQuestionBank();
                }

            } catch (error) {
                console.error('Error saving questions:', error);
                showNotification('Error saving questions: ' + error.message, 'error');
            }
        }

        // Save individual question to database
        async function saveQuestionToDatabase(question) {
            const response = await fetch('/api/questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                },
                body: JSON.stringify({
                    examType: question.subject.toLowerCase() === 'biology' ? 'neet' : 'jee',
                    subject: question.subject.toLowerCase(),
                    class: '11', // Default class
                    chapter: question.chapter,
                    difficulty: question.difficulty,
                    question: question.question,
                    options: question.options,
                    correctAnswer: question.correctAnswer,
                    explanation: question.explanation
                })
            });

            return response.json();
        }

        // Question Bank Functions
        // Duplicate variables removed - using main definitions above
        // Duplicate functions removed to avoid conflicts

        function showSubject(examType, subject) {
            currentExamType = examType;
            currentSubject = subject;

            // Hide main content and show subject detail
            document.getElementById('jeeContent').style.display = 'none';
            document.getElementById('neetContent').style.display = 'none';
            document.getElementById('subjectDetailView').style.display = 'block';
            document.getElementById('questionPracticeView').style.display = 'none';

            // Update header
            const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
            const examName = examType.toUpperCase();
            document.getElementById('subjectDetailTitle').textContent = `${subjectName} - ${examName}`;
            document.getElementById('subjectDetailSubtitle').textContent = `Choose a chapter to start practicing ${subjectName}`;

            // Load chapters
            loadChapters(examType, subject);
        }

        function selectQuestionOption(questionIndex, optionIndex) {
            // Add visual feedback for selected option
            const questionCard = document.querySelectorAll('.question-card')[questionIndex];
            const options = questionCard.querySelectorAll('.option-item');

            // Reset all options
            options.forEach(option => {
                option.style.borderColor = '#e5e7eb';
                option.style.background = 'white';
            });

            // Highlight selected option
            options[optionIndex].style.borderColor = '#6366f1';
            options[optionIndex].style.background = '#f0f9ff';
        }

        function showQuestionSolution(questionIndex) {
            const panel = document.getElementById(`solution-${questionIndex}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Solution';
                button.style.background = '#6b7280';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-lightbulb"></i> Show Solution';
                button.style.background = '#6366f1';
            }
        }

        function showQuestionExplanation(questionIndex) {
            const panel = document.getElementById(`explanation-${questionIndex}`);
            const button = event.target;

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Explanation';
                button.style.background = '#6b7280';
            } else {
                panel.style.display = 'none';
                button.innerHTML = '<i class="fas fa-info-circle"></i> Explanation';
                button.style.background = '#10b981';
            }
        }

        function goBackToQuestionBank() {
            document.getElementById('subjectDetailView').style.display = 'none';
            document.getElementById('questionPracticeView').style.display = 'none';

            if (currentExamType === 'jee') {
                document.getElementById('jeeContent').style.display = 'block';
            } else {
                document.getElementById('neetContent').style.display = 'block';
            }
        }



        function filterQuestions() {
            const difficulty = document.getElementById('difficultyFilter').value;
            const questionCards = document.querySelectorAll('.question-card');

            questionCards.forEach(card => {
                const difficultyBadge = card.querySelector('.question-meta span:last-child');
                const cardDifficulty = difficultyBadge.textContent.toLowerCase();

                if (difficulty === 'all' || cardDifficulty === difficulty) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function startQuestionTest() {
            showNotification('Test mode will be implemented in the next version!', 'info');
        }

        // Test Section Functions - REMOVED (testSection no longer exists)


        function showTestSubject(examType, subject) {
            // Update active subject tab
            const container = document.getElementById(examType + 'TestContent');
            if (container) {
                container.querySelectorAll('.subject-tab').forEach(tab => tab.classList.remove('active'));

                // Find and activate the correct subject tab
                const subjectTab = container.querySelector(`.subject-tab[onclick*="${subject}"]`);
                if (subjectTab) {
                    subjectTab.classList.add('active');
                }
            }

            // Load chapters for this subject
            loadTestChapters(examType, subject);
        }

        function loadTestChapters(examType, subject) {
            const chapters = getChaptersForSubject(examType, subject);
            const container = examType === 'jee' ?
                document.getElementById('testChaptersList') :
                document.getElementById('neetTestChaptersList');

            let html = '<div class="chapters-grid">';
            chapters.forEach(chapter => {
                const questions = getQuestionsForChapter(examType, subject, chapter.id);
                html += `
                    <div class="chapter-card">
                        <h4>${chapter.name}</h4>
                        <p>${questions.length} Questions Available</p>
                        <button class="btn btn-primary" onclick="startChapterTest('${examType}', '${subject}', '${chapter.id}', '${chapter.name}')">
                            Start Test
                        </button>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function getChaptersForSubject(examType, subject) {
            // This function is deprecated - chapters are now loaded from API
            // Return empty array as fallback
            console.warn('âš ï¸ getChaptersForSubject is deprecated - use loadChaptersFromAPI instead');
            return [];
        }

        function startChapterTest(examType, subject, chapterId, chapterName) {
            const questions = getQuestionsForChapter(examType, subject, chapterId);

            if (questions.length === 0) {
                showNotification('No questions available for this chapter', 'error');
                return;
            }

            // Create test interface
            const testHtml = `
                <div class="test-interface">
                    <div class="test-header">
                        <h2>Test: ${chapterName}</h2>
                        <button class="test-close-btn" onclick="closeChapterTest()" title="Close Test">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="test-info">
                            <span>Questions: ${questions.length}</span>
                            <span>Time: ${questions.length * 2} minutes</span>
                            <span id="timer">00:00</span>
                        </div>
                    </div>
                    
                    <div class="test-questions" id="testQuestions">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="test-controls">
                        <button class="btn btn-secondary" onclick="endTest()">End Test</button>
                        <button class="btn btn-primary" onclick="submitTest()">Submit Test</button>
                    </div>
                </div>
            `;

            // Note: testSection has been removed - test interface handled differently
            showNotification('Test functionality has been moved to Create Test section', 'info');

            // Load questions into test
            displayTestQuestions(questions);

            // Start timer
            startTestTimer(questions.length * 2 * 60); // 2 minutes per question
        }

        function displayTestQuestions(questions) {
            const container = document.getElementById('testQuestions');
            let html = '';

            questions.forEach((question, index) => {
                html += `
                    <div class="test-question" id="question-${index}">
                        <div class="question-number">Question ${index + 1} of ${questions.length}</div>
                        <div class="question-text">${cleanTextWithLineBreaks(question.text)}</div>
                        
                        ${question.references ? `
                            <div class="question-references" style="margin: 1rem 0; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">
                                    <i class="fas fa-book"></i>
                                    References
                                </div>
                                <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                                    ${cleanTextWithLineBreaks(question.references)}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${question.options && question.options.length > 0 ? `
                            <div class="test-options">
                                ${question.options.map((option, optIndex) => `
                                    <label class="test-option">
                                        <input type="radio" name="question-${index}" value="${cleanText(option)}">
                                        <span>${String.fromCharCode(65 + optIndex)}. ${cleanTextWithLineBreaks(option)}</span>
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="numerical-input">
                                <label>Enter your answer:</label>
                                <input type="text" name="question-${index}" placeholder="Enter numerical answer">
                            </div>
                        `}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function startTestTimer(seconds) {
            const timerElement = document.getElementById('timer');
            let timeLeft = seconds;

            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitTest();
                }

                timeLeft--;
            }, 1000);
        }

        function submitTest() {
            // Collect answers and show results
            showNotification('Test submitted successfully!', 'success');
            // Return to dashboard
            showSection('dashboardSection');
        }

        function endTest() {
            if (confirm('Are you sure you want to end the test?')) {
                showSection('dashboardSection');
            }
        }

        function closeChapterTest() {
            if (confirm('Are you sure you want to close the test? Your progress will be lost.')) {
                // Clear any running timer
                if (window.testTimer) {
                    clearInterval(window.testTimer);
                    window.testTimer = null;
                }
                // Return to the dashboard
                showSection('dashboardSection');
                // Reload the test section to show chapter selection again
                location.reload();
            }
        }

        function goBackToHome() {
            // Navigate back to the dashboard/home section
            showSection('dashboardSection');
        }

        // Performance Section Functions
        async function loadPerformanceData() {
            console.log('ðŸ“Š Loading performance data...');
            
            try {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                console.log('ðŸ” Debug - Token:', token ? 'exists' : 'missing');
                console.log('ðŸ” Debug - User:', user);
                console.log('ðŸ” Debug - User ID:', user._id);
                
                if (!token || !user || !user._id) {
                    console.warn('âš ï¸ User not logged in, showing empty state');
                    document.getElementById('overallScore').textContent = '0%';
                    document.getElementById('testsCompleted').textContent = '0';
                    document.getElementById('accuracy').textContent = '0%';
                    document.getElementById('bestSubject').textContent = 'N/A';
                    
                    document.getElementById('recentTestResults').innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-sign-in-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Please login to view your performance data</p>
                        </div>
                    `;
                    
                    document.getElementById('subjectPerformance').innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-sign-in-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Please login to view performance charts</p>
                        </div>
                    `;
                    return;
                }

                // Fetch test results for current user
                const response = await fetch(`${API_BASE}/api/test-results/user/${user._id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load performance data');
                }

                const results = data.results;
                console.log('âœ… Loaded', results.length, 'test results');

                // Calculate statistics
                const testsCompleted = results.length;
                const avgPercentage = testsCompleted > 0 
                    ? (results.reduce((sum, r) => sum + r.percentage, 0) / testsCompleted).toFixed(1)
                    : 0;
                
                const totalCorrect = results.reduce((sum, r) => sum + r.correct, 0);
                const totalQuestions = results.reduce((sum, r) => sum + r.totalQuestions, 0);
                const accuracy = totalQuestions > 0 
                    ? ((totalCorrect / totalQuestions) * 100).toFixed(1)
                    : 0;

                // Find best subject (placeholder - would need subject data)
                const bestSubject = 'Physics';

                // Update overview cards
                document.getElementById('overallScore').textContent = `${avgPercentage}%`;
                document.getElementById('testsCompleted').textContent = testsCompleted;
                document.getElementById('accuracy').textContent = `${accuracy}%`;
                document.getElementById('bestSubject').textContent = bestSubject;

                // Load recent test results table
                loadRecentTestResults(results);

                // Create performance chart
                createPerformanceChart(results);

            } catch (error) {
                console.error('âŒ Error loading performance data:', error);
                document.getElementById('overallScore').textContent = '0%';
                document.getElementById('testsCompleted').textContent = '0';
                document.getElementById('accuracy').textContent = '0%';
                document.getElementById('bestSubject').textContent = 'N/A';
                
                document.getElementById('recentTestResults').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--error);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Error loading performance data</p>
                    </div>
                `;
            }
        }

        function loadRecentTestResults(results) {
            const container = document.getElementById('recentTestResults');
            if (!container) return;

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No test results yet. Take a test to see your performance!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-100); border-bottom: 2px solid var(--gray-300);">
                                <th style="padding: 0.75rem; text-align: left;">Test Name</th>
                                <th style="padding: 0.75rem; text-align: center;">Type</th>
                                <th style="padding: 0.75rem; text-align: center;">Score</th>
                                <th style="padding: 0.75rem; text-align: center;">Percentage</th>
                                <th style="padding: 0.75rem; text-align: center;">Correct</th>
                                <th style="padding: 0.75rem; text-align: center;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.slice(0, 10).map(result => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 0.75rem;">${result.testTitle}</td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        <span style="background: ${result.testType === 'mock' ? 'var(--primary)' : 'var(--info)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">
                                            ${result.testType}
                                        </span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; font-weight: bold;">${result.totalMarks}/${result.maxMarks}</td>
                                    <td style="padding: 0.75rem; text-align: center; color: ${result.percentage >= 75 ? 'var(--success)' : result.percentage >= 50 ? 'var(--warning)' : 'var(--error)'}; font-weight: bold;">
                                        ${result.percentage.toFixed(1)}%
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; color: var(--success);">${result.correct}/${result.totalQuestions}</td>
                                    <td style="padding: 0.75rem; text-align: center; font-size: 0.85rem;">${new Date(result.timestamp).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createPerformanceChart(results) {
            const container = document.getElementById('subjectPerformance');
            if (!container) return;

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No data available for charts yet</p>
                    </div>
                `;
                return;
            }

            // Create canvas for chart
            container.innerHTML = `
                <canvas id="performanceChart" style="max-height: 400px;"></canvas>
            `;

            // Prepare data for chart - last 10 tests
            const recentTests = results.slice(0, 10).reverse();
            const labels = recentTests.map((r, i) => `Test ${i + 1}`);
            const percentages = recentTests.map(r => r.percentage);
            const correctAnswers = recentTests.map(r => r.correct);

            // Create chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Percentage Score',
                            data: percentages,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Correct Answers',
                            data: correctAnswers,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Performance Trend (Last 10 Tests)'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Correct Answers'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }



        // Admin Panel Functions
        function showAdminTab(tabName) {
            console.log('ðŸ”§ Switching to admin tab:', tabName);

            // Hide all tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const targetContent = document.getElementById(tabName + '-tab');
            if (targetContent) {
                targetContent.classList.add('active');
            }

            // Find the clicked tab by matching the onclick attribute
            document.querySelectorAll('.admin-tab').forEach(tab => {
                const onclick = tab.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                }
            });

            // Load data for specific tab
            switch (tabName) {
                case 'users':
                    loadUserManagement();
                    break;
                case 'questions':
                    loadQuestionManagement();
                    break;
                case 'analytics':
                    loadSystemAnalytics();
                    break;
                case 'settings':
                    loadSystemSettings();
                    break;
            }
        }

        async function loadUserManagement() {
            console.log('ðŸ‘¥ Loading user management data...');

            try {
                // Get the auth token - for admin panel, we'll use admin-token
                const authToken = 'admin-token'; // Force admin token for admin panel access

                console.log('ðŸ”‘ Using auth token:', authToken);

                // Fetch real user data and stats
                const [usersResponse, statsResponse] = await Promise.all([
                    fetch('/api/admin/users', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/admin/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                console.log('ðŸ“¡ API Response Status - Users:', usersResponse.status, 'Stats:', statsResponse.status);

                if (!usersResponse.ok || !statsResponse.ok) {
                    throw new Error(`HTTP error! users: ${usersResponse.status}, stats: ${statsResponse.status}`);
                }

                const usersData = await usersResponse.json();
                const statsData = await statsResponse.json();

                if (usersData.success && statsData.success) {
                    displayRealUsers(usersData.users);
                    updateUserStats(statsData.stats);
                    console.log('âœ… Real user data loaded:', usersData.users.length, 'users');
                    console.log('âœ… Real stats loaded:', statsData.stats);
                } else {
                    throw new Error(usersData.error || statsData.error || 'Failed to fetch data');
                }

            } catch (error) {
                console.error('âŒ Error loading users:', error);
                showNotification('Error loading user data: ' + error.message, 'error');
                // Fallback to static data
                displayFallbackUsers();
            }
        }

        function updateUserStats(stats) {
            // Update the stat cards with real data
            const statCards = document.querySelectorAll('#users-tab .stat-number');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.totalUsers || 0;
                statCards[1].textContent = stats.totalStudents || 0;
                statCards[2].textContent = stats.totalTeachers || 0;
                statCards[3].textContent = stats.totalAdmins || 0;
            }

            console.log('ðŸ“Š Stats updated:', stats);
        }

        function displayRealUsers(users) {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) return;

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No users found in the database.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const html = users.map(user => {
                const roleColors = {
                    'student': 'var(--info)',
                    'teacher': 'var(--success)',
                    'admin': 'var(--error)'
                };

                const createdDate = new Date(user.createdAt).toLocaleDateString();

                return `
                    <tr style="border-bottom: 1px solid var(--gray-100);">
                        <td style="padding: 1rem;">${user.username}</td>
                        <td style="padding: 1rem;">${user.email}</td>
                        <td style="padding: 1rem;">
                            <span style="background: ${roleColors[user.role]}; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; text-transform: capitalize;">
                                ${user.role}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                Active
                            </span>
                        </td>
                        <td style="padding: 1rem;">${createdDate}</td>
                        <td style="padding: 1rem;">
                            <button onclick="editUser('${user._id}', '${user.username}')" 
                                style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer; margin-right: 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${user._id}', '${user.username}')" 
                                style="background: var(--error); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = html;
        }

        function displayFallbackUsers() {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) return;

            // Keep existing static data as fallback
            console.log('ðŸ“‹ Using fallback user data');
        }

        async function loadQuestionManagement() {
            console.log('â“ Loading question management data...');

            try {
                // Fetch real questions and stats
                const [questionsResponse, statsResponse] = await Promise.all([
                    fetch('/api/questions', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/admin/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!questionsResponse.ok || !statsResponse.ok) {
                    throw new Error(`HTTP error! questions: ${questionsResponse.status}, stats: ${statsResponse.status}`);
                }

                const questionsData = await questionsResponse.json();
                const statsData = await statsResponse.json();

                if (questionsData.success && statsData.success) {
                    displayRealQuestions(questionsData.questions);
                    updateQuestionStats(statsData.stats, questionsData.questions);
                    populateAdminChapterFilter(questionsData.questions);
                    console.log('âœ… Real questions loaded:', questionsData.questions.length, 'questions');
                } else {
                    throw new Error(questionsData.error || statsData.error || 'Failed to fetch questions');
                }

            } catch (error) {
                console.error('âŒ Error loading questions:', error);
                showNotification('Error loading questions: ' + error.message, 'error');
                displayFallbackQuestions();
            }
        }

        function displayRealQuestions(questions) {
            // Ensure questions is an array
            if (!questions || !Array.isArray(questions)) {
                questions = [];
            }

            // Store questions data globally for filtering
            allQuestionsData = questions;

            const questionsList = document.getElementById('adminQuestionsList');
            if (!questionsList) return;

            if (questions.length === 0) {
                questionsList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-question-circle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No Questions Found</h3>
                        <p>No questions have been added to the database yet.</p>
                        <button class="btn btn-primary" onclick="showAddQuestionModal()" style="margin-top: 
                `;
                return;
            }

            // Populate chapter filter with unique chapters
            updateChapterFilter(questions);

            // Display all questions using the filtering system
            displayFilteredQuestions(questions);
        }

        function displayRealQuestionsOld(questions) {
            const html = questions.slice(0, 20).map(question => { // Show first 20 questions
                const difficultyColors = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                return `
                    <div style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: uppercase;">
                                        ${question.examType}
                                    </span>
                                    <span style="background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: capitalize;">
                                        ${question.subject}
                                    </span>
                                    <span style="background: ${difficultyColors[question.difficulty]}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: capitalize;">
                                        ${question.difficulty}
                                    </span>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-800);">${question.chapter}</h4>
                                <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem; line-height: 1.4;">
                                    ${question.text.substring(0, 150)}${question.text.length > 150 ? '...' : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="editQuestion('${question._id}')" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteQuestion('${question._id}')" style="background: var(--error); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">
                            Options: ${question.options.length} â€¢ Created: ${new Date(question.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');

            if (questions.length > 20) {
                questionsList.innerHTML = html + `
                    <div style="text-align: center; padding: 1rem; color: var(--gray-500);">
                        <p>Showing first 20 of ${questions.length} questions</p>
                        <button class="btn btn-secondary" onclick="loadAllQuestions()">
                            <i class="fas fa-list"></i>
                            Load All Questions
                        </button>
                    </div>
                `;
            } else {
                questionsList.innerHTML = html;
            }
        }

        function updateQuestionStats(stats, questions) {
            // Update question stats cards
            const statCards = document.querySelectorAll('#questions-tab .stat-number');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.totalQuestions || questions.length || 0;

                // Count by subject (case-insensitive)
                const subjectCounts = questions.reduce((acc, q) => {
                    const subject = q.subject.toLowerCase();
                    acc[subject] = (acc[subject] || 0) + 1;
                    return acc;
                }, {});

                console.log('ðŸ“Š Subject counts:', subjectCounts);

                statCards[1].textContent = subjectCounts.physics || 0;
                statCards[2].textContent = subjectCounts.chemistry || 0;
                statCards[3].textContent = subjectCounts.mathematics || subjectCounts.math || subjectCounts.biology || 0;
            }
        }

        function displayFallbackQuestions() {
            const questionsList = document.getElementById('adminQuestionsList');
            if (questionsList) {
                questionsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>Unable to Load Questions</h3>
                        <p>There was an error loading questions from the database.</p>
                        <button class="btn btn-primary" onclick="loadQuestionManagement()" style="margin-top: 1rem;">
                            <i class="fas fa-refresh"></i>
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function loadSystemAnalytics() {
            console.log('ðŸ“Š Loading system analytics...');
            // This would typically fetch analytics data from the server
        }

        function loadSystemSettings() {
            console.log('âš™ï¸ Loading system settings and mock tests...');
            // Load mock tests when settings tab is opened
            loadMockTestsList();
        }

        function showAddUserModal() {
            console.log('âž• Opening add user modal...');
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('âœ… Add user modal opened');
            } else {
                console.error('âŒ Add user modal not found');
                showNotification('Add user modal not found', 'error');
            }
        }

        function closeAddUserModal() {
            console.log('âŒ Closing add user modal...');
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.style.display = 'none';
                // Clear form fields
                modal.querySelectorAll('input, select').forEach(field => {
                    field.value = '';
                });
                console.log('âœ… Add user modal closed and form cleared');
            }
        }

        async function addUser() {
            const userData = {
                username: document.getElementById('uUsername').value,
                email: document.getElementById('uEmail').value,
                password: document.getElementById('uPassword').value,
                role: document.getElementById('uRole').value
            };

            // Validation
            if (!userData.username || !userData.email || !userData.password || !userData.role) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userData.email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            // Password validation
            if (userData.password.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('User added successfully!', 'success');
                    closeAddUserModal();
                    // Reload user management data
                    loadUserManagement();
                } else {
                    showNotification(data.error || 'Error adding user', 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Network error adding user', 'error');
            }
        }

        // Global variables to store questions data (moved to top of script section)
        // Chapters data structure initialized at top of script section

        // Get questions for a specific chapter from database
        async function getQuestionsForChapterFromDB(examType, subject, chapterId) {
            try {
                console.log(`ðŸ“– Fetching questions for chapter: ${chapterId}`);

                const response = await fetch(`${API_BASE}/api/questions?examType=${examType}&subject=${subject}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.questions) {
                    // For database chapters, chapterId is the MongoDB _id
                    // We need to find the chapter name first, then filter questions by chapter name
                    let chapterQuestions = [];

                    if (chapterId === 'mixed') {
                        // Return all questions for this subject
                        chapterQuestions = data.questions;
                    } else {
                        // Find the chapter name from the chapters API
                        const chapters = await loadChaptersFromAPI(examType, subject);
                        const chapter = chapters.find(ch => ch.id === chapterId);

                        if (chapter && chapter.name) {
                            // Filter questions by chapter name
                            chapterQuestions = data.questions.filter(q =>
                                q.chapter && q.chapter.toLowerCase() === chapter.name.toLowerCase()
                            );
                        }
                    }

                    console.log(`âœ… Found ${chapterQuestions.length} questions for chapter`);
                    return chapterQuestions;
                } else {
                    console.warn('âš ï¸ No questions data received');
                    return [];
                }
            } catch (error) {
                console.error('âŒ Error fetching questions for chapter:', error);
                return [];
            }
        }

        // Get question count for a specific chapter
        async function getQuestionCountForChapter(examType, subject, chapterName) {
            try {
                const response = await fetch(`${API_BASE}/api/questions?examType=${examType}&subject=${subject}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.warn(`âš ï¸ Failed to fetch questions for ${chapterName}`);
                    return 0;
                }

                const data = await response.json();

                if (data.success && data.questions) {
                    // Filter questions by chapter name
                    const chapterQuestions = data.questions.filter(q =>
                        q.chapter && q.chapter.toLowerCase() === chapterName.toLowerCase()
                    );
                    return chapterQuestions.length;
                } else {
                    return 0;
                }
            } catch (error) {
                console.warn(`âš ï¸ Error getting question count for ${chapterName}:`, error);
                return 0;
            }
        }

        // Load chapters from API
        async function loadChaptersFromAPI(examType, subject) {
            try {
                console.log(`ðŸ“š Loading chapters for ${examType} - ${subject} from API...`);

                const response = await fetch(`${API_BASE}/api/chapters?examType=${examType}&subject=${subject}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.chapters) {
                    // Always add "Mixed" option at the beginning
                    const chapters = [
                        { id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' },
                        ...data.chapters.map(chapter => ({
                            id: chapter._id,
                            name: chapter.name,
                            icon: chapter.icon || 'fa-book'
                        }))
                    ];

                    // Update the chaptersData structure - ensure it's initialized
                    if (typeof chaptersData === 'undefined') {
                        chaptersData = { jee: {}, neet: {} };
                    }
                    if (!chaptersData[examType]) {
                        chaptersData[examType] = {};
                    }
                    chaptersData[examType][subject] = chapters;

                    console.log(`âœ… Loaded ${data.chapters.length} chapters for ${examType} - ${subject}`);
                    return chapters;
                } else {
                    console.error('âŒ Failed to load chapters:', data.error || 'Unknown error');
                    return [{ id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' }];
                }
            } catch (error) {
                console.error('âŒ Error loading chapters from API:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('âš ï¸ Server not accessible - using fallback chapters');
                    showNotification('âš ï¸ Using offline mode - server not accessible', 'warning');
                }
                // Return fallback mixed option
                return [{ id: 'mixed', name: 'Mixed (All Chapters)', icon: 'fa-layer-group' }];
            }
        }

        // Load real questions from database
        async function loadRealQuestions() {
            // Prevent multiple simultaneous loads
            if (isLoadingRealQuestions) {
                console.log('â³ Already loading real questions, waiting...');
                // Wait for the current load to complete
                while (isLoadingRealQuestions) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                return realQuestionsData;
            }

            // If already loaded, return existing data
            if (realQuestionsData && realQuestionsData.length > 0) {
                console.log('âœ… Real questions already loaded, using cached data');
                return realQuestionsData;
            }

            isLoadingRealQuestions = true;

            try {
                console.log('ðŸ“š Loading real questions from database...');
                const response = await fetch('/api/questions', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success && data.questions) {
                    realQuestionsData = data.questions;
                    console.log(`âœ… Loaded ${realQuestionsData.length} real questions from database`);

                    // Log the questions for debugging (limit to first 5 to avoid spam)
                    const sampleQuestions = realQuestionsData.slice(0, 5);
                    sampleQuestions.forEach((q, i) => {
                        console.log(`${i + 1}. ${q.subject} - ${q.chapter} (${q.difficulty})`);
                    });
                    if (realQuestionsData.length > 5) {
                        console.log(`... and ${realQuestionsData.length - 5} more questions`);
                    }

                    return realQuestionsData;
                } else {
                    throw new Error(data.error || 'Failed to load questions');
                }
            } catch (error) {
                console.error('âŒ Error loading real questions:', error);
                showNotification('Error loading questions from database', 'error');
                // Initialize as empty array to prevent further errors
                realQuestionsData = [];
                return [];
            } finally {
                isLoadingRealQuestions = false;
            }
        }

        // Question filtering functions
        function filterAdminQuestions() {
            const subjectFilter = document.getElementById('adminSubjectFilter').value.toLowerCase();
            const difficultyFilter = document.getElementById('adminDifficultyFilter').value.toLowerCase();
            const chapterFilter = document.getElementById('adminChapterFilter').value.toLowerCase();
            const searchFilter = document.getElementById('adminSearchFilter').value.toLowerCase();

            console.log('ðŸ” Filtering questions:', { subjectFilter, difficultyFilter, chapterFilter, searchFilter });

            // Safety check to ensure allQuestionsData is initialized
            if (!allQuestionsData || !Array.isArray(allQuestionsData)) {
                console.warn('âš ï¸ allQuestionsData not initialized yet, skipping filter');
                return;
            }

            let filteredQuestions = allQuestionsData.filter(question => {
                const matchesSubject = !subjectFilter || question.subject.toLowerCase().includes(subjectFilter);
                const matchesDifficulty = !difficultyFilter || question.difficulty.toLowerCase() === difficultyFilter;
                const matchesChapter = !chapterFilter || question.chapter.toLowerCase().includes(chapterFilter);
                const matchesSearch = !searchFilter ||
                    question.text.toLowerCase().includes(searchFilter) ||
                    question.chapter.toLowerCase().includes(searchFilter) ||
                    question.subject.toLowerCase().includes(searchFilter);

                return matchesSubject && matchesDifficulty && matchesChapter && matchesSearch;
            });

            console.log(`ðŸ“Š Filtered ${filteredQuestions.length} questions from ${allQuestionsData.length} total`);
            displayFilteredQuestions(filteredQuestions);
            updateChapterFilter(filteredQuestions);
        }

        function displayFilteredQuestions(questions) {
            const questionsList = document.getElementById('adminQuestionsList');
            if (!questionsList) return;

            if (questions.length === 0) {
                questionsList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No Questions Found</h3>
                        <p>No questions match the current filters.</p>
                        <button class="btn btn-secondary" onclick="clearAdminFilters()" style="margin-top: 1rem;">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                `;
                return;
            }

            const html = questions.map(question => {
                const difficultyColors = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                return `
                    <div style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <span style="background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.subject}</span>
                                    <span style="background: rgba(245, 158, 11, 0.1); color: ${difficultyColors[question.difficulty]}; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.difficulty}</span>
                                    <span style="background: rgba(59, 130, 246, 0.1); color: var(--info); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">${question.chapter}</span>
                                    ${question.examType ? `<span style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">${question.examType}</span>` : ''}
                                    ${question.tags && question.tags.length > 0 ? question.tags.map(tag => `<span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500;">#${tag}</span>`).join('') : ''}
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-800);">${question.chapter}</h4>
                                <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem; line-height: 1.4;">
                                    ${question.text.substring(0, 150)}${question.text.length > 150 ? '...' : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="editQuestion('${question._id}')" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;" title="Edit Question">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="viewQuestion('${question._id}')" style="background: var(--info); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;" title="View Question">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteQuestion('${question._id}')" style="background: var(--error); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;" title="Delete Question">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">
                            Options: ${question.options.length} â€¢ Created: ${new Date(question.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');

            questionsList.innerHTML = html;

            // Render MathJax for LaTeX expressions
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([questionsList]).catch((err) => {
                    console.log('MathJax rendering error:', err);
                });
            }
        }

        function updateChapterFilter(questions) {
            const chapterFilter = document.getElementById('adminChapterFilter');
            if (!chapterFilter) return;

            // Get unique chapters from filtered questions
            const chapters = [...new Set(questions.map(q => q.chapter))].sort();

            // Keep current selection
            const currentValue = chapterFilter.value;

            // Update options
            chapterFilter.innerHTML = '<option value="">All Chapters</option>' +
                chapters.map(chapter => `<option value="${chapter}" ${chapter === currentValue ? 'selected' : ''}>${chapter}</option>`).join('');
        }

        function clearAdminFilters() {
            document.getElementById('adminSubjectFilter').value = '';
            document.getElementById('adminDifficultyFilter').value = '';
            document.getElementById('adminChapterFilter').value = '';
            document.getElementById('adminSearchFilter').value = '';

            console.log('ðŸ§¹ Filters cleared');
            filterAdminQuestions();
        }

        // Edit Question Functions
        async function editQuestion(questionId) {
            console.log('âœï¸ Editing question:', questionId);

            try {
                // Find the question in our stored data
                if (!allQuestionsData || !Array.isArray(allQuestionsData)) {
                    showNotification('Questions data not loaded yet', 'error');
                    return;
                }
                const question = allQuestionsData.find(q => q._id === questionId);
                if (!question) {
                    showNotification('Question not found', 'error');
                    return;
                }

                // Populate the edit form
                document.getElementById('editQuestionId').value = questionId;
                document.getElementById('editQExamType').value = question.examType;
                document.getElementById('editQSubject').value = question.subject;
                document.getElementById('editQClass').value = question.class;
                document.getElementById('editQDifficulty').value = question.difficulty;
                document.getElementById('editQChapter').value = question.chapter;
                document.getElementById('editQText').value = question.text;
                document.getElementById('editQOptionA').value = question.options[0] || '';
                document.getElementById('editQOptionB').value = question.options[1] || '';
                document.getElementById('editQOptionC').value = question.options[2] || '';
                document.getElementById('editQOptionD').value = question.options[3] || '';
                document.getElementById('editQAnswer').value = question.answer;
                document.getElementById('editQSolution').value = question.solution;
                document.getElementById('editQExplanation').value = question.explanation || '';

                // Show the modal and initialize
                document.getElementById('editQuestionModal').style.display = 'flex';
                showEditTab('basic'); // Start with basic tab
                updatePreview(); // Generate initial preview
                
                // Show keyboard shortcuts notification
                setTimeout(() => {
                    showNotification('ðŸ’¡ Tip: Use Ctrl+S to save, Ctrl+P to refresh preview, Ctrl+1/2/3 to switch tabs', 'info');
                }, 1000);
                
                // Check for drafts after a short delay
                setTimeout(() => {
                    loadDraft();
                }, 1500);

            } catch (error) {
                console.error('Error loading question for edit:', error);
                showNotification('Error loading question', 'error');
            }
        }

        // Tab switching for edit modal
        function showEditTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.edit-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.edit-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`edit-${tabName}-tab`).style.display = 'block';
            
            // Add active class to selected tab
            document.querySelector(`.edit-tab[data-tab="${tabName}"]`).classList.add('active');
        }

        // Update preview function
        function updatePreview() {
            const questionText = document.getElementById('editQText').value;
            const optionA = document.getElementById('editQOptionA').value;
            const optionB = document.getElementById('editQOptionB').value;
            const optionC = document.getElementById('editQOptionC').value;
            const optionD = document.getElementById('editQOptionD').value;
            const correctAnswer = document.getElementById('editQAnswer').value;
            const solution = document.getElementById('editQSolution').value;
            const explanation = document.getElementById('editQExplanation').value;
            const subject = document.getElementById('editQSubject').value;
            const difficulty = document.getElementById('editQDifficulty').value;
            const chapter = document.getElementById('editQChapter').value;
            const classLevel = document.getElementById('editQClass').value;

            const previewContainer = document.getElementById('questionPreview');
            
            if (!questionText && !optionA && !optionB && !optionC && !optionD) {
                previewContainer.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                        <i class="fas fa-eye" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Question preview will appear here as you edit</p>
                    </div>
                `;
                return;
            }

            const difficultyClass = difficulty ? `difficulty-${difficulty}` : '';
            const subjectCapitalized = subject.charAt(0).toUpperCase() + subject.slice(1);

            previewContainer.innerHTML = `
                <div class="preview-question-card">
                    <div class="preview-question-header">
                        <div class="preview-question-meta">
                            ${subject ? `<span class="preview-meta-tag subject">${subjectCapitalized}</span>` : ''}
                            ${difficulty ? `<span class="preview-meta-tag ${difficultyClass}">${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</span>` : ''}
                            ${classLevel ? `<span class="preview-meta-tag">Class ${classLevel}</span>` : ''}
                            ${chapter ? `<span class="preview-meta-tag">${chapter}</span>` : ''}
                        </div>
                    </div>
                    
                    ${questionText ? `
                        <div class="preview-question-text">
                            <div id="preview-question-math">${questionText}</div>
                        </div>
                    ` : ''}
                    
                    ${(optionA || optionB || optionC || optionD) ? `
                        <div class="preview-options">
                            ${optionA ? `
                                <div class="preview-option ${correctAnswer === 'A' ? 'correct' : ''}">
                                    <div class="preview-option-label">A</div>
                                    <div class="preview-option-text">
                                        <div id="preview-option-a-math">${optionA}</div>
                                    </div>
                                </div>
                            ` : ''}
                            ${optionB ? `
                                <div class="preview-option ${correctAnswer === 'B' ? 'correct' : ''}">
                                    <div class="preview-option-label">B</div>
                                    <div class="preview-option-text">
                                        <div id="preview-option-b-math">${optionB}</div>
                                    </div>
                                </div>
                            ` : ''}
                            ${optionC ? `
                                <div class="preview-option ${correctAnswer === 'C' ? 'correct' : ''}">
                                    <div class="preview-option-label">C</div>
                                    <div class="preview-option-text">
                                        <div id="preview-option-c-math">${optionC}</div>
                                    </div>
                                </div>
                            ` : ''}
                            ${optionD ? `
                                <div class="preview-option ${correctAnswer === 'D' ? 'correct' : ''}">
                                    <div class="preview-option-label">D</div>
                                    <div class="preview-option-text">
                                        <div id="preview-option-d-math">${optionD}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${solution ? `
                        <div class="preview-solution">
                            <div class="preview-solution-header">
                                <i class="fas fa-lightbulb"></i>
                                Solution
                            </div>
                            <div class="preview-solution-text">
                                <div id="preview-solution-math">${solution}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${explanation ? `
                        <div class="preview-solution" style="margin-top: 0.5rem; border-left-color: var(--info);">
                            <div class="preview-solution-header" style="color: var(--info);">
                                <i class="fas fa-comment"></i>
                                Additional Explanation
                            </div>
                            <div class="preview-solution-text">
                                <div id="preview-explanation-math">${explanation}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Render MathJax for the preview
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([previewContainer]).catch((err) => {
                        console.log('MathJax typeset error:', err);
                    });
                }
            }, 100);
        }

        // Refresh preview function
        function refreshPreview() {
            updatePreview();
            showNotification('Preview refreshed!', 'success');
        }

        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').style.display = 'none';
            clearDraft(); // Clear any saved draft when closing
        }

        async function updateQuestion() {
            const questionId = document.getElementById('editQuestionId').value;
            const questionData = {
                examType: document.getElementById('editQExamType').value,
                subject: document.getElementById('editQSubject').value,
                class: document.getElementById('editQClass').value,
                chapter: document.getElementById('editQChapter').value,
                difficulty: document.getElementById('editQDifficulty').value,
                question: {
                    text: document.getElementById('editQText').value,
                    options: [
                        document.getElementById('editQOptionA').value,
                        document.getElementById('editQOptionB').value,
                        document.getElementById('editQOptionC').value,
                        document.getElementById('editQOptionD').value
                    ],
                    answer: document.getElementById('editQAnswer').value,
                    solution: document.getElementById('editQSolution').value,
                    explanation: document.getElementById('editQExplanation').value
                }
            };

            if (!questionData.question.text || !questionData.chapter) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/questions/${questionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify(questionData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Question updated successfully!', 'success');
                    clearDraft(); // Clear draft on successful save
                    closeEditQuestionModal();
                    loadQuestionManagement(); // Reload questions
                } else {
                    showNotification(data.error || 'Error updating question', 'error');
                }
            } catch (error) {
                console.error('Error updating question:', error);
                showNotification('Network error updating question', 'error');
            }
        }

        // View Question Functions
        async function viewQuestion(questionId) {
            console.log('ðŸ‘ï¸ Viewing question:', questionId);

            try {
                if (!allQuestionsData || !Array.isArray(allQuestionsData)) {
                    showNotification('Questions data not loaded yet', 'error');
                    return;
                }
                const question = allQuestionsData.find(q => q._id === questionId);
                if (!question) {
                    showNotification('Question not found', 'error');
                    return;
                }

                const content = `
                    <div style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">${question.examType.toUpperCase()}</span>
                            <span style="background: var(--secondary); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">${question.subject}</span>
                            <span style="background: var(--info); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">Class ${question.class}</span>
                            <span style="background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">${question.difficulty}</span>
                            ${question.enhanced ? '<span style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;"><i class="fas fa-star"></i> Enhanced</span>' : ''}
                        </div>
                        
                        ${question.tags && question.tags.length > 0 ? `
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <span style="color: var(--gray-600); font-size: 0.8rem; margin-right: 0.5rem;">Tags:</span>
                                ${question.tags.map(tag => `<span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <h3 style="color: var(--gray-800); margin-bottom: 0.5rem;">${question.chapter}</h3>
                        
                        <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--gray-700);">Question:</h4>
                            <p style="line-height: 1.6; color: var(--gray-800);">${preserveLineBreaks(question.text)}</p>
                        </div>

                        <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--gray-700);">Options:</h4>
                            ${question.options.map((option, index) => {
                    const letter = String.fromCharCode(65 + index);
                    const isCorrect = question.answer === letter;
                    return `
                                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: ${isCorrect ? 'var(--success)' : 'white'}; color: ${isCorrect ? 'white' : 'var(--gray-800)'}; border-radius: var(--radius-md); border: 1px solid ${isCorrect ? 'var(--success)' : 'var(--gray-200)'};">
                                        <strong>${letter}.</strong> ${preserveLineBreaks(option)} ${isCorrect ? 'âœ“' : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>

                        <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--gray-700);">Solution:</h4>
                            <p style="line-height: 1.6; color: var(--gray-800);">${preserveLineBreaks(question.solution)}</p>
                            ${question.explanation ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                    <h5 style="margin-bottom: 0.5rem; color: var(--gray-700);">Additional Explanation:</h5>
                                    <p style="line-height: 1.6; color: var(--gray-600);">${preserveLineBreaks(question.explanation)}</p>
                                </div>
                            ` : ''}
                        </div>

                        ${question.hints ? `
                            <div style="background: rgba(59, 130, 246, 0.05); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem; border-left: 4px solid var(--info);">
                                <h4 style="margin-bottom: 1rem; color: var(--info); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-lightbulb"></i> Hints
                                </h4>
                                <p style="line-height: 1.6; color: var(--gray-700);">${preserveLineBreaks(question.hints)}</p>
                            </div>
                        ` : ''}

                        ${question.references ? `
                            <div style="background: rgba(16, 185, 129, 0.05); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem; border-left: 4px solid var(--success);">
                                <h4 style="margin-bottom: 1rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-book"></i> References
                                </h4>
                                <p style="line-height: 1.6; color: var(--gray-700);">${preserveLineBreaks(question.references)}</p>
                            </div>
                        ` : ''}

                        <div style="font-size: 0.9rem; color: var(--gray-500); text-align: center;">
                            Created: ${new Date(question.createdAt).toLocaleString()}
                        </div>
                    </div>
                `;

                document.getElementById('viewQuestionContent').innerHTML = content;
                document.getElementById('viewQuestionModal').style.display = 'flex';

            } catch (error) {
                console.error('Error viewing question:', error);
                showNotification('Error loading question', 'error');
            }
        }

        function closeViewQuestionModal() {
            document.getElementById('viewQuestionModal').style.display = 'none';
        }

        // Delete Question Function
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/questions/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Question deleted successfully!', 'success');
                    loadQuestionManagement(); // Reload questions
                } else {
                    showNotification(data.error || 'Error deleting question', 'error');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showNotification('Network error deleting question', 'error');
            }
        }

        // Image Management Functions
        function addImageToQuestion(fieldId) {
            showNotification('Image upload functionality - Select an image file', 'info');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                handleImageUpload(e.target.files[0], fieldId);
            };
            input.click();
        }

        function addImageToOption(fieldId) {
            showNotification('Image upload functionality - Select an image file', 'info');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                handleImageUpload(e.target.files[0], fieldId);
            };
            input.click();
        }

        function addImageToSolution(fieldId) {
            showNotification('Image upload functionality - Select an image file', 'info');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                handleImageUpload(e.target.files[0], fieldId);
            };
            input.click();
        }

        function handleImageUpload(file, fieldId) {
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image size must be less than 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const imageData = e.target.result;
                const field = document.getElementById(fieldId);
                if (field) {
                    // Add image reference to the text
                    const imageRef = `[IMAGE:${file.name}]`;
                    field.value += (field.value ? ' ' : '') + imageRef;
                    showNotification(`Image "${file.name}" added to ${fieldId}`, 'success');
                }
            };
            reader.readAsDataURL(file);
        }



        function editUser(username) {
            showNotification(`Edit user: ${username}`, 'info');
        }

        async function deleteUser(userId, username) {
            if (confirm(`Are you sure you want to delete user: ${username}? This action cannot be undone.`)) {
                try {
                    console.log('ðŸ—‘ï¸ Deleting user:', username);

                    const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        showNotification(`âœ… User ${username} deleted successfully`, 'success');
                        // Reload user data
                        loadUserManagement();
                    } else {
                        throw new Error(data.error || 'Failed to delete user');
                    }

                } catch (error) {
                    console.error('âŒ Error deleting user:', error);
                    showNotification(`âŒ Error deleting user: ${error.message}`, 'error');
                }
            }
        }

        function editUser(userId, username) {
            showNotification(`Edit functionality for ${username} coming soon!`, 'info');
            console.log('âœï¸ Edit user:', userId, username);
        }

        async function filterAdminQuestions() {
            const subject = document.getElementById('adminSubjectFilter').value;
            const difficulty = document.getElementById('adminDifficultyFilter').value;
            const chapter = document.getElementById('adminChapterFilter').value;
            const searchText = document.getElementById('adminSearchFilter').value;

            console.log('ðŸ” Filtering questions:', { subject, difficulty, chapter, searchText });

            // Add loading state
            const filtersContainer = document.querySelector('.question-filters');
            filtersContainer.classList.add('loading');

            // Count active filters
            const activeFilters = [subject, difficulty, chapter, searchText].filter(f => f && f.trim()).length;
            updateFilterCount(activeFilters);

            try {
                // Get all questions first
                const response = await fetch('/api/questions', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    let filteredQuestions = data.questions;

                    // Apply filters
                    if (subject) {
                        filteredQuestions = filteredQuestions.filter(q => 
                            q.subject && q.subject.toLowerCase() === subject.toLowerCase()
                        );
                    }

                    if (difficulty) {
                        filteredQuestions = filteredQuestions.filter(q => 
                            q.difficulty && q.difficulty.toLowerCase() === difficulty.toLowerCase()
                        );
                    }

                    if (chapter) {
                        filteredQuestions = filteredQuestions.filter(q => 
                            q.chapter && q.chapter.toLowerCase().includes(chapter.toLowerCase())
                        );
                    }

                    if (searchText) {
                        const searchLower = searchText.toLowerCase();
                        filteredQuestions = filteredQuestions.filter(q => 
                            (q.text && q.text.toLowerCase().includes(searchLower)) ||
                            (q.chapter && q.chapter.toLowerCase().includes(searchLower)) ||
                            (q.subject && q.subject.toLowerCase().includes(searchLower)) ||
                            (q.options && q.options.some(opt => opt.toLowerCase().includes(searchLower)))
                        );
                    }

                    displayRealQuestions(filteredQuestions);
                    
                    // Enhanced notification with filter info
                    const filterInfo = [];
                    if (subject) filterInfo.push(`Subject: ${subject}`);
                    if (difficulty) filterInfo.push(`Difficulty: ${difficulty}`);
                    if (chapter) filterInfo.push(`Chapter: ${chapter}`);
                    if (searchText) filterInfo.push(`Search: "${searchText}"`);
                    
                    const message = activeFilters > 0 
                        ? `Found ${filteredQuestions.length} questions (${filterInfo.join(', ')})`
                        : `Showing all ${filteredQuestions.length} questions`;
                    
                    showNotification(message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to filter questions');
                }

            } catch (error) {
                console.error('âŒ Error filtering questions:', error);
                showNotification('Error filtering questions: ' + error.message, 'error');
            } finally {
                // Remove loading state
                filtersContainer.classList.remove('loading');
            }
        }

        // Helper function to update filter count badge
        function updateFilterCount(count) {
            const clearButton = document.querySelector('.question-filters .btn-secondary');
            let badge = clearButton.querySelector('.filter-count');
            
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'filter-count';
                    clearButton.style.position = 'relative';
                    clearButton.appendChild(badge);
                }
                badge.textContent = count;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }

        // Debounced filter function for better performance
        let filterTimeout;
        function debouncedFilterQuestions() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                filterAdminQuestions();
            }, 300);
        }

        function clearAdminFilters() {
            // Add visual feedback
            const filtersContainer = document.querySelector('.question-filters');
            filtersContainer.style.transform = 'scale(0.98)';
            
            setTimeout(() => {
                document.getElementById('adminSubjectFilter').value = '';
                document.getElementById('adminDifficultyFilter').value = '';
                document.getElementById('adminChapterFilter').value = '';
                document.getElementById('adminSearchFilter').value = '';
                
                // Update filter count
                updateFilterCount(0);
                
                // Reset visual state
                filtersContainer.style.transform = 'scale(1)';
                
                // Reload all questions
                filterAdminQuestions();
                
                showNotification('All filters cleared', 'info');
            }, 150);
            loadQuestionManagement();
            showNotification('Filters cleared', 'info');
        }

        function populateAdminChapterFilter(questions) {
            const chapterFilter = document.getElementById('adminChapterFilter');
            if (!chapterFilter) return;

            // Safety check for questions parameter
            if (!questions || !Array.isArray(questions)) {
                console.warn('âš ï¸ populateAdminChapterFilter called without valid questions array');
                chapterFilter.innerHTML = '<option value="">All Chapters</option>';
                return;
            }

            // Get unique chapters from questions
            const chapters = [...new Set(questions.map(q => q.chapter).filter(chapter => chapter))].sort();

            // Keep current selection
            const currentValue = chapterFilter.value;

            // Update options
            chapterFilter.innerHTML = '<option value="">All Chapters</option>' +
                chapters.map(chapter => `<option value="${chapter}" ${chapter === currentValue ? 'selected' : ''}>${chapter}</option>`).join('');
        }

        async function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                try {
                    console.log('ðŸ—‘ï¸ Deleting question:', questionId);

                    const response = await fetch(`${API_BASE}/api/questions/${questionId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        showNotification('âœ… Question deleted successfully', 'success');
                        // Reload questions
                        loadQuestionManagement();
                    } else {
                        throw new Error(data.error || 'Failed to delete question');
                    }

                } catch (error) {
                    console.error('âŒ Error deleting question:', error);
                    showNotification('âŒ Error deleting question: ' + error.message, 'error');
                }
            }
        }

        async function loadAllQuestions() {
            console.log('ðŸ“š Loading all questions...');

            try {
                const response = await fetch('/api/questions', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayAllQuestions(data.questions);
                    showNotification(`Loaded all ${data.questions.length} questions`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load all questions');
                }

            } catch (error) {
                console.error('âŒ Error loading all questions:', error);
                showNotification('Error loading questions: ' + error.message, 'error');
            }
        }

        function displayAllQuestions(questions) {
            const questionsList = document.getElementById('adminQuestionsList');
            if (!questionsList) return;

            if (questions.length === 0) {
                displayRealQuestions(questions);
                return;
            }

            // Display all questions without limit
            const html = questions.map(question => {
                const difficultyColors = {
                    'easy': 'var(--success)',
                    'medium': 'var(--warning)',
                    'hard': 'var(--error)'
                };

                return `
                    <div style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: uppercase;">
                                        ${question.examType}
                                    </span>
                                    <span style="background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: capitalize;">
                                        ${question.subject}
                                    </span>
                                    <span style="background: ${difficultyColors[question.difficulty]}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; text-transform: capitalize;">
                                        ${question.difficulty}
                                    </span>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-800);">${question.chapter}</h4>
                                <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem; line-height: 1.4;">
                                    ${question.text.substring(0, 200)}${question.text.length > 200 ? '...' : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="editQuestion('${question._id}')" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteQuestion('${question._id}')" style="background: var(--error); color: white; border: none; padding: 0.5rem; border-radius: var(--radius-md); cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">
                            Options: ${question.options.length} â€¢ Created: ${new Date(question.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');

            questionsList.innerHTML = html + `
                <div style="text-align: center; padding: 1rem; color: var(--gray-600); border-top: 1px solid var(--gray-200); margin-top: 1rem;">
                    <p><strong>Showing all ${questions.length} questions</strong></p>
                </div>
            `;
        }

        // Settings Management Functions
        function saveSettings() {
            try {
                console.log('ðŸ’¾ Saving system settings...');

                // Show loading state
                const saveBtn = document.querySelector('button[onclick="saveSettings()"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                // Get all settings values
                const settings = {
                    siteName: document.getElementById('siteName')?.value || 'EduSphere Pro',
                    testDurationDefault: document.getElementById('testDurationDefault')?.value || 60,
                    questionsPerTest: document.getElementById('questionsPerTest')?.value || 30,
                    smtpServer: document.getElementById('smtpServer')?.value || 'smtp.gmail.com',
                    smtpPort: document.getElementById('smtpPort')?.value || 587,
                    fromEmail: document.getElementById('fromEmail')?.value || 'noreply@edusphere.com',
                    twoFactorAuth: document.querySelector('input[type="checkbox"]:nth-of-type(1)')?.checked || false,
                    passwordReset: document.querySelector('input[type="checkbox"]:nth-of-type(2)')?.checked || false,
                    ipWhitelisting: document.querySelector('input[type="checkbox"]:nth-of-type(3)')?.checked || false,
                    backupFrequency: document.querySelector('select')?.value || 'weekly'
                };

                // Save to localStorage (in a real app, this would go to the server)
                localStorage.setItem('systemSettings', JSON.stringify(settings));

                console.log('âœ… Settings saved:', settings);

                // Simulate save delay for better UX
                setTimeout(() => {
                    // Restore button state
                    const saveBtn = document.querySelector('button[onclick="saveSettings()"]');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
                        saveBtn.disabled = false;
                    }

                    showNotification('âœ… Settings saved successfully!', 'success');

                    // Update page title if site name changed
                    if (settings.siteName) {
                        document.title = `${settings.siteName} | Next-Gen JEE/NEET Platform`;
                    }
                }, 1000);

            } catch (error) {
                console.error('âŒ Error saving settings:', error);

                // Restore button state on error
                const saveBtn = document.querySelector('button[onclick="saveSettings()"]');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
                    saveBtn.disabled = false;
                }

                showNotification('âŒ Error saving settings!', 'error');
            }
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                try {
                    console.log('ðŸ”„ Resetting settings to defaults...');

                    // Default settings
                    const defaultSettings = {
                        siteName: 'EduSphere Pro',
                        testDurationDefault: 60,
                        questionsPerTest: 30,
                        smtpServer: 'smtp.gmail.com',
                        smtpPort: 587,
                        fromEmail: 'noreply@edusphere.com',
                        twoFactorAuth: true,
                        passwordReset: true,
                        ipWhitelisting: false,
                        backupFrequency: 'weekly'
                    };

                    // Update form fields
                    if (document.getElementById('siteName')) document.getElementById('siteName').value = defaultSettings.siteName;
                    if (document.getElementById('testDurationDefault')) document.getElementById('testDurationDefault').value = defaultSettings.testDurationDefault;
                    if (document.getElementById('questionsPerTest')) document.getElementById('questionsPerTest').value = defaultSettings.questionsPerTest;
                    if (document.getElementById('smtpServer')) document.getElementById('smtpServer').value = defaultSettings.smtpServer;
                    if (document.getElementById('smtpPort')) document.getElementById('smtpPort').value = defaultSettings.smtpPort;
                    if (document.getElementById('fromEmail')) document.getElementById('fromEmail').value = defaultSettings.fromEmail;

                    // Update checkboxes
                    const checkboxes = document.querySelectorAll('#settings-tab input[type="checkbox"]');
                    if (checkboxes[0]) checkboxes[0].checked = defaultSettings.twoFactorAuth;
                    if (checkboxes[1]) checkboxes[1].checked = defaultSettings.passwordReset;
                    if (checkboxes[2]) checkboxes[2].checked = defaultSettings.ipWhitelisting;

                    // Update select
                    const backupSelect = document.querySelector('#settings-tab select');
                    if (backupSelect) backupSelect.value = defaultSettings.backupFrequency;

                    // Save defaults to localStorage
                    localStorage.setItem('systemSettings', JSON.stringify(defaultSettings));

                    // Reset page title
                    document.title = `${defaultSettings.siteName} | Next-Gen JEE/NEET Platform`;

                    console.log('âœ… Settings reset to defaults');
                    showNotification('ðŸ”„ Settings reset to defaults successfully!', 'success');

                } catch (error) {
                    console.error('âŒ Error resetting settings:', error);
                    showNotification('âŒ Error resetting settings!', 'error');
                }
            }
        }

        function loadSystemSettings() {
            try {
                console.log('ðŸ“– Loading system settings and mock tests...');

                // Load mock tests when settings tab is opened
                loadMockTestsList();

                // Load settings from localStorage
                const savedSettings = localStorage.getItem('systemSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // Update form fields with saved values
                    if (document.getElementById('siteName')) document.getElementById('siteName').value = settings.siteName || 'EduSphere Pro';
                    if (document.getElementById('testDurationDefault')) document.getElementById('testDurationDefault').value = settings.testDurationDefault || 60;
                    if (document.getElementById('questionsPerTest')) document.getElementById('questionsPerTest').value = settings.questionsPerTest || 30;
                    if (document.getElementById('smtpServer')) document.getElementById('smtpServer').value = settings.smtpServer || 'smtp.gmail.com';
                    if (document.getElementById('smtpPort')) document.getElementById('smtpPort').value = settings.smtpPort || 587;
                    if (document.getElementById('fromEmail')) document.getElementById('fromEmail').value = settings.fromEmail || 'noreply@edusphere.com';

                    // Update checkboxes
                    const checkboxes = document.querySelectorAll('#settings-tab input[type="checkbox"]');
                    if (checkboxes[0]) checkboxes[0].checked = settings.twoFactorAuth !== false;
                    if (checkboxes[1]) checkboxes[1].checked = settings.passwordReset !== false;
                    if (checkboxes[2]) checkboxes[2].checked = settings.ipWhitelisting === true;

                    // Update select
                    const backupSelect = document.querySelector('#settings-tab select');
                    if (backupSelect) backupSelect.value = settings.backupFrequency || 'weekly';

                    console.log('âœ… Settings loaded:', settings);
                } else {
                    console.log('â„¹ï¸ No saved settings found, using defaults');
                }

            } catch (error) {
                console.error('âŒ Error loading settings:', error);
                showNotification('âš ï¸ Error loading settings, using defaults', 'warning');
            }
        }

        // ========================================
        // MOCK TEST CREATION FUNCTIONS
        // ========================================

        // Update third subject label based on exam type
        document.addEventListener('DOMContentLoaded', function() {
            const mockTestExam = document.getElementById('mockTestExam');
            if (mockTestExam) {
                mockTestExam.addEventListener('change', function() {
                    const thirdSubjectLabel = document.getElementById('thirdSubjectLabel');
                    if (this.value === 'neet') {
                        thirdSubjectLabel.innerHTML = '<i class="fas fa-dna" style="color: #ef4444;"></i> Biology';
                    } else {
                        thirdSubjectLabel.innerHTML = '<i class="fas fa-square-root-alt" style="color: #f59e0b;"></i> Mathematics';
                    }
                });
            }

            // Update total questions count
            const questionInputs = document.querySelectorAll('#mockSubjectQuestions input[type="number"]');
            questionInputs.forEach(input => {
                input.addEventListener('input', updateTotalMockQuestions);
            });
        });

        function updateTotalMockQuestions() {
            const inputs = document.querySelectorAll('#mockSubjectQuestions input[type="number"]');
            let total = 0;
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById('totalMockQuestions').textContent = total;
        }

        function createMockTest() {
            try {
                console.log('ðŸ“ Creating mock test...');

                // Get form values
                const testName = document.getElementById('mockTestName').value.trim();
                const examType = document.getElementById('mockTestExam').value;
                const duration = parseInt(document.getElementById('mockTestDuration').value);
                const description = document.getElementById('mockTestDescription').value.trim();
                const marksPerQuestion = parseInt(document.getElementById('mockTestMarksPerQuestion').value);
                const negativeMarking = document.getElementById('mockTestNegativeMarking').checked;

                // Validate required fields
                if (!testName) {
                    showNotification('âŒ Please enter a test name', 'error');
                    return;
                }
                if (!examType) {
                    showNotification('âŒ Please select an exam type', 'error');
                    return;
                }
                if (!duration || duration < 30) {
                    showNotification('âŒ Please enter a valid duration (minimum 30 minutes)', 'error');
                    return;
                }
                if (!marksPerQuestion || marksPerQuestion < 1) {
                    showNotification('âŒ Please enter valid marks per question (minimum 1)', 'error');
                    return;
                }

                // Get selected question IDs
                const selectedQuestionIds = JSON.parse(document.getElementById('selectedQuestionIds').value || '[]');

                if (selectedQuestionIds.length === 0) {
                    showNotification('âŒ Please select at least one question', 'error');
                    return;
                }

                // Calculate negative marks (25% of marks per question)
                const negativeMarks = negativeMarking ? -(marksPerQuestion * 0.25) : 0;

                // Create mock test object
                const mockTest = {
                    name: testName,
                    examType: examType,
                    duration: duration,
                    description: description,
                    questionIds: selectedQuestionIds,
                    totalQuestions: selectedQuestionIds.length,
                    marksPerQuestion: marksPerQuestion,
                    negativeMarking: negativeMarking,
                    negativeMarks: negativeMarks,
                    totalMarks: selectedQuestionIds.length * marksPerQuestion,
                    createdBy: currentUser?.username || 'admin',
                    isPublic: true,
                    status: 'active'
                };

                // Save to database via API
                const token = localStorage.getItem('token');
                
                fetch('/api/mock-tests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(mockTest)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('âœ… Mock test created:', data.mockTest);
                        showNotification(`âœ… Mock test "${testName}" created successfully!`, 'success');

                        // Reset form and reload list
                        resetMockTestForm();
                        loadMockTestsList();
                        loadMockTestsInCreateSection();
                    } else {
                        throw new Error(data.error || 'Failed to create mock test');
                    }
                })
                .catch(error => {
                    console.error('âŒ Error creating mock test:', error);
                    showNotification('âŒ Error creating mock test: ' + error.message, 'error');
                });

            } catch (error) {
                console.error('âŒ Error creating mock test:', error);
                showNotification('âŒ Error creating mock test!', 'error');
            }
        }

        function resetMockTestForm() {
            document.getElementById('mockTestName').value = '';
            document.getElementById('mockTestExam').value = '';
            document.getElementById('mockTestDuration').value = '';
            document.getElementById('mockTestMarksPerQuestion').value = '4';
            document.getElementById('mockTestNegativeMarking').checked = true;
            document.getElementById('mockTestDescription').value = '';
            
            // Reset selected questions
            selectedQuestions = [];
            document.getElementById('selectedQuestionIds').value = '[]';
            document.getElementById('totalMockQuestions').textContent = '0';
            
            // Reset display
            document.getElementById('selectedQuestionsDisplay').innerHTML = `
                <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                    <p>No questions selected yet. Click "Open Question Selector" to choose questions.</p>
                </div>
            `;
        }

        function loadMockTestsList() {
            try {
                const container = document.getElementById('mockTestsList');
                if (!container) return;

                // Fetch mock tests from database
                fetch(`${API_BASE}/api/mock-tests`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success || data.mockTests.length === 0) {
                            container.innerHTML = `
                                <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>No mock tests created yet. Create your first mock test above!</p>
                                </div>
                            `;
                            return;
                        }

                        container.innerHTML = data.mockTests.map(test => `
                    <div class="mock-test-card" style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="color: var(--gray-800); margin-bottom: 0.5rem; font-size: 1.2rem;">${test.name}</h4>
                                <p style="color: var(--gray-600); font-size: 0.9rem;">${test.description || 'No description'}</p>
                            </div>
                            <span class="badge" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; text-transform: uppercase;">
                                ${test.examType}
                            </span>
                        </div>
                        <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-clock"></i>
                                <span>${test.duration} minutes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-list-check"></i>
                                <span>${test.totalQuestions} questions</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-calendar"></i>
                                <span>${new Date(test.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="viewMockTestData('${test._id}', '${test.name}')" class="btn btn-sm" style="background: var(--success); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-chart-bar"></i> View Data
                            </button>
                            <button onclick="viewMockTest('${test._id}')" class="btn btn-sm" style="background: var(--info); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="deleteMockTest('${test._id}')" class="btn btn-sm" style="background: var(--error); color: white; padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                    })
                    .catch(error => {
                        console.error('âŒ Error loading mock tests:', error);
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--error);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Error loading mock tests</p>
                            </div>
                        `;
                    });

            } catch (error) {
                console.error('âŒ Error loading mock tests:', error);
            }
        }

        function viewMockTest(testId) {
            fetch(`${API_BASE}/api/mock-tests/${testId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const test = data.mockTest;
                        alert(`Mock Test Details:\n\nName: ${test.name}\nExam: ${test.examType.toUpperCase()}\nDuration: ${test.duration} minutes\nTotal Questions: ${test.totalQuestions}\n\nThis mock test is available to all students!`);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error viewing mock test:', error);
                    showNotification('âŒ Error loading mock test details!', 'error');
                });
        }

        async function viewMockTestData(testId, testName) {
            try {
                showNotification('Loading test data...', 'info');
                const token = localStorage.getItem('token');
                
                const response = await fetch(`${API_BASE}/api/test-results/mock/${testId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load test data');
                }
                
                const results = data.results;
                
                // Create modal to show results
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="color: var(--gray-800); margin: 0;">
                                <i class="fas fa-chart-bar"></i> ${testName} - Results
                            </h2>
                            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-600);">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        ${results.length === 0 ? `
                            <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No students have taken this test yet.</p>
                            </div>
                        ` : `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--primary); color: white; border-radius: 12px; text-align: center;">
                                <h3 style="margin: 0;">Total Students: ${results.length}</h3>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--gray-100); border-bottom: 2px solid var(--gray-300);">
                                            <th style="padding: 0.75rem; text-align: left;">Rank</th>
                                            <th style="padding: 0.75rem; text-align: left;">Username</th>
                                            <th style="padding: 0.75rem; text-align: center;">Score</th>
                                            <th style="padding: 0.75rem; text-align: center;">Percentage</th>
                                            <th style="padding: 0.75rem; text-align: center;">Correct</th>
                                            <th style="padding: 0.75rem; text-align: center;">Wrong</th>
                                            <th style="padding: 0.75rem; text-align: center;">Time</th>
                                            <th style="padding: 0.75rem; text-align: center;">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map((result, index) => `
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 0.75rem; font-weight: bold; color: ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? '#cd7f32' : 'var(--gray-600)'};">
                                                    ${index + 1}
                                                </td>
                                                <td style="padding: 0.75rem;">${result.username}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-weight: bold;">${result.totalMarks}/${result.maxMarks}</td>
                                                <td style="padding: 0.75rem; text-align: center; color: ${result.percentage >= 75 ? 'var(--success)' : result.percentage >= 50 ? 'var(--warning)' : 'var(--error)'}; font-weight: bold;">
                                                    ${result.percentage.toFixed(1)}%
                                                </td>
                                                <td style="padding: 0.75rem; text-align: center; color: var(--success);">${result.correct}</td>
                                                <td style="padding: 0.75rem; text-align: center; color: var(--error);">${result.incorrect}</td>
                                                <td style="padding: 0.75rem; text-align: center;">${Math.floor(result.timeSpent / 60)}:${(result.timeSpent % 60).toString().padStart(2, '0')}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-size: 0.85rem;">${new Date(result.timestamp).toLocaleDateString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('âŒ Error loading test data:', error);
                showNotification('âŒ Error loading test data: ' + error.message, 'error');
            }
        }

        function deleteMockTest(testId) {
            if (confirm('Are you sure you want to delete this mock test? This action cannot be undone.')) {
                const token = localStorage.getItem('token');
                
                fetch(`${API_BASE}/api/mock-tests/${testId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('âœ… Mock test deleted successfully!', 'success');
                        loadMockTestsList();
                        loadMockTestsInCreateSection();
                    } else {
                        throw new Error(data.error || 'Failed to delete mock test');
                    }
                })
                .catch(error => {
                    console.error('âŒ Error deleting mock test:', error);
                    showNotification('âŒ Error deleting mock test!', 'error');
                });
            }
        }

        // Load mock tests in Create Test section
        function loadMockTestsInCreateSection() {
            try {
                console.log('ðŸŽ¯ ========== loadMockTestsInCreateSection CALLED ==========');
                const container = document.getElementById('mockTestsDisplay');
                console.log('ðŸ“¦ Container found:', container ? 'YES âœ…' : 'NO âŒ');
                console.log('ðŸ“¦ Container element:', container);
                
                if (!container) {
                    console.error('âŒ mockTestsDisplay container not found!');
                    console.error('âŒ Make sure the Create Test section has <div id="mockTestsDisplay"></div>');
                    return;
                }

                // Show loading state
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--primary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--gray-700);">Loading Mock Tests...</h3>
                        <p style="color: var(--gray-500); margin-top: 0.5rem;">Fetching from database...</p>
                    </div>
                `;

                console.log('ðŸŒ Fetching mock tests from /api/mock-tests...');
                console.log('ðŸŒ API URL:', '${API_BASE}/api/mock-tests');
                
                fetch(`${API_BASE}/api/mock-tests`)
                    .then(response => {
                        console.log('ðŸ“¡ Response received!');
                        console.log('ðŸ“¡ Response status:', response.status);
                        console.log('ðŸ“¡ Response ok:', response.ok);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('ðŸ“Š ========== MOCK TESTS DATA RECEIVED ==========');
                        console.log('ðŸ“Š Full data object:', data);
                        console.log('ðŸ“Š data.success:', data.success);
                        console.log('ðŸ“Š data.mockTests:', data.mockTests);
                        console.log('ðŸ“Š Number of mock tests:', data.mockTests ? data.mockTests.length : 0);
                        
                        if (data.mockTests && data.mockTests.length > 0) {
                            console.log('ðŸ“Š First mock test:', data.mockTests[0]);
                        }
                        
                        if (!data.success || !data.mockTests || data.mockTests.length === 0) {
                            console.log('âš ï¸ No mock tests found, showing empty state');
                            container.innerHTML = `
                                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--gray-500); background: white; border-radius: 16px; border: 2px dashed var(--gray-300);">
                                    <i class="fas fa-clipboard-list" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                    <h3 style="color: var(--gray-600); margin-bottom: 0.5rem;">No Mock Tests Available</h3>
                                    <p>Mock tests will appear here once created by administrators</p>
                                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-400);">
                                        Go to Admin Panel â†’ Mock Test to create one
                                    </p>
                                </div>
                            `;
                            return;
                        }
                        
                        console.log('âœ… ========== RENDERING', data.mockTests.length, 'MOCK TESTS ==========');

                        container.innerHTML = data.mockTests.map(test => `
                    <div class="mock-test-card" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); border-radius: 20px; padding: 1.5rem; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15); border: 2px solid rgba(102, 126, 234, 0.1); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 12px 32px rgba(102, 126, 234, 0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(102, 126, 234, 0.15)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <h3 style="color: var(--gray-800); margin-bottom: 0.5rem; font-size: 1.3rem; font-weight: 700;">${test.name}</h3>
                                <p style="color: var(--gray-600); font-size: 0.9rem; line-height: 1.5;">${test.description || 'Comprehensive mock test'}</p>
                            </div>
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                ${test.examType}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 12px;">
                            <div style="text-align: center;">
                                <i class="fas fa-clock" style="color: var(--primary); font-size: 1.2rem; margin-bottom: 0.25rem;"></i>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--gray-800);">${test.duration}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">minutes</div>
                            </div>
                            <div style="text-align: center;">
                                <i class="fas fa-list-check" style="color: var(--success); font-size: 1.2rem; margin-bottom: 0.25rem;"></i>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--gray-800);">${test.totalQuestions}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">questions</div>
                            </div>
                            <div style="text-align: center;">
                                <i class="fas fa-calendar" style="color: var(--info); font-size: 1.2rem; margin-bottom: 0.25rem;"></i>
                                <div style="font-size: 0.85rem; font-weight: 600; color: var(--gray-800);">${new Date(test.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">created</div>
                            </div>
                        </div>
                        
                        <button onclick="startMockTest('${test._id}')" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 700; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 28px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'">
                            <i class="fas fa-play-circle"></i>
                            Start Mock Test
                        </button>
                    </div>
                `).join('');
                        
                        console.log('âœ… Mock tests HTML rendered successfully');
                        console.log('ðŸ“¦ Container innerHTML length:', container.innerHTML.length);
                        
                        // Load personal tests after mock tests
                        loadPersonalTests();
                    })
                    .catch(error => {
                        console.error('âŒ ========== ERROR LOADING MOCK TESTS ==========');
                        console.error('âŒ Error object:', error);
                        console.error('âŒ Error message:', error.message);
                        console.error('âŒ Error stack:', error.stack);
                        
                        container.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--error); background: white; border-radius: 16px; border: 2px solid var(--error);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                                <h3 style="color: var(--error); margin-bottom: 0.5rem;">Error Loading Mock Tests</h3>
                                <p style="color: var(--gray-600); margin-bottom: 1rem;">${error.message}</p>
                                <button onclick="loadMockTestsInCreateSection()" class="btn btn-primary" style="margin-top: 1rem;">
                                    <i class="fas fa-sync"></i> Retry
                                </button>
                                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray-500);">
                                    Check browser console (F12) for more details
                                </p>
                            </div>
                        `;
                    });

            } catch (error) {
                console.error('âŒ Error loading mock tests in create section:', error);
            }
        }

        // Mock Test State
        let activeMockTest = null;
        let activeMockQuestions = [];
        let activeMockQuestionIdx = 0;
        let activeMockAnswers = {};
        let activeMockMarked = new Set();
        let activeMockTimer = null;
        let activeMockTime = 0;

        // Start a mock test
        async function startMockTest(testId) {
            try {
                console.log('ðŸš€ Starting mock test:', testId);
                showNotification(`ðŸš€ Loading mock test...`, 'info');
                
                // Fetch mock test from database
                const response = await fetch(`${API_BASE}/api/mock-tests/${testId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Mock test not found');
                }
                
                activeMockTest = data.mockTest;
                console.log('ðŸ“Š Mock test loaded:', activeMockTest);
                console.log('ðŸ“Š Question IDs:', activeMockTest.questionIds);
                
                // Check if questionIds exists and is an array
                if (!activeMockTest.questionIds || !Array.isArray(activeMockTest.questionIds) || activeMockTest.questionIds.length === 0) {
                    throw new Error('No questions found in this mock test. Please add questions to the test.');
                }
                
                // Fetch all questions for this mock test
                const questionsResponse = await fetch('/api/questions/by-ids', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: activeMockTest.questionIds })
                });
                
                const questionsData = await questionsResponse.json();
                
                if (!questionsData.success) {
                    throw new Error('Failed to load questions');
                }
                
                activeMockQuestions = questionsData.questions;
                console.log('ðŸ“ Questions loaded:', activeMockQuestions.length);
                
                if (activeMockQuestions.length === 0) {
                    throw new Error('No questions found for this mock test');
                }
                
                // Initialize test state
                activeMockQuestionIdx = 0;
                activeMockAnswers = {};
                activeMockMarked = new Set();
                activeMockTime = activeMockTest.duration * 60; // Convert to seconds
                
                // Show mock test interface
                showMockTestInterface();
                
                showNotification(`âœ… Mock test started: ${activeMockTest.name}`, 'success');
                
            } catch (error) {
                console.error('âŒ Error starting mock test:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        function showMockTestInterface() {
            console.log('ðŸŽ¯ ========== SHOWING MOCK TEST INTERFACE ==========');
            console.log('ðŸ“Š Active mock test:', activeMockTest);
            console.log('ðŸ“ Questions count:', activeMockQuestions.length);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Show mock test interface
            const mockTestSection = document.getElementById('mockTestInterfaceSection');
            console.log('ðŸ“¦ Mock test section found:', mockTestSection ? 'YES' : 'NO');
            
            if (!mockTestSection) {
                console.error('âŒ Mock test interface section not found!');
                showNotification('âŒ Error: Test interface not found', 'error');
                return;
            }
            
            // Force show the section
            mockTestSection.style.display = 'block';
            mockTestSection.style.visibility = 'visible';
            mockTestSection.style.opacity = '1';
            mockTestSection.style.position = 'relative';
            mockTestSection.style.zIndex = '1000';
            mockTestSection.classList.add('active');
            
            console.log('âœ… Mock test section displayed');
            console.log('ðŸ“Š Section styles:', {
                display: mockTestSection.style.display,
                visibility: mockTestSection.style.visibility,
                opacity: mockTestSection.style.opacity,
                zIndex: mockTestSection.style.zIndex
            });
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Ensure body is scrollable
            document.body.style.overflow = 'auto';
            
            // Update header
            const titleElement = document.getElementById('mockTestTitle');
            const infoElement = document.getElementById('mockTestInfo');
            
            console.log('ðŸ“¦ Title element found:', titleElement ? 'YES' : 'NO');
            console.log('ðŸ“¦ Info element found:', infoElement ? 'YES' : 'NO');
            
            if (titleElement) titleElement.textContent = activeMockTest.name;
            if (infoElement) infoElement.textContent = `${activeMockTest.examType.toUpperCase()} â€¢ ${activeMockTest.totalQuestions} Questions â€¢ ${activeMockTest.duration} Minutes`;
            
            // Wait for DOM to be ready before initializing
            setTimeout(() => {
                console.log('ðŸ” Checking if elements exist...');
                const questionsContainer = document.getElementById('mockTestQuestions');
                const timerElement = document.getElementById('mockTestTimer');
                const paletteElement = document.getElementById('questionPalette');
                
                console.log('ðŸ“¦ mockTestQuestions:', questionsContainer ? 'FOUND âœ…' : 'NOT FOUND âŒ');
                console.log('ðŸ“¦ mockTestTimer:', timerElement ? 'FOUND âœ…' : 'NOT FOUND âŒ');
                console.log('ðŸ“¦ questionPalette:', paletteElement ? 'FOUND âœ…' : 'NOT FOUND âŒ');
                
                if (!questionsContainer || !timerElement || !paletteElement) {
                    console.error('âŒ Critical elements missing! Retrying in 500ms...');
                    setTimeout(() => {
                        showMockTestInterface(); // Retry
                    }, 500);
                    return;
                }
                
                console.log('ðŸŽ¨ Initializing question palette...');
                initializeQuestionPalette();
                
                console.log('ðŸ“ Loading first question...');
                loadMockQuestion(0);
                
                console.log('â±ï¸ Starting timer...');
                startMockTestTimer();
                
                console.log('ðŸ“Š Updating stats...');
                updateMockTestStats();
                
                console.log('âœ… Mock test interface ready!');
            }, 200);
        }

        function initializeQuestionPalette() {
            const palette = document.getElementById('questionPalette');
            palette.innerHTML = activeMockQuestions.map((q, index) => `
                <button onclick="loadMockQuestion(${index})" 
                        id="paletteBtn${index}"
                        style="width: 40px; height: 40px; border: 2px solid var(--gray-300); background: var(--gray-100); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; color: var(--gray-700);">
                    ${index + 1}
                </button>
            `).join('');
        }

        function loadMockQuestion(index) {
            console.log('ðŸ“ loadMockQuestion called with index:', index);
            
            if (index < 0 || index >= activeMockQuestions.length) {
                console.error('âŒ Invalid question index:', index);
                return;
            }
            
            activeMockQuestionIdx = index;
            const question = activeMockQuestions[index];
            
            console.log('ðŸ“ Loading question', index + 1, ':', question);
            
            const container = document.getElementById('mockTestQuestions');
            console.log('ðŸ“¦ Question container found:', container ? 'YES' : 'NO');
            
            if (!container) {
                console.error('âŒ mockTestQuestions container not found!');
                return;
            }
            container.innerHTML = `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                        <h2 style="margin: 0; color: var(--primary); font-size: 1.3rem;">
                            Question ${index + 1} of ${activeMockQuestions.length}
                        </h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                                ${question.subject || 'N/A'}
                            </span>
                            <span style="background: ${question.difficulty === 'easy' ? '#dcfce7' : question.difficulty === 'medium' ? '#fef3c7' : '#fee2e2'}; 
                                         color: ${question.difficulty === 'easy' ? '#15803d' : question.difficulty === 'medium' ? '#a16207' : '#b91c1c'}; 
                                         padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                                ${question.difficulty || 'N/A'}
                            </span>
                        </div>
                    </div>
                    
                    <div style="font-size: 1.1rem; line-height: 1.8; color: var(--gray-800); margin-bottom: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 12px; border-left: 4px solid var(--primary); white-space: pre-line;">
                        ${question.text ? question.text.replace(/\\n/g, '\n').split('\n').map(line => line.trim()).join('\n') : ''}
                    </div>
                    
                    ${question.options && question.options.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${question.options.map((option, optIndex) => {
                                const optionLetter = String.fromCharCode(65 + optIndex);
                                const isSelected = activeMockAnswers[question._id] === optionLetter;
                                return `
                                    <label style="display: flex; align-items: start; gap: 1rem; padding: 1.25rem; background: ${isSelected ? 'rgba(102, 126, 234, 0.1)' : 'white'}; border: 2px solid ${isSelected ? 'var(--primary)' : 'var(--gray-200)'}; border-radius: 12px; cursor: pointer; transition: all 0.2s;" 
                                           onmouseover="if(!${isSelected}) this.style.borderColor='var(--primary)'; if(!${isSelected}) this.style.background='rgba(102, 126, 234, 0.05)';" 
                                           onmouseout="if(!${isSelected}) this.style.borderColor='var(--gray-200)'; if(!${isSelected}) this.style.background='white';">
                                        <input type="radio" 
                                               name="mockQuestion${index}" 
                                               value="${optionLetter}" 
                                               ${isSelected ? 'checked' : ''}
                                               onchange="saveMockAnswer('${question._id}', '${optionLetter}')"
                                               style="width: 20px; height: 20px; margin-top: 0.25rem; cursor: pointer;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">${optionLetter}</div>
                                            <div style="color: var(--gray-700); line-height: 1.6; white-space: pre-line;">${option ? option.replace(/\\n/g, '\n').split('\n').map(line => line.trim()).join('\n') : ''}</div>
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="padding: 1.5rem; background: var(--gray-50); border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-700);">
                                Enter your numerical answer:
                            </label>
                            <input type="text" 
                                   id="numericalAnswer${index}"
                                   value="${activeMockAnswers[question._id] || ''}"
                                   onchange="saveMockAnswer('${question._id}', this.value)"
                                   placeholder="Enter answer"
                                   style="width: 100%; padding: 1rem; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1.1rem;">
                        </div>
                    `}
                </div>
            `;
            
            // Update navigation buttons
            document.getElementById('prevQuestionBtn').style.display = index === 0 ? 'none' : 'block';
            document.getElementById('nextQuestionBtn').style.display = index === activeMockQuestions.length - 1 ? 'none' : 'block';
            document.getElementById('submitMockTestBtn').style.display = index === activeMockQuestions.length - 1 ? 'block' : 'none';
            
            // Update palette
            updateQuestionPalette();
            
            // Render MathJax
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch(err => console.log('MathJax error:', err));
            }
        }

        function saveMockAnswer(questionId, answer) {
            activeMockAnswers[questionId] = answer;
            console.log('ðŸ’¾ Answer saved:', questionId, '=', answer);
            updateQuestionPalette();
            updateMockTestStats();
        }

        function navigateMockQuestion(direction) {
            const newIndex = activeMockQuestionIdx + direction;
            if (newIndex >= 0 && newIndex < activeMockQuestions.length) {
                loadMockQuestion(newIndex);
            }
        }

        function updateQuestionPalette() {
            activeMockQuestions.forEach((q, index) => {
                const btn = document.getElementById(`paletteBtn${index}`);
                if (btn) {
                    const isAnswered = activeMockAnswers[q._id] !== undefined;
                    const isMarked = activeMockMarked.has(q._id);
                    const isCurrent = index === activeMockQuestionIdx;
                    
                    if (isCurrent) {
                        btn.style.background = 'var(--primary)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--primary)';
                    } else if (isAnswered) {
                        btn.style.background = 'var(--success)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--success)';
                    } else if (isMarked) {
                        btn.style.background = 'var(--warning)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--warning)';
                    } else {
                        btn.style.background = 'var(--gray-100)';
                        btn.style.color = 'var(--gray-700)';
                        btn.style.borderColor = 'var(--gray-300)';
                    }
                }
            });
        }

        function updateMockTestStats() {
            const answered = Object.keys(activeMockAnswers).length;
            const marked = activeMockMarked.size;
            const notAnswered = activeMockQuestions.length - answered;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('markedCount').textContent = marked;
            document.getElementById('notAnsweredCount').textContent = notAnswered;
        }

        function markForReview() {
            const currentQuestion = activeMockQuestions[activeMockQuestionIdx];
            if (activeMockMarked.has(currentQuestion._id)) {
                activeMockMarked.delete(currentQuestion._id);
                showNotification('Unmarked for review', 'info');
            } else {
                activeMockMarked.add(currentQuestion._id);
                showNotification('Marked for review', 'info');
            }
            updateQuestionPalette();
            updateMockTestStats();
        }

        function startMockTestTimer() {
            console.log('â±ï¸ Starting mock test timer...');
            const timerElement = document.getElementById('mockTestTimer');
            
            if (!timerElement) {
                console.error('âŒ Timer element not found!');
                return;
            }
            
            console.log('â±ï¸ Timer duration:', activeMockTime, 'seconds');
            
            activeMockTimer = setInterval(() => {
                activeMockTime--;
                
                const hours = Math.floor(activeMockTime / 3600);
                const minutes = Math.floor((activeMockTime % 3600) / 60);
                const seconds = activeMockTime % 60;
                
                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Change color when time is running out
                if (activeMockTime <= 300) { // 5 minutes
                    timerElement.style.color = '#ef4444';
                } else if (activeMockTime <= 600) { // 10 minutes
                    timerElement.style.color = '#f59e0b';
                }
                
                if (activeMockTime <= 0) {
                    clearInterval(activeMockTimer);
                    showNotification('â° Time is up! Submitting test...', 'warning');
                    setTimeout(() => submitMockTest(), 2000);
                }
            }, 1000);
            
            console.log('âœ… Timer started successfully');
        }

        function exitMockTest() {
            if (confirm('Are you sure you want to exit the test? Your progress will be lost.')) {
                clearInterval(activeMockTimer);
                activeMockTest = null;
                activeMockQuestions = [];
                activeMockAnswers = {};
                activeMockMarked.clear();
                
                // Go back to Create Test section
                document.getElementById('mockTestInterfaceSection').style.display = 'none';
                showSection('createTestSection');
            }
        }

        function submitMockTest() {
            if (!confirm(`Submit test with ${Object.keys(activeMockAnswers).length} answered out of ${activeMockQuestions.length} questions?`)) {
                return;
            }
            
            clearInterval(activeMockTimer);
            
            // Get test configuration - use mock test's settings
            const marksPerQuestion = activeMockTest?.marksPerQuestion || 4;
            const hasNegativeMarking = activeMockTest?.negativeMarking !== undefined ? activeMockTest.negativeMarking : true;
            const negativeMarksPerQuestion = hasNegativeMarking ? (marksPerQuestion * 0.25) : 0;
            
            console.log('ðŸ“Š Scoring with config:', {
                marksPerQuestion,
                hasNegativeMarking,
                negativeMarksPerQuestion,
                mockTestData: activeMockTest
            });
            
            // Calculate score
            let correct = 0;
            let incorrect = 0;
            let unanswered = 0;
            let totalMarks = 0;
            let maxMarks = 0;
            
            activeMockQuestions.forEach(q => {
                maxMarks += marksPerQuestion; // Use configured marks per question
                
                const userAnswer = activeMockAnswers[q._id];
                if (!userAnswer) {
                    unanswered++;
                } else if (userAnswer === q.answer) {
                    correct++;
                    totalMarks += marksPerQuestion; // Add configured marks for correct answer
                } else {
                    incorrect++;
                    if (hasNegativeMarking) {
                        totalMarks -= negativeMarksPerQuestion; // Subtract configured negative marks
                    }
                }
            });
            
            const totalQuestions = activeMockQuestions.length;
            const percentage = maxMarks > 0 ? ((totalMarks / maxMarks) * 100).toFixed(2) : 0;
            const timeSpent = (activeMockTest.duration * 60) - activeMockTime;
            
            // Save results to database
            const token = localStorage.getItem('token');
            if (token) {
                fetch(`${API_BASE}/api/test-results`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mockTestId: activeMockTest._id,
                        testTitle: activeMockTest.name,
                        testType: 'mock',
                        answers: activeMockAnswers,
                        score: totalMarks,
                        totalMarks: totalMarks,
                        maxMarks: maxMarks,
                        totalQuestions: totalQuestions,
                        correct: correct,
                        incorrect: incorrect,
                        unanswered: unanswered,
                        percentage: parseFloat(percentage),
                        timeSpent: timeSpent,
                        hasNegativeMarking: hasNegativeMarking
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('âœ… Test result saved to database');
                    } else {
                        console.error('âŒ Failed to save test result:', data.error);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error saving test result:', error);
                });
            }
            
            // Show results
            showMockTestResults({
                testName: activeMockTest.name,
                totalMarks,
                maxMarks,
                totalQuestions,
                percentage,
                correct,
                incorrect,
                unanswered,
                timeSpent,
                marksPerQuestion,
                negativeMarksPerQuestion,
                hasNegativeMarking
            });
        }

        function showMockTestResults(results) {
            const container = document.getElementById('mockTestQuestions');
            if (!container) {
                console.error('âŒ Results container not found!');
                showNotification('âŒ Error displaying results', 'error');
                return;
            }
            
            // Ensure container has overflow visible
            container.style.overflow = 'visible';
            
            container.innerHTML = `
                <div class="mock-test-results" style="text-align: center; padding: 3rem 2rem; overflow: visible; min-height: 100vh;">
                    <div class="results-check-icon" style="width: 140px; height: 140px; margin: 0 auto 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); position: relative; flex-shrink: 0;">
                        <i class="fas fa-check" style="font-size: 4.5rem; color: white; display: flex; align-items: center; justify-content: center; line-height: 1; margin: 0; padding: 0; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
                    </div>
                    
                    <h1 class="results-title" style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--gray-800);">Test Completed!</h1>
                    <p class="results-test-name" style="font-size: 1.2rem; color: var(--gray-600); margin-bottom: 1rem;">${results.testName}</p>
                    <p class="results-marking-info" style="font-size: 0.95rem; color: var(--gray-500); margin-bottom: 3rem;">
                        <i class="fas fa-calculator"></i> Marking Scheme: +${results.marksPerQuestion || 4} for correct${results.hasNegativeMarking ? `, -${results.negativeMarksPerQuestion || 1} for incorrect` : ', No negative marking'}
                    </p>
                    
                    <div class="results-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <div class="results-stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                            <div class="stat-number" style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem;">${results.totalMarks}/${results.maxMarks}</div>
                            <div class="stat-label" style="font-size: 1.1rem; opacity: 0.9;">Total Marks</div>
                            <div class="stat-percentage" style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">${results.percentage}%</div>
                        </div>
                        <div class="results-stat-card" style="background: white; border: 2px solid var(--gray-200); padding: 2rem; border-radius: 16px;">
                            <div class="stat-number" style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--success);">${results.correct}</div>
                            <div class="stat-label" style="font-size: 1.1rem; color: var(--gray-600);">Correct</div>
                            <div class="stat-marks" style="font-size: 0.9rem; color: var(--success); margin-top: 0.5rem;">+${(results.correct * (results.marksPerQuestion || 4)).toFixed(2)} marks</div>
                        </div>
                        <div class="results-stat-card" style="background: white; border: 2px solid var(--gray-200); padding: 2rem; border-radius: 16px;">
                            <div class="stat-number" style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--error);">${results.incorrect}</div>
                            <div class="stat-label" style="font-size: 1.1rem; color: var(--gray-600);">Incorrect</div>
                            <div class="stat-marks" style="font-size: 0.9rem; color: var(--error); margin-top: 0.5rem;">${results.hasNegativeMarking ? `-${(results.incorrect * (results.negativeMarksPerQuestion || 1)).toFixed(2)} marks` : '0 marks'}</div>
                        </div>
                        <div class="results-stat-card" style="background: white; border: 2px solid var(--gray-200); padding: 2rem; border-radius: 16px;">
                            <div class="stat-number" style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--gray-400);">${results.unanswered}</div>
                            <div class="stat-label" style="font-size: 1.1rem; color: var(--gray-600);">Unanswered</div>
                            <div class="stat-marks" style="font-size: 0.9rem; color: var(--gray-400); margin-top: 0.5rem;">0 marks</div>
                        </div>
                    </div>
                    
                    <div class="results-actions" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="exitMockTest()" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            <i class="fas fa-home"></i> Back to Tests
                        </button>
                        <button onclick="reviewMockTest()" class="btn btn-secondary" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            <i class="fas fa-eye"></i> Review Answers
                        </button>
                    </div>
                </div>
            `;
            
            // Hide navigation buttons
            document.getElementById('prevQuestionBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('submitMockTestBtn').style.display = 'none';
            
            showNotification(`âœ… Test submitted! Score: ${results.percentage}%`, 'success');
        }

        function reviewMockTest() {
            showNotification('Review feature coming soon!', 'info');
        }

        // ========================================
        // QUESTION SELECTOR FUNCTIONS
        // ========================================

        let selectedQuestions = [];
        let availableQuestions = [];
        let allChapters = []; // Store all chapters with their subjects

        function openQuestionSelector() {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('âŒ Please login first to select questions', 'error');
                return;
            }

            // Show loading
            showNotification('ðŸ“š Loading questions and chapters...', 'info');
            
            // Load chapters first
            fetch('/api/chapters', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(chaptersData => {
                    if (chaptersData.success) {
                        // Store all chapters globally
                        allChapters = chaptersData.chapters;
                        
                        // Populate chapter dropdown with all chapters initially
                        updateChapterDropdown();
                    }
                })
                .catch(error => {
                    console.error('Error loading chapters:', error);
                });

            // Load all questions from database
            fetch('/api/questions', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        availableQuestions = data.questions;
                        if (availableQuestions.length === 0) {
                            showNotification('âš ï¸ No questions available in database', 'warning');
                            return;
                        }
                        displayQuestionsForSelection();
                        document.getElementById('questionSelectorModal').style.display = 'flex';
                        showNotification(`âœ… Loaded ${availableQuestions.length} questions`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load questions');
                    }
                })
                .catch(error => {
                    console.error('âŒ Error loading questions:', error);
                    showNotification('âŒ Error loading questions: ' + error.message, 'error');
                });
        }

        function closeQuestionSelector() {
            document.getElementById('questionSelectorModal').style.display = 'none';
        }

        function updateChapterDropdown() {
            const selectedSubject = document.getElementById('selectorSubject').value;
            const chapterSelect = document.getElementById('selectorChapter');
            
            if (!chapterSelect) return;
            
            // Filter chapters by selected subject
            let filteredChapters = allChapters;
            if (selectedSubject) {
                filteredChapters = allChapters.filter(c => c.subject.toLowerCase() === selectedSubject.toLowerCase());
            }
            
            // Get unique chapter names
            const uniqueChapters = [...new Set(filteredChapters.map(c => c.name))];
            
            // Update dropdown
            chapterSelect.innerHTML = '<option value="">All Chapters</option>' + 
                uniqueChapters.map(chapter => `<option value="${chapter}">${chapter}</option>`).join('');
            
            console.log(`ðŸ“š Updated chapters for subject: ${selectedSubject || 'All'}, found ${uniqueChapters.length} chapters`);
        }

        function displayQuestionsForSelection() {
            const container = document.getElementById('questionSelectorList');
            
            if (!availableQuestions || availableQuestions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No questions available</p>
                    </div>
                `;
                return;
            }

            // Build HTML with full question text and LaTeX support
            const html = availableQuestions.map(q => {
                const isSelected = selectedQuestions.includes(q._id);
                const questionText = q.text || 'No question text';
                
                return `
                    <div class="question-selector-item" 
                         style="background: ${isSelected ? 'rgba(102, 126, 234, 0.1)' : 'white'}; 
                                border: 2px solid ${isSelected ? 'var(--primary)' : 'var(--gray-200)'}; 
                                border-radius: 12px; 
                                padding: 1.5rem; 
                                cursor: pointer; 
                                transition: all 0.3s ease;
                                margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div onclick="toggleQuestionSelection('${q._id}')" style="flex: 1; padding-right: 1rem; cursor: pointer;">
                                <!-- Tags -->
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                    <span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                        ${q.subject || 'N/A'}
                                    </span>
                                    <span style="background: ${q.difficulty === 'easy' ? '#dcfce7' : q.difficulty === 'medium' ? '#fef3c7' : '#fee2e2'}; 
                                                 color: ${q.difficulty === 'easy' ? '#15803d' : q.difficulty === 'medium' ? '#a16207' : '#b91c1c'}; 
                                                 padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                        ${q.difficulty || 'N/A'}
                                    </span>
                                    <span style="background: #f3e8ff; color: #7e22ce; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                        ${q.chapter || 'N/A'}
                                    </span>
                                </div>
                                
                                <!-- Full Question Text with LaTeX -->
                                <div class="question-text-full" 
                                     style="color: var(--gray-800); 
                                            font-size: 1rem; 
                                            line-height: 1.6; 
                                            word-wrap: break-word; 
                                            overflow-wrap: break-word;
                                            padding: 0.75rem;
                                            background: rgba(0,0,0,0.02);
                                            border-radius: 8px;
                                            border-left: 3px solid var(--primary);">
                                    ${questionText}
                                </div>
                                
                                <!-- Options Preview (if available) -->
                                ${q.options && q.options.length > 0 ? `
                                    <div style="margin-top: 0.75rem; padding-left: 0.75rem; font-size: 0.85rem; color: var(--gray-600);">
                                        <strong>Options:</strong> ${q.options.length} choices â€¢ 
                                        <strong>Answer:</strong> ${q.answer || 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Checkbox -->
                            <div style="margin-left: 1rem; flex-shrink: 0;">
                                <input type="checkbox" 
                                       id="checkbox-${q._id}"
                                       data-question-id="${q._id}"
                                       ${isSelected ? 'checked' : ''} 
                                       onclick="toggleQuestionSelection('${q._id}');"
                                       style="width: 24px; height: 24px; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Render MathJax for LaTeX expressions
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch((err) => {
                    console.log('MathJax rendering error:', err);
                });
            }

            updateSelectedCount();
        }

        function toggleQuestionSelection(questionId) {
            const index = selectedQuestions.indexOf(questionId);
            if (index > -1) {
                selectedQuestions.splice(index, 1);
            } else {
                selectedQuestions.push(questionId);
            }
            
            // Update the UI without full re-render
            const checkbox = document.getElementById(`checkbox-${questionId}`);
            const card = checkbox ? checkbox.closest('.question-selector-item') : null;
            
            if (checkbox && card) {
                const isSelected = selectedQuestions.includes(questionId);
                checkbox.checked = isSelected;
                card.style.background = isSelected ? 'rgba(102, 126, 234, 0.1)' : 'white';
                card.style.borderColor = isSelected ? 'var(--primary)' : 'var(--gray-200)';
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedQuestions.length;
        }

        function filterQuestionsForSelector() {
            const subject = document.getElementById('selectorSubject').value;
            const difficulty = document.getElementById('selectorDifficulty').value;
            const chapter = document.getElementById('selectorChapter').value;

            // Re-fetch questions with filters
            let url = '/api/questions?';
            if (subject) url += `subject=${encodeURIComponent(subject)}&`;
            if (difficulty) url += `difficulty=${encodeURIComponent(difficulty)}&`;
            if (chapter) url += `chapter=${encodeURIComponent(chapter)}&`;

            const token = localStorage.getItem('token');

            showNotification('ðŸ” Filtering questions...', 'info');

            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        availableQuestions = data.questions;
                        displayQuestionsForSelection();
                        showNotification(`âœ… Found ${availableQuestions.length} questions`, 'success');
                    }
                })
                .catch(error => {
                    console.error('âŒ Error filtering questions:', error);
                    showNotification('âŒ Error filtering questions', 'error');
                });
        }

        function confirmQuestionSelection() {
            if (selectedQuestions.length === 0) {
                showNotification('âŒ Please select at least one question', 'error');
                return;
            }

            // Update hidden input
            document.getElementById('selectedQuestionIds').value = JSON.stringify(selectedQuestions);
            
            // Update total count
            document.getElementById('totalMockQuestions').textContent = selectedQuestions.length;

            // Display selected questions
            displaySelectedQuestions();

            // Close modal
            closeQuestionSelector();
            showNotification(`âœ… ${selectedQuestions.length} questions selected`, 'success');
        }

        function displaySelectedQuestions() {
            const container = document.getElementById('selectedQuestionsDisplay');
            
            if (selectedQuestions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p>No questions selected yet. Click "Open Question Selector" to choose questions.</p>
                    </div>
                `;
                return;
            }

            // Fetch question details to display
            fetch('/api/questions/by-ids', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selectedQuestions })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.innerHTML = `
                        <div style="display: grid; gap: 1rem;">
                            ${data.questions.map((q, index) => {
                                const questionText = q.text || 'No question text';
                                
                                return `
                                    <div style="background: white; padding: 1.25rem; border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 600; font-size: 0.85rem;">
                                                    #${index + 1}
                                                </span>
                                                <span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                                    ${q.subject || 'N/A'}
                                                </span>
                                                <span style="background: #f3e8ff; color: #7e22ce; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                                    ${q.chapter || 'N/A'}
                                                </span>
                                            </div>
                                            <button onclick="removeSelectedQuestion('${q._id}')" 
                                                    style="background: var(--error); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#dc2626'" 
                                                    onmouseout="this.style.background='var(--error)'">
                                                <i class="fas fa-times"></i> Remove
                                            </button>
                                        </div>
                                        <div class="question-text-display" 
                                             style="color: var(--gray-800); 
                                                    font-size: 1rem; 
                                                    line-height: 1.6; 
                                                    word-wrap: break-word; 
                                                    overflow-wrap: break-word;
                                                    padding: 0.75rem;
                                                    background: rgba(0,0,0,0.02);
                                                    border-radius: 8px;">
                                            ${questionText}
                                        </div>
                                        ${q.options && q.options.length > 0 ? `
                                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200); font-size: 0.85rem; color: var(--gray-600);">
                                                <strong>Options:</strong> ${q.options.length} choices â€¢ 
                                                <strong>Answer:</strong> ${q.answer || 'N/A'}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    // Render MathJax for LaTeX expressions
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([container]).catch((err) => {
                            console.log('MathJax rendering error:', err);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('âŒ Error displaying selected questions:', error);
            });
        }

        function removeSelectedQuestion(questionId) {
            selectedQuestions = selectedQuestions.filter(id => id !== questionId);
            document.getElementById('selectedQuestionIds').value = JSON.stringify(selectedQuestions);
            document.getElementById('totalMockQuestions').textContent = selectedQuestions.length;
            displaySelectedQuestions();
            showNotification('Question removed', 'info');
        }

        function createBackup() {
            try {
                console.log('ðŸ’¾ Creating system backup...');

                // Simulate backup creation
                const backupData = {
                    timestamp: new Date().toISOString(),
                    settings: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
                    userCount: 1247, // Mock data
                    questionCount: 2847, // Mock data
                    version: '1.0.0'
                };

                // Create downloadable backup file
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = `edusphere-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Clean up
                URL.revokeObjectURL(url);

                console.log('âœ… Backup created successfully');
                showNotification('ðŸ’¾ Backup created and downloaded successfully!', 'success');

            } catch (error) {
                console.error('âŒ Error creating backup:', error);
                showNotification('âŒ Error creating backup!', 'error');
            }
        }

        // Navigation highlighting function
        function updateNavigationHighlight(sectionId) {
            // Remove active class from all navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to the corresponding navigation button
            let targetButton = null;

            if (sectionId === 'adminSection') {
                targetButton = document.getElementById('adminNavBtn');
            } else {
                // For other sections, find by data-section attribute
                targetButton = document.querySelector(`[data-section="${sectionId}"]`);
            }

            if (targetButton) {
                targetButton.classList.add('active');
                console.log('âœ… Navigation button highlighted:', sectionId);
            } else {
                console.warn('âš ï¸ No navigation button found for section:', sectionId);
            }
        }

        // Admin Password Protection Functions
        function showAdminPasswordPrompt() {
            document.getElementById('adminPasswordModal').style.display = 'flex';
            document.getElementById('adminPassword').focus();
            // Clear any previous error
            document.getElementById('adminPasswordError').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function closeAdminPasswordModal() {
            document.getElementById('adminPasswordModal').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPasswordError').style.display = 'none';
        }

        function handleAdminPasswordKeypress(event) {
            if (event.key === 'Enter') {
                verifyAdminPassword();
            }
        }

        async function verifyAdminPassword() {
            const password = document.getElementById('adminPassword').value;

            if (!password) {
                document.getElementById('adminPasswordError').style.display = 'block';
                document.getElementById('adminPasswordError').textContent = 'Please enter the admin password';
                return;
            }

            try {
                const response = await fetch('/api/admin/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    // Password is correct, close modal and show admin panel
                    closeAdminPasswordModal();
                    showSection('adminSection');
                    showNotification('ðŸ”“ Admin Access Granted! Welcome to Admin Panel!', 'success');

                    // Store admin access in localStorage for this session
                    localStorage.setItem('adminAccess', 'true');
                    localStorage.setItem('adminAccessTime', Date.now().toString());
                    localStorage.setItem('adminToken', data.token);

                    // Initialize admin panel
                    setTimeout(() => {
                        loadAdminPanel();
                        showAdminTab('users');
                    }, 100);

                } else {
                    // Password is incorrect, show error
                    document.getElementById('adminPasswordError').style.display = 'block';
                    document.getElementById('adminPasswordError').textContent = data.error || 'Invalid password';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();

                    // Shake animation for the modal
                    const modal = document.querySelector('#adminPasswordModal .modal-content');
                    modal.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        modal.style.animation = '';
                    }, 500);

                    showNotification('âŒ Incorrect admin password!', 'error');
                }
            } catch (error) {
                console.error('Error verifying admin password:', error);
                document.getElementById('adminPasswordError').style.display = 'block';
                document.getElementById('adminPasswordError').textContent = 'Network error. Please try again.';
                showNotification('âŒ Network error. Please try again.', 'error');
            }
        }



        // Function to handle admin button click
        function handleAdminButtonClick() {
            // Always show password prompt - no caching
            showAdminPasswordPrompt();
        }

        // Function to load admin panel data
        function loadAdminPanel() {
            console.log('ðŸ”§ Loading admin panel data...');

            // Load user management data
            loadUserManagement();

            // Load question management data  
            loadQuestionManagement();

            console.log('âœ… Admin panel data loaded');
        }

        // Enhanced Question Modal Functions
        function showEnhancedQuestionModal() {
            console.log('âœ¨ Opening enhanced question modal...');
            const modal = document.getElementById('enhancedQuestionModal');
            if (modal) {
                modal.style.display = 'flex';
                // Reset to first tab
                showEnhancedTab('basic');
                
                // Add language change handler
                const languageSelect = document.getElementById('enhancedLanguage');
                if (languageSelect) {
                    languageSelect.addEventListener('change', function() {
                        const isGujarati = this.value === 'gu';
                        const textAreas = [
                            'enhancedQuestionText',
                            'enhancedOptionA', 'enhancedOptionB', 'enhancedOptionC', 'enhancedOptionD',
                            'enhancedSolution', 'enhancedExplanation', 'enhancedHints', 'enhancedReferences'
                        ];
                        
                        textAreas.forEach(id => {
                            const element = document.getElementById(id);
                            if (element) {
                                if (isGujarati) {
                                    element.classList.add('lang-gu', 'gujarati-text');
                                    element.setAttribute('lang', 'gu');
                                } else {
                                    element.classList.remove('lang-gu', 'gujarati-text');
                                    element.removeAttribute('lang');
                                }
                            }
                        });
                        
                        console.log(`ðŸŒ Language changed to: ${isGujarati ? 'Gujarati' : 'English'}`);
                    });
                }
                
                console.log('âœ… Enhanced question modal opened');
            } else {
                console.error('âŒ Enhanced question modal not found');
                showNotification('Enhanced question modal not found', 'error');
            }
        }

        function closeEnhancedQuestionModal() {
            console.log('âŒ Closing enhanced question modal...');
            const modal = document.getElementById('enhancedQuestionModal');
            if (modal) {
                modal.style.display = 'none';
                // Clear all form fields
                modal.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.type !== 'submit' && field.type !== 'button') {
                        field.value = '';
                    }
                });
                console.log('âœ… Enhanced question modal closed and form cleared');
            }
        }

        function showEnhancedTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.enhanced-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.enhanced-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const tabContent = document.getElementById(`enhanced-${tabName}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Add active class to selected tab
            const tab = document.querySelector(`[data-tab="${tabName}"]`);
            if (tab) {
                tab.classList.add('active');
            }

            console.log(`ðŸ“‹ Switched to enhanced tab: ${tabName}`);
        }

        async function saveEnhancedQuestion() {
            // Determine question type
            const isMCQ = document.getElementById('mcqOptionsContainer').style.display !== 'none';

            // Validate required fields based on question type
            let requiredFields = [
                'enhancedSubject', 'enhancedDifficulty', 'enhancedChapter', 'enhancedQuestionText', 'enhancedSolution'
            ];

            if (isMCQ) {
                requiredFields.push('enhancedOptionA', 'enhancedOptionB', 'enhancedOptionC', 'enhancedOptionD', 'enhancedCorrectAnswer');
            } else {
                requiredFields.push('enhancedNumericalAnswer');
            }

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    const fieldName = fieldId.replace('enhanced', '').replace(/([A-Z])/g, ' $1').trim();
                    showNotification(`Please fill in: ${fieldName}`, 'error');
                    if (field) {
                        showEnhancedTab(field.closest('.enhanced-tab-content').id.replace('enhanced-', '').replace('-tab', ''));
                        field.focus();
                    }
                    return;
                }
            }

            const questionData = {
                examType: 'jee', // Default value
                subject: document.getElementById('enhancedSubject').value,
                class: '11', // Default value
                chapter: document.getElementById('enhancedChapter').value,
                difficulty: document.getElementById('enhancedDifficulty').value,
                language: document.getElementById('enhancedLanguage')?.value || 'en', // Language field
                enhanced: true,
                tags: document.getElementById('enhancedTags')?.value.split(',').map(tag => tag.trim()).filter(tag => tag) || [],
                question: {
                    text: document.getElementById('enhancedQuestionText').value,
                    solution: document.getElementById('enhancedSolution').value,
                    explanation: document.getElementById('enhancedExplanation')?.value || '',
                    hints: document.getElementById('enhancedHints')?.value || '',
                    references: document.getElementById('enhancedReferences')?.value || ''
                }
            };

            if (isMCQ) {
                questionData.question.options = [
                    document.getElementById('enhancedOptionA').value,
                    document.getElementById('enhancedOptionB').value,
                    document.getElementById('enhancedOptionC').value,
                    document.getElementById('enhancedOptionD').value
                ];
                questionData.question.answer = document.getElementById('enhancedCorrectAnswer').value;
            } else {
                questionData.question.options = [];
                questionData.question.answer = document.getElementById('enhancedNumericalAnswer').value;
            }

            try {
                console.log('ðŸ“¤ Sending question data:', questionData);
                console.log('ðŸ·ï¸ Tags:', questionData.tags);
                console.log('ðŸ“š References:', questionData.question.references);
                console.log('ðŸ’¡ Hints:', questionData.question.hints);

                const response = await fetch('/api/questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify(questionData)
                });

                const data = await response.json();

                if (data.success) {
                    // Show the server's message which indicates if multiple questions were created
                    showNotification(`âœ¨ ${data.message}`, 'success');
                    console.log('âœ… Question(s) saved:', data.questions || [data.question]);

                    // Log the tags to verify they're being saved
                    const savedQuestions = data.questions || [data.question];
                    savedQuestions.forEach((q, i) => {
                        console.log(`ðŸ“‹ Question ${i + 1} tags:`, q.tags);
                        console.log(`ðŸ’¡ Question ${i + 1} hints:`, q.hints);
                        console.log(`ðŸ“š Question ${i + 1} references:`, q.references);
                    });

                    closeEnhancedQuestionModal();
                    loadQuestionManagement(); // Reload questions
                } else {
                    showNotification(data.error || 'Error saving enhanced question', 'error');
                }
            } catch (error) {
                console.error('Error saving enhanced question:', error);
                showNotification('Network error saving enhanced question', 'error');
            }
        }

        function previewEnhancedQuestion() {
            // Collect all form data
            const questionData = {
                examType: 'jee',
                subject: document.getElementById('enhancedSubject')?.value || '',
                class: '11',
                difficulty: document.getElementById('enhancedDifficulty')?.value || '',
                chapter: document.getElementById('enhancedChapter')?.value || '',
                language: document.getElementById('enhancedLanguage')?.value || 'en', // Language field
                tags: document.getElementById('enhancedTags')?.value.split(',').map(tag => tag.trim()).filter(tag => tag) || [],
                text: document.getElementById('enhancedQuestionText')?.value || '',
                options: [
                    document.getElementById('enhancedOptionA')?.value || '',
                    document.getElementById('enhancedOptionB')?.value || '',
                    document.getElementById('enhancedOptionC')?.value || '',
                    document.getElementById('enhancedOptionD')?.value || ''
                ],
                answer: document.getElementById('enhancedCorrectAnswer')?.value || '',
                solution: document.getElementById('enhancedSolution')?.value || '',
                explanation: document.getElementById('enhancedExplanation')?.value || '',
                hints: document.getElementById('enhancedHints')?.value || '',
                references: document.getElementById('enhancedReferences')?.value || '',
                enhanced: true
            };

            // Validate required fields
            if (!questionData.text) {
                showNotification('Please enter question text to preview', 'error');
                return;
            }

            // Generate preview HTML that matches question bank display
            const previewHTML = generateQuestionPreview(questionData);
            
            // Show preview modal
            document.getElementById('previewModalBody').innerHTML = previewHTML;
            document.getElementById('enhancedQuestionPreviewModal').style.display = 'flex';
            
            // Re-render MathJax if present
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('previewModalBody')]).catch((err) => {
                    console.log('MathJax rendering error:', err);
                });
            }
        }

        function generateQuestionPreview(question) {
            // Determine if question is in Gujarati
            const isGujarati = question.language === 'gu';
            const langClass = isGujarati ? 'lang-gu gujarati-text' : '';
            const langAttr = isGujarati ? 'lang="gu"' : '';
            
            // Create exact replica of question bank display
            return `
                <div class="question-bank-item ${langClass}" ${langAttr} style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-200); margin-bottom: 1rem; transition: all 0.3s ease;">
                    
                    <!-- Question Header - Exact match to question bank -->
                    <div class="test-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div class="test-title" style="font-size: 1.2rem; font-weight: 600; color: var(--gray-800);">
                            <i class="fas fa-eye" style="color: var(--primary); margin-right: 0.5rem;"></i>
                            Question Preview
                        </div>
                        <div class="test-difficulty difficulty-${question.difficulty}" style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; background: ${getDifficultyColor(question.difficulty)}; color: white;">
                            ${question.difficulty}
                        </div>
                    </div>
                    
                    <!-- Meta Tags - Exact match to question bank -->
                    <div class="question-meta" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <span class="meta-tag subject" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
                            <i class="fas fa-book" style="margin-right: 0.25rem;"></i>
                            ${question.subject.charAt(0).toUpperCase() + question.subject.slice(1)}
                        </span>
                        <span class="meta-tag chapter" style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
                            <i class="fas fa-bookmark" style="margin-right: 0.25rem;"></i>
                            ${question.chapter}
                        </span>
                        ${isGujarati ? '<span class="meta-tag language lang-gu" style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;"><i class="fas fa-language" style="margin-right: 0.25rem;"></i>àª—à«àªœàª°àª¾àª¤à«€</span>' : ''}
                        ${question.enhanced ? '<span class="meta-tag enhanced" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;"><i class="fas fa-star" style="margin-right: 0.25rem;"></i>Enhanced</span>' : ''}
                    </div>
                    
                    <!-- Question Text - With proper styling -->
                    <div class="question-text ${langClass}" ${langAttr} style="font-size: 1.1rem; line-height: 1.6; color: var(--gray-800); margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary);">
                        ${preserveLineBreaks(question.text)}
                    </div>
                    
                    <!-- Options - Exact match to question bank styling -->
                    ${question.options && question.options.length > 0 && question.options[0] ? `
                        <div class="question-options" style="margin-bottom: 1.5rem;">
                            ${question.options.map((option, i) => `
                                <div class="option-item ${String.fromCharCode(65 + i) === question.answer ? 'correct' : ''}" style="
                                    padding: 1rem; 
                                    margin-bottom: 0.75rem; 
                                    border: 2px solid ${String.fromCharCode(65 + i) === question.answer ? '#10b981' : 'var(--gray-200)'}; 
                                    border-radius: 12px; 
                                    background: ${String.fromCharCode(65 + i) === question.answer ? 'rgba(16, 185, 129, 0.05)' : 'white'};
                                    transition: all 0.3s ease;
                                    position: relative;
                                ">
                                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                        <div style="
                                            width: 32px; 
                                            height: 32px; 
                                            border-radius: 50%; 
                                            background: ${String.fromCharCode(65 + i) === question.answer ? '#10b981' : 'var(--gray-200)'}; 
                                            color: ${String.fromCharCode(65 + i) === question.answer ? 'white' : 'var(--gray-600)'}; 
                                            display: flex; 
                                            align-items: center; 
                                            justify-content: center; 
                                            font-weight: 600;
                                            flex-shrink: 0;
                                        ">
                                            ${String.fromCharCode(65 + i)}
                                        </div>
                                        <div style="flex: 1; line-height: 1.5;">
                                            ${preserveLineBreaks(option)}
                                        </div>
                                        ${String.fromCharCode(65 + i) === question.answer ? '<i class="fas fa-check-circle" style="position: absolute; top: 0.75rem; right: 0.75rem; color: #10b981; font-size: 1.2rem;"></i>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Solution Section -->
                    ${question.solution ? `
                        <div class="solution-section" style="background: rgba(59, 130, 246, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #3b82f6; transition: all 0.3s ease;">
                            <h4 style="margin-bottom: 1rem; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> 
                                Detailed Solution
                            </h4>
                            <div style="line-height: 1.6; color: var(--gray-700); font-size: 1rem;">
                                ${preserveLineBreaks(question.solution)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Explanation Section -->
                    ${question.explanation ? `
                        <div class="explanation-section" style="background: rgba(139, 92, 246, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #8b5cf6; transition: all 0.3s ease;">
                            <h4 style="margin-bottom: 1rem; color: #8b5cf6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                <i class="fas fa-info-circle"></i> 
                                Explanation
                            </h4>
                            <div style="line-height: 1.6; color: var(--gray-700); font-size: 1rem;">
                                ${preserveLineBreaks(question.explanation)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Hints Section -->
                    ${question.hints ? `
                        <div class="hints-section" style="background: rgba(245, 158, 11, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #f59e0b; transition: all 0.3s ease;">
                            <h4 style="margin-bottom: 1rem; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> 
                                Helpful Hints
                            </h4>
                            <div style="line-height: 1.6; color: var(--gray-700); font-size: 1rem;">
                                ${preserveLineBreaks(question.hints)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- References Section -->
                    ${question.references ? `
                        <div class="question-references" style="margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6; border-radius: 0 12px 12px 0; transition: all 0.3s ease;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: #3b82f6; font-weight: 600; font-size: 1rem;">
                                <i class="fas fa-book"></i>
                                Study References
                            </div>
                            <div style="color: #374151; font-size: 0.9rem; line-height: 1.5;">
                                ${preserveLineBreaks(question.references)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Tags Section -->
                    ${question.tags && question.tags.length > 0 ? `
                        <div class="tags-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: var(--gray-600); font-weight: 500; font-size: 0.9rem;">
                                <i class="fas fa-tags"></i>
                                Tags:
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${question.tags.map(tag => `
                                    <span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.4rem 0.8rem; border-radius: 16px; font-size: 0.8rem; font-weight: 500; border: 1px solid rgba(139, 92, 246, 0.2);">
                                        #${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Preview Footer -->
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--gray-200); display: flex; justify-content: between; align-items: center;">
                        <div style="color: var(--gray-500); font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle"></i>
                            This is how your question will appear in the question bank
                        </div>
                    </div>
                </div>
            `;
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case 'easy': return '#10b981';
                case 'medium': return '#f59e0b';
                case 'hard': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function closePreviewModal() {
            document.getElementById('enhancedQuestionPreviewModal').style.display = 'none';
        }

        function editFromPreview() {
            closePreviewModal();
            showNotification('Continue editing your question', 'info');
        }

        // Enhanced Question Helper Functions
        function insertMath(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                const cursorPos = field.selectionStart;
                const textBefore = field.value.substring(0, cursorPos);
                const textAfter = field.value.substring(field.selectionEnd);

                const mathTemplate = '$x^2$';
                field.value = textBefore + mathTemplate + textAfter;

                // Position cursor inside the math expression
                field.focus();
                field.setSelectionRange(cursorPos + 1, cursorPos + 3);

                showNotification('Math expression template inserted', 'success');
            }
        }

        function insertSymbol(fieldId) {
            const symbols = ['Î±', 'Î²', 'Î³', 'Î´', 'Îµ', 'Î¸', 'Î»', 'Î¼', 'Ï€', 'Ïƒ', 'Ï†', 'Ï‰', 'âˆž', 'âˆ‘', 'âˆ«', 'âˆ‚', 'âˆš', 'Â±', 'â‰¤', 'â‰¥', 'â‰ ', 'â‰ˆ', 'âˆ', 'âˆ´', 'âˆµ'];
            const symbol = symbols[Math.floor(Math.random() * symbols.length)];

            const field = document.getElementById(fieldId);
            if (field) {
                const cursorPos = field.selectionStart;
                const textBefore = field.value.substring(0, cursorPos);
                const textAfter = field.value.substring(field.selectionEnd);

                field.value = textBefore + symbol + textAfter;
                field.focus();
                field.setSelectionRange(cursorPos + 1, cursorPos + 1);

                showNotification(`Symbol ${symbol} inserted`, 'success');
            }
        }

        function addImageToEnhanced(fieldId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const imageRef = `[IMAGE:${file.name}]`;
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value += (field.value ? ' ' : '') + imageRef;
                        showNotification(`Image "${file.name}" reference added`, 'success');
                    }
                }
            };
            input.click();
        }

        function insertStep(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                const cursorPos = field.selectionStart;
                const textBefore = field.value.substring(0, cursorPos);
                const textAfter = field.value.substring(field.selectionEnd);

                const stepTemplate = '\n\nStep 1: \nStep 2: \nStep 3: ';
                field.value = textBefore + stepTemplate + textAfter;

                field.focus();
                field.setSelectionRange(cursorPos + 9, cursorPos + 9);

                showNotification('Step template inserted', 'success');
            }
        }

        // ==================== QUESTION SELECTOR MODAL FUNCTIONS ====================
        
        let selectedQuestionIdsForMockTest = [];
        let allQuestionsForSelector = [];
        let currentExamTypeForSelector = 'jee'; // Default to JEE

        // Open Question Selector Modal
        async function openQuestionSelector() {
            console.log('ðŸ” Opening Question Selector Modal');
            
            // Get exam type from the mock test form
            const examTypeSelect = document.getElementById('mockTestExam');
            if (examTypeSelect && examTypeSelect.value) {
                currentExamTypeForSelector = examTypeSelect.value;
            }
            
            // Show modal
            document.getElementById('questionSelectorModal').style.display = 'flex';
            
            // Load questions
            await loadQuestionsForSelector();
        }

        // Close Question Selector Modal
        function closeQuestionSelector() {
            document.getElementById('questionSelectorModal').style.display = 'none';
        }

        // Load questions for selector
        async function loadQuestionsForSelector() {
            try {
                const subject = document.getElementById('selectorSubject').value;
                const difficulty = document.getElementById('selectorDifficulty').value;
                const chapter = document.getElementById('selectorChapter').value;

                console.log('ðŸ“¥ Loading questions with filters:', {
                    examType: currentExamTypeForSelector,
                    subject,
                    difficulty,
                    chapter
                });

                // Build query parameters - CRITICAL: Include examType
                const params = new URLSearchParams();
                params.append('examType', currentExamTypeForSelector); // MUST filter by exam type
                if (subject) params.append('subject', subject);
                if (difficulty) params.append('difficulty', difficulty);
                if (chapter) params.append('chapter', chapter);

                const response = await fetch(`${API_BASE}/api/questions?${params.toString()}`);
                const data = await response.json();

                console.log(`âœ… Loaded ${data.questions?.length || 0} questions for ${currentExamTypeForSelector}`);

                allQuestionsForSelector = data.questions || [];
                displayQuestionsInSelector();

            } catch (error) {
                console.error('âŒ Error loading questions:', error);
                showNotification('Error loading questions: ' + error.message, 'error');
            }
        }

        // Display questions in selector
        function displayQuestionsInSelector() {
            const container = document.getElementById('questionSelectorList');
            
            if (!allQuestionsForSelector || allQuestionsForSelector.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem; margin: 0;">No questions found</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Try adjusting your filters or add questions to the database</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allQuestionsForSelector.map((q, index) => `
                <div class="question-selector-item ${selectedQuestionIdsForMockTest.includes(q._id) ? 'selected' : ''}" 
                     style="background: white; border: 2px solid ${selectedQuestionIdsForMockTest.includes(q._id) ? 'var(--success)' : 'var(--gray-200)'}; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease;" 
                     onclick="toggleQuestionForMockTest('${q._id}')">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <input type="checkbox" 
                               id="q_${q._id}" 
                               ${selectedQuestionIdsForMockTest.includes(q._id) ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleQuestionForMockTest('${q._id}')"
                               style="width: 20px; height: 20px; cursor: pointer; margin-top: 0.25rem; flex-shrink: 0;">
                        <div style="flex: 1;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                <span style="background: rgba(99, 102, 241, 0.1); color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${q.examType?.toUpperCase() || 'N/A'}</span>
                                <span style="background: rgba(16, 185, 129, 0.1); color: #047857; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${q.subject || 'N/A'}</span>
                                <span style="background: rgba(245, 158, 11, 0.1); color: #92400e; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${q.difficulty || 'N/A'}</span>
                                <span style="background: rgba(59, 130, 246, 0.1); color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${q.chapter || 'N/A'}</span>
                            </div>
                            <div class="question-text" style="font-size: 1rem; line-height: 1.6; color: var(--gray-800); margin-bottom: 0.75rem; white-space: pre-wrap;">
                                <strong>Q${index + 1}.</strong> ${preserveLineBreaks(q.text || 'No question text')}
                            </div>
                            ${q.options && q.options.length > 0 ? `
                                <div style="display: grid; gap: 0.5rem; margin-top: 0.75rem; padding-left: 1rem;">
                                    ${q.options.map((opt, i) => `
                                        <div style="display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.9rem; color: var(--gray-700);">
                                            <span style="font-weight: 600;">${String.fromCharCode(65 + i)})</span>
                                            <span style="white-space: pre-wrap; line-height: 1.5;">${preserveLineBreaks(opt)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200); font-size: 0.85rem; color: var(--gray-600);">
                                <i class="fas fa-check-circle" style="color: var(--success);"></i> Answer: <strong>${q.answer || 'N/A'}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Render LaTeX after DOM update
            if (window.MathJax && window.MathJax.typesetPromise) {
                setTimeout(() => {
                    window.MathJax.typesetPromise([container]).catch(err => {
                        console.error('MathJax rendering error:', err);
                    });
                }, 100);
            }
        }

        // Toggle question selection for mock test
        function toggleQuestionForMockTest(questionId) {
            const index = selectedQuestionIdsForMockTest.indexOf(questionId);
            if (index > -1) {
                selectedQuestionIdsForMockTest.splice(index, 1);
            } else {
                selectedQuestionIdsForMockTest.push(questionId);
            }
            
            // Update checkbox
            const checkbox = document.getElementById(`q_${questionId}`);
            if (checkbox) {
                checkbox.checked = selectedQuestionIdsForMockTest.includes(questionId);
            }
            
            // Update count
            document.getElementById('selectedCount').textContent = selectedQuestionIdsForMockTest.length;
            
            console.log('ðŸ“ Selected questions:', selectedQuestionIdsForMockTest.length);
        }

        // Filter questions for selector
        async function filterQuestionsForSelector() {
            await loadQuestionsForSelector();
        }

        // Update chapter dropdown based on subject
        async function updateChapterDropdown() {
            const subject = document.getElementById('selectorSubject').value;
            const chapterSelect = document.getElementById('selectorChapter');
            
            if (!subject) {
                chapterSelect.innerHTML = '<option value="">All Chapters</option>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/chapters?examType=${currentExamTypeForSelector}&subject=${subject}`);
                const data = await response.json();
                
                chapterSelect.innerHTML = '<option value="">All Chapters</option>';
                if (data.chapters && data.chapters.length > 0) {
                    data.chapters.forEach(chapter => {
                        chapterSelect.innerHTML += `<option value="${chapter.name}">${chapter.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
            }
        }

        // Confirm question selection
        function confirmQuestionSelection() {
            if (selectedQuestionIdsForMockTest.length === 0) {
                showNotification('Please select at least one question', 'warning');
                return;
            }

            // Update the hidden input
            document.getElementById('selectedQuestionIds').value = JSON.stringify(selectedQuestionIdsForMockTest);
            
            // Update the display
            document.getElementById('totalMockQuestions').textContent = selectedQuestionIdsForMockTest.length;
            
            // Update the selected questions display
            const displayContainer = document.getElementById('selectedQuestionsDisplay');
            displayContainer.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--primary);">
                            <i class="fas fa-check-circle"></i> ${selectedQuestionIdsForMockTest.length} Questions Selected
                        </h4>
                        <button class="btn btn-sm btn-secondary" onclick="openQuestionSelector()">
                            <i class="fas fa-edit"></i> Edit Selection
                        </button>
                    </div>
                    <p style="color: var(--gray-600); margin: 0; font-size: 0.9rem;">
                        Questions have been selected. You can now create the mock test.
                    </p>
                </div>
            `;
            
            closeQuestionSelector();
            showNotification(`${selectedQuestionIdsForMockTest.length} questions selected successfully!`, 'success');
        }

        // Question Type Functions
        function setQuestionType(type) {
            // Update button styles
            const mcqBtn = document.getElementById('mcqTypeBtn');
            const numericalBtn = document.getElementById('numericalTypeBtn');

            if (type === 'mcq') {
                mcqBtn.style.background = 'var(--primary)';
                mcqBtn.style.color = 'white';
                mcqBtn.style.borderColor = 'var(--primary)';
                numericalBtn.style.background = 'white';
                numericalBtn.style.color = 'var(--gray-700)';
                numericalBtn.style.borderColor = 'var(--gray-300)';

                // Show MCQ options
                document.getElementById('mcqOptionsContainer').style.display = 'block';
                document.getElementById('numericalAnswerContainer').style.display = 'none';
            } else {
                numericalBtn.style.background = 'var(--primary)';
                numericalBtn.style.color = 'white';
                numericalBtn.style.borderColor = 'var(--primary)';
                mcqBtn.style.background = 'white';
                mcqBtn.style.color = 'var(--gray-700)';
                mcqBtn.style.borderColor = 'var(--gray-300)';

                // Show numerical answer
                document.getElementById('mcqOptionsContainer').style.display = 'none';
                document.getElementById('numericalAnswerContainer').style.display = 'block';
            }
        }

        // LaTeX Dropdown Functions
        function toggleLatexDropdown(fieldId) {
            // Close all other dropdowns first
            document.querySelectorAll('.latex-dropdown').forEach(dropdown => {
                if (dropdown.id !== `latexDropdown-${fieldId}`) {
                    dropdown.classList.remove('active');
                }
            });

            // Create dropdown if it doesn't exist
            let dropdown = document.getElementById(`latexDropdown-${fieldId}`);
            if (!dropdown) {
                dropdown = createLatexDropdown(fieldId);
            }

            // Toggle current dropdown
            dropdown.classList.toggle('active');

            // Close dropdown when clicking outside
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!e.target.closest('.latex-dropdown-container')) {
                            dropdown.classList.remove('active');
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 100);
            }
        }

        function createLatexDropdown(fieldId) {
            const container = document.querySelector(`[onclick*="${fieldId}"]`).parentElement;
            if (!container.classList.contains('latex-dropdown-container')) {
                container.classList.add('latex-dropdown-container');
            }

            const dropdown = document.createElement('div');
            dropdown.className = 'latex-dropdown';
            dropdown.id = `latexDropdown-${fieldId}`;
            dropdown.innerHTML = `
                <div class="latex-category">
                    <h5>Basic Math</h5>
                    <div class="latex-options">
                        <button onclick="insertLatex('${fieldId}', 'x^2')" class="latex-option">
                            <span class="latex-preview">xÂ²</span>
                            <span class="latex-code">x^2</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', 'x_1')" class="latex-option">
                            <span class="latex-preview">xâ‚</span>
                            <span class="latex-code">x_1</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\frac{a}{b}')" class="latex-option">
                            <span class="latex-preview">a/b</span>
                            <span class="latex-code">\\frac{a}{b}</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\sqrt{x}')" class="latex-option">
                            <span class="latex-preview">âˆšx</span>
                            <span class="latex-code">\\sqrt{x}</span>
                        </button>
                    </div>
                </div>
                <div class="latex-category">
                    <h5>Calculus</h5>
                    <div class="latex-options">
                        <button onclick="insertLatex('${fieldId}', '\\\\int_{a}^{b} f(x) dx')" class="latex-option">
                            <span class="latex-preview">âˆ«áµƒáµ‡ f(x)dx</span>
                            <span class="latex-code">\\\\int_{a}^{b} f(x) dx</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\sum_{i=1}^{n} x_i')" class="latex-option">
                            <span class="latex-preview">Î£áµ¢â‚Œâ‚â¿ xáµ¢</span>
                            <span class="latex-code">\\\\sum_{i=1}^{n} x_i</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\lim_{x \\\\to \\\\infty}')" class="latex-option">
                            <span class="latex-preview">lim xâ†’âˆž</span>
                            <span class="latex-code">\\\\lim_{x \\\\to \\\\infty}</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\frac{d}{dx}')" class="latex-option">
                            <span class="latex-preview">d/dx</span>
                            <span class="latex-code">\\\\frac{d}{dx}</span>
                        </button>
                    </div>
                </div>
                <div class="latex-category">
                    <h5>Greek Letters</h5>
                    <div class="latex-options">
                        <button onclick="insertLatex('${fieldId}', '\\\\alpha')" class="latex-option">
                            <span class="latex-preview">Î±</span>
                            <span class="latex-code">\\\\alpha</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\beta')" class="latex-option">
                            <span class="latex-preview">Î²</span>
                            <span class="latex-code">\\\\beta</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\gamma')" class="latex-option">
                            <span class="latex-preview">Î³</span>
                            <span class="latex-code">\\\\gamma</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\pi')" class="latex-option">
                            <span class="latex-preview">Ï€</span>
                            <span class="latex-code">\\\\pi</span>
                        </button>
                    </div>
                </div>
                <div class="latex-category">
                    <h5>Physics</h5>
                    <div class="latex-options">
                        <button onclick="insertLatex('${fieldId}', 'F = ma')" class="latex-option">
                            <span class="latex-preview">F = ma</span>
                            <span class="latex-code">F = ma</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', 'E = mc^2')" class="latex-option">
                            <span class="latex-preview">E = mcÂ²</span>
                            <span class="latex-code">E = mc^2</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', 'v = u + at')" class="latex-option">
                            <span class="latex-preview">v = u + at</span>
                            <span class="latex-code">v = u + at</span>
                        </button>
                        <button onclick="insertLatex('${fieldId}', '\\\\vec{F} = m\\\\vec{a}')" class="latex-option">
                            <span class="latex-preview">Fâƒ— = maâƒ—</span>
                            <span class="latex-code">\\\\vec{F} = m\\\\vec{a}</span>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(dropdown);
            return dropdown;
        }

        function insertLatex(fieldId, latexCode) {
            const field = document.getElementById(fieldId);
            if (field) {
                const cursorPos = field.selectionStart;
                const textBefore = field.value.substring(0, cursorPos);
                const textAfter = field.value.substring(field.selectionEnd);

                // Wrap in $ signs for LaTeX
                const latexExpression = `$${latexCode}$`;
                field.value = textBefore + latexExpression + textAfter;

                // Position cursor after the LaTeX expression
                field.focus();
                field.setSelectionRange(cursorPos + latexExpression.length, cursorPos + latexExpression.length);

                // Close dropdown
                document.getElementById(`latexDropdown-${fieldId}`).classList.remove('active');

                showNotification(`LaTeX expression inserted: ${latexCode}`, 'success');

                // Trigger MathJax rendering if available
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([field.parentElement]).catch((err) => console.log(err));
                }
            }
        }

        // Add Chapter Functions
        function showAddChapterModal() {
            console.log('ðŸ“š Opening add chapter modal...');
            const modal = document.getElementById('addChapterModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('newChapterName').focus();

                console.log('âœ… Add chapter modal opened');
            } else {
                console.error('âŒ Add chapter modal not found');
                showNotification('Add chapter modal not found', 'error');
            }
        }

        function closeAddChapterModal() {
            console.log('âŒ Closing add chapter modal...');
            const modal = document.getElementById('addChapterModal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('newChapterName').value = '';
                console.log('âœ… Add chapter modal closed');
            }
        }



        async function addNewChapter() {
            const chapterName = document.getElementById('newChapterName').value.trim();

            if (!chapterName) {
                showNotification('Please enter a chapter name', 'error');
                return;
            }

            const examType = 'jee'; // Default value
            const subject = document.getElementById('enhancedSubject')?.value || 'physics';

            try {
                console.log(`ðŸ“š Adding new chapter: ${chapterName} for ${examType} - ${subject}`);

                const response = await fetch('/api/chapters', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        examType,
                        subject,
                        name: chapterName,
                        description: `Chapter on ${chapterName}`,
                        icon: 'fa-book'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update the dropdown
                    await updateChapterDropdown();

                    // Select the new chapter
                    selectChapter(data.chapter._id, chapterName);

                    // Close modal
                    closeAddChapterModal();

                    // Show appropriate success message
                    const message = data.chapters && data.chapters.length > 1
                        ? `âœ… Chapter "${chapterName}" added for both JEE and NEET!`
                        : `âœ… Chapter "${chapterName}" added successfully!`;

                    showNotification(message, 'success');
                    console.log('âœ… Chapter added successfully:', data.chapter || data.chapters);
                } else {
                    showNotification(`âŒ Error: ${data.error}`, 'error');
                    console.error('âŒ Error adding chapter:', data.error);
                }
            } catch (error) {
                console.error('âŒ Error adding chapter:', error);
                showNotification('âŒ Failed to add chapter. Please try again.', 'error');
            }
        }

        // Hide all admin tab contents
        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.remove('active');
        });




        function loadUsersData() {
            console.log('Loading users data...');
            // This would typically fetch data from the server
            // For now, we'll use the static data already in the HTML
        }

        function loadQuestionsData() {
            console.log('Loading questions data...');
            const questionsList = document.getElementById('adminQuestionsList');
            if (questionsList) {
                questionsList.innerHTML = `
                    <div class="question-item">
                        <div class="question-info">
                            <h4>What is Newton's First Law of Motion?</h4>
                            <p>Subject: Physics | Difficulty: Easy | Chapter: Laws of Motion</p>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon" onclick="editQuestion('q1')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon danger" onclick="deleteQuestion('q1')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="question-item">
                        <div class="question-info">
                            <h4>Calculate the molecular weight of H2SO4</h4>
                            <p>Subject: Chemistry | Difficulty: Medium | Chapter: Atomic Structure</p>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon" onclick="editQuestion('q2')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon danger" onclick="deleteQuestion('q2')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function loadAnalyticsData() {
            console.log('Loading analytics data...');
            // This would typically load charts and analytics
        }

        function loadSettingsData() {
            console.log('Loading settings data...');
            // This would typically load current system settings
        }



        function editUser(userId) {
            showNotification(`Edit user: ${userId}`, 'info');
        }

        // Dummy functions removed - using real delete functions above

        function filterQuestions() {
            const subject = document.getElementById('subjectFilter').value;
            const difficulty = document.getElementById('difficultyFilter').value;

            console.log('Filtering questions:', { subject, difficulty });
            showNotification('Questions filtered', 'success');
        }



        // Debug function to test sections
        function testSections() {
            console.log('ðŸ§ª Testing sections...');

            const performanceSection = document.getElementById('performanceSection');
            const adminSection = document.getElementById('adminSection');

            console.log('Performance section:', performanceSection ? 'Found' : 'Not found');
            console.log('Admin section:', adminSection ? 'Found' : 'Not found');

            if (performanceSection) {
                console.log('Performance section content length:', performanceSection.innerHTML.length);
                console.log('Performance section display:', window.getComputedStyle(performanceSection).display);
                console.log('Performance section visibility:', window.getComputedStyle(performanceSection).visibility);
            }

            if (adminSection) {
                console.log('Admin section content length:', adminSection.innerHTML.length);
                console.log('Admin section display:', window.getComputedStyle(adminSection).display);
                console.log('Admin section visibility:', window.getComputedStyle(adminSection).visibility);
            }
        }

        // Function to manually test section activation
        function testPerformanceSection() {
            console.log('ðŸ§ª Testing Performance Section...');
            showSection('performanceSection');
        }

        function testAdminSection() {
            console.log('ðŸ§ª Testing Admin Section...');
            showSection('adminSection');
        }

        // Helper functions for easy testing
        function forceShowPerformance() {
            console.log('ðŸš€ Force showing Performance section...');
            const section = document.getElementById('performanceSection');
            if (section) {
                // Hide all other sections
                document.querySelectorAll('.section').forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none';
                });

                // Show performance section
                section.classList.add('active');
                section.style.display = 'block';
                section.style.visibility = 'visible';
                section.style.opacity = '1';

                // Load data
                loadPerformanceData();
                console.log('âœ… Performance section force-activated!');
            }
        }

        // DEBUG FUNCTION REMOVED

        // Call test function after page loads - DISABLED to prevent automatic section switching
        document.addEventListener('DOMContentLoaded', function () {
            // setTimeout(testSections, 2000); // Disabled automatic testing

            // Immediate section debugging
            console.log('ðŸ” Checking sections immediately...');
            const perfSection = document.getElementById('performanceSection');
            const adminSection = document.getElementById('adminSection');

            console.log('Performance section exists:', !!perfSection);
            console.log('Admin section exists:', !!adminSection);

            if (perfSection) {
                console.log('Performance section HTML length:', perfSection.innerHTML.length);
                console.log('Performance section classes:', perfSection.className);
            }

            if (adminSection) {
                console.log('Admin section HTML length:', adminSection.innerHTML.length);
                console.log('Admin section classes:', adminSection.className);
            }

            // Auto-test sections after 3 seconds to show they work
            // Automatic testing disabled to prevent unwanted section switching
            // setTimeout(() => {
            //     console.log('ðŸ§ª Auto-testing sections...');
            //     console.log('ðŸ“Š Testing Performance section in 1 second...');
            //     setTimeout(() => {
            //         forceShowPerformance();
            //         setTimeout(() => {
            //             console.log('ðŸ”§ Testing Admin section in 2 seconds...');
            //             setTimeout(() => {
            //                 forceShowAdmin();
            //             }, 2000);
            //         }, 2000);
            //     }, 1000);
            // }, 3000);

            // Debug functions removed - users must login properly
            console.log('âœ… Application initialized - login required');
        });

        // Custom Test Functions
        function displayCustomTestQuestion() {
            const test = window.currentCustomTest;
            const questionIndex = window.currentCustomQuestionIndex;
            const question = test.questions[questionIndex];

            const container = document.getElementById('customTestQuestions');

            let html = `
                <div class="custom-test-question">
                    <div class="question-header">
                        <span class="question-number">Question ${questionIndex + 1}</span>
                        <div class="question-meta">
                            <span class="difficulty-badge ${question.difficulty}">${question.difficulty}</span>
                            ${question.source ? `<span class="source-badge">${question.source}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="question-text">
                        ${cleanTextWithLineBreaks(question.text)}
                    </div>
                    
                    ${question.references ? `
                        <div class="question-references" style="margin: 1rem 0; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">
                                <i class="fas fa-book"></i>
                                References
                            </div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                                ${cleanTextWithLineBreaks(question.references)}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${question.options && question.options.length > 0 ? `
                        <div class="custom-test-options">
                            ${question.options.map((option, optIndex) => `
                                <label class="custom-test-option ${window.customTestAnswers[questionIndex] === cleanText(option) ? 'selected' : ''}">
                                    <input type="radio" name="customQuestion-${questionIndex}" value="${cleanText(option)}" 
                                           ${window.customTestAnswers[questionIndex] === cleanText(option) ? 'checked' : ''}
                                           onchange="saveCustomTestAnswer(${questionIndex}, this.value)">
                                    <span class="option-letter">${String.fromCharCode(65 + optIndex)}</span>
                                    <span class="option-text">${cleanTextWithLineBreaks(option)}</span>
                                </label>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="numerical-input-container">
                            <label class="numerical-label">Enter your numerical answer:</label>
                            <input type="text" class="numerical-input" 
                                   value="${window.customTestAnswers[questionIndex] || ''}"
                                   onchange="saveCustomTestAnswer(${questionIndex}, this.value)"
                                   placeholder="Enter your answer">
                        </div>
                    `}
                </div>
            `;

            container.innerHTML = html;

            // Update progress
            const progress = ((questionIndex + 1) / test.questions.length) * 100;
            document.getElementById('testProgress').style.width = progress + '%';
            document.getElementById('currentQuestionNum').textContent = questionIndex + 1;

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = questionIndex === 0;
            document.getElementById('nextBtn').style.display = questionIndex === test.questions.length - 1 ? 'none' : 'inline-flex';
            document.getElementById('submitBtn').style.display = questionIndex === test.questions.length - 1 ? 'inline-flex' : 'none';
        }

        function saveCustomTestAnswer(questionIndex, answer) {
            // Initialize answers object if it doesn't exist
            if (!window.customTestAnswers) {
                window.customTestAnswers = {};
            }

            window.customTestAnswers[questionIndex] = answer;
            console.log(`Answer saved for question ${questionIndex}:`, answer);
            console.log('All answers so far:', window.customTestAnswers);

            // Update option styling
            const options = document.querySelectorAll(`input[name="customQuestion-${questionIndex}"]`);
            options.forEach(option => {
                const label = option.closest('.custom-test-option');
                if (option.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        }

        function nextQuestion() {
            if (window.currentCustomQuestionIndex < window.currentCustomTest.questions.length - 1) {
                window.currentCustomQuestionIndex++;
                displayCustomTestQuestion();
            }
        }

        function previousQuestion() {
            if (window.currentCustomQuestionIndex > 0) {
                window.currentCustomQuestionIndex--;
                displayCustomTestQuestion();
            }
        }

        function startCustomTestTimer(seconds) {
            const timerElement = document.getElementById('customTestTimer');
            let timeLeft = seconds;

            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                // Change color when time is running out
                if (timeLeft <= 300) { // 5 minutes
                    timerElement.style.color = '#ef4444';
                } else if (timeLeft <= 600) { // 10 minutes
                    timerElement.style.color = '#f59e0b';
                }

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitCustomTest();
                }

                timeLeft--;
            }, 1000);

            window.customTestTimer = timer;
        }

        function submitCustomTest() {
            console.log('Submitting custom test...');

            if (window.customTestTimer) {
                clearInterval(window.customTestTimer);
            }

            const test = window.currentCustomTest;
            const answers = window.customTestAnswers;

            // Debug logging
            console.log('Test data:', test);
            console.log('Answers data:', answers);

            // Validation checks
            if (!test) {
                console.error('No test data found!');
                showNotification('Error: Test data not found. Please try again.', 'error');
                return;
            }

            if (!test.questions || test.questions.length === 0) {
                console.error('No questions found in test!');
                showNotification('Error: No questions found in test.', 'error');
                return;
            }

            if (!answers) {
                console.warn('No answers found, treating as all unattempted');
                window.customTestAnswers = {};
            }

            // Calculate results with negative marking
            let correct = 0;
            let wrong = 0;
            let attempted = 0;
            let totalMarks = 0;
            let maxMarks = 0;

            test.questions.forEach((question, index) => {
                if (test.negativeMarking) {
                    maxMarks += 4; // JEE/NEET style: +4 for each question
                } else {
                    maxMarks += 1; // No negative marking: +1 for each question
                }

                if (answers[index] !== undefined && answers[index] !== '') {
                    attempted++;
                    if (answers[index] === question.answer) {
                        correct++;
                        if (test.negativeMarking) {
                            totalMarks += 4; // +4 for correct answer
                        } else {
                            totalMarks += 1; // +1 for correct answer
                        }
                    } else {
                        wrong++;
                        if (test.negativeMarking) {
                            totalMarks -= 1; // -1 for wrong answer
                        }
                        // No negative marking: 0 for wrong answer
                    }
                }
                // Unattempted: 0 marks in both cases
            });

            const percentage = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;
            const totalPercentage = maxMarks > 0 ? Math.round((totalMarks / maxMarks) * 100) : 0;
            const marksPercentage = Math.max(0, totalPercentage); // Ensure it doesn't go below 0%

            // Show results
            const resultHtml = `
                <div class="test-results">
                    <div class="results-header">
                        <h2>Test Completed!</h2>
                        <div class="score-circle">
                            <div class="score-number">${marksPercentage}%</div>
                            <div class="score-label">Overall Score</div>
                        </div>
                        <div class="marks-display" style="margin-top: 1rem; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--gray-700);">
                                ${totalMarks} / ${maxMarks} marks
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray-600); margin-top: 0.25rem;">
                                ${test.negativeMarking ? 'JEE/NEET Style (+4, -1)' : 'No Negative Marking (+1, 0)'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-stats">
                        <div class="stat-item">
                            <div class="stat-number" style="color: var(--success);">${correct}</div>
                            <div class="stat-label">Correct</div>
                            <div class="stat-marks">+${test.negativeMarking ? correct * 4 : correct} marks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: var(--error);">${wrong}</div>
                            <div class="stat-label">Wrong</div>
                            <div class="stat-marks">${test.negativeMarking ? '-' + wrong : '0'} marks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: var(--gray-500);">${test.questions.length - attempted}</div>
                            <div class="stat-label">Unattempted</div>
                            <div class="stat-marks">0 marks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: var(--primary);">${attempted}</div>
                            <div class="stat-label">Attempted</div>
                            <div class="stat-marks">${percentage}% accuracy</div>
                        </div>
                    </div>
                    
                    <div class="results-actions">
                        <button class="btn btn-primary" onclick="reviewCustomTest()">
                            <i class="fas fa-eye"></i> Review Answers
                        </button>
                        <button class="btn btn-secondary" onclick="goBackToTestSection()">
                            <i class="fas fa-home"></i> Back to Tests
                        </button>
                        <button class="btn btn-success" onclick="retakeCustomTest()">
                            <i class="fas fa-redo"></i> Retake Test
                        </button>
                    </div>
                </div>
            `;

            // Note: testSection has been removed - results handled differently
            showNotification('Test results will be displayed in Create Test section', 'info');
            if (false) {
                console.error('Test section not found!');
                showNotification('Error: Could not display results.', 'error');
                return;
            }

            // Show success notification
            const scoreMessage = `Test completed! You scored ${marksPercentage}% (${totalMarks}/${maxMarks} marks)`;
            showNotification(scoreMessage, 'success');

            console.log('Test submission completed successfully:', {
                correct,
                wrong,
                attempted,
                totalMarks,
                maxMarks,
                percentage: marksPercentage
            });
        }

        function reviewCustomTest() {
            console.log('Review Answers button clicked');
            // Implementation for reviewing answers
            showNotification('Review functionality will be implemented soon!', 'info');
        }

        function retakeCustomTest() {
            console.log('Retake Test button clicked');
            if (confirm('Are you sure you want to retake this test? Your current progress will be lost.')) {
                // Reset test state
                window.currentCustomQuestionIndex = 0;
                window.customTestAnswers = {};

                // Shuffle questions again for variety
                if (window.currentCustomTest && window.currentCustomTest.questions) {
                    window.currentCustomTest.questions = shuffleArray(window.currentCustomTest.questions);
                    // Restart test
                    startCustomTestWithQuestions(window.currentCustomTest);
                } else {
                    console.error('No current test found to retake');
                    showNotification('Error: No test data found to retake', 'error');
                }
            }
        }

        function endCustomTest() {
            if (confirm('Are you sure you want to end the test? Your progress will be lost.')) {
                if (window.customTestTimer) {
                    clearInterval(window.customTestTimer);
                }
                showSection('testSection');
            }
        }

        // Debug function to check test state
        function debugTestState() {
            console.log('=== TEST STATE DEBUG ===');
            console.log('Current test:', window.currentCustomTest);
            console.log('Current question index:', window.currentCustomQuestionIndex);
            console.log('Answers:', window.customTestAnswers);
            console.log('Test section element:', document.getElementById('testSection'));
            console.log('========================');
        }

        // Add a button to manually submit test for debugging
        function forceSubmitTest() {
            console.log('Force submitting test...');
            debugTestState();
            submitCustomTest();
        }

        // Function to go back to test section - REMOVED (testSection no longer exists)


        // Image Manager Functions
        let selectedQuestionForImage = null;

        function showImageManagerModal() {
            console.log('Opening image manager modal');
            document.getElementById('imageManagerModal').style.display = 'flex';
            loadQuestionsForImageManager();
        }

        function closeImageManagerModal() {
            document.getElementById('imageManagerModal').style.display = 'none';
        }

        function closeQuestionImageModal() {
            document.getElementById('questionImageModal').style.display = 'none';
            selectedQuestionForImage = null;
        }

        function loadQuestionsForImageManager() {
            const container = document.getElementById('questionsForImagesList');
            container.innerHTML = '<p>Loading questions...</p>';

            // Get questions from the questionsData object
            const allQuestions = [];

            // Extract questions from questionsData
            try {
                const questionsData = getQuestionsForChapter('jee', 'physics', 'phy-1');
                if (questionsData && questionsData.length > 0) {
                    questionsData.forEach((q, index) => {
                        allQuestions.push({
                            ...q,
                            id: `phy-1-${index}`,
                            subject: 'physics',
                            chapter: 'Physical World, Units and Measurements'
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }

            if (allQuestions.length === 0) {
                container.innerHTML = '<p>No questions found.</p>';
                return;
            }

            let html = '';
            allQuestions.forEach((question, index) => {
                const needsImage = question.hasImage || question.adminNote;
                const needsTable = question.hasTable;
                const statusIcon = needsImage ? 'ðŸ–¼ï¸' : (needsTable ? 'ðŸ“Š' : 'âœ…');
                const statusText = needsImage ? 'Needs Image' : (needsTable ? 'Needs Table' : 'Complete');

                html += `
                    <div class="question-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${statusIcon}</span>
                                    <span class="badge" style="background: ${needsImage || needsTable ? '#fbbf24' : '#10b981'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                                        ${statusText}
                                    </span>
                                    <span class="badge" style="background: #6366f1; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                                        ${question.subject}
                                    </span>
                                </div>
                                <p style="margin: 0.5rem 0; font-weight: 500; color: #374151;">
                                    ${question.text.substring(0, 150)}${question.text.length > 150 ? '...' : ''}
                                </p>
                                ${question.adminNote ? `<p style="margin: 0.5rem 0; font-size: 0.8rem; color: #f59e0b; font-style: italic;"><i class="fas fa-exclamation-triangle"></i> ${question.adminNote}</p>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-sm btn-primary" onclick="openImageUploadForQuestion(${index}, '${question.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    <i class="fas fa-upload"></i>
                                    ${needsImage || needsTable ? 'Add' : 'Edit'} Media
                                </button>
                                ${question.hasImage ? `<button class="btn btn-sm btn-secondary" onclick="viewQuestionImage('${question.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;"><i class="fas fa-eye"></i> View</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterQuestionsForImages() {
            const subject = document.getElementById('imageFilterSubject').value;
            const type = document.getElementById('imageFilterType').value;

            console.log('Filtering questions:', { subject, type });
            // For now, just reload all questions
            // In a real implementation, you would filter based on the selected criteria
            loadQuestionsForImageManager();
        }

        function openImageUploadForQuestion(questionIndex, questionId) {
            selectedQuestionForImage = { index: questionIndex, id: questionId };

            // Show question info
            const questionsData = getQuestionsForChapter('jee', 'physics', 'phy-1');
            const question = questionsData[questionIndex];

            if (question) {
                document.getElementById('selectedQuestionInfo').innerHTML = `
                    <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Selected Question</h4>
                    <p style="margin: 0; color: #6b7280;">${preserveLineBreaks(question.text)}</p>
                    ${question.adminNote ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #f59e0b;"><i class="fas fa-info-circle"></i> ${question.adminNote}</p>` : ''}
                `;
            }

            document.getElementById('questionImageModal').style.display = 'flex';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File size must be less than 5MB', 'error');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function createTable() {
            const rows = parseInt(document.getElementById('tableRows').value) || 3;
            const cols = parseInt(document.getElementById('tableCols').value) || 3;

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db;">
                    <thead>
                        <tr>
            `;

            // Create header row
            for (let j = 0; j < cols; j++) {
                tableHTML += `<th style="border: 1px solid #d1d5db; padding: 0.5rem; background: #f9fafb;"><input type="text" placeholder="Header ${j + 1}" style="width: 100%; border: none; background: transparent;"></th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            // Create data rows
            for (let i = 0; i < rows - 1; i++) {
                tableHTML += '<tr>';
                for (let j = 0; j < cols; j++) {
                    tableHTML += `<td style="border: 1px solid #d1d5db; padding: 0.5rem;"><input type="text" placeholder="Data ${i + 1},${j + 1}" style="width: 100%; border: none;"></td>`;
                }
                tableHTML += '</tr>';
            }

            tableHTML += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = tableHTML;
            document.getElementById('tableContainer').style.display = 'block';
        }

        function saveQuestionImage() {
            if (!selectedQuestionForImage) {
                showNotification('No question selected', 'error');
                return;
            }

            const imageFile = document.getElementById('questionImageFile').files[0];
            const tableContainer = document.getElementById('tableContainer');

            if (!imageFile && tableContainer.style.display === 'none') {
                showNotification('Please upload an image or create a table', 'error');
                return;
            }

            // In a real implementation, you would:
            // 1. Upload the image to a server or cloud storage
            // 2. Save the table data to the database
            // 3. Update the question record with the media information

            // For now, just show a success message
            showNotification('Image/Table saved successfully! (Demo mode)', 'success');
            closeQuestionImageModal();
            loadQuestionsForImageManager(); // Refresh the list
        }

        function viewQuestionImage(questionId) {
            // In a real implementation, this would show the actual image
            showNotification('Image viewer would open here (Demo mode)', 'info');
        }

        // ===== ADMIN-ONLY FUNCTIONALITY =====

        // Check if current user is admin and show/hide admin elements
        function checkAdminAccess() {
            // Admin panel is now password-protected, always show admin elements
            const adminElements = document.querySelectorAll('.admin-only');
            const adminNavItem = document.getElementById('adminNavItem');

            console.log('ðŸ” Admin panel is password-protected, showing all admin elements');
            console.log('ðŸ” Found admin elements:', adminElements.length);

            adminElements.forEach(element => {
                element.classList.add('show-admin');
                element.style.display = 'flex';
                element.style.visibility = 'visible';
                element.style.opacity = '1';
            });

            if (adminNavItem) {
                adminNavItem.classList.add('show-admin');
                adminNavItem.style.display = 'flex';
                adminNavItem.style.visibility = 'visible';
                adminNavItem.style.opacity = '1';
            }

            console.log('âœ… Admin elements shown (password-protected)');

            // Add floating button for quick access

        }

        // Force hide admin elements immediately
        function forceHideAdminElements() {
            const adminElements = document.querySelectorAll('.admin-only');
            const adminNavItem = document.getElementById('adminNavItem');

            console.log('ðŸš« Force hiding admin elements...');

            adminElements.forEach(element => {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
                element.style.opacity = '0';
                element.classList.remove('show-admin');
            });

            if (adminNavItem) {
                adminNavItem.style.display = 'none';
                adminNavItem.style.visibility = 'hidden';
                adminNavItem.style.opacity = '0';
                adminNavItem.classList.remove('show-admin');
            }
        }

        // Function to simulate admin login for testing
        function loginAsAdmin() {
            localStorage.setItem('userRole', 'admin');
            localStorage.setItem('authToken', 'admin-token');
            checkAdminAccess();
            console.log('Logged in as admin');
        }

        // Function to simulate student login for testing
        function loginAsStudent() {
            localStorage.setItem('userRole', 'student');
            localStorage.setItem('authToken', 'student-token');
            checkAdminAccess();
            console.log('Logged in as student');
        }

        // Test function to verify admin functionality
        function testAdminFunctionality() {
            console.log('=== TESTING ADMIN FUNCTIONALITY ===');

            // Test as student first
            console.log('1. Testing as student...');
            loginAsStudent();

            setTimeout(() => {
                // Test as admin
                console.log('2. Testing as admin...');
                loginAsAdmin();

                setTimeout(() => {
                    console.log('3. Admin functionality test completed!');
                    console.log('Check the navigation bar - Admin Panel button should now be visible');
                }, 1000);
            }, 2000);
        }

        // Make test functions available globally for console testing
        window.testAdminFunctionality = testAdminFunctionality;
        window.loginAsAdmin = loginAsAdmin;
        window.loginAsStudent = loginAsStudent;

        // Add floating action button for admin quick access


        // Add hover effects

        // Remove floating button for non-admins


        // Call admin check on page load and after login
        document.addEventListener('DOMContentLoaded', function () {
            // First, force hide all admin elements
            forceHideAdminElements();

            // Then check admin access
            setTimeout(() => {
                checkAdminAccess();
            }, 100);

            // Set up navigation button handlers
            setupNavigationHandlers();
        });

        // Also run immediately when script loads (before DOM is ready)
        setTimeout(() => {
            forceHideAdminElements();
            checkAdminAccess();
            updateCloseButtonsToBackButtons();
        }, 50);

        // Update close buttons to be back buttons for better UX
        function updateCloseButtonsToBackButtons() {
            const closeButtons = document.querySelectorAll('.section-close-btn');
            closeButtons.forEach(button => {
                if (button.innerHTML.includes('fas fa-times')) {
                    button.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Dashboard';
                    button.title = 'Back to Dashboard';
                }
            });
        }

        function setupNavigationHandlers() {
            // Handle navigation button clicks
            document.querySelectorAll('[data-section]').forEach(button => {
                button.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });
        }

        // Override the existing login success handler to include admin check
        if (typeof window.showSection === 'function') {
            const originalShowSectionAdmin = window.showSection;
            window.showSection = function (sectionId) {
                originalShowSectionAdmin(sectionId);
                checkAdminAccess();
            };
        }

        // ===== RICH MEDIA SUPPORT FOR QUESTIONS =====

        let uploadedMedia = [];

        // Initialize media upload functionality
        function initializeMediaUpload() {
            const uploadAreas = document.querySelectorAll('.media-upload-section');

            uploadAreas.forEach(area => {
                area.addEventListener('dragover', handleDragOver);
                area.addEventListener('dragleave', handleDragLeave);
                area.addEventListener('drop', handleDrop);
                area.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    input.onchange = (e) => handleFileSelect(e.target.files);
                    input.click();
                });
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileSelect(files);
        }

        function handleFileSelect(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));

            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const mediaItem = {
                        id: Date.now() + Math.random(),
                        type: 'image',
                        data: e.target.result,
                        name: file.name
                    };
                    uploadedMedia.push(mediaItem);
                    displayMediaPreview(mediaItem);
                };
                reader.readAsDataURL(file);
            });
        }

        function displayMediaPreview(mediaItem) {
            const previewContainer = document.getElementById('mediaPreviewContainer') || createMediaPreviewContainer();

            const preview = document.createElement('div');
            preview.className = 'media-preview';
            preview.innerHTML = `
                <img src="${mediaItem.data}" alt="${mediaItem.name}">
                <button class="media-remove-btn" onclick="removeMedia('${mediaItem.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            previewContainer.appendChild(preview);
        }

        function createMediaPreviewContainer() {
            const container = document.createElement('div');
            container.id = 'mediaPreviewContainer';
            container.className = 'media-preview-container';
            container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0;';

            // Insert after upload section
            const uploadSection = document.querySelector('.media-upload-section');
            if (uploadSection) {
                uploadSection.parentNode.insertBefore(container, uploadSection.nextSibling);
            }

            return container;
        }

        function removeMedia(mediaId) {
            uploadedMedia = uploadedMedia.filter(item => item.id !== mediaId);
            const preview = document.querySelector(`[onclick="removeMedia('${mediaId}')"]`).parentElement;
            preview.remove();
        }



        // ===== RICH TEXT EDITOR FOR SOLUTIONS =====

        function initializeRichEditor() {
            const editors = document.querySelectorAll('.rich-editor');

            editors.forEach(editor => {
                const toolbar = editor.querySelector('.editor-toolbar');
                const content = editor.querySelector('.editor-content');

                if (!toolbar || !content) return;

                // Make content editable
                content.contentEditable = true;

                // Add toolbar event listeners
                toolbar.addEventListener('click', (e) => {
                    if (e.target.classList.contains('editor-btn')) {
                        handleEditorCommand(e.target.dataset.command, content);
                    }
                });
            });
        }

        function handleEditorCommand(command, content) {
            content.focus();

            switch (command) {
                case 'bold':
                    document.execCommand('bold');
                    break;
                case 'italic':
                    document.execCommand('italic');
                    break;
                case 'underline':
                    document.execCommand('underline');
                    break;
                case 'insertOrderedList':
                    document.execCommand('insertOrderedList');
                    break;
                case 'insertUnorderedList':
                    document.execCommand('insertUnorderedList');
                    break;
                case 'insertImage':
                    insertImageInEditor(content);
                    break;
                case 'insertMath':
                    insertMathInEditor(content);
                    break;
            }
        }

        function insertImageInEditor(content) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';

                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.insertNode(img);
                        } else {
                            content.appendChild(img);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function insertMathInEditor(content) {
            const mathInput = prompt('Enter LaTeX math expression (e.g., x^2 + y^2 = r^2):');
            if (mathInput) {
                const mathSpan = document.createElement('span');
                mathSpan.innerHTML = `$${mathInput}$`;
                mathSpan.className = 'math-expression';

                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(mathSpan);
                } else {
                    content.appendChild(mathSpan);
                }

                // Re-render MathJax
                if (window.MathJax) {
                    MathJax.typesetPromise([mathSpan]).catch((err) => console.log(err.message));
                }
            }
        }

        // ===== ENHANCED QUESTION CREATION DISABLED =====

        function showEnhancedQuestionForm() {
            console.log('Enhanced Question form disabled');
            return; // Function disabled
        }

        function closeEnhancedQuestionForm() {
            console.log('Enhanced Question form close disabled');
            return; // Function disabled
        }



        async function saveQuestionWithMedia(questionData) {
            console.log('Enhanced Question save with media disabled');
            return; // Function disabled
        }

        // Advanced Enhanced Question Functions - DISABLED



        // Interactive Elements Functions
        function addSlider() {
            const sliderHtml = `
                <div class="interactive-element" style="margin: 1rem 0; padding: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);">
                    <label>Interactive Slider:</label>
                    <input type="range" min="0" max="100" value="50" style="width: 100%; margin: 0.5rem 0;">
                    <span>Value: <span class="slider-value">50</span></span>
                </div>
            `;
            insertInteractiveElement(sliderHtml);
            showNotification('Slider added to question', 'success');
        }

        function addDropdown() {
            const dropdownHtml = `
                <div class="interactive-element" style="margin: 1rem 0; padding: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);">
                    <label>Select an option:</label>
                    <select style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
                        <option>Option 1</option>
                        <option>Option 2</option>
                        <option>Option 3</option>
                    </select>
                </div>
            `;
            insertInteractiveElement(dropdownHtml);
            showNotification('Dropdown added to question', 'success');
        }

        function addCheckbox() {
            const checkboxHtml = `
                <div class="interactive-element" style="margin: 1rem 0; padding: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);">
                    <label><input type="checkbox"> Interactive checkbox option</label>
                </div>
            `;
            insertInteractiveElement(checkboxHtml);
            showNotification('Checkbox added to question', 'success');
        }

        function addDragDrop() {
            const dragDropHtml = `
                <div class="interactive-element" style="margin: 1rem 0; padding: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);">
                    <p>Drag and Drop Area:</p>
                    <div style="display: flex; gap: 1rem;">
                        <div class="drag-item" draggable="true" style="padding: 0.5rem; background: var(--primary); color: white; border-radius: var(--radius-sm); cursor: move;">Item 1</div>
                        <div class="drag-item" draggable="true" style="padding: 0.5rem; background: var(--success); color: white; border-radius: var(--radius-sm); cursor: move;">Item 2</div>
                    </div>
                    <div class="drop-zone" style="margin-top: 1rem; padding: 2rem; border: 2px dashed var(--gray-300); text-align: center;">Drop items here</div>
                </div>
            `;
            insertInteractiveElement(dragDropHtml);
            showNotification('Drag & Drop area added to question', 'success');
        }

        function insertInteractiveElement(html) {
            const questionText = document.getElementById('enhancedQuestionText');
            if (questionText) {
                questionText.value += '\n\n[INTERACTIVE_ELEMENT]\n' + html + '\n[/INTERACTIVE_ELEMENT]\n';
            }
        }



        // Enhanced notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => {
                n.classList.add('hide');
                setTimeout(() => n.remove(), 300);
            });

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icon = getNotificationIcon(type);

            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <p class="notification-text">${message}</p>
                </div>
                <button class="notification-close" onclick="closeNotification(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => notification.classList.add('show'), 50);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                closeNotification(notification);
            }, 5000);
        }

        function closeNotification(notification) {
            notification.classList.remove('show');
            notification.classList.add('hide');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // Test notification function




        function formatText(elementId, format) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (element.tagName === 'TEXTAREA') {
                // For textarea, wrap selected text with HTML/markdown-style formatting
                const start = element.selectionStart;
                const end = element.selectionEnd;
                const selectedText = element.value.substring(start, end);

                let formattedText = selectedText;
                switch (format) {
                    case 'bold':
                        formattedText = `<strong>${selectedText}</strong>`;
                        break;
                    case 'italic':
                        formattedText = `<em>${selectedText}</em>`;
                        break;
                    case 'underline':
                        formattedText = `<u>${selectedText}</u>`;
                        break;
                }

                element.value = element.value.substring(0, start) + formattedText + element.value.substring(end);

                // Move cursor to after the formatted text
                const newCursorPos = start + formattedText.length;
                element.selectionStart = element.selectionEnd = newCursorPos;
                element.focus();
            } else {
                // For contenteditable elements
                document.execCommand(format, false, null);
            }
        }

        // Text alignment function
        function alignText(elementId, alignment) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (element.tagName === 'TEXTAREA') {
                const start = element.selectionStart;
                const end = element.selectionEnd;
                const selectedText = element.value.substring(start, end);

                // If no text is selected, get the current line
                let textToAlign = selectedText;
                let lineStart = start;
                let lineEnd = end;

                if (selectedText === '') {
                    // Find the current line
                    const lines = element.value.split('\n');
                    let currentPos = 0;
                    let currentLine = '';

                    for (let i = 0; i < lines.length; i++) {
                        const lineLength = lines[i].length + 1; // +1 for \n
                        if (currentPos + lineLength > start) {
                            currentLine = lines[i];
                            lineStart = currentPos;
                            lineEnd = currentPos + lines[i].length;
                            break;
                        }
                        currentPos += lineLength;
                    }
                    textToAlign = currentLine;
                }

                let alignedText = '';
                switch (alignment) {
                    case 'left':
                        alignedText = `<div style="text-align: left;">${textToAlign}</div>`;
                        break;
                    case 'center':
                        alignedText = `<div style="text-align: center;">${textToAlign}</div>`;
                        break;
                    case 'right':
                        alignedText = `<div style="text-align: right;">${textToAlign}</div>`;
                        break;
                }

                element.value = element.value.substring(0, lineStart) + alignedText + element.value.substring(lineEnd);

                // Move cursor to after the aligned text
                const newCursorPos = lineStart + alignedText.length;
                element.selectionStart = element.selectionEnd = newCursorPos;
                element.focus();
            } else {
                // For contenteditable elements
                document.execCommand('justify' + alignment.charAt(0).toUpperCase() + alignment.slice(1), false, null);
            }
        }

        function insertNewLine(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (element.tagName === 'TEXTAREA') {
                const start = element.selectionStart;
                const end = element.selectionEnd;

                // Insert literal \n text at the cursor position
                element.value = element.value.substring(0, start) + '\\n' + element.value.substring(end);

                // Move cursor to after the inserted \n
                element.selectionStart = element.selectionEnd = start + 2;
                element.focus();
            } else {
                // For contenteditable elements
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const textNode = document.createTextNode('\\n');
                    range.deleteContents();
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        }

        // Insert mathematical symbols for numerical answers
        function insertMathSymbol(elementId, symbol) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                const start = element.selectionStart;
                const end = element.selectionEnd;

                // Insert the symbol at the cursor position
                element.value = element.value.substring(0, start) + symbol + element.value.substring(end);

                // Move cursor to after the inserted symbol
                const newCursorPos = start + symbol.length;
                element.selectionStart = element.selectionEnd = newCursorPos;
                element.focus();

                showNotification(`Inserted ${symbol}`, 'success');
            }
        }

        // Validate numerical answer format
        function validateNumericalAnswer(answer) {
            if (!answer || answer.trim() === '') {
                return { valid: false, message: 'Answer cannot be empty' };
            }

            // Check for common mathematical expressions
            const validPatterns = [
                /^-?\d+(\.\d+)?$/, // Simple numbers: 42, 3.14, -5.2
                /^-?\d+(\.\d+)?\s*Ã—\s*10\s*\^\s*-?\d+$/, // Scientific notation: 2.5Ã—10^8
                /^-?\d+\/\d+$/, // Fractions: 1/2, 22/7
                /^âˆš\d+(\.\d+)?$/, // Square roots: âˆš2, âˆš25
                /^âˆ›\d+(\.\d+)?$/, // Cube roots: âˆ›8
                /^Ï€(\/\d+)?$/, // Pi expressions: Ï€, Ï€/4
                /^-?\d+(\.\d+)?\s*Ï€$/, // Number with pi: 2Ï€
                /^-?\d+(\.\d+)?\s*Â±\s*\d+(\.\d+)?$/ // Range: 9.8 Â± 0.1
            ];

            const isValid = validPatterns.some(pattern => pattern.test(answer.trim()));

            if (isValid) {
                return { valid: true, message: 'Valid numerical answer format' };
            } else {
                return {
                    valid: false,
                    message: 'Please use a valid numerical format (e.g., 42, 3.14, âˆš2, Ï€/4, 2.5Ã—10^8)'
                };
            }
        }

        // Add real-time validation to numerical answer field
        document.addEventListener('DOMContentLoaded', function () {
            const numericalField = document.getElementById('enhancedNumericalAnswer');
            if (numericalField) {
                numericalField.addEventListener('input', function () {
                    const validation = validateNumericalAnswer(this.value);

                    // Remove existing validation classes
                    this.classList.remove('valid-input', 'invalid-input');

                    if (this.value.trim() !== '') {
                        if (validation.valid) {
                            this.classList.add('valid-input');
                        } else {
                            this.classList.add('invalid-input');
                        }
                    }
                });
            }
        });

        function addImageToEnhanced(targetElementId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgTag = `<img src="${e.target.result}" alt="Uploaded image" style="max-width: 100%; height: auto; margin: 10px 0;">`;
                        const targetElement = document.getElementById(targetElementId);

                        if (targetElement.tagName === 'TEXTAREA') {
                            targetElement.value += imgTag;
                        } else {
                            targetElement.innerHTML += imgTag;
                        }

                        showNotification('Image added successfully!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }



        // Initialize all components when page loads
        document.addEventListener('DOMContentLoaded', function () {
            checkAdminAccess();

            // Enhanced question button creation disabled
            setTimeout(() => {
                console.log('Enhanced Question button creation disabled');
            }, 1000);

            // Admin floating button creation disabled
            setTimeout(() => {
                console.log('Admin floating button creation disabled');
            }, 1500);
        });

        // Simplified LaTeX Modal Functions
        let currentLatexTarget = null;

        function showLatexModal(targetElementId) {
            currentLatexTarget = targetElementId;
            const modal = document.getElementById('latexModal');
            if (modal) {
                modal.style.display = 'flex';
                const input = document.getElementById('latexInput');
                if (input) {
                    input.value = '';

                    // Ensure event listeners are attached
                    input.removeEventListener('input', window.updateLatexPreview);
                    input.removeEventListener('keyup', window.updateLatexPreview);
                    input.addEventListener('input', window.updateLatexPreview);
                    input.addEventListener('keyup', window.updateLatexPreview);

                    input.focus();
                }
                window.updateLatexPreview();
                console.log('âœ… LaTeX modal opened for target:', targetElementId);
            } else {
                console.error('âŒ LaTeX modal not found');
            }
        }



        // Hover effects are handled by CSS


        function closeLatexModal() {
            const modal = document.getElementById('latexModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentLatexTarget = null;
        }

        function insertLatexFromModal() {
            const input = document.getElementById('latexInput');
            const targetField = document.getElementById(currentLatexTarget);

            if (input && targetField && input.value.trim()) {
                const latexExpression = `$${input.value.trim()}$`;
                const cursorPos = targetField.selectionStart || targetField.value.length;
                const textBefore = targetField.value.substring(0, cursorPos);
                const textAfter = targetField.value.substring(targetField.selectionEnd || cursorPos);

                targetField.value = textBefore + latexExpression + textAfter;
                targetField.focus();
                targetField.setSelectionRange(cursorPos + latexExpression.length, cursorPos + latexExpression.length);

                showNotification('LaTeX expression inserted!', 'success');
                closeLatexModal();
            } else {
                showNotification('Please enter a LaTeX expression', 'warning');
            }
        }

        function insertQuickLatex(latex) {
            const input = document.getElementById('latexInput');
            if (input) {
                const cursorPos = input.selectionStart || input.value.length;
                const textBefore = input.value.substring(0, cursorPos);
                const textAfter = input.value.substring(input.selectionEnd || cursorPos);

                input.value = textBefore + latex + textAfter;
                input.focus();
                input.setSelectionRange(cursorPos + latex.length, cursorPos + latex.length);
                window.updateLatexPreview();
            }
        }

        function updateLatexPreview() {
            const input = document.getElementById('latexInput');
            const preview = document.getElementById('latexPreview');

            if (input && preview) {
                if (input.value.trim()) {
                    preview.innerHTML = `$${input.value.trim()}$`;
                    // Trigger MathJax rendering
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([preview]).catch(err => console.log(err));
                    }
                } else {
                    preview.innerHTML = 'Enter LaTeX above to see preview';
                }
            }
        }

        function insertLatex(latex) {
            const input = document.getElementById('latexInput');
            console.log('Inserting LaTeX symbol:', latex);
            console.log('LaTeX input element:', input);

            if (!input) {
                console.error('âŒ LaTeX input element not found');
                return;
            }

            const cursorPos = input.selectionStart || 0;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(input.selectionEnd || cursorPos);
            input.value = textBefore + latex + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + latex.length, cursorPos + latex.length);

            console.log('âœ… LaTeX symbol inserted, updating preview...');
            updateLatexPreview();
        }

        function updateLatexPreview() {
            const input = document.getElementById('latexInput');
            const preview = document.getElementById('latexPreview');

            if (!input || !preview) {
                console.log('LaTeX input or preview element not found');
                return;
            }

            if (input.value.trim()) {
                preview.innerHTML = `$${input.value}$`;
                console.log('Updating LaTeX preview:', input.value);

                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([preview]).then(() => {
                        console.log('âœ… LaTeX rendered successfully');
                    }).catch((err) => {
                        console.error('âŒ LaTeX rendering error:', err);
                        preview.innerHTML = `<span style="color: red;">LaTeX Error: ${input.value}</span>`;
                    });
                } else {
                    console.warn('MathJax not available');
                    preview.innerHTML = `Raw LaTeX: $${input.value}$`;
                }
            } else {
                preview.innerHTML = 'Enter LaTeX above to see preview';
            }
        }

        // Add CSS animations
        const latexModalStyle = document.createElement('style');
        latexModalStyle.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes slideUp {
                from { 
                    opacity: 0;
                    transform: translateY(20px);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .latex-input:focus {
                outline: none !important;
                border-color: #5046e5 !important;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
                background: white !important;
            }
        `;
        document.head.appendChild(latexModalStyle);

        // Test LaTeX functionality



        // Add test button for debugging


        // Remove test buttons when page loads (disabled)


        // Make LaTeX functions globally accessible
        window.showLatexModal = showLatexModal;
        window.closeLatexModal = closeLatexModal;
        window.insertLatex = insertLatex;
        window.updateLatexPreview = updateLatexPreview;


        // Remove Test LaTeX button and Enhanced Question button functionality


        // Override the addLatexTestButton function to prevent button creation

        // Override testLatexFunctionality to disable it

        // Fix LaTeX Modal Functions - Working Implementation
        function insertLatex(latex) {
            console.log('ï¿½ inseertLatex called with:', latex);
            const input = document.getElementById('latexInput');
            if (!input) {
                console.error('âŒ latexInput element not found');
                return;
            }

            const cursorPos = input.selectionStart || input.value.length;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(input.selectionEnd || cursorPos);
            input.value = textBefore + latex + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + latex.length, cursorPos + latex.length);

            // Update preview immediately
            updateLatexPreview();

            console.log('âœ… LaTeX inserted:', latex);
        }

        function updateLatexPreview() {
            console.log('ðŸ”§ updateLatexPreview called');
            const input = document.getElementById('latexInput');
            const preview = document.getElementById('latexPreview');

            if (!input || !preview) {
                console.error('âŒ Preview elements not found:', { input: !!input, preview: !!preview });
                return;
            }

            if (input.value.trim()) {
                const latexCode = `$${input.value.trim()}$`;
                preview.innerHTML = latexCode;
                console.log('ðŸ”§ Rendering LaTeX:', latexCode);

                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([preview]).then(() => {
                        console.log('âœ… MathJax rendered successfully');
                    }).catch((err) => {
                        console.error('âŒ MathJax rendering error:', err);
                        preview.innerHTML = `<span style="color: #ef4444;">LaTeX Error: ${err.message}</span>`;
                    });
                } else {
                    console.warn('âš ï¸ MathJax not available, showing raw LaTeX');
                    preview.innerHTML = `<code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${latexCode}</code>`;
                }
            } else {
                preview.innerHTML = 'Enter LaTeX above to see preview';
                console.log('ðŸ”§ Preview cleared - empty input');
            }
        }







        // Clean, working LaTeX preview function
        window.updateLatexPreview = function () {
            console.log('ï¿½i Clean updateLatexPreview called');
            const input = document.getElementById('latexInput');
            const preview = document.getElementById('latexPreview');

            if (!input || !preview) {
                console.error('âŒ LaTeX elements not found:', { input: !!input, preview: !!preview });
                return;
            }

            const inputValue = input.value.trim();
            console.log('ðŸ“ Input value:', inputValue);

            if (inputValue) {
                // Create LaTeX expression with dollar signs
                const dollarSign = String.fromCharCode(36); // $ character
                const latexExpression = dollarSign + inputValue + dollarSign;
                preview.innerHTML = latexExpression;
                console.log('ðŸ§® Rendering LaTeX:', latexExpression);

                // Trigger MathJax rendering
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([preview]).then(() => {
                        console.log('âœ… MathJax rendering completed successfully');
                    }).catch(err => {
                        console.error('âŒ MathJax rendering error:', err);
                        preview.innerHTML = 'Preview error: ' + err.message;
                    });
                } else {
                    console.warn('âš ï¸ MathJax not available, showing raw LaTeX');
                    preview.innerHTML = 'MathJax not loaded: ' + latexExpression;
                }
            } else {
                preview.innerHTML = 'Enter LaTeX above to see preview';
            }
        };

        // Add event listener for live preview
        document.addEventListener('DOMContentLoaded', function () {
            // Wait a bit for the modal to be ready
            setTimeout(() => {
                const latexInput = document.getElementById('latexInput');
                if (latexInput) {
                    // Remove any existing listeners
                    latexInput.removeEventListener('input', window.updateLatexPreview);
                    latexInput.removeEventListener('keyup', window.updateLatexPreview);

                    // Add fresh listeners
                    latexInput.addEventListener('input', window.updateLatexPreview);
                    latexInput.addEventListener('keyup', window.updateLatexPreview);
                    console.log('âœ… LaTeX input event listeners added');
                }
            }, 500);
        });

        // Test function for LaTeX preview
        window.testLatexPreview = function () {
            const input = document.getElementById('latexInput');
            if (input) {
                input.value = 'x^2 + y^2 = r^2';
                window.updateLatexPreview();
                showNotification('Test LaTeX inserted! Check preview below.', 'info');
            }
        };

        // Override any existing updateLatexPreview functions
        window.updateLatexPreview();

        console.log('âœ… LaTeX Modal loaded with ultra-high z-index (999999)!');
        console.log('ðŸ”§ Enhanced LaTeX functions loaded with working preview!');
        console.log('ðŸ“‹ Available functions: showLatexModal, closeLatexModal, insertLatex, updateLatexPreview, insertLatexFromModal');

        // Additional helper functions for edit modal
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced version of updatePreview for better performance
        const debouncedUpdatePreview = debounce(updatePreview, 300);

        // Auto-save draft functionality
        function saveDraft() {
            const draftData = {
                questionId: document.getElementById('editQuestionId').value,
                examType: document.getElementById('editQExamType').value,
                subject: document.getElementById('editQSubject').value,
                class: document.getElementById('editQClass').value,
                difficulty: document.getElementById('editQDifficulty').value,
                chapter: document.getElementById('editQChapter').value,
                text: document.getElementById('editQText').value,
                optionA: document.getElementById('editQOptionA').value,
                optionB: document.getElementById('editQOptionB').value,
                optionC: document.getElementById('editQOptionC').value,
                optionD: document.getElementById('editQOptionD').value,
                answer: document.getElementById('editQAnswer').value,
                solution: document.getElementById('editQSolution').value,
                explanation: document.getElementById('editQExplanation').value,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('editQuestionDraft', JSON.stringify(draftData));
        }

        // Load draft functionality
        function loadDraft() {
            const draft = localStorage.getItem('editQuestionDraft');
            if (draft) {
                const draftData = JSON.parse(draft);
                const currentQuestionId = document.getElementById('editQuestionId').value;
                
                if (draftData.questionId === currentQuestionId) {
                    if (confirm('A draft was found for this question. Would you like to load it?')) {
                        document.getElementById('editQExamType').value = draftData.examType || '';
                        document.getElementById('editQSubject').value = draftData.subject || '';
                        document.getElementById('editQClass').value = draftData.class || '';
                        document.getElementById('editQDifficulty').value = draftData.difficulty || '';
                        document.getElementById('editQChapter').value = draftData.chapter || '';
                        document.getElementById('editQText').value = draftData.text || '';
                        document.getElementById('editQOptionA').value = draftData.optionA || '';
                        document.getElementById('editQOptionB').value = draftData.optionB || '';
                        document.getElementById('editQOptionC').value = draftData.optionC || '';
                        document.getElementById('editQOptionD').value = draftData.optionD || '';
                        document.getElementById('editQAnswer').value = draftData.answer || '';
                        document.getElementById('editQSolution').value = draftData.solution || '';
                        document.getElementById('editQExplanation').value = draftData.explanation || '';
                        
                        updatePreview();
                        showNotification('Draft loaded successfully!', 'success');
                    }
                }
            }
        }

        // Clear draft
        function clearDraft() {
            localStorage.removeItem('editQuestionDraft');
        }

        // Enhanced keyboard shortcuts for edit modal
        document.addEventListener('keydown', function(e) {
            // Only work when edit modal is open
            if (document.getElementById('editQuestionModal').style.display === 'flex') {
                // Ctrl+S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    updateQuestion();
                }
                
                // Ctrl+P to refresh preview
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    refreshPreview();
                }
                
                // Ctrl+1, Ctrl+2, Ctrl+3 to switch tabs
                if (e.ctrlKey && ['1', '2', '3'].includes(e.key)) {
                    e.preventDefault();
                    const tabs = ['basic', 'content', 'solution'];
                    showEditTab(tabs[parseInt(e.key) - 1]);
                }
                
                // Escape to close modal
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeEditQuestionModal();
                }
            }
        });

        console.log('âœ¨ Enhanced edit modal with preview functionality loaded!');
        console.log('ðŸŽ¯ Keyboard shortcuts: Ctrl+S (save), Ctrl+P (refresh preview), Ctrl+1/2/3 (switch tabs), Esc (close)');

        // File Attachment Functionality
        let attachedFiles = [];
        let processedFileData = [];

        function openFileAttachmentModal() {
            document.getElementById('fileAttachmentModal').style.display = 'flex';
            setupFileDropZone();
        }

        function closeFileAttachmentModal() {
            document.getElementById('fileAttachmentModal').style.display = 'none';
            resetFileModal();
        }

        function setupFileDropZone() {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('fileInput');

            // Click to browse
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain',
                'image/jpeg',
                'image/jpg',
                'image/png',
                'image/gif'
            ];

            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    showNotification(`File "${file.name}" is too large. Max size is 10MB.`, 'error');
                    return;
                }

                if (!allowedTypes.includes(file.type)) {
                    showNotification(`File type "${file.type}" is not supported.`, 'error');
                    return;
                }

                // Check if file already exists
                if (attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    showNotification(`File "${file.name}" is already attached.`, 'warning');
                    return;
                }

                attachedFiles.push(file);
            });

            updateFilesList();
            updateFileInfo();
        }

        function updateFilesList() {
            const container = document.getElementById('filesContainer');
            const selectedFiles = document.getElementById('selectedFilesList');
            const attachButton = document.getElementById('attachButton');

            if (attachedFiles.length === 0) {
                selectedFiles.style.display = 'none';
                attachButton.disabled = true;
                return;
            }

            selectedFiles.style.display = 'block';
            attachButton.disabled = false;

            container.innerHTML = attachedFiles.map((file, index) => {
                const fileType = getFileType(file.type);
                const fileSize = formatFileSize(file.size);
                
                return `
                    <div class="file-item">
                        <div class="file-icon ${fileType}">
                            <i class="fas ${getFileIcon(file.type)}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                        <button class="file-remove" onclick="removeFile(${index})" title="Remove file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            updateFilesList();
            updateFileInfo();
        }

        function updateFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const count = attachedFiles.length;
            const totalSize = attachedFiles.reduce((sum, file) => sum + file.size, 0);

            if (count === 0) {
                fileInfo.textContent = 'No files selected';
            } else {
                fileInfo.textContent = `${count} file${count > 1 ? 's' : ''} selected (${formatFileSize(totalSize)})`;
            }
        }

        function getFileType(mimeType) {
            if (mimeType.includes('pdf')) return 'pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'doc';
            if (mimeType.includes('text')) return 'txt';
            if (mimeType.includes('image')) return 'img';
            return 'txt';
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'fa-file-pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'fa-file-word';
            if (mimeType.includes('text')) return 'fa-file-alt';
            if (mimeType.includes('image')) return 'fa-file-image';
            return 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function attachFiles() {
            if (attachedFiles.length === 0) return;

            const attachButton = document.getElementById('attachButton');
            const originalText = attachButton.innerHTML;
            
            try {
                attachButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                attachButton.disabled = true;

                // Process files
                processedFileData = [];
                
                for (const file of attachedFiles) {
                    const fileData = await processFile(file);
                    processedFileData.push(fileData);
                }

                // Update UI
                updateAttachedFilesPreview();
                closeFileAttachmentModal();
                
                showNotification(`${attachedFiles.length} file(s) attached successfully!`, 'success');
                
            } catch (error) {
                console.error('Error processing files:', error);
                showNotification('Error processing files. Please try again.', 'error');
            } finally {
                attachButton.innerHTML = originalText;
                attachButton.disabled = false;
            }
        }

        async function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        content: e.target.result,
                        extractText: document.getElementById('extractText').checked,
                        analyzeImages: document.getElementById('analyzeImages').checked,
                        summarizeContent: document.getElementById('summarizeContent').checked,
                        detectLanguage: document.getElementById('detectLanguage').checked
                    };
                    
                    resolve(fileData);
                };
                
                // Read as base64 for all file types
                reader.readAsDataURL(file);
            });
        }

        function updateAttachedFilesPreview() {
            const preview = document.getElementById('attachedFilesPreview');
            const list = document.getElementById('attachedFilesList');
            const ultraPreview = document.getElementById('ultraAttachedFilesPreview');
            const ultraList = document.getElementById('ultraAttachedFilesList');

            if (processedFileData.length === 0) {
                if (preview) preview.style.display = 'none';
                if (ultraPreview) ultraPreview.style.display = 'none';
                return;
            }

            const fileChips = processedFileData.map((file, index) => `
                <div class="attached-file-chip">
                    <i class="fas ${getFileIcon(file.type)}"></i>
                    ${file.name}
                </div>
            `).join('');

            // Update both interfaces
            if (preview && list) {
                preview.style.display = 'block';
                list.innerHTML = fileChips;
            }
            
            if (ultraPreview && ultraList) {
                ultraPreview.style.display = 'block';
                ultraList.innerHTML = fileChips;
            }
        }

        function clearAttachedFiles() {
            processedFileData = [];
            updateAttachedFilesPreview();
            showNotification('Attached files cleared', 'info');
        }

        function resetFileModal() {
            attachedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFilesList').style.display = 'none';
            document.getElementById('attachButton').disabled = true;
            updateFileInfo();
        }

        // Update sendMessage function to include file data
        const originalSendMessage = window.sendMessage;
        window.sendMessage = function() {
            const input = document.getElementById('chatInput');
            const message = input?.value?.trim();
            
            if (!message && processedFileData.length === 0) {
                showNotification('Please enter a message or attach files', 'warning');
                return;
            }

            // Create enhanced message with file attachments
            const enhancedMessage = {
                text: message || '',
                files: processedFileData.map(file => ({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: file.content,
                    options: {
                        extractText: file.extractText,
                        analyzeImages: file.analyzeImages,
                        summarizeContent: file.summarizeContent,
                        detectLanguage: file.detectLanguage
                    }
                }))
            };

            // Call original function with enhanced message
            if (typeof originalSendMessage === 'function') {
                originalSendMessage.call(this, enhancedMessage);
            } else {
                // Fallback to basic send
                sendMessageWithFiles(enhancedMessage);
            }

            // Clear attachments after sending
            if (processedFileData.length > 0) {
                clearAttachedFiles();
            }
        };

        async function sendMessageWithFiles(messageData) {
            console.log('ðŸ“Ž Sending message with files:', messageData);
            console.log('ðŸ“Ž Files count:', messageData.files?.length || 0);
            console.log('ðŸ“Ž Message text:', messageData.text);
            
            const input = document.getElementById('chatInput');
            if (input) input.value = '';

            // Add user message to chat
            if (messageData.text) {
                addMessageToChat('user', messageData.text);
            }

            // Show file attachments in chat
            if (messageData.files.length > 0) {
                const fileMessage = `ðŸ“Ž Attached ${messageData.files.length} file(s): ${messageData.files.map(f => f.name).join(', ')}`;
                addMessageToChat('system', fileMessage);
            }

            try {
                // Send to AI with file data
                const response = await fetch(`${API_BASE}/api/ai-guidance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'student-token'}`
                    },
                    body: JSON.stringify({
                        query: messageData.text,
                        files: messageData.files,
                        preferredProvider: 'cohere' // Prioritize Cohere for file processing
                    })
                });

                const data = await response.json();
                console.log('ðŸ“Ž Server response:', data);
                
                if (data.success) {
                    const aiResponse = data.response || data.guidance || 'No response received from AI';
                    addMessageToChat('ai', aiResponse);
                } else {
                    console.error('âŒ Server error:', data.error);
                    addMessageToChat('ai', `Sorry, I encountered an error: ${data.error || 'Unknown error'}. Please try again.`);
                }
            } catch (error) {
                console.error('Error sending message with files:', error);
                addMessageToChat('ai', 'Sorry, I encountered a network error. Please check your connection and try again.');
            }
        }

        console.log('ðŸ“Ž File attachment functionality loaded!');

        // Fix duplicate IDs on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Fix duplicate cohereKey IDs
            const cohereInputs = document.querySelectorAll('#cohereKey');
            if (cohereInputs.length > 1) {
                // The second one should be groqKey
                cohereInputs[1].id = 'groqKey';
                cohereInputs[1].placeholder = 'Groq API Key (gsk_...)';
                
                // Fix the associated button
                const groqButton = cohereInputs[1].parentElement.querySelector('button');
                if (groqButton) {
                    groqButton.onclick = function() { testGroqKey(); };
                    groqButton.textContent = 'Test Groq';
                }
                
                // Fix the label
                const groqLabel = cohereInputs[1].parentElement.parentElement.querySelector('label');
                if (groqLabel) {
                    groqLabel.innerHTML = 'ðŸš€ Groq API Key (Ultra Fast - Priority 2)';
                }
                
                // Fix the description
                const groqDesc = cohereInputs[1].parentElement.parentElement.querySelector('p');
                if (groqDesc) {
                    groqDesc.innerHTML = `Get free API key from: <a href="https://console.groq.com/" target="_blank">console.groq.com</a><br>
                    <strong>âš¡ Speed:</strong> 500+ tokens/sec | <strong>Free:</strong> 14,400 requests/day`;
                }
                
                console.log('âœ… Fixed duplicate cohereKey IDs');
            }
        });

        // ============================================
        // NEW MAKE PAPER FUNCTIONALITY
        // ============================================

        let paperQuestions = [];
        let paperSelectedIds = [];
        let paperFilteredQuestions = [];
        let paperExamType = 'jee';
        let paperSelectedSubject = 'physics';

        function selectPaperExamType(type) {
            paperExamType = type;
            console.log('Selected exam type:', type);
            
            // Update toggle buttons
            const jeeTab = document.getElementById('paperJeeTab');
            const neetTab = document.getElementById('paperNeetTab');
            
            if (!jeeTab || !neetTab) {
                console.warn('Toggle buttons not found');
                return;
            }
            
            if (type === 'jee') {
                // JEE active
                jeeTab.style.background = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
                jeeTab.style.color = 'white';
                jeeTab.style.borderColor = '#6366f1';
                jeeTab.classList.add('active');
                
                neetTab.style.background = 'white';
                neetTab.style.color = '#64748b';
                neetTab.style.borderColor = '#e2e8f0';
                neetTab.classList.remove('active');
                
                // Update third subject to Mathematics
                const thirdName = document.getElementById('thirdSubjectName');
                const thirdLabel = document.getElementById('thirdSubjectLabel');
                const thirdIcon = document.getElementById('thirdSubjectIcon');
                const thirdCard = document.getElementById('thirdSubjectCard');
                
                if (thirdName) thirdName.textContent = 'Mathematics';
                if (thirdLabel) thirdLabel.textContent = 'JEE Mathematics';
                if (thirdIcon) thirdIcon.className = 'fas fa-calculator';
                if (thirdCard) {
                    thirdCard.setAttribute('data-subject', 'mathematics');
                    thirdCard.setAttribute('onclick', "selectPaperSubject('mathematics')");
                }
                
                // Update labels
                const physicsLabel = document.getElementById('physicsLabel');
                const chemistryLabel = document.getElementById('chemistryLabel');
                if (physicsLabel) physicsLabel.textContent = 'JEE Physics';
                if (chemistryLabel) chemistryLabel.textContent = 'JEE Chemistry';
            } else {
                // NEET active
                neetTab.style.background = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
                neetTab.style.color = 'white';
                neetTab.style.borderColor = '#6366f1';
                neetTab.classList.add('active');
                
                jeeTab.style.background = 'white';
                jeeTab.style.color = '#64748b';
                jeeTab.style.borderColor = '#e2e8f0';
                jeeTab.classList.remove('active');
                
                // Update third subject to Biology
                const thirdName = document.getElementById('thirdSubjectName');
                const thirdLabel = document.getElementById('thirdSubjectLabel');
                const thirdIcon = document.getElementById('thirdSubjectIcon');
                const thirdCard = document.getElementById('thirdSubjectCard');
                
                if (thirdName) thirdName.textContent = 'Biology';
                if (thirdLabel) thirdLabel.textContent = 'NEET Biology';
                if (thirdIcon) thirdIcon.className = 'fas fa-dna';
                if (thirdCard) {
                    thirdCard.setAttribute('data-subject', 'biology');
                    thirdCard.setAttribute('onclick', "selectPaperSubject('biology')");
                }
                
                // Update labels
                const physicsLabel = document.getElementById('physicsLabel');
                const chemistryLabel = document.getElementById('chemistryLabel');
                if (physicsLabel) physicsLabel.textContent = 'NEET Physics';
                if (chemistryLabel) chemistryLabel.textContent = 'NEET Chemistry';
            }
            
            // Reset to first subject
            paperSelectedSubject = 'physics';
            updateSubjectCards();
            loadPaperQuestions();
        }

        function selectPaperSubject(subject) {
            paperSelectedSubject = subject;
            updateSubjectCards();
            loadPaperChapters();
            filterPaperQuestions();
        }

        function updateSubjectCards() {
            const cards = document.querySelectorAll('.subject-card');
            cards.forEach(card => {
                const cardSubject = card.getAttribute('data-subject');
                const isActive = cardSubject === paperSelectedSubject;
                
                if (isActive) {
                    card.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
                    card.style.color = 'white';
                    card.style.borderColor = '#3b82f6';
                    card.style.boxShadow = '0 4px 12px rgba(59,130,246,0.3)';
                    
                    const statusDiv = card.querySelector('div:last-child');
                    if (statusDiv) {
                        statusDiv.style.background = 'rgba(255,255,255,0.2)';
                        statusDiv.style.color = 'white';
                        statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Selected';
                    }
                } else {
                    card.style.background = 'white';
                    card.style.color = '#64748b';
                    card.style.borderColor = '#e2e8f0';
                    card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    
                    const statusDiv = card.querySelector('div:last-child');
                    if (statusDiv) {
                        statusDiv.style.background = '#f1f5f9';
                        statusDiv.style.color = '#64748b';
                        statusDiv.innerHTML = 'Click to Select';
                    }
                }
            });
        }

        function loadPaperQuestions() {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Please login first', 'error');
                return;
            }

            const container = document.getElementById('paperQuestionsList');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align:center; padding:4rem; color:#94a3b8;"><i class="fas fa-spinner fa-spin" style="font-size:3rem; margin-bottom:1rem;"></i><p style="font-size:1.1rem;">Loading questions...</p></div>';

            fetch('/api/questions', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.questions) {
                    paperQuestions = data.questions;
                    filterPaperQuestions();
                    loadPaperChapters();
                    showNotification(`Loaded ${paperQuestions.length} questions`, 'success');
                } else {
                    container.innerHTML = '<div style="text-align:center; padding:4rem; color:#ef4444;"><i class="fas fa-exclamation-circle" style="font-size:3rem; margin-bottom:1rem;"></i><p>Failed to load questions</p></div>';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                container.innerHTML = '<div style="text-align:center; padding:4rem; color:#ef4444;"><i class="fas fa-exclamation-circle" style="font-size:3rem; margin-bottom:1rem;"></i><p>Error loading questions</p></div>';
            });
        }

        function loadPaperChapters() {
            // Filter chapters by exam type and selected subject
            const filteredQuestions = paperQuestions.filter(q => {
                if (paperExamType && q.examType && q.examType.toLowerCase() !== paperExamType.toLowerCase()) {
                    return false;
                }
                if (paperSelectedSubject && q.subject !== paperSelectedSubject) {
                    return false;
                }
                return true;
            });
            
            const chapters = [...new Set(filteredQuestions.map(q => q.chapter).filter(c => c))];
            const select = document.getElementById('paperChapterFilter');
            if (select) {
                select.innerHTML = '<option value="">All Chapters</option>' +
                    chapters.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function renderPaperQuestions() {
            const container = document.getElementById('paperQuestionsList');
            if (!container) return;
            
            if (!paperFilteredQuestions || paperFilteredQuestions.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:4rem; color:#94a3b8;"><i class="fas fa-inbox" style="font-size:3rem; margin-bottom:1rem;"></i><p style="font-size:1.1rem;">No questions found</p></div>';
                return;
            }

            container.innerHTML = '';

            paperFilteredQuestions.forEach((q, index) => {
                const isSelected = paperSelectedIds.includes(q._id);
                
                const card = document.createElement('div');
                card.dataset.id = q._id;
                card.className = 'paper-question-card';
                card.style.cssText = `
                    background: ${isSelected ? '#f0f4ff' : 'white'};
                    border: 2px solid ${isSelected ? '#6366f1' : '#e2e8f0'};
                    border-radius: 12px;
                    padding: 1.5rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: ${isSelected ? '0 4px 12px rgba(99,102,241,0.2)' : '0 2px 4px rgba(0,0,0,0.05)'};
                `;

                const diffColors = {
                    'easy': { bg: '#dcfce7', text: '#166534' },
                    'medium': { bg: '#fef3c7', text: '#854d0e' },
                    'hard': { bg: '#fee2e2', text: '#991b1b' }
                };
                const dc = diffColors[q.difficulty] || { bg: '#f1f5f9', text: '#475569' };

                // Build options HTML
                let optionsHTML = '';
                if (q.options && q.options.length > 0) {
                    optionsHTML = `
                        <div style="margin-top: 1rem; display: grid; gap: 0.75rem;">
                            ${q.options.map((opt, i) => {
                                const optLabel = String.fromCharCode(65 + i); // A, B, C, D
                                const isCorrect = q.answer === optLabel;
                                return `
                                    <div style="display: flex; gap: 0.75rem; padding: 0.75rem; background: ${isCorrect ? '#dcfce7' : '#f8fafc'}; border: 1px solid ${isCorrect ? '#10b981' : '#e2e8f0'}; border-radius: 8px;">
                                        <div style="flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%; background: ${isCorrect ? '#10b981' : '#64748b'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;">
                                            ${optLabel}
                                        </div>
                                        <div style="flex: 1; color: #1e293b; line-height: 1.6;">
                                            ${opt || ''}
                                        </div>
                                        ${isCorrect ? '<i class="fas fa-check-circle" style="color: #10b981; font-size: 1.2rem;"></i>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div style="display: flex; gap: 1.25rem; align-items: flex-start;">
                        <div style="flex-shrink: 0; margin-top: 3px;">
                            <input type="checkbox" 
                                   class="paper-checkbox"
                                   ${isSelected ? 'checked' : ''}
                                   style="width: 24px; height: 24px; cursor: pointer; accent-color: #6366f1;">
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                                        ${q.subject || 'N/A'}
                                    </span>
                                    <span style="background: ${dc.bg}; color: ${dc.text}; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                                        ${q.difficulty || 'N/A'}
                                    </span>
                                    ${q.chapter ? `<span style="background: #f3e8ff; color: #6b21a8; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">${q.chapter}</span>` : ''}
                                </div>
                                <span style="background: #f1f5f9; color: #475569; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">
                                    Q${index + 1}
                                </span>
                            </div>
                            <div class="question-text-latex" style="color: #1e293b; font-size: 1.05rem; line-height: 1.8; word-break: break-word; margin-bottom: 0.5rem;">
                                ${q.text || 'No question text'}
                            </div>
                            ${optionsHTML}
                        </div>
                    </div>
                `;

                card.addEventListener('click', function(e) {
                    const checkbox = card.querySelector('.paper-checkbox');
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    togglePaperQuestion(q._id, checkbox.checked);
                });

                container.appendChild(card);
            });

            // Render LaTeX
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch(err => {
                    console.log('MathJax error:', err);
                });
            }

            updatePaperCount();
        }

        function togglePaperQuestion(id, isChecked) {
            if (isChecked) {
                if (!paperSelectedIds.includes(id)) {
                    paperSelectedIds.push(id);
                }
            } else {
                paperSelectedIds = paperSelectedIds.filter(qid => qid !== id);
            }

            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                const isSelected = paperSelectedIds.includes(id);
                card.style.background = isSelected ? '#f0f4ff' : 'white';
                card.style.borderColor = isSelected ? '#6366f1' : '#e2e8f0';
                card.style.boxShadow = isSelected ? '0 4px 12px rgba(99,102,241,0.2)' : '0 2px 4px rgba(0,0,0,0.05)';
            }

            updatePaperCount();
        }

        function updatePaperCount() {
            const countEl = document.getElementById('paperSelectedCount');
            if (countEl) {
                countEl.textContent = paperSelectedIds.length;
            }
        }

        function filterPaperQuestions() {
            const difficulty = document.getElementById('paperDifficultyFilter')?.value || '';
            const chapter = document.getElementById('paperChapterFilter')?.value || '';

            paperFilteredQuestions = paperQuestions.filter(q => {
                // Filter by exam type (JEE/NEET)
                if (paperExamType && q.examType && q.examType.toLowerCase() !== paperExamType.toLowerCase()) {
                    return false;
                }
                
                // Filter by selected subject
                if (paperSelectedSubject && q.subject !== paperSelectedSubject) return false;
                
                // Filter by difficulty
                if (difficulty && q.difficulty !== difficulty) return false;
                
                // Filter by chapter
                if (chapter && q.chapter !== chapter) return false;
                
                return true;
            });

            renderPaperQuestions();
            
            if (paperFilteredQuestions.length === 0) {
                const container = document.getElementById('paperQuestionsList');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:4rem; color:#94a3b8;">
                            <i class="fas fa-inbox" style="font-size:3rem; margin-bottom:1rem;"></i>
                            <p style="font-size:1.1rem;">No questions found for ${paperExamType.toUpperCase()} - ${paperSelectedSubject}</p>
                            <p style="font-size:0.9rem; margin-top:0.5rem;">Try selecting a different subject or exam type</p>
                        </div>
                    `;
                }
            } else {
                showNotification(`Found ${paperFilteredQuestions.length} ${paperExamType.toUpperCase()} questions`, 'info');
            }
        }

        function resetPaperFilters() {
            const diffFilter = document.getElementById('paperDifficultyFilter');
            const chapFilter = document.getElementById('paperChapterFilter');
            
            if (diffFilter) diffFilter.value = '';
            if (chapFilter) chapFilter.value = '';
            
            filterPaperQuestions();
        }

        function selectAllPaper() {
            paperSelectedIds = paperFilteredQuestions.map(q => q._id);
            renderPaperQuestions();
            showNotification(`Selected ${paperSelectedIds.length} questions`, 'success');
        }

        function clearAllPaper() {
            paperSelectedIds = [];
            renderPaperQuestions();
            showNotification('Selection cleared', 'info');
        }

        function goToNextStep() {
            if (paperSelectedIds.length === 0) {
                showNotification('Please select at least one question', 'error');
                return;
            }

            // Update settings page with selection info
            const settingsCount = document.getElementById('settingsSelectedCount');
            const settingsInfo = document.getElementById('settingsExamInfo');
            
            if (settingsCount) settingsCount.textContent = paperSelectedIds.length;
            if (settingsInfo) settingsInfo.textContent = `${paperExamType.toUpperCase()} - ${paperSelectedSubject.charAt(0).toUpperCase() + paperSelectedSubject.slice(1)}`;

            // Navigate to settings page
            showSection('paperSettingsSection');
            showNotification(`âœ… ${paperSelectedIds.length} questions selected!`, 'success');
        }

        function backToPaperSelection() {
            showSection('makePaperSection');
        }

        // ==================== PDF GENERATION WITH HTML TO PDF ====================
        
        // Progress tracking functions
        function showPDFProgress() {
            const modal = document.getElementById('pdfProgressModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hidePDFProgress() {
            const modal = document.getElementById('pdfProgressModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updatePDFProgress(percent, text, details = '') {
            const progressBar = document.getElementById('pdfProgressBar');
            const progressPercent = document.getElementById('pdfProgressPercent');
            const progressText = document.getElementById('pdfProgressText');
            const progressDetails = document.getElementById('pdfProgressDetails');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressPercent) progressPercent.textContent = Math.round(percent) + '%';
            if (progressText) progressText.textContent = text;
            if (progressDetails) progressDetails.textContent = details;
        }

        async function generatePaperPDF() {
            if (paperSelectedIds.length === 0) {
                showNotification('No questions selected', 'error');
                return;
            }

            try {
                const startTime = Date.now();
                showPDFProgress();
                updatePDFProgress(5, 'Initializing...', 'Setting up PDF generator');

                // Get form values
                const schoolName = document.getElementById('schoolName')?.value || 'GYANMANJARI';
                const paperTitle = document.getElementById('paperTitle')?.value || 'MOCK_12-11';
                const examDate = document.getElementById('examDate')?.value || new Date().toISOString().split('T')[0];
                const duration = document.getElementById('examDuration')?.value || '180';
                const totalMarks = document.getElementById('totalMarks')?.value || '100';
                const marksPerQuestion = document.getElementById('marksPerQuestion')?.value || '4';
                const includeAnswers = document.getElementById('includeAnswers')?.checked || false;
                const includeSolutions = document.getElementById('includeSolutions')?.checked || false;
                const showDifficulty = document.getElementById('showDifficulty')?.checked || false;
                const instructions = document.getElementById('paperInstructions')?.value || '';

                // Fetch selected questions
                updatePDFProgress(15, 'Fetching questions...', `Loading ${paperSelectedIds.length} questions from database`);
                const questions = await fetchQuestionsByIds(paperSelectedIds);
                
                if (!questions || questions.length === 0) {
                    hidePDFProgress();
                    showNotification('âŒ No questions found', 'error');
                    return;
                }

                const config = {
                    schoolName,
                    paperTitle,
                    examDate,
                    duration,
                    totalMarks,
                    marksPerQuestion,
                    showDifficulty,
                    instructions,
                    examType: paperExamType,
                    subject: paperSelectedSubject
                };

                // Calculate progress steps
                const totalSteps = 1 + (includeAnswers ? 1 : 0) + (includeSolutions ? 1 : 0);
                let currentStep = 0;
                const progressPerStep = 70 / totalSteps; // 70% for generation, 15% for init, 15% for finish

                // Generate Question Paper
                updatePDFProgress(25, 'Generating Question Paper...', `Creating PDF with ${questions.length} questions`);
                await generateQuestionPaperHTML(questions, config);
                currentStep++;
                updatePDFProgress(25 + (progressPerStep * currentStep), 'Question Paper Complete', 'âœ“ Questions PDF generated');

                // Answer Key if selected
                if (includeAnswers) {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay for UI update
                    updatePDFProgress(25 + (progressPerStep * currentStep), 'Generating Answer Key...', 'Creating answer key table');
                    await generateAnswerKeyHTML(questions, config);
                    currentStep++;
                    updatePDFProgress(25 + (progressPerStep * currentStep), 'Answer Key Complete', 'âœ“ Answer key PDF generated');
                }

                // Solutions if selected
                if (includeSolutions) {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay for UI update
                    updatePDFProgress(25 + (progressPerStep * currentStep), 'Generating Solutions...', 'Creating detailed solutions');
                    await generateSolutionsHTML(questions, config);
                    currentStep++;
                    updatePDFProgress(25 + (progressPerStep * currentStep), 'Solutions Complete', 'âœ“ Solutions PDF generated');
                }

                // Finalizing
                updatePDFProgress(95, 'Finalizing...', 'Completing PDF generation');
                await new Promise(resolve => setTimeout(resolve, 200));

                const endTime = Date.now();
                const duration_sec = ((endTime - startTime) / 1000).toFixed(1);
                
                updatePDFProgress(100, 'Complete!', `All PDFs generated successfully in ${duration_sec}s`);
                
                setTimeout(() => {
                    hidePDFProgress();
                    showNotification(`âœ… PDFs generated in ${duration_sec}s!`, 'success');
                }, 1500);

            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                hidePDFProgress();
                showNotification('âŒ Error: ' + error.message, 'error');
            }
        }

        // Fetch questions by IDs
        async function fetchQuestionsByIds(ids) {
            try {
                const response = await fetch(`${API_BASE}/api/questions/by-ids`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'admin-token'}`
                    },
                    body: JSON.stringify({ ids })
                });

                const data = await response.json();
                return data.success ? data.questions : [];
            } catch (error) {
                console.error('Error fetching questions:', error);
                return [];
            }
        }

        // ==================== HTML TO PDF GENERATION ====================

        // Generate Question Paper using Playwright backend
        async function generateQuestionPaperHTML(questions, config) {
            try {
                await generatePDFWithBackend(questions, config, 'questions');
            } catch (error) {
                console.error('Error generating question paper:', error);
                throw error;
            }
        }

        // Generate Answer Key using Playwright backend
        async function generateAnswerKeyHTML(questions, config) {
            try {
                await generatePDFWithBackend(questions, config, 'answerkey');
            } catch (error) {
                console.error('Error generating answer key:', error);
                throw error;
            }
        }

        // Generate Solutions using Playwright backend
        async function generateSolutionsHTML(questions, config) {
            try {
                await generatePDFWithBackend(questions, config, 'solutions');
            } catch (error) {
                console.error('Error generating solutions:', error);
                throw error;
            }
        }

        // Helper function to generate PDF using Playwright backend
        async function generatePDFWithBackend(questions, config, type) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/generate-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        paperConfigId: null,
                        pdfType: type,
                        questions: questions,
                        config: {
                            schoolName: config.schoolName || 'GYANMANJARI',
                            paperTitle: config.paperTitle || 'MOCK_12-11',
                            subject: config.subject || 'Physics',
                            standard: config.standard || '11',
                            totalMarks: config.totalMarks || '100',
                            paperSet: config.paperSet || '1',
                            examDate: config.examDate || new Date().toISOString(),
                            examTime: config.duration ? `${Math.floor(config.duration / 60)}H:${config.duration % 60}M` : '0H:0M'
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'PDF generation failed');
                }

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${config.schoolName || 'GYANMANJARI'}_${config.paperTitle || 'MOCK'}_${type}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                console.log(`âœ… ${type} PDF downloaded successfully`);
            } catch (error) {
                console.error(`âŒ Error generating ${type} PDF:`, error);
                throw error;
            }
        }

        // Build Question Paper HTML with Page Border (GYANMANJARI Style)
        function buildQuestionPaperHTML(questions, config) {
            return `
                <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #000; width: 780px; padding: 20px; border: 3px solid #000; box-sizing: border-box; background: white;">
                    <!-- Header -->
                    <div style="text-align: center; padding-bottom: 15px; border-bottom: 2px solid #000; margin-bottom: 20px;">
                        <h1 style="margin: 0 0 15px 0; font-size: 26px; font-weight: bold; letter-spacing: 2px;">${config.schoolName}</h1>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <div style="text-align: left; line-height: 1.6;">
                                <div><strong>Subject</strong> : ${config.subject}</div>
                                <div><strong>Standard</strong> : 11</div>
                                <div><strong>Total Mark</strong> : ${config.totalMarks}</div>
                            </div>
                            
                            <div style="text-align: center;">
                                <div style="font-size: 16px; font-weight: bold;">${config.paperTitle}</div>
                            </div>
                            
                            <div style="text-align: right; line-height: 1.6;">
                                <div><strong>Paper Set</strong> : 1</div>
                                <div><strong>Date</strong> : ${config.examDate}</div>
                                <div><strong>Time</strong> : ${config.duration}M</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Header -->
                    <div style="text-align: center; margin-bottom: 18px;">
                        <div style="display: inline-block; border: 2px solid #000; padding: 6px 25px; font-weight: bold; font-size: 12px;">
                            ${config.subject} - Section A (MCQ)
                        </div>
                    </div>

                    <!-- Questions in Two Columns -->
                    <div style="column-count: 2; column-gap: 20px; font-size: 11px; column-rule: 1px solid #ddd;">
                        ${questions.map((q, index) => `
                            <div style="break-inside: avoid; margin-bottom: 16px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">(${index + 1})</div>
                                <div style="margin-left: 12px; margin-bottom: 8px; text-align: justify; line-height: 1.6;">
                                    ${q.text || q.question || ''}
                                </div>
                                
                                ${q.image || q.questionImage ? `
                                    <div style="margin: 10px 0; text-align: center;">
                                        <img src="${q.image || q.questionImage}" style="max-width: 100%; height: auto; max-height: 150px;" />
                                    </div>
                                ` : ''}
                                
                                ${q.options && q.options.length > 0 ? `
                                    <div style="margin-left: 12px; margin-top: 6px;">
                                        ${q.options.map((opt, i) => `
                                            <div style="margin-bottom: 4px; line-height: 1.5;">
                                                <strong>(${String.fromCharCode(65 + i)})</strong> ${preserveLineBreaks(opt)}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Build Answer Key HTML with Page Border
        function buildAnswerKeyHTML(questions, config) {
            const answersPerRow = 10;
            const rows = Math.ceil(questions.length / answersPerRow);
            
            let answerTable = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            
            for (let row = 0; row < rows; row++) {
                const startIdx = row * answersPerRow;
                const endIdx = Math.min(startIdx + answersPerRow, questions.length);
                
                answerTable += '<tr>';
                for (let i = startIdx; i < endIdx; i++) {
                    const answer = questions[i].correctAnswer || questions[i].answer || 'N/A';
                    answerTable += `
                        <td style="border: 1px solid #000; padding: 6px 10px; text-align: center; font-weight: bold; font-size: 11px;">
                            ${i + 1}-${answer}
                        </td>
                    `;
                }
                // Fill empty cells
                for (let i = endIdx; i < startIdx + answersPerRow; i++) {
                    answerTable += '<td style="border: 1px solid #000; padding: 6px 10px;"></td>';
                }
                answerTable += '</tr>';
            }
            answerTable += '</table>';

            return `
                <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #000; width: 780px; padding: 20px; border: 3px solid #000; box-sizing: border-box; background: white;">
                    <!-- Header -->
                    <div style="text-align: center; padding-bottom: 15px; border-bottom: 2px solid #000; margin-bottom: 20px;">
                        <h1 style="margin: 0 0 15px 0; font-size: 26px; font-weight: bold; letter-spacing: 2px;">${config.schoolName}</h1>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <div style="text-align: left; line-height: 1.6;">
                                <div><strong>Subject</strong> : ${config.subject}</div>
                                <div><strong>Standard</strong> : 11</div>
                                <div><strong>Total Mark</strong> : ${config.totalMarks}</div>
                            </div>
                            
                            <div style="text-align: center;">
                                <div style="font-size: 16px; font-weight: bold;">${config.paperTitle}</div>
                                <div style="font-size: 14px; font-weight: bold; color: #d32f2f;">(Answer Key)</div>
                            </div>
                            
                            <div style="text-align: right; line-height: 1.6;">
                                <div><strong>Paper Set</strong> : 1</div>
                                <div><strong>Date</strong> : ${config.examDate}</div>
                                <div><strong>Time</strong> : ${config.duration}M</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Header -->
                    <div style="text-align: center; margin-bottom: 18px;">
                        <div style="display: inline-block; border: 2px solid #000; padding: 6px 25px; font-weight: bold; font-size: 12px;">
                            ${config.subject} - Section A (MCQ)
                        </div>
                    </div>

                    <!-- Answer Table -->
                    ${answerTable}
                </div>
            `;
        }

        // Build Solutions HTML with Full Width and Auto Pagination
        function buildSolutionsHTML(questions, config) {
            return `
                <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #000; width: 100%; max-width: 100%;">
                    <!-- Header with Border -->
                    <div style="border: 3px solid #000; padding: 15px; margin-bottom: 20px; page-break-inside: avoid;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: bold; text-align: center; letter-spacing: 2px;">${config.schoolName}</h1>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 12px; border-top: 2px solid #000; padding-top: 10px;">
                            <div style="text-align: left; line-height: 1.8; flex: 1;">
                                <div><strong>Subject</strong> : ${config.subject}</div>
                                <div><strong>Standard</strong> : 11</div>
                                <div><strong>Total Mark</strong> : ${config.totalMarks}</div>
                            </div>
                            
                            <div style="text-align: center; flex: 1; padding: 0 20px;">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${config.paperTitle}</div>
                                <div style="font-size: 15px; font-weight: bold; color: #1976d2;">(Solutions)</div>
                            </div>
                            
                            <div style="text-align: right; line-height: 1.8; flex: 1;">
                                <div><strong>Paper Set</strong> : 1</div>
                                <div><strong>Date</strong> : ${config.examDate}</div>
                                <div><strong>Time</strong> : ${config.duration}M</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Header -->
                    <div style="text-align: center; margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="display: inline-block; border: 2px solid #000; padding: 8px 30px; font-weight: bold; font-size: 13px; background: #f5f5f5;">
                            ${config.subject} - Section A (MCQ)
                        </div>
                    </div>

                    <!-- Solutions in Two Columns with Page Break Support -->
                    <div style="column-count: 2; column-gap: 25px; font-size: 12px; column-rule: 1px dotted #ccc; width: 100%;">
                        ${questions.map((q, index) => {
                            const answer = q.correctAnswer || q.answer || 'N/A';
                            const questionText = q.text || q.question || '';
                            const briefQuestion = questionText.length > 180 ? questionText.substring(0, 180) + '...' : questionText;
                            
                            return `
                                <div style="break-inside: avoid; page-break-inside: avoid; margin-bottom: 22px; border: 1px solid #e0e0e0; padding: 12px; border-radius: 6px; background: #fafafa;">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px; color: #1976d2;">(${index + 1})</div>
                                    <div style="margin-left: 15px; margin-bottom: 10px; text-align: justify; line-height: 1.6; font-size: 11px; color: #555; word-wrap: break-word;">
                                        ${briefQuestion}
                                    </div>
                                    
                                    <div style="margin-left: 15px; margin-top: 10px; padding: 10px; background: #fff; border-left: 4px solid #4caf50; border-radius: 4px;">
                                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 6px;">
                                            Solution: <span style="color: #d32f2f;">(Correct Answer: ${answer})</span>
                                        </div>
                                        <div style="margin-top: 6px; line-height: 1.7; text-align: justify; word-wrap: break-word;">
                                            ${q.solution || q.explanation || 'No solution provided'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ccc; padding-top: 10px; page-break-inside: avoid;">
                        <div>Generated by EduSphere Pro | ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;
        }

        // Wait for images to load - Optimized with faster timeout
        function waitForImagesToLoad(container) {
            const images = container.getElementsByTagName('img');
            const promises = [];
            
            for (let img of images) {
                if (!img.complete) {
                    promises.push(new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = resolve;
                        setTimeout(resolve, 1000);
                    }));
                }
            }
            
            return promises.length > 0 ? Promise.all(promises) : Promise.resolve();
        }

        // ULTRA-FAST PDF Generation - No Dialogs, No Freezing
        // DISABLED - This function used html2canvas which is removed
        async function printToPDF_DISABLED_USE_PDFMAKE(htmlContent, filename) {
            console.warn('âš ï¸ printToPDF is disabled. Use generateFastPDF with pdfmake instead.');
            alert('This PDF generation is being updated. Please use the main download buttons.');
            return Promise.resolve();
        }
        
        async function printToPDF_OLD_REMOVED(htmlContent, filename) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Create container
                    const container = document.createElement('div');
                    container.id = 'pdf-temp-container';
                    container.style.position = 'absolute';
                    container.style.left = '-9999px';
                    container.style.top = '0';
                    container.innerHTML = htmlContent;
                    document.body.appendChild(container);

                    // INSTANT KaTeX render (10-100x faster than MathJax!)
                    if (window.renderMathInElement) {
                        renderMathInElement(container, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\[', right: '\\]', display: true},
                                {left: '\\(', right: '\\)', display: false}
                            ],
                            throwOnError: false,
                            strict: false
                        });
                        // KaTeX is instant! Just wait for DOM
                        await new Promise(r => setTimeout(r, 100));
                    }

                    // Wait for images
                    const images = container.getElementsByTagName('img');
                    if (images.length > 0) {
                        await Promise.race([
                            Promise.all(Array.from(images).map(img => {
                                if (img.complete) return Promise.resolve();
                                return new Promise(r => {
                                    img.onload = r;
                                    img.onerror = r;
                                    setTimeout(r, 1000); // Give images more time for quality
                                });
                            })),
                            new Promise(r => setTimeout(r, 2000)) // Wait longer for images
                        ]);
                    }

                    // Yield to UI
                    await new Promise(r => requestAnimationFrame(r));

                    // HIGH QUALITY canvas render
                    const canvas = await html2canvas(container, {
                        scale: 2, // High quality (2x resolution)
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        imageTimeout: 0,
                        backgroundColor: '#ffffff',
                        windowWidth: 794,
                        async: true,
                        foreignObjectRendering: true, // Better rendering
                        removeContainer: false,
                        letterRendering: true // Better text quality
                    });

                    // Yield to UI
                    await new Promise(r => requestAnimationFrame(r));

                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgData = canvas.toDataURL('image/png'); // PNG for best quality (no compression)
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const ratio = pdfWidth / canvas.width;
                    const scaledHeight = canvas.height * ratio;
                    const pageCount = Math.ceil(scaledHeight / pdfHeight);
                    
                    // Add pages
                    for (let i = 0; i < pageCount; i++) {
                        if (i > 0) pdf.addPage();
                        const yOffset = -(i * pdfHeight / ratio);
                        pdf.addImage(imgData, 'PNG', 0, yOffset * ratio, pdfWidth, scaledHeight, undefined, 'SLOW'); // High quality
                        
                        // Yield every 2 pages
                        if (i % 2 === 0) await new Promise(r => requestAnimationFrame(r));
                    }
                    
                    // Save
                    pdf.save(filename + '.pdf');
                    
                    // Cleanup
                    document.body.removeChild(container);
                    resolve();

                } catch (error) {
                    console.error('Error in printToPDF:', error);
                    reject(error);
                }
            });
        }

        // Non-blocking HTML to PDF conversion
        async function html2pdf(element, filename) {
            const { jsPDF } = window.jspdf;
            
            try {
                // Allow UI to update before heavy operation
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Use html2canvas with optimized settings
                const canvas = await html2canvas(element, {
                    scale: 1.2, // Lower scale for speed
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    imageTimeout: 0,
                    backgroundColor: '#ffffff',
                    onclone: function(clonedDoc) {
                        // Optimize cloned document
                        const clonedElement = clonedDoc.getElementById('pdf-render-container');
                        if (clonedElement) {
                            clonedElement.style.transform = 'scale(1)';
                        }
                    }
                });

                // Allow UI to breathe
                await new Promise(resolve => setTimeout(resolve, 50));

                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                const ratio = pdfWidth / canvasWidth;
                const scaledHeight = canvasHeight * ratio;
                const pageCount = Math.ceil(scaledHeight / pdfHeight);
                
                // Add pages with breaks to prevent freezing
                for (let i = 0; i < pageCount; i++) {
                    if (i > 0) {
                        pdf.addPage();
                        // Allow UI to update every 3 pages
                        if (i % 3 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    const yOffset = -(i * pdfHeight / ratio);
                    pdf.addImage(imgData, 'JPEG', 0, yOffset * ratio, pdfWidth, scaledHeight, undefined, 'FAST');
                }
                
                // Allow UI to update before saving
                await new Promise(resolve => setTimeout(resolve, 50));
                pdf.save(filename);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.text('Error generating PDF. Please try again.', 10, 10);
                pdf.save(filename);
            }
        }
        // Generate Question Paper PDF with Two-Column Layout
        async function generateQuestionPaperPDF(questions, config) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const columnGap = 5;
            const columnWidth = (pageWidth - (2 * margin) - columnGap) / 2;
            
            let currentPage = 1;
            let leftColumnY = 0;
            let rightColumnY = 0;
            let currentColumn = 'left'; // Start with left column

            // Function to add header to page
            function addPageHeader(isFirstPage = false) {
                let yPos = 10;
                
                // GYANMANJARI Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(config.schoolName, pageWidth / 2, yPos, { align: 'center' });
                yPos += 8;

                // Paper Info - Three columns
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                // Left info
                doc.text(`Subject: ${config.subject}`, margin, yPos);
                doc.text(`Standard: 11`, margin, yPos + 4);
                doc.text(`Total Mark: ${config.totalMarks}`, margin, yPos + 8);
                
                // Center info
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(config.paperTitle, pageWidth / 2, yPos + 2, { align: 'center' });
                
                if (isFirstPage) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                }
                
                // Right info
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Paper Set: 1`, pageWidth - margin, yPos, { align: 'right' });
                doc.text(`Date: ${config.examDate}`, pageWidth - margin, yPos + 4, { align: 'right' });
                doc.text(`Time: ${config.duration}M`, pageWidth - margin, yPos + 8, { align: 'right' });

                yPos += 12;
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 5;

                // Section Header
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.rect(margin + 20, yPos - 4, 60, 6);
                doc.text(`${config.subject} - Section A (MCQ)`, margin + 50, yPos, { align: 'center' });
                yPos += 8;

                return yPos;
            }

            // Initialize first page
            leftColumnY = addPageHeader(true);
            rightColumnY = leftColumnY;

            // Process questions in two columns
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const questionNumber = i + 1;
                
                // Determine which column to use
                const useLeftColumn = currentColumn === 'left';
                const xPos = useLeftColumn ? margin : (margin + columnWidth + columnGap);
                let yPos = useLeftColumn ? leftColumnY : rightColumnY;

                // Check if we need a new page
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    currentPage++;
                    leftColumnY = addPageHeader(false);
                    rightColumnY = leftColumnY;
                    currentColumn = 'left';
                    continue; // Reprocess this question
                }

                // Render question
                const newY = await renderQuestionInPDFColumn(doc, question, questionNumber, xPos, yPos, columnWidth, config);
                
                // Update column position
                if (useLeftColumn) {
                    leftColumnY = newY + 3;
                    currentColumn = 'right';
                } else {
                    rightColumnY = newY + 3;
                    currentColumn = 'left';
                }
            }

            // Save PDF
            doc.save(`${config.paperTitle}_Questions.pdf`);
        }

        // Render question in column with proper formatting
        async function renderQuestionInPDFColumn(doc, question, questionNumber, xPos, yPos, columnWidth, config) {
            const startY = yPos;
            
            // Question number
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`(${questionNumber})`, xPos, yPos);
            yPos += 5;

            // Question text with proper formatting
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            yPos = await renderFormattedText(doc, question.text || question.question || '', xPos + 5, yPos, columnWidth - 5);
            
            // Add question image if exists
            if (question.image || question.questionImage) {
                yPos += 3;
                yPos = await addImageToPDFColumn(doc, question.image || question.questionImage, xPos + 5, yPos, columnWidth - 10);
                yPos += 3;
            }

            // Options
            if (question.options && question.options.length > 0) {
                yPos += 3;
                for (let i = 0; i < question.options.length; i++) {
                    const optionLabel = String.fromCharCode(65 + i);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`(${optionLabel})`, xPos + 5, yPos);
                    
                    doc.setFont('helvetica', 'normal');
                    yPos = await renderFormattedText(doc, question.options[i], xPos + 12, yPos, columnWidth - 12);
                    yPos += 1;
                }
            }

            return yPos;
        }

        // Render formatted text with subscripts, superscripts, and special characters
        async function renderFormattedText(doc, text, xPos, yPos, maxWidth) {
            if (!text) return yPos;

            // Clean and process text
            let processedText = text
                // Remove HTML tags but preserve content
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/p>/gi, '\n')
                .replace(/<p>/gi, '')
                .replace(/<strong>(.*?)<\/strong>/gi, '$1')
                .replace(/<b>(.*?)<\/b>/gi, '$1')
                .replace(/<em>(.*?)<\/em>/gi, '$1')
                .replace(/<i>(.*?)<\/i>/gi, '$1')
                .replace(/<u>(.*?)<\/u>/gi, '$1')
                .replace(/<\/?[^>]+(>|$)/g, '');

            // Process LaTeX - convert to readable format
            processedText = convertLatexToReadable(processedText);

            // Split into lines
            const lines = doc.splitTextToSize(processedText, maxWidth);
            
            for (let line of lines) {
                // Render line with special character support
                doc.text(line, xPos, yPos);
                yPos += 4;
            }

            return yPos;
        }

        // Convert LaTeX to readable format with proper symbols
        function convertLatexToReadable(text) {
            if (!text) return '';

            return text
                // Math delimiters
                .replace(/\$\$(.*?)\$\$/g, '$1')
                .replace(/\$(.*?)\$/g, '$1')
                .replace(/\\\[(.*?)\\\]/g, '$1')
                .replace(/\\\((.*?)\\\)/g, '$1')
                
                // Fractions
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1/$2')
                .replace(/\\dfrac\{([^}]+)\}\{([^}]+)\}/g, '$1/$2')
                
                // Square roots
                .replace(/\\sqrt\{([^}]+)\}/g, 'âˆš$1')
                .replace(/\\sqrt\[(\d+)\]\{([^}]+)\}/g, '$1âˆš$2')
                
                // Text commands
                .replace(/\\text\{([^}]+)\}/g, '$1')
                .replace(/\\mathrm\{([^}]+)\}/g, '$1')
                .replace(/\\mathbf\{([^}]+)\}/g, '$1')
                
                // Subscripts and superscripts - keep them readable
                .replace(/\^{([^}]+)}/g, '^$1')
                .replace(/\^(\w)/g, '^$1')
                .replace(/_{([^}]+)}/g, '_$1')
                .replace(/_(\w)/g, '_$1')
                
                // Greek letters (lowercase)
                .replace(/\\alpha/g, 'Î±').replace(/\\beta/g, 'Î²').replace(/\\gamma/g, 'Î³')
                .replace(/\\delta/g, 'Î´').replace(/\\epsilon/g, 'Îµ').replace(/\\varepsilon/g, 'Îµ')
                .replace(/\\zeta/g, 'Î¶').replace(/\\eta/g, 'Î·').replace(/\\theta/g, 'Î¸')
                .replace(/\\vartheta/g, 'Î¸').replace(/\\iota/g, 'Î¹').replace(/\\kappa/g, 'Îº')
                .replace(/\\lambda/g, 'Î»').replace(/\\mu/g, 'Î¼').replace(/\\nu/g, 'Î½')
                .replace(/\\xi/g, 'Î¾').replace(/\\pi/g, 'Ï€').replace(/\\varpi/g, 'Ï€')
                .replace(/\\rho/g, 'Ï').replace(/\\varrho/g, 'Ï').replace(/\\sigma/g, 'Ïƒ')
                .replace(/\\varsigma/g, 'Ï‚').replace(/\\tau/g, 'Ï„').replace(/\\upsilon/g, 'Ï…')
                .replace(/\\phi/g, 'Ï†').replace(/\\varphi/g, 'Ï†').replace(/\\chi/g, 'Ï‡')
                .replace(/\\psi/g, 'Ïˆ').replace(/\\omega/g, 'Ï‰')
                
                // Greek letters (uppercase)
                .replace(/\\Gamma/g, 'Î“').replace(/\\Delta/g, 'Î”').replace(/\\Theta/g, 'Î˜')
                .replace(/\\Lambda/g, 'Î›').replace(/\\Xi/g, 'Îž').replace(/\\Pi/g, 'Î ')
                .replace(/\\Sigma/g, 'Î£').replace(/\\Upsilon/g, 'Î¥').replace(/\\Phi/g, 'Î¦')
                .replace(/\\Psi/g, 'Î¨').replace(/\\Omega/g, 'Î©')
                
                // Math operators
                .replace(/\\times/g, 'Ã—').replace(/\\div/g, 'Ã·').replace(/\\pm/g, 'Â±')
                .replace(/\\mp/g, 'âˆ“').replace(/\\cdot/g, 'Â·').replace(/\\ast/g, '*')
                .replace(/\\star/g, 'â‹†').replace(/\\circ/g, 'Â°').replace(/\\bullet/g, 'â€¢')
                
                // Relations
                .replace(/\\approx/g, 'â‰ˆ').replace(/\\neq/g, 'â‰ ').replace(/\\ne/g, 'â‰ ')
                .replace(/\\leq/g, 'â‰¤').replace(/\\le/g, 'â‰¤').replace(/\\geq/g, 'â‰¥')
                .replace(/\\ge/g, 'â‰¥').replace(/\\ll/g, 'â‰ª').replace(/\\gg/g, 'â‰«')
                .replace(/\\sim/g, '~').replace(/\\simeq/g, 'â‰ƒ').replace(/\\equiv/g, 'â‰¡')
                .replace(/\\cong/g, 'â‰…').replace(/\\propto/g, 'âˆ')
                
                // Geometry
                .replace(/\\parallel/g, 'âˆ¥').replace(/\\perp/g, 'âŠ¥').replace(/\\angle/g, 'âˆ ')
                .replace(/\\triangle/g, 'â–³').replace(/\\square/g, 'â–¡').replace(/\\degree/g, 'Â°')
                
                // Arrows
                .replace(/\\rightarrow/g, 'â†’').replace(/\\to/g, 'â†’').replace(/\\leftarrow/g, 'â†')
                .replace(/\\Rightarrow/g, 'â‡’').replace(/\\Leftarrow/g, 'â‡')
                .replace(/\\leftrightarrow/g, 'â†”').replace(/\\Leftrightarrow/g, 'â‡”')
                .replace(/\\uparrow/g, 'â†‘').replace(/\\downarrow/g, 'â†“')
                
                // Calculus
                .replace(/\\infty/g, 'âˆž').replace(/\\partial/g, 'âˆ‚').replace(/\\nabla/g, 'âˆ‡')
                .replace(/\\int/g, 'âˆ«').replace(/\\iint/g, 'âˆ¬').replace(/\\iiint/g, 'âˆ­')
                .replace(/\\oint/g, 'âˆ®').replace(/\\sum/g, 'âˆ‘').replace(/\\prod/g, 'âˆ')
                .replace(/\\lim/g, 'lim').replace(/\\sin/g, 'sin').replace(/\\cos/g, 'cos')
                .replace(/\\tan/g, 'tan').replace(/\\log/g, 'log').replace(/\\ln/g, 'ln')
                .replace(/\\exp/g, 'exp')
                
                // Sets
                .replace(/\\in/g, 'âˆˆ').replace(/\\notin/g, 'âˆ‰').replace(/\\subset/g, 'âŠ‚')
                .replace(/\\supset/g, 'âŠƒ').replace(/\\subseteq/g, 'âŠ†').replace(/\\supseteq/g, 'âŠ‡')
                .replace(/\\cup/g, 'âˆª').replace(/\\cap/g, 'âˆ©').replace(/\\emptyset/g, 'âˆ…')
                .replace(/\\forall/g, 'âˆ€').replace(/\\exists/g, 'âˆƒ')
                
                // Logic
                .replace(/\\land/g, 'âˆ§').replace(/\\lor/g, 'âˆ¨').replace(/\\neg/g, 'Â¬')
                .replace(/\\implies/g, 'â‡’').replace(/\\iff/g, 'â‡”')
                
                // Misc
                .replace(/\\ldots/g, '...').replace(/\\cdots/g, 'Â·Â·Â·').replace(/\\vdots/g, 'â‹®')
                .replace(/\\ddots/g, 'â‹±').replace(/\\therefore/g, 'âˆ´').replace(/\\because/g, 'âˆµ')
                
                // Remove remaining LaTeX commands
                .replace(/\\[a-zA-Z]+\*/g, '')
                .replace(/\\[a-zA-Z]+/g, '')
                .replace(/[{}]/g, '')
                
                // Clean up whitespace
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Convert LaTeX to readable text
        function renderLatexToText(text) {
            if (!text) return '';

            return text
                // Remove HTML tags
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/p>/gi, '\n')
                .replace(/<p>/gi, '')
                .replace(/<strong>(.*?)<\/strong>/gi, '$1')
                .replace(/<b>(.*?)<\/b>/gi, '$1')
                .replace(/<em>(.*?)<\/em>/gi, '$1')
                .replace(/<i>(.*?)<\/i>/gi, '$1')
                .replace(/<u>(.*?)<\/u>/gi, '$1')
                .replace(/<\/?[^>]+(>|$)/g, '')
                
                // LaTeX math delimiters
                .replace(/\$\$(.*?)\$\$/g, '$1')
                .replace(/\$(.*?)\$/g, '$1')
                .replace(/\\\[(.*?)\\\]/g, '$1')
                .replace(/\\\((.*?)\\\)/g, '$1')
                
                // LaTeX commands
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)')
                .replace(/\\dfrac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)')
                .replace(/\\sqrt\{([^}]+)\}/g, 'âˆš($1)')
                .replace(/\\sqrt\[(\d+)\]\{([^}]+)\}/g, '$1âˆš($2)')
                .replace(/\\text\{([^}]+)\}/g, '$1')
                .replace(/\\mathrm\{([^}]+)\}/g, '$1')
                .replace(/\\mathbf\{([^}]+)\}/g, '$1')
                
                // Superscripts and subscripts
                .replace(/\^(\d+)/g, '^$1')
                .replace(/\^{([^}]+)}/g, '^($1)')
                .replace(/_(\d+)/g, '_$1')
                .replace(/_{([^}]+)}/g, '_($1)')
                
                // Greek letters
                .replace(/\\alpha/g, 'Î±').replace(/\\beta/g, 'Î²').replace(/\\gamma/g, 'Î³')
                .replace(/\\delta/g, 'Î´').replace(/\\epsilon/g, 'Îµ').replace(/\\zeta/g, 'Î¶')
                .replace(/\\eta/g, 'Î·').replace(/\\theta/g, 'Î¸').replace(/\\iota/g, 'Î¹')
                .replace(/\\kappa/g, 'Îº').replace(/\\lambda/g, 'Î»').replace(/\\mu/g, 'Î¼')
                .replace(/\\nu/g, 'Î½').replace(/\\xi/g, 'Î¾').replace(/\\pi/g, 'Ï€')
                .replace(/\\rho/g, 'Ï').replace(/\\sigma/g, 'Ïƒ').replace(/\\tau/g, 'Ï„')
                .replace(/\\upsilon/g, 'Ï…').replace(/\\phi/g, 'Ï†').replace(/\\chi/g, 'Ï‡')
                .replace(/\\psi/g, 'Ïˆ').replace(/\\omega/g, 'Ï‰')
                .replace(/\\Gamma/g, 'Î“').replace(/\\Delta/g, 'Î”').replace(/\\Theta/g, 'Î˜')
                .replace(/\\Lambda/g, 'Î›').replace(/\\Xi/g, 'Îž').replace(/\\Pi/g, 'Î ')
                .replace(/\\Sigma/g, 'Î£').replace(/\\Phi/g, 'Î¦').replace(/\\Psi/g, 'Î¨')
                .replace(/\\Omega/g, 'Î©')
                
                // Math symbols
                .replace(/\\times/g, 'Ã—').replace(/\\div/g, 'Ã·').replace(/\\pm/g, 'Â±')
                .replace(/\\mp/g, 'âˆ“').replace(/\\cdot/g, 'Â·').replace(/\\ast/g, '*')
                .replace(/\\circ/g, 'Â°').replace(/\\degree/g, 'Â°')
                .replace(/\\infty/g, 'âˆž').replace(/\\partial/g, 'âˆ‚')
                .replace(/\\nabla/g, 'âˆ‡').replace(/\\int/g, 'âˆ«')
                .replace(/\\sum/g, 'âˆ‘').replace(/\\prod/g, 'âˆ')
                .replace(/\\approx/g, 'â‰ˆ').replace(/\\neq/g, 'â‰ ')
                .replace(/\\leq/g, 'â‰¤').replace(/\\geq/g, 'â‰¥')
                .replace(/\\ll/g, 'â‰ª').replace(/\\gg/g, 'â‰«')
                .replace(/\\sim/g, '~').replace(/\\equiv/g, 'â‰¡')
                .replace(/\\propto/g, 'âˆ').replace(/\\parallel/g, 'âˆ¥')
                .replace(/\\perp/g, 'âŠ¥').replace(/\\angle/g, 'âˆ ')
                .replace(/\\triangle/g, 'â–³').replace(/\\square/g, 'â–¡')
                .replace(/\\rightarrow/g, 'â†’').replace(/\\leftarrow/g, 'â†')
                .replace(/\\Rightarrow/g, 'â‡’').replace(/\\Leftarrow/g, 'â‡')
                .replace(/\\leftrightarrow/g, 'â†”').replace(/\\Leftrightarrow/g, 'â‡”')
                
                // Remove remaining LaTeX commands
                .replace(/\\[a-zA-Z]+/g, '')
                .replace(/[{}]/g, '')
                
                // Clean up whitespace
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Add base64 image to PDF column
        async function addImageToPDFColumn(doc, base64Data, xPos, yPos, maxWidth) {
            try {
                if (!base64Data) return yPos;

                // Ensure proper base64 format
                let imageData = base64Data;
                if (!imageData.startsWith('data:image')) {
                    // Try to detect image type
                    const imageType = base64Data.charAt(0) === '/' ? 'jpeg' : 'png';
                    imageData = `data:image/${imageType};base64,${imageData}`;
                }

                // Calculate dimensions
                const imgWidth = Math.min(maxWidth, 60);
                const imgHeight = 40;
                
                // Add image
                doc.addImage(imageData, 'PNG', xPos, yPos, imgWidth, imgHeight);
                
                return yPos + imgHeight + 2;
            } catch (error) {
                console.error('Error adding image to PDF:', error);
                // Add placeholder text if image fails
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.text('[Image]', xPos, yPos);
                return yPos + 4;
            }
        }

        // Generate Answer Key PDF
        async function generateAnswerKeyPDF(questions, config) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            let yPos = 20;
            const pageWidth = 210;
            const margin = 15;

            // Add GYANMANJARI Header
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(config.schoolName, pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;

            // Add Paper Info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Subject: ${config.subject}`, margin, yPos);
            doc.text(`Standard: 11`, margin, yPos + 5);
            doc.text(`Total Mark: ${config.totalMarks}`, margin, yPos + 10);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`${config.paperTitle}`, pageWidth / 2, yPos + 5, { align: 'center' });
            doc.text('(Answer Key)', pageWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Paper Set: 1`, pageWidth - margin, yPos, { align: 'right' });
            doc.text(`Date: ${config.examDate}`, pageWidth - margin, yPos + 5, { align: 'right' });
            doc.text(`Time: ${config.duration}M`, pageWidth - margin, yPos + 10, { align: 'right' });

            yPos += 20;
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 10;

            // Add Section Header
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`${config.subject} - Section A (MCQ)`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;

            // Create Answer Key Table
            const answersPerRow = 10;
            const rows = Math.ceil(questions.length / answersPerRow);
            
            for (let row = 0; row < rows; row++) {
                let xPos = margin + 10;
                const startIdx = row * answersPerRow;
                const endIdx = Math.min(startIdx + answersPerRow, questions.length);
                
                for (let i = startIdx; i < endIdx; i++) {
                    const question = questions[i];
                    const answer = question.correctAnswer || question.answer || 'N/A';
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${i + 1}-${answer}`, xPos, yPos);
                    xPos += 18;
                }
                yPos += 6;
            }

            doc.save(`${config.paperTitle}_AnswerKey.pdf`);
        }

        // Generate Solutions PDF with Two-Column Layout
        async function generateSolutionsPDF(questions, config) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const columnGap = 5;
            const columnWidth = (pageWidth - (2 * margin) - columnGap) / 2;
            
            let leftColumnY = 0;
            let rightColumnY = 0;
            let currentColumn = 'left';

            // Add header function
            function addSolutionHeader(isFirstPage = false) {
                let yPos = 10;
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(config.schoolName, pageWidth / 2, yPos, { align: 'center' });
                yPos += 8;

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Subject: ${config.subject}`, margin, yPos);
                doc.text(`Standard: 11`, margin, yPos + 4);
                doc.text(`Total Mark: ${config.totalMarks}`, margin, yPos + 8);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(config.paperTitle, pageWidth / 2, yPos + 2, { align: 'center' });
                doc.text('(Solutions)', pageWidth / 2, yPos + 6, { align: 'center' });
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Paper Set: 1`, pageWidth - margin, yPos, { align: 'right' });
                doc.text(`Date: ${config.examDate}`, pageWidth - margin, yPos + 4, { align: 'right' });
                doc.text(`Time: ${config.duration}M`, pageWidth - margin, yPos + 8, { align: 'right' });

                yPos += 12;
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 5;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.rect(margin + 20, yPos - 4, 60, 6);
                doc.text(`${config.subject} - Section A (MCQ)`, margin + 50, yPos, { align: 'center' });
                yPos += 8;

                return yPos;
            }

            leftColumnY = addSolutionHeader(true);
            rightColumnY = leftColumnY;

            // Process questions with solutions
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const questionNumber = i + 1;
                
                const useLeftColumn = currentColumn === 'left';
                const xPos = useLeftColumn ? margin : (margin + columnWidth + columnGap);
                let yPos = useLeftColumn ? leftColumnY : rightColumnY;

                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    leftColumnY = addSolutionHeader(false);
                    rightColumnY = leftColumnY;
                    currentColumn = 'left';
                    continue;
                }

                // Render question with solution
                const newY = await renderSolutionInColumn(doc, question, questionNumber, xPos, yPos, columnWidth, config);
                
                if (useLeftColumn) {
                    leftColumnY = newY + 5;
                    currentColumn = 'right';
                } else {
                    rightColumnY = newY + 5;
                    currentColumn = 'left';
                }
            }

            doc.save(`${config.paperTitle}_Solutions.pdf`);
        }

        // Render solution in column with proper formatting
        async function renderSolutionInColumn(doc, question, questionNumber, xPos, yPos, columnWidth, config) {
            // Question number
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`(${questionNumber})`, xPos, yPos);
            yPos += 5;

            // Brief question text
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const questionText = convertLatexToReadable(question.text || question.question || '');
            const briefText = questionText.substring(0, 120) + (questionText.length > 120 ? '...' : '');
            const lines = doc.splitTextToSize(briefText, columnWidth - 5);
            
            for (let line of lines.slice(0, 3)) { // Max 3 lines
                doc.text(line, xPos + 5, yPos);
                yPos += 4;
            }

            yPos += 2;

            // Answer
            doc.setFont('helvetica', 'bold');
            const answer = question.correctAnswer || question.answer || 'N/A';
            doc.text(`Solution: (Correct Answer: ${answer})`, xPos + 5, yPos);
            yPos += 5;

            // Solution text with proper formatting
            doc.setFont('helvetica', 'normal');
            yPos = await renderFormattedText(doc, question.solution || question.explanation || 'No solution provided', xPos + 5, yPos, columnWidth - 5);

            return yPos;
        }

        // Render question in PDF with LaTeX and images
        async function renderQuestionInPDF(doc, question, questionNumber, yPos, margin, contentWidth, config) {
            const pageHeight = 297;
            
            // Question number
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`(${questionNumber})`, margin, yPos);
            yPos += 6;

            // Question text with LaTeX
            doc.setFont('helvetica', 'normal');
            yPos = await renderTextWithLatex(doc, question.text || question.question, margin + 5, yPos, contentWidth - 5);
            
            // Add question image if exists
            if (question.image || question.questionImage) {
                const imageData = question.image || question.questionImage;
                if (imageData) {
                    yPos += 5;
                    yPos = await addImageToPDF(doc, imageData, margin + 5, yPos, contentWidth - 10);
                }
            }

            yPos += 5;

            // Options
            if (question.options && question.options.length > 0) {
                for (let i = 0; i < question.options.length; i++) {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const optionLabel = String.fromCharCode(65 + i); // A, B, C, D
                    doc.setFont('helvetica', 'normal');
                    doc.text(`(${optionLabel})`, margin + 5, yPos);
                    
                    yPos = await renderTextWithLatex(doc, question.options[i], margin + 15, yPos, contentWidth - 15);
                    yPos += 2;
                }
            }

            yPos += 5;
            return yPos;
        }

        // Render text with LaTeX support
        async function renderTextWithLatex(doc, text, x, y, maxWidth) {
            if (!text) return y;

            // Convert LaTeX to readable format (simplified)
            let processedText = text
                .replace(/\$\$(.*?)\$\$/g, '$1') // Display math
                .replace(/\$(.*?)\$/g, '$1')     // Inline math
                .replace(/\\frac\{(.*?)\}\{(.*?)\}/g, '($1/$2)') // Fractions
                .replace(/\\sqrt\{(.*?)\}/g, 'âˆš($1)') // Square root
                .replace(/\^(\d+)/g, '^$1') // Superscript
                .replace(/_(\d+)/g, '_$1') // Subscript
                .replace(/\\times/g, 'Ã—')
                .replace(/\\div/g, 'Ã·')
                .replace(/\\pm/g, 'Â±')
                .replace(/\\degree/g, 'Â°')
                .replace(/\\alpha/g, 'Î±')
                .replace(/\\beta/g, 'Î²')
                .replace(/\\gamma/g, 'Î³')
                .replace(/\\Delta/g, 'Î”')
                .replace(/\\theta/g, 'Î¸')
                .replace(/\\pi/g, 'Ï€')
                .replace(/\\omega/g, 'Ï‰')
                .replace(/\\Omega/g, 'Î©')
                .replace(/\\infty/g, 'âˆž')
                .replace(/\\approx/g, 'â‰ˆ')
                .replace(/\\neq/g, 'â‰ ')
                .replace(/\\leq/g, 'â‰¤')
                .replace(/\\geq/g, 'â‰¥')
                .replace(/\\cdot/g, 'Â·')
                .replace(/<br>/g, '\n')
                .replace(/<\/?[^>]+(>|$)/g, ''); // Remove HTML tags

            // Handle formatting
            const lines = doc.splitTextToSize(processedText, maxWidth);
            
            for (let line of lines) {
                // Check for bold, italic, underline
                if (line.includes('**') || line.includes('__')) {
                    doc.setFont('helvetica', 'bold');
                    line = line.replace(/\*\*/g, '').replace(/__/g, '');
                } else if (line.includes('*') || line.includes('_')) {
                    doc.setFont('helvetica', 'italic');
                    line = line.replace(/\*/g, '').replace(/_/g, '');
                } else {
                    doc.setFont('helvetica', 'normal');
                }

                doc.text(line, x, y);
                y += 5;
            }

            return y;
        }

        // Add base64 image to PDF
        async function addImageToPDF(doc, base64Data, x, y, maxWidth) {
            try {
                // Ensure base64 data has proper format
                let imageData = base64Data;
                if (!imageData.startsWith('data:image')) {
                    imageData = `data:image/png;base64,${imageData}`;
                }

                // Add image to PDF
                const imgWidth = Math.min(maxWidth, 80);
                const imgHeight = 60; // Maintain aspect ratio
                
                doc.addImage(imageData, 'PNG', x, y, imgWidth, imgHeight);
                
                return y + imgHeight + 5;
            } catch (error) {
                console.error('Error adding image to PDF:', error);
                return y;
            }
        }

        // Auto-load when section opens
        document.addEventListener('DOMContentLoaded', function() {
            const originalShowSection = window.showSection;
            if (originalShowSection) {
                window.showSection = function(sectionId) {
                    originalShowSection(sectionId);
                    
                    if (sectionId === 'makePaperSection') {
                        paperSelectedIds = [];
                        setTimeout(() => loadPaperQuestions(), 100);
                    }
                    
                    // Load documents when documents section is shown
                    if (sectionId === 'documentsSection') {
                        setTimeout(() => loadDocuments(), 100);
                    }
                };
            }
        });

        // ==================== DOCUMENTS SECTION FUNCTIONS ====================
        
        let documentsStream = 'jee';
        let documentsSubject = 'all';
        let allDocuments = [];

        // Show documents exam type (JEE/NEET)
        function showDocumentsExamType(stream) {
            documentsStream = stream;
            documentsSubject = 'all';
            
            // Update tab styles
            const jeeTab = document.getElementById('docsJeeTab');
            const neetTab = document.getElementById('docsNeetTab');
            
            if (stream === 'jee') {
                jeeTab.classList.add('active');
                neetTab.classList.remove('active');
            } else {
                neetTab.classList.add('active');
                jeeTab.classList.remove('active');
            }
            
            // Update subject filter buttons
            updateDocumentsSubjectFilter();
            
            // Load documents
            loadDocuments();
        }

        // Update subject filter buttons based on stream
        function updateDocumentsSubjectFilter() {
            const filterContainer = document.getElementById('documentsSubjectFilter');
            if (!filterContainer) return;
            
            const subjects = documentsStream === 'jee' 
                ? ['all', 'physics', 'chemistry', 'mathematics']
                : ['all', 'physics', 'chemistry', 'biology'];
            
            const subjectLabels = {
                all: 'All Subjects',
                physics: 'Physics',
                chemistry: 'Chemistry',
                mathematics: 'Mathematics',
                biology: 'Biology'
            };
            
            const subjectIcons = {
                all: 'fa-th',
                physics: 'fa-atom',
                chemistry: 'fa-flask',
                mathematics: 'fa-calculator',
                biology: 'fa-dna'
            };
            
            filterContainer.innerHTML = subjects.map(subject => `
                <button 
                    onclick="filterDocumentsBySubject('${subject}')"
                    class="subject-filter-btn ${subject === documentsSubject ? 'active' : ''}"
                    data-subject="${subject}"
                    style="
                        padding: 0.75rem 1.5rem;
                        border: 2px solid ${subject === documentsSubject ? '#6366f1' : '#e2e8f0'};
                        background: ${subject === documentsSubject ? '#6366f1' : 'white'};
                        color: ${subject === documentsSubject ? 'white' : '#64748b'};
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    "
                >
                    <i class="fas ${subjectIcons[subject]}"></i>
                    ${subjectLabels[subject]}
                </button>
            `).join('');
        }

        // Filter documents by subject
        function filterDocumentsBySubject(subject) {
            documentsSubject = subject;
            updateDocumentsSubjectFilter();
            renderDocuments();
        }

        // Load documents from API
        async function loadDocuments() {
            const grid = document.getElementById('documentsGrid');
            if (!grid) return;
            
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i><p style="font-size: 1.1rem;">Loading documents...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/embedded-documents?stream=${documentsStream}`);
                const data = await response.json();
                
                if (data.success) {
                    allDocuments = data.documents || [];
                    renderDocuments();
                } else {
                    grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>Failed to load documents</p></div>';
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>Error loading documents</p></div>';
            }
        }

        // Render documents in grid (Button style like Question Bank chapters)
        function renderDocuments() {
            const grid = document.getElementById('documentsGrid');
            if (!grid) return;
            
            // Filter documents by subject
            const filteredDocs = documentsSubject === 'all' 
                ? allDocuments 
                : allDocuments.filter(doc => doc.subject === documentsSubject);
            
            if (filteredDocs.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.1rem;">No documents found for ${documentsStream.toUpperCase()} - ${documentsSubject === 'all' ? 'All Subjects' : documentsSubject.charAt(0).toUpperCase() + documentsSubject.slice(1)}</p>
                    </div>
                `;
                return;
            }
            
            const docTypeIcons = {
                pdf: { icon: 'fa-file-pdf', gradient: 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)' },
                ppt: { icon: 'fa-file-powerpoint', gradient: 'linear-gradient(135deg, #ea580c 0%, #c2410c 100%)' },
                docx: { icon: 'fa-file-word', gradient: 'linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)' },
                other: { icon: 'fa-file', gradient: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)' }
            };
            
            grid.innerHTML = filteredDocs.map(doc => {
                const typeInfo = docTypeIcons[doc.documentType] || docTypeIcons.other;
                return `
                    <div class="chapter-card" onclick="viewDocument('${doc._id}')" style="
                        background: white;
                        border-radius: 16px;
                        padding: 1.75rem;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 2px solid transparent;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            width: 60px;
                            height: 60px;
                            background: ${typeInfo.gradient};
                            border-radius: 14px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 1.25rem;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        ">
                            <i class="fas ${typeInfo.icon}" style="font-size: 1.75rem; color: white;"></i>
                        </div>
                        
                        <h3 style="
                            margin: 0 0 0.75rem 0;
                            font-size: 1.15rem;
                            font-weight: 700;
                            color: #1f2937;
                            line-height: 1.4;
                            min-height: 2.8rem;
                        ">
                            ${doc.name}
                        </h3>
                        
                        ${doc.description ? `
                            <p style="
                                margin: 0 0 1rem 0;
                                color: #6b7280;
                                font-size: 0.875rem;
                                line-height: 1.5;
                                display: -webkit-box;
                                -webkit-line-clamp: 2;
                                -webkit-box-orient: vertical;
                                overflow: hidden;
                            ">
                                ${doc.description}
                            </p>
                        ` : ''}
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <span style="
                                background: rgba(99, 102, 241, 0.1);
                                color: #4f46e5;
                                padding: 0.35rem 0.75rem;
                                border-radius: 6px;
                                font-size: 0.75rem;
                                font-weight: 600;
                                text-transform: uppercase;
                            ">
                                ${doc.documentType}
                            </span>
                            <span style="
                                background: rgba(16, 185, 129, 0.1);
                                color: #059669;
                                padding: 0.35rem 0.75rem;
                                border-radius: 6px;
                                font-size: 0.75rem;
                                font-weight: 600;
                            ">
                                <i class="fas fa-eye"></i> ${doc.viewCount || 0}
                            </span>
                        </div>
                        
                        <div style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding-top: 1rem;
                            border-top: 1px solid #e5e7eb;
                        ">
                            <span style="
                                color: #6b7280;
                                font-size: 0.875rem;
                                font-weight: 500;
                            ">
                                Click to view
                            </span>
                            <i class="fas fa-arrow-right" style="color: #6366f1; font-size: 1rem;"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add hover effects
            const cards = grid.querySelectorAll('.chapter-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px)';
                    this.style.boxShadow = '0 12px 24px rgba(0, 0, 0, 0.15)';
                    this.style.borderColor = '#6366f1';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                    this.style.borderColor = 'transparent';
                });
            });
        }

        // Modern PDF Viewer Variables
        let currentDocument = null;
        let pdfDoc = null;
        let currentPage = 1;
        let totalPagesCount = 0;
        let pdfScale = 1.5;
        let isRendering = false;
        
        // View document with modern PDF viewer
        async function viewDocument(docId) {
            try {
                showSection('documentViewerPage');
                
                const loadingAnim = document.getElementById('documentLoadingAnimation');
                if (loadingAnim) loadingAnim.style.display = 'block';
                
                const response = await fetch(`${API_BASE}/api/embedded-documents/${docId}`);
                const data = await response.json();
                
                if (data.success && data.document) {
                    currentDocument = data.document;
                    const doc = data.document;
                    
                    document.getElementById('documentViewerPageTitle').textContent = doc.name;
                    document.getElementById('documentViewerPageSubtitle').textContent = `${doc.stream.toUpperCase()} - ${doc.subject.charAt(0).toUpperCase() + doc.subject.slice(1)} | ${doc.documentType.toUpperCase()}`;
                    
                    const downloadBtn = document.getElementById('documentPageDownloadBtn');
                    if (doc.downloadUrl) {
                        downloadBtn.style.display = 'flex';
                        downloadBtn.onclick = () => window.open(doc.downloadUrl, '_blank');
                    } else {
                        downloadBtn.style.display = 'none';
                    }
                    
                    // Load document - prioritize iframe for Google Drive
                    if (doc.pdfUrl && doc.pdfUrl.trim()) {
                        // Check if it's a Google Drive URL
                        if (doc.pdfUrl.includes('drive.google.com')) {
                            // Extract file ID and create preview iframe
                            const fileId = extractGoogleDriveFileId(doc.pdfUrl);
                            if (fileId) {
                                const embedCode = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" allow="autoplay"></iframe>`;
                                showIframeViewer(embedCode);
                                console.log('âœ… Using Google Drive preview iframe');
                            } else {
                                showNotification('Invalid Google Drive URL', 'error');
                                closeDocumentViewerPage();
                            }
                        } else {
                            // Try loading as regular PDF
                            try {
                                await loadPDF(doc.pdfUrl);
                            } catch (error) {
                                console.error('PDF loading failed:', error);
                                if (doc.embedCode) {
                                    showIframeViewer(doc.embedCode);
                                } else {
                                    showNotification('Failed to load PDF', 'error');
                                    closeDocumentViewerPage();
                                }
                            }
                        }
                    } else if (doc.embedCode) {
                        showIframeViewer(doc.embedCode);
                    } else {
                        showNotification('No PDF URL or embed code found', 'error');
                        closeDocumentViewerPage();
                    }
                    if (loadingAnim) loadingAnim.style.display = 'none';
                    
                } else {
                    if (loadingAnim) loadingAnim.style.display = 'none';
                    showNotification('Failed to load document', 'error');
                    closeDocumentViewerPage();
                }
            } catch (error) {
                console.error('Error viewing document:', error);
                const loadingAnim = document.getElementById('documentLoadingAnimation');
                if (loadingAnim) loadingAnim.style.display = 'none';
                showNotification('Error loading document', 'error');
                closeDocumentViewerPage();
            }
        }

        // Show iframe viewer (beautiful, full-size)
        function showIframeViewer(embedCode) {
            const wrapper = document.getElementById('pdfIframeWrapper');
            wrapper.innerHTML = embedCode;
            
            // Make sure iframe takes full space
            const iframe = wrapper.querySelector('iframe');
            if (iframe) {
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '16px';
            }
            
            console.log('âœ… Using beautiful iframe viewer');
        }

        // Fullscreen toggle for document viewer
        function toggleDocumentFullscreen() {
            const container = document.getElementById('documentViewerPage');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Load PDF with PDF.js
        async function loadPDF(url) {
            if (!url || url.trim() === '') {
                throw new Error('PDF URL is empty');
            }
            
            try {
                console.log('ðŸ“„ Loading PDF from:', url);
                
                const loadingTask = pdfjsLib.getDocument({
                    url: url,
                    withCredentials: false,
                    isEvalSupported: false
                });
                
                pdfDoc = await loadingTask.promise;
                totalPagesCount = pdfDoc.numPages;
                
                document.getElementById('totalPages').textContent = totalPagesCount;
                document.getElementById('currentPageInput').max = totalPagesCount;
                
                currentPage = 1;
                await renderPage(currentPage);
                
                console.log(`âœ… PDF loaded: ${totalPagesCount} pages`);
            } catch (error) {
                console.error('Error loading PDF:', error);
                throw error;
            }
        }

        // Render specific page
        async function renderPage(pageNum) {
            if (isRendering) return;
            isRendering = true;
            
            try {
                const page = await pdfDoc.getPage(pageNum);
                const canvas = document.getElementById('pdfCanvas');
                const context = canvas.getContext('2d');
                
                const viewport = page.getViewport({ scale: pdfScale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                currentPage = pageNum;
                document.getElementById('currentPageInput').value = pageNum;
                
                updateNavigationButtons();
                isRendering = false;
            } catch (error) {
                console.error('Error rendering page:', error);
                isRendering = false;
            }
        }

        // Navigation functions
        function nextPage() {
            if (currentPage < totalPagesCount) {
                renderPage(currentPage + 1);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                renderPage(currentPage - 1);
            }
        }

        function goToPage(pageNum) {
            const num = parseInt(pageNum);
            if (num >= 1 && num <= totalPagesCount) {
                renderPage(num);
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPagesCount;
        }

        // Zoom functions
        function zoomIn() {
            pdfScale += 0.25;
            renderPage(currentPage);
            updateZoomDisplay();
        }

        function zoomOut() {
            if (pdfScale > 0.5) {
                pdfScale -= 0.25;
                renderPage(currentPage);
                updateZoomDisplay();
            }
        }

        function resetZoom() {
            pdfScale = 1.5;
            renderPage(currentPage);
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(pdfScale * 100 / 1.5) + '%';
        }

        // Fullscreen toggle
        function togglePDFFullscreen() {
            const container = document.getElementById('pdfViewerContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Helper functions kept for compatibility

        // Extract Google Drive file ID
        function extractGoogleDriveFileId(url) {
            if (!url) return null;
            
            let fileId = null;
            
            // Pattern 1: /file/d/FILE_ID/view or /file/d/FILE_ID/
            const pattern1 = /\/file\/d\/([^\/\?]+)/;
            const match1 = url.match(pattern1);
            if (match1) {
                fileId = match1[1];
            }
            
            // Pattern 2: ?id=FILE_ID
            if (!fileId) {
                const pattern2 = /[?&]id=([^&]+)/;
                const match2 = url.match(pattern2);
                if (match2) {
                    fileId = match2[1];
                }
            }
            
            // Pattern 3: /d/FILE_ID (alternative format)
            if (!fileId) {
                const pattern3 = /\/d\/([^\/\?]+)/;
                const match3 = url.match(pattern3);
                if (match3) {
                    fileId = match3[1];
                }
            }
            
            // Pattern 4: uc?id=FILE_ID
            if (!fileId) {
                const pattern4 = /uc\?.*id=([^&]+)/;
                const match4 = url.match(pattern4);
                if (match4) {
                    fileId = match4[1];
                }
            }
            
            return fileId;
        }

        // Check if URL is Google Drive
        function isGoogleDriveUrl(url) {
            return url && (url.includes('drive.google.com') || url.includes('docs.google.com'));
        }

        // ========================================
        // GOOGLE DRIVE API - BLAZING FAST PDF LOADING
        // ========================================
        // 
        // HOW TO USE:
        // 1. Upload PDF to Google Drive
        // 2. Right-click > Share > "Anyone with the link can view"
        // 3. Copy link: https://drive.google.com/file/d/FILE_ID/view
        // 4. Paste in embedded documents - auto-converts to fast URL
        //
        // OPTIONAL: Add API key for even faster loading
        // Get free API key: https://console.cloud.google.com/apis/credentials
        // Store in localStorage: localStorage.setItem('googleDriveApiKey', 'YOUR_KEY')
        //
        let GOOGLE_DRIVE_API_KEY = localStorage.getItem('googleDriveApiKey') || '';
        
        // Validate API key format
        if (GOOGLE_DRIVE_API_KEY && !GOOGLE_DRIVE_API_KEY.startsWith('AIzaSy')) {
            console.warn('âš ï¸ Invalid Google API key format. Should start with "AIzaSy"');
            GOOGLE_DRIVE_API_KEY = ''; // Clear invalid key
        }
        
        // Convert Google Drive URL to multiple download formats (try fastest first)
        function getGoogleDriveUrls(url) {
            const fileId = extractGoogleDriveFileId(url);
            if (!fileId) return [url];
            
            const urls = [];
            
            // Method 1: Google Drive API v3 (FASTEST & MOST RELIABLE!) - if API key available
            if (GOOGLE_DRIVE_API_KEY && GOOGLE_DRIVE_API_KEY.startsWith('AIzaSy')) {
                urls.push(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${GOOGLE_DRIVE_API_KEY}`);
                console.log('ðŸ”‘ Using Google Drive API with key (fastest & most reliable)');
            }
            
            // Method 2: Google Drive Viewer (WORKS WITHOUT API KEY - CORS friendly)
            // This uses Google's PDF viewer which is CORS-enabled
            urls.push(`https://drive.google.com/uc?export=view&id=${fileId}`);
            
            // Method 3: Alternative viewer URL
            urls.push(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`);
            
            // Method 4: Direct download (may require confirmation for large files)
            urls.push(`https://drive.google.com/uc?export=download&id=${fileId}&confirm=t`);
            
            return urls;
        }

        // Try to load PDF with multiple methods (fastest first)
        async function loadPDFWithFallback(url) {
            // Check if it's Google Drive
            if (isGoogleDriveUrl(url)) {
                console.log('ðŸ“ Google Drive detected - trying multiple methods...');
                const urls = getGoogleDriveUrls(url);
                
                // Try each method in order (fastest first)
                for (let i = 0; i < urls.length; i++) {
                    const tryUrl = urls[i];
                    const methodName = i === 0 && GOOGLE_DRIVE_API_KEY ? 'Google Drive API' : 
                                      i === 0 ? 'Direct Download' : 
                                      i === 1 ? 'Alternative Download' : 
                                      i === 2 ? 'Direct View' : 'Fallback';
                    
                    try {
                        console.log(`ðŸ”„ Method ${i + 1}/${urls.length}: ${methodName}`);
                        console.log(`   URL: ${tryUrl.substring(0, 80)}...`);
                        
                        const startTime = performance.now();
                        
                        const loadingTask = pdfjsLib.getDocument({
                            url: tryUrl,
                            withCredentials: false,
                            isEvalSupported: false,
                            stopAtErrors: true
                        });
                        
                        const pdf = await Promise.race([
                            loadingTask.promise,
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Timeout')), 15000)
                            )
                        ]);
                        
                        const loadTime = Math.round(performance.now() - startTime);
                        console.log(`âœ… Success with ${methodName} in ${loadTime}ms!`);
                        
                        return pdf;
                        
                    } catch (error) {
                        console.log(`âŒ ${methodName} failed:`, error.message);
                        
                        // If not the last method, try next
                        if (i < urls.length - 1) {
                            console.log(`   Trying next method...`);
                            continue;
                        } else {
                            throw error; // Last method failed
                        }
                    }
                }
            }
            
            // Try direct load for non-Google Drive URLs
            console.log('ðŸ“¥ Attempting direct PDF load...');
            try {
                const loadingTask = pdfjsLib.getDocument({
                    url: url,
                    withCredentials: false,
                    isEvalSupported: false
                });
                return await loadingTask.promise;
            } catch (error) {
                console.error('âŒ Direct load failed:', error.message);
                
                // Try with external CORS proxy as last resort
                console.log('ðŸ”„ Trying external CORS proxy...');
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const loadingTask = pdfjsLib.getDocument({
                    url: proxyUrl,
                    withCredentials: false,
                    isEvalSupported: false
                });
                return await loadingTask.promise;
            }
        }

        // Store PDF document globally for lazy loading
        let currentPdfDocument = null;
        let renderedPages = new Set();
        let renderQuality = 'fast'; // 'fast' or 'high'
        
        // Client-side PDF cache using localStorage (for small PDFs)
        const pdfCache = {
            get: function(url) {
                try {
                    const cached = localStorage.getItem('pdf_' + btoa(url).substring(0, 50));
                    if (cached) {
                        const data = JSON.parse(cached);
                        // Check if cache is less than 24 hours old
                        if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                            console.log('ðŸ’¾ Using cached PDF from localStorage');
                            return data.url;
                        }
                    }
                } catch (e) {
                    console.log('Cache read error:', e);
                }
                return null;
            },
            set: function(url, dataUrl) {
                try {
                    // Only cache if data URL is small enough (< 5MB)
                    if (dataUrl.length < 5 * 1024 * 1024) {
                        const cacheKey = 'pdf_' + btoa(url).substring(0, 50);
                        localStorage.setItem(cacheKey, JSON.stringify({
                            url: dataUrl,
                            timestamp: Date.now()
                        }));
                        console.log('ðŸ’¾ Cached PDF to localStorage');
                    }
                } catch (e) {
                    console.log('Cache write error (probably too large):', e);
                }
            }
        };

        // Render PDF as flipbook pages with lazy loading
        async function renderPDFFlipbook(pdfUrl, flipbook) {
            try {
                console.log('ðŸ“„ Loading PDF:', pdfUrl);
                
                // Load PDF document with fallback
                const pdf = await loadPDFWithFallback(pdfUrl);
                currentPdfDocument = pdf;
                
                console.log('âœ… PDF loaded successfully!');
                console.log('ðŸ“Š Total pages:', pdf.numPages);
                console.log('ðŸ“ PDF info:', {
                    numPages: pdf.numPages,
                    fingerprint: pdf.fingerprint
                });
                
                // Create pages HTML with placeholders
                let pagesHTML = '';
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    pagesHTML += `
                        <div class="page" data-page="${pageNum}" style="background: white; display: flex; align-items: center; justify-content: center; padding: 1rem; position: relative;">
                            <div class="page-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #6b7280;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0; font-size: 0.9rem;">Loading page ${pageNum}...</p>
                            </div>
                            <canvas id="pdf-page-${pageNum}" style="max-width: 100%; max-height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;"></canvas>
                        </div>
                    `;
                }
                
                flipbook.html(pagesHTML);
                
                // Initialize Turn.js with lazy loading
                flipbook.turn({
                    width: 900,
                    height: 600,
                    elevation: 50,
                    gradients: true,
                    autoCenter: true,
                    duration: 1000,
                    pages: pdf.numPages,
                    acceleration: true,
                    display: 'double',
                    when: {
                        turning: function(event, page, view) {
                            showFlipSound();
                            $('#currentPageInput').val(page);
                            
                            // Load pages that will be visible
                            loadVisiblePages(page);
                        },
                        turned: function(event, page, view) {
                            console.log('ðŸ“– Current page:', page);
                            loadVisiblePages(page);
                        }
                    }
                });
                
                flipbookInstance = flipbook;
                
                // Update total pages
                $('#totalPages').text(pdf.numPages);
                $('#currentPageInput').attr('max', pdf.numPages);
                
                // Load first few pages immediately
                console.log('ðŸš€ Loading initial pages...');
                await loadVisiblePages(1);
                
                showNotification(`âœ… PDF loaded! ${pdf.numPages} pages ready to flip.`, 'success');
                
                // Start background preloading after initial pages
                setTimeout(() => {
                    preloadPagesInBackground();
                }, 2000);
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                handlePDFLoadError(error, flipbook);
            }
        }

        // Load pages that are currently visible or nearby
        async function loadVisiblePages(currentPage) {
            if (!currentPdfDocument) return;
            
            // Load current page and nearby pages (for smooth experience)
            const pagesToLoad = [];
            const range = 1; // Load only 1 page before and after (ULTRA FAST!)
            
            for (let i = Math.max(1, currentPage - range); i <= Math.min(currentPdfDocument.numPages, currentPage + range); i++) {
                if (!renderedPages.has(i)) {
                    pagesToLoad.push(i);
                }
            }
            
            if (pagesToLoad.length > 0) {
                console.log(`âš¡ Loading ${pagesToLoad.length} pages: ${pagesToLoad.join(', ')}`);
                
                // Load pages with higher concurrency (5 at a time for maximum speed)
                const concurrency = 5;
                for (let i = 0; i < pagesToLoad.length; i += concurrency) {
                    const batch = pagesToLoad.slice(i, i + concurrency);
                    await Promise.all(batch.map(pageNum => renderPDFPage(currentPdfDocument, pageNum)));
                }
            }
        }

        // Handle PDF load errors
        function handlePDFLoadError(error, flipbook) {
            let errorMessage = 'Failed to load PDF. ';
            
            if (error.name === 'InvalidPDFException') {
                errorMessage += 'The URL does not point to a valid PDF file. ';
            } else if (error.message && error.message.includes('CORS')) {
                errorMessage += 'CORS error - PDF must be publicly accessible. ';
            } else if (error.message && error.message.includes('404')) {
                errorMessage += 'PDF file not found (404). ';
            }
            
            errorMessage += 'Using fallback view.';
            
            showNotification(errorMessage, 'error');
            
            // Fallback to iframe if available
            if (currentDocument.embedCode) {
                console.log('Falling back to iframe embed');
                renderIframeFlipbook(currentDocument.embedCode, flipbook);
            } else {
                // Show error page
                flipbook.html(`
                    <div class="page" style="background: white; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                        <div style="text-align: center; color: #ef4444; max-width: 500px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                            <h3 style="margin: 0 0 1rem 0; color: #1f2937;">Failed to Load PDF</h3>
                            <p style="margin: 0 0 1rem 0; color: #6b7280; line-height: 1.6;">
                                ${errorMessage}
                            </p>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left;">
                                <strong style="color: #92400e;">Tips:</strong>
                                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #92400e;">
                                    <li>Use direct PDF URLs (ending in .pdf)</li>
                                    <li>Ensure the PDF is publicly accessible</li>
                                    <li>For Google Drive: Use "Get link" â†’ "Anyone with the link"</li>
                                    <li>Or provide an iframe embed code as alternative</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `);
                
                flipbook.turn({
                    width: 900,
                    height: 600,
                    pages: 1
                });
                
                flipbookInstance = flipbook;
            }
        }

        // Render individual PDF page with ultra-fast settings
        async function renderPDFPage(pdf, pageNum) {
            const startTime = performance.now();
            
            try {
                // Skip if already rendered
                if (renderedPages.has(pageNum)) {
                    return;
                }
                
                const page = await pdf.getPage(pageNum);
                const canvas = document.getElementById(`pdf-page-${pageNum}`);
                
                if (!canvas) return;
                
                // Use willReadFrequently for faster pixel access
                const context = canvas.getContext('2d', { 
                    alpha: false,
                    desynchronized: true, // Faster rendering
                    willReadFrequently: false
                });
                
                // Calculate optimal scale based on container size
                const container = canvas.parentElement;
                const containerWidth = container.clientWidth - 32;
                const containerHeight = container.clientHeight - 32;
                
                // Get page dimensions at scale 1
                const viewport1 = page.getViewport({ scale: 1 });
                
                // Ultra-fast scaling - much lower resolution
                const scaleX = containerWidth / viewport1.width;
                const scaleY = containerHeight / viewport1.height;
                
                let scale;
                if (renderQuality === 'high') {
                    scale = Math.min(scaleX, scaleY, 1.5); // High = 1.5x
                } else {
                    scale = Math.min(scaleX, scaleY, 0.9); // Fast = 0.9x (ULTRA FAST!)
                }
                
                const viewport = page.getViewport({ scale: scale });
                
                // Set canvas size
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Ultra-optimized rendering settings
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                    intent: 'display',
                    renderInteractiveForms: false,
                    enableWebGL: true,
                    // Additional speed optimizations
                    background: 'white',
                    optionalContentConfigPromise: null
                };
                
                // Disable image smoothing for speed
                context.imageSmoothingEnabled = false;
                
                // Render with aggressive timeout
                const renderTask = page.render(renderContext);
                
                await Promise.race([
                    renderTask.promise,
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Render timeout')), 5000) // 5s timeout
                    )
                ]);
                
                // Re-enable smoothing for display
                context.imageSmoothingEnabled = true;
                
                // Hide loading indicator and show canvas
                const pageDiv = canvas.parentElement;
                const loadingDiv = pageDiv.querySelector('.page-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                canvas.style.display = 'block';
                
                // Mark as rendered
                renderedPages.add(pageNum);
                
                const renderTime = Math.round(performance.now() - startTime);
                console.log(`âœ… Page ${pageNum} rendered in ${renderTime}ms (${Math.round(scale * 100)}% scale)`);
                
            } catch (error) {
                const renderTime = Math.round(performance.now() - startTime);
                console.error(`âŒ Error rendering page ${pageNum} after ${renderTime}ms:`, error);
                
                // Show error in page
                const canvas = document.getElementById(`pdf-page-${pageNum}`);
                if (canvas) {
                    const pageDiv = canvas.parentElement;
                    const loadingDiv = pageDiv.querySelector('.page-loading');
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #ef4444;"></i>
                            <p style="margin: 0; font-size: 0.9rem; color: #ef4444;">Failed to load page ${pageNum}</p>
                            <button onclick="retryRenderPage(${pageNum})" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        `;
                    }
                }
            }
        }

        // Retry rendering a failed page
        async function retryRenderPage(pageNum) {
            if (currentPdfDocument) {
                renderedPages.delete(pageNum);
                await renderPDFPage(currentPdfDocument, pageNum);
            }
        }

        // Background preloading of pages
        let preloadingActive = false;
        async function preloadPagesInBackground() {
            if (!currentPdfDocument || preloadingActive) return;
            
            preloadingActive = true;
            console.log('ðŸ”„ Starting background preload...');
            
            // Get current page
            const currentPage = flipbookInstance ? $('#flipbook').turn('page') : 1;
            
            // Preload pages in chunks (10 pages at a time)
            const chunkSize = 10;
            const totalPages = currentPdfDocument.numPages;
            
            // Start from current page and go forward
            for (let start = currentPage; start <= totalPages; start += chunkSize) {
                // Check if user is still on the page
                if (!currentPdfDocument) break;
                
                const pagesToPreload = [];
                for (let i = start; i < start + chunkSize && i <= totalPages; i++) {
                    if (!renderedPages.has(i)) {
                        pagesToPreload.push(i);
                    }
                }
                
                if (pagesToPreload.length > 0) {
                    console.log(`ðŸ“¦ Preloading pages ${pagesToPreload[0]}-${pagesToPreload[pagesToPreload.length - 1]}`);
                    
                    // Render 2 pages at a time in background
                    for (let i = 0; i < pagesToPreload.length; i += 2) {
                        const batch = pagesToPreload.slice(i, i + 2);
                        await Promise.all(batch.map(pageNum => renderPDFPage(currentPdfDocument, pageNum)));
                        
                        // Small delay to not block UI
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Delay between chunks
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            console.log('âœ… Background preload complete!');
            preloadingActive = false;
        }

        // Render iframe as flipbook (fallback)
        function renderIframeFlipbook(embedCode, flipbook) {
            flipbook.html(`
                <div class="page" style="background: white; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div style="width: 100%; height: 100%; overflow: auto;">
                        ${embedCode}
                    </div>
                </div>
                <div class="page" style="background: white; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div style="text-align: center; color: #6b7280;">
                        <i class="fas fa-book-open" style="font-size: 4rem; margin-bottom: 1rem; color: #6366f1;"></i>
                        <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">End of Document</h3>
                        <p style="margin: 0;">You've reached the last page</p>
                    </div>
                </div>
            `);
            
            // Make iframes responsive
            flipbook.find('iframe').css({
                width: '100%',
                height: '500px',
                border: 'none',
                borderRadius: '8px'
            });
            
            // Initialize Turn.js
            flipbook.turn({
                width: 900,
                height: 600,
                elevation: 50,
                gradients: true,
                autoCenter: true,
                duration: 1000,
                pages: 2,
                acceleration: true,
                display: 'double',
                when: {
                    turning: function(event, page, view) {
                        showFlipSound();
                        $('#currentPageInput').val(page);
                    },
                    turned: function(event, page, view) {
                        console.log('Current page:', page);
                    }
                }
            });
            
            flipbookInstance = flipbook;
            
            // Update total pages
            $('#totalPages').text(2);
            $('#currentPageInput').attr('max', 2);
        }

        // Show flip sound indicator
        function showFlipSound() {
            const indicator = document.getElementById('flipSound');
            if (indicator) {
                indicator.style.display = 'flex';
                indicator.style.alignItems = 'center';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 800);
            }
        }

        // Close document viewer page
        function closeDocumentViewerPage() {
            // Reset PDF viewer
            pdfDoc = null;
            currentPage = 1;
            totalPagesCount = 0;
            pdfScale = 1.5;
            
            showSection('documentsSection');
            currentDocument = null;
        }

        // Keyboard navigation for PDF viewer
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('documentViewerPage').style.display !== 'none') {
                if (e.key === 'ArrowLeft') {
                    prevPage();
                } else if (e.key === 'ArrowRight') {
                    nextPage();
                } else if (e.key === '+' || e.key === '=') {
                    zoomIn();
                } else if (e.key === '-') {
                    zoomOut();
                } else if (e.key === '0') {
                    resetZoom();
                }
            }
        });

        // ==================== ADMIN SYSTEM MANAGEMENT FUNCTIONS ====================
        
        // Clear all chat history
        async function clearAllChatHistory() {
            if (!confirm('âš ï¸ Are you sure you want to clear ALL chat history?\n\nThis will delete:\nâ€¢ All AI conversation history\nâ€¢ All chat sessions\nâ€¢ All saved chats\nâ€¢ All conversation data from database\n\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                showNotification('ðŸ—‘ï¸ Clearing chat history...', 'info');
                
                // Clear all chat-related localStorage items
                const keysToRemove = [];
                
                // Find all localStorage keys related to chat
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.includes('chat') || 
                        key.includes('Chat') || 
                        key.includes('conversation') || 
                        key.includes('Conversation') ||
                        key.includes('message') ||
                        key.includes('Message') ||
                        key.includes('history') ||
                        key.includes('History') ||
                        key.includes('aiGuidance') ||
                        key.includes('AIGuidance')
                    )) {
                        keysToRemove.push(key);
                    }
                }
                
                // Remove all chat-related keys from localStorage
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    console.log('ðŸ—‘ï¸ Removed from localStorage:', key);
                });
                
                // Also clear sessionStorage
                const sessionKeysToRemove = [];
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (
                        key.includes('chat') || 
                        key.includes('Chat') || 
                        key.includes('conversation') || 
                        key.includes('message')
                    )) {
                        sessionKeysToRemove.push(key);
                    }
                }
                
                sessionKeysToRemove.forEach(key => {
                    sessionStorage.removeItem(key);
                    console.log('ðŸ—‘ï¸ Removed from sessionStorage:', key);
                });
                
                const totalCleared = keysToRemove.length + sessionKeysToRemove.length;
                console.log(`âœ… Cleared ${totalCleared} chat history items`);
                
                showNotification(`âœ… Successfully cleared ${totalCleared} chat history items!`, 'success');
                
                // Show confirmation dialog
                setTimeout(() => {
                    if (confirm('âœ… Chat history cleared successfully!\n\nWould you like to refresh the page to see changes?')) {
                        location.reload();
                    }
                }, 500);
                
            } catch (error) {
                console.error('âŒ Error clearing chat history:', error);
                showNotification('âŒ Error clearing chat history: ' + error.message, 'error');
            }
        }

        // Clear browser cache
        function clearBrowserCache() {
            if (!confirm('âš ï¸ Are you sure you want to clear ALL browser cache?\n\nThis will delete:\nâ€¢ All saved papers\nâ€¢ All user preferences\nâ€¢ All temporary data\nâ€¢ Chat history\n\nYou will need to log in again!')) {
                return;
            }
            
            try {
                const itemCount = localStorage.length;
                localStorage.clear();
                
                console.log(`âœ… Cleared ${itemCount} localStorage items`);
                showNotification(`âœ… Successfully cleared ${itemCount} cache items!`, 'success');
                
                // Redirect to login after clearing
                setTimeout(() => {
                    alert('Cache cleared! Redirecting to login page...');
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                showNotification('âŒ Error clearing cache: ' + error.message, 'error');
            }
        }

        // Refresh system
        function refreshSystem() {
            if (confirm('Refresh the system and reload all data?')) {
                showNotification('ðŸ”„ Refreshing system...', 'info');
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        // Save Google Drive API Key
        function saveGoogleApiKey() {
            const apiKey = document.getElementById('googleApiKeyInput').value.trim();
            
            if (!apiKey) {
                showNotification('Please enter an API key', 'error');
                return;
            }
            
            if (!apiKey.startsWith('AIzaSy')) {
                showNotification('Invalid API key format. Should start with "AIzaSy"', 'error');
                return;
            }
            
            localStorage.setItem('googleDriveApiKey', apiKey);
            showNotification('âœ… API Key saved! PDFs will load 10x faster now!', 'success');
            
            // Update the global variable
            window.GOOGLE_DRIVE_API_KEY = apiKey;
            
            setTimeout(() => {
                if (confirm('API Key saved! Refresh page to apply changes?')) {
                    location.reload();
                }
            }, 1000);
        }

        // Load API key on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedKey = localStorage.getItem('googleDriveApiKey');
            if (savedKey) {
                const input = document.getElementById('googleApiKeyInput');
                if (input) {
                    input.value = savedKey;
                }
            }
        });

        // ==================== ADMIN DOCUMENT MANAGEMENT FUNCTIONS ====================
        
        // Show admin tab (extend existing function)
        const originalShowAdminTab = window.showAdminTab;
        window.showAdminTab = function(tabName) {
            if (originalShowAdminTab) {
                originalShowAdminTab(tabName);
            }
            
            // Load documents when documents tab is shown
            if (tabName === 'documents') {
                loadAdminDocuments();
            }
        };

        // Load documents for admin panel
        async function loadAdminDocuments() {
            const container = document.getElementById('adminDocumentsList');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #94a3b8;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i><p style="font-size: 1.1rem;">Loading documents...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/embedded-documents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    renderAdminDocuments(data.documents || []);
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>Failed to load documents</p></div>';
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>Error loading documents</p></div>';
            }
        }

        // Render documents in admin panel
        function renderAdminDocuments(documents) {
            const container = document.getElementById('adminDocumentsList');
            if (!container) return;
            
            if (documents.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #94a3b8;"><i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i><p style="font-size: 1.1rem;">No documents found. Add your first document!</p></div>';
                return;
            }
            
            container.innerHTML = documents.map(doc => `
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700; color: #1f2937;">
                                ${doc.name}
                            </h3>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                    ${doc.stream.toUpperCase()}
                                </span>
                                <span style="background: #f3e8ff; color: #6b21a8; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                    ${doc.subject.toUpperCase()}
                                </span>
                                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                    ${doc.documentType.toUpperCase()}
                                </span>
                            </div>
                            ${doc.description ? `<p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9rem;">${doc.description}</p>` : ''}
                            <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.8rem;">
                                <i class="fas fa-eye"></i> ${doc.viewCount || 0} views
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editDocument('${doc._id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteDocument('${doc._id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show add document modal
        function showAddDocumentModal() {
            document.getElementById('documentModalTitle').textContent = 'Add New Document';
            document.getElementById('documentId').value = '';
            document.getElementById('documentForm').reset();
            document.getElementById('documentModal').style.display = 'flex';
        }

        // Close document modal
        function closeDocumentModal() {
            document.getElementById('documentModal').style.display = 'none';
            document.getElementById('documentForm').reset();
        }

        // Test PDF URL before saving
        async function testPdfUrl() {
            const pdfUrl = document.getElementById('documentPdfUrl').value;
            
            if (!pdfUrl) {
                showNotification('Please enter a PDF URL first', 'error');
                return;
            }
            
            showNotification('Testing PDF URL...', 'info');
            
            try {
                // Test with the same method used for loading
                console.log('Testing URL:', pdfUrl);
                const pdf = await loadPDFWithFallback(pdfUrl);
                
                const source = isGoogleDriveUrl(pdfUrl) ? 'Google Drive (via proxy)' : 'Direct URL';
                showNotification(`âœ… Success! PDF has ${pdf.numPages} pages from ${source}. Will create realistic flipbook!`, 'success');
                console.log('âœ… PDF test successful:', {
                    pages: pdf.numPages,
                    fingerprint: pdf.fingerprint,
                    source: source
                });
                
            } catch (error) {
                console.error('âŒ PDF test failed:', error);
                
                let message = 'âŒ Failed to load PDF. ';
                if (error.name === 'InvalidPDFException') {
                    message += 'The URL does not point to a valid PDF file.';
                } else if (error.message && error.message.includes('CORS')) {
                    message += 'CORS error - PDF must be publicly accessible.';
                } else if (error.message && error.message.includes('403')) {
                    message += 'Access forbidden (403). Make sure the file is shared publicly.';
                } else if (error.message && error.message.includes('404')) {
                    message += 'PDF file not found (404).';
                } else {
                    message += error.message || 'Unknown error.';
                }
                
                showNotification(message, 'error');
            }
        }

        // Update subject dropdown based on stream
        function updateDocumentSubjects() {
            const stream = document.getElementById('documentStream').value;
            const subjectSelect = document.getElementById('documentSubject');
            
            if (!stream) {
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                return;
            }
            
            const subjects = stream === 'jee' 
                ? ['physics', 'chemistry', 'mathematics']
                : ['physics', 'chemistry', 'biology'];
            
            subjectSelect.innerHTML = '<option value="">Select Subject</option>' +
                subjects.map(s => `<option value="${s}">${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('');
        }

        // Save document (add or update)
        async function saveDocument(event) {
            event.preventDefault();
            
            const docId = document.getElementById('documentId').value;
            const name = document.getElementById('documentName').value;
            const stream = document.getElementById('documentStream').value;
            const subject = document.getElementById('documentSubject').value;
            const documentType = document.getElementById('documentType').value;
            const pdfUrl = document.getElementById('documentPdfUrl').value;
            const embedCode = document.getElementById('documentEmbedCode').value;
            const description = document.getElementById('documentDescription').value;
            const downloadUrl = document.getElementById('documentDownloadUrl').value;
            
            if (!name || !stream || !subject) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            if (!pdfUrl && !embedCode) {
                showNotification('Please provide either a PDF URL or embed code', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const url = docId ? `${API_BASE}/api/embedded-documents/${docId}` : '/api/embedded-documents';
                const method = docId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        pdfUrl,
                        embedCode,
                        stream,
                        subject,
                        documentType,
                        description,
                        downloadUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(docId ? 'Document updated successfully' : 'Document added successfully', 'success');
                    closeDocumentModal();
                    loadAdminDocuments();
                } else {
                    showNotification(data.error || 'Failed to save document', 'error');
                }
            } catch (error) {
                console.error('Error saving document:', error);
                showNotification('Error saving document', 'error');
            }
        }

        // Edit document
        async function editDocument(docId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/embedded-documents/${docId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.document) {
                    const doc = data.document;
                    document.getElementById('documentModalTitle').textContent = 'Edit Document';
                    document.getElementById('documentId').value = doc._id;
                    document.getElementById('documentName').value = doc.name;
                    document.getElementById('documentStream').value = doc.stream;
                    updateDocumentSubjects();
                    setTimeout(() => {
                        document.getElementById('documentSubject').value = doc.subject;
                    }, 100);
                    document.getElementById('documentType').value = doc.documentType;
                    document.getElementById('documentPdfUrl').value = doc.pdfUrl || '';
                    document.getElementById('documentEmbedCode').value = doc.embedCode || '';
                    document.getElementById('documentDescription').value = doc.description || '';
                    document.getElementById('documentDownloadUrl').value = doc.downloadUrl || '';
                    document.getElementById('documentModal').style.display = 'flex';
                } else {
                    showNotification('Failed to load document', 'error');
                }
            } catch (error) {
                console.error('Error loading document:', error);
                showNotification('Error loading document', 'error');
            }
        }

        // Delete document
        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/embedded-documents/${docId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Document deleted successfully', 'success');
                    loadAdminDocuments();
                } else {
                    showNotification(data.error || 'Failed to delete document', 'error');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                showNotification('Error deleting document', 'error');
            }
        }

    </script>

    <!-- File Attachment Modal -->
    <div class="modal" id="fileAttachmentModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-primary); color: white; padding: 1.5rem 2rem;">
                <h2 class="modal-title" style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-paperclip"></i>
                    Attach Files
                </h2>
                <button class="close-modal" onclick="closeFileAttachmentModal()" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">&times;</button>
            </div>

            <div class="modal-body" style="padding: 2rem;">
                <!-- File Drop Zone -->
                <div class="file-drop-zone" id="fileDropZone" style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 1.5rem; transition: all 0.3s ease; cursor: pointer;">
                    <div class="drop-zone-content">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--gray-700);">Drop files here or click to browse</h3>
                        <p style="margin: 0; color: var(--gray-500); font-size: 0.9rem;">Supports: PDF, DOC, DOCX, TXT, Images (JPG, PNG, GIF)</p>
                        <p style="margin: 0.5rem 0 0 0; color: var(--gray-400); font-size: 0.8rem;">Max file size: 10MB per file</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif" style="display: none;">
                </div>

                <!-- Selected Files List -->
                <div class="selected-files" id="selectedFilesList" style="display: none;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--gray-700); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-files"></i>
                        Selected Files
                    </h4>
                    <div class="files-container" id="filesContainer"></div>
                </div>

                <!-- File Processing Options -->
                <div class="processing-options" style="background: var(--gray-50); padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--gray-700); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-cogs"></i>
                        Processing Options
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="extractText" checked style="margin: 0;">
                            <span>Extract text content</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="analyzeImages" checked style="margin: 0;">
                            <span>Analyze images</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="summarizeContent" style="margin: 0;">
                            <span>Auto-summarize</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="detectLanguage" style="margin: 0;">
                            <span>Detect language</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="background: var(--gray-50); padding: 1.5rem 2rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                <div class="file-info" id="fileInfo" style="color: var(--gray-600); font-size: 0.9rem;">
                    No files selected
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeFileAttachmentModal()" style="padding: 0.75rem 1.5rem; border: 2px solid var(--gray-300); background: white; color: var(--gray-700); border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="attachFiles()" id="attachButton" disabled style="padding: 0.75rem 1.5rem; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-paperclip"></i>
                        Attach Files
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Keyboard Shortcuts Help Panel -->
    <div class="keyboard-shortcuts-help" id="keyboardShortcutsHelp">
        <div class="shortcuts-header">
            <div class="shortcuts-title">
                <i class="fas fa-keyboard"></i>
                Keyboard Shortcuts
            </div>
            <button class="shortcuts-close" onclick="toggleKeyboardShortcuts()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="shortcuts-content">
            <!-- General Navigation -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">
                    <i class="fas fa-compass"></i>
                    General Navigation
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-question-circle shortcut-icon"></i>
                        Show Shortcuts
                    </span>
                    <span class="shortcut-keys">F1</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-search shortcut-icon"></i>
                        Focus Search
                    </span>
                    <span class="shortcut-keys">Ctrl+/</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-sync-alt shortcut-icon"></i>
                        Refresh Page
                    </span>
                    <span class="shortcut-keys">F5</span>
                </div>
            </div>

            <!-- Text Formatting -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">
                    <i class="fas fa-font"></i>
                    Text Formatting
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-bold shortcut-icon"></i>
                        Bold Text
                    </span>
                    <span class="shortcut-keys">Ctrl+B</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-italic shortcut-icon"></i>
                        Italic Text
                    </span>
                    <span class="shortcut-keys">Ctrl+I</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-underline shortcut-icon"></i>
                        Underline Text
                    </span>
                    <span class="shortcut-keys">Ctrl+U</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-align-left shortcut-icon"></i>
                        Align Left
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+L</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-align-center shortcut-icon"></i>
                        Align Center
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+E</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-align-right shortcut-icon"></i>
                        Align Right
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+R</span>
                </div>
            </div>

            <!-- LaTeX & Math -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">
                    <i class="fas fa-square-root-alt"></i>
                    LaTeX & Mathematics
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-calculator shortcut-icon"></i>
                        LaTeX Math Modal
                    </span>
                    <span class="shortcut-keys">Ctrl+Q</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-pi shortcut-icon"></i>
                        Pi Symbol (Ï€)
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+P</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-square-root-alt shortcut-icon"></i>
                        Square Root (âˆš)
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+S</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-superscript shortcut-icon"></i>
                        Scientific (Ã—10^)
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+X</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-infinity shortcut-icon"></i>
                        Infinity (âˆž)
                    </span>
                    <span class="shortcut-keys">Ctrl+Shift+I</span>
                </div>
            </div>

            <!-- Question Editor -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">
                    <i class="fas fa-edit"></i>
                    Question Editor
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-save shortcut-icon"></i>
                        Save Question
                    </span>
                    <span class="shortcut-keys">Ctrl+S</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-eye shortcut-icon"></i>
                        Refresh Preview
                    </span>
                    <span class="shortcut-keys">Ctrl+P</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-info-circle shortcut-icon"></i>
                        Basic Info Tab
                    </span>
                    <span class="shortcut-keys">Ctrl+1</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-question-circle shortcut-icon"></i>
                        Content Tab
                    </span>
                    <span class="shortcut-keys">Ctrl+2</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-lightbulb shortcut-icon"></i>
                        Solution Tab
                    </span>
                    <span class="shortcut-keys">Ctrl+3</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-times shortcut-icon"></i>
                        Close Modal
                    </span>
                    <span class="shortcut-keys">Escape</span>
                </div>
            </div>

            <!-- System Actions -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">
                    <i class="fas fa-cogs"></i>
                    System Actions
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-plus shortcut-icon"></i>
                        New Question
                    </span>
                    <span class="shortcut-keys">Ctrl+N</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-copy shortcut-icon"></i>
                        Copy Text
                    </span>
                    <span class="shortcut-keys">Ctrl+C</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-paste shortcut-icon"></i>
                        Paste Text
                    </span>
                    <span class="shortcut-keys">Ctrl+V</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-undo shortcut-icon"></i>
                        Undo Action
                    </span>
                    <span class="shortcut-keys">Ctrl+Z</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">
                        <i class="fas fa-redo shortcut-icon"></i>
                        Redo Action
                    </span>
                    <span class="shortcut-keys">Ctrl+Y</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Toggle Button -->
    <button class="shortcuts-toggle-btn" id="shortcutsToggleBtn" onclick="toggleKeyboardShortcuts()"
        title="Keyboard Shortcuts (F1)">
        <i class="fas fa-keyboard"></i>
    </button>

</body>

</html>

